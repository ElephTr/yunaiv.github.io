title: MyCAT 源码解析 —— 分片结果合并
date: 2017-06-13
tags:
categories: MyCAT
permalink: MyCAT/sharding-result-aggregation

---

# 1. 概述

相信很多同学都看过 MySQL 各种优化的文章，里面 99% 都会提到：单表数据量大了，需要进行分片。拆分之后，业务上必然面临的场景：跨分片的数据合并。今天我们就一起来瞅瞅 MyCAT 是如何实现**分片结果合并**。

跨分片查询大体流程如下：

![flow](http://www.yunai.me/images/MyCAT/2017_06_13/flow.png)

和 [《【单库单表】查询》](http://www.yunai.me/Mycat/single-db-single-table-select/) 不同的两个过程：

* 【2】多分片执行 SQL
* 【4】合并多分片结果

下面，我们逐条来讲解这两个过程。

# 2. 多分片执行 SQL

![execute_sql](http://www.yunai.me/images/MyCAT/2017_06_13/execute_sql.png)

经过 SQL 解析后，计算出需要执行 SQL 的**分片节点**，遍历**分片节点**发送 SQL 进行执行。核心代码：【[MultiNodeQueryHandler.java#execute()](https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java)】。

_**SQL 解析** 详细过程，我们另开文章，避免内容过多，影响大家对 **分片结果合并** 流程和逻辑的理解。_

# 3. 合并多分片结果

![handle_response](http://www.yunai.me/images/MyCAT/2017_06_13/handle_response.png)

和 [《【单库单表】查询》](http://www.yunai.me/Mycat/single-db-single-table-select/) 不同，多个**分片节点**都会**分别**响应 _记录头(header)_ 和 _记录行(row)_ 。在开始分析 MyCAT 是怎么合并多分片结果之前，我们先来回想下 SQL 的执行顺序。

```SQL
FROM       // [1] 选择表
WHERE      // [2] 过滤表
GROUP BY   // [3] 分组
SELECT     // [4] 普通字段，max / min / avg / sum / count 等函数，distinct
HAVING     // [5] 再过滤表
ORDER BY   // [6] 排序
LIMIT      // [7] 分页
```

## 3.1 记录头(header)

多个**分片节点**响应时，会响应多次 _记录头(header)_ 。MyCAT 实际在处理时，只处理第一个返回的 _记录头(header)_ 。因此，在使用时要保证表的 Schema 相同。

**分片节点**响应的 _记录头(header)_ 可以直接返回 MySQL Client 吗？答案是不可以。`AVG`函数 是特殊情况，MyCAT 需要将 `AVG` 拆成 `SUM` + `COUNT` 进行计算。举个例子：

```SQL
// [1] MySQL Client => MyCAT ：
SELECT AVG(age) FROM student;

// [2] MyCAT => MySQL Server ：
SELECT SUM(age) AS AVG0SUM, COUNT(age) AS AVG0COUNT FROM student;

// [3] 最终：AVG(age) = SUM(age) AS AVG0SUM / COUNT(age)
```

## 3.2 记录行(row)

