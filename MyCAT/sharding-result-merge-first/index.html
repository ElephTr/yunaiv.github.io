<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="ÂéüÊñáÂú∞ÂùÄÔºöhttp://www.yunai.me/MyCAT/sharding-result-merge-first/MyCat-Server Â∏¶Ê≥®Èáä‰ª£Á†ÅÂú∞ÂùÄ Ôºöhttps://github.com/YunaiV/Mycat-ServerüòàÊú¨Á≥ªÂàóÊØè 1-2 Âë®Êõ¥Êñ∞‰∏ÄÁØáÔºåÊ¨¢ËøéËÆ¢ÈòÖ„ÄÅÂÖ≥Ê≥®„ÄÅÊî∂Ëóè ÂÖ¨‰ºóÂè∑      1. Ê¶ÇËø∞Áõ∏‰ø°ÂæàÂ§öÂêåÂ≠¶ÁúãËøá MySQL ÂêÑÁßç‰ºòÂåñÁöÑÊñáÁ´†ÔºåÈáåÈù¢ 99% ‰ºöÊèêÂà∞ÔºöÂçïË°®Êï∞">
<meta name="keywords" content="Java,Êû∂ÊûÑ,ÂêéÁ´Ø,ÊúçÂä°Á´Ø,RocketMQ,MyCAT,ÂàÜÂ∏ÉÂºèÊ∂àÊÅØÈòüÂàó,ÂàÜÂ∏ÉÂºèÂ≠òÂÇ®,ÊäÄÊúØÂçöÂÆ¢">
<meta property="og:type" content="article">
<meta property="og:title" content="MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ">
<meta property="og:url" content="http://www.yunai.me/MyCAT/sharding-result-merge-first/index.html">
<meta property="og:site_name" content="ËäãËâøVÁöÑÂçöÂÆ¢">
<meta property="og:description" content="ÂéüÊñáÂú∞ÂùÄÔºöhttp://www.yunai.me/MyCAT/sharding-result-merge-first/MyCat-Server Â∏¶Ê≥®Èáä‰ª£Á†ÅÂú∞ÂùÄ Ôºöhttps://github.com/YunaiV/Mycat-ServerüòàÊú¨Á≥ªÂàóÊØè 1-2 Âë®Êõ¥Êñ∞‰∏ÄÁØáÔºåÊ¨¢ËøéËÆ¢ÈòÖ„ÄÅÂÖ≥Ê≥®„ÄÅÊî∂Ëóè ÂÖ¨‰ºóÂè∑      1. Ê¶ÇËø∞Áõ∏‰ø°ÂæàÂ§öÂêåÂ≠¶ÁúãËøá MySQL ÂêÑÁßç‰ºòÂåñÁöÑÊñáÁ´†ÔºåÈáåÈù¢ 99% ‰ºöÊèêÂà∞ÔºöÂçïË°®Êï∞">
<meta property="og:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_06_13/flow.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_06_13/execute_sql.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_06_13/handle_response.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_06_13/merge_service.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_06_13/AbstractDataNodeMerge_run.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_object.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_2.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_06_13/sorter_write.jpeg">
<meta property="og:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
<meta property="og:updated_time" content="2017-06-15T11:20:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ">
<meta name="twitter:description" content="ÂéüÊñáÂú∞ÂùÄÔºöhttp://www.yunai.me/MyCAT/sharding-result-merge-first/MyCat-Server Â∏¶Ê≥®Èáä‰ª£Á†ÅÂú∞ÂùÄ Ôºöhttps://github.com/YunaiV/Mycat-ServerüòàÊú¨Á≥ªÂàóÊØè 1-2 Âë®Êõ¥Êñ∞‰∏ÄÁØáÔºåÊ¨¢ËøéËÆ¢ÈòÖ„ÄÅÂÖ≥Ê≥®„ÄÅÊî∂Ëóè ÂÖ¨‰ºóÂè∑      1. Ê¶ÇËø∞Áõ∏‰ø°ÂæàÂ§öÂêåÂ≠¶ÁúãËøá MySQL ÂêÑÁßç‰ºòÂåñÁöÑÊñáÁ´†ÔºåÈáåÈù¢ 99% ‰ºöÊèêÂà∞ÔºöÂçïË°®Êï∞">
<meta name="twitter:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,Êû∂ÊûÑ,ÂêéÁ´Ø,ÊúçÂä°Á´Ø,RocketMQ,MyCAT,ÂàÜÂ∏ÉÂºèÊ∂àÊÅØÈòüÂàó,ÂàÜÂ∏ÉÂºèÂ≠òÂÇ®,ÊäÄÊúØÂçöÂÆ¢">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- ÁôæÂ∫¶ÁªüËÆ° -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- ÁôæÂ∫¶Á´ôÈïø-Ë¢´Âä®Êé®ÈÄÅ -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360ÊêúÁ¥¢-Ëá™Âä®Êî∂ÂΩï -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/Mycat/single-db-single-table-select/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/MyCAT/sharding-result-merge-first/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&text=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&title=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&is_video=false&description=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ&body=Check out this article: http://www.yunai.me/MyCAT/sharding-result-merge-first/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&title=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&title=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&title=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&title=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&name=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Ê¶ÇËø∞"><span class="toc-number">1.</span> <span class="toc-text">1. Ê¶ÇËø∞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Â§öÂàÜÁâáÊâßË°å-SQL"><span class="toc-number">2.</span> <span class="toc-text">2. Â§öÂàÜÁâáÊâßË°å SQL</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-ÂêàÂπ∂Â§öÂàÜÁâáÁªìÊûú"><span class="toc-number">3.</span> <span class="toc-text">3. ÂêàÂπ∂Â§öÂàÜÁâáÁªìÊûú</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-ËÆ∞ÂΩïÂ§¥-header"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 ËÆ∞ÂΩïÂ§¥(header)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ËÆ∞ÂΩïË°å-row"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ËÆ∞ÂΩïË°å(row)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-AbstractDataNodeMerge"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.1 AbstractDataNodeMerge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-DataNodeMergeManager"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2 DataNodeMergeManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-UnsafeRow"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.3 UnsafeRow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-UnsafeExternalRowSorter"><span class="toc-number">3.2.4.</span> <span class="toc-text">3.4 UnsafeExternalRowSorter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-UnsafeRowGrouper"><span class="toc-number">3.2.5.</span> <span class="toc-text">3.5 UnsafeRowGrouper</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-ÊïëÊä§‰∏≠ÂøÉ"><span class="toc-number">4.</span> <span class="toc-text">4. ÊïëÊä§‰∏≠ÂøÉ</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">ËäãËâøVÁöÑÂçöÂÆ¢</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-06-12T16:00:00.000Z" itemprop="datePublished">2017-06-13</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p> ÂéüÊñáÂú∞ÂùÄÔºö<a href="http://www.yunai.me/MyCAT/sharding-result-merge-first/">http://www.yunai.me/MyCAT/sharding-result-merge-first/</a><br><code>MyCat-Server</code> <strong>Â∏¶Ê≥®Èáä‰ª£Á†Å</strong>Âú∞ÂùÄ Ôºö<a href="https://github.com/YunaiV/Mycat-Server" target="_blank" rel="external">https://github.com/YunaiV/Mycat-Server</a><br><strong>üòàÊú¨Á≥ªÂàóÊØè 1-2 Âë®Êõ¥Êñ∞‰∏ÄÁØáÔºåÊ¨¢ËøéËÆ¢ÈòÖ„ÄÅÂÖ≥Ê≥®„ÄÅÊî∂Ëóè ÂÖ¨‰ºóÂè∑</strong>  </p>
</blockquote>
<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="wechat_mp"></p>
<hr>
<h1 id="1-Ê¶ÇËø∞"><a href="#1-Ê¶ÇËø∞" class="headerlink" title="1. Ê¶ÇËø∞"></a>1. Ê¶ÇËø∞</h1><p>Áõ∏‰ø°ÂæàÂ§öÂêåÂ≠¶ÁúãËøá MySQL ÂêÑÁßç‰ºòÂåñÁöÑÊñáÁ´†ÔºåÈáåÈù¢ 99% ‰ºöÊèêÂà∞ÔºöÂçïË°®Êï∞ÊçÆÈáèÂ§ß‰∫ÜÔºåÈúÄË¶ÅËøõË°åÂàÜÁâáÔºàÊ∞¥Âπ≥ÊãÜÂàÜ or ÂûÇÁõ¥ÊãÜÂàÜÔºâ„ÄÇÂàÜÁâá‰πãÂêéÔºå‰∏öÂä°‰∏äÂøÖÁÑ∂Èù¢‰∏¥ÁöÑÂú∫ÊôØÔºöË∑®ÂàÜÁâáÁöÑÊï∞ÊçÆÂêàÂπ∂„ÄÇ‰ªäÂ§©Êàë‰ª¨Â∞±‰∏ÄËµ∑Êù•ÁûÖÁûÖ MyCAT ÊòØÂ¶Ç‰ΩïÂÆûÁé∞<strong>ÂàÜÁâáÁªìÊûúÂêàÂπ∂</strong>„ÄÇ</p>
<p>Ë∑®ÂàÜÁâáÊü•ËØ¢Â§ß‰ΩìÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/flow.png" alt="flow"></p>
<p>Âíå <a href="http://www.yunai.me/Mycat/single-db-single-table-select/">„Ää„ÄêÂçïÂ∫ìÂçïË°®„ÄëÊü•ËØ¢„Äã</a> ‰∏çÂêåÁöÑ‰∏§‰∏™ËøáÁ®ãÔºö</p>
<ul>
<li>„Äê2„ÄëÂ§öÂàÜÁâáÊâßË°å SQL</li>
<li>„Äê4„ÄëÂêàÂπ∂Â§öÂàÜÁâáÁªìÊûú</li>
</ul>
<p>‰∏ãÈù¢ÔºåÊàë‰ª¨Êù•ÈÄêÊù°ËÆ≤Ëß£Ëøô‰∏§‰∏™ËøáÁ®ã„ÄÇ</p>
<h1 id="2-Â§öÂàÜÁâáÊâßË°å-SQL"><a href="#2-Â§öÂàÜÁâáÊâßË°å-SQL" class="headerlink" title="2. Â§öÂàÜÁâáÊâßË°å SQL"></a>2. Â§öÂàÜÁâáÊâßË°å SQL</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/execute_sql.png" alt="execute_sql"></p>
<p>ÁªèËøá SQL Ëß£ÊûêÂêéÔºåËÆ°ÁÆóÂá∫ÈúÄË¶ÅÊâßË°å SQL ÁöÑ<strong>ÂàÜÁâáËäÇÁÇπ</strong>ÔºåÈÅçÂéÜ<strong>ÂàÜÁâáËäÇÁÇπ</strong>ÂèëÈÄÅ SQL ËøõË°åÊâßË°å„ÄÇ</p>
<p><strong>Ê†∏ÂøÉ‰ª£Á†Å</strong>Ôºö</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java" target="_blank" rel="external">MultiNodeQueryHandler.java#execute(‚Ä¶)</a></li>
</ul>
<p><em><strong>SQL Ëß£Êûê</strong> ËØ¶ÁªÜËøáÁ®ãÔºåÊàë‰ª¨Âè¶ÂºÄÊñáÁ´†ÔºåÈÅøÂÖçÂÜÖÂÆπËøáÂ§öÔºåÂΩ±ÂìçÂ§ßÂÆ∂ÂØπ <strong>ÂàÜÁâáÁªìÊûúÂêàÂπ∂</strong> ÊµÅÁ®ãÂíåÈÄªËæëÁöÑÁêÜËß£„ÄÇ</em></p>
<h1 id="3-ÂêàÂπ∂Â§öÂàÜÁâáÁªìÊûú"><a href="#3-ÂêàÂπ∂Â§öÂàÜÁâáÁªìÊûú" class="headerlink" title="3. ÂêàÂπ∂Â§öÂàÜÁâáÁªìÊûú"></a>3. ÂêàÂπ∂Â§öÂàÜÁâáÁªìÊûú</h1><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/handle_response.png" alt="handle_response"></p>
<p>Âíå <a href="http://www.yunai.me/Mycat/single-db-single-table-select/">„Ää„ÄêÂçïÂ∫ìÂçïË°®„ÄëÊü•ËØ¢„Äã</a> ‰∏çÂêåÔºåÂ§ö‰∏™<strong>ÂàÜÁâáËäÇÁÇπ</strong>ÈÉΩ‰ºö<strong>ÂàÜÂà´</strong>ÂìçÂ∫î <em>ËÆ∞ÂΩïÂ§¥(header)</em> Âíå <em>ËÆ∞ÂΩïË°å(row)</em> „ÄÇÂú®ÂºÄÂßãÂàÜÊûê MyCAT ÊòØÊÄé‰πàÂêàÂπ∂Â§öÂàÜÁâáÁªìÊûú‰πãÂâçÔºåÊàë‰ª¨ÂÖàÊù•ÂõûÊÉ≥‰∏ã SQL ÁöÑÊâßË°åÈ°∫Â∫è„ÄÇ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">FROM       // [1] ÈÄâÊã©Ë°®</div><div class="line">WHERE      // [2] ËøáÊª§Ë°®</div><div class="line">GROUP BY   // [3] ÂàÜÁªÑ</div><div class="line"><span class="keyword">SELECT</span>     // [<span class="number">4</span>] ÊôÆÈÄöÂ≠óÊÆµÔºå<span class="keyword">max</span> / <span class="keyword">min</span> / <span class="keyword">avg</span> / <span class="keyword">sum</span> / <span class="keyword">count</span> Á≠âÂáΩÊï∞Ôºå<span class="keyword">distinct</span></div><div class="line"><span class="keyword">HAVING</span>     // [<span class="number">5</span>] ÂÜçËøáÊª§Ë°®</div><div class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>   // [<span class="number">6</span>] ÊéíÂ∫è</div><div class="line"><span class="keyword">LIMIT</span>      // [<span class="number">7</span>] ÂàÜÈ°µ</div></pre></td></tr></table></figure>
<h2 id="3-1-ËÆ∞ÂΩïÂ§¥-header"><a href="#3-1-ËÆ∞ÂΩïÂ§¥-header" class="headerlink" title="3.1 ËÆ∞ÂΩïÂ§¥(header)"></a>3.1 ËÆ∞ÂΩïÂ§¥(header)</h2><p>Â§ö‰∏™<strong>ÂàÜÁâáËäÇÁÇπ</strong>ÂìçÂ∫îÊó∂Ôºå‰ºöÂìçÂ∫îÂ§öÊ¨° <em>ËÆ∞ÂΩïÂ§¥(header)</em> „ÄÇMyCAT Âú®ÂÆûÈôÖÂ§ÑÁêÜÊó∂ÔºåÂè™Â§ÑÁêÜÁ¨¨‰∏Ä‰∏™ËøîÂõûÁöÑ <em>ËÆ∞ÂΩïÂ§¥(header)</em> „ÄÇÂõ†Ê≠§ÔºåÂú®‰ΩøÁî®Êó∂Ë¶Å‰øùËØÅË°®ÁöÑ Schema Áõ∏Âêå„ÄÇ</p>
<p><strong>ÂàÜÁâáËäÇÁÇπ</strong>ÂìçÂ∫îÁöÑ <em>ËÆ∞ÂΩïÂ§¥(header)</em> ÂèØ‰ª•Áõ¥Êé•ËøîÂõû MySQL Client ÂêóÔºüÁ≠îÊ°àÊòØ‰∏çÂèØ‰ª•„ÄÇ<code>AVG</code>ÂáΩÊï∞ ÊòØÁâπÊÆäÊÉÖÂÜµÔºåMyCAT ÈúÄË¶ÅÂ∞Ü <code>AVG</code> ÊãÜÊàê <code>SUM</code> + <code>COUNT</code> ËøõË°åËÆ°ÁÆó„ÄÇ‰∏æ‰∏™‰æãÂ≠êÔºö</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">// [1] MySQL Client =&gt; MyCAT Ôºö</div><div class="line">SELECT AVG(age) FROM student;</div><div class="line"></div><div class="line">// [2] MyCAT =&gt; MySQL Server Ôºö</div><div class="line">SELECT SUM(age) AS AVG0SUM, COUNT(age) AS AVG0COUNT FROM student;</div><div class="line"></div><div class="line">// [3] ÊúÄÁªàÔºöAVG(age) = SUM(age) AS AVG0SUM / COUNT(age)</div></pre></td></tr></table></figure>
<p><strong>Ê†∏ÂøÉ‰ª£Á†Å</strong>Ôºö</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/nio/handler/MultiNodeQueryHandler.java" target="_blank" rel="external">MultiNodeQueryHandler.java#fieldEofResponse(‚Ä¶)</a>„ÄÇ</li>
</ul>
<h2 id="3-2-ËÆ∞ÂΩïË°å-row"><a href="#3-2-ËÆ∞ÂΩïË°å-row" class="headerlink" title="3.2 ËÆ∞ÂΩïË°å(row)"></a>3.2 ËÆ∞ÂΩïË°å(row)</h2><h3 id="3-1-AbstractDataNodeMerge"><a href="#3-1-AbstractDataNodeMerge" class="headerlink" title="3.1 AbstractDataNodeMerge"></a>3.1 AbstractDataNodeMerge</h3><p>MyCAT ÂØπÂàÜÁâáÁªìÊûúÂêàÂπ∂ÈÄöËøá <code>AbstractDataNodeMerge</code> Â≠êÁ±ªÊù•ÂÆåÊàê„ÄÇ</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/merge_service.png" alt="merge_service"> </p>
<p><code>AbstractDataNodeMerge</code> Ôºö</p>
<ul>
<li>-packs ÔºöÂæÖÂêàÂπ∂ËÆ∞ÂΩïË°å(row)ÈòüÂàó„ÄÇÈòüÂàóÂ∞æÈÉ®ÊèíÂÖ• <code>END_FLAG_PACK</code> Ë°®Á§∫ÈòüÂàóÂ∑≤ÁªìÊùü„ÄÇ</li>
<li>-running ÔºöÂêàÂπ∂ÈÄªËæëÊòØÂê¶Ê≠£Âú®ÊâßË°å‰∏≠ÁöÑÊ†áËÆ∞„ÄÇ</li>
<li>~onRowMetaData(‚Ä¶) ÔºöÊ†πÊçÆ<strong>ËÆ∞ÂΩïÂàó‰ø°ÊÅØ(ColMeta)</strong>ÊûÑÂª∫ÂØπÂ∫îÁöÑÊéíÂ∫èÁªÑ‰ª∂ÂíåËÅöÂêàÁªÑ‰ª∂„ÄÇÈúÄË¶ÅÂ≠êÁ±ªËøõË°åÂÆûÁé∞„ÄÇ</li>
<li>~onNewRecord(‚Ä¶) ÔºöÊèíÂÖ•ËÆ∞ÂΩïË°å(row) Âà∞ <code>packs</code>„ÄÇ</li>
<li>~outputMergeResult(‚Ä¶) ÔºöÊèíÂÖ• <code>END_FLAG_PACK</code> Âà∞ <code>packs</code>„ÄÇ</li>
<li>~run(‚Ä¶) ÔºöÊâßË°å<strong>ÂêàÂπ∂</strong>ÂàÜÁâáÁªìÊûúÈÄªËæëÔºåÂπ∂Â∞ÜÂêàÂπ∂ÁªìÊûúËøîÂõûÁªô MySQL Client„ÄÇÈúÄË¶ÅÂ≠êÁ±ªËøõË°åÂÆûÁé∞„ÄÇ</li>
</ul>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/AbstractDataNodeMerge_run.png" alt="AbstractDataNodeMerge_run.png"></p>
<p><strong>ÈÄöËøá <code>running</code> Ê†áËÆ∞‰øùËØÅÂêå‰∏ÄÊù° SQL ÂêåÊó∂Âè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãÊ≠£Âú®ÊâßË°åÔºåÂπ∂‰∏î‰∏çÈúÄË¶ÅÁ≠âÂà∞ÊØè‰∏™ÂàÜÁâáÁªìÊûúÈÉΩËøîÂõûÂ∞±ÂèØ‰ª•ÊâßË°å<em>ËÅöÂêà</em>ÈÄªËæë„ÄÇÂΩìÁÑ∂Ôºå<em>ÊéíÂ∫è</em>ÈÄªËæëÈúÄË¶ÅÁ≠âÂà∞ÊâÄÊúâÂàÜÁâáÁªìÊûúÈÉΩËøîÂõûÊâçÂèØ‰ª•ÊâßË°å„ÄÇ</strong></p>
<p><strong>Ê†∏ÂøÉ‰ª£Á†Å</strong>Ôºö</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/AbstractDataNodeMerge.java" target="_blank" rel="external">AbstractDataNodeMerge.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/DataNodeMergeManager.java" target="_blank" rel="external">DataNodeMergeManager.java#run(‚Ä¶)</a></li>
</ul>
<h3 id="3-2-DataNodeMergeManager"><a href="#3-2-DataNodeMergeManager" class="headerlink" title="3.2 DataNodeMergeManager"></a>3.2 DataNodeMergeManager</h3><p><code>AbstractDataNodeMerge</code> Êúâ‰∏§ÁßçÂ≠êÁ±ªÂÆûÁé∞Ôºö</p>
<ul>
<li><code>DataMergeService</code> ÔºöÂü∫‰∫é<strong>Â†ÜÂÜÖÂÜÖÂ≠ò</strong>ÂêàÂπ∂ÂàÜÁâáÁªìÊûú„ÄÇ</li>
<li><code>DataNodeMergeManager</code> ÔºöÂü∫‰∫é<strong>Â†ÜÂ§ñÂÜÖÂ≠ò</strong>ÂêàÂπ∂ÂàÜÁâáÁªìÊûú„ÄÇ</li>
</ul>
<p>ÁõÆÂâçÂÆòÊñπÈªòËÆ§ÈÖçÁΩÆ‰ΩøÁî® <code>DataNodeMergeManager</code>„ÄÇ‰∏ªË¶ÅÊúâÂ¶Ç‰∏ã‰ºòÁÇπÔºö</p>
<ol>
<li>ÂèØ‰ª•‰ΩøÁî®Êõ¥Â§ßÁöÑÂÜÖÂ≠òÁ©∫Èó¥„ÄÇÂΩìÂπ∂ÂèëÈáèÂ§ßÊàñËÄÖÊï∞ÊçÆÈáèÂ§ßÊó∂ÔºåÊõ¥Â§ßÁöÑÂÜÖÂ≠òÁ©∫Èó¥ÊÑèÂë≥ÁùÄÊõ¥Â•ΩÁöÑÊÄßËÉΩ„ÄÇ</li>
<li>ÂáèÂ∞ë GC ÊöÇÂÅúÊó∂Èó¥„ÄÇËÆ∞ÂΩïË°å(row)ÂØπË±°Â∞è‰∏îÈáçÁî®ÊÄßÂæà‰ΩéÔºåÈúÄË¶ÅËÉΩÂ§üËøõË°åÁ±ª‰ºº C / C++ ÁöÑËá™‰∏ªÂÜÖÂ≠òÈáäÊîæ„ÄÇ</li>
<li>Êõ¥Âø´ÁöÑÂÜÖÂ≠òÂ§çÂà∂ÂíåËØªÂèñÈÄüÂ∫¶ÔºåÂØπÊéíÂ∫èÂíåËÅöÂêàÂ∏¶Êù•ÂæàÂ•ΩÁöÑÊèêÈÄü„ÄÇ</li>
</ol>
<p>Â¶ÇÊûúÂØπ<strong>Â†ÜÂ§ñÂÜÖÂ≠ò</strong>‰∏çÂ§™‰∫ÜËß£ÔºåÊé®ËçêÈòÖËØªÂ¶Ç‰∏ãÊñáÁ´†Ôºö</p>
<ol>
<li><a href="http://www.jianshu.com/p/50be08b54bee" rel="external nofollow noopener noreferrer" target="_blank">„Ää‰ªé0Âà∞1Ëµ∑Ê≠•-Ë∑üÊàëËøõÂÖ•Â†ÜÂ§ñÂÜÖÂ≠òÁöÑÂ•áÂ¶ô‰∏ñÁïå„Äã</a></li>
<li><a href="http://www.infoq.com/cn/news/2014/12/external-memory-heap-memory" rel="external nofollow noopener noreferrer" target="_blank">„ÄäÂ†ÜÂÜÖÂÜÖÂ≠òËøòÊòØÂ†ÜÂ§ñÂÜÖÂ≠òÔºü„Äã</a></li>
<li><a href="http://www.cnblogs.com/moonandstar08/p/5107648.html" rel="external nofollow noopener noreferrer" target="_blank">„ÄäJAVAÂ†ÜÂ§ñÂÜÖÂ≠ò„Äã</a></li>
<li><a href="https://yq.aliyun.com/articles/2948?spm=5176.100239.blogcont62539.11.a3HdFE" rel="external nofollow noopener noreferrer" target="_blank">„ÄäJVMÊ∫êÁ†ÅÂàÜÊûê‰πãÂ†ÜÂ§ñÂÜÖÂ≠òÂÆåÂÖ®Ëß£ËØª„Äã</a></li>
</ol>
<p>Êú¨Êñá‰∏ªË¶ÅÂàÜÊûê <code>DataNodeMergeManager</code> ÂÆûÁé∞Ôºå<code>DataMergeService</code> ÂèØ‰ª•Ëá™Â∑±ÈòÖËØªÊàñËÄÖÁ≠âÂæÖÂêéÁª≠ÊñáÁ´†Ôºàüòà<strong>Ê¨¢ËøéËÆ¢ÈòÖÊàëÁöÑÂÖ¨‰ºóÂè∑Âô¢</strong>Ôºâ„ÄÇ</p>
<p><code>DataNodeMergeManager</code> Êúâ‰∏â‰∏™ÁªÑ‰ª∂Ôºö</p>
<ul>
<li><code>globalSorter</code> Ôºö<code>UnsafeExternalRowSorter</code> =&gt; ÂÆûÁé∞ËÆ∞ÂΩïË°å(row)<strong>ÂêàÂπ∂Âπ∂ÊéíÂ∫è</strong>ÈÄªËæë„ÄÇ</li>
<li><code>globalMergeResult</code> Ôºö<code>UnsafeExternalRowSorter</code> =&gt; ÂÆûÁé∞ËÆ∞ÂΩïË°å(row)<strong>ÂêàÂπ∂‰∏çÊéíÂ∫è</strong>ÈÄªËæë„ÄÇ</li>
<li><code>unsafeRowGrouper</code> Ôºö <code>UnsafeRowGrouper</code> =&gt; ÂÆûÁé∞ËÆ∞ÂΩïË°å(row)<strong>ËÅöÂêà</strong>ÈÄªËæë„ÄÇ</li>
</ul>
<p><code>DataNodeMergeManager#run(...)</code> ÈÄªËæëÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>[1] ÂÜôÂÖ•ËÆ∞ÂΩïË°å(row)Âà∞ <code>UnsafeRow</code>„ÄÇ</li>
<li>[2] Ê†πÊçÆÊÉÖÂÜµÂ∞Ü <code>UnsafeRow</code> ÊèíÂÖ•ÂØπÂ∫îÁªÑ‰ª∂„ÄÇ</li>
<li>[3] ÂΩìÊâÄÊúâ <code>UnsafeRow</code> ÊèíÂÖ•ÂÆåÂêéÔºåÊ†πÊçÆÊÉÖÂÜµ‰ΩøÁî®ÁªÑ‰ª∂ËÅöÂêà„ÄÅÊéíÂ∫è„ÄÇ</li>
</ul>
<table>
<thead>
<tr>
<th>ÊòØÂê¶ÊéíÂ∫è</th>
<th>ÊòØÂê¶ËÅöÂêà</th>
<th>‰æùËµñÁªÑ‰ª∂</th>
<th>[2]</th>
<th>[3]</th>
</tr>
</thead>
<tbody>
<tr>
<td>Âê¶</td>
<td>Âê¶</td>
<td><code>globalSorter</code></td>
<td>ÊèíÂÖ• <code>globalSorter</code></td>
<td>‰ΩøÁî® <code>globalSorter</code> ÂêàÂπ∂Âπ∂ÊéíÂ∫è</td>
</tr>
<tr>
<td>ÊòØ</td>
<td>Âê¶</td>
<td><code>globalMergeResult</code></td>
<td>ÊèíÂÖ• <code>globalMergeResult</code></td>
<td>‰ΩøÁî® <code>globalMergeResult</code> ÂêàÂπ∂‰∏çÊéíÂ∫è</td>
</tr>
<tr>
<td>Âê¶</td>
<td>ÊòØ</td>
<td><code>unsafeRowGrouper</code> + <code>globalSorter</code></td>
<td>ÊèíÂÖ• <code>unsafeRowGrouper</code> ËøõË°åËÅöÂêà</td>
<td>‰ΩøÁî® <code>globalSorter</code> ÂêàÂπ∂Âπ∂ÊéíÂ∫è</td>
</tr>
<tr>
<td>ÊòØ</td>
<td>ÊòØ</td>
<td><code>unsafeRowGrouper</code> + <code>globalMergeResult</code></td>
<td>ÊèíÂÖ• <code>unsafeRowGrouper</code> ËøõË°åËÅöÂêà</td>
<td>‰ΩøÁî® <code>globalMergeResult</code> ÂêàÂπ∂‰∏çÊéíÂ∫è</td>
</tr>
</tbody>
</table>
<p><strong>Ê†∏ÂøÉ‰ª£Á†Å</strong>Ôºö</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/sqlengine/mpp/DataNodeMergeManager.java" target="_blank" rel="external">DataNodeMergeManager.java</a>„ÄÇ</li>
</ul>
<p>üôÉÁúãÂà∞ËøôÈáåÔºåÂèØËÉΩÂæàÂ§öÂêåÂ≠¶ÈÉΩÊúâÁÇπÊáµÈÄºÔºåÈóÆÈ¢ò‰∏çÂ§ßÔºåÊàë‰ª¨ÁªßÁª≠ÂæÄ‰∏ãÁûÖ„ÄÇ</p>
<h3 id="3-3-UnsafeRow"><a href="#3-3-UnsafeRow" class="headerlink" title="3.3 UnsafeRow"></a>3.3 UnsafeRow</h3><p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row.png" alt="unsafe_row"></p>
<p>ËÆ∞ÂΩïË°å(row)ÂÜôÂà∞ <code>UnsafeRow</code> ÁöÑ <code>baseObject</code> Â±ûÊÄßÔºåÁªìÊûÑÂ¶Ç‰∏ãÔºö</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_object.png" alt="unsafe_row_object"><br><img src="http://www.yunai.me/images/MyCAT/2017_06_13/unsafe_row_2.png" alt="unsafe_row_2.png"></p>
<ul>
<li>ÊãÜÂàÜÊàê‰∏â‰∏™Âå∫ÂüüÔºå<strong>ÊØè‰∏™Âå∫ÂüüÊåâÁÖßÊ†ºÂ≠êËÆ∞ÂΩï‰ø°ÊÅØÔºåÊØè‰∏™Ê†ºÂ≠ê 64bits(8 Bytes)</strong>„ÄÇ</li>
<li>ËÆ∞ÂΩïË°å(row)ÊåâÁÖßÂ≠óÊÆµÈ°∫Â∫è‰ΩçÁΩÆËÆ∞ÂΩïÂà∞ <code>baseObject</code>„ÄÇ</li>
<li>[1] Á©∫Ê†áËÆ∞‰ΩçÂå∫Âüü ÔºöÊ†áËÆ∞Â≠óÊÆµÂØπÂ∫îÁöÑÂÄºÊòØÂê¶‰∏∫ NULL„ÄÇ<ul>
<li>ÂΩìÂ≠óÊÆµÂØπÂ∫îÁöÑÂÄº‰∏∫ NULL Êó∂ÔºåÂÖ∂ÂØπÂ∫îÁöÑÂ≠óÊÆµÈ°∫Â∫èÂØπÂ∫îÁöÑ bit ËÆæÁΩÆ‰∏∫ 1„ÄÇ‰∏æ‰∏™‰æãÂ≠êÔºåÁ¨¨ 0 ‰∏™‰ΩçÁΩÆÂ≠óÊÆµ‰∏∫ NULLÔºåÂàôÁ¨¨‰∏Ä‰∏™Ê†ºÂ≠êÂØπÂ∫îÁöÑ 64 bits ‰ªéÂè≥ËæπÁ¨¨‰∏Ä‰∏™ bit ËÆæÁΩÆ‰∏∫ 1„ÄÇ</li>
<li>Âõ†‰∏∫ÊØè‰∏™Ê†ºÂ≠êÊòØ 64 bitsÔºåÊØè 64 ‰∏™Â≠óÊÆµÂç†Áî®‰∏Ä‰∏™Ê†ºÂ≠êÔºå‰∏çÊª°‰∏Ä‰∏™Ê†ºÂ≠êÔºåÊåâÁÖß‰∏Ä‰∏™Ê†ºÂ≠êËÆ°ÁÆó„ÄÇÂõ†Ê≠§ÔºåËØ•Âå∫ÂüüÁöÑÈïøÂ∫¶(<code>bitSetWidthInBytes</code>) = Â≠óÊÆµÂç†Áî®ÁöÑÊ†ºÂ≠êÊï∞ * 64 bits„ÄÇ</li>
</ul>
</li>
<li>[2] ‰ΩçÁΩÆÈïøÂ∫¶Âå∫Âüü ÔºöËÆ∞ÂΩïÂ≠óÊÆµÂØπÂ∫îÁöÑÂÄºÂú®<code>[3]Âå∫Âüü</code>ÊâÄÂú®ÁöÑ‰ΩçÁΩÆÂíåÈïøÂ∫¶„ÄÇ<ul>
<li>ÊØè‰∏™Â≠óÊÆµËÆ∞ÂΩï<code>[2]Âå∫Âüü</code>ÁöÑ‰ΩçÁΩÆ = <code>baseOffset</code> + <code>bitSetWidthInBytes</code> + 8 Bytes * Â≠óÊÆµÈ°∫Â∫è„ÄÇ</li>
<li>Âç†Áî®‰∏Ä‰∏™Ê†ºÂ≠êÔºåÂâç 32 bits ‰∏∫<code>[3]Âå∫Âüü</code>ÁöÑ‰ΩçÁΩÆÔºåÂêé 32 bits ‰∏∫Â≠óÊÆµÂØπÂ∫îÁöÑÂÄºÈïøÂ∫¶„ÄÇ</li>
</ul>
</li>
<li>[3] ÂÄºÂå∫Âüü ÔºöËÆ∞ÂΩïÂ≠óÊÆµÂØπÂ∫îÁöÑÂÄº„ÄÇ<ul>
<li>ÊØè‰∏™Â≠óÊÆµÂØπÂ∫îÁöÑÂÄºÂç†Áî®Ê†ºÂ≠êÊï∞ = Â≠óÊÆµÂØπÂ∫îÁöÑÂÄºÈïøÂ∫¶ / 8 ByteÔºåÂ¶ÇÊûúÊó†Ê≥ïÊï¥Èô§ÂÜç + 1„ÄÇ</li>
<li>Âõ†‰∏∫Â≠óÊÆµÂØπÂ∫îÁöÑÂÄºÂèØËÉΩÊó†Ê≥ïÂàöÂ•ΩÂç†Êª°ÊØè‰∏™Ê†ºÂ≠êÔºåÊú™‰ΩøÁî®ÁöÑ bit Áî® 0 Âç†‰Ωç„ÄÇ</li>
</ul>
</li>
</ul>
<p><strong>ÂÜôÂÖ• <code>UnsafeRow</code>ÔºåMyCAT ÂèØ‰ª•È°∫Â∫èËÆøÈóÆÊØè‰∏™Â≠óÊÆµÔºåËÄå‰∏çÈúÄË¶ÅÂú®ËÆ∞ÂΩïË°å(row)ËøõË°åÈÅçÂéÜ„ÄÇ</strong>  </p>
<p>üôÉÊó•Â∏∏ÂºÄÂèë‰ΩøÁî®‰ΩçÊìç‰ΩúÁöÑÊú∫‰ºöÊØîËæÉÂ∞ëÔºåÂèØËÉΩËæÉ‰∏∫ÈöæÁêÜËß£ÔºåÈúÄË¶ÅÂèçÂ§çÁêÜËß£‰∏ãÔºåÁõ∏‰ø°‰ºöËé∑ÂæóÂæàÂ§ßÂêØÂèë„ÄÇÊÅ©ÔºåËØ•ÈÉ®ÂàÜ‰ª£Á†ÅÂºïÁî®Ëá™ÂºÄÊ∫êËøêÁÆóÊ°ÜÊû∂ <code>Spark</code>ÔºåÊòØ‰∏çÊòØÊõ¥Âä†ÊúâÂä®ÂäõÂàóüòà„ÄÇ</p>
<p><strong>Ê†∏ÂøÉ‰ª£Á†Å</strong>Ôºö</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/UnsafeRow.java" target="_blank" rel="external">UnsafeRow.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/BufferHolder.java" target="_blank" rel="external">BufferHolder.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/row/UnsafeRowWriter.java" target="_blank" rel="external">UnsafeRowWriter.java</a></li>
</ul>
<h3 id="3-4-UnsafeExternalRowSorter"><a href="#3-4-UnsafeExternalRowSorter" class="headerlink" title="3.4 UnsafeExternalRowSorter"></a>3.4 UnsafeExternalRowSorter</h3><p>Â¶ÇÊûú‰ΩøÁî® Java ÂÆûÁé∞ <code>SELECT * FROM student ORDER BY age desc, nickname asc</code>Ôºå‰∏çËÄÉËôëÁÆóÊ≥ï‰ºòÂåñÁöÑÊÉÖÂÜµ‰∏ãÔºåÊàë‰ª¨ÂèØ‰ª•ÁÆÄÂçïÂ¶Ç‰∏ãÂÆûÁé∞Ôºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Collections.sort(students, <span class="keyword">new</span> Comparator&lt;Comparable&gt;() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Student o1, Student o2)</span> </span>&#123;</div><div class="line">           <span class="keyword">int</span> cmp = compare(o2.age, o1.age);</div><div class="line">           <span class="keyword">return</span> cmp != <span class="number">0</span> ? cmp : compare(o1.nickname, o2.nickname);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>‰ªéÂäüËÉΩ‰∏äÔºå<code>UnsafeExternalRowSorter</code> ÊòØËøô‰πàÂÆûÁé∞ÊéíÂ∫èÈÄªËæë„ÄÇÂΩìÁÑ∂ËÇØÂÆöÁöÑÊòØÔºå‰∏çÊòØËøô‰πà‚ÄúÁÆÄÂçï‚ÄùÁöÑÂÆûÁé∞„ÄÇ</p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_06_13/sorter_write.jpeg" alt="sorter_write"></p>
<p><code>UnsafeRow</code> ‰ºöÂÜôÂÖ•Âà∞‰∏§‰∏™Âú∞ÊñπÔºö</p>
<ol>
<li><code>List&lt;MemoryBlock&gt;</code> ÔºöÂÜÖÂ≠òÂùóÊï∞ÁªÑ„ÄÇÂΩìÂâç <code>MemoryBlock</code> Êó†Ê≥ïÂÆπÁ∫≥ÂÜôÂÖ•ÁöÑ <code>UnsafeRow</code> Êó∂ÔºåÁîüÊàêÊñ∞ÁöÑ <code>MemoryBlock</code> Êèê‰æõÂÜôÂÖ•„ÄÇÊØèÊù° <code>UnsafeRow</code> Â≠òÂÇ®Âú® <code>MemoryBlock</code> Áî± ÈïøÂ∫¶ + Â≠óËäÇÂÜÖÂÆπ ÁªÑÊàê„ÄÇ</li>
<li><code>LongArray</code> ÔºöÊØèÊù° <code>UnsafeRow</code> Â≠òÂÇ®Âú® <code>LongArray</code> Áî±‰∏§ÈÉ®ÂàÜÁªÑÊàêÔºöaddress + prefix„ÄÇ<ul>
<li><code>address</code> Ôºö<code>UnsafeRow</code> Â≠òÂÇ®Âú® <code>List&lt;MemoryBlock&gt;</code> ÁöÑ‰ΩçÁΩÆ„ÄÇÂâç 13 bits ËÆ∞ÂΩïÊâÄÂú® <code>MemoryBlock</code> ÁöÑ indexÔºåÂêé 51 bit ËÆ∞ÂΩïÂú® <code>MemoryBlock</code> ÁöÑ offset„ÄÇ</li>
<li><code>prefix</code> Ôºö<code>UnsafeRow</code> Á¨¨‰∏Ä‰∏™ÊéíÂ∫èÂ≠óÊÆµ<strong>ÂÄº</strong>Ââç 64 bits ËÆ°ÁÆóÁöÑÂÄº„ÄÇ</li>
</ul>
</li>
</ol>
<p><strong><code>UnsafeExternalRowSorter</code> ÊéíÂ∫èÂÆûÁé∞ÊñπÂºè</strong> ÔºöÊèê‰æõ <strong><a href="http://blog.csdn.net/yangzhongblog/article/details/8184707" rel="external nofollow noopener noreferrer" target="_blank">TimSort</a></strong> Âíå <strong>RadixSort</strong> ‰∏§ÁßçÊéíÂ∫èÁÆóÊ≥ïÔºåÂâçËÄÖ‰∏∫ÈªòËÆ§ÂÆûÁé∞„ÄÇ<strong>TimSort</strong> ÊäòÂçäÊü•ÊâæÊó∂Ôºå‰ΩøÁî® <code>LongArray</code>ÔºåÂÖàÊØîËæÉ <code>prefix</code>ÔºåËã•Áõ∏Á≠âÔºåÂàôÈ°∫Â∫èÂØπÊØîÊØè‰∏™ÊéíÂ∫èÂ≠óÊÆµÁõ¥Âà∞‰∏çÁ≠âÔºåÊèêÂçáËÆ°ÁÆóÊïàÁéá„ÄÇÊèíÂÖ•Êìç‰ΩúÂú® <code>LongArray</code> Êìç‰ΩúÔºå<code>List&lt;MemoryBlock&gt;</code> Âè™‰Ωú‰∏∫ÂéüÂßãÊï∞ÊçÆ„ÄÇ</p>
<p>Âè¶Â§ñÔºåÂΩìÈúÄË¶ÅÊéíÂ∫èÁâπÂà´Â§ßÁöÑÊï∞ÊçÆÈáèÊó∂Ôºå‰ºö‰ΩøÁî®Â≠òÂÇ®Êï∞ÊçÆÂà∞Êñá‰ª∂ËøõË°åÊéíÂ∫è„ÄÇÈôê‰∫éÁ¨îËÄÖÊöÇÊó∂Êú™ÈòÖËØªËØ•Â§ÑÊ∫êÁ†ÅÔºåÂêéÁª≠‰ºöÂè¶ÂºÄÊñáÁ´†ÂàÜÊûê„ÄÇüôÇ</p>
<p>Ê†∏ÂøÉÊ∫êÁ†ÅÔºö</p>
<ul>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/UnsafeExternalRowSorter.java" target="_blank" rel="external">UnsafeExternalRowSorter.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/UnsafeExternalRowSorter.java" target="_blank" rel="external">UnsafeExternalRowSorter.java</a></li>
<li><a href="https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/memory/unsafe/utils/sort/TimSort.java" target="_blank" rel="external">TimSort.java</a></li>
</ul>
<h3 id="3-5-UnsafeRowGrouper"><a href="#3-5-UnsafeRowGrouper" class="headerlink" title="3.5 UnsafeRowGrouper"></a>3.5 UnsafeRowGrouper</h3><p>Â¶ÇÊûú‰ΩøÁî® Java ÂÆûÁé∞ <code>SELECT nickname, COUNT(*) FROM student group by nickname</code>Ôºå‰∏çËÄÉËôëÁÆóÊ≥ï‰ºòÂåñÁöÑÊÉÖÂÜµ‰∏ãÔºåÊàë‰ª¨ÂèØ‰ª•ÁÆÄÂçïÂ¶Ç‰∏ãÂÆûÁé∞Ôºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Map&lt;String, List&lt;Object&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"><span class="comment">// ËÅöÂêà</span></div><div class="line"><span class="keyword">for</span> (student : students) &#123;</div><div class="line">    <span class="keyword">if</span> (map.contains(student.nickname)) &#123;</div><div class="line">        map.put(student.nickname, map.get(student.nickname).get(<span class="number">1</span>) + <span class="number">1</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        List&lt;Object&gt; value = <span class="keyword">new</span> Array&lt;&gt;();</div><div class="line">        value.add(nickname);</div><div class="line">        value.add(<span class="number">1</span>);</div><div class="line">        map.put(student.nickname, value);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ËæìÂá∫</span></div><div class="line"><span class="keyword">for</span> (value : map.values) &#123;</div><div class="line">    System.out.println(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>‰ªéÂäüËÉΩ‰∏äÔºå<code>UnsafeRowGrouper</code> ÊòØËøô‰πàÂÆûÁé∞ÊéíÂ∫èÈÄªËæë„ÄÇÂΩìÁÑ∂ËÇØÂÆöÁöÑÊòØÔºå‰πü‰∏çÊòØËøô‰πà‚ÄúÁÆÄÂçï‚ÄùÁöÑÂÆûÁé∞„ÄÇ</p>
<p>üòàÂÖ∑‰ΩìÊÄé‰πàÂÆûÁé∞ÁöÑÂë¢ÔºüÊàë‰ª¨Âú®„ÄäMyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∫åÔºâ„ÄãÁªßÁª≠ÂàÜÊûê„ÄÇ</p>
<h1 id="4-ÊïëÊä§‰∏≠ÂøÉ"><a href="#4-ÊïëÊä§‰∏≠ÂøÉ" class="headerlink" title="4. ÊïëÊä§‰∏≠ÂøÉ"></a>4. ÊïëÊä§‰∏≠ÂøÉ</h1><p>ÁúãÂà∞Ê≠§Â§ÑÁöÑÂ∫îËØ•ÊòØÁúüÁà±ÂêßÔºüÔºÅÂ¶ÇÊûúÂÜÖÂÆπ‰∏äÊúâ‰ªÄ‰πàÈîôËØØÊàñËÄÖÈöæÊáÇÁöÑÂú∞ÊñπÔºåÂèØ‰ª•ÂÖ≥Ê≥®ÊàëÁöÑÂæÆ‰ø°ÂÖ¨‰ºóÂè∑ÁªôÊàëÁïôË®ÄÔºåÊàë‰ºöÂæàËÆ§ÁúüÁöÑÈÄêÊù°Ëß£Á≠îÁöÑ„ÄÇ‚Äú‰∏á‰∏Ä‚ÄùËßâÂæóÊú¨ÊñáËøòÂèØ‰ª•ÔºåÂ∏åÊúõËΩ¨ÂèëÂà∞ÊúãÂèãÂúàËÆ©Êõ¥Â§öÁöÑ‰∫∫ÁúãÂà∞„ÄÇ</p>
<p>ÊúÄÂêéÁöÑÊúÄÂêéÔºåÊÑüË∞¢ËÄêÂøÉÈòÖËØªÊú¨ÊñáÁöÑÂêåÂ≠¶„ÄÇ</p>
<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="wechat_mp"></p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Ê¶ÇËø∞"><span class="toc-number">1.</span> <span class="toc-text">1. Ê¶ÇËø∞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Â§öÂàÜÁâáÊâßË°å-SQL"><span class="toc-number">2.</span> <span class="toc-text">2. Â§öÂàÜÁâáÊâßË°å SQL</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-ÂêàÂπ∂Â§öÂàÜÁâáÁªìÊûú"><span class="toc-number">3.</span> <span class="toc-text">3. ÂêàÂπ∂Â§öÂàÜÁâáÁªìÊûú</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-ËÆ∞ÂΩïÂ§¥-header"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 ËÆ∞ÂΩïÂ§¥(header)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ËÆ∞ÂΩïË°å-row"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ËÆ∞ÂΩïË°å(row)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-AbstractDataNodeMerge"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.1 AbstractDataNodeMerge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-DataNodeMergeManager"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2 DataNodeMergeManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-UnsafeRow"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.3 UnsafeRow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-UnsafeExternalRowSorter"><span class="toc-number">3.2.4.</span> <span class="toc-text">3.4 UnsafeExternalRowSorter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-UnsafeRowGrouper"><span class="toc-number">3.2.5.</span> <span class="toc-text">3.5 UnsafeRowGrouper</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-ÊïëÊä§‰∏≠ÂøÉ"><span class="toc-number">4.</span> <span class="toc-text">4. ÊïëÊä§‰∏≠ÂøÉ</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/MyCAT/sharding-result-merge-first/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&text=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&title=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&is_video=false&description=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ&body=Check out this article: http://www.yunai.me/MyCAT/sharding-result-merge-first/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&title=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&title=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&title=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&title=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/MyCAT/sharding-result-merge-first/&name=MyCAT Ê∫êÁ†ÅËß£Êûê ‚Äî‚Äî ÂàÜÁâáÁªìÊûúÂêàÂπ∂Ôºà‰∏ÄÔºâ&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 ÁéãÊñáÊñå
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO ÂæÖ‰ºòÂåñÔºöËøáÊª§ Áà¨Ëô´
        url = $('#actions .icon').attr('href').trim(); // ÊñáÁ´†url
//        alert(url);
        title = $('.posttitle').text().trim(); // ÊñáÁ´†Ê†áÈ¢ò
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // ÊèíÂÖ•Ê¨°Êï∞
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // ÊèíÂÖ•Ê¨°Êï∞
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // Ëé∑Âèñuid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip ÊµèËßàÂô®Êó†Ê≥ïËé∑Âèñ
        // time ÊúçÂä°Á´ØÂ∑≤ÁªèËÆ∞ÂΩï
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO ÂæÖ‰ºòÂåñÔºöÊ≠§Â§ÑÊÄßËÉΩËæÉÂ∑ÆÔºåÂèØËÉΩ
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // Âà§Êñ≠ÊòØÂê¶Âú®ÊñáÁ´†È°µ
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // Â¢ûÂä†ÊñáÁ´†ËÆøÈóÆÊ¨°Êï∞
                addCount(Counter);
            }
            // ËÆ∞ÂΩïËÆøÈóÆÊó•Âøó
            addVisitLog();
            // ËÆ°ÁÆóÂ§öÂ∞ë‰∫∫ËÆøÈóÆ
            countVisitLog();
        }, 1000);
    });
</script>
