<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客">
<meta property="og:type" content="article">
<meta property="og:title" content="MyCAT 源码分析  —— XA分布式事务">
<meta property="og:url" content="http://www.yunai.me/MyCAT/xa-distributed-transaction/index.html">
<meta property="og:site_name" content="芋艿V的博客">
<meta property="og:description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta property="og:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_07_15/01.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_07_15/02.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_07_15/03.png">
<meta property="og:updated_time" content="2017-07-20T01:38:46.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MyCAT 源码分析  —— XA分布式事务">
<meta name="twitter:description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta name="twitter:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>MyCAT 源码分析  —— XA分布式事务</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- 百度统计 -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- 百度站长-被动推送 -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360搜索-自动收录 -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/Sharding-JDBC/why-read-Sharding-JDBC-source-code/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$(" #i-prev").toggle();"="" onmouseout="$("></i></a></li>
        
        
        <li><a class="icon" href="/MyCAT/two-table-share-join/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/MyCAT/xa-distributed-transaction/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&text=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&is_video=false&description=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MyCAT 源码分析  —— XA分布式事务&body=Check out this article: http://www.yunai.me/MyCAT/xa-distributed-transaction/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&name=MyCAT 源码分析  —— XA分布式事务&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-概述"><span class="toc-number">1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-XA-概念"><span class="toc-number">2.</span> <span class="toc-text">2. XA 概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-MyCAT-代码实现"><span class="toc-number">3.</span> <span class="toc-text">3. MyCAT 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-JDBC-Demo-代码"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 JDBC Demo 代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-MyCAT-开启-XA-事务"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 MyCAT 开启 XA 事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-MyCAT-接收-SQL"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 MyCAT 接收 SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-MySQL-接收-COMMIT"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 MySQL 接收 COMMIT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-单节点事务-or-多节点事务"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 单节点事务 or 多节点事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-协调日志"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 协调日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-MultiNodeCoordinator"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 MultiNodeCoordinator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-MyCAT-启动回滚-XA事务"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 MyCAT 启动回滚 XA事务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-MyCAT-实现缺陷"><span class="toc-number">4.</span> <span class="toc-text">4. MyCAT 实现缺陷</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-协调日志写入性能"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 协调日志写入性能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-数据节点未全部-PREPARE-就进行-COMMIT"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 数据节点未全部 PREPARE 就进行 COMMIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-MyCAT-启动回滚-PREPARE-的-XA事务"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 MyCAT 启动回滚 PREPARE 的 XA事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-单节点事务未记录协调日志"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 单节点事务未记录协调日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-XA-COMMIT-部分节点挂了重新恢复后，未进一步处理"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 XA COMMIT 部分节点挂了重新恢复后，未进一步处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-彩蛋"><span class="toc-number">5.</span> <span class="toc-text">5. 彩蛋</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MyCAT 源码分析  —— XA分布式事务
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">芋艿V的博客</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-07-14T16:00:00.000Z" itemprop="datePublished">2017-07-15</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><a class="magnific-img" href="http://www.yunai.me/images/common/wechat_mp.jpeg"><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="" class="ui centered image"></a></p>
<blockquote>
<p>&#x1F642;&#x1F642;&#x1F642;&#x5173;&#x6CE8;<strong>&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x53F7;&#xFF1A;&#x3010;&#x828B;&#x827F;&#x7684;&#x540E;&#x7AEF;&#x5C0F;&#x5C4B;&#x3011;</strong>&#x6709;&#x798F;&#x5229;&#xFF1A;  </p>
<ol class="ui list">
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>&#x6240;&#x6709;</strong>&#x6E90;&#x7801;&#x5206;&#x6790;&#x6587;&#x7AE0;&#x5217;&#x8868;  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>&#x4E2D;&#x6587;&#x6CE8;&#x91CA;&#x6E90;&#x7801; GitHub &#x5730;&#x5740;</strong>  </li>
<li>&#x60A8;&#x5BF9;&#x4E8E;&#x6E90;&#x7801;&#x7684;&#x7591;&#x95EE;&#x6BCF;&#x6761;&#x7559;&#x8A00;<strong>&#x90FD;</strong>&#x5C06;&#x5F97;&#x5230;<strong>&#x8BA4;&#x771F;</strong>&#x56DE;&#x590D;&#x3002;<strong>&#x751A;&#x81F3;&#x4E0D;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x8BFB;&#x6E90;&#x7801;&#x4E5F;&#x53EF;&#x4EE5;&#x8BF7;&#x6559;&#x5662;</strong>&#x3002;  </li>
<li><strong>&#x65B0;&#x7684;</strong>&#x6E90;&#x7801;&#x89E3;&#x6790;&#x6587;&#x7AE0;<strong>&#x5B9E;&#x65F6;</strong>&#x6536;&#x5230;&#x901A;&#x77E5;&#x3002;<strong>&#x6BCF;&#x5468;&#x66F4;&#x65B0;&#x4E00;&#x7BC7;&#x5DE6;&#x53F3;</strong>&#x3002;</li>
</ol>
</blockquote>
<hr>
<ul class="ui list">
<li><a href="#">1. &#x6982;&#x8FF0;</a></li>
<li><a href="#">2. XA &#x6982;&#x5FF5;</a></li>
<li><a href="#">3. MyCAT &#x4EE3;&#x7801;&#x5B9E;&#x73B0;</a><ul>
<li><a href="#">3.1 JDBC Demo &#x4EE3;&#x7801;</a></li>
<li><a href="#">3.2 MyCAT &#x5F00;&#x542F; XA &#x4E8B;&#x52A1;</a></li>
<li><a href="#">3.3 MyCAT &#x63A5;&#x6536; SQL</a></li>
<li><a href="#">3.4 MySQL &#x63A5;&#x6536; COMMIT</a><ul>
<li><a href="#">3.4.1 &#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1; or &#x591A;&#x8282;&#x70B9;&#x4E8B;&#x52A1;</a></li>
<li><a href="#">3.4.2 &#x534F;&#x8C03;&#x65E5;&#x5FD7;</a></li>
<li><a href="#">3.4.3 MultiNodeCoordinator</a></li>
</ul>
</li>
<li><a href="#">3.5 MyCAT &#x542F;&#x52A8;&#x56DE;&#x6EDA; XA&#x4E8B;&#x52A1;</a></li>
</ul>
</li>
<li><a href="#">4. MyCAT &#x5B9E;&#x73B0;&#x7F3A;&#x9677;</a><ul>
<li><a href="#">4.1 &#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x5199;&#x5165;&#x6027;&#x80FD;</a></li>
<li><a href="#">4.2 &#x6570;&#x636E;&#x8282;&#x70B9;&#x672A;&#x5168;&#x90E8; PREPARE &#x5C31;&#x8FDB;&#x884C; COMMIT</a></li>
<li><a href="#">4.3 MyCAT &#x542F;&#x52A8;&#x56DE;&#x6EDA; PREPARE &#x7684; XA&#x4E8B;&#x52A1;</a></li>
<li><a href="#">4.4 &#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1;&#x672A;&#x8BB0;&#x5F55;&#x534F;&#x8C03;&#x65E5;&#x5FD7;</a></li>
<li><a href="#">4.5 XA COMMIT &#x90E8;&#x5206;&#x8282;&#x70B9;&#x6302;&#x4E86;&#x91CD;&#x65B0;&#x6062;&#x590D;&#x540E;&#xFF0C;&#x672A;&#x8FDB;&#x4E00;&#x6B65;&#x5904;&#x7406;</a></li>
</ul>
</li>
<li><a href="#">5. &#x5F69;&#x86CB;</a></li>
</ul>
<hr>
<h1 id="1-&#x6982;&#x8FF0;"><a href="#1-&#x6982;&#x8FF0;" class="headerlink" title="1. &#x6982;&#x8FF0;"></a>1. &#x6982;&#x8FF0;</h1><p>&#x6570;&#x636E;&#x5E93;&#x62C6;&#x5206;&#x540E;&#xFF0C;&#x4E1A;&#x52A1;&#x4E0A;&#x4F1A;&#x78B0;&#x5230;&#x9700;&#x8981;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x7684;&#x573A;&#x666F;&#x3002;MyCAT &#x57FA;&#x4E8E; XA &#x5B9E;&#x73B0;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x3002;&#x56FD;&#x5185;&#x76EE;&#x524D;&#x53E6;&#x5916;&#x4E00;&#x6B3E;&#x5F88;&#x706B;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x95F4;&#x4EF6; Sharding-JDBC &#x51C6;&#x5907;&#x57FA;&#x4E8E; TCC &#x5B9E;&#x73B0;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x3002;</p>
<p>&#x672C;&#x6587;&#x5185;&#x5BB9;&#x5206;&#x6210;&#x4E09;&#x90E8;&#x5206;&#xFF1A;</p>
<ol class="ui list">
<li>XA &#x6982;&#x5FF5;&#x7B80;&#x8FF0;</li>
<li>MyCAT &#x4EE3;&#x7801;&#x5982;&#x4F55;&#x5B9E;&#x73B0; XA</li>
<li>MyCAT &#x5728;&#x5B9E;&#x73B0; XA &#x5B58;&#x5728;&#x7684;&#x4E00;&#x4E9B;&#x7F3A;&#x9677;</li>
</ol>
<h1 id="2-XA-&#x6982;&#x5FF5;"><a href="#2-XA-&#x6982;&#x5FF5;" class="headerlink" title="2. XA &#x6982;&#x5FF5;"></a>2. XA &#x6982;&#x5FF5;</h1><p>&gt;<br>X/Open &#x7EC4;&#x7EC7;&#xFF08;&#x5373;&#x73B0;&#x5728;&#x7684; Open Group &#xFF09;&#x5B9A;&#x4E49;&#x4E86;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x5904;&#x7406;&#x6A21;&#x578B;&#x3002; X/Open DTP &#x6A21;&#x578B;&#xFF08; 1994 &#xFF09;&#x5305;&#x62EC;&#xFF1A;  </p>
<ol class="ui list">
<li>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF08; <strong>AP</strong> &#xFF09;  </li>
<li>&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#xFF08; <strong>TM</strong> &#xFF09;  </li>
<li>&#x8D44;&#x6E90;&#x7BA1;&#x7406;&#x5668;&#xFF08; <strong>RM</strong> &#xFF09;  </li>
<li>&#x901A;&#x4FE1;&#x8D44;&#x6E90;&#x7BA1;&#x7406;&#x5668;&#xFF08; <strong>CRM</strong> &#xFF09;<br>&#x4E00;&#x822C;&#xFF0C;&#x5E38;&#x89C1;&#x7684;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#xFF08; TM &#xFF09;&#x662F;&#x4EA4;&#x6613;&#x4E2D;&#x95F4;&#x4EF6;&#xFF0C;&#x5E38;&#x89C1;&#x7684;&#x8D44;&#x6E90;&#x7BA1;&#x7406;&#x5668;&#xFF08; <strong>RM</strong> &#xFF09;&#x662F;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5E38;&#x89C1;&#x7684;&#x901A;&#x4FE1;&#x8D44;&#x6E90;&#x7BA1;&#x7406;&#x5668;&#xFF08; <strong>CRM</strong> &#xFF09;&#x662F;&#x6D88;&#x606F;&#x4E2D;&#x95F4;&#x4EF6;&#xFF0C;&#x4E0B;&#x56FE;&#x662F;X/Open DTP&#x6A21;&#x578B;&#xFF1A;</li>
</ol>
<p><a class="magnific-img" href="http://www.yunai.me/images/MyCAT/2017_07_15/01.png"><img src="http://www.yunai.me/images/MyCAT/2017_07_15/01.png" alt="" class="ui centered image"></a></p>
<blockquote>
<p>&#x4E00;&#x822C;&#x7684;&#x7F16;&#x7A0B;&#x65B9;&#x5F0F;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;  </p>
<ol class="ui list">
<li>&#x914D;&#x7F6E; <strong>TM</strong> &#xFF0C;&#x901A;&#x8FC7; <strong>TM</strong> &#x6216;&#x8005; <strong>RM</strong> &#x63D0;&#x4F9B;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x628A; <strong>RM</strong> &#x6CE8;&#x518C;&#x5230; <strong>TM</strong>&#x3002;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x7ED9; <strong>TM</strong> &#x6CE8;&#x518C; <strong>RM</strong> &#x4F5C;&#x4E3A;&#x6570;&#x636E;&#x6E90;&#x3002;&#x4E00;&#x4E2A; <strong>TM</strong> &#x53EF;&#x4EE5;&#x6CE8;&#x518C;&#x591A;&#x4E2A; <strong>RM</strong>&#x3002;  </li>
<li><strong>AP</strong> &#x4ECE; <strong>TM</strong> &#x83B7;&#x53D6;&#x8D44;&#x6E90;&#x7BA1;&#x7406;&#x5668;&#x7684;&#x4EE3;&#x7406;&#xFF08;&#x4F8B;&#x5982;&#xFF1A;&#x4F7F;&#x7528;JTA&#x63A5;&#x53E3;&#xFF0C;&#x4ECE;TM&#x7BA1;&#x7406;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#xFF0C;&#x83B7;&#x53D6;&#x51FA;&#x8FD9;&#x4E2A;TM&#x6240;&#x7BA1;&#x7406;&#x7684;RM&#x7684;JDBC&#x8FDE;&#x63A5;&#x6216;JMS&#x8FDE;&#x63A5;&#xFF09;<br><strong>AP</strong> &#x5411; <strong>TM</strong> &#x53D1;&#x8D77;&#x4E00;&#x4E2A;&#x5168;&#x5C40;&#x4E8B;&#x52A1;&#x3002;&#x8FD9;&#x65F6;&#xFF0C;<strong>TM</strong> &#x4F1A;&#x901A;&#x77E5;&#x5404;&#x4E2A; <strong>RM</strong>&#x3002;<strong>XID</strong>&#xFF08;&#x5168;&#x5C40;&#x4E8B;&#x52A1;ID&#xFF09;&#x4F1A;&#x901A;&#x77E5;&#x5230;&#x5404;&#x4E2A;RM&#x3002;  </li>
<li><strong>AP</strong> &#x901A;&#x8FC7; <strong>TM</strong> &#x4E2D;&#x83B7;&#x53D6;&#x7684;&#x8FDE;&#x63A5;&#xFF0C;<strong>&#x95F4;&#x63A5;</strong>&#x64CD;&#x4F5C; <strong>RM</strong> &#x8FDB;&#x884C;&#x4E1A;&#x52A1;&#x64CD;&#x4F5C;&#x3002;&#x8FD9;&#x65F6;&#xFF0C;<strong>TM</strong> &#x5728;&#x6BCF;&#x6B21; <strong>AP</strong> &#x64CD;&#x4F5C;&#x65F6;&#x628A; <strong>XID</strong>(&#x5305;&#x62EC;&#x6240;&#x5C5E;&#x5206;&#x652F;&#x7684;&#x4FE1;&#x606F;)&#x4F20;&#x9012;&#x7ED9; <strong>RM</strong>&#xFF0C;<strong>RM</strong> &#x6B63;&#x662F;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A; <strong>XID</strong> &#x5173;&#x8054;&#x6765;&#x64CD;&#x4F5C;&#x548C;&#x4E8B;&#x52A1;&#x7684;&#x5173;&#x7CFB;&#x7684;&#x3002;  </li>
<li><strong>AP</strong> &#x7ED3;&#x675F;&#x5168;&#x5C40;&#x4E8B;&#x52A1;&#x65F6;&#xFF0C;<strong>TM</strong> &#x4F1A;&#x901A;&#x77E5; <strong>RM</strong> &#x5168;&#x5C40;&#x4E8B;&#x52A1;&#x7ED3;&#x675F;&#x3002;&#x5F00;&#x59CB;&#x4E8C;&#x6BB5;&#x63D0;&#x4EA4;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;prepare - commit&#x7684;&#x8FC7;&#x7A0B;&#x3002;</li>
</ol>
</blockquote>
<hr>
<blockquote>
<p>XA&#x534F;&#x8BAE;&#x6307;&#x7684;&#x662F;TM&#xFF08;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#xFF09;&#x548C;RM&#xFF08;&#x8D44;&#x6E90;&#x7BA1;&#x7406;&#x5668;&#xFF09;&#x4E4B;&#x95F4;&#x7684;&#x63A5;&#x53E3;&#x3002;&#x76EE;&#x524D;&#x4E3B;&#x6D41;&#x7684;&#x5173;&#x7CFB;&#x578B;&#x6570;&#x636E;&#x5E93;&#x4EA7;&#x54C1;&#x90FD;&#x662F;&#x5B9E;&#x73B0;&#x4E86;XA&#x63A5;&#x53E3;&#x7684;&#x3002;JTA(Java Transaction API)&#x662F;&#x7B26;&#x5408;X/Open DTP&#x6A21;&#x578B;&#x7684;&#xFF0C;&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;&#x548C;&#x8D44;&#x6E90;&#x7BA1;&#x7406;&#x5668;&#x4E4B;&#x95F4;&#x4E5F;&#x4F7F;&#x7528;&#x4E86;XA&#x534F;&#x8BAE;&#x3002; &#x672C;&#x8D28;&#x4E0A;&#x4E5F;&#x662F;&#x501F;&#x52A9;&#x4E24;&#x9636;&#x6BB5;&#x63D0;&#x4EA4;&#x534F;&#x8BAE;&#x6765;&#x5B9E;&#x73B0;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x7684;&#xFF0C;&#x4E0B;&#x9762;&#x5206;&#x522B;&#x6765;&#x770B;&#x770B;XA&#x4E8B;&#x52A1;&#x6210;&#x529F;&#x548C;&#x5931;&#x8D25;&#x7684;&#x6A21;&#x578B;&#x56FE;&#xFF1A;</p>
</blockquote>
<p><a class="magnific-img" href="http://www.yunai.me/images/MyCAT/2017_07_15/02.png"><img src="http://www.yunai.me/images/MyCAT/2017_07_15/02.png" alt="&#x6210;&#x529F;" class="ui centered image"></a></p>
<p><a class="magnific-img" href="http://www.yunai.me/images/MyCAT/2017_07_15/03.png"><img src="http://www.yunai.me/images/MyCAT/2017_07_15/03.png" alt="&#x5931;&#x8D25;" class="ui centered image"></a></p>
<hr>
<p>&#x1F608; &#x770B;&#x5230;&#x8FD9;&#x91CC;&#x662F;&#x4E0D;&#x662F;&#x6709;&#x79CD;&#x9ED1;&#x4EBA;&#x95EE;&#x53F7;&#x7684;&#x611F;&#x89C9;&#xFF1F;&#x6DE1;&#x5B9A;&#xFF01;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x770B; MyCAT &#x4EE3;&#x7801;&#x5C42;&#x9762;&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0; XA &#x7684;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x5BF9;&#x6982;&#x5FF5;&#x4E86;&#x89E3;&#x66F4;&#x591A;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x770B;&#x5982;&#x4E0B;&#x6587;&#x7AE0;&#xFF1A;</p>
<ol class="ui list">
<li><a href="http://www.infoq.com/cn/articles/xa-transactions-handle" rel="external nofollow noopener noreferrer" target="_blank">&#x300A;XA&#x4E8B;&#x52A1;&#x5904;&#x7406;&#x300B;</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html" rel="external nofollow noopener noreferrer" target="_blank">&#x300A;XA Transaction SQL Syntax&#x300B;</a></li>
<li><a href="http://www.voidcn.com/blog/gao1738/article/p-4554083.html" rel="external nofollow noopener noreferrer" target="_blank">&#x300A;MySQL XA &#x4E8B;&#x52A1;&#x652F;&#x6301;&#x8C03;&#x7814;&#x300B;</a></li>
</ol>
<h1 id="3-MyCAT-&#x4EE3;&#x7801;&#x5B9E;&#x73B0;"><a href="#3-MyCAT-&#x4EE3;&#x7801;&#x5B9E;&#x73B0;" class="headerlink" title="3. MyCAT &#x4EE3;&#x7801;&#x5B9E;&#x73B0;"></a>3. MyCAT &#x4EE3;&#x7801;&#x5B9E;&#x73B0;</h1><ul class="ui list">
<li>MyCAT &#xFF1A;TM&#xFF0C;&#x534F;&#x8C03;&#x8005;&#x3002;</li>
<li>&#x6570;&#x636E;&#x8282;&#x70B9; &#xFF1A;RM&#xFF0C;&#x53C2;&#x4E0E;&#x8005;&#x3002;</li>
</ul>
<h2 id="3-1-JDBC-Demo-&#x4EE3;&#x7801;"><a href="#3-1-JDBC-Demo-&#x4EE3;&#x7801;" class="headerlink" title="3.1 JDBC Demo &#x4EE3;&#x7801;"></a>3.1 JDBC Demo &#x4EE3;&#x7801;</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCATXAClientDemo</span> </span>{</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>{</div><div class="line">        <span class="comment">// 1. &#x83B7;&#x5F97;&#x6570;&#x636E;&#x5E93;&#x8FDE;&#x63A5;</span></div><div class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(<span class="string">&quot;jdbc:mysql://127.0.0.1:8066/dbtest&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;123456&quot;</span>);</div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 2. &#x5F00;&#x542F; MyCAT XA &#x4E8B;&#x52A1;</span></div><div class="line">        conn.prepareStatement(<span class="string">&quot;set xa=on&quot;</span>).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 3. &#x63D2;&#x5165; SQL</span></div><div class="line">        <span class="comment">// 3.1 SQL1 A&#x5E93;</span></div><div class="line">        <span class="keyword">long</span> uid = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String username = UUID.randomUUID().toString();</div><div class="line">        String password = UUID.randomUUID().toString();</div><div class="line">        String sql1 = String.format(<span class="string">&quot;insert into t_user(id, username, password) VALUES (%d, &apos;%s&apos;, &apos;%s&apos;)&quot;</span>,</div><div class="line">                uid, username, password);</div><div class="line">        conn.prepareStatement(sql1).execute();</div><div class="line">        <span class="comment">// 3.2 SQL2 B&#x5E93;</span></div><div class="line">        <span class="keyword">long</span> orderId = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String nickname = UUID.randomUUID().toString();</div><div class="line">        String sql2 = String.format(<span class="string">&quot;insert into t_order(id, uid, nickname) VALUES(%d, %s, &apos;%s&apos;)&quot;</span>, orderId, uid, nickname);</div><div class="line">        conn.prepareStatement(sql2).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 4. &#x63D0;&#x4EA4; XA &#x4E8B;&#x52A1;</span></div><div class="line">        conn.commit();</div><div class="line">    }</div><div class="line"></div><div class="line">}</div></pre></td></tr></table></figure>
<ul class="ui list">
<li><code>set xa=on</code> MyCAT &#x5F00;&#x542F; XA &#x4E8B;&#x52A1;&#x3002;</li>
<li><code>conn.commit</code> &#x63D0;&#x4EA4; XA &#x4E8B;&#x52A1;&#x3002; </li>
</ul>
<h2 id="3-2-MyCAT-&#x5F00;&#x542F;-XA-&#x4E8B;&#x52A1;"><a href="#3-2-MyCAT-&#x5F00;&#x542F;-XA-&#x4E8B;&#x52A1;" class="headerlink" title="3.2 MyCAT &#x5F00;&#x542F; XA &#x4E8B;&#x52A1;"></a>3.2 MyCAT &#x5F00;&#x542F; XA &#x4E8B;&#x52A1;</h2><p>&#x5F53; MyCAT &#x63A5;&#x6536;&#x5230; <code>set xa = on</code> &#x547D;&#x4EE4;&#x65F6;&#xFF0C;&#x5F00;&#x542F; XA &#x4E8B;&#x52A1;&#xFF0C;&#x5E76;&#x751F;&#x6210; XA &#x4E8B;&#x52A1;&#x7F16;&#x53F7;&#x3002;XA &#x4E8B;&#x52A1;&#x7F16;&#x53F7;&#x751F;&#x6210;&#x7B97;&#x6CD5;&#x4E3A; UUID&#x3002;&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SetHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String stmt, ServerConnection c, <span class="keyword">int</span> offset)</span> </span>{</div><div class="line">		<span class="keyword">int</span> rs = ServerParseSet.parse(stmt, offset);</div><div class="line">		<span class="keyword">switch</span> (rs &amp; <span class="number">0xff</span>) {</div><div class="line">		<span class="comment">// ... &#x7701;&#x7565;&#x4EE3;&#x7801;</span></div><div class="line">		<span class="keyword">case</span> XA_FLAG_ON: {</div><div class="line">			<span class="keyword">if</span> (c.isAutocommit()) {</div><div class="line">				c.writeErrMessage(ErrorCode.ERR_WRONG_USED, <span class="string">&quot;set xa cmd on can&apos;t used in autocommit connection &quot;</span>);</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			}</div><div class="line">			c.getSession2().setXATXEnabled(<span class="keyword">true</span>);</div><div class="line">			c.write(c.writeToBuffer(OkPacket.OK, c.allocate()));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		}</div><div class="line">		<span class="keyword">case</span> XA_FLAG_OFF: {</div><div class="line">			c.writeErrMessage(ErrorCode.ERR_WRONG_USED,</div><div class="line">					<span class="string">&quot;set xa cmd off not for external use &quot;</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		}</div><div class="line">		<span class="comment">// ... &#x7701;&#x7565;&#x4EE3;&#x7801;</span></div><div class="line">	}</div><div class="line">}</div><div class="line"><span class="comment">// NonBlockingSession.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setXATXEnabled</span><span class="params">(<span class="keyword">boolean</span> xaTXEnabled)</span> </span>{</div><div class="line">   <span class="keyword">if</span> (xaTXEnabled) {</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.xaTXID == <span class="keyword">null</span>) {</div><div class="line">           xaTXID = genXATXID(); <span class="comment">// &#x1F608;&#x1F608;&#x1F608;&#x83B7;&#x5F97; XA &#x4E8B;&#x52A1;&#x7F16;&#x53F7;</span></div><div class="line">       }</div><div class="line">   } <span class="keyword">else</span> {</div><div class="line">       <span class="keyword">this</span>.xaTXID = <span class="keyword">null</span>;</div><div class="line">   }</div><div class="line">}</div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">genXATXID</span><span class="params">()</span> </span>{</div><div class="line">   <span class="keyword">return</span> MycatServer.getInstance().getXATXIDGLOBAL();</div><div class="line">}</div><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getXATXIDGLOBAL</span><span class="params">()</span> </span>{</div><div class="line">   <span class="keyword">return</span> <span class="string">&quot;&apos;&quot;</span> + getUUID() + <span class="string">&quot;&apos;&quot;</span>;</div><div class="line">}</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID</span><span class="params">()</span> </span>{ <span class="comment">// &#x1F608;&#x1F608;&#x1F608;</span></div><div class="line">   String s = UUID.randomUUID().toString();</div><div class="line">   <span class="keyword">return</span> s.substring(<span class="number">0</span>, <span class="number">8</span>) + s.substring(<span class="number">9</span>, <span class="number">13</span>) + s.substring(<span class="number">14</span>, <span class="number">18</span>) + s.substring(<span class="number">19</span>, <span class="number">23</span>) + s.substring(<span class="number">24</span>);</div><div class="line">}</div></pre></td></tr></table></figure>
<h2 id="3-3-MyCAT-&#x63A5;&#x6536;-SQL"><a href="#3-3-MyCAT-&#x63A5;&#x6536;-SQL" class="headerlink" title="3.3 MyCAT &#x63A5;&#x6536; SQL"></a>3.3 MyCAT &#x63A5;&#x6536; SQL</h2><p>&#x6B64;&#x5904; SQL &#x6307;&#x7684;&#x662F; <code>insert</code>&#x3001;<code>update</code>&#x3001;<code>delete</code> &#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x5F53;&#x5411;&#x67D0;&#x4E2A;&#x6570;&#x636E;&#x8282;&#x70B9;<strong>&#x7B2C;&#x4E00;&#x6B21;</strong>&#x53D1;&#x8D77; SQL &#x65F6;&#xFF0C;&#x4F1A;&#x5728; SQL &#x524D;&#x9762;&#x9644;&#x52A0; <code>XA START &apos;xaTranId&apos;</code>&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x8BE5;&#x6570;&#x636E;&#x8282;&#x70B9;<strong>&#x8FDE;&#x63A5;</strong>&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x4E3A; <code>TxState.TX_STARTED_STATE</code>&#xFF08;<em>&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x72B6;&#x6001;&#xFF0C;&#x4E0B;&#x6587;&#x4F1A;&#x4E13;&#x95E8;&#x6574;&#x7406;</em>&#xFF09;&#x3002;&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLConnection.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">synAndDoExecute</span><span class="params">(String xaTxID, RouteResultsetNode rrn,</span></span></div><div class="line">                                 <span class="keyword">int</span> clientCharSetIndex, <span class="keyword">int</span> clientTxIsoLation,</div><div class="line">                                 <span class="keyword">boolean</span> clientAutoCommit) {</div><div class="line">   String xaCmd = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">boolean</span> conAutoComit = <span class="keyword">this</span>.autocommit;</div><div class="line">   String conSchema = <span class="keyword">this</span>.schema;</div><div class="line">   <span class="comment">// never executed modify sql,so auto commit</span></div><div class="line">   <span class="keyword">boolean</span> expectAutocommit = !modifiedSQLExecuted || isFromSlaveDB() || clientAutoCommit;</div><div class="line">   <span class="keyword">if</span> (expectAutocommit == <span class="keyword">false</span> &amp;&amp; xaTxID != <span class="keyword">null</span> &amp;&amp; xaStatus == TxState.TX_INITIALIZE_STATE) { <span class="comment">// &#x1F608;&#x1F608;&#x1F608;</span></div><div class="line">       xaCmd = <span class="string">&quot;XA START &quot;</span> + xaTxID + <span class="string">&apos;;&apos;</span>;</div><div class="line">       <span class="keyword">this</span>.xaStatus = TxState.TX_STARTED_STATE;</div><div class="line">   }</div><div class="line">   <span class="comment">// .... &#x7701;&#x7565;&#x4EE3;&#x7801;</span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="comment">// .... &#x7701;&#x7565;&#x4EE3;&#x7801;</span></div><div class="line">   <span class="keyword">if</span> (xaCmd != <span class="keyword">null</span>) {</div><div class="line">       sb.append(xaCmd);</div><div class="line">   }</div><div class="line">   <span class="comment">// and our query sql to multi command at last</span></div><div class="line">   sb.append(rrn.getStatement() + <span class="string">&quot;;&quot;</span>);</div><div class="line">   <span class="comment">// syn and execute others</span></div><div class="line">   <span class="keyword">this</span>.sendQueryCmd(sb.toString());</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x4E3E;&#x4E2A; &#x53D8;&#x91CF;<code>sb</code> &#x7684;&#x4F8B;&#x5B50;&#xFF1A;</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">names</span> utf8;<span class="keyword">SET</span> autocommit=<span class="number">0</span>;XA <span class="keyword">START</span> <span class="string">&apos;1f2da7353e8846e5833b8d8dd041cfb1&apos;</span>,<span class="string">&apos;db2&apos;</span>;<span class="keyword">insert</span> <span class="keyword">into</span> t_user(<span class="keyword">id</span>, username, <span class="keyword">password</span>) <span class="keyword">VALUES</span> (<span class="number">3400</span>, <span class="string">&apos;b7c5ec1f-11cc-4599-851c-06ad617fec42&apos;</span>, <span class="string">&apos;d2694679-f6a2-4623-a339-48d4a868be90&apos;</span>);</div></pre></td></tr></table></figure>
<h2 id="3-4-MySQL-&#x63A5;&#x6536;-COMMIT"><a href="#3-4-MySQL-&#x63A5;&#x6536;-COMMIT" class="headerlink" title="3.4 MySQL &#x63A5;&#x6536; COMMIT"></a>3.4 MySQL &#x63A5;&#x6536; COMMIT</h2><h3 id="3-4-1-&#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1;-or-&#x591A;&#x8282;&#x70B9;&#x4E8B;&#x52A1;"><a href="#3-4-1-&#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1;-or-&#x591A;&#x8282;&#x70B9;&#x4E8B;&#x52A1;" class="headerlink" title="3.4.1 &#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1; or &#x591A;&#x8282;&#x70B9;&#x4E8B;&#x52A1;"></a>3.4.1 &#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1; or &#x591A;&#x8282;&#x70B9;&#x4E8B;&#x52A1;</h3><p><code>COMMIT</code> &#x6267;&#x884C;&#x65F6;&#xFF0C;MyCAT &#x4F1A;&#x5224;&#x65AD; XA &#x4E8B;&#x52A1;&#x91CC;&#xFF0C;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x6570;&#x636E;&#x5E93;&#x8282;&#x70B9;&#x6570;&#x91CF;&#x3002;</p>
<ul class="ui list">
<li>&#x5982;&#x679C;&#x8282;&#x70B9;&#x6570;&#x91CF;&#x4E3A; 1&#xFF0C;&#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1;&#xFF0C;&#x4F7F;&#x7528; <code>CommitNodeHandler</code> &#x5904;&#x7406;&#x3002;</li>
<li>&#x5982;&#x679C;&#x8282;&#x70B9;&#x6570;&#x91CF; &gt; 1&#xFF0C;&#x591A;&#x8282;&#x70B9;&#x4E8B;&#x52A1;&#xFF0C;&#x4F7F;&#x7528; <code>MultiNodeCoordinator</code> &#x5904;&#x7406;&#x3002;</li>
</ul>
<p><code>CommitNodeHandler</code> &#x76F8;&#x6BD4; <code>MultiNodeCoordinator</code> &#x6765;&#x8BF4;&#xFF0C;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x8282;&#x70B9;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x591A;&#x8282;&#x70B9;&#x534F;&#x8C03;&#xFF0C;&#x903B;&#x8F91;&#x4F1A;&#x76F8;&#x5BF9;&#x7B80;&#x5355;&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x53E6;&#x5916;&#x770B;&#x3002;&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x5206;&#x6790; <code>MultiNodeCoordinator</code>&#x3002;</p>
<h3 id="3-4-2-&#x534F;&#x8C03;&#x65E5;&#x5FD7;"><a href="#3-4-2-&#x534F;&#x8C03;&#x65E5;&#x5FD7;" class="headerlink" title="3.4.2 &#x534F;&#x8C03;&#x65E5;&#x5FD7;"></a>3.4.2 &#x534F;&#x8C03;&#x65E5;&#x5FD7;</h3><p><strong>&#x534F;&#x8C03;&#x65E5;&#x5FD7;</strong>&#xFF0C;&#x8BB0;&#x5F55;&#x534F;&#x8C03;&#x8FC7;&#x7A0B;&#x4E2D;&#x5404;&#x6570;&#x636E;&#x8282;&#x70B9; XA &#x4E8B;&#x52A1;&#x72B6;&#x6001;&#xFF0C;&#x5904;&#x7406;<strong>MyCAT&#x5F02;&#x5E38;&#x5954;&#x6E83;</strong>&#x6216;&#x8005;<strong>&#x6570;&#x636E;&#x8282;&#x70B9;&#x90E8;&#x5206;XA COMMIT&#xFF0C;&#x53E6;&#x5916;&#x90E8;&#x5206; XA PREPARE</strong>&#x4E0B;&#x7684;&#x72B6;&#x6001;&#x6062;&#x590D;&#x3002;</p>
<p><strong>XA &#x4E8B;&#x52A1;&#x5171;&#x6709;&#x79CD;</strong>&#xFF1A;</p>
<ol class="ui list">
<li>TX_INITIALIZE_STATE &#xFF1A;&#x4E8B;&#x52A1;&#x521D;&#x59CB;&#x5316;</li>
<li>TX_STARTED_STATE &#xFF1A;&#x4E8B;&#x52A1;&#x5F00;&#x59CB;&#x5B8C;&#x6210;</li>
<li>TX_PREPARED_STATE &#xFF1A;&#x4E8B;&#x52A1;&#x51C6;&#x5907;&#x5B8C;&#x6210;</li>
<li>TX_COMMITED_STATE &#xFF1A;&#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#x5B8C;&#x6210;</li>
<li>TX_ROLLBACKED_STATE &#xFF1A;&#x4E8B;&#x52A1;&#x56DE;&#x6EDA;&#x5B8C;&#x6210;</li>
</ol>
<p><strong>&#x72B6;&#x6001;&#x53D8;&#x66F4;&#x6D41;</strong> &#xFF1A;TX_INITIALIZE_STATE =&gt; TX_STARTED_STATE =&gt; TX_PREPARED_STATE =&gt; TX_COMMITED_STATE / TX_ROLLBACKED_STATE &#x3002;</p>
<p><strong>&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x5305;&#x542B;&#x4E24;&#x4E2A;&#x90E8;&#x5206;</strong>&#xFF1A;</p>
<ol class="ui list">
<li>CoordinatorLogEntry &#xFF1A;&#x534F;&#x8C03;&#x8005;&#x65E5;&#x5FD7;</li>
<li>ParticipantLogEntry &#xFF1A;&#x53C2;&#x4E0E;&#x8005;&#x65E5;&#x5FD7;&#x3002;<strong>&#x6B64;&#x5904;&#xFF0C;&#x6570;&#x636E;&#x8282;&#x70B9;&#x626E;&#x6F14;&#x53C2;&#x4E0E;&#x8005;&#x7684;&#x89D2;&#x8272;&#x3002;&#x4E0B;&#x6587;&#x4E2D;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x51FA;&#x73B0;&#x53C2;&#x4E0E;&#x8005;&#x4E0E;&#x6570;&#x636E;&#x8282;&#x70B9;&#x6DF7;&#x7528;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x671B;&#x89C1;&#x8C05;&#x3002;</strong></li>
</ol>
<p><em>&#x4E00;&#x6B21; XA &#x4E8B;&#x52A1;&#xFF0C;&#x5BF9;&#x5E94;&#x4E00;&#x6761; <code>CoordinatorLogEntry</code>&#x3002;&#x4E00;&#x6761;<code>CoordinatorLogEntry</code> &#x5305;&#x542B; N&#x6761;<code>ParticipantLogEntry</code></em>&#x3002; &#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CoordinatorLogEntry &#xFF1A;&#x534F;&#x8C03;&#x8005;&#x65E5;&#x5FD7;</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoordinatorLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA &#x4E8B;&#x52A1;&#x7F16;&#x53F7;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &#x53C2;&#x4E0E;&#x8005;&#x65E5;&#x5FD7;&#x6570;&#x7EC4;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ParticipantLogEntry[] participants;</div><div class="line">}</div><div class="line"><span class="comment">// ParticipantLogEntry &#xFF1A;&#x53C2;&#x4E0E;&#x8005;&#x65E5;&#x5FD7;</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParticipantLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA &#x4E8B;&#x52A1;&#x7F16;&#x53F7;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String coordinatorId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &#x6570;&#x636E;&#x5E93; uri</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String uri;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &#x8FC7;&#x671F;&#x63CF;&#x8FF0;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">long</span> expires;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA &#x4E8B;&#x52A1;&#x72B6;&#x6001;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> txState;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &#x53C2;&#x4E0E;&#x8005;&#x540D;&#x5B57;</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String resourceName;</div><div class="line">}</div></pre></td></tr></table></figure>
<p><strong>MyCAT &#x8BB0;&#x5F55;&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x4EE5; JSON&#x683C;&#x5F0F; &#x5230;&#x6587;&#x4EF6;</strong>&#x3002;<strong>&#x6BCF;&#x884C;</strong>&#x5305;&#x542B;&#x4E00;&#x6761;<code>CoordinatorLogEntry</code>&#x3002;&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">{<span class="attr">&quot;id&quot;</span>:<span class="string">&quot;&apos;e827b3fe666c4d968961350d19adda31&apos;&quot;</span>,<span class="attr">&quot;participants&quot;</span>:[{<span class="attr">&quot;uri&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>,<span class="attr">&quot;state&quot;</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">&quot;expires&quot;</span>:<span class="number">0</span>,<span class="attr">&quot;resourceName&quot;</span>:<span class="string">&quot;db3&quot;</span>},{<span class="attr">&quot;uri&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>,<span class="attr">&quot;state&quot;</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">&quot;expires&quot;</span>:<span class="number">0</span>,<span class="attr">&quot;resourceName&quot;</span>:<span class="string">&quot;db1&quot;</span>}]}</div><div class="line">{<span class="attr">&quot;id&quot;</span>:<span class="string">&quot;&apos;f00b61fa17cb4ec5b8264a6d82f847d0&apos;&quot;</span>,<span class="attr">&quot;participants&quot;</span>:[{<span class="attr">&quot;uri&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>,<span class="attr">&quot;state&quot;</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">&quot;expires&quot;</span>:<span class="number">0</span>,<span class="attr">&quot;resourceName&quot;</span>:<span class="string">&quot;db2&quot;</span>},{<span class="attr">&quot;uri&quot;</span>:<span class="string">&quot;127.0.0.1&quot;</span>,<span class="attr">&quot;state&quot;</span>:<span class="string">&quot;3&quot;</span>,<span class="attr">&quot;expires&quot;</span>:<span class="number">0</span>,<span class="attr">&quot;resourceName&quot;</span>:<span class="string">&quot;db1&quot;</span>}]}</div></pre></td></tr></table></figure>
<p>&#x5B9E;&#x73B0;&#x7C7B;&#x4E3A;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// XA &#x534F;&#x8C03;&#x8005;&#x65E5;&#x5FD7; &#x5B58;&#x50A8;&#x63A5;&#x53E3;&#xFF1A;https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/Repository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Repository</span> </span>{}</div><div class="line"><span class="comment">// XA &#x534F;&#x8C03;&#x8005;&#x65E5;&#x5FD7; &#x6587;&#x4EF6;&#x5B58;&#x50A8;&#xFF1A;https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/FileSystemRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>{}</div><div class="line"><span class="comment">// XA &#x534F;&#x8C03;&#x8005;&#x65E5;&#x5FD7; &#x6587;&#x4EF6;&#x5B58;&#x50A8;&#xFF1A;https://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/InMemoryRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>{}</div></pre></td></tr></table></figure>
<p>&#x76EE;&#x524D;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;&#x5199;&#x5165;&#x7684;&#x65B9;&#x5F0F;&#x6027;&#x80FD;&#x8F83;&#x5DEE;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E0D;&#x505A;&#x5206;&#x6790;&#xFF0C;&#x5728;&#x3010;4. MyCAT &#x5B9E;&#x73B0;&#x7F3A;&#x9677;&#x3011;&#x91CC;&#x4E00;&#x8D77;&#x8BB2;&#x3002;</p>
<h3 id="3-4-3-MultiNodeCoordinator"><a href="#3-4-3-MultiNodeCoordinator" class="headerlink" title="3.4.3 MultiNodeCoordinator"></a>3.4.3 MultiNodeCoordinator</h3><p>&#x6572;&#x6572;&#x6572;&#xFF0C;&#x8FD9;&#x91CC;&#x662F;&#x672C;&#x6587;&#x7684;&#x91CD;&#x70B9;&#x4E4B;&#x4E00;&#x5662;&#x3002;&#x1F608;</p>
<p><strong>&#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#xFF1A;&#x53D1;&#x8D77; PREPARE&#x3002;</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeBatchNodeCmd</span><span class="params">(SQLCtrlCommand cmdHandler)</span> </span>{</div><div class="line">   <span class="keyword">this</span>.cmdHandler = cmdHandler;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> initCount = session.getTargetCount();</div><div class="line">   runningCount.set(initCount);</div><div class="line">   nodeCount = initCount;</div><div class="line">   failed.set(<span class="keyword">false</span>);</div><div class="line">   faileCount.set(<span class="number">0</span>);</div><div class="line">   <span class="comment">//recovery nodes log</span></div><div class="line">   ParticipantLogEntry[] participantLogEntry = <span class="keyword">new</span> ParticipantLogEntry[initCount];</div><div class="line">   <span class="comment">// &#x6267;&#x884C;</span></div><div class="line">   <span class="keyword">int</span> started = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (RouteResultsetNode rrn : session.getTargetKeys()) {</div><div class="line">       <span class="keyword">if</span> (rrn == <span class="keyword">null</span>) {</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       }</div><div class="line">       <span class="keyword">final</span> BackendConnection conn = session.getTarget(rrn);</div><div class="line">       <span class="keyword">if</span> (conn != <span class="keyword">null</span>) {</div><div class="line">           conn.setResponseHandler(<span class="keyword">this</span>);</div><div class="line">           <span class="comment">//process the XA_END XA_PREPARE Command</span></div><div class="line">           MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">           String xaTxId = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) {</div><div class="line">               xaTxId = session.getXaTXID() + <span class="string">&quot;,&apos;&quot;</span> + mysqlCon.getSchema() + <span class="string">&quot;&apos;&quot;</span>;</div><div class="line">           }</div><div class="line">           <span class="keyword">if</span> (mysqlCon.getXaStatus() == TxState.TX_STARTED_STATE) { <span class="comment">// XA &#x4E8B;&#x52A1;</span></div><div class="line">               <span class="comment">//recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               String[] cmds = <span class="keyword">new</span> String[]{<span class="string">&quot;XA END &quot;</span> + xaTxId, <span class="comment">// XA END &#x547D;&#x4EE4;</span></div><div class="line">                       <span class="string">&quot;XA PREPARE &quot;</span> + xaTxId}; <span class="comment">// XA PREPARE &#x547D;&#x4EE4;</span></div><div class="line">               mysqlCon.execBatchCmd(cmds);</div><div class="line">           } <span class="keyword">else</span> { <span class="comment">// &#x975E; XA &#x4E8B;&#x52A1;</span></div><div class="line">               <span class="comment">// recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               cmdHandler.sendCommand(session, conn);</div><div class="line">           }</div><div class="line">           ++started;</div><div class="line">       }</div><div class="line">   }</div><div class="line">   <span class="comment">// xa recovery log</span></div><div class="line">   <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) {</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = <span class="keyword">new</span> CoordinatorLogEntry(session.getXaTXID(), <span class="keyword">false</span>, participantLogEntry);</div><div class="line">       inMemoryRepository.put(session.getXaTXID(), coordinatorLogEntry);</div><div class="line">       fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">   }</div><div class="line">   <span class="keyword">if</span> (started &lt; nodeCount) { <span class="comment">// TODO &#x7591;&#x95EE;&#xFF1A;&#x5982;&#x4F55;&#x89E6;&#x53D1;</span></div><div class="line">       runningCount.set(started);</div><div class="line">       LOGGER.warn(<span class="string">&quot;some connection failed to execute &quot;</span> + (nodeCount - started));</div><div class="line">       <span class="comment">/**</span></div><div class="line">        * assumption: only caused by front-end connection close. &lt;br/&gt;</div><div class="line">        * Otherwise, packet must be returned to front-end</div><div class="line">        */</div><div class="line">       failed.set(<span class="keyword">true</span>);</div><div class="line">   }</div><div class="line">}</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x5411;&#x5404;&#x6570;&#x636E;&#x8282;&#x70B9;&#x53D1;&#x9001; <code>XA END</code> + <code>XA PREPARE</code> &#x6307;&#x4EE4;&#x3002;&#x4E3E;&#x4E2A; &#x53D8;&#x91CF;<code>cmds</code> &#x4F8B;&#x5B50;&#xFF1A;</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">XA <span class="keyword">END</span> <span class="string">&apos;4cbb18214d0b47adbdb0658598666677&apos;</span>,<span class="string">&apos;db3&apos;</span>;XA <span class="keyword">PREPARE</span> <span class="string">&apos;4cbb18214d0b47adbdb0658598666677&apos;</span>,<span class="string">&apos;db3&apos;</span>;</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BB0;&#x5F55;&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x3002;&#x6BCF;&#x6761;&#x53C2;&#x4E0E;&#x8005;&#x65E5;&#x5FD7;&#x72B6;&#x6001;&#x4E3A; <code>TxState.TX_STARTED_STATE</code>&#x3002;</li>
</ul>
<hr>
<p><strong>&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;&#xFF1A;&#x53D1;&#x8D77; COMMIT&#x3002;</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">okResponse</span><span class="params">(<span class="keyword">byte</span>[] ok, BackendConnection conn)</span> </span>{</div><div class="line">   <span class="comment">// process the XA Transatcion 2pc commit</span></div><div class="line">   <span class="keyword">if</span> (conn <span class="keyword">instanceof</span> MySQLConnection) {</div><div class="line">       MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">       <span class="keyword">switch</span> (mysqlCon.getXaStatus()) {</div><div class="line">           <span class="keyword">case</span> TxState.TX_STARTED_STATE:</div><div class="line">               <span class="comment">//if there have many SQL execute wait the okResponse,will come to here one by one</span></div><div class="line">               <span class="comment">//should be wait all nodes ready ,then send xa commit to all nodes.</span></div><div class="line">               <span class="keyword">if</span> (mysqlCon.batchCmdFinished()) {</div><div class="line">                   String xaTxId = session.getXaTXID();</div><div class="line">                   String cmd = <span class="string">&quot;XA COMMIT &quot;</span> + xaTxId + <span class="string">&quot;,&apos;&quot;</span> + mysqlCon.getSchema() + <span class="string">&quot;&apos;&quot;</span>;</div><div class="line">                   <span class="keyword">if</span> (LOGGER.isDebugEnabled()) {</div><div class="line">                       LOGGER.debug(<span class="string">&quot;Start execute the cmd :&quot;</span> + cmd + <span class="string">&quot;,current host:&quot;</span> + mysqlCon.getHost() + <span class="string">&quot;:&quot;</span> + mysqlCon.getPort());</div><div class="line">                   }</div><div class="line">                   <span class="comment">// recovery log</span></div><div class="line">                   CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) {</div><div class="line">                       LOGGER.debug(<span class="string">&quot;[In Memory CoordinatorLogEntry]&quot;</span> + coordinatorLogEntry.participants[i]);</div><div class="line">                       <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) {</div><div class="line">                           coordinatorLogEntry.participants[i].txState = TxState.TX_PREPARED_STATE;</div><div class="line">                       }</div><div class="line">                   }</div><div class="line">                   inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">                   fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">                   <span class="comment">// send commit</span></div><div class="line">                   mysqlCon.setXaStatus(TxState.TX_PREPARED_STATE);</div><div class="line">                   mysqlCon.execCmd(cmd);</div><div class="line">               }</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           <span class="keyword">case</span> TxState.TX_PREPARED_STATE: {</div><div class="line">               <span class="comment">// recovery log</span></div><div class="line">               String xaTxId = session.getXaTXID();</div><div class="line">               CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) {</div><div class="line">                   <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) {</div><div class="line">                       coordinatorLogEntry.participants[i].txState = TxState.TX_COMMITED_STATE;</div><div class="line">                   }</div><div class="line">               }</div><div class="line">               inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">               fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">               <span class="comment">// XA reset status now</span></div><div class="line">               mysqlCon.setXaStatus(TxState.TX_INITIALIZE_STATE);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           }</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">       }</div><div class="line">   }</div><div class="line">   <span class="comment">// &#x91CA;&#x653E;&#x8FDE;&#x63A5;</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.cmdHandler.relaseConOnOK()) {</div><div class="line">       session.releaseConnection(conn);</div><div class="line">   } <span class="keyword">else</span> {</div><div class="line">       session.releaseConnectionIfSafe(conn, LOGGER.isDebugEnabled(), <span class="keyword">false</span>);</div><div class="line">   }</div><div class="line">   <span class="comment">// &#x662F;&#x5426;&#x6240;&#x6709;&#x8282;&#x70B9;&#x90FD;&#x5B8C;&#x6210;commit&#xFF0C;&#x5982;&#x679C;&#x662F;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;Client &#x6210;&#x529F;</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.finished()) {</div><div class="line">       cmdHandler.okResponse(session, ok);</div><div class="line">       <span class="keyword">if</span> (cmdHandler.isAutoClearSessionCons()) {</div><div class="line">           session.clearResources(<span class="keyword">false</span>);</div><div class="line">       }</div><div class="line">       <span class="comment">/* 1.  &#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#x540E;,xa &#x4E8B;&#x52A1;&#x7ED3;&#x675F;   */</span></div><div class="line">       <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) {</div><div class="line">           session.setXATXEnabled(<span class="keyword">false</span>);</div><div class="line">       }</div><div class="line">       <span class="comment">/* 2. preAcStates &#x4E3A;true,&#x4E8B;&#x52A1;&#x7ED3;&#x675F;&#x540E;,&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x4E3A;true&#x3002;preAcStates &#x4E3A;ac&#x4E0A;&#x4E00;&#x4E2A;&#x72B6;&#x6001;    */</span></div><div class="line">       <span class="keyword">if</span> (session.getSource().isPreAcStates()) {</div><div class="line">           session.getSource().setAutocommit(<span class="keyword">true</span>);</div><div class="line">       }</div><div class="line">   }</div><div class="line">}</div></pre></td></tr></table></figure>
<ul class="ui list">
<li><code>mysqlCon.batchCmdFinished()</code> &#x6BCF;&#x4E2A;&#x6570;&#x636E;&#x8282;&#x70B9;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x8FD4;&#x56DE;&#x7684;&#x662F; <code>XA END</code> &#x6210;&#x529F;&#xFF0C;&#x7B2C;&#x4E8C;&#x6B21;&#x8FD4;&#x56DE;&#x7684;&#x662F; <code>XA PREPARE</code>&#x3002;&#x5728; <code>XA PREPARE</code> &#x6210;&#x529F;&#x540E;&#xFF0C;&#x8BB0;&#x5F55;&#x8BE5;&#x6570;&#x636E;&#x8282;&#x70B9;&#x7684;<strong>&#x53C2;&#x4E0E;&#x8005;&#x65E5;&#x5FD7;</strong>&#x72B6;&#x6001;&#x4E3A; <code>TxState.TX_PREPARED_STATE</code>&#x3002;&#x4E4B;&#x540E;&#xFF0C;&#x5411;&#x8BE5;&#x6570;&#x636E;&#x8282;&#x70B9;&#x53D1;&#x8D77; <code>XA COMMIT</code> &#x547D;&#x4EE4;&#x3002;</li>
<li><code>XA COMMIT</code> &#x8FD4;&#x56DE;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x8BB0;&#x5F55;&#x8BE5;&#x6570;&#x636E;&#x8282;&#x70B9;&#x7684;<strong>&#x4E8B;&#x52A1;&#x53C2;&#x4E0E;&#x8005;&#x65E5;&#x5FD7;</strong>&#x72B6;&#x6001;&#x4E3A; <code>TxState.TX_COMMITED_STATE</code>&#x3002;</li>
<li>&#x5F53;&#x6240;&#x6709;&#x6570;&#x636E;&#x8282;&#x70B9;&#xFF08;&#x53C2;&#x4E0E;&#x8005;&#xFF09;&#x90FD;&#x6267;&#x884C;&#x5B8C;&#x6210; <code>XA COMMIT</code> &#x8FD4;&#x56DE;&#xFF0C;&#x5373; <code>this.finished() == true</code>&#xFF0C;&#x8FD4;&#x56DE; MySQL Client XA &#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#x6210;&#x529F;&#x3002;</li>
</ul>
<p>[x] <code>XA PREPARE</code> &#x548C; <code>XA COMMIT</code>&#xFF0C;&#x6570;&#x636E;&#x8282;&#x70B9;&#x53EF;&#x80FD;&#x8FD4;&#x56DE;&#x5931;&#x8D25;&#xFF0C;&#x76EE;&#x524D;&#x6682;&#x65F6;&#x6CA1;&#x6A21;&#x62DF;&#x51FA;&#x6765;&#xFF0C;&#x5BF9;&#x5E94;&#x65B9;&#x6CD5;&#x4E3A; <code>#errorResponse(....)</code>&#x3002; </p>
<h2 id="3-5-MyCAT-&#x542F;&#x52A8;&#x56DE;&#x6EDA;-XA&#x4E8B;&#x52A1;"><a href="#3-5-MyCAT-&#x542F;&#x52A8;&#x56DE;&#x6EDA;-XA&#x4E8B;&#x52A1;" class="headerlink" title="3.5 MyCAT &#x542F;&#x52A8;&#x56DE;&#x6EDA; XA&#x4E8B;&#x52A1;"></a>3.5 MyCAT &#x542F;&#x52A8;&#x56DE;&#x6EDA; XA&#x4E8B;&#x52A1;</h2><p>MyCAT &#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x4F1A;<strong>&#x56DE;&#x6EDA;&#x5904;&#x4E8E;TxState.TX_PREPARED_STATE</strong>&#x7684; <code>ParticipantLogEntry</code> &#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;&#x8282;&#x70B9;&#x7684; XA &#x4E8B;&#x52A1;&#x3002;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performXARecoveryLog</span><span class="params">()</span> </span>{</div><div class="line">   <span class="comment">// fetch the recovery log</span></div><div class="line">   CoordinatorLogEntry[] coordinatorLogEntries = getCoordinatorLogEntries();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) {</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = coordinatorLogEntries[i];</div><div class="line">       <span class="keyword">boolean</span> needRollback = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) {</div><div class="line">           ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">           <span class="keyword">if</span> (participantLogEntry.txState == TxState.TX_PREPARED_STATE) {</div><div class="line">               needRollback = <span class="keyword">true</span>;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           }</div><div class="line">       }</div><div class="line">       <span class="keyword">if</span> (needRollback) {</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) {</div><div class="line">               ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">               <span class="comment">//XA rollback</span></div><div class="line">               String xacmd = <span class="string">&quot;XA ROLLBACK &quot;</span> + coordinatorLogEntry.id + <span class="string">&apos;;&apos;</span>;</div><div class="line">               OneRawSQLQueryResultHandler resultHandler = <span class="keyword">new</span> OneRawSQLQueryResultHandler(<span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> XARollbackCallback());</div><div class="line">               outloop:</div><div class="line">               <span class="keyword">for</span> (SchemaConfig schema : MycatServer.getInstance().getConfig().getSchemas().values()) {</div><div class="line">                   <span class="keyword">for</span> (TableConfig table : schema.getTables().values()) {</div><div class="line">                       <span class="keyword">for</span> (String dataNode : table.getDataNodes()) {</div><div class="line">                           PhysicalDBNode dn = MycatServer.getInstance().getConfig().getDataNodes().get(dataNode);</div><div class="line">                           <span class="keyword">if</span> (dn.getDbPool().getSource().getConfig().getIp().equals(participantLogEntry.uri)</div><div class="line">                                   &amp;&amp; dn.getDatabase().equals(participantLogEntry.resourceName)) {</div><div class="line">                               <span class="comment">//XA STATE ROLLBACK</span></div><div class="line">                               participantLogEntry.txState = TxState.TX_ROLLBACKED_STATE;</div><div class="line">                               SQLJob sqlJob = <span class="keyword">new</span> SQLJob(xacmd, dn.getDatabase(), resultHandler, dn.getDbPool().getSource());</div><div class="line">                               sqlJob.run();</div><div class="line">                               <span class="keyword">break</span> outloop;</div><div class="line">                           }</div><div class="line">                       }</div><div class="line">                   }</div><div class="line">               }</div><div class="line">           }</div><div class="line">       }</div><div class="line">   }</div><div class="line">   <span class="comment">// init into in memory cached</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) {</div><div class="line">  MultiNodeCoordinator.inMemoryRepository.put(coordinatorLogEntries[i].id, coordinatorLogEntries[i]);</div><div class="line">   }</div><div class="line">   <span class="comment">// discard the recovery log</span></div><div class="line">    MultiNodeCoordinator.fileRepository.writeCheckpoint(MultiNodeCoordinator.inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">}</div></pre></td></tr></table></figure>
<h1 id="4-MyCAT-&#x5B9E;&#x73B0;&#x7F3A;&#x9677;"><a href="#4-MyCAT-&#x5B9E;&#x73B0;&#x7F3A;&#x9677;" class="headerlink" title="4. MyCAT &#x5B9E;&#x73B0;&#x7F3A;&#x9677;"></a>4. MyCAT &#x5B9E;&#x73B0;&#x7F3A;&#x9677;</h1><p>MyCAT 1.6.5 &#x7248;&#x672C;&#x5B9E;&#x73B0;&#x5F31;XA&#x4E8B;&#x52A1;&#xFF0C;&#x76F8;&#x5BF9;&#x6765;&#x8BF4;&#xFF0C;&#x7B14;&#x8005;&#x8BA4;&#x4E3A;&#x8DDD;&#x79BB;&#x5B9E;&#x9645;&#x751F;&#x4EA7;&#x4F7F;&#x7528;&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x5DEE;&#x8DDD;&#x3002;&#x4E0B;&#x9762;&#x7F57;&#x5217;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x7684;&#x7F3A;&#x9677;&#xFF0C;&#x5982;&#x6709;&#x9519;&#x8BEF;&#xFF0C;&#x9EBB;&#x70E6;&#x6307;&#x51FA;&#x3002;&#x1F642;&#x5E0C;&#x671B; MyCAT &#x5728;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x7684;&#x5B9E;&#x73B0;&#x4E0A;&#xFF0C;&#x80FD;&#x591F;&#x8D8A;&#x6765;&#x8D8A;&#x7ED9;&#x529B;&#x3002;</p>
<h2 id="4-1-&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x5199;&#x5165;&#x6027;&#x80FD;"><a href="#4-1-&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x5199;&#x5165;&#x6027;&#x80FD;" class="headerlink" title="4.1 &#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x5199;&#x5165;&#x6027;&#x80FD;"></a>4.1 &#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x5199;&#x5165;&#x6027;&#x80FD;</h2><p>1&#x3001;<code>CoordinatorLogEntry</code>&#x3001;<code>ParticipantLogEntry</code> &#x5728;&#x6BCF;&#x6B21;&#x5199;&#x5165;&#x6587;&#x4EF6;&#x65F6;&#xFF0C;&#x662F;&#x5C06;&#x5185;&#x5B58;&#x4E2D;&#x6240;&#x6709;&#x7684;&#x65E5;&#x5FD7;<strong>&#x5168;&#x90E8;&#x91CD;&#x65B0;</strong>&#x5199;&#x5165;&#xFF0C;&#x5BFC;&#x81F4;&#x5199;&#x5165;&#x6027;&#x80FD;&#x968F;&#x7740; XA &#x4E8B;&#x52A1;&#x6B21;&#x6570;&#x7684;&#x589E;&#x52A0;&#xFF0C;&#x6027;&#x80FD;&#x4F1A;&#x8D8A;&#x6765;&#x8D8A;&#x7CDF;&#x7CD5;&#xFF0C;&#x5BFC;&#x81F4; XA &#x4E8B;&#x52A1;&#x6574;&#x4F53;&#x6027;&#x80FD;&#x4F1A;&#x975E;&#x5E38;&#x5DEE;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x662F;<strong>&#x540C;&#x6B65;</strong>&#x7684;&#xFF0C;&#x4E5F;&#x52A0;&#x5927;&#x4E86;&#x5199;&#x5165;&#x7684;&#x5EF6;&#x8FDF;&#x3002;</p>
<p>&#x5EFA;&#x8BAE;&#xFF1A;&#x5148;&#x83B7;&#x5F97;&#x53EF;&#x5199;&#x5165;&#x6587;&#x4EF6;&#x7684; OFFSET&#xFF0C;&#x5199;&#x5165;&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x5230;&#x6587;&#x4EF6;&#xFF0C;&#x5185;&#x5B58;&#x7EF4;&#x62A4;&#x597D; XA&#x4E8B;&#x52A1;&#x7F16;&#x53F7; &#x4E0E; OFFSET &#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;<strong>&#x987A;&#x5E8F;&#x5199;&#x5165;</strong> + <strong>&#x5E76;&#x884C;&#x5199;&#x5165;</strong>&#x3002;</p>
<p>2&#x3001;&#x5185;&#x5B58;&#x91CC;&#x7EF4;&#x62A4;&#x4E86;&#x6240;&#x6709;&#x7684;&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#xFF0C;&#x5360;&#x7528;&#x5185;&#x5B58;&#x4F1A;&#x8D8A;&#x6765;&#x8D8A;&#x5927;&#xFF0C;&#x5E76;&#x4E14;&#x65E0;&#x91CA;&#x653E;&#x673A;&#x5236;&#x3002;&#x5373;&#x4F7F;&#x91CD;&#x542F;&#xFF0C;&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x4E5F;&#x4F1A;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x5230;&#x5185;&#x5B58;&#x3002;</p>
<p>&#x5EFA;&#x8BAE;&#xFF1A;&#x5DF2;&#x5B8C;&#x5168;&#x56DE;&#x6EDA;&#x6216;&#x8005;&#x63D0;&#x4EA4;&#x7684;&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x4E0D;&#x653E;&#x5165;&#x5185;&#x5B58;&#x3002;&#x53E6;&#x5916;&#x6709;&#x6587;&#x4EF6;&#x5B58;&#x50A8;&#x597D; XA&#x4E8B;&#x52A1;&#x7F16;&#x53F7; &#x4E0E; OFFSET &#x7684;&#x6620;&#x5C04;&#x5173;&#x7CFB;&#x3002;</p>
<p>3&#x3001;&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x53EA;&#x5199;&#x5165;&#x5355;&#x4E2A;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x5EFA;&#x8BAE;&#xFF1A;&#x5206;&#x62C6;&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;&#x3002;</p>
<p>PS&#xFF1A;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x770B;&#x4E0B; <code>RocketMQ</code> &#x5BF9; <code>CommitLog</code> &#x7684;&#x5B58;&#x50A8;&#xFF0C;&#x6027;&#x80FD;&#x4E0A;&#x5F88;&#x8D5E;&#xFF01;</p>
<h2 id="4-2-&#x6570;&#x636E;&#x8282;&#x70B9;&#x672A;&#x5168;&#x90E8;-PREPARE-&#x5C31;&#x8FDB;&#x884C;-COMMIT"><a href="#4-2-&#x6570;&#x636E;&#x8282;&#x70B9;&#x672A;&#x5168;&#x90E8;-PREPARE-&#x5C31;&#x8FDB;&#x884C;-COMMIT" class="headerlink" title="4.2 &#x6570;&#x636E;&#x8282;&#x70B9;&#x672A;&#x5168;&#x90E8; PREPARE &#x5C31;&#x8FDB;&#x884C; COMMIT"></a>4.2 &#x6570;&#x636E;&#x8282;&#x70B9;&#x672A;&#x5168;&#x90E8; PREPARE &#x5C31;&#x8FDB;&#x884C; COMMIT</h2><p>XA &#x4E8B;&#x52A1;&#x5B9A;&#x4E49;&#xFF0C;&#x9700;&#x8981;&#x7B49;&#x5F85;&#x6240;&#x6709;&#x53C2;&#x4E0E;&#x8005;<strong>&#x5168;&#x90E8;</strong> <code>XA PREPARE</code> &#x6210;&#x529F;&#x5B8C;&#x6210;&#x540E;&#x53D1;&#x8D77; <code>XA COMMIT</code>&#x3002;&#x76EE;&#x524D; MyCAT &#x662F;&#x67D0;&#x4E2A;&#x6570;&#x636E;&#x8282;&#x70B9; <code>XA PREPARE</code> &#x5B8C;&#x6210;&#x540E;<strong>&#x7ACB;&#x5373;</strong>&#x8FDB;&#x884C; <code>XA COMMIT</code>&#x3002;&#x6BD4;&#x5982;&#x8BF4;&#xFF1A;&#x7B2C;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x8282;&#x70B9;&#x63D0;&#x4EA4;&#x4E86; <code>XA END;XA PREPARE</code> &#x65F6;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x6570;&#x636E;&#x8282;&#x5728;&#x8FDB;&#x884C; <code>XA END;XA PREAPRE;</code> &#x524D;&#x6302;&#x4E86;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x4F9D;&#x7136;&#x4F1A; <code>XA COMMIT</code> &#x6210;&#x529F;&#x3002;</p>
<p>&#x5EFA;&#x8BAE;&#xFF1A;&#x6309;&#x7167;&#x4E25;&#x683C;&#x7684; XA &#x4E8B;&#x52A1;&#x5B9A;&#x4E49;&#x3002;</p>
<h2 id="4-3-MyCAT-&#x542F;&#x52A8;&#x56DE;&#x6EDA;-PREPARE-&#x7684;-XA&#x4E8B;&#x52A1;"><a href="#4-3-MyCAT-&#x542F;&#x52A8;&#x56DE;&#x6EDA;-PREPARE-&#x7684;-XA&#x4E8B;&#x52A1;" class="headerlink" title="4.3 MyCAT &#x542F;&#x52A8;&#x56DE;&#x6EDA; PREPARE &#x7684; XA&#x4E8B;&#x52A1;"></a>4.3 MyCAT &#x542F;&#x52A8;&#x56DE;&#x6EDA; PREPARE &#x7684; XA&#x4E8B;&#x52A1;</h2><p>1&#x3001;MyCAT &#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x56DE;&#x6EDA;&#x6240;&#x6709;&#x7684; <code>PREPARE</code> &#x7684; XA &#x4E8B;&#x52A1;&#xFF0C;&#x53EF;&#x80FD;&#x67D0;&#x4E2A; XA &#x4E8B;&#x52A1;&#xFF0C;&#x90E8;&#x5206; <code>COMMIT</code>&#xFF0C;&#x90E8;&#x5206; <code>PREPARE</code>&#x3002;&#x6B64;&#x65F6;&#x76F4;&#x63A5;&#x56DE;&#x6EDA;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4;&#x6570;&#x636E;&#x4E0D;&#x4E00;&#x81F4;&#x3002;</p>
<p>&#x5EFA;&#x8BAE;&#xFF1A;&#x5F53;&#x5224;&#x65AD;&#x5230;&#x67D0;&#x4E2A; XA &#x4E8B;&#x52A1;&#x5B58;&#x5728; <code>PREPARE</code> &#x7684;&#x53C2;&#x4E0E;&#x8005;&#xFF0C;<strong>&#x540C;&#x65F6;&#x5224;&#x65AD;&#x8BE5; XA &#x4E8B;&#x52A1;&#x91CC;&#x5176;&#x4ED6;&#x53C2;&#x4E0E;&#x8005;&#x7684;&#x4E8B;&#x52A1;&#x72B6;&#x6001;</strong>&#x4EE5;&#x53CA;<strong>&#x6570;&#x636E;&#x8282;&#x70B9;&#x91CC; XA &#x4E8B;&#x52A1;&#x72B6;&#x6001;</strong>&#xFF0C;&#x6BD4;&#x5982;&#x53C2;&#x4E0E;&#x8005;&#x4E3A; <code>MySQL</code>&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; <code>XA RECOVER</code> &#x67E5;&#x8BE2;&#x5904;&#x4E8E; <code>PREPARE</code> &#x6240;&#x6709;&#x7684; XA &#x4E8B;&#x52A1;&#x3002;</p>
<p>2&#x3001;&#x56DE;&#x6EDA; <code>PREPARE</code> &#x662F;&#x5F02;&#x6B65;&#x8FDB;&#x884C;&#x7684;&#xFF0C;&#x5728;&#x672A;&#x8FDB;&#x884C;&#x5B8C;&#x6210;&#x65F6;&#x5DF2;&#x7ECF;&#x8BBE;&#x7F6E;&#x6587;&#x4EF6;&#x91CC;&#x56DE;&#x6EDA;&#x6210;&#x529F;&#x3002;&#x5982;&#x679C;&#x5F02;&#x6B65;&#x8FC7;&#x7A0B;&#x4E2D;&#x5931;&#x8D25;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4; XA &#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x4E0D;&#x4E00;&#x81F4;&#x3002;</p>
<p>&#x5EFA;&#x8BAE;&#xFF1A;&#x56DE;&#x8C03;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x66F4;&#x65B0;&#x8BE5; XA &#x4E8B;&#x52A1;&#x72B6;&#x6001;&#x3002;</p>
<h2 id="4-4-&#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1;&#x672A;&#x8BB0;&#x5F55;&#x534F;&#x8C03;&#x65E5;&#x5FD7;"><a href="#4-4-&#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1;&#x672A;&#x8BB0;&#x5F55;&#x534F;&#x8C03;&#x65E5;&#x5FD7;" class="headerlink" title="4.4 &#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1;&#x672A;&#x8BB0;&#x5F55;&#x534F;&#x8C03;&#x65E5;&#x5FD7;"></a>4.4 &#x5355;&#x8282;&#x70B9;&#x4E8B;&#x52A1;&#x672A;&#x8BB0;&#x5F55;&#x534F;&#x8C03;&#x65E5;&#x5FD7;</h2><p>&#x8BE5;&#x60C5;&#x51B5;&#x8F83;&#x4E3A;&#x6781;&#x7AEF;&#x3002;&#x53D1;&#x8D77; <code>XA PREPARE</code>&#x5B8C;&#x540E;&#xFF0C;MyCAT &#x6302;&#x4E86;&#x3002;&#x91CD;&#x542F;&#x540E;&#xFF0C;&#x8BE5; XA &#x4E8B;&#x52A1;&#x5728; MyCAT &#x91CC;&#x5C31;&#x201C;&#x6D88;&#x5931;&#x201C;&#x4E86;&#xFF0C;&#x53C2;&#x4E0E;&#x8005;&#x7684;&#x8BE5; XA &#x4E8B;&#x52A1;&#x4E00;&#x76F4;&#x5904;&#x4E8E; <code>PREPARE</code> &#x72B6;&#x6001;&#x3002;&#x4ECE;&#x7406;&#x8BBA;&#x4E0A;&#x6765;&#x8BF4;&#xFF0C;&#x9700;&#x8981;&#x56DE;&#x6EDA;&#x8BE5; XA &#x4E8B;&#x52A1;&#x3002;</p>
<p>&#x5EFA;&#x8BAE;&#xFF1A;&#x8BB0;&#x5F55;&#x534F;&#x8C03;&#x65E5;&#x5FD7;&#x3002;</p>
<h2 id="4-5-XA-COMMIT-&#x90E8;&#x5206;&#x8282;&#x70B9;&#x6302;&#x4E86;&#x91CD;&#x65B0;&#x6062;&#x590D;&#x540E;&#xFF0C;&#x672A;&#x8FDB;&#x4E00;&#x6B65;&#x5904;&#x7406;"><a href="#4-5-XA-COMMIT-&#x90E8;&#x5206;&#x8282;&#x70B9;&#x6302;&#x4E86;&#x91CD;&#x65B0;&#x6062;&#x590D;&#x540E;&#xFF0C;&#x672A;&#x8FDB;&#x4E00;&#x6B65;&#x5904;&#x7406;" class="headerlink" title="4.5 XA COMMIT &#x90E8;&#x5206;&#x8282;&#x70B9;&#x6302;&#x4E86;&#x91CD;&#x65B0;&#x6062;&#x590D;&#x540E;&#xFF0C;&#x672A;&#x8FDB;&#x4E00;&#x6B65;&#x5904;&#x7406;"></a>4.5 XA COMMIT &#x90E8;&#x5206;&#x8282;&#x70B9;&#x6302;&#x4E86;&#x91CD;&#x65B0;&#x6062;&#x590D;&#x540E;&#xFF0C;&#x672A;&#x8FDB;&#x4E00;&#x6B65;&#x5904;&#x7406;</h2><p>&#x5F53;&#x4E00;&#x90E8;&#x5206;&#x8282;&#x70B9; <code>XA COMMIT</code> &#x5B8C;&#x6210;&#xFF0C;&#x53E6;&#x5916;&#x4E00;&#x90E8;&#x5206;&#x6B64;&#x65F6;&#x6302;&#x4E86;&#x3002;&#x5728;&#x7BA1;&#x7406;&#x5458;&#x91CD;&#x542F;&#x6302;&#x6389;&#x7684;&#x8282;&#x70B9;&#xFF0C;&#x5176;&#x5BF9;&#x5E94;&#x7684; XA &#x4E8B;&#x52A1;&#x672A;&#x8FDB;&#x4E00;&#x6B65;&#x5904;&#x7406;&#xFF0C;&#x5BFC;&#x81F4;&#x6570;&#x636E;&#x4E0D;&#x4E00;&#x81F4;&#x3002;</p>
<p>&#x5EFA;&#x8BAE;&#xFF1A;&#x1F608;&#x6728;&#x6709;&#x5EFA;&#x8BAE;&#x3002;&#x4E5F;&#x5F88;&#x597D;&#x5947;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x5982;&#x4F55;&#x5904;&#x7406;&#x8F83;&#x4E3A;&#x5408;&#x9002;&#x3002;&#x5982;&#x6709;&#x5927;&#x5927;&#x77E5;&#x9053;&#xFF0C;&#x70E6;&#x8BF7;&#x544A;&#x77E5;&#x4E0B;&#x3002;</p>
<h1 id="5-&#x5F69;&#x86CB;"><a href="#5-&#x5F69;&#x86CB;" class="headerlink" title="5. &#x5F69;&#x86CB;"></a>5. &#x5F69;&#x86CB;</h1><p>&#x4F8B;&#x884C;&#x201C;&#x5F69;&#x86CB;&#x201D;&#xFF1F;</p>
<ul class="ui list">
<li><a href="http://blog.csdn.net/d6619309/article/details/52330334" rel="external nofollow noopener noreferrer" target="_blank">&#x300A;Mycat&#x6E90;&#x7801;&#x7BC7; : MyCat&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x673A;&#x5236;&#x5206;&#x6790;&#x300B;</a> &#x6765;&#x81EA; MyCAT Committer &#x7684;&#x6587;&#x7AE0;</li>
<li><a href="http://mysql.taobao.org/monthly/2015/04/05/" rel="external nofollow noopener noreferrer" target="_blank">&#x300A;MySQL &#xB7; &#x6349;&#x866B;&#x52A8;&#x6001; &#xB7; &#x8FDE;&#x63A5;&#x65AD;&#x5F00;&#x5BFC;&#x81F4;XA&#x4E8B;&#x52A1;&#x4E22;&#x5931;&#x300B;</a></li>
<li><a href="http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency" rel="external nofollow noopener noreferrer" target="_blank">&#x300A;&#x5206;&#x5E03;&#x5F0F;&#x7CFB;&#x7EDF;&#x4E8B;&#x52A1;&#x4E00;&#x81F4;&#x6027;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x300B;</a></li>
<li><a href="http://blog.csdn.net/fly2749/article/details/44998203" rel="external nofollow noopener noreferrer" target="_blank">&#x300A;MySQL&#x6570;&#x636E;&#x5E93;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;XA&#x4F18;&#x7F3A;&#x70B9;&#x4E0E;&#x6539;&#x8FDB;&#x65B9;&#x6848;&#x300B;</a></li>
<li><a href="http://www.hollischuang.com/archives/1580" rel="external nofollow noopener noreferrer" target="_blank">&#x300A;&#x6DF1;&#x5165;&#x7406;&#x89E3;&#x5206;&#x5E03;&#x5F0F;&#x7CFB;&#x7EDF;&#x7684;2PC&#x548C;3PC&#x300B;</a></li>
<li><a href="https://github.com/YunaiV/yunaiv.github.io/blob/master/source/_drafts/MyCAT/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.xmind" target="_blank" rel="external">&#x3010;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;.xmind&#x3011;</a> &#x7B14;&#x8005;&#x62D9;&#x4F5C; </li>
<li><a href="http://www.yunai.me/RocketMQ/message-transaction/?self">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; &#x4E8B;&#x52A1;&#x6D88;&#x606F;&#x300B;</a> &#x7B14;&#x8005;&#x62D9;&#x4F5C;</li>
</ul>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-概述"><span class="toc-number">1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-XA-概念"><span class="toc-number">2.</span> <span class="toc-text">2. XA 概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-MyCAT-代码实现"><span class="toc-number">3.</span> <span class="toc-text">3. MyCAT 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-JDBC-Demo-代码"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 JDBC Demo 代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-MyCAT-开启-XA-事务"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 MyCAT 开启 XA 事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-MyCAT-接收-SQL"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 MyCAT 接收 SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-MySQL-接收-COMMIT"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 MySQL 接收 COMMIT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-单节点事务-or-多节点事务"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 单节点事务 or 多节点事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-协调日志"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 协调日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-MultiNodeCoordinator"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 MultiNodeCoordinator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-MyCAT-启动回滚-XA事务"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 MyCAT 启动回滚 XA事务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-MyCAT-实现缺陷"><span class="toc-number">4.</span> <span class="toc-text">4. MyCAT 实现缺陷</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-协调日志写入性能"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 协调日志写入性能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-数据节点未全部-PREPARE-就进行-COMMIT"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 数据节点未全部 PREPARE 就进行 COMMIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-MyCAT-启动回滚-PREPARE-的-XA事务"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 MyCAT 启动回滚 PREPARE 的 XA事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-单节点事务未记录协调日志"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 单节点事务未记录协调日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-XA-COMMIT-部分节点挂了重新恢复后，未进一步处理"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 XA COMMIT 部分节点挂了重新恢复后，未进一步处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-彩蛋"><span class="toc-number">5.</span> <span class="toc-text">5. 彩蛋</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/MyCAT/xa-distributed-transaction/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&text=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&is_video=false&description=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MyCAT 源码分析  —— XA分布式事务&body=Check out this article: http://www.yunai.me/MyCAT/xa-distributed-transaction/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCAT 源码分析  —— XA分布式事务" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&name=MyCAT 源码分析  —— XA分布式事务&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 王文斌
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO 待优化：过滤 爬虫
        url = $('#actions .icon').attr('href').trim(); // 文章url
//        alert(url);
        title = $('.posttitle').text().trim(); // 文章标题
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // 插入次数
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // 插入次数
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // 获取uid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip 浏览器无法获取
        // time 服务端已经记录
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO 待优化：此处性能较差，可能
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // 判断是否在文章页
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // 增加文章访问次数
                addCount(Counter);
            }
            // 记录访问日志
            addVisitLog();
            // 计算多少人访问
            countVisitLog();
        }, 1000);
    });
</script>
