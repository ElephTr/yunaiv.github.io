<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="ÂéüÊñáÂú∞ÂùÄÔºöhttp://www.yunai.me/MyCAT/xa-distributed-transaction/MyCat-Server Â∏¶Ê≥®Èáä‰ª£Á†ÅÂú∞ÂùÄ Ôºöhttps://github.com/YunaiV/Mycat-ServerüòàÊú¨Á≥ªÂàóÊØè 1-2 Âë®Êõ¥Êñ∞‰∏ÄÁØáÔºåÊ¨¢ËøéËÆ¢ÈòÖ„ÄÅÂÖ≥Ê≥®„ÄÅÊî∂Ëóè ÂÖ¨‰ºóÂè∑QQ Ôºö7685413     1. Ê¶ÇËø∞ 2. XA Ê¶ÇÂøµ 3. MyCAT ‰ª£Á†ÅÂÆûÁé∞ 3.1">
<meta name="keywords" content="Java,Êû∂ÊûÑ,ÂêéÁ´Ø,ÊúçÂä°Á´Ø,RocketMQ,MyCAT,ÂàÜÂ∏ÉÂºèÊ∂àÊÅØÈòüÂàó,ÂàÜÂ∏ÉÂºèÂ≠òÂÇ®,ÊäÄÊúØÂçöÂÆ¢">
<meta property="og:type" content="article">
<meta property="og:title" content="MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°">
<meta property="og:url" content="http://www.yunai.me/MyCAT/xa-distributed-transaction/index.html">
<meta property="og:site_name" content="ËäãËâøVÁöÑÂçöÂÆ¢">
<meta property="og:description" content="ÂéüÊñáÂú∞ÂùÄÔºöhttp://www.yunai.me/MyCAT/xa-distributed-transaction/MyCat-Server Â∏¶Ê≥®Èáä‰ª£Á†ÅÂú∞ÂùÄ Ôºöhttps://github.com/YunaiV/Mycat-ServerüòàÊú¨Á≥ªÂàóÊØè 1-2 Âë®Êõ¥Êñ∞‰∏ÄÁØáÔºåÊ¨¢ËøéËÆ¢ÈòÖ„ÄÅÂÖ≥Ê≥®„ÄÅÊî∂Ëóè ÂÖ¨‰ºóÂè∑QQ Ôºö7685413     1. Ê¶ÇËø∞ 2. XA Ê¶ÇÂøµ 3. MyCAT ‰ª£Á†ÅÂÆûÁé∞ 3.1">
<meta property="og:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_07_15/01.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_07_15/02.png">
<meta property="og:image" content="http://www.yunai.me/images/MyCAT/2017_07_15/03.png">
<meta property="og:updated_time" content="2017-07-15T12:21:54.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°">
<meta name="twitter:description" content="ÂéüÊñáÂú∞ÂùÄÔºöhttp://www.yunai.me/MyCAT/xa-distributed-transaction/MyCat-Server Â∏¶Ê≥®Èáä‰ª£Á†ÅÂú∞ÂùÄ Ôºöhttps://github.com/YunaiV/Mycat-ServerüòàÊú¨Á≥ªÂàóÊØè 1-2 Âë®Êõ¥Êñ∞‰∏ÄÁØáÔºåÊ¨¢ËøéËÆ¢ÈòÖ„ÄÅÂÖ≥Ê≥®„ÄÅÊî∂Ëóè ÂÖ¨‰ºóÂè∑QQ Ôºö7685413     1. Ê¶ÇËø∞ 2. XA Ê¶ÇÂøµ 3. MyCAT ‰ª£Á†ÅÂÆûÁé∞ 3.1">
<meta name="twitter:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,Êû∂ÊûÑ,ÂêéÁ´Ø,ÊúçÂä°Á´Ø,RocketMQ,MyCAT,ÂàÜÂ∏ÉÂºèÊ∂àÊÅØÈòüÂàó,ÂàÜÂ∏ÉÂºèÂ≠òÂÇ®,ÊäÄÊúØÂçöÂÆ¢">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- ÁôæÂ∫¶ÁªüËÆ° -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- ÁôæÂ∫¶Á´ôÈïø-Ë¢´Âä®Êé®ÈÄÅ -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360ÊêúÁ¥¢-Ëá™Âä®Êî∂ÂΩï -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/Sharding-JDBC/why-read-Sharding-JDBC-source-code/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$(" #i-prev").toggle();"="" onmouseout="$("></i></a></li>
        
        
        <li><a class="icon" href="/MyCAT/two-table-share-join/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/MyCAT/xa-distributed-transaction/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&text=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&is_video=false&description=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°&body=Check out this article: http://www.yunai.me/MyCAT/xa-distributed-transaction/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&name=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Ê¶ÇËø∞"><span class="toc-number">1.</span> <span class="toc-text">1. Ê¶ÇËø∞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-XA-Ê¶ÇÂøµ"><span class="toc-number">2.</span> <span class="toc-text">2. XA Ê¶ÇÂøµ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-MyCAT-‰ª£Á†ÅÂÆûÁé∞"><span class="toc-number">3.</span> <span class="toc-text">3. MyCAT ‰ª£Á†ÅÂÆûÁé∞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-JDBC-Demo-‰ª£Á†Å"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 JDBC Demo ‰ª£Á†Å</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-MyCAT-ÂºÄÂêØ-XA-‰∫ãÂä°"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 MyCAT ÂºÄÂêØ XA ‰∫ãÂä°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-MyCAT-Êé•Êî∂-SQL"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 MyCAT Êé•Êî∂ SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-MySQL-Êé•Êî∂-COMMIT"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 MySQL Êé•Êî∂ COMMIT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-ÂçïËäÇÁÇπ‰∫ãÂä°-or-Â§öËäÇÁÇπ‰∫ãÂä°"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 ÂçïËäÇÁÇπ‰∫ãÂä° or Â§öËäÇÁÇπ‰∫ãÂä°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-ÂçèË∞ÉÊó•Âøó"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 ÂçèË∞ÉÊó•Âøó</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-MultiNodeCoordinator"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 MultiNodeCoordinator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-MyCAT-ÂêØÂä®ÂõûÊªö-XA‰∫ãÂä°"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 MyCAT ÂêØÂä®ÂõûÊªö XA‰∫ãÂä°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-MyCAT-ÂÆûÁé∞Áº∫Èô∑"><span class="toc-number">4.</span> <span class="toc-text">4. MyCAT ÂÆûÁé∞Áº∫Èô∑</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-ÂçèË∞ÉÊó•ÂøóÂÜôÂÖ•ÊÄßËÉΩ"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 ÂçèË∞ÉÊó•ÂøóÂÜôÂÖ•ÊÄßËÉΩ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-Êï∞ÊçÆËäÇÁÇπÊú™ÂÖ®ÈÉ®-PREPARE-Â∞±ËøõË°å-COMMIT"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 Êï∞ÊçÆËäÇÁÇπÊú™ÂÖ®ÈÉ® PREPARE Â∞±ËøõË°å COMMIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-MyCAT-ÂêØÂä®ÂõûÊªö-PREPARE-ÁöÑ-XA‰∫ãÂä°"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 MyCAT ÂêØÂä®ÂõûÊªö PREPARE ÁöÑ XA‰∫ãÂä°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-ÂçïËäÇÁÇπ‰∫ãÂä°Êú™ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 ÂçïËäÇÁÇπ‰∫ãÂä°Êú™ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-XA-COMMIT-ÈÉ®ÂàÜËäÇÁÇπÊåÇ‰∫ÜÈáçÊñ∞ÊÅ¢Â§çÂêéÔºåÊú™Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 XA COMMIT ÈÉ®ÂàÜËäÇÁÇπÊåÇ‰∫ÜÈáçÊñ∞ÊÅ¢Â§çÂêéÔºåÊú™Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-ÂΩ©Ëõã"><span class="toc-number">5.</span> <span class="toc-text">5. ÂΩ©Ëõã</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">ËäãËâøVÁöÑÂçöÂÆ¢</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-07-14T16:00:00.000Z" itemprop="datePublished">2017-07-15</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <blockquote>
<p> ÂéüÊñáÂú∞ÂùÄÔºö<a href="http://www.yunai.me/MyCAT/xa-distributed-transaction/">http://www.yunai.me/MyCAT/xa-distributed-transaction/</a><br><code>MyCat-Server</code> <strong>Â∏¶Ê≥®Èáä‰ª£Á†Å</strong>Âú∞ÂùÄ Ôºö<a href="https://github.com/YunaiV/Mycat-Server" target="_blank" rel="external">https://github.com/YunaiV/Mycat-Server</a><br><strong>üòàÊú¨Á≥ªÂàóÊØè 1-2 Âë®Êõ¥Êñ∞‰∏ÄÁØáÔºåÊ¨¢ËøéËÆ¢ÈòÖ„ÄÅÂÖ≥Ê≥®„ÄÅÊî∂Ëóè ÂÖ¨‰ºóÂè∑</strong><br>QQ Ôºö7685413</p>
</blockquote>
<p><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="wechat_mp"></p>
<hr>
<ul>
<li><a href="#">1. Ê¶ÇËø∞</a></li>
<li><a href="#">2. XA Ê¶ÇÂøµ</a></li>
<li><a href="#">3. MyCAT ‰ª£Á†ÅÂÆûÁé∞</a><ul>
<li><a href="#">3.1 JDBC Demo ‰ª£Á†Å</a></li>
<li><a href="#">3.2 MyCAT ÂºÄÂêØ XA ‰∫ãÂä°</a></li>
<li><a href="#">3.3 MyCAT Êé•Êî∂ SQL</a></li>
<li><a href="#">3.4 MySQL Êé•Êî∂ COMMIT</a><ul>
<li><a href="#">3.4.1 ÂçïËäÇÁÇπ‰∫ãÂä° or Â§öËäÇÁÇπ‰∫ãÂä°</a></li>
<li><a href="#">3.4.2 ÂçèË∞ÉÊó•Âøó</a></li>
<li><a href="#">3.4.3 MultiNodeCoordinator</a></li>
</ul>
</li>
<li><a href="#">3.5 MyCAT ÂêØÂä®ÂõûÊªö XA‰∫ãÂä°</a></li>
</ul>
</li>
<li><a href="#">4. MyCAT ÂÆûÁé∞Áº∫Èô∑</a><ul>
<li><a href="#">4.1 ÂçèË∞ÉÊó•ÂøóÂÜôÂÖ•ÊÄßËÉΩ</a></li>
<li><a href="#">4.2 Êï∞ÊçÆËäÇÁÇπÊú™ÂÖ®ÈÉ® PREPARE Â∞±ËøõË°å COMMIT</a></li>
<li><a href="#">4.3 MyCAT ÂêØÂä®ÂõûÊªö PREPARE ÁöÑ XA‰∫ãÂä°</a></li>
<li><a href="#">4.4 ÂçïËäÇÁÇπ‰∫ãÂä°Êú™ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó</a></li>
<li><a href="#">4.5 XA COMMIT ÈÉ®ÂàÜËäÇÁÇπÊåÇ‰∫ÜÈáçÊñ∞ÊÅ¢Â§çÂêéÔºåÊú™Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ</a></li>
</ul>
</li>
<li><a href="#">5. ÂΩ©Ëõã</a></li>
</ul>
<hr>
<h1 id="1-Ê¶ÇËø∞"><a href="#1-Ê¶ÇËø∞" class="headerlink" title="1. Ê¶ÇËø∞"></a>1. Ê¶ÇËø∞</h1><p>Êï∞ÊçÆÂ∫ìÊãÜÂàÜÂêéÔºå‰∏öÂä°‰∏ä‰ºöÁ¢∞Âà∞ÈúÄË¶ÅÂàÜÂ∏ÉÂºè‰∫ãÂä°ÁöÑÂú∫ÊôØ„ÄÇMyCAT Âü∫‰∫é XA ÂÆûÁé∞ÂàÜÂ∏ÉÂºè‰∫ãÂä°„ÄÇÂõΩÂÜÖÁõÆÂâçÂè¶Â§ñ‰∏ÄÊ¨æÂæàÁÅ´ÁöÑÊï∞ÊçÆÂ∫ì‰∏≠Èó¥‰ª∂ Sharding-JDBC ÂáÜÂ§áÂü∫‰∫é TCC ÂÆûÁé∞ÂàÜÂ∏ÉÂºè‰∫ãÂä°„ÄÇ</p>
<p>Êú¨ÊñáÂÜÖÂÆπÂàÜÊàê‰∏âÈÉ®ÂàÜÔºö</p>
<ol>
<li>XA Ê¶ÇÂøµÁÆÄËø∞</li>
<li>MyCAT ‰ª£Á†ÅÂ¶Ç‰ΩïÂÆûÁé∞ XA</li>
<li>MyCAT Âú®ÂÆûÁé∞ XA Â≠òÂú®ÁöÑ‰∏Ä‰∫õÁº∫Èô∑</li>
</ol>
<h1 id="2-XA-Ê¶ÇÂøµ"><a href="#2-XA-Ê¶ÇÂøµ" class="headerlink" title="2. XA Ê¶ÇÂøµ"></a>2. XA Ê¶ÇÂøµ</h1><p>&gt;<br>X/Open ÁªÑÁªáÔºàÂç≥Áé∞Âú®ÁöÑ Open Group ÔºâÂÆö‰πâ‰∫ÜÂàÜÂ∏ÉÂºè‰∫ãÂä°Â§ÑÁêÜÊ®°Âûã„ÄÇ X/Open DTP Ê®°ÂûãÔºà 1994 ÔºâÂåÖÊã¨Ôºö  </p>
<ol>
<li>Â∫îÁî®Á®ãÂ∫èÔºà <strong>AP</strong> Ôºâ  </li>
<li>‰∫ãÂä°ÁÆ°ÁêÜÂô®Ôºà <strong>TM</strong> Ôºâ  </li>
<li>ËµÑÊ∫êÁÆ°ÁêÜÂô®Ôºà <strong>RM</strong> Ôºâ  </li>
<li>ÈÄö‰ø°ËµÑÊ∫êÁÆ°ÁêÜÂô®Ôºà <strong>CRM</strong> Ôºâ<br>‰∏ÄËà¨ÔºåÂ∏∏ËßÅÁöÑ‰∫ãÂä°ÁÆ°ÁêÜÂô®Ôºà TM ÔºâÊòØ‰∫§Êòì‰∏≠Èó¥‰ª∂ÔºåÂ∏∏ËßÅÁöÑËµÑÊ∫êÁÆ°ÁêÜÂô®Ôºà <strong>RM</strong> ÔºâÊòØÊï∞ÊçÆÂ∫ìÔºåÂ∏∏ËßÅÁöÑÈÄö‰ø°ËµÑÊ∫êÁÆ°ÁêÜÂô®Ôºà <strong>CRM</strong> ÔºâÊòØÊ∂àÊÅØ‰∏≠Èó¥‰ª∂Ôºå‰∏ãÂõæÊòØX/Open DTPÊ®°ÂûãÔºö</li>
</ol>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/01.png" alt=""></p>
<blockquote>
<p>‰∏ÄËà¨ÁöÑÁºñÁ®ãÊñπÂºèÊòØËøôÊ†∑ÁöÑÔºö  </p>
<ol>
<li>ÈÖçÁΩÆ <strong>TM</strong> ÔºåÈÄöËøá <strong>TM</strong> ÊàñËÄÖ <strong>RM</strong> Êèê‰æõÁöÑÊñπÂºèÔºåÊää <strong>RM</strong> Ê≥®ÂÜåÂà∞ <strong>TM</strong>„ÄÇÂèØ‰ª•ÁêÜËß£‰∏∫Áªô <strong>TM</strong> Ê≥®ÂÜå <strong>RM</strong> ‰Ωú‰∏∫Êï∞ÊçÆÊ∫ê„ÄÇ‰∏Ä‰∏™ <strong>TM</strong> ÂèØ‰ª•Ê≥®ÂÜåÂ§ö‰∏™ <strong>RM</strong>„ÄÇ  </li>
<li><strong>AP</strong> ‰ªé <strong>TM</strong> Ëé∑ÂèñËµÑÊ∫êÁÆ°ÁêÜÂô®ÁöÑ‰ª£ÁêÜÔºà‰æãÂ¶ÇÔºö‰ΩøÁî®JTAÊé•Âè£Ôºå‰ªéTMÁÆ°ÁêÜÁöÑ‰∏ä‰∏ãÊñá‰∏≠ÔºåËé∑ÂèñÂá∫Ëøô‰∏™TMÊâÄÁÆ°ÁêÜÁöÑRMÁöÑJDBCËøûÊé•ÊàñJMSËøûÊé•Ôºâ<br><strong>AP</strong> Âêë <strong>TM</strong> ÂèëËµ∑‰∏Ä‰∏™ÂÖ®Â±Ä‰∫ãÂä°„ÄÇËøôÊó∂Ôºå<strong>TM</strong> ‰ºöÈÄöÁü•ÂêÑ‰∏™ <strong>RM</strong>„ÄÇ<strong>XID</strong>ÔºàÂÖ®Â±Ä‰∫ãÂä°IDÔºâ‰ºöÈÄöÁü•Âà∞ÂêÑ‰∏™RM„ÄÇ  </li>
<li><strong>AP</strong> ÈÄöËøá <strong>TM</strong> ‰∏≠Ëé∑ÂèñÁöÑËøûÊé•Ôºå<strong>Èó¥Êé•</strong>Êìç‰Ωú <strong>RM</strong> ËøõË°å‰∏öÂä°Êìç‰Ωú„ÄÇËøôÊó∂Ôºå<strong>TM</strong> Âú®ÊØèÊ¨° <strong>AP</strong> Êìç‰ΩúÊó∂Êää <strong>XID</strong>(ÂåÖÊã¨ÊâÄÂ±ûÂàÜÊîØÁöÑ‰ø°ÊÅØ)‰º†ÈÄíÁªô <strong>RM</strong>Ôºå<strong>RM</strong> Ê≠£ÊòØÈÄöËøáËøô‰∏™ <strong>XID</strong> ÂÖ≥ËÅîÊù•Êìç‰ΩúÂíå‰∫ãÂä°ÁöÑÂÖ≥Á≥ªÁöÑ„ÄÇ  </li>
<li><strong>AP</strong> ÁªìÊùüÂÖ®Â±Ä‰∫ãÂä°Êó∂Ôºå<strong>TM</strong> ‰ºöÈÄöÁü• <strong>RM</strong> ÂÖ®Â±Ä‰∫ãÂä°ÁªìÊùü„ÄÇÂºÄÂßã‰∫åÊÆµÊèê‰∫§Ôºå‰πüÂ∞±ÊòØprepare - commitÁöÑËøáÁ®ã„ÄÇ</li>
</ol>
</blockquote>
<hr>
<blockquote>
<p>XAÂçèËÆÆÊåáÁöÑÊòØTMÔºà‰∫ãÂä°ÁÆ°ÁêÜÂô®ÔºâÂíåRMÔºàËµÑÊ∫êÁÆ°ÁêÜÂô®Ôºâ‰πãÈó¥ÁöÑÊé•Âè£„ÄÇÁõÆÂâç‰∏ªÊµÅÁöÑÂÖ≥Á≥ªÂûãÊï∞ÊçÆÂ∫ì‰∫ßÂìÅÈÉΩÊòØÂÆûÁé∞‰∫ÜXAÊé•Âè£ÁöÑ„ÄÇJTA(Java Transaction API)ÊòØÁ¨¶ÂêàX/Open DTPÊ®°ÂûãÁöÑÔºå‰∫ãÂä°ÁÆ°ÁêÜÂô®ÂíåËµÑÊ∫êÁÆ°ÁêÜÂô®‰πãÈó¥‰πü‰ΩøÁî®‰∫ÜXAÂçèËÆÆ„ÄÇ Êú¨Ë¥®‰∏ä‰πüÊòØÂÄüÂä©‰∏§Èò∂ÊÆµÊèê‰∫§ÂçèËÆÆÊù•ÂÆûÁé∞ÂàÜÂ∏ÉÂºè‰∫ãÂä°ÁöÑÔºå‰∏ãÈù¢ÂàÜÂà´Êù•ÁúãÁúãXA‰∫ãÂä°ÊàêÂäüÂíåÂ§±Ë¥•ÁöÑÊ®°ÂûãÂõæÔºö</p>
</blockquote>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/02.png" alt="ÊàêÂäü"></p>
<p><img src="http://www.yunai.me/images/MyCAT/2017_07_15/03.png" alt="Â§±Ë¥•"></p>
<hr>
<p>üòà ÁúãÂà∞ËøôÈáåÊòØ‰∏çÊòØÊúâÁßçÈªë‰∫∫ÈóÆÂè∑ÁöÑÊÑüËßâÔºüÊ∑°ÂÆöÔºÅÊàë‰ª¨Êé•‰∏ãÊù•Áúã MyCAT ‰ª£Á†ÅÂ±ÇÈù¢ÊòØÂ¶Ç‰ΩïÂÆûÁé∞ XA ÁöÑ„ÄÇÂè¶Â§ñÔºåÊúâÂÖ¥Ë∂£ÂØπÊ¶ÇÂøµ‰∫ÜËß£Êõ¥Â§öÁöÑÔºåÂèØ‰ª•ÂèÇÁúãÂ¶Ç‰∏ãÊñáÁ´†Ôºö</p>
<ol>
<li><a href="http://www.infoq.com/cn/articles/xa-transactions-handle" rel="external nofollow noopener noreferrer" target="_blank">„ÄäXA‰∫ãÂä°Â§ÑÁêÜ„Äã</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html" rel="external nofollow noopener noreferrer" target="_blank">„ÄäXA Transaction SQL Syntax„Äã</a></li>
<li><a href="http://www.voidcn.com/blog/gao1738/article/p-4554083.html" rel="external nofollow noopener noreferrer" target="_blank">„ÄäMySQL XA ‰∫ãÂä°ÊîØÊåÅË∞ÉÁ†î„Äã</a></li>
</ol>
<h1 id="3-MyCAT-‰ª£Á†ÅÂÆûÁé∞"><a href="#3-MyCAT-‰ª£Á†ÅÂÆûÁé∞" class="headerlink" title="3. MyCAT ‰ª£Á†ÅÂÆûÁé∞"></a>3. MyCAT ‰ª£Á†ÅÂÆûÁé∞</h1><ul>
<li>MyCAT ÔºöTMÔºåÂçèË∞ÉËÄÖ„ÄÇ</li>
<li>Êï∞ÊçÆËäÇÁÇπ ÔºöRMÔºåÂèÇ‰∏éËÄÖ„ÄÇ</li>
</ul>
<h2 id="3-1-JDBC-Demo-‰ª£Á†Å"><a href="#3-1-JDBC-Demo-‰ª£Á†Å" class="headerlink" title="3.1 JDBC Demo ‰ª£Á†Å"></a>3.1 JDBC Demo ‰ª£Á†Å</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCATXAClientDemo</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</div><div class="line">        <span class="comment">// 1. Ëé∑ÂæóÊï∞ÊçÆÂ∫ìËøûÊé•</span></div><div class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</div><div class="line">        Connection conn = DriverManager.getConnection(<span class="string">"jdbc:mysql://127.0.0.1:8066/dbtest"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>);</div><div class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 2. ÂºÄÂêØ MyCAT XA ‰∫ãÂä°</span></div><div class="line">        conn.prepareStatement(<span class="string">"set xa=on"</span>).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 3. ÊèíÂÖ• SQL</span></div><div class="line">        <span class="comment">// 3.1 SQL1 AÂ∫ì</span></div><div class="line">        <span class="keyword">long</span> uid = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String username = UUID.randomUUID().toString();</div><div class="line">        String password = UUID.randomUUID().toString();</div><div class="line">        String sql1 = String.format(<span class="string">"insert into t_user(id, username, password) VALUES (%d, '%s', '%s')"</span>,</div><div class="line">                uid, username, password);</div><div class="line">        conn.prepareStatement(sql1).execute();</div><div class="line">        <span class="comment">// 3.2 SQL2 BÂ∫ì</span></div><div class="line">        <span class="keyword">long</span> orderId = Math.abs(<span class="keyword">new</span> Random().nextLong());</div><div class="line">        String nickname = UUID.randomUUID().toString();</div><div class="line">        String sql2 = String.format(<span class="string">"insert into t_order(id, uid, nickname) VALUES(%d, %s, '%s')"</span>, orderId, uid, nickname);</div><div class="line">        conn.prepareStatement(sql2).execute();</div><div class="line"></div><div class="line">        <span class="comment">// 4. Êèê‰∫§ XA ‰∫ãÂä°</span></div><div class="line">        conn.commit();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>set xa=on</code> MyCAT ÂºÄÂêØ XA ‰∫ãÂä°„ÄÇ</li>
<li><code>conn.commit</code> Êèê‰∫§ XA ‰∫ãÂä°„ÄÇ </li>
</ul>
<h2 id="3-2-MyCAT-ÂºÄÂêØ-XA-‰∫ãÂä°"><a href="#3-2-MyCAT-ÂºÄÂêØ-XA-‰∫ãÂä°" class="headerlink" title="3.2 MyCAT ÂºÄÂêØ XA ‰∫ãÂä°"></a>3.2 MyCAT ÂºÄÂêØ XA ‰∫ãÂä°</h2><p>ÂΩì MyCAT Êé•Êî∂Âà∞ <code>set xa = on</code> ÂëΩ‰ª§Êó∂ÔºåÂºÄÂêØ XA ‰∫ãÂä°ÔºåÂπ∂ÁîüÊàê XA ‰∫ãÂä°ÁºñÂè∑„ÄÇXA ‰∫ãÂä°ÁºñÂè∑ÁîüÊàêÁÆóÊ≥ï‰∏∫ UUID„ÄÇÊ†∏ÂøÉ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SetHandler.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(String stmt, ServerConnection c, <span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> rs = ServerParseSet.parse(stmt, offset);</div><div class="line">		<span class="keyword">switch</span> (rs &amp; <span class="number">0xff</span>) &#123;</div><div class="line">		<span class="comment">// ... ÁúÅÁï•‰ª£Á†Å</span></div><div class="line">		<span class="keyword">case</span> XA_FLAG_ON: &#123;</div><div class="line">			<span class="keyword">if</span> (c.isAutocommit()) &#123;</div><div class="line">				c.writeErrMessage(ErrorCode.ERR_WRONG_USED, <span class="string">"set xa cmd on can't used in autocommit connection "</span>);</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			c.getSession2().setXATXEnabled(<span class="keyword">true</span>);</div><div class="line">			c.write(c.writeToBuffer(OkPacket.OK, c.allocate()));</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">case</span> XA_FLAG_OFF: &#123;</div><div class="line">			c.writeErrMessage(ErrorCode.ERR_WRONG_USED,</div><div class="line">					<span class="string">"set xa cmd off not for external use "</span>);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// ... ÁúÅÁï•‰ª£Á†Å</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// NonBlockingSession.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setXATXEnabled</span><span class="params">(<span class="keyword">boolean</span> xaTXEnabled)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (xaTXEnabled) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.xaTXID == <span class="keyword">null</span>) &#123;</div><div class="line">           xaTXID = genXATXID(); <span class="comment">// üòàüòàüòàËé∑Âæó XA ‰∫ãÂä°ÁºñÂè∑</span></div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">this</span>.xaTXID = <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">genXATXID</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> MycatServer.getInstance().getXATXIDGLOBAL();</div><div class="line">&#125;</div><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getXATXIDGLOBAL</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">"'"</span> + getUUID() + <span class="string">"'"</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUUID</span><span class="params">()</span> </span>&#123; <span class="comment">// üòàüòàüòà</span></div><div class="line">   String s = UUID.randomUUID().toString();</div><div class="line">   <span class="keyword">return</span> s.substring(<span class="number">0</span>, <span class="number">8</span>) + s.substring(<span class="number">9</span>, <span class="number">13</span>) + s.substring(<span class="number">14</span>, <span class="number">18</span>) + s.substring(<span class="number">19</span>, <span class="number">23</span>) + s.substring(<span class="number">24</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-3-MyCAT-Êé•Êî∂-SQL"><a href="#3-3-MyCAT-Êé•Êî∂-SQL" class="headerlink" title="3.3 MyCAT Êé•Êî∂ SQL"></a>3.3 MyCAT Êé•Êî∂ SQL</h2><p>Ê≠§Â§Ñ SQL ÊåáÁöÑÊòØ <code>insert</code>„ÄÅ<code>update</code>„ÄÅ<code>delete</code> Êìç‰Ωú„ÄÇ</p>
<p>ÂΩìÂêëÊüê‰∏™Êï∞ÊçÆËäÇÁÇπ<strong>Á¨¨‰∏ÄÊ¨°</strong>ÂèëËµ∑ SQL Êó∂Ôºå‰ºöÂú® SQL ÂâçÈù¢ÈôÑÂä† <code>XA START &#39;xaTranId&#39;</code>ÔºåÂπ∂ËÆæÁΩÆËØ•Êï∞ÊçÆËäÇÁÇπ<strong>ËøûÊé•</strong>‰∫ãÂä°Áä∂ÊÄÅ‰∏∫ <code>TxState.TX_STARTED_STATE</code>Ôºà<em>ÂàÜÂ∏ÉÂºè‰∫ãÂä°Áä∂ÊÄÅÔºå‰∏ãÊñá‰ºö‰∏ìÈó®Êï¥ÁêÜ</em>Ôºâ„ÄÇÊ†∏ÂøÉ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLConnection.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">synAndDoExecute</span><span class="params">(String xaTxID, RouteResultsetNode rrn,</span></span></div><div class="line">                                 <span class="keyword">int</span> clientCharSetIndex, <span class="keyword">int</span> clientTxIsoLation,</div><div class="line">                                 <span class="keyword">boolean</span> clientAutoCommit) &#123;</div><div class="line">   String xaCmd = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">boolean</span> conAutoComit = <span class="keyword">this</span>.autocommit;</div><div class="line">   String conSchema = <span class="keyword">this</span>.schema;</div><div class="line">   <span class="comment">// never executed modify sql,so auto commit</span></div><div class="line">   <span class="keyword">boolean</span> expectAutocommit = !modifiedSQLExecuted || isFromSlaveDB() || clientAutoCommit;</div><div class="line">   <span class="keyword">if</span> (expectAutocommit == <span class="keyword">false</span> &amp;&amp; xaTxID != <span class="keyword">null</span> &amp;&amp; xaStatus == TxState.TX_INITIALIZE_STATE) &#123; <span class="comment">// üòàüòàüòà</span></div><div class="line">       xaCmd = <span class="string">"XA START "</span> + xaTxID + <span class="string">';'</span>;</div><div class="line">       <span class="keyword">this</span>.xaStatus = TxState.TX_STARTED_STATE;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// .... ÁúÅÁï•‰ª£Á†Å</span></div><div class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="comment">// .... ÁúÅÁï•‰ª£Á†Å</span></div><div class="line">   <span class="keyword">if</span> (xaCmd != <span class="keyword">null</span>) &#123;</div><div class="line">       sb.append(xaCmd);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// and our query sql to multi command at last</span></div><div class="line">   sb.append(rrn.getStatement() + <span class="string">";"</span>);</div><div class="line">   <span class="comment">// syn and execute others</span></div><div class="line">   <span class="keyword">this</span>.sendQueryCmd(sb.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>‰∏æ‰∏™ ÂèòÈáè<code>sb</code> ÁöÑ‰æãÂ≠êÔºö</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SET</span> <span class="keyword">names</span> utf8;<span class="keyword">SET</span> autocommit=<span class="number">0</span>;XA <span class="keyword">START</span> <span class="string">'1f2da7353e8846e5833b8d8dd041cfb1'</span>,<span class="string">'db2'</span>;<span class="keyword">insert</span> <span class="keyword">into</span> t_user(<span class="keyword">id</span>, username, <span class="keyword">password</span>) <span class="keyword">VALUES</span> (<span class="number">3400</span>, <span class="string">'b7c5ec1f-11cc-4599-851c-06ad617fec42'</span>, <span class="string">'d2694679-f6a2-4623-a339-48d4a868be90'</span>);</div></pre></td></tr></table></figure>
<h2 id="3-4-MySQL-Êé•Êî∂-COMMIT"><a href="#3-4-MySQL-Êé•Êî∂-COMMIT" class="headerlink" title="3.4 MySQL Êé•Êî∂ COMMIT"></a>3.4 MySQL Êé•Êî∂ COMMIT</h2><h3 id="3-4-1-ÂçïËäÇÁÇπ‰∫ãÂä°-or-Â§öËäÇÁÇπ‰∫ãÂä°"><a href="#3-4-1-ÂçïËäÇÁÇπ‰∫ãÂä°-or-Â§öËäÇÁÇπ‰∫ãÂä°" class="headerlink" title="3.4.1 ÂçïËäÇÁÇπ‰∫ãÂä° or Â§öËäÇÁÇπ‰∫ãÂä°"></a>3.4.1 ÂçïËäÇÁÇπ‰∫ãÂä° or Â§öËäÇÁÇπ‰∫ãÂä°</h3><p><code>COMMIT</code> ÊâßË°åÊó∂ÔºåMyCAT ‰ºöÂà§Êñ≠ XA ‰∫ãÂä°ÈáåÔºåÊ∂âÂèäÂà∞ÁöÑÊï∞ÊçÆÂ∫ìËäÇÁÇπÊï∞Èáè„ÄÇ</p>
<ul>
<li>Â¶ÇÊûúËäÇÁÇπÊï∞Èáè‰∏∫ 1ÔºåÂçïËäÇÁÇπ‰∫ãÂä°Ôºå‰ΩøÁî® <code>CommitNodeHandler</code> Â§ÑÁêÜ„ÄÇ</li>
<li>Â¶ÇÊûúËäÇÁÇπÊï∞Èáè &gt; 1ÔºåÂ§öËäÇÁÇπ‰∫ãÂä°Ôºå‰ΩøÁî® <code>MultiNodeCoordinator</code> Â§ÑÁêÜ„ÄÇ</li>
</ul>
<p><code>CommitNodeHandler</code> Áõ∏ÊØî <code>MultiNodeCoordinator</code> Êù•ËØ¥ÔºåÂè™Êúâ‰∏Ä‰∏™Êï∞ÊçÆËäÇÁÇπÔºå‰∏çÈúÄË¶ÅËøõË°åÂ§öËäÇÁÇπÂçèË∞ÉÔºåÈÄªËæë‰ºöÁõ∏ÂØπÁÆÄÂçïÔºåÊúâÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•Âè¶Â§ñÁúã„ÄÇÊàë‰ª¨‰∏ªË¶ÅÂàÜÊûê <code>MultiNodeCoordinator</code>„ÄÇ</p>
<h3 id="3-4-2-ÂçèË∞ÉÊó•Âøó"><a href="#3-4-2-ÂçèË∞ÉÊó•Âøó" class="headerlink" title="3.4.2 ÂçèË∞ÉÊó•Âøó"></a>3.4.2 ÂçèË∞ÉÊó•Âøó</h3><p><strong>ÂçèË∞ÉÊó•Âøó</strong>ÔºåËÆ∞ÂΩïÂçèË∞ÉËøáÁ®ã‰∏≠ÂêÑÊï∞ÊçÆËäÇÁÇπ XA ‰∫ãÂä°Áä∂ÊÄÅÔºåÂ§ÑÁêÜ<strong>MyCATÂºÇÂ∏∏Â•îÊ∫É</strong>ÊàñËÄÖ<strong>Êï∞ÊçÆËäÇÁÇπÈÉ®ÂàÜXA COMMITÔºåÂè¶Â§ñÈÉ®ÂàÜ XA PREPARE</strong>‰∏ãÁöÑÁä∂ÊÄÅÊÅ¢Â§ç„ÄÇ</p>
<p><strong>XA ‰∫ãÂä°ÂÖ±ÊúâÁßç</strong>Ôºö</p>
<ol>
<li>TX_INITIALIZE_STATE Ôºö‰∫ãÂä°ÂàùÂßãÂåñ</li>
<li>TX_STARTED_STATE Ôºö‰∫ãÂä°ÂºÄÂßãÂÆåÊàê</li>
<li>TX_PREPARED_STATE Ôºö‰∫ãÂä°ÂáÜÂ§áÂÆåÊàê</li>
<li>TX_COMMITED_STATE Ôºö‰∫ãÂä°Êèê‰∫§ÂÆåÊàê</li>
<li>TX_ROLLBACKED_STATE Ôºö‰∫ãÂä°ÂõûÊªöÂÆåÊàê</li>
</ol>
<p><strong>Áä∂ÊÄÅÂèòÊõ¥ÊµÅ</strong> ÔºöTX_INITIALIZE_STATE =&gt; TX_STARTED_STATE =&gt; TX_PREPARED_STATE =&gt; TX_COMMITED_STATE / TX_ROLLBACKED_STATE „ÄÇ</p>
<p><strong>ÂçèË∞ÉÊó•ÂøóÂåÖÂê´‰∏§‰∏™ÈÉ®ÂàÜ</strong>Ôºö</p>
<ol>
<li>CoordinatorLogEntry ÔºöÂçèË∞ÉËÄÖÊó•Âøó</li>
<li>ParticipantLogEntry ÔºöÂèÇ‰∏éËÄÖÊó•Âøó„ÄÇ<strong>Ê≠§Â§ÑÔºåÊï∞ÊçÆËäÇÁÇπÊâÆÊºîÂèÇ‰∏éËÄÖÁöÑËßíËâ≤„ÄÇ‰∏ãÊñá‰∏≠ÔºåÂèØËÉΩ‰ºöÂá∫Áé∞ÂèÇ‰∏éËÄÖ‰∏éÊï∞ÊçÆËäÇÁÇπÊ∑∑Áî®ÁöÑÊÉÖÂÜµÔºåÊúõËßÅË∞Ö„ÄÇ</strong></li>
</ol>
<p><em>‰∏ÄÊ¨° XA ‰∫ãÂä°ÔºåÂØπÂ∫î‰∏ÄÊù° <code>CoordinatorLogEntry</code>„ÄÇ‰∏ÄÊù°<code>CoordinatorLogEntry</code> ÂåÖÂê´ NÊù°<code>ParticipantLogEntry</code></em>„ÄÇ Ê†∏ÂøÉ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// CoordinatorLogEntry ÔºöÂçèË∞ÉËÄÖÊó•Âøó</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoordinatorLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA ‰∫ãÂä°ÁºñÂè∑</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String id;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÂèÇ‰∏éËÄÖÊó•ÂøóÊï∞ÁªÑ</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ParticipantLogEntry[] participants;</div><div class="line">&#125;</div><div class="line"><span class="comment">// ParticipantLogEntry ÔºöÂèÇ‰∏éËÄÖÊó•Âøó</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParticipantLogEntry</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA ‰∫ãÂä°ÁºñÂè∑</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String coordinatorId;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Êï∞ÊçÆÂ∫ì uri</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String uri;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ËøáÊúüÊèèËø∞</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">long</span> expires;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * XA ‰∫ãÂä°Áä∂ÊÄÅ</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> txState;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÂèÇ‰∏éËÄÖÂêçÂ≠ó</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> String resourceName;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>MyCAT ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó‰ª• JSONÊ†ºÂºè Âà∞Êñá‰ª∂</strong>„ÄÇ<strong>ÊØèË°å</strong>ÂåÖÂê´‰∏ÄÊù°<code>CoordinatorLogEntry</code>„ÄÇ‰∏æ‰∏™‰æãÂ≠êÔºö</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'e827b3fe666c4d968961350d19adda31'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db3"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"'f00b61fa17cb4ec5b8264a6d82f847d0'"</span>,<span class="attr">"participants"</span>:[&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db2"</span>&#125;,&#123;<span class="attr">"uri"</span>:<span class="string">"127.0.0.1"</span>,<span class="attr">"state"</span>:<span class="string">"3"</span>,<span class="attr">"expires"</span>:<span class="number">0</span>,<span class="attr">"resourceName"</span>:<span class="string">"db1"</span>&#125;]&#125;</div></pre></td></tr></table></figure>
<p>ÂÆûÁé∞Á±ª‰∏∫Ôºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// XA ÂçèË∞ÉËÄÖÊó•Âøó Â≠òÂÇ®Êé•Âè£Ôºöhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/Repository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA ÂçèË∞ÉËÄÖÊó•Âøó Êñá‰ª∂Â≠òÂÇ®Ôºöhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/FileSystemRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileSystemRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div><div class="line"><span class="comment">// XA ÂçèË∞ÉËÄÖÊó•Âøó Êñá‰ª∂Â≠òÂÇ®Ôºöhttps://github.com/YunaiV/Mycat-Server/blob/1.6/src/main/java/io/mycat/backend/mysql/xa/recovery/impl/InMemoryRepository.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InMemoryRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span> </span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>ÁõÆÂâçÊó•ÂøóÊñá‰ª∂ÂÜôÂÖ•ÁöÑÊñπÂºèÊÄßËÉΩËæÉÂ∑ÆÔºåËøôÈáåÊàë‰ª¨‰∏çÂÅöÂàÜÊûêÔºåÂú®„Äê4. MyCAT ÂÆûÁé∞Áº∫Èô∑„ÄëÈáå‰∏ÄËµ∑ËÆ≤„ÄÇ</p>
<h3 id="3-4-3-MultiNodeCoordinator"><a href="#3-4-3-MultiNodeCoordinator" class="headerlink" title="3.4.3 MultiNodeCoordinator"></a>3.4.3 MultiNodeCoordinator</h3><p>Êï≤Êï≤Êï≤ÔºåËøôÈáåÊòØÊú¨ÊñáÁöÑÈáçÁÇπ‰πã‰∏ÄÂô¢„ÄÇüòà</p>
<p><strong>Á¨¨‰∏ÄÈò∂ÊÆµÔºöÂèëËµ∑ PREPARE„ÄÇ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeBatchNodeCmd</span><span class="params">(SQLCtrlCommand cmdHandler)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.cmdHandler = cmdHandler;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> initCount = session.getTargetCount();</div><div class="line">   runningCount.set(initCount);</div><div class="line">   nodeCount = initCount;</div><div class="line">   failed.set(<span class="keyword">false</span>);</div><div class="line">   faileCount.set(<span class="number">0</span>);</div><div class="line">   <span class="comment">//recovery nodes log</span></div><div class="line">   ParticipantLogEntry[] participantLogEntry = <span class="keyword">new</span> ParticipantLogEntry[initCount];</div><div class="line">   <span class="comment">// ÊâßË°å</span></div><div class="line">   <span class="keyword">int</span> started = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (RouteResultsetNode rrn : session.getTargetKeys()) &#123;</div><div class="line">       <span class="keyword">if</span> (rrn == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">final</span> BackendConnection conn = session.getTarget(rrn);</div><div class="line">       <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</div><div class="line">           conn.setResponseHandler(<span class="keyword">this</span>);</div><div class="line">           <span class="comment">//process the XA_END XA_PREPARE Command</span></div><div class="line">           MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">           String xaTxId = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">               xaTxId = session.getXaTXID() + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (mysqlCon.getXaStatus() == TxState.TX_STARTED_STATE) &#123; <span class="comment">// XA ‰∫ãÂä°</span></div><div class="line">               <span class="comment">//recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               String[] cmds = <span class="keyword">new</span> String[]&#123;<span class="string">"XA END "</span> + xaTxId, <span class="comment">// XA END ÂëΩ‰ª§</span></div><div class="line">                       <span class="string">"XA PREPARE "</span> + xaTxId&#125;; <span class="comment">// XA PREPARE ÂëΩ‰ª§</span></div><div class="line">               mysqlCon.execBatchCmd(cmds);</div><div class="line">           &#125; <span class="keyword">else</span> &#123; <span class="comment">// Èùû XA ‰∫ãÂä°</span></div><div class="line">               <span class="comment">// recovery Log</span></div><div class="line">               participantLogEntry[started] = <span class="keyword">new</span> ParticipantLogEntry(xaTxId, conn.getHost(), <span class="number">0</span>, conn.getSchema(), ((MySQLConnection) conn).getXaStatus());</div><div class="line">               cmdHandler.sendCommand(session, conn);</div><div class="line">           &#125;</div><div class="line">           ++started;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// xa recovery log</span></div><div class="line">   <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = <span class="keyword">new</span> CoordinatorLogEntry(session.getXaTXID(), <span class="keyword">false</span>, participantLogEntry);</div><div class="line">       inMemoryRepository.put(session.getXaTXID(), coordinatorLogEntry);</div><div class="line">       fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (started &lt; nodeCount) &#123; <span class="comment">// TODO ÁñëÈóÆÔºöÂ¶Ç‰ΩïËß¶Âèë</span></div><div class="line">       runningCount.set(started);</div><div class="line">       LOGGER.warn(<span class="string">"some connection failed to execute "</span> + (nodeCount - started));</div><div class="line">       <span class="comment">/**</span></div><div class="line">        * assumption: only caused by front-end connection close. &lt;br/&gt;</div><div class="line">        * Otherwise, packet must be returned to front-end</div><div class="line">        */</div><div class="line">       failed.set(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ÂêëÂêÑÊï∞ÊçÆËäÇÁÇπÂèëÈÄÅ <code>XA END</code> + <code>XA PREPARE</code> Êåá‰ª§„ÄÇ‰∏æ‰∏™ ÂèòÈáè<code>cmds</code> ‰æãÂ≠êÔºö</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">XA <span class="keyword">END</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;XA <span class="keyword">PREPARE</span> <span class="string">'4cbb18214d0b47adbdb0658598666677'</span>,<span class="string">'db3'</span>;</div></pre></td></tr></table></figure>
<ul>
<li>ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó„ÄÇÊØèÊù°ÂèÇ‰∏éËÄÖÊó•ÂøóÁä∂ÊÄÅ‰∏∫ <code>TxState.TX_STARTED_STATE</code>„ÄÇ</li>
</ul>
<hr>
<p><strong>Á¨¨‰∫åÈò∂ÊÆµÔºöÂèëËµ∑ COMMIT„ÄÇ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">okResponse</span><span class="params">(<span class="keyword">byte</span>[] ok, BackendConnection conn)</span> </span>&#123;</div><div class="line">   <span class="comment">// process the XA Transatcion 2pc commit</span></div><div class="line">   <span class="keyword">if</span> (conn <span class="keyword">instanceof</span> MySQLConnection) &#123;</div><div class="line">       MySQLConnection mysqlCon = (MySQLConnection) conn;</div><div class="line">       <span class="keyword">switch</span> (mysqlCon.getXaStatus()) &#123;</div><div class="line">           <span class="keyword">case</span> TxState.TX_STARTED_STATE:</div><div class="line">               <span class="comment">//if there have many SQL execute wait the okResponse,will come to here one by one</span></div><div class="line">               <span class="comment">//should be wait all nodes ready ,then send xa commit to all nodes.</span></div><div class="line">               <span class="keyword">if</span> (mysqlCon.batchCmdFinished()) &#123;</div><div class="line">                   String xaTxId = session.getXaTXID();</div><div class="line">                   String cmd = <span class="string">"XA COMMIT "</span> + xaTxId + <span class="string">",'"</span> + mysqlCon.getSchema() + <span class="string">"'"</span>;</div><div class="line">                   <span class="keyword">if</span> (LOGGER.isDebugEnabled()) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"Start execute the cmd :"</span> + cmd + <span class="string">",current host:"</span> + mysqlCon.getHost() + <span class="string">":"</span> + mysqlCon.getPort());</div><div class="line">                   &#125;</div><div class="line">                   <span class="comment">// recovery log</span></div><div class="line">                   CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                       LOGGER.debug(<span class="string">"[In Memory CoordinatorLogEntry]"</span> + coordinatorLogEntry.participants[i]);</div><div class="line">                       <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                           coordinatorLogEntry.participants[i].txState = TxState.TX_PREPARED_STATE;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">                   fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">                   <span class="comment">// send commit</span></div><div class="line">                   mysqlCon.setXaStatus(TxState.TX_PREPARED_STATE);</div><div class="line">                   mysqlCon.execCmd(cmd);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           <span class="keyword">case</span> TxState.TX_PREPARED_STATE: &#123;</div><div class="line">               <span class="comment">// recovery log</span></div><div class="line">               String xaTxId = session.getXaTXID();</div><div class="line">               CoordinatorLogEntry coordinatorLogEntry = inMemoryRepository.get(xaTxId);</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntry.participants.length; i++) &#123;</div><div class="line">                   <span class="keyword">if</span> (coordinatorLogEntry.participants[i].resourceName.equals(conn.getSchema())) &#123;</div><div class="line">                       coordinatorLogEntry.participants[i].txState = TxState.TX_COMMITED_STATE;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               inMemoryRepository.put(xaTxId, coordinatorLogEntry);</div><div class="line">               fileRepository.writeCheckpoint(inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">               <span class="comment">// XA reset status now</span></div><div class="line">               mysqlCon.setXaStatus(TxState.TX_INITIALIZE_STATE);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ÈáäÊîæËøûÊé•</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.cmdHandler.relaseConOnOK()) &#123;</div><div class="line">       session.releaseConnection(conn);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       session.releaseConnectionIfSafe(conn, LOGGER.isDebugEnabled(), <span class="keyword">false</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ÊòØÂê¶ÊâÄÊúâËäÇÁÇπÈÉΩÂÆåÊàêcommitÔºåÂ¶ÇÊûúÊòØÔºåÂàôËøîÂõûClient ÊàêÂäü</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.finished()) &#123;</div><div class="line">       cmdHandler.okResponse(session, ok);</div><div class="line">       <span class="keyword">if</span> (cmdHandler.isAutoClearSessionCons()) &#123;</div><div class="line">           session.clearResources(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 1.  ‰∫ãÂä°Êèê‰∫§Âêé,xa ‰∫ãÂä°ÁªìÊùü   */</span></div><div class="line">       <span class="keyword">if</span> (session.getXaTXID() != <span class="keyword">null</span>) &#123;</div><div class="line">           session.setXATXEnabled(<span class="keyword">false</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 2. preAcStates ‰∏∫true,‰∫ãÂä°ÁªìÊùüÂêé,ÈúÄË¶ÅËÆæÁΩÆ‰∏∫true„ÄÇpreAcStates ‰∏∫ac‰∏ä‰∏Ä‰∏™Áä∂ÊÄÅ    */</span></div><div class="line">       <span class="keyword">if</span> (session.getSource().isPreAcStates()) &#123;</div><div class="line">           session.getSource().setAutocommit(<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>mysqlCon.batchCmdFinished()</code> ÊØè‰∏™Êï∞ÊçÆËäÇÁÇπÔºåÁ¨¨‰∏ÄÊ¨°ËøîÂõûÁöÑÊòØ <code>XA END</code> ÊàêÂäüÔºåÁ¨¨‰∫åÊ¨°ËøîÂõûÁöÑÊòØ <code>XA PREPARE</code>„ÄÇÂú® <code>XA PREPARE</code> ÊàêÂäüÂêéÔºåËÆ∞ÂΩïËØ•Êï∞ÊçÆËäÇÁÇπÁöÑ<strong>ÂèÇ‰∏éËÄÖÊó•Âøó</strong>Áä∂ÊÄÅ‰∏∫ <code>TxState.TX_PREPARED_STATE</code>„ÄÇ‰πãÂêéÔºåÂêëËØ•Êï∞ÊçÆËäÇÁÇπÂèëËµ∑ <code>XA COMMIT</code> ÂëΩ‰ª§„ÄÇ</li>
<li><code>XA COMMIT</code> ËøîÂõûÊàêÂäüÂêéÔºåËÆ∞ÂΩïËØ•Êï∞ÊçÆËäÇÁÇπÁöÑ<strong>‰∫ãÂä°ÂèÇ‰∏éËÄÖÊó•Âøó</strong>Áä∂ÊÄÅ‰∏∫ <code>TxState.TX_COMMITED_STATE</code>„ÄÇ</li>
<li>ÂΩìÊâÄÊúâÊï∞ÊçÆËäÇÁÇπÔºàÂèÇ‰∏éËÄÖÔºâÈÉΩÊâßË°åÂÆåÊàê <code>XA COMMIT</code> ËøîÂõûÔºåÂç≥ <code>this.finished() == true</code>ÔºåËøîÂõû MySQL Client XA ‰∫ãÂä°Êèê‰∫§ÊàêÂäü„ÄÇ</li>
</ul>
<p>[x] <code>XA PREPARE</code> Âíå <code>XA COMMIT</code>ÔºåÊï∞ÊçÆËäÇÁÇπÂèØËÉΩËøîÂõûÂ§±Ë¥•ÔºåÁõÆÂâçÊöÇÊó∂Ê≤°Ê®°ÊãüÂá∫Êù•ÔºåÂØπÂ∫îÊñπÊ≥ï‰∏∫ <code>#errorResponse(....)</code>„ÄÇ </p>
<h2 id="3-5-MyCAT-ÂêØÂä®ÂõûÊªö-XA‰∫ãÂä°"><a href="#3-5-MyCAT-ÂêØÂä®ÂõûÊªö-XA‰∫ãÂä°" class="headerlink" title="3.5 MyCAT ÂêØÂä®ÂõûÊªö XA‰∫ãÂä°"></a>3.5 MyCAT ÂêØÂä®ÂõûÊªö XA‰∫ãÂä°</h2><p>MyCAT ÂêØÂä®Êó∂Ôºå‰ºö<strong>ÂõûÊªöÂ§Ñ‰∫éTxState.TX_PREPARED_STATE</strong>ÁöÑ <code>ParticipantLogEntry</code> ÂØπÂ∫îÁöÑÊï∞ÊçÆËäÇÁÇπÁöÑ XA ‰∫ãÂä°„ÄÇ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MycatServer.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performXARecoveryLog</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// fetch the recovery log</span></div><div class="line">   CoordinatorLogEntry[] coordinatorLogEntries = getCoordinatorLogEntries();</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">       CoordinatorLogEntry coordinatorLogEntry = coordinatorLogEntries[i];</div><div class="line">       <span class="keyword">boolean</span> needRollback = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">           ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">           <span class="keyword">if</span> (participantLogEntry.txState == TxState.TX_PREPARED_STATE) &#123;</div><div class="line">               needRollback = <span class="keyword">true</span>;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (needRollback) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; coordinatorLogEntry.participants.length; j++) &#123;</div><div class="line">               ParticipantLogEntry participantLogEntry = coordinatorLogEntry.participants[j];</div><div class="line">               <span class="comment">//XA rollback</span></div><div class="line">               String xacmd = <span class="string">"XA ROLLBACK "</span> + coordinatorLogEntry.id + <span class="string">';'</span>;</div><div class="line">               OneRawSQLQueryResultHandler resultHandler = <span class="keyword">new</span> OneRawSQLQueryResultHandler(<span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> XARollbackCallback());</div><div class="line">               outloop:</div><div class="line">               <span class="keyword">for</span> (SchemaConfig schema : MycatServer.getInstance().getConfig().getSchemas().values()) &#123;</div><div class="line">                   <span class="keyword">for</span> (TableConfig table : schema.getTables().values()) &#123;</div><div class="line">                       <span class="keyword">for</span> (String dataNode : table.getDataNodes()) &#123;</div><div class="line">                           PhysicalDBNode dn = MycatServer.getInstance().getConfig().getDataNodes().get(dataNode);</div><div class="line">                           <span class="keyword">if</span> (dn.getDbPool().getSource().getConfig().getIp().equals(participantLogEntry.uri)</div><div class="line">                                   &amp;&amp; dn.getDatabase().equals(participantLogEntry.resourceName)) &#123;</div><div class="line">                               <span class="comment">//XA STATE ROLLBACK</span></div><div class="line">                               participantLogEntry.txState = TxState.TX_ROLLBACKED_STATE;</div><div class="line">                               SQLJob sqlJob = <span class="keyword">new</span> SQLJob(xacmd, dn.getDatabase(), resultHandler, dn.getDbPool().getSource());</div><div class="line">                               sqlJob.run();</div><div class="line">                               <span class="keyword">break</span> outloop;</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// init into in memory cached</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; coordinatorLogEntries.length; i++) &#123;</div><div class="line">  MultiNodeCoordinator.inMemoryRepository.put(coordinatorLogEntries[i].id, coordinatorLogEntries[i]);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// discard the recovery log</span></div><div class="line">    MultiNodeCoordinator.fileRepository.writeCheckpoint(MultiNodeCoordinator.inMemoryRepository.getAllCoordinatorLogEntries());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="4-MyCAT-ÂÆûÁé∞Áº∫Èô∑"><a href="#4-MyCAT-ÂÆûÁé∞Áº∫Èô∑" class="headerlink" title="4. MyCAT ÂÆûÁé∞Áº∫Èô∑"></a>4. MyCAT ÂÆûÁé∞Áº∫Èô∑</h1><p>MyCAT 1.6.5 ÁâàÊú¨ÂÆûÁé∞Âº±XA‰∫ãÂä°ÔºåÁõ∏ÂØπÊù•ËØ¥ÔºåÁ¨îËÄÖËÆ§‰∏∫Ë∑ùÁ¶ªÂÆûÈôÖÁîü‰∫ß‰ΩøÁî®Â≠òÂú®‰∏Ä‰∫õÂ∑ÆË∑ù„ÄÇ‰∏ãÈù¢ÁΩóÂàóÂèØËÉΩÂ≠òÂú®ÁöÑÁº∫Èô∑ÔºåÂ¶ÇÊúâÈîôËØØÔºåÈ∫ªÁÉ¶ÊåáÂá∫„ÄÇüôÇÂ∏åÊúõ MyCAT Âú®ÂàÜÂ∏ÉÂºè‰∫ãÂä°ÁöÑÂÆûÁé∞‰∏äÔºåËÉΩÂ§üË∂äÊù•Ë∂äÁªôÂäõ„ÄÇ</p>
<h2 id="4-1-ÂçèË∞ÉÊó•ÂøóÂÜôÂÖ•ÊÄßËÉΩ"><a href="#4-1-ÂçèË∞ÉÊó•ÂøóÂÜôÂÖ•ÊÄßËÉΩ" class="headerlink" title="4.1 ÂçèË∞ÉÊó•ÂøóÂÜôÂÖ•ÊÄßËÉΩ"></a>4.1 ÂçèË∞ÉÊó•ÂøóÂÜôÂÖ•ÊÄßËÉΩ</h2><p>1„ÄÅ<code>CoordinatorLogEntry</code>„ÄÅ<code>ParticipantLogEntry</code> Âú®ÊØèÊ¨°ÂÜôÂÖ•Êñá‰ª∂Êó∂ÔºåÊòØÂ∞ÜÂÜÖÂ≠ò‰∏≠ÊâÄÊúâÁöÑÊó•Âøó<strong>ÂÖ®ÈÉ®ÈáçÊñ∞</strong>ÂÜôÂÖ•ÔºåÂØºËá¥ÂÜôÂÖ•ÊÄßËÉΩÈöèÁùÄ XA ‰∫ãÂä°Ê¨°Êï∞ÁöÑÂ¢ûÂä†ÔºåÊÄßËÉΩ‰ºöË∂äÊù•Ë∂äÁ≥üÁ≥ïÔºåÂØºËá¥ XA ‰∫ãÂä°Êï¥‰ΩìÊÄßËÉΩ‰ºöÈùûÂ∏∏Â∑Æ„ÄÇÂè¶Â§ñÔºåËØ•ÊñπÊ≥ïÊòØ<strong>ÂêåÊ≠•</strong>ÁöÑÔºå‰πüÂä†Â§ß‰∫ÜÂÜôÂÖ•ÁöÑÂª∂Ëøü„ÄÇ</p>
<p>Âª∫ËÆÆÔºöÂÖàËé∑ÂæóÂèØÂÜôÂÖ•Êñá‰ª∂ÁöÑ OFFSETÔºåÂÜôÂÖ•ÂçèË∞ÉÊó•ÂøóÂà∞Êñá‰ª∂ÔºåÂÜÖÂ≠òÁª¥Êä§Â•Ω XA‰∫ãÂä°ÁºñÂè∑ ‰∏é OFFSET ÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÔºå‰ªéËÄåÂÆûÁé∞<strong>È°∫Â∫èÂÜôÂÖ•</strong> + <strong>Âπ∂Ë°åÂÜôÂÖ•</strong>„ÄÇ</p>
<p>2„ÄÅÂÜÖÂ≠òÈáåÁª¥Êä§‰∫ÜÊâÄÊúâÁöÑÂçèË∞ÉÊó•ÂøóÔºåÂç†Áî®ÂÜÖÂ≠ò‰ºöË∂äÊù•Ë∂äÂ§ßÔºåÂπ∂‰∏îÊó†ÈáäÊîæÊú∫Âà∂„ÄÇÂç≥‰ΩøÈáçÂêØÔºåÂçèË∞ÉÊó•Âøó‰πü‰ºöÈáçÊñ∞Âä†ËΩΩÂà∞ÂÜÖÂ≠ò„ÄÇ</p>
<p>Âª∫ËÆÆÔºöÂ∑≤ÂÆåÂÖ®ÂõûÊªöÊàñËÄÖÊèê‰∫§ÁöÑÂçèË∞ÉÊó•Âøó‰∏çÊîæÂÖ•ÂÜÖÂ≠ò„ÄÇÂè¶Â§ñÊúâÊñá‰ª∂Â≠òÂÇ®Â•Ω XA‰∫ãÂä°ÁºñÂè∑ ‰∏é OFFSET ÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ</p>
<p>3„ÄÅÂçèË∞ÉÊó•ÂøóÂè™ÂÜôÂÖ•Âçï‰∏™Êñá‰ª∂„ÄÇ</p>
<p>Âª∫ËÆÆÔºöÂàÜÊãÜÂçèË∞ÉÊó•ÂøóÊñá‰ª∂„ÄÇ</p>
<p>PSÔºöÊúâÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•Áúã‰∏ã <code>RocketMQ</code> ÂØπ <code>CommitLog</code> ÁöÑÂ≠òÂÇ®ÔºåÊÄßËÉΩ‰∏äÂæàËµûÔºÅ</p>
<h2 id="4-2-Êï∞ÊçÆËäÇÁÇπÊú™ÂÖ®ÈÉ®-PREPARE-Â∞±ËøõË°å-COMMIT"><a href="#4-2-Êï∞ÊçÆËäÇÁÇπÊú™ÂÖ®ÈÉ®-PREPARE-Â∞±ËøõË°å-COMMIT" class="headerlink" title="4.2 Êï∞ÊçÆËäÇÁÇπÊú™ÂÖ®ÈÉ® PREPARE Â∞±ËøõË°å COMMIT"></a>4.2 Êï∞ÊçÆËäÇÁÇπÊú™ÂÖ®ÈÉ® PREPARE Â∞±ËøõË°å COMMIT</h2><p>XA ‰∫ãÂä°ÂÆö‰πâÔºåÈúÄË¶ÅÁ≠âÂæÖÊâÄÊúâÂèÇ‰∏éËÄÖ<strong>ÂÖ®ÈÉ®</strong> <code>XA PREPARE</code> ÊàêÂäüÂÆåÊàêÂêéÂèëËµ∑ <code>XA COMMIT</code>„ÄÇÁõÆÂâç MyCAT ÊòØÊüê‰∏™Êï∞ÊçÆËäÇÁÇπ <code>XA PREPARE</code> ÂÆåÊàêÂêé<strong>Á´ãÂç≥</strong>ËøõË°å <code>XA COMMIT</code>„ÄÇÊØîÂ¶ÇËØ¥ÔºöÁ¨¨‰∏Ä‰∏™Êï∞ÊçÆËäÇÁÇπÊèê‰∫§‰∫Ü <code>XA END;XA PREPARE</code> Êó∂ÔºåÁ¨¨‰∫å‰∏™Êï∞ÊçÆËäÇÂú®ËøõË°å <code>XA END;XA PREAPRE;</code> ÂâçÊåÇ‰∫ÜÔºåÁ¨¨‰∏Ä‰∏™ËäÇÁÇπ‰æùÁÑ∂‰ºö <code>XA COMMIT</code> ÊàêÂäü„ÄÇ</p>
<p>Âª∫ËÆÆÔºöÊåâÁÖß‰∏•Ê†ºÁöÑ XA ‰∫ãÂä°ÂÆö‰πâ„ÄÇ</p>
<h2 id="4-3-MyCAT-ÂêØÂä®ÂõûÊªö-PREPARE-ÁöÑ-XA‰∫ãÂä°"><a href="#4-3-MyCAT-ÂêØÂä®ÂõûÊªö-PREPARE-ÁöÑ-XA‰∫ãÂä°" class="headerlink" title="4.3 MyCAT ÂêØÂä®ÂõûÊªö PREPARE ÁöÑ XA‰∫ãÂä°"></a>4.3 MyCAT ÂêØÂä®ÂõûÊªö PREPARE ÁöÑ XA‰∫ãÂä°</h2><p>1„ÄÅMyCAT ÂêØÂä®Êó∂ÔºåÂõûÊªöÊâÄÊúâÁöÑ <code>PREPARE</code> ÁöÑ XA ‰∫ãÂä°ÔºåÂèØËÉΩÊüê‰∏™ XA ‰∫ãÂä°ÔºåÈÉ®ÂàÜ <code>COMMIT</code>ÔºåÈÉ®ÂàÜ <code>PREPARE</code>„ÄÇÊ≠§Êó∂Áõ¥Êé•ÂõûÊªöÔºå‰ºöÂØºËá¥Êï∞ÊçÆ‰∏ç‰∏ÄËá¥„ÄÇ</p>
<p>Âª∫ËÆÆÔºöÂΩìÂà§Êñ≠Âà∞Êüê‰∏™ XA ‰∫ãÂä°Â≠òÂú® <code>PREPARE</code> ÁöÑÂèÇ‰∏éËÄÖÔºå<strong>ÂêåÊó∂Âà§Êñ≠ËØ• XA ‰∫ãÂä°ÈáåÂÖ∂‰ªñÂèÇ‰∏éËÄÖÁöÑ‰∫ãÂä°Áä∂ÊÄÅ</strong>‰ª•Âèä<strong>Êï∞ÊçÆËäÇÁÇπÈáå XA ‰∫ãÂä°Áä∂ÊÄÅ</strong>ÔºåÊØîÂ¶ÇÂèÇ‰∏éËÄÖ‰∏∫ <code>MySQL</code>Êó∂ÔºåÂèØ‰ª•‰ΩøÁî® <code>XA RECOVER</code> Êü•ËØ¢Â§Ñ‰∫é <code>PREPARE</code> ÊâÄÊúâÁöÑ XA ‰∫ãÂä°„ÄÇ</p>
<p>2„ÄÅÂõûÊªö <code>PREPARE</code> ÊòØÂºÇÊ≠•ËøõË°åÁöÑÔºåÂú®Êú™ËøõË°åÂÆåÊàêÊó∂Â∑≤ÁªèËÆæÁΩÆÊñá‰ª∂ÈáåÂõûÊªöÊàêÂäü„ÄÇÂ¶ÇÊûúÂºÇÊ≠•ËøáÁ®ã‰∏≠Â§±Ë¥•Ôºå‰ºöÂØºËá¥ XA ‰∫ãÂä°Áä∂ÊÄÅ‰∏ç‰∏ÄËá¥„ÄÇ</p>
<p>Âª∫ËÆÆÔºöÂõûË∞ÉÊàêÂäüÂêéÔºåÊõ¥Êñ∞ËØ• XA ‰∫ãÂä°Áä∂ÊÄÅ„ÄÇ</p>
<h2 id="4-4-ÂçïËäÇÁÇπ‰∫ãÂä°Êú™ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó"><a href="#4-4-ÂçïËäÇÁÇπ‰∫ãÂä°Êú™ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó" class="headerlink" title="4.4 ÂçïËäÇÁÇπ‰∫ãÂä°Êú™ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó"></a>4.4 ÂçïËäÇÁÇπ‰∫ãÂä°Êú™ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó</h2><p>ËØ•ÊÉÖÂÜµËæÉ‰∏∫ÊûÅÁ´Ø„ÄÇÂèëËµ∑ <code>XA PREPARE</code>ÂÆåÂêéÔºåMyCAT ÊåÇ‰∫Ü„ÄÇÈáçÂêØÂêéÔºåËØ• XA ‰∫ãÂä°Âú® MyCAT ÈáåÂ∞±‚ÄúÊ∂àÂ§±‚Äú‰∫ÜÔºåÂèÇ‰∏éËÄÖÁöÑËØ• XA ‰∫ãÂä°‰∏ÄÁõ¥Â§Ñ‰∫é <code>PREPARE</code> Áä∂ÊÄÅ„ÄÇ‰ªéÁêÜËÆ∫‰∏äÊù•ËØ¥ÔºåÈúÄË¶ÅÂõûÊªöËØ• XA ‰∫ãÂä°„ÄÇ</p>
<p>Âª∫ËÆÆÔºöËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó„ÄÇ</p>
<h2 id="4-5-XA-COMMIT-ÈÉ®ÂàÜËäÇÁÇπÊåÇ‰∫ÜÈáçÊñ∞ÊÅ¢Â§çÂêéÔºåÊú™Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ"><a href="#4-5-XA-COMMIT-ÈÉ®ÂàÜËäÇÁÇπÊåÇ‰∫ÜÈáçÊñ∞ÊÅ¢Â§çÂêéÔºåÊú™Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ" class="headerlink" title="4.5 XA COMMIT ÈÉ®ÂàÜËäÇÁÇπÊåÇ‰∫ÜÈáçÊñ∞ÊÅ¢Â§çÂêéÔºåÊú™Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ"></a>4.5 XA COMMIT ÈÉ®ÂàÜËäÇÁÇπÊåÇ‰∫ÜÈáçÊñ∞ÊÅ¢Â§çÂêéÔºåÊú™Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ</h2><p>ÂΩì‰∏ÄÈÉ®ÂàÜËäÇÁÇπ <code>XA COMMIT</code> ÂÆåÊàêÔºåÂè¶Â§ñ‰∏ÄÈÉ®ÂàÜÊ≠§Êó∂ÊåÇ‰∫Ü„ÄÇÂú®ÁÆ°ÁêÜÂëòÈáçÂêØÊåÇÊéâÁöÑËäÇÁÇπÔºåÂÖ∂ÂØπÂ∫îÁöÑ XA ‰∫ãÂä°Êú™Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜÔºåÂØºËá¥Êï∞ÊçÆ‰∏ç‰∏ÄËá¥„ÄÇ</p>
<p>Âª∫ËÆÆÔºöüòàÊú®ÊúâÂª∫ËÆÆ„ÄÇ‰πüÂæàÂ•ΩÂ•áÔºåÂ¶ÇÊûúÊòØËøôÊ†∑ÁöÑÊÉÖÂÜµÔºåÂ¶Ç‰ΩïÂ§ÑÁêÜËæÉ‰∏∫ÂêàÈÄÇ„ÄÇÂ¶ÇÊúâÂ§ßÂ§ßÁü•ÈÅìÔºåÁÉ¶ËØ∑ÂëäÁü•‰∏ã„ÄÇ</p>
<h1 id="5-ÂΩ©Ëõã"><a href="#5-ÂΩ©Ëõã" class="headerlink" title="5. ÂΩ©Ëõã"></a>5. ÂΩ©Ëõã</h1><p>‰æãË°å‚ÄúÂΩ©Ëõã‚ÄùÔºü</p>
<ul>
<li><a href="http://blog.csdn.net/d6619309/article/details/52330334" rel="external nofollow noopener noreferrer" target="_blank">„ÄäMycatÊ∫êÁ†ÅÁØá : MyCat‰∫ãÂä°ÁÆ°ÁêÜÊú∫Âà∂ÂàÜÊûê„Äã</a> Êù•Ëá™ MyCAT Committer ÁöÑÊñáÁ´†</li>
<li><a href="http://mysql.taobao.org/monthly/2015/04/05/" rel="external nofollow noopener noreferrer" target="_blank">„ÄäMySQL ¬∑ ÊçâËô´Âä®ÊÄÅ ¬∑ ËøûÊé•Êñ≠ÂºÄÂØºËá¥XA‰∫ãÂä°‰∏¢Â§±„Äã</a></li>
<li><a href="http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency" rel="external nofollow noopener noreferrer" target="_blank">„ÄäÂàÜÂ∏ÉÂºèÁ≥ªÁªü‰∫ãÂä°‰∏ÄËá¥ÊÄßËß£ÂÜ≥ÊñπÊ°à„Äã</a></li>
<li><a href="http://blog.csdn.net/fly2749/article/details/44998203" rel="external nofollow noopener noreferrer" target="_blank">„ÄäMySQLÊï∞ÊçÆÂ∫ìÂàÜÂ∏ÉÂºè‰∫ãÂä°XA‰ºòÁº∫ÁÇπ‰∏éÊîπËøõÊñπÊ°à„Äã</a></li>
<li><a href="http://www.hollischuang.com/archives/1580" rel="external nofollow noopener noreferrer" target="_blank">„ÄäÊ∑±ÂÖ•ÁêÜËß£ÂàÜÂ∏ÉÂºèÁ≥ªÁªüÁöÑ2PCÂíå3PC„Äã</a></li>
<li><a href="https://github.com/YunaiV/yunaiv.github.io/blob/master/source/_drafts/MyCAT/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.xmind" target="_blank" rel="external">„ÄêÂàÜÂ∏ÉÂºè‰∫ãÂä°.xmind„Äë</a> Á¨îËÄÖÊãô‰Ωú </li>
<li><a href="http://www.yunai.me/RocketMQ/message-transaction/?self">„ÄäRocketMQ Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî ‰∫ãÂä°Ê∂àÊÅØ„Äã</a> Á¨îËÄÖÊãô‰Ωú</li>
</ul>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Ê¶ÇËø∞"><span class="toc-number">1.</span> <span class="toc-text">1. Ê¶ÇËø∞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-XA-Ê¶ÇÂøµ"><span class="toc-number">2.</span> <span class="toc-text">2. XA Ê¶ÇÂøµ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-MyCAT-‰ª£Á†ÅÂÆûÁé∞"><span class="toc-number">3.</span> <span class="toc-text">3. MyCAT ‰ª£Á†ÅÂÆûÁé∞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-JDBC-Demo-‰ª£Á†Å"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 JDBC Demo ‰ª£Á†Å</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-MyCAT-ÂºÄÂêØ-XA-‰∫ãÂä°"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 MyCAT ÂºÄÂêØ XA ‰∫ãÂä°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-MyCAT-Êé•Êî∂-SQL"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 MyCAT Êé•Êî∂ SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-MySQL-Êé•Êî∂-COMMIT"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 MySQL Êé•Êî∂ COMMIT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-ÂçïËäÇÁÇπ‰∫ãÂä°-or-Â§öËäÇÁÇπ‰∫ãÂä°"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 ÂçïËäÇÁÇπ‰∫ãÂä° or Â§öËäÇÁÇπ‰∫ãÂä°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-ÂçèË∞ÉÊó•Âøó"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 ÂçèË∞ÉÊó•Âøó</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-MultiNodeCoordinator"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 MultiNodeCoordinator</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-MyCAT-ÂêØÂä®ÂõûÊªö-XA‰∫ãÂä°"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 MyCAT ÂêØÂä®ÂõûÊªö XA‰∫ãÂä°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-MyCAT-ÂÆûÁé∞Áº∫Èô∑"><span class="toc-number">4.</span> <span class="toc-text">4. MyCAT ÂÆûÁé∞Áº∫Èô∑</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-ÂçèË∞ÉÊó•ÂøóÂÜôÂÖ•ÊÄßËÉΩ"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 ÂçèË∞ÉÊó•ÂøóÂÜôÂÖ•ÊÄßËÉΩ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-Êï∞ÊçÆËäÇÁÇπÊú™ÂÖ®ÈÉ®-PREPARE-Â∞±ËøõË°å-COMMIT"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 Êï∞ÊçÆËäÇÁÇπÊú™ÂÖ®ÈÉ® PREPARE Â∞±ËøõË°å COMMIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-MyCAT-ÂêØÂä®ÂõûÊªö-PREPARE-ÁöÑ-XA‰∫ãÂä°"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 MyCAT ÂêØÂä®ÂõûÊªö PREPARE ÁöÑ XA‰∫ãÂä°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-ÂçïËäÇÁÇπ‰∫ãÂä°Êú™ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 ÂçïËäÇÁÇπ‰∫ãÂä°Êú™ËÆ∞ÂΩïÂçèË∞ÉÊó•Âøó</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-XA-COMMIT-ÈÉ®ÂàÜËäÇÁÇπÊåÇ‰∫ÜÈáçÊñ∞ÊÅ¢Â§çÂêéÔºåÊú™Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 XA COMMIT ÈÉ®ÂàÜËäÇÁÇπÊåÇ‰∫ÜÈáçÊñ∞ÊÅ¢Â§çÂêéÔºåÊú™Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-ÂΩ©Ëõã"><span class="toc-number">5.</span> <span class="toc-text">5. ÂΩ©Ëõã</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/MyCAT/xa-distributed-transaction/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&text=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&is_video=false&description=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°&body=Check out this article: http://www.yunai.me/MyCAT/xa-distributed-transaction/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&title=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/MyCAT/xa-distributed-transaction/&name=MyCATÊ∫êÁ†ÅÂàÜÊûê  ‚Äî‚Äî XAÂàÜÂ∏ÉÂºè‰∫ãÂä°&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 ÁéãÊñáÊñå
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO ÂæÖ‰ºòÂåñÔºöËøáÊª§ Áà¨Ëô´
        url = $('#actions .icon').attr('href').trim(); // ÊñáÁ´†url
//        alert(url);
        title = $('.posttitle').text().trim(); // ÊñáÁ´†Ê†áÈ¢ò
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // ÊèíÂÖ•Ê¨°Êï∞
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // ÊèíÂÖ•Ê¨°Êï∞
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // Ëé∑Âèñuid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip ÊµèËßàÂô®Êó†Ê≥ïËé∑Âèñ
        // time ÊúçÂä°Á´ØÂ∑≤ÁªèËÆ∞ÂΩï
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO ÂæÖ‰ºòÂåñÔºöÊ≠§Â§ÑÊÄßËÉΩËæÉÂ∑ÆÔºåÂèØËÉΩ
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // Âà§Êñ≠ÊòØÂê¶Âú®ÊñáÁ´†È°µ
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // Â¢ûÂä†ÊñáÁ´†ËÆøÈóÆÊ¨°Êï∞
                addCount(Counter);
            }
            // ËÆ∞ÂΩïËÆøÈóÆÊó•Âøó
            addVisitLog();
            // ËÆ°ÁÆóÂ§öÂ∞ë‰∫∫ËÆøÈóÆ
            countVisitLog();
        }, 1000);
    });
</script>
