<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="üôÇüôÇüôÇÂÖ≥Ê≥®ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºö„ÄêËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã„ÄëÊúâÁ¶èÂà©Ôºö    RocketMQ / MyCAT / Sharding-JDBC ÊâÄÊúâÊ∫êÁ†ÅÂàÜÊûêÊñáÁ´†ÂàóË°®   RocketMQ / MyCAT / Sharding-JDBC ‰∏≠ÊñáÊ≥®ÈáäÊ∫êÁ†Å GitHub Âú∞ÂùÄ   ÊÇ®ÂØπ‰∫éÊ∫êÁ†ÅÁöÑÁñëÈóÆÊØèÊù°ÁïôË®ÄÈÉΩÂ∞ÜÂæóÂà∞ËÆ§ÁúüÂõûÂ§ç„ÄÇÁîöËá≥‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËØªÊ∫êÁ†Å‰πüÂèØ‰ª•ËØ∑ÊïôÂô¢„ÄÇ   Êñ∞ÁöÑÊ∫êÁ†ÅËß£ÊûêÊñáÁ´†ÂÆûÊó∂Êî∂Âà∞ÈÄöÁü•„ÄÇÊØèÂë®Êõ¥Êñ∞‰∏ÄÁØáÂ∑¶Âè≥„ÄÇ   ËÆ§">
<meta name="keywords" content="Java,Êû∂ÊûÑ,ÂêéÁ´Ø,ÊúçÂä°Á´Ø,RocketMQ,MyCAT,ÂàÜÂ∏ÉÂºèÊ∂àÊÅØÈòüÂàó,ÂàÜÂ∏ÉÂºèÂ≠òÂÇ®,ÊäÄÊúØÂçöÂÆ¢">
<meta property="og:type" content="article">
<meta property="og:title" content="Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL">
<meta property="og:url" content="http://www.yunai.me/Sharding-JDBC/sql-parse-3/index.html">
<meta property="og:site_name" content="ËäãËâøVÁöÑÂçöÂÆ¢">
<meta property="og:description" content="üôÇüôÇüôÇÂÖ≥Ê≥®ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºö„ÄêËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã„ÄëÊúâÁ¶èÂà©Ôºö    RocketMQ / MyCAT / Sharding-JDBC ÊâÄÊúâÊ∫êÁ†ÅÂàÜÊûêÊñáÁ´†ÂàóË°®   RocketMQ / MyCAT / Sharding-JDBC ‰∏≠ÊñáÊ≥®ÈáäÊ∫êÁ†Å GitHub Âú∞ÂùÄ   ÊÇ®ÂØπ‰∫éÊ∫êÁ†ÅÁöÑÁñëÈóÆÊØèÊù°ÁïôË®ÄÈÉΩÂ∞ÜÂæóÂà∞ËÆ§ÁúüÂõûÂ§ç„ÄÇÁîöËá≥‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËØªÊ∫êÁ†Å‰πüÂèØ‰ª•ËØ∑ÊïôÂô¢„ÄÇ   Êñ∞ÁöÑÊ∫êÁ†ÅËß£ÊûêÊñáÁ´†ÂÆûÊó∂Êî∂Âà∞ÈÄöÁü•„ÄÇÊØèÂë®Êõ¥Êñ∞‰∏ÄÁØáÂ∑¶Âè≥„ÄÇ   ËÆ§">
<meta property="og:image" content="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/03.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/04.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/01.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/05.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/06.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/02.png">
<meta property="og:updated_time" content="2017-07-31T12:30:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL">
<meta name="twitter:description" content="üôÇüôÇüôÇÂÖ≥Ê≥®ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºö„ÄêËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã„ÄëÊúâÁ¶èÂà©Ôºö    RocketMQ / MyCAT / Sharding-JDBC ÊâÄÊúâÊ∫êÁ†ÅÂàÜÊûêÊñáÁ´†ÂàóË°®   RocketMQ / MyCAT / Sharding-JDBC ‰∏≠ÊñáÊ≥®ÈáäÊ∫êÁ†Å GitHub Âú∞ÂùÄ   ÊÇ®ÂØπ‰∫éÊ∫êÁ†ÅÁöÑÁñëÈóÆÊØèÊù°ÁïôË®ÄÈÉΩÂ∞ÜÂæóÂà∞ËÆ§ÁúüÂõûÂ§ç„ÄÇÁîöËá≥‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËØªÊ∫êÁ†Å‰πüÂèØ‰ª•ËØ∑ÊïôÂô¢„ÄÇ   Êñ∞ÁöÑÊ∫êÁ†ÅËß£ÊûêÊñáÁ´†ÂÆûÊó∂Êî∂Âà∞ÈÄöÁü•„ÄÇÊØèÂë®Êõ¥Êñ∞‰∏ÄÁØáÂ∑¶Âè≥„ÄÇ   ËÆ§">
<meta name="twitter:image" content="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,Êû∂ÊûÑ,ÂêéÁ´Ø,ÊúçÂä°Á´Ø,RocketMQ,MyCAT,ÂàÜÂ∏ÉÂºèÊ∂àÊÅØÈòüÂàó,ÂàÜÂ∏ÉÂºèÂ≠òÂÇ®,ÊäÄÊúØÂçöÂÆ¢">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- ÁôæÂ∫¶ÁªüËÆ° -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- ÁôæÂ∫¶Á´ôÈïø-Ë¢´Âä®Êé®ÈÄÅ -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360ÊêúÁ¥¢-Ëá™Âä®Êî∂ÂΩï -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/Sharding-JDBC/sql-parse-4/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$(" #i-prev").toggle();"="" onmouseout="$("></i></a></li>
        
        
        <li><a class="icon" href="/Sharding-JDBC/sql-parse-2/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/Sharding-JDBC/sql-parse-3/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&text=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&is_video=false&description=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL&body=Check out this article: http://www.yunai.me/Sharding-JDBC/sql-parse-3/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&name=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Ê¶ÇËø∞"><span class="toc-number">1.</span> <span class="toc-text">1. Ê¶ÇËø∞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-SelectStatement"><span class="toc-number">2.</span> <span class="toc-text">2. SelectStatement</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-AbstractSQLStatement"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 AbstractSQLStatement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-SQLToken"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 SQLToken</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-query"><span class="toc-number">3.</span> <span class="toc-text">3. #query()</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-parseDistinct"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 #parseDistinct()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-parseSelectList"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 #parseSelectList()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-SelectItem-ÈÄâÊã©È°π"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 SelectItem ÈÄâÊã©È°π</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-parseAlias-Ëß£ÊûêÂà´Âêç"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 #parseAlias() Ëß£ÊûêÂà´Âêç</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-TableToken-Ë°®Ê†áËÆ∞ÂØπË±°"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 TableToken Ë°®Ê†áËÆ∞ÂØπË±°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-skipToFrom"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 #skipToFrom()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-parseFrom"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 #parseFrom()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-JOIN-ON-FROM-TABLE"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 JOIN ON / FROM TABLE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-Â≠êÊü•ËØ¢"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 Â≠êÊü•ËØ¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-parseJoinTable"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 #parseJoinTable()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-Tables-Ë°®ÈõÜÂêàÂØπË±°"><span class="toc-number">3.4.4.</span> <span class="toc-text">3.4.4 Tables Ë°®ÈõÜÂêàÂØπË±°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-parseWhere"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 #parseWhere()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-parseGroupBy"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 #parseGroupBy()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-1-OrderItem-ÊéíÂ∫èÈ°π"><span class="toc-number">3.6.1.</span> <span class="toc-text">3.6.1 OrderItem ÊéíÂ∫èÈ°π</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-parseOrderBy"><span class="toc-number">3.7.</span> <span class="toc-text">3.7 #parseOrderBy()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-parseLimit"><span class="toc-number">3.8.</span> <span class="toc-text">3.8 #parseLimit()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-1-Limit"><span class="toc-number">3.8.1.</span> <span class="toc-text">3.8.1 Limit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-2-OffsetToken-RowCountToken"><span class="toc-number">3.8.2.</span> <span class="toc-text">3.8.2 OffsetToken RowCountToken</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-queryRest"><span class="toc-number">3.9.</span> <span class="toc-text">3.9 #queryRest()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-appendDerivedÁ≠âÊñπÊ≥ï"><span class="toc-number">4.</span> <span class="toc-text">4. appendDerivedÁ≠âÊñπÊ≥ï</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-appendAvgDerivedColumns"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 appendAvgDerivedColumns</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-appendDerivedOrderColumns"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 appendDerivedOrderColumns</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-ItemsToken"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 ItemsToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-appendDerivedOrderBy"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 appendDerivedOrderBy()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-OrderByToken"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.3.1 OrderByToken</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-ÂΩ©Ëõã"><span class="toc-number">5.</span> <span class="toc-text">666. ÂΩ©Ëõã</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">ËäãËâøVÁöÑÂçöÂÆ¢</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-07-26T16:00:00.000Z" itemprop="datePublished">2017-07-27</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>üôÇüôÇüôÇÂÖ≥Ê≥®<strong>ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºö„ÄêËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã„Äë</strong>ÊúâÁ¶èÂà©Ôºö  </p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ÊâÄÊúâ</strong>Ê∫êÁ†ÅÂàÜÊûêÊñáÁ´†ÂàóË°®  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>‰∏≠ÊñáÊ≥®ÈáäÊ∫êÁ†Å GitHub Âú∞ÂùÄ</strong>  </li>
<li>ÊÇ®ÂØπ‰∫éÊ∫êÁ†ÅÁöÑÁñëÈóÆÊØèÊù°ÁïôË®Ä<strong>ÈÉΩ</strong>Â∞ÜÂæóÂà∞<strong>ËÆ§Áúü</strong>ÂõûÂ§ç„ÄÇ<strong>ÁîöËá≥‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËØªÊ∫êÁ†Å‰πüÂèØ‰ª•ËØ∑ÊïôÂô¢</strong>„ÄÇ  </li>
<li><strong>Êñ∞ÁöÑ</strong>Ê∫êÁ†ÅËß£ÊûêÊñáÁ´†<strong>ÂÆûÊó∂</strong>Êî∂Âà∞ÈÄöÁü•„ÄÇ<strong>ÊØèÂë®Êõ¥Êñ∞‰∏ÄÁØáÂ∑¶Âè≥</strong>„ÄÇ  </li>
<li><strong>ËÆ§ÁúüÁöÑ</strong>Ê∫êÁ†Å‰∫§ÊµÅÂæÆ‰ø°Áæ§„ÄÇ</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. Ê¶ÇËø∞</a></li>
<li><a href="#">2. SelectStatement</a><ul>
<li><a href="#">2.1 AbstractSQLStatement</a></li>
<li><a href="#">2.2 SQLToken</a></li>
</ul>
</li>
<li><a href="#">3. #query()</a><ul>
<li><a href="#">3.1 #parseDistinct()</a></li>
<li><a href="#">3.2 #parseSelectList()</a></li>
<li><a href="#">3.3 #skipToFrom()</a></li>
<li><a href="#">3.4 #parseFrom()</a></li>
<li><a href="#">3.5 #parseWhere()</a></li>
<li><a href="#">3.6 #parseGroupBy()</a></li>
<li><a href="#">3.7 #parseOrderBy()</a></li>
<li><a href="#">3.8 #parseLimit()</a></li>
<li><a href="#">3.9 #queryRest()</a></li>
</ul>
</li>
<li><a href="#">4. appendDerivedÁ≠âÊñπÊ≥ï</a><ul>
<li><a href="#">4.1 appendAvgDerivedColumns</a></li>
<li><a href="#">4.2 appendDerivedOrderColumns</a></li>
<li><a href="#">4.3 ItemsToken</a></li>
<li><a href="#">4.4 appendDerivedOrderBy()</a></li>
</ul>
</li>
<li><a href="#">666. ÂΩ©Ëõã</a></li>
</ul>
<hr>
<h1 id="1-Ê¶ÇËø∞"><a href="#1-Ê¶ÇËø∞" class="headerlink" title="1. Ê¶ÇËø∞"></a>1. Ê¶ÇËø∞</h1><p>Êú¨ÊñáÂâçÁΩÆÈòÖËØªÔºö</p>
<ul>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-1/?self">„ÄäSQL Ëß£ÊûêÔºà‰∏ÄÔºâ‰πãËØçÊ≥ïËß£Êûê„Äã</a></li>
<li><a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">„ÄäSQL Ëß£ÊûêÔºà‰∫åÔºâ‰πãSQLËß£Êûê„Äã</a></li>
</ul>
<p>Êú¨ÊñáÂàÜ‰∫´<strong>ÊèíÂÖ•SQLËß£Êûê</strong>ÁöÑÊ∫êÁ†ÅÂÆûÁé∞„ÄÇ</p>
<p>Áî±‰∫éÊØè‰∏™Êï∞ÊçÆÂ∫ìÂú®ÈÅµÂÆà SQL ËØ≠Ê≥ïËßÑËåÉÁöÑÂêåÊó∂ÔºåÂèàÊúâÂêÑËá™Áã¨ÁâπÁöÑËØ≠Ê≥ï„ÄÇÂõ†Ê≠§ÔºåÂú® Sharding-JDBC ÈáåÊØè‰∏™Êï∞ÊçÆÂ∫ìÈÉΩÊúâËá™Â∑±ÁöÑ SELECT ËØ≠Âè•ÁöÑËß£ÊûêÂô®ÂÆûÁé∞ÊñπÂºèÔºåÂΩìÁÑ∂ÁªùÂ§ßÈÉ®ÂàÜÈÄªËæëÊòØÁõ∏ÂêåÁöÑ„ÄÇ<strong>Êú¨Êñá‰∏ªË¶ÅÂàÜ‰∫´Á¨îËÄÖÊúÄÂ∏∏Áî®ÁöÑ MySQL Êü•ËØ¢</strong>„ÄÇ</p>
<p>Êü•ËØ¢ SQL Ëß£Êûê‰∏ªÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/03.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SelectStatement <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">   query();</div><div class="line">   parseOrderBy();</div><div class="line">   customizedSelect();</div><div class="line">   appendDerivedColumns();</div><div class="line">   appendDerivedOrderBy();</div><div class="line">   <span class="keyword">return</span> selectStatement;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>#parseOrderBy()</code> ÔºöÂØπ‰∫é MySQL Êü•ËØ¢ËØ≠Âè•Ëß£ÊûêÂô®Êó†ÊïàÊûúÔºåÂõ†‰∏∫Â∑≤ÁªèÂú® <code>#query()</code> ÊñπÊ≥ïÈáåÈù¢Â∑≤ÁªèË∞ÉÁî® <code>#parseOrderBy()</code>ÔºåÂõ†Ê≠§Âõæ‰∏≠ÁúÅÁï•ËØ•ÊñπÊ≥ï„ÄÇ</li>
<li><code>#customizedSelect()</code> ÔºöOracle„ÄÅSQLServer Êü•ËØ¢ËØ≠Âè•Ëß£ÊûêÂô®ÈáçÂÜô‰∫ÜËØ•ÊñπÊ≥ïÔºåÂØπ‰∫é MySQL Êü•ËØ¢Ëß£ÊûêÂô®ÊòØ‰∏™Á©∫ÊñπÊ≥ïÔºåËøõË°åÁúÅÁï•„ÄÇÊúâÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•ÂçïÁã¨ÂéªÁ†îÁ©∂Á†îÁ©∂„ÄÇ</li>
</ul>
<blockquote>
<p><strong>Sharding-JDBC Ê≠£Âú®Êî∂ÈõÜ‰ΩøÁî®ÂÖ¨Âè∏ÂêçÂçïÔºö<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">‰º†ÈÄÅÈó®</a>„ÄÇ<br>üôÇ ‰Ω†ÁöÑÁôªËÆ∞Ôºå‰ºöËÆ©Êõ¥Â§ö‰∫∫ÂèÇ‰∏éÂíå‰ΩøÁî® Sharding-JDBC„ÄÇ<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">‰º†ÈÄÅÈó®</a><br>Sharding-JDBC ‰πü‰ºöÂõ†Ê≠§ÔºåËÉΩÂ§üË¶ÜÁõñÊõ¥Â§öÁöÑ‰∏öÂä°Âú∫ÊôØ„ÄÇ<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">‰º†ÈÄÅÈó®</a><br>ÁôªËÆ∞ÂêßÔºåÈ™öÂπ¥ÔºÅ<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">‰º†ÈÄÅÈó®</a></strong></p>
</blockquote>
<p>üëº Êü•ËØ¢ËØ≠Âè•Ëß£ÊûêÊòØÂ¢ûÂà†ÊîπÊü•ÈáåÈù¢<strong>ÊúÄÁÅµÊ¥ª‰πüÊòØÊúÄÂ§çÊùÇÁöÑ</strong>ÔºåÂ∏åÊúõÂ§ßÂÆ∂ÊúâËÄêÂøÉÁúãÂÆåÊú¨Êñá„ÄÇÁêÜËß£Êü•ËØ¢ËØ≠Âè•Ëß£ÊûêÔºåÂè¶Â§ñ‰∏âÁßçËØ≠Âè•ÁêÜËß£Ëµ∑Êù•ÁÆÄÁõ¥ÊòØ SO EASY„ÄÇÈ™ó‰∫∫ÊòØÂ∞èÁãóüê∂„ÄÇ<br>üôÇÂ¶ÇÊûúÂØπÊú¨ÊñáÊúâ‰∏çÁêÜËß£ÁöÑÂú∞ÊñπÔºåÂèØ‰ª•ÁªôÊàëÁöÑÂÖ¨‰ºóÂè∑<strong>Ôºà<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã</a>Ôºâ</strong>ÁïôË®ÄÔºåÊàë‰ºö<strong>ÈÄêÊù°ËÆ§ÁúüËÄêÂøÉ</strong>ÂõûÂ§ç„ÄÇÈ™ó‰∫∫ÊòØÂ∞èÁå™üê∑„ÄÇ</p>
<p>OKÔºå‰∏çÂ∫üËØùÂï¶ÔºåÂºÄÂßãÊàë‰ª¨ËøôÊÆµÁóõÂπ∂Âø´‰πêÁöÑÊóÖÈÄî„ÄÇ</p>
<h1 id="2-SelectStatement"><a href="#2-SelectStatement" class="headerlink" title="2. SelectStatement"></a>2. SelectStatement</h1><p>üôÇ <strong>Êú¨ËäÇÂè™‰ªãÁªçËøô‰∫õÁ±ªÔºåÊñπ‰æøÊú¨Êñá‰∏ãËäÇÂàÜÊûêÊ∫êÁ†ÅÂÆûÁé∞Â§ßÂÆ∂ËÉΩÁü•ÈÅìËÆ§ËØÜÂÆÉ‰ª¨</strong> üôÇ  </p>
<p>SelectStatementÔºåÊü•ËØ¢ËØ≠Âè•Ëß£ÊûêÁªìÊûúÂØπË±°„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SelectStatement.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectStatement</span> <span class="keyword">extends</span> <span class="title">AbstractSQLStatement</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÊòØÂê¶Ë°å DISTINCT / DISTINCTROW / UNION</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> distinct;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÊòØÂê¶Êü•ËØ¢ÊâÄÊúâÂ≠óÊÆµÔºåÂç≥ SELECT *</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> containStar;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÊúÄÂêé‰∏Ä‰∏™Êü•ËØ¢È°π‰∏ã‰∏Ä‰∏™ Token ÁöÑÂºÄÂßã‰ΩçÁΩÆ</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #items</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> selectListLastPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÊúÄÂêé‰∏Ä‰∏™ÂàÜÁªÑÈ°π‰∏ã‰∏Ä‰∏™ Token ÁöÑÂºÄÂßã‰ΩçÁΩÆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> groupByLastPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Êü•ËØ¢È°π</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SelectItem&gt; items = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÂàÜÁªÑÈ°π</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; groupByItems = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÊéíÂ∫èÈ°π</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OrderItem&gt; orderByItems = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÂàÜÈ°µ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Limit limit;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Êàë‰ª¨ÂØπÂ±ûÊÄßÊåâÁÖßÁ±ªÂûãËøõË°åÂΩíÁ±ªÔºö</p>
<ul>
<li>ÁâπÊÆä<ul>
<li>distinct </li>
</ul>
</li>
<li>Êü•ËØ¢Â≠óÊÆµ<ul>
<li>containStar</li>
<li>items</li>
<li>selectListLastPosition</li>
</ul>
</li>
<li>ÂàÜÁªÑÊù°‰ª∂<ul>
<li>groupByItems</li>
<li>groupByLastPosition</li>
</ul>
</li>
<li>ÊéíÂ∫èÊù°‰ª∂<ul>
<li>orderByItems</li>
</ul>
</li>
<li>ÂàÜÈ°µÊù°‰ª∂<ul>
<li>limit</li>
</ul>
</li>
</ul>
<h2 id="2-1-AbstractSQLStatement"><a href="#2-1-AbstractSQLStatement" class="headerlink" title="2.1 AbstractSQLStatement"></a>2.1 AbstractSQLStatement</h2><p>Â¢ûÂà†ÊîπÊü•Ëß£ÊûêÁªìÊûúÂØπË±°ÁöÑ<strong>ÊäΩË±°Áà∂Á±ª</strong>„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSQLStatement</span> <span class="keyword">implements</span> <span class="title">SQLStatement</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL Á±ªÂûã</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SQLType type;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Ë°®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Tables tables = <span class="keyword">new</span> Tables();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ËøáÊª§Êù°‰ª∂„ÄÇ</div><div class="line">     * Âè™ÊúâÂØπË∑ØÁî±ÁªìÊûúÊúâÂΩ±ÂìçÁöÑÊù°‰ª∂ÔºåÊâçÊ∑ªÂä†ËøõÊï∞ÁªÑ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Conditions conditions = <span class="keyword">new</span> Conditions();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQLÊ†áËÆ∞ÂØπË±°</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-2-SQLToken"><a href="#2-2-SQLToken" class="headerlink" title="2.2 SQLToken"></a>2.2 SQLToken</h2><p>SQLTokenÔºåSQLÊ†áËÆ∞ÂØπË±°Êé•Âè£ÔºåSQL ÊîπÂÜôÊó∂‰ΩøÁî®Âà∞„ÄÇ‰∏ãÈù¢ÈÉΩÊòØÂÆÉÁöÑÂÆûÁé∞Á±ªÔºö</p>
<table>
<thead>
<tr>
<th style="text-align:left">Á±ª</th>
<th style="text-align:left">ËØ¥Êòé</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GeneratedKeyToken</td>
<td style="text-align:left">Ëá™Â¢û‰∏ªÈîÆÊ†áËÆ∞ÂØπË±°</td>
</tr>
<tr>
<td style="text-align:left">TableToken</td>
<td style="text-align:left">Ë°®Ê†áËÆ∞ÂØπË±°</td>
</tr>
<tr>
<td style="text-align:left">ItemsToken</td>
<td style="text-align:left">ÈÄâÊã©È°πÊ†áËÆ∞ÂØπË±°</td>
</tr>
<tr>
<td style="text-align:left">OffsetToken</td>
<td style="text-align:left">ÂàÜÈ°µÂÅèÁßªÈáèÊ†áËÆ∞ÂØπË±°</td>
</tr>
<tr>
<td style="text-align:left">OrderByToken</td>
<td style="text-align:left">ÊéíÂ∫èÊ†áËÆ∞ÂØπË±°</td>
</tr>
<tr>
<td style="text-align:left">RowCountToken</td>
<td style="text-align:left">ÂàÜÈ°µÈïøÂ∫¶Ê†áËÆ∞ÂØπË±°</td>
</tr>
</tbody>
</table>
<h1 id="3-query"><a href="#3-query" class="headerlink" title="3. #query()"></a>3. #query()</h1><p><code>#query()</code>ÔºåÊü•ËØ¢ SQL Ëß£Êûê„ÄÇ</p>
<p><strong>MySQL SELECT Syntax</strong>Ôºö</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">// https://dev.mysql.com/doc/refman/5.7/en/select.html</div><div class="line"><span class="keyword">SELECT</span></div><div class="line">    [ALL | <span class="keyword">DISTINCT</span> | <span class="keyword">DISTINCTROW</span> ]</div><div class="line">      [<span class="keyword">HIGH_PRIORITY</span>]</div><div class="line">      [<span class="keyword">STRAIGHT_JOIN</span>]</div><div class="line">      [<span class="keyword">SQL_SMALL_RESULT</span>] [<span class="keyword">SQL_BIG_RESULT</span>] [<span class="keyword">SQL_BUFFER_RESULT</span>]</div><div class="line">      [<span class="keyword">SQL_CACHE</span> | SQL_NO_CACHE] [<span class="keyword">SQL_CALC_FOUND_ROWS</span>]</div><div class="line">    select_expr [, select_expr ...]</div><div class="line">    [<span class="keyword">FROM</span> table_references</div><div class="line">      [<span class="keyword">PARTITION</span> partition_list]</div><div class="line">    [<span class="keyword">WHERE</span> where_condition]</div><div class="line">    [<span class="keyword">GROUP</span> <span class="keyword">BY</span> &#123;col_name | expr | <span class="keyword">position</span>&#125;</div><div class="line">      [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ... [<span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>]]</div><div class="line">    [<span class="keyword">HAVING</span> where_condition]</div><div class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> &#123;col_name | expr | <span class="keyword">position</span>&#125;</div><div class="line">      [<span class="keyword">ASC</span> | <span class="keyword">DESC</span>], ...]</div><div class="line">    [<span class="keyword">LIMIT</span> &#123;[<span class="keyword">offset</span>,] <span class="keyword">row_count</span> | <span class="keyword">row_count</span> <span class="keyword">OFFSET</span> <span class="keyword">offset</span>&#125;]</div><div class="line">    [<span class="keyword">PROCEDURE</span> procedure_name(argument_list)]</div><div class="line">    [<span class="keyword">INTO</span> <span class="keyword">OUTFILE</span> <span class="string">'file_name'</span></div><div class="line">        [<span class="built_in">CHARACTER</span> <span class="keyword">SET</span> charset_name]</div><div class="line">        export_options</div><div class="line">      | <span class="keyword">INTO</span> <span class="keyword">DUMPFILE</span> <span class="string">'file_name'</span></div><div class="line">      | <span class="keyword">INTO</span> var_name [, var_name]]</div><div class="line">    [<span class="keyword">FOR</span> <span class="keyword">UPDATE</span> | <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span>]]</div></pre></td></tr></table></figure>
<p>Â§ß‰ΩìÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/04.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// MySQLSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.SELECT)) &#123;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">       parseDistinct();</div><div class="line">       getSqlParser().skipAll(MySQLKeyword.HIGH_PRIORITY, DefaultKeyword.STRAIGHT_JOIN, MySQLKeyword.SQL_SMALL_RESULT, MySQLKeyword.SQL_BIG_RESULT, MySQLKeyword.SQL_BUFFER_RESULT,</div><div class="line">               MySQLKeyword.SQL_CACHE, MySQLKeyword.SQL_NO_CACHE, MySQLKeyword.SQL_CALC_FOUND_ROWS);</div><div class="line">       parseSelectList(); <span class="comment">// Ëß£Êûê Êü•ËØ¢Â≠óÊÆµ</span></div><div class="line">       skipToFrom(); <span class="comment">// Ë∑≥Âà∞ FROM Â§Ñ</span></div><div class="line">   &#125;</div><div class="line">   parseFrom();<span class="comment">// Ëß£Êûê Ë°®ÔºàJOIN ON / FROM Âçï&amp;Â§öË°®Ôºâ</span></div><div class="line">   parseWhere(); <span class="comment">// Ëß£Êûê WHERE Êù°‰ª∂</span></div><div class="line">   parseGroupBy(); <span class="comment">// Ëß£Êûê Group By Âíå HavingÔºàÁõÆÂâç‰∏çÊîØÊåÅÔºâÊù°‰ª∂</span></div><div class="line">   parseOrderBy(); <span class="comment">// Ëß£Êûê Order By Êù°‰ª∂</span></div><div class="line">   parseLimit(); <span class="comment">// Ëß£Êûê ÂàÜÈ°µ Limit Êù°‰ª∂</span></div><div class="line">   <span class="comment">// [PROCEDURE] ÊöÇ‰∏çÊîØÊåÅ</span></div><div class="line">   <span class="keyword">if</span> (getSqlParser().equalAny(DefaultKeyword.PROCEDURE)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(getSqlParser().getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">   queryRest();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-1-parseDistinct"><a href="#3-1-parseDistinct" class="headerlink" title="3.1 #parseDistinct()"></a>3.1 #parseDistinct()</h2><p>Ëß£Êûê DISTINCT„ÄÅDISTINCTROW„ÄÅUNION Ë∞ìËØ≠„ÄÇ</p>
<p>Ê†∏ÂøÉ‰ª£Á†ÅÔºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseDistinct</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.DISTINCT, DefaultKeyword.DISTINCTROW, DefaultKeyword.UNION)) &#123;</div><div class="line">       selectStatement.setDistinct(<span class="keyword">true</span>);</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (hasDistinctOn() &amp;&amp; sqlParser.equalAny(DefaultKeyword.ON)) &#123; <span class="comment">// PostgreSQL Áã¨ÊúâËØ≠Ê≥ïÔºö DISTINCT ON</span></div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">           sqlParser.skipParentheses();</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.ALL)) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Ê≠§Â§Ñ DISTINCT Âíå DISTINCT(Â≠óÊÆµ) ‰∏çÂêåÔºåÂÆÉÊòØÈíàÂØπÊü•ËØ¢ÁªìÊûúÂÅöÂéªÈáçÔºåÂç≥Êï¥Ë°åÈáçÂ§ç„ÄÇ‰∏æ‰∏™‰æãÂ≠êÔºö</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; SELECT item_id, order_id FROM t_order_item;</div><div class="line">+---------+----------+</div><div class="line">| item_id | order_id |</div><div class="line">+---------+----------+</div><div class="line">| 1       | 1        |</div><div class="line">| 1       | 1        |</div><div class="line">+---------+----------+</div><div class="line">2 rows in set (0.03 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT DISTINCT item_id, order_id FROM t_order_item;</div><div class="line">+---------+----------+</div><div class="line">| item_id | order_id |</div><div class="line">+---------+----------+</div><div class="line">| 1       | 1        |</div><div class="line">+---------+----------+</div><div class="line">1 rows in set (0.02 sec)</div></pre></td></tr></table></figure>
<h2 id="3-2-parseSelectList"><a href="#3-2-parseSelectList" class="headerlink" title="3.2 #parseSelectList()"></a>3.2 #parseSelectList()</h2><table>
<thead>
<tr>
<th>SELECT</th>
<th>o.user_id</th>
<th>COUNT(DISTINCT i.item_id) AS item_count</th>
<th>MAX(i.item_id)</th>
<th>FROM</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>SelectItem</td>
<td>SelectItem</td>
<td>SelectItem</td>
</tr>
</tbody>
</table>
<p>Â∞Ü SQL <strong>Êü•ËØ¢Â≠óÊÆµ</strong> ÊåâÁÖß<strong>ÈÄóÂè∑( , )</strong>ÂàáÂâ≤Êàê<strong>Â§ö‰∏™</strong>ÈÄâÊã©È°π( SelectItem)„ÄÇÊ†∏ÂøÉ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseSelectList</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">do</span> &#123;</div><div class="line">       <span class="comment">// Ëß£ÊûêÂçï‰∏™ÈÄâÊã©È°π</span></div><div class="line">       parseSelectItem();</div><div class="line">   &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(Symbol.COMMA));</div><div class="line">   <span class="comment">// ËÆæÁΩÆ ÊúÄÂêé‰∏Ä‰∏™Êü•ËØ¢È°π‰∏ã‰∏Ä‰∏™ Token ÁöÑÂºÄÂßã‰ΩçÁΩÆ</span></div><div class="line">   selectStatement.setSelectListLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-1-SelectItem-ÈÄâÊã©È°π"><a href="#3-2-1-SelectItem-ÈÄâÊã©È°π" class="headerlink" title="3.2.1 SelectItem ÈÄâÊã©È°π"></a>3.2.1 SelectItem ÈÄâÊã©È°π</h3><p>SelectItem Êé•Âè£Ôºå<strong>Â±û‰∫éÂàÜÁâá‰∏ä‰∏ãÊñá‰ø°ÊÅØ</strong>ÔºåÊúâ 2 ‰∏™ÂÆûÁé∞Á±ªÔºö</p>
<ul>
<li>CommonSelectItem ÔºöÈÄöÁî®ÈÄâÊã©È°π</li>
<li>AggregationSelectItem ÔºöËÅöÂêàÈÄâÊã©È°π</li>
</ul>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/01.png" alt=""></p>
<p>Ëß£ÊûêÂçï‰∏™ SelectItem Ê†∏ÂøÉ‰ª£Á†ÅÔºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSelectItem</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// Á¨¨ÂõõÁßçÊÉÖÂÜµÔºåSQL Server Áã¨Êúâ</span></div><div class="line">   <span class="keyword">if</span> (isRowNumberSelectItem()) &#123;</div><div class="line">       selectStatement.getItems().add(parseRowNumberSelectItem());</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   sqlParser.skipIfEqual(DefaultKeyword.CONNECT_BY_ROOT); <span class="comment">// Oracle Áã¨ÊúâÔºöhttps://docs.oracle.com/cd/B19306_01/server.102/b14200/operators004.htm</span></div><div class="line">   String literals = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">   <span class="comment">// Á¨¨‰∏ÄÁßçÊÉÖÂÜµÔºå* ÈÄöÁî®ÈÄâÊã©È°πÔºåSELECT *</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(Symbol.STAR) || Symbol.STAR.getLiterals().equals(SQLUtil.getExactlyValue(literals))) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       selectStatement.getItems().add(<span class="keyword">new</span> CommonSelectItem(Symbol.STAR.getLiterals(), sqlParser.parseAlias()));</div><div class="line">       selectStatement.setContainStar(<span class="keyword">true</span>);</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// Á¨¨‰∫åÁßçÊÉÖÂÜµÔºåËÅöÂêàÈÄâÊã©È°π</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.MAX, DefaultKeyword.MIN, DefaultKeyword.SUM, DefaultKeyword.AVG, DefaultKeyword.COUNT)) &#123;</div><div class="line">       selectStatement.getItems().add(<span class="keyword">new</span> AggregationSelectItem(AggregationType.valueOf(literals.toUpperCase()), sqlParser.skipParentheses(), sqlParser.parseAlias()));</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// Á¨¨‰∏âÁßçÊÉÖÂÜµÔºåÈùû * ÈÄöÁî®ÈÄâÊã©È°π</span></div><div class="line">   StringBuilder expression = <span class="keyword">new</span> StringBuilder();</div><div class="line">   Token lastToken = <span class="keyword">null</span>;</div><div class="line">   <span class="keyword">while</span> (!sqlParser.equalAny(DefaultKeyword.AS) &amp;&amp; !sqlParser.equalAny(Symbol.COMMA) &amp;&amp; !sqlParser.equalAny(DefaultKeyword.FROM) &amp;&amp; !sqlParser.equalAny(Assist.END)) &#123;</div><div class="line">       String value = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">       <span class="keyword">int</span> position = sqlParser.getLexer().getCurrentToken().getEndPosition() - value.length();</div><div class="line">       expression.append(value);</div><div class="line">       lastToken = sqlParser.getLexer().getCurrentToken();</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       <span class="keyword">if</span> (sqlParser.equalAny(Symbol.DOT)) &#123;</div><div class="line">           selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(position, value));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ‰∏çÂ∏¶ ASÔºåÂπ∂‰∏îÊúâÂà´ÂêçÔºåÂπ∂‰∏îÂà´Âêç‰∏çÁ≠â‰∫éËá™Â∑±ÔºàtipsÔºöËøôÈáåÈáçÁÇπÁúã„ÄÇÂà§Êñ≠Ëøô‰πàÂ§çÊùÇÁöÑÂéüÂõ†ÔºöÈò≤Ê≠¢substringÊìç‰ΩúÊà™ÂèñÁªìÊûúÈîôËØØÔºâ</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != lastToken &amp;&amp; Literals.IDENTIFIER == lastToken.getType()</div><div class="line">           &amp;&amp; !isSQLPropertyExpression(expression, lastToken) <span class="comment">// ËøáÊª§ÊéâÔºåÂà´ÂêçÊòØËá™Â∑±ÁöÑÊÉÖÂÜµ„Äê1„ÄëÔºà‰æãÂ¶ÇÔºåSELECT u.user_id u.user_id FROM t_userÔºâ</span></div><div class="line">           &amp;&amp; !expression.toString().equals(lastToken.getLiterals())) &#123; <span class="comment">// ËøáÊª§ÊéâÔºåÊó†Âà´ÂêçÁöÑÊÉÖÂÜµ„Äê2„ÄëÔºà‰æãÂ¶ÇÔºåSELECT user_id FROM t_userÔºâ</span></div><div class="line">       selectStatement.getItems().add(</div><div class="line">               <span class="keyword">new</span> CommonSelectItem(SQLUtil.getExactlyValue(expression.substring(<span class="number">0</span>, expression.lastIndexOf(lastToken.getLiterals()))), Optional.of(lastToken.getLiterals())));</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// Â∏¶ ASÔºà‰æãÂ¶ÇÔºåSELECT user_id AS userIdÔºâ ÊàñËÄÖ Êó†Âà´ÂêçÔºà‰æãÂ¶ÇÔºåSELECT user_idÔºâ</span></div><div class="line">   selectStatement.getItems().add(<span class="keyword">new</span> CommonSelectItem(SQLUtil.getExactlyValue(expression.toString()), sqlParser.parseAlias()));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>‰∏ÄÂÖ±ÂàÜÊàê 4 ÁßçÂ§ßÁöÑÊÉÖÂÜµÔºåÊàë‰ª¨Êù•ÈÄêÊù°Ê¢≥ÁêÜÔºö</p>
<ul>
<li>Á¨¨‰∏ÄÁßçÔºö<strong><code>*</code> ÈÄöÁî®ÈÄâÊã©È°π</strong>Ôºö<br>‰æãÂ¶ÇÔºå<code>SELECT * FROM t_user</code> ÁöÑ <code>*</code>„ÄÇ<br>‰∏∫‰ªÄ‰πàË¶ÅÂä†   <code>Symbol.STAR.getLiterals().equals(SQLUtil.getExactlyValue(literals))</code> Âà§Êñ≠Âë¢Ôºü  </li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">`*`</span> <span class="keyword">FROM</span> t_user; // ‰πüËÉΩËææÂà∞Êü•ËØ¢ÊâÄÊúâÂ≠óÊÆµÁöÑÊïàÊûú</div></pre></td></tr></table></figure>
<ul>
<li>Á¨¨‰∫åÁßçÔºö<strong>ËÅöÂêàÈÄâÊã©È°π</strong>Ôºö<br>‰æãÂ¶ÇÔºå<code>SELECT COUNT(user_id) FROM t_user</code> ÁöÑ <code>COUNT(user_id)</code>„ÄÇ</li>
</ul>
<p>Ëß£ÊûêÁªìÊûú AggregationSelectItemÔºö<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/05.png" alt=""></p>
<p><code>sqlParser.skipParentheses()</code> Ëß£ÊûêËßÅ<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">„ÄäSQL Ëß£ÊûêÔºà‰∫åÔºâ‰πãSQLËß£Êûê„ÄãÁöÑAbstractParserÂ∞èËäÇ</a>„ÄÇ</p>
<ul>
<li>Á¨¨‰∏âÁßçÔºö<strong>Èùû <code>*</code> ÈÄöÁî®ÈÄâÊã©È°π</strong>Ôºö</li>
</ul>
<p>‰æãÂ¶ÇÔºå<code>SELECT user_id FROM t_user</code>„ÄÇ</p>
<p>‰ªéÂÆûÁé∞‰∏äÔºåÈÄªËæë‰ºöÂ§çÊùÇÂæàÂ§ö„ÄÇÁõ∏ÊØîÁ¨¨‰∏ÄÁßçÔºåÂèØ‰ª•Ê†πÊçÆ <code>*</code> ÂÅöÂ≠óÊÆµÂà§Êñ≠ÔºõÁõ∏ÊØîÁ¨¨‰∫åÁßçÔºåÂèØ‰ª•‰ΩøÁî® <code>(</code> Âíå <code>)</code> ÂÅöÂ≠óÊÆµÂà§Êñ≠„ÄÇËÉΩÂ§üÂà§Êñ≠‰∏Ä‰∏™<strong>ÂåÖÂê´Âà´ÂêçÁöÑ</strong> SelectItem ÁªìÊùüÊúâ 4 Áßç TokenÔºåÊ†πÊçÆÁªìÊùüÊñπÂºèÊàë‰ª¨ÂàÜÊàê 2 ÁßçÔºö</p>
<ul>
<li>DefaultKeyword.AS ÔºöËÉΩÂ§üÊé•Ëß¶Âá∫ SelectItem Â≠óÊÆµÔºå<strong>Âç≥‰∏çÂåÖÂê´Âà´Âêç</strong>„ÄÇ‰æãÂ¶ÇÔºå<code>SELECT user_id AS uid FROM t_user</code>ÔºåËÉΩÂ§üÁõ¥Êé•Ëß£ÊûêÂá∫ <code>user_id</code>„ÄÇ</li>
<li>Symbol.COMMA / DefaultKeyword.FROM / Assist.END Ôºö<strong>ÂåÖÂê´Âà´Âêç</strong>„ÄÇ‰æãÂ¶ÇÔºå<code>SELECT user_id uid FROM t_user</code>ÔºåËß£ÊûêÁªìÊûú‰∏∫ <code>user_id uid</code>„ÄÇ</li>
</ul>
<p>Âü∫‰∫éËøô‰∏™Âú®ÈÖçÂêà‰∏äÈù¢ÁöÑ‰ª£Á†ÅÊ≥®ÈáäÔºåÂ§ßÂÆ∂ÂÜçÈáçÊñ∞ÁêÜËß£‰∏ãÁ¨¨‰∏âÁßçÊÉÖÂÜµÁöÑÂÆûÁé∞„ÄÇ</p>
<ul>
<li>Á¨¨ÂõõÁßçÔºöSQLServer ROW_NUMBERÔºö</li>
</ul>
<p>ROW_NUMBER ÊòØ SQLServer Áã¨ÊúâÁöÑ„ÄÇÁî±‰∫éÊú¨ÊñáÂ§ßÈÉ®ÂàÜÁöÑËØªËÄÖ‰ΩøÁî®ÁöÑ MySQL / OracleÔºåÂ∞±Ë∑≥Ëøá‰∫Ü„ÄÇÊúâÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•Áúã <a href="https://github.com/dangdangdotcom/sharding-jdbc/blob/9354031743b63e44cbded5618980ae71a15f0260/sharding-jdbc-core/src/main/java/com/dangdang/ddframe/rdb/sharding/parsing/parser/dialect/sqlserver/SQLServerSelectParser.java" rel="external nofollow noopener noreferrer" target="_blank">SQLServerSelectParser#parseRowNumberSelectItem()</a> ÊñπÊ≥ï„ÄÇ</p>
<h3 id="3-2-2-parseAlias-Ëß£ÊûêÂà´Âêç"><a href="#3-2-2-parseAlias-Ëß£ÊûêÂà´Âêç" class="headerlink" title="3.2.2 #parseAlias() Ëß£ÊûêÂà´Âêç"></a>3.2.2 #parseAlias() Ëß£ÊûêÂà´Âêç</h3><p>Ëß£ÊûêÂà´ÂêçÔºåÂàÜÊàêÊòØÂê¶Â∏¶ <code>AS</code> ‰∏§ÁßçÊÉÖÂÜµ„ÄÇËß£Êûê‰ª£Á†ÅÔºö<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">„ÄäSQL Ëß£ÊûêÔºà‰∫åÔºâ‰πãSQLËß£Êûê„ÄãÁöÑ#parseAlias()Â∞èËäÇ</a>„ÄÇ</p>
<h3 id="3-2-3-TableToken-Ë°®Ê†áËÆ∞ÂØπË±°"><a href="#3-2-3-TableToken-Ë°®Ê†áËÆ∞ÂØπË±°" class="headerlink" title="3.2.3 TableToken Ë°®Ê†áËÆ∞ÂØπË±°"></a>3.2.3 TableToken Ë°®Ê†áËÆ∞ÂØπË±°</h3><p>TableTokenÔºåËÆ∞ÂΩïË°®ÂêçÂú® SQL ÈáåÂá∫Áé∞ÁöÑ<strong>‰ΩçÁΩÆ</strong>Âíå<strong>ÂêçÂ≠ó</strong>„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TableToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÂºÄÂßã‰ΩçÁΩÆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Ë°®ËææÂºè</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String originalLiterals;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Ëé∑ÂèñË°®ÂêçÁß∞.</div><div class="line">     * <span class="doctag">@return</span> Ë°®ÂêçÁß∞</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTableName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SQLUtil.getExactlyValue(originalLiterals);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>‰æãÂ¶Ç‰∏äÊñáÁ¨¨‰∏âÁßçÊÉÖÂÜµ„ÄÇ<br><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/06.png" alt=""></p>
<h2 id="3-3-skipToFrom"><a href="#3-3-skipToFrom" class="headerlink" title="3.3 #skipToFrom()"></a>3.3 #skipToFrom()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Ë∑≥Âà∞ FROM Â§Ñ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">skipToFrom</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">while</span> (!getSqlParser().equalAny(DefaultKeyword.FROM) &amp;&amp; !getSqlParser().equalAny(Assist.END)) &#123;</div><div class="line">       getSqlParser().getLexer().nextToken();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-4-parseFrom"><a href="#3-4-parseFrom" class="headerlink" title="3.4 #parseFrom()"></a>3.4 #parseFrom()</h2><p>Ëß£ÊûêË°®‰ª•ÂèäË°®ËøûÊé•ÂÖ≥Á≥ª„ÄÇ<strong>ËøôÂùóÁõ∏ÂØπÊØîËæÉÂ§çÊùÇÔºåËØ∑Â§ßÂÆ∂ËÄêÂøÉ+ËÄêÂøÉ+ËÄêÂøÉ„ÄÇ</strong></p>
<p><strong>MySQL JOIN Syntax</strong>Ôºö</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">// https://dev.mysql.com/doc/refman/5.7/en/join.html</div><div class="line">table_references:</div><div class="line">    escaped_table_reference [, escaped_table_reference] ...</div><div class="line"></div><div class="line">escaped_table_reference:</div><div class="line">    table_reference</div><div class="line">  | &#123; OJ table_reference &#125;</div><div class="line"></div><div class="line">table_reference:</div><div class="line">    table_factor</div><div class="line">  | join_table</div><div class="line"></div><div class="line">table_factor:</div><div class="line">    tbl_name [PARTITION (partition_names)]</div><div class="line">        [[AS] alias] [index_hint_list]</div><div class="line">  | table_subquery [AS] alias</div><div class="line">  | ( table_references )</div><div class="line"></div><div class="line">join_table:</div><div class="line">    table_reference [INNER | CROSS] JOIN table_factor [join_condition]</div><div class="line">  | table_reference STRAIGHT_JOIN table_factor</div><div class="line">  | table_reference STRAIGHT_JOIN table_factor ON conditional_expr</div><div class="line">  | table_reference &#123;LEFT|RIGHT&#125; [OUTER] JOIN table_reference join_condition</div><div class="line">  | table_reference NATURAL [&#123;LEFT|RIGHT&#125; [OUTER]] JOIN table_factor</div><div class="line"></div><div class="line">join_condition:</div><div class="line">    ON conditional_expr</div><div class="line">  | USING (column_list)</div><div class="line"></div><div class="line">index_hint_list:</div><div class="line">    index_hint [, index_hint] ...</div><div class="line"></div><div class="line">index_hint:</div><div class="line">    USE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] ([index_list])</div><div class="line">  | IGNORE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] (index_list)</div><div class="line">  | FORCE &#123;INDEX|KEY&#125;</div><div class="line">      [FOR &#123;JOIN|ORDER BY|GROUP BY&#125;] (index_list)</div><div class="line"></div><div class="line">index_list:</div><div class="line">    index_name [, index_name] ...</div></pre></td></tr></table></figure>
<h3 id="3-4-1-JOIN-ON-FROM-TABLE"><a href="#3-4-1-JOIN-ON-FROM-TABLE" class="headerlink" title="3.4.1 JOIN ON / FROM TABLE"></a>3.4.1 JOIN ON / FROM TABLE</h3><p>ÂÖàÊäõÂºÄ<strong>Â≠êÊü•ËØ¢</strong>ÁöÑÊÉÖÂÜµÔºåÂè™ËÄÉËôëÂ¶Ç‰∏ã‰∏§Áßç SQL ÊÉÖÂÜµ„ÄÇ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">// JOIN ON Ôºö ÂÆûÈôÖÂèØ‰ª•ÁªßÁª≠ JOIN ON Êõ¥Â§öË°®</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o.order_id = i.order_id; </div><div class="line">// FROM Â§öË°® ÔºöÂÆûÈôÖÂèØ‰ª•ÁªßÁª≠ FROM Â§öÊõ¥Ë°®</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o, t_order_item i</div></pre></td></tr></table></figure>
<p>Âú®ÁúãÂÆûÁé∞‰ª£Á†Å‰πãÂâçÔºåÂÖà‰∏ÄËµ∑Áúã‰∏ãË∞ÉÁî®È°∫Â∫èÂõæÔºö</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_07_27/02.png" alt=""></p>
<p>ÁúãÊáÇ‰∏äÂõæÂêéÔºåÊù•ÁªßÁª≠Áúã‰∏ãÂÆûÁé∞‰ª£Á†ÅÔºàüôÇ<strong>‰ª£Á†ÅÊúâÁÇπÂ§öÔºå‰∏çË¶ÅÊñπÔºÅ</strong>ÔºâÔºö</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* Ëß£ÊûêÊâÄÊúâË°®ÂêçÂíåË°®Âà´Âêç</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseFrom</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.FROM)) &#123;</div><div class="line">       parseTable();</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Ëß£ÊûêÊâÄÊúâË°®ÂêçÂíåË°®Âà´Âêç</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// Ëß£ÊûêÂ≠êÊü•ËØ¢</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(Symbol.LEFT_PAREN)) &#123;</div><div class="line">       <span class="keyword">if</span> (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support subquery for nested tables."</span>);</div><div class="line">       &#125;</div><div class="line">       selectStatement.setContainStar(<span class="keyword">false</span>);</div><div class="line">       sqlParser.skipUselessParentheses(); <span class="comment">// ÂéªÊéâÂ≠êÊü•ËØ¢Â∑¶Êã¨Âè∑</span></div><div class="line">       parse(); <span class="comment">// Ëß£ÊûêÂ≠êÊü•ËØ¢ SQL</span></div><div class="line">       sqlParser.skipUselessParentheses(); <span class="comment">// ÂéªÊéâÂ≠êÊü•ËØ¢Âè≥Êã¨Âè∑</span></div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="keyword">if</span> (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   parseTableFactor(); <span class="comment">// Ëß£ÊûêÂΩìÂâçË°®</span></div><div class="line">   parseJoinTable(); <span class="comment">// Ëß£Êûê‰∏ã‰∏Ä‰∏™Ë°®</span></div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Ëß£ÊûêÂçï‰∏™Ë°®ÂêçÂíåË°®Âà´Âêç</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parseTableFactor</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> beginPosition = sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length();</div><div class="line">   String literals = sqlParser.getLexer().getCurrentToken().getLiterals();</div><div class="line">   sqlParser.getLexer().nextToken();</div><div class="line">   <span class="comment">// TODO ÂåÖÂê´SchemaËß£Êûê</span></div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(Symbol.DOT)) &#123; <span class="comment">// https://dev.mysql.com/doc/refman/5.7/en/information-schema.html ÔºöSELECT table_name, table_type, engine FROM information_schema.tables</span></div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">       sqlParser.parseAlias();</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// FIXME Ê†πÊçÆshardingRuleËøáÊª§table</span></div><div class="line">   selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(beginPosition, literals));</div><div class="line">   <span class="comment">// Ë°® ‰ª•Âèä Ë°®Âà´Âêç</span></div><div class="line">   selectStatement.getTables().add(<span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), sqlParser.parseAlias()));</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Ëß£Êûê Join Table ÊàñËÄÖ FROM ‰∏ã‰∏ÄÂº† Table</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseJoinTable</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipJoin()) &#123;</div><div class="line">       <span class="comment">// ËøôÈáåË∞ÉÁî® parseJoinTable() ËÄå‰∏çÊòØ parseTableFactor() Ôºö‰∏ã‰∏Ä‰∏™ Table ÂèØËÉΩÊòØÂ≠êÊü•ËØ¢</span></div><div class="line">       <span class="comment">// ‰æãÂ¶ÇÔºöSELECT * FROM t_order JOIN (SELECT * FROM t_order_item JOIN t_order_other ON ) .....</span></div><div class="line">       parseTable();</div><div class="line">       <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.ON)) &#123; <span class="comment">// JOIN Ë°®Êó∂ ON Êù°‰ª∂</span></div><div class="line">           <span class="keyword">do</span> &#123;</div><div class="line">               parseTableCondition(sqlParser.getLexer().getCurrentToken().getEndPosition());</div><div class="line">               sqlParser.accept(Symbol.EQ);</div><div class="line">               parseTableCondition(sqlParser.getLexer().getCurrentToken().getEndPosition() - sqlParser.getLexer().getCurrentToken().getLiterals().length());</div><div class="line">           &#125; <span class="keyword">while</span> (sqlParser.skipIfEqual(DefaultKeyword.AND));</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.USING)) &#123; <span class="comment">// JOIN Ë°®Êó∂ USING ‰∏∫‰ΩøÁî®‰∏§Ë°®Áõ∏ÂêåÂ≠óÊÆµÁõ∏ÂêåÊó∂ÂØπ ON ÁöÑÁÆÄÂåñ„ÄÇ‰æãÂ¶Ç‰ª•‰∏ã‰∏§Êù° SQL Á≠â‰ª∑Ôºö</span></div><div class="line">                                                                   <span class="comment">// SELECT * FROM t_order o JOIN t_order_item i USING (order_id);</span></div><div class="line">                                                                   <span class="comment">// SELECT * FROM t_order o JOIN t_order_item i ON o.order_id = i.order_id</span></div><div class="line">           sqlParser.skipParentheses();</div><div class="line">       &#125;</div><div class="line">       parseJoinTable(); <span class="comment">// ÁªßÁª≠ÈÄíÂΩí</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Ëß£Êûê ON Êù°‰ª∂ÈáåÁöÑ TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> startPosition ÂºÄÂßã‰ΩçÁΩÆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseTableCondition</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> startPosition)</span> </span>&#123;</div><div class="line">   SQLExpression sqlExpression = sqlParser.parseExpression();</div><div class="line">   <span class="keyword">if</span> (!(sqlExpression <span class="keyword">instanceof</span> SQLPropertyExpression)) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   SQLPropertyExpression sqlPropertyExpression = (SQLPropertyExpression) sqlExpression;</div><div class="line">   <span class="keyword">if</span> (selectStatement.getTables().getTableNames().contains(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner().getName()))) &#123;</div><div class="line">       selectStatement.getSqlTokens().add(<span class="keyword">new</span> TableToken(startPosition, sqlPropertyExpression.getOwner().getName()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>OKÔºåÈÄíÂΩíÂõ†‰∏∫Âπ≥Êó∂Êó•Â∏∏‰∏≠ÂÜôÁöÑÊØîËæÉÂ∞ëÔºåÂèØËÉΩÁêÜËß£Ëµ∑Êù•ÂèØËÉΩ‰ºöÂõ∞Èöæ‰∏Ä‰∫õÔºåÂä™ÂäõÁúãÊáÇÔºÅüôÇ<strong>Â¶ÇÊûúÁúüÁöÑÁúã‰∏çÊáÇÔºåÂèØ‰ª•Âä†ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºà<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã</a>ÔºâÔºåÊàëÊù•Â∏Æ‰Ω†‰∏ÄËµ∑ÁêÜËß£„ÄÇ</strong></p>
<h3 id="3-4-2-Â≠êÊü•ËØ¢"><a href="#3-4-2-Â≠êÊü•ËØ¢" class="headerlink" title="3.4.2 Â≠êÊü•ËØ¢"></a>3.4.2 Â≠êÊü•ËØ¢</h3><p>Sharding-JDBC ÁõÆÂâçÊîØÊåÅ<strong>Á¨¨‰∏Ä‰∏™</strong>ÂåÖÂê´Â§öÂ±ÇÁ∫ßÁöÑÊï∞ÊçÆÂ≠êÊü•ËØ¢„ÄÇ‰æãÂ¶ÇÔºö</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3;</div><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3 <span class="keyword">JOIN</span> t_order_item i <span class="keyword">ON</span> o3.order_id = i.order_id;</div></pre></td></tr></table></figure>
<p>‰∏çÊîØÊåÅ<strong>Á¨¨‰∫å‰∏™ÂºÄÂßã</strong>ÂåÖÂê´Â§öÂ±ÇÁ∫ßÁöÑÊï∞ÊçÆÂ≠êÊü•ËØ¢„ÄÇ‰æãÂ¶ÇÔºö</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> o3.* <span class="keyword">FROM</span> t_order_item i <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o) o2) o3 <span class="keyword">ON</span> o3.order_id = i.order_id; // Ê≠§Êù° SQL ÊòØ‰∏äÈù¢Á¨¨‰∫åÊù° SQL Â∑¶Âè≥ÈáèË°®È¢†ÂÄí</div><div class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_order o <span class="keyword">WHERE</span> o.id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">FROM</span> t_order <span class="keyword">WHERE</span> <span class="keyword">status</span> = ?)) // <span class="keyword">FROM</span> ÂÆòÊñπ‰∏çÊîØÊåÅ <span class="keyword">SQL</span> ‰∏æ‰æã</div></pre></td></tr></table></figure>
<p>‰ΩøÁî®<strong>Á¨¨‰∫å‰∏™ÂºÄÂßã</strong>ÁöÑÂ≠êÊü•ËØ¢‰ºöÊäõÂá∫ÂºÇÂ∏∏Ôºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// AbstractSelectParser.java#parseTable()ÁâáÊÆµ</div><div class="line">if (!selectStatement.getTables().isEmpty()) &#123;</div><div class="line">    throw new UnsupportedOperationException(&quot;Cannot support subquery for nested tables.&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>‰ΩøÁî®Â≠êÊü•ËØ¢ÔºåÂª∫ËÆÆËÆ§ÁúüÈòÖËØªÂÆòÊñπ<a href="http://dangdangdotcom.github.io/sharding-jdbc/02-guide/subquery/" rel="external nofollow noopener noreferrer" target="_blank">„ÄäÂàÜÈ°µÂèäÂ≠êÊü•ËØ¢„Äã</a>ÊñáÊ°£„ÄÇ</p>
<h3 id="3-4-3-parseJoinTable"><a href="#3-4-3-parseJoinTable" class="headerlink" title="3.4.3 #parseJoinTable()"></a>3.4.3 #parseJoinTable()</h3><p>MySQLSelectParser ÈáçÂÜô‰∫Ü <code>#parseJoinTable()</code> ÊñπÊ≥ïÁî®‰∫éËß£Êûê USE / IGNORE / FORCE index_hint„ÄÇÂÖ∑‰ΩìËØ≠Ê≥ïËßÅ‰∏äÊñá <strong>JOIN Syntax</strong>„ÄÇËøôÈáåÂ∞±Ë∑≥ËøáÔºåÊúâÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•ÂéªÁúãÁúã„ÄÇ</p>
<h3 id="3-4-4-Tables-Ë°®ÈõÜÂêàÂØπË±°"><a href="#3-4-4-Tables-Ë°®ÈõÜÂêàÂØπË±°" class="headerlink" title="3.4.4 Tables Ë°®ÈõÜÂêàÂØπË±°"></a>3.4.4 Tables Ë°®ÈõÜÂêàÂØπË±°</h3><p><strong>Â±û‰∫éÂàÜÁâá‰∏ä‰∏ãÊñá‰ø°ÊÅØ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Tables.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Tables</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Table&gt; tables = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Table.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Table</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Ë°®</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Âà´Âêç</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; alias;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// AbstractSelectParser.java#parseTableFactor()ÁâáÊÆµ</span></div><div class="line">selectStatement.getTables().add(<span class="keyword">new</span> Table(SQLUtil.getExactlyValue(literals), sqlParser.parseAlias()));</div></pre></td></tr></table></figure>
<h2 id="3-5-parseWhere"><a href="#3-5-parseWhere" class="headerlink" title="3.5 #parseWhere()"></a>3.5 #parseWhere()</h2><p>Ëß£Êûê WHERE Êù°‰ª∂„ÄÇËß£Êûê‰ª£Á†ÅÔºö<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-2/?self">„ÄäSQL Ëß£ÊûêÔºà‰∫åÔºâ‰πãSQLËß£Êûê„ÄãÁöÑ#parseWhere()Â∞èËäÇ</a>„ÄÇ</p>
<h2 id="3-6-parseGroupBy"><a href="#3-6-parseGroupBy" class="headerlink" title="3.6 #parseGroupBy()"></a>3.6 #parseGroupBy()</h2><p>Ëß£ÊûêÂàÜÁªÑÊù°‰ª∂ÔºåÂÆûÁé∞‰∏äÊØîËæÉÁ±ª‰ºº <code>#parseSelectList</code>Ôºå‰ºöÊõ¥Âä†ÁÆÄÂçï‰∏Ä‰∫õ„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* Ëß£Êûê Group By Âíå HavingÔºàÊöÇÊó∂‰∏çÊîØÊåÅÔºâ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseGroupBy</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.GROUP)) &#123;</div><div class="line">       sqlParser.accept(DefaultKeyword.BY);</div><div class="line">       <span class="comment">// Ëß£Êûê Group By ÊØè‰∏™Â≠óÊÆµ</span></div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           addGroupByItem(sqlParser.parseExpression(selectStatement));</div><div class="line">           <span class="keyword">if</span> (!sqlParser.equalAny(Symbol.COMMA)) &#123;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">while</span> (sqlParser.equalAny(DefaultKeyword.WITH) || sqlParser.getLexer().getCurrentToken().getLiterals().equalsIgnoreCase(<span class="string">"ROLLUP"</span>)) &#123;</div><div class="line">           sqlParser.getLexer().nextToken();</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// HavingÔºàÊöÇÊó∂‰∏çÊîØÊåÅÔºâ</span></div><div class="line">       <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.HAVING)) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Having"</span>);</div><div class="line">       &#125;</div><div class="line">       selectStatement.setGroupByLastPosition(sqlParser.getLexer().getCurrentToken().getEndPosition());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.HAVING)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Cannot support Having"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Ëß£Êûê Group By Âçï‰∏™Â≠óÊÆµ</div><div class="line">* Group By Êù°‰ª∂ÊòØÂ∏¶ÊúâÊéíÂ∫èÂäüËÉΩÔºåÈªòËÆ§ASC</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlExpression Ë°®ËææÂºè</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addGroupByItem</span><span class="params">(<span class="keyword">final</span> SQLExpression sqlExpression)</span> </span>&#123;</div><div class="line">   <span class="comment">// Group By Â≠óÊÆµ DESC / ASC / ;ÈªòËÆ§ÊòØ ASC„ÄÇ</span></div><div class="line">   OrderType orderByType = OrderType.ASC;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.ASC)) &#123;</div><div class="line">       sqlParser.getLexer().nextToken();</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlParser.skipIfEqual(DefaultKeyword.DESC)) &#123;</div><div class="line">       orderByType = OrderType.DESC;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// Ëß£Êûê OrderItem</span></div><div class="line">   OrderItem orderItem;</div><div class="line">   <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLPropertyExpression) &#123;</div><div class="line">       SQLPropertyExpression sqlPropertyExpression = (SQLPropertyExpression) sqlExpression;</div><div class="line">       orderItem = <span class="keyword">new</span> OrderItem(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner().getName()), SQLUtil.getExactlyValue(sqlPropertyExpression.getName()), orderByType,</div><div class="line">               getAlias(SQLUtil.getExactlyValue(sqlPropertyExpression.getOwner() + <span class="string">"."</span> + SQLUtil.getExactlyValue(sqlPropertyExpression.getName()))));</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlExpression <span class="keyword">instanceof</span> SQLIdentifierExpression) &#123;</div><div class="line">       SQLIdentifierExpression sqlIdentifierExpression = (SQLIdentifierExpression) sqlExpression;</div><div class="line">       orderItem = <span class="keyword">new</span> OrderItem(SQLUtil.getExactlyValue(sqlIdentifierExpression.getName()), orderByType, getAlias(SQLUtil.getExactlyValue(sqlIdentifierExpression.getName())));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   selectStatement.getGroupByItems().add(orderItem);</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Â≠óÊÆµÂú®Êü•ËØ¢È°πÈáåÁöÑÂà´Âêç</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> name Â≠óÊÆµ</div><div class="line">* <span class="doctag">@return</span> Âà´Âêç</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Optional&lt;String&gt; <span class="title">getAlias</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (selectStatement.isContainStar()) &#123;</div><div class="line">       <span class="keyword">return</span> Optional.absent();</div><div class="line">   &#125;</div><div class="line">   String rawName = SQLUtil.getExactlyValue(name);</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (rawName.equalsIgnoreCase(SQLUtil.getExactlyValue(each.getExpression()))) &#123;</div><div class="line">           <span class="keyword">return</span> each.getAlias();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (rawName.equalsIgnoreCase(each.getAlias().orNull())) &#123;</div><div class="line">           <span class="keyword">return</span> Optional.of(rawName);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> Optional.absent();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-6-1-OrderItem-ÊéíÂ∫èÈ°π"><a href="#3-6-1-OrderItem-ÊéíÂ∫èÈ°π" class="headerlink" title="3.6.1 OrderItem ÊéíÂ∫èÈ°π"></a>3.6.1 OrderItem ÊéíÂ∫èÈ°π</h3><p><strong>Â±û‰∫éÂàÜÁâá‰∏ä‰∏ãÊñá‰ø°ÊÅØ</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderItem</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * ÊâÄÂ±ûË°®Âà´Âêç</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; owner;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * ÊéíÂ∫èÂ≠óÊÆµ</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Optional&lt;String&gt; name;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * ÊéíÂ∫èÁ±ªÂûã</div><div class="line">    */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderType type;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * ÊåâÁÖßÁ¨¨Âá†‰∏™Êü•ËØ¢Â≠óÊÆµÊéíÂ∫è</div><div class="line">    * ORDER BY Êï∞Â≠ó ÁöÑ Êï∞Â≠ó‰ª£Ë°®ÁöÑÊòØÁ¨¨Âá†‰∏™Â≠óÊÆµ</div><div class="line">    */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index = -<span class="number">1</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * Â≠óÊÆµÂú®Êü•ËØ¢È°π(&#123;<span class="doctag">@link</span> com.dangdang.ddframe.rdb.sharding.parsing.parser.context.selectitem.SelectItem&#125; ÁöÑÂà´Âêç</div><div class="line">    */</div><div class="line">    <span class="meta">@Setter</span></div><div class="line">    <span class="keyword">private</span> Optional&lt;String&gt; alias;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-7-parseOrderBy"><a href="#3-7-parseOrderBy" class="headerlink" title="3.7 #parseOrderBy()"></a>3.7 #parseOrderBy()</h2><p>Ëß£ÊûêÊéíÂ∫èÊù°‰ª∂„ÄÇÂÆûÁé∞ÈÄªËæëÁ±ª‰ºº <code>#parseGroupBy()</code>ÔºåËøôÈáåÂ∞±Ë∑≥ËøáÔºåÊúâÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•ÂéªÁúãÁúã„ÄÇ</p>
<h2 id="3-8-parseLimit"><a href="#3-8-parseLimit" class="headerlink" title="3.8 #parseLimit()"></a>3.8 #parseLimit()</h2><p>Ëß£ÊûêÂàÜÈ°µ Limit Êù°‰ª∂„ÄÇÁõ∏ÂØπÁÆÄÂçïÔºåËøôÈáåÂ∞±Ë∑≥ËøáÔºåÊúâÂÖ¥Ë∂£ÁöÑÂêåÂ≠¶ÂèØ‰ª•ÂéªÁúãÁúã„ÄÇÊ≥®ÊÑè‰∏ãÔºåÂàÜÊàê 3 ÁßçÊÉÖÂÜµÔºö</p>
<ul>
<li>LIMIT row_count</li>
<li>LIMIT offset, row_count</li>
<li>LIMIT row_count OFFSET offset</li>
</ul>
<h3 id="3-8-1-Limit"><a href="#3-8-1-Limit" class="headerlink" title="3.8.1 Limit"></a>3.8.1 Limit</h3><p>ÂàÜÈ°µÂØπË±°„ÄÇ<strong>Â±û‰∫éÂàÜÁâá‰∏ä‰∏ãÊñá‰ø°ÊÅØ</strong>„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Limit.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Limit</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÊòØÂê¶ÈáçÂÜôrowCount</div><div class="line">     * TODO ÂæÖË°•ÂÖÖÔºöÈ¢ÑËÆ°ÂíåÂÜÖÂ≠òÂàÜÈ°µÂêàÂπ∂ÊúâÂÖ≥</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> rowCountRewriteFlag;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * offset</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LimitValue offset;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * row</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LimitValue rowCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// LimitValue.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LimitValue</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÂÄº</div><div class="line">     * ÂΩì value == -1 Êó∂Ôºå‰∏∫Âç†‰ΩçÁ¨¶</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Á¨¨Âá†‰∏™Âç†‰ΩçÁ¨¶</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-8-2-OffsetToken-RowCountToken"><a href="#3-8-2-OffsetToken-RowCountToken" class="headerlink" title="3.8.2 OffsetToken RowCountToken"></a>3.8.2 OffsetToken RowCountToken</h3><ul>
<li>OffsetTokenÔºöÂàÜÈ°µÂÅèÁßªÈáèÊ†áËÆ∞ÂØπË±°</li>
<li>RowCountTokenÔºöÂàÜÈ°µÈïøÂ∫¶Ê†áËÆ∞ÂØπË±°</li>
</ul>
<p><strong>Âè™ÊúâÂú®ÂØπÂ∫î‰ΩçÁΩÆÈùûÂç†‰ΩçÁ¨¶ÊâçÊúâËØ• SQLToken</strong>„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// OffsetToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OffsetToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL ÊâÄÂú®ÂºÄÂßã‰ΩçÁΩÆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÂÅèÁßªÂÄº</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> offset;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RowCountToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RowCountToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL ÊâÄÂú®ÂºÄÂßã‰ΩçÁΩÆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Ë°åÊï∞</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> rowCount;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-9-queryRest"><a href="#3-9-queryRest" class="headerlink" title="3.9 #queryRest()"></a>3.9 #queryRest()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">queryRest</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (sqlParser.equalAny(DefaultKeyword.UNION, DefaultKeyword.EXCEPT, DefaultKeyword.INTERSECT, DefaultKeyword.MINUS)) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingUnsupportedException(sqlParser.getLexer().getCurrentToken().getType());</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>‰∏çÊîØÊåÅ UNION / EXCEPT / INTERSECT / MINUS ÔºåË∞ÉÁî®‰ºöÊäõÂá∫ÂºÇÂ∏∏„ÄÇ</p>
<h1 id="4-appendDerivedÁ≠âÊñπÊ≥ï"><a href="#4-appendDerivedÁ≠âÊñπÊ≥ï" class="headerlink" title="4. appendDerivedÁ≠âÊñπÊ≥ï"></a>4. appendDerivedÁ≠âÊñπÊ≥ï</h1><p>Âõ†‰∏∫ Sharding-JDBC ÂØπË°®ÂÅö‰∫ÜÂàÜÁâáÔºåÂú® AVG , GROUP BY , ORDER BY ÈúÄË¶ÅÂØπ SQL ËøõË°å‰∏Ä‰∫õÊîπÂÜôÔºå<strong>‰ª•ËææÂà∞ËÉΩÂú®ÂÜÖÂ≠òÈáåÂØπÁªìÊûúÂÅöËøõ‰∏ÄÊ≠•Â§ÑÁêÜ</strong>Ôºå‰æãÂ¶ÇÊ±ÇÂπ≥ÂùáÂÄº„ÄÅÂàÜÁªÑ„ÄÅÊéíÂ∫èÁ≠â„ÄÇ</p>
<p>üòàÔºöÊâìËµ∑Á≤æÁ•ûÔºåÊ≠§ÂùóÊòØÈùûÂ∏∏ÊúâË∂£ÁöÑ„ÄÇ</p>
<h2 id="4-1-appendAvgDerivedColumns"><a href="#4-1-appendAvgDerivedColumns" class="headerlink" title="4.1 appendAvgDerivedColumns"></a>4.1 appendAvgDerivedColumns</h2><p>Ëß£ÂÜ≥ AVG Êü•ËØ¢„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ÈíàÂØπ AVG ËÅöÂêàÂ≠óÊÆµÔºåÂ¢ûÂä†Êé®ÂØºÂ≠óÊÆµ</div><div class="line">* AVG ÊîπÂÜôÊàê SUM + COUNT Êü•ËØ¢ÔºåÂÜÖÂ≠òËÆ°ÁÆóÂá∫ AVG ÁªìÊûú„ÄÇ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> itemsToken ÈÄâÊã©È°πÊ†áËÆ∞ÂØπË±°</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendAvgDerivedColumns</span><span class="params">(<span class="keyword">final</span> ItemsToken itemsToken)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> derivedColumnOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (!(each <span class="keyword">instanceof</span> AggregationSelectItem) || AggregationType.AVG != ((AggregationSelectItem) each).getType()) &#123;</div><div class="line">           <span class="keyword">continue</span>;</div><div class="line">       &#125;</div><div class="line">       AggregationSelectItem avgItem = (AggregationSelectItem) each;</div><div class="line">       <span class="comment">// COUNT Â≠óÊÆµ</span></div><div class="line">       String countAlias = String.format(DERIVED_COUNT_ALIAS, derivedColumnOffset);</div><div class="line">       AggregationSelectItem countItem = <span class="keyword">new</span> AggregationSelectItem(AggregationType.COUNT, avgItem.getInnerExpression(), Optional.of(countAlias));</div><div class="line">       <span class="comment">// SUM Â≠óÊÆµ</span></div><div class="line">       String sumAlias = String.format(DERIVED_SUM_ALIAS, derivedColumnOffset);</div><div class="line">       AggregationSelectItem sumItem = <span class="keyword">new</span> AggregationSelectItem(AggregationType.SUM, avgItem.getInnerExpression(), Optional.of(sumAlias));</div><div class="line">       <span class="comment">// AggregationSelectItem ËÆæÁΩÆ</span></div><div class="line">       avgItem.getDerivedAggregationSelectItems().add(countItem);</div><div class="line">       avgItem.getDerivedAggregationSelectItems().add(sumItem);</div><div class="line">       <span class="comment">// TODO Â∞ÜAVGÂàóÊõøÊç¢ÊàêÂ∏∏Êï∞ÔºåÈÅøÂÖçÊï∞ÊçÆÂ∫ìÂÜçËÆ°ÁÆóÊó†Áî®ÁöÑAVGÂáΩÊï∞</span></div><div class="line">       <span class="comment">// ItemsToken</span></div><div class="line">       itemsToken.getItems().add(countItem.getExpression() + <span class="string">" AS "</span> + countAlias + <span class="string">" "</span>);</div><div class="line">       itemsToken.getItems().add(sumItem.getExpression() + <span class="string">" AS "</span> + sumAlias + <span class="string">" "</span>);</div><div class="line">       <span class="comment">//</span></div><div class="line">       derivedColumnOffset++;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-2-appendDerivedOrderColumns"><a href="#4-2-appendDerivedOrderColumns" class="headerlink" title="4.2 appendDerivedOrderColumns"></a>4.2 appendDerivedOrderColumns</h2><p>Ëß£ÂÜ≥ GROUP BY , ORDER BY„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ÈíàÂØπ GROUP BY Êàñ ORDER BY Â≠óÊÆµÔºåÂ¢ûÂä†Êé®ÂØºÂ≠óÊÆµ</div><div class="line">* Â¶ÇÊûúËØ•Â≠óÊÆµ‰∏çÂú®Êü•ËØ¢Â≠óÊÆµÈáåÔºåÈúÄË¶ÅÈ¢ùÂ§ñÊü•ËØ¢ËØ•Â≠óÊÆµÔºåËøôÊ†∑ÊâçËÉΩÂú®ÂÜÖÂ≠òÈáå GROUP BY Êàñ ORDER BY</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> itemsToken ÈÄâÊã©È°πÊ†áËÆ∞ÂØπË±°</div><div class="line">* <span class="doctag">@param</span> orderItems ÊéíÂ∫èÂ≠óÊÆµ</div><div class="line">* <span class="doctag">@param</span> aliasPattern Âà´ÂêçÊ®°Âºè</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendDerivedOrderColumns</span><span class="params">(<span class="keyword">final</span> ItemsToken itemsToken, <span class="keyword">final</span> List&lt;OrderItem&gt; orderItems, <span class="keyword">final</span> String aliasPattern)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> derivedColumnOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (OrderItem each : orderItems) &#123;</div><div class="line">       <span class="keyword">if</span> (!isContainsItem(each)) &#123;</div><div class="line">           String alias = String.format(aliasPattern, derivedColumnOffset++);</div><div class="line">           each.setAlias(Optional.of(alias));</div><div class="line">           itemsToken.getItems().add(each.getQualifiedName().get() + <span class="string">" AS "</span> + alias + <span class="string">" "</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Êü•ËØ¢Â≠óÊÆµÊòØÂê¶ÂåÖÂê´ÊéíÂ∫èÂ≠óÊÆµ</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> orderItem ÊéíÂ∫èÂ≠óÊÆµ</div><div class="line">* <span class="doctag">@return</span> ÊòØÂê¶</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isContainsItem</span><span class="params">(<span class="keyword">final</span> OrderItem orderItem)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (selectStatement.isContainStar()) &#123; <span class="comment">// SELECT *</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">for</span> (SelectItem each : selectStatement.getItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (-<span class="number">1</span> != orderItem.getIndex()) &#123; <span class="comment">// ORDER BY ‰ΩøÁî®Êï∞Â≠ó</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (each.getAlias().isPresent() &amp;&amp; orderItem.getAlias().isPresent() &amp;&amp; each.getAlias().get().equalsIgnoreCase(orderItem.getAlias().get())) &#123; <span class="comment">// Â≠óÊÆµÂà´ÂêçÊØîËæÉ</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!each.getAlias().isPresent() &amp;&amp; orderItem.getQualifiedName().isPresent() &amp;&amp; each.getExpression().equalsIgnoreCase(orderItem.getQualifiedName().get())) &#123; <span class="comment">// Â≠óÊÆµÂéüÂêçÊØîËæÉ</span></div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-3-ItemsToken"><a href="#4-3-ItemsToken" class="headerlink" title="4.3 ItemsToken"></a>4.3 ItemsToken</h2><p>ÈÄâÊã©È°πÊ†áËÆ∞ÂØπË±°Ôºå<strong>Â±û‰∫éÂàÜÁâá‰∏ä‰∏ãÊñá‰ø°ÊÅØ</strong>ÔºåÁõÆÂâçÊúâ 3 ‰∏™ÊÉÖÂÜµ‰ºöÂàõÂª∫Ôºö</p>
<ol>
<li><code>AVG</code> Êü•ËØ¢È¢ùÂ§ñ COUNT Âíå SUMÔºö<code>#appendAvgDerivedColumns()</code></li>
<li><code>GROUP BY</code> ‰∏çÂú® Êü•ËØ¢Â≠óÊÆµÔºåÈ¢ùÂ§ñÊü•ËØ¢ËØ•Â≠óÊÆµ Ôºö<code>#appendDerivedOrderColumns()</code></li>
<li><code>ORDER BY</code> ‰∏çÂú® Êü•ËØ¢Â≠óÊÆµÔºåÈ¢ùÂ§ñÊü•ËØ¢ËØ•Â≠óÊÆµ Ôºö<code>#appendDerivedOrderColumns()</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemsToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL ÂºÄÂßã‰ΩçÁΩÆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Â≠óÊÆµÂêçÊï∞ÁªÑ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; items = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-4-appendDerivedOrderBy"><a href="#4-4-appendDerivedOrderBy" class="headerlink" title="4.4 appendDerivedOrderBy()"></a>4.4 appendDerivedOrderBy()</h2><p>ÂΩì SQL ÊúâËÅöÂêàÊù°‰ª∂ËÄåÊó†ÊéíÂ∫èÊù°‰ª∂ÔºåÊ†πÊçÆËÅöÂêàÊù°‰ª∂ËøõË°åÊéíÂ∫è„ÄÇËøôÊòØÊï∞ÊçÆÂ∫ìËá™Â∑±ÁöÑÊâßË°åËßÑÂàô„ÄÇ</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">mysql&gt; SELECT order_id FROM t_order GROUP BY order_id;</div><div class="line">+----------+</div><div class="line">| order_id |</div><div class="line">+----------+</div><div class="line">| 1        |</div><div class="line">| 2        |</div><div class="line">| 3        |</div><div class="line">+----------+</div><div class="line">3 rows in set (0.05 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT order_id FROM t_order GROUP BY order_id DESC;</div><div class="line">+----------+</div><div class="line">| order_id |</div><div class="line">+----------+</div><div class="line">| 3        |</div><div class="line">| 2        |</div><div class="line">| 1        |</div><div class="line">+----------+</div><div class="line">3 rows in set (0.02 sec)</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// AbstractSelectParser.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ÂΩìÊó† Order By Êù°‰ª∂Êó∂Ôºå‰ΩøÁî® Group By ‰Ωú‰∏∫ÊéíÂ∫èÊù°‰ª∂ÔºàÊï∞ÊçÆÂ∫ìÊú¨Ë∫´ËßÑÂàôÔºâ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendDerivedOrderBy</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (!getSelectStatement().getGroupByItems().isEmpty() &amp;&amp; getSelectStatement().getOrderByItems().isEmpty()) &#123;</div><div class="line">       getSelectStatement().getOrderByItems().addAll(getSelectStatement().getGroupByItems());</div><div class="line">       getSelectStatement().getSqlTokens().add(<span class="keyword">new</span> OrderByToken(getSelectStatement().getGroupByLastPosition()));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-3-1-OrderByToken"><a href="#4-3-1-OrderByToken" class="headerlink" title="4.3.1 OrderByToken"></a>4.3.1 OrderByToken</h3><p>ÊéíÂ∫èÊ†áËÆ∞ÂØπË±°„ÄÇÂΩìÊó† Order By Êù°‰ª∂Êó∂Ôºå‰ΩøÁî® Group By ‰Ωú‰∏∫ÊéíÂ∫èÊù°‰ª∂ÔºàÊï∞ÊçÆÂ∫ìÊú¨Ë∫´ËßÑÂàôÔºâ„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// OrderByToken.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderByToken</span> <span class="keyword">implements</span> <span class="title">SQLToken</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SQL ÊâÄÂú®ÂºÄÂßã‰ΩçÁΩÆ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> beginPosition;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="666-ÂΩ©Ëõã"><a href="#666-ÂΩ©Ëõã" class="headerlink" title="666. ÂΩ©Ëõã"></a>666. ÂΩ©Ëõã</h1><p>Âí≥Âí≥Âí≥ÔºåÁ°ÆÂÆûÊúâ‰∏Ä‰∫õÁï•Èïø„ÄÇ‰ΩÜËØ∑Áõ∏‰ø°ÔºåINSERT / UPDATE / DELETE ‰ºöÁÆÄÂçïÂæàÂ§öÂæàÂ§ö„ÄÇËÄÉËØïËÄÉÁöÑ SQL ÊúÄÂ§öÁöÑÊòØ‰ªÄ‰πàÔºüSELECT ËØ≠Âè•ÂëÄÔºÅ‰∏∫Âï•ÔºåÈöæÂëó„ÄÇÊÅ©ÔºåÊàëÁõ∏‰ø°ÁúãÂà∞Ê≠§Â§ÑÁöÑ‰Ω†Ôºå‰∏ÄÂÆöÊòØËÉΩÁúãÊáÇÁöÑÔºåÂä†Ê≤πÔºÅ</p>
<p>üôÇÂ¶ÇÊûúÂØπÊú¨ÊñáÊúâ‰∏çÁêÜËß£ÁöÑÂú∞ÊñπÔºåÂèØ‰ª•ÂÖ≥Ê≥®ÊàëÁöÑÂÖ¨‰ºóÂè∑<strong>Ôºà<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">ËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã</a>Ôºâ</strong>Ëé∑Âæó<strong>ÂæÆ‰ø°Âè∑</strong>ÔºåÊàë‰ª¨Êù•‰∏ÄÂú∫Ôºå1 ÂØπ 1 ÁöÑÊêûÂü∫ÂêßÔºå‰∏ç‰∏ç‰∏çÔºåÊòØ‰∫§ÊµÅ‰∫§ÊµÅ„ÄÇ</p>
<p>ÈÅìÂèãÔºåÂ∏ÆÊàëÂàÜ‰∫´‰∏ÄÊ≥¢ÊÄé‰πàÊ†∑Ôºü</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Ê¶ÇËø∞"><span class="toc-number">1.</span> <span class="toc-text">1. Ê¶ÇËø∞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-SelectStatement"><span class="toc-number">2.</span> <span class="toc-text">2. SelectStatement</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-AbstractSQLStatement"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 AbstractSQLStatement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-SQLToken"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 SQLToken</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-query"><span class="toc-number">3.</span> <span class="toc-text">3. #query()</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-parseDistinct"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 #parseDistinct()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-parseSelectList"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 #parseSelectList()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-SelectItem-ÈÄâÊã©È°π"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 SelectItem ÈÄâÊã©È°π</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-parseAlias-Ëß£ÊûêÂà´Âêç"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 #parseAlias() Ëß£ÊûêÂà´Âêç</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-TableToken-Ë°®Ê†áËÆ∞ÂØπË±°"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 TableToken Ë°®Ê†áËÆ∞ÂØπË±°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-skipToFrom"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 #skipToFrom()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-parseFrom"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 #parseFrom()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-JOIN-ON-FROM-TABLE"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 JOIN ON / FROM TABLE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-Â≠êÊü•ËØ¢"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.4.2 Â≠êÊü•ËØ¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-parseJoinTable"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.4.3 #parseJoinTable()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-Tables-Ë°®ÈõÜÂêàÂØπË±°"><span class="toc-number">3.4.4.</span> <span class="toc-text">3.4.4 Tables Ë°®ÈõÜÂêàÂØπË±°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-parseWhere"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 #parseWhere()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-parseGroupBy"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 #parseGroupBy()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-1-OrderItem-ÊéíÂ∫èÈ°π"><span class="toc-number">3.6.1.</span> <span class="toc-text">3.6.1 OrderItem ÊéíÂ∫èÈ°π</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-parseOrderBy"><span class="toc-number">3.7.</span> <span class="toc-text">3.7 #parseOrderBy()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-parseLimit"><span class="toc-number">3.8.</span> <span class="toc-text">3.8 #parseLimit()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-1-Limit"><span class="toc-number">3.8.1.</span> <span class="toc-text">3.8.1 Limit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-2-OffsetToken-RowCountToken"><span class="toc-number">3.8.2.</span> <span class="toc-text">3.8.2 OffsetToken RowCountToken</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-queryRest"><span class="toc-number">3.9.</span> <span class="toc-text">3.9 #queryRest()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-appendDerivedÁ≠âÊñπÊ≥ï"><span class="toc-number">4.</span> <span class="toc-text">4. appendDerivedÁ≠âÊñπÊ≥ï</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-appendAvgDerivedColumns"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 appendAvgDerivedColumns</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-appendDerivedOrderColumns"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 appendDerivedOrderColumns</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-ItemsToken"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 ItemsToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-appendDerivedOrderBy"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 appendDerivedOrderBy()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-OrderByToken"><span class="toc-number">4.4.1.</span> <span class="toc-text">4.3.1 OrderByToken</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-ÂΩ©Ëõã"><span class="toc-number">5.</span> <span class="toc-text">666. ÂΩ©Ëõã</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/Sharding-JDBC/sql-parse-3/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&text=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&is_video=false&description=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL&body=Check out this article: http://www.yunai.me/Sharding-JDBC/sql-parse-3/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/Sharding-JDBC/sql-parse-3/&name=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 ÁéãÊñáÊñå
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO ÂæÖ‰ºòÂåñÔºöËøáÊª§ Áà¨Ëô´
        url = $('#actions .icon').attr('href').trim(); // ÊñáÁ´†url
//        alert(url);
        title = $('.posttitle').text().trim(); // ÊñáÁ´†Ê†áÈ¢ò
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // ÊèíÂÖ•Ê¨°Êï∞
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // ÊèíÂÖ•Ê¨°Êï∞
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // Ëé∑Âèñuid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip ÊµèËßàÂô®Êó†Ê≥ïËé∑Âèñ
        // time ÊúçÂä°Á´ØÂ∑≤ÁªèËÆ∞ÂΩï
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO ÂæÖ‰ºòÂåñÔºöÊ≠§Â§ÑÊÄßËÉΩËæÉÂ∑ÆÔºåÂèØËÉΩ
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // Âà§Êñ≠ÊòØÂê¶Âú®ÊñáÁ´†È°µ
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // Â¢ûÂä†ÊñáÁ´†ËÆøÈóÆÊ¨°Êï∞
                addCount(Counter);
            }
            // ËÆ∞ÂΩïËÆøÈóÆÊó•Âøó
            addVisitLog();
            // ËÆ°ÁÆóÂ§öÂ∞ë‰∫∫ËÆøÈóÆ
            countVisitLog();
        }, 1000);
    });
</script>
