<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="üôÇüôÇüôÇÂÖ≥Ê≥®**ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºö„ÄêËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã„Äë**ÊúâÁ¶èÂà©Ôºö  RocketMQ / MyCAT / Sharding-JDBC ÊâÄÊúâÊ∫êÁ†ÅÂàÜÊûêÊñáÁ´†ÂàóË°® RocketMQ / MyCAT / Sharding-JDBC ‰∏≠ÊñáÊ≥®ÈáäÊ∫êÁ†Å GitHub Âú∞ÂùÄ ÊÇ®ÂØπ‰∫éÊ∫êÁ†ÅÁöÑÁñëÈóÆÊØèÊù°ÁïôË®ÄÈÉΩÂ∞ÜÂæóÂà∞ËÆ§ÁúüÂõûÂ§ç„ÄÇÁîöËá≥‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËØªÊ∫êÁ†Å‰πüÂèØ‰ª•ËØ∑ÊïôÂô¢„ÄÇ Êñ∞ÁöÑÊ∫êÁ†ÅËß£ÊûêÊñáÁ´†ÂÆûÊó∂Êî∂Âà∞ÈÄöÁü•„ÄÇÊØèÂë®Êõ¥Êñ∞‰∏ÄÁØáÂ∑¶Âè≥„ÄÇ ËÆ§ÁúüÁöÑÊ∫êÁ†Å‰∫§ÊµÅ">
<meta name="keywords" content="Java,Êû∂ÊûÑ,ÂêéÁ´Ø,ÊúçÂä°Á´Ø,RocketMQ,MyCAT,ÂàÜÂ∏ÉÂºèÊ∂àÊÅØÈòüÂàó,ÂàÜÂ∏ÉÂºèÂ≠òÂÇ®,ÊäÄÊúØÂçöÂÆ¢">
<meta property="og:type" content="article">
<meta property="og:title" content="Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô">
<meta property="og:url" content="http://www.yunai.me/Sharding-JDBC/sql-rewrite/index.html">
<meta property="og:site_name" content="ËäãËâøVÁöÑÂçöÂÆ¢">
<meta property="og:description" content="üôÇüôÇüôÇÂÖ≥Ê≥®**ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºö„ÄêËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã„Äë**ÊúâÁ¶èÂà©Ôºö  RocketMQ / MyCAT / Sharding-JDBC ÊâÄÊúâÊ∫êÁ†ÅÂàÜÊûêÊñáÁ´†ÂàóË°® RocketMQ / MyCAT / Sharding-JDBC ‰∏≠ÊñáÊ≥®ÈáäÊ∫êÁ†Å GitHub Âú∞ÂùÄ ÊÇ®ÂØπ‰∫éÊ∫êÁ†ÅÁöÑÁñëÈóÆÊØèÊù°ÁïôË®ÄÈÉΩÂ∞ÜÂæóÂà∞ËÆ§ÁúüÂõûÂ§ç„ÄÇÁîöËá≥‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËØªÊ∫êÁ†Å‰πüÂèØ‰ª•ËØ∑ÊïôÂô¢„ÄÇ Êñ∞ÁöÑÊ∫êÁ†ÅËß£ÊûêÊñáÁ´†ÂÆûÊó∂Êî∂Âà∞ÈÄöÁü•„ÄÇÊØèÂë®Êõ¥Êñ∞‰∏ÄÁØáÂ∑¶Âè≥„ÄÇ ËÆ§ÁúüÁöÑÊ∫êÁ†Å‰∫§ÊµÅ">
<meta property="og:image" content="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/01.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/02.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/03.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/04.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/05.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/06.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/07.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/08.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/09.png">
<meta property="og:image" content="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/10.png">
<meta property="og:image" content="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">
<meta property="og:updated_time" content="2017-08-03T13:12:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô">
<meta name="twitter:description" content="üôÇüôÇüôÇÂÖ≥Ê≥®**ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºö„ÄêËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã„Äë**ÊúâÁ¶èÂà©Ôºö  RocketMQ / MyCAT / Sharding-JDBC ÊâÄÊúâÊ∫êÁ†ÅÂàÜÊûêÊñáÁ´†ÂàóË°® RocketMQ / MyCAT / Sharding-JDBC ‰∏≠ÊñáÊ≥®ÈáäÊ∫êÁ†Å GitHub Âú∞ÂùÄ ÊÇ®ÂØπ‰∫éÊ∫êÁ†ÅÁöÑÁñëÈóÆÊØèÊù°ÁïôË®ÄÈÉΩÂ∞ÜÂæóÂà∞ËÆ§ÁúüÂõûÂ§ç„ÄÇÁîöËá≥‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËØªÊ∫êÁ†Å‰πüÂèØ‰ª•ËØ∑ÊïôÂô¢„ÄÇ Êñ∞ÁöÑÊ∫êÁ†ÅËß£ÊûêÊñáÁ´†ÂÆûÊó∂Êî∂Âà∞ÈÄöÁü•„ÄÇÊØèÂë®Êõ¥Êñ∞‰∏ÄÁØáÂ∑¶Âè≥„ÄÇ ËÆ§ÁúüÁöÑÊ∫êÁ†Å‰∫§ÊµÅ">
<meta name="twitter:image" content="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,Êû∂ÊûÑ,ÂêéÁ´Ø,ÊúçÂä°Á´Ø,RocketMQ,MyCAT,ÂàÜÂ∏ÉÂºèÊ∂àÊÅØÈòüÂàó,ÂàÜÂ∏ÉÂºèÂ≠òÂÇ®,ÊäÄÊúØÂçöÂÆ¢">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- ÁôæÂ∫¶ÁªüËÆ° -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- ÁôæÂ∫¶Á´ôÈïø-Ë¢´Âä®Êé®ÈÄÅ -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360ÊêúÁ¥¢-Ëá™Âä®Êî∂ÂΩï -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/Sharding-JDBC/distributed-id/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$(" #i-prev").toggle();"="" onmouseout="$("></i></a></li>
        
        
        <li><a class="icon" href="/Sharding-JDBC/sql-route-3/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/Sharding-JDBC/sql-rewrite/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&text=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&is_video=false&description=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô&body=Check out this article: http://www.yunai.me/Sharding-JDBC/sql-rewrite/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&name=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. Ê¶ÇËø∞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. SQLToken</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3.SQL ÊîπÂÜô</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 TableToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ItemsToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 OffsetToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 RowCountToken</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 ÂàÜÈ°µË°•ÂÖÖ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 OrderByToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 GeneratedKeyToken</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">4. SQL ÁîüÊàê</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">666. ÂΩ©Ëõã</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">ËäãËâøVÁöÑÂçöÂÆ¢</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-08-09T16:00:00.000Z" itemprop="datePublished">2017-08-10</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<blockquote>
<p>üôÇüôÇüôÇÂÖ≥Ê≥®**ÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºö„ÄêËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã„Äë**ÊúâÁ¶èÂà©Ôºö</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>ÊâÄÊúâ</strong>Ê∫êÁ†ÅÂàÜÊûêÊñáÁ´†ÂàóË°®</li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>‰∏≠ÊñáÊ≥®ÈáäÊ∫êÁ†Å GitHub Âú∞ÂùÄ</strong></li>
<li>ÊÇ®ÂØπ‰∫éÊ∫êÁ†ÅÁöÑÁñëÈóÆÊØèÊù°ÁïôË®Ä<strong>ÈÉΩ</strong>Â∞ÜÂæóÂà∞<strong>ËÆ§Áúü</strong>ÂõûÂ§ç„ÄÇ<strong>ÁîöËá≥‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËØªÊ∫êÁ†Å‰πüÂèØ‰ª•ËØ∑ÊïôÂô¢</strong>„ÄÇ</li>
<li><strong>Êñ∞ÁöÑ</strong>Ê∫êÁ†ÅËß£ÊûêÊñáÁ´†<strong>ÂÆûÊó∂</strong>Êî∂Âà∞ÈÄöÁü•„ÄÇ<strong>ÊØèÂë®Êõ¥Êñ∞‰∏ÄÁØáÂ∑¶Âè≥</strong>„ÄÇ</li>
<li><strong>ËÆ§ÁúüÁöÑ</strong>Ê∫êÁ†Å‰∫§ÊµÅÂæÆ‰ø°Áæ§„ÄÇ</li>
</ol>
</blockquote>
<hr>
<ul>
<li><a href="#">1. Ê¶ÇËø∞</a></li>
<li><a href="#">2. SQLToken</a></li>
<li><a href="#">3.SQL ÊîπÂÜô</a>
<ul>
<li><a href="#">3.1 TableToken</a></li>
<li><a href="#">3.2 ItemsToken</a></li>
<li><a href="#">3.3 OffsetToken</a></li>
<li><a href="#">3.4 RowCountToken</a>
<ul>
<li><a href="#">3.4.1 ÂàÜÈ°µË°•ÂÖÖ</a></li>
</ul>
</li>
<li><a href="#">3.5 OrderByToken</a></li>
<li><a href="#">3.6 GeneratedKeyToken</a></li>
</ul>
</li>
<li><a href="#">4. SQL ÁîüÊàê</a></li>
<li><a href="#">666. ÂΩ©Ëõã</a></li>
</ul>
<hr>
<h1>1. Ê¶ÇËø∞</h1>
<p>ÂâçÁΩÆÈòÖËØªÔºö<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-3/?mp">„ÄäSQL Ëß£ÊûêÔºà‰∏âÔºâ‰πãÊü•ËØ¢SQL„Äã</a></p>
<p>Êú¨ÊñáÂàÜ‰∫´<strong>SQL ÊîπÂÜô</strong>ÁöÑÊ∫êÁ†ÅÂÆûÁé∞„ÄÇ‰∏ªË¶ÅÊ∂âÂèä‰∏§ÊñπÈù¢Ôºö</p>
<ol>
<li>SQL ÊîπÂÜôÔºöÊîπÂÜô SQLÔºåËß£ÂÜ≥ÂàÜÂ∫ìÂàÜË°®ÂêéÔºåÊü•ËØ¢ÁªìÊûúÈúÄË¶ÅËÅöÂêàÔºåÈúÄË¶ÅÂØπ SQL ËøõË°åË∞ÉÊï¥Ôºå‰æãÂ¶ÇÂàÜÈ°µ</li>
<li>SQL ÁîüÊàêÔºöÁîüÊàêÂàÜË°®ÂàÜÂ∫ìÁöÑÊâßË°å SQL</li>
</ol>
<p>SQLRewriteEngineÔºåSQLÈáçÂÜôÂºïÊìéÔºåÂÆûÁé∞ SQL ÊîπÂÜô„ÄÅÁîüÊàêÂäüËÉΩ„ÄÇ‰ªé Sharding-JDBC 1.5.0 ÁâàÊú¨ÔºåSQL ÊîπÂÜôËøõË°å‰∫ÜË∞ÉÊï¥ÂíåÂ§ßÈáè‰ºòÂåñ„ÄÇ</p>
<blockquote>
<p>1.4.xÂèä‰πãÂâçÁâàÊú¨ÔºåSQLÊîπÂÜôÊòØÂú®SQLË∑ØÁî±‰πãÂâçÂÆåÊàêÁöÑÔºåÂú®1.5.x‰∏≠Ë∞ÉÊï¥‰∏∫SQLË∑ØÁî±‰πãÂêéÔºåÂõ†‰∏∫SQLÊîπÂÜôÂèØ‰ª•Ê†πÊçÆË∑ØÁî±Ëá≥ÂçïÂ∫ìË°®ËøòÊòØÂ§öÂ∫ìË°®ËÄåËøõË°åËøõ‰∏ÄÊ≠•‰ºòÂåñ„ÄÇ</p>
</blockquote>
<p>üòÜ ÂæàÂ§öÂêåÂ≠¶ÁúãÂÆå<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">„ÄäSQL Ëß£Êûê-Á≥ªÂàó„Äã</a> ÂèØËÉΩÊòØ‰∏ÄËÑ∏ÊáµÈÄºÔºåÁâπÂà´ÂØπ**‚ÄúSQL ÂçäÁêÜËß£‚Äù**„ÄÇ<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/01.png" alt="">Â∏åÊúõÊú¨ÊñáËÉΩÁªô‰Ω†‰∏Ä‰∫õÂêØÂèë„ÄÇ</p>
<blockquote>
<p><strong>Sharding-JDBC Ê≠£Âú®Êî∂ÈõÜ‰ΩøÁî®ÂÖ¨Âè∏ÂêçÂçïÔºö<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">‰º†ÈÄÅÈó®</a>„ÄÇ<br>
üôÇ ‰Ω†ÁöÑÁôªËÆ∞Ôºå‰ºöËÆ©Êõ¥Â§ö‰∫∫ÂèÇ‰∏éÂíå‰ΩøÁî® Sharding-JDBC„ÄÇ<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">‰º†ÈÄÅÈó®</a><br>
Sharding-JDBC ‰πü‰ºöÂõ†Ê≠§ÔºåËÉΩÂ§üË¶ÜÁõñÊõ¥Â§öÁöÑ‰∏öÂä°Âú∫ÊôØ„ÄÇ<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">‰º†ÈÄÅÈó®</a><br>
ÁôªËÆ∞ÂêßÔºåÈ™öÂπ¥ÔºÅ<a href="https://github.com/dangdangdotcom/sharding-jdbc/issues/234" rel="external nofollow noopener noreferrer" target="_blank">‰º†ÈÄÅÈó®</a></strong></p>
</blockquote>
<h1>2. SQLToken</h1>
<p>üòÅ SQLToken Âú®Êú¨Êñá‰∏≠ÂæàÈáçË¶ÅÔºåÊâÄ‰ª•Âç≥‰ΩøÂú®<a href="http://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">„ÄäSQL Ëß£Êûê-Á≥ªÂàó„Äã</a>Â∑≤ÁªèÂàÜ‰∫´ËøáÔºåÊàë‰ª¨‰πüÊç¢‰∏™ÂßøÂäøÔºåÂÜçÊù•‰∏ÄÊ¨°„ÄÇ</p>
<p>SQLTokenÔºåSQLÊ†áËÆ∞ÂØπË±°<strong>Êé•Âè£</strong>„ÄÇSQLRewriteEngine Âü∫‰∫é SQLToken ÂÆûÁé∞ <strong>SQLÊîπÂÜô</strong>„ÄÇSQLËß£ÊûêÂô®Âú® SQLËß£ÊûêËøáÁ®ã‰∏≠ÔºåÂæàÈáçË¶ÅÁöÑ‰∏Ä‰∏™ÁõÆÁöÑÊòØ<strong>Ê†áËÆ∞ÈúÄË¶ÅSQLÊîπÂÜôÁöÑÈÉ®ÂàÜ</strong>Ôºå‰πüÂ∞±ÊòØ SQLToken„ÄÇ</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/02.png" alt=""></p>
<p><strong>ÂêÑ SQLToken ÁîüÊàêÊù°‰ª∂Â¶Ç‰∏ã</strong>(<em>ÊÇ≤‰º§ÔºåÂÅöÊàêË°®Ê†ºÂΩ¢ÂºèÊéíÁâàÊòØ‰π±ÁöÑ</em>)Ôºö</p>
<ol>
<li>GeneratedKeyToken Ëá™Â¢û‰∏ªÈîÆÊ†áËÆ∞ÂØπË±°
<ul>
<li>ÊèíÂÖ•SQLËá™Â¢ûÂàó‰∏çÂ≠òÂú®Ôºö<code>INSERT INTO t_order(nickname) VALUES ...</code> ‰∏≠Ê≤°ÊúâËá™Â¢ûÂàó <code>order_id</code></li>
</ul>
</li>
<li>TableToken Ë°®Ê†áËÆ∞ÂØπË±°
<ul>
<li>Êü•ËØ¢ÂàóÁöÑË°®Âà´ÂêçÔºö<code>SELECT o.order_id</code> ÁöÑ <code>o</code></li>
<li>Êü•ËØ¢ÁöÑË°®ÂêçÔºö<code>SELECT * FROM t_order</code> ÁöÑ <code>t_order</code></li>
</ul>
</li>
<li>ItemsToken ÈÄâÊã©È°πÊ†áËÆ∞ÂØπË±°
<ul>
<li>AVGÊü•ËØ¢ÂàóÔºö<code>SELECT AVG(price) FROM t_order</code> ÁöÑ <code>AVG(price)</code></li>
<li>ORDER BY Â≠óÊÆµ‰∏çÂú®Êü•ËØ¢ÂàóÔºö<code>SELECT order_id FROM t_order ORDER BY create_time</code> ÁöÑ <code>create_time</code></li>
<li>GROUP BY Â≠óÊÆµ‰∏çÂú®Êü•ËØ¢ÂàóÔºö<code>SELECT COUNT(order_id) FROM t_order GROUP BY user_id</code> ÁöÑ <code>user_id</code></li>
<li>Ëá™Â¢û‰∏ªÈîÆÊú™Âú®ÊèíÂÖ•Âàó‰∏≠Ôºö<code>INSERT INTO t_order(nickname) VALUES ...</code> ‰∏≠Ê≤°ÊúâËá™Â¢ûÂàó <code>order_id</code></li>
</ul>
</li>
<li>OffsetToken ÂàÜÈ°µÂÅèÁßªÈáèÊ†áËÆ∞ÂØπË±°
<ul>
<li>ÂàÜÈ°µÊúâÂÅèÁßªÈáèÔºå‰ΩÜ<strong>‰∏çÊòØ</strong>Âç†‰ΩçÁ¨¶ <code>?</code></li>
</ul>
</li>
<li>RowCountToken ÂàÜÈ°µÈïøÂ∫¶Ê†áËÆ∞ÂØπË±°
<ul>
<li>ÂàÜÈ°µÊúâÈïøÂ∫¶Ôºå‰ΩÜ<strong>‰∏çÊòØ</strong>Âç†‰ΩçÁ¨¶ <code>?</code></li>
</ul>
</li>
<li>OrderByToken ÊéíÂ∫èÊ†áËÆ∞ÂØπË±°
<ul>
<li>Êúâ GROUP BY Êù°‰ª∂ÔºåÊó† ORDER BY Êù°‰ª∂Ôºö<code>SELECT COUNT(*) FROM t_order GROUP BY order_id</code> ÁöÑ <code>order_id</code></li>
</ul>
</li>
</ol>
<h1>3.SQL ÊîπÂÜô</h1>
<p><code>SQLRewriteEngine#rewrite()</code> ÂÆûÁé∞‰∫Ü <strong>SQLÊîπÂÜô</strong> ÂäüËÉΩ„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* SQLÊîπÂÜô.</div><div class="line">* <span class="doctag">@param</span> isRewriteLimit ÊòØÂê¶ÈáçÂÜôLimit</div><div class="line">* <span class="doctag">@return</span> SQLÊûÑÂª∫Âô®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> SQLBuilder <span class="title">rewrite</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isRewriteLimit)</span> </span>&#123;</div><div class="line">   SQLBuilder result = <span class="keyword">new</span> SQLBuilder();</div><div class="line">   <span class="keyword">if</span> (sqlTokens.isEmpty()) &#123;</div><div class="line">       result.appendLiterals(originalSQL);</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">   <span class="comment">// ÊéíÂ∫èSQLTokenÔºåÊåâÁÖß beginPosition ÈÄíÂ¢û</span></div><div class="line">   sortByBeginPosition();</div><div class="line">   <span class="keyword">for</span> (SQLToken each : sqlTokens) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="number">0</span> == count) &#123; <span class="comment">// ÊãºÊé•Á¨¨‰∏Ä‰∏™ SQLToken ÂâçÁöÑÂ≠óÁ¨¶‰∏≤</span></div><div class="line">           result.appendLiterals(originalSQL.substring(<span class="number">0</span>, each.getBeginPosition()));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">// ÊãºÊé•ÊØè‰∏™SQLToken</span></div><div class="line">       <span class="keyword">if</span> (each <span class="keyword">instanceof</span> TableToken) &#123;</div><div class="line">           appendTableToken(result, (TableToken) each, count, sqlTokens);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> ItemsToken) &#123;</div><div class="line">           appendItemsToken(result, (ItemsToken) each, count, sqlTokens);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> RowCountToken) &#123;</div><div class="line">           appendLimitRowCount(result, (RowCountToken) each, count, sqlTokens, isRewriteLimit);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> OffsetToken) &#123;</div><div class="line">           appendLimitOffsetToken(result, (OffsetToken) each, count, sqlTokens, isRewriteLimit);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (each <span class="keyword">instanceof</span> OrderByToken) &#123;</div><div class="line">           appendOrderByToken(result);</div><div class="line">       &#125;</div><div class="line">       count++;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>SQLÊîπÂÜô‰ª• SQLToken ‰∏∫<strong>Èó¥Èöî</strong>Ôºå<strong>È°∫Â∫è</strong>ÊîπÂÜô„ÄÇ
<ul>
<li>È°∫Â∫èÔºöË∞ÉÁî® <code>#sortByBeginPosition()</code> Â∞Ü SQLToken ÊåâÁÖß <code>beginPosition</code> <strong>ÂçáÂ∫è</strong>„ÄÇ</li>
<li>Èó¥ÈöîÔºöÈÅçÂéÜ SQLTokenÔºåÈÄê‰∏™ÊãºÊé•„ÄÇ</li>
</ul>
</li>
</ul>
<p>‰æãÂ¶ÇÔºö
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/03.png" alt=""></p>
<hr>
<p>SQLBuilderÔºåSQLÊûÑÂª∫Âô®„ÄÇ‰∏ãÊñá‰ºöÂ§ßÈáèÁî®Âà∞ÔºåÊàë‰ª¨Áúã‰∏ãÂÆûÁé∞‰ª£Á†Å„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SQLBuilder</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÊÆµÈõÜÂêà</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; segments;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ÂΩìÂâçÊÆµ</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> StringBuilder currentSegment;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SQLBuilder</span><span class="params">()</span> </span>&#123;</div><div class="line">        segments = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">        currentSegment = <span class="keyword">new</span> StringBuilder();</div><div class="line">        segments.add(currentSegment);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ËøΩÂä†Â≠óÈù¢Èáè.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> literals Â≠óÈù¢Èáè</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendLiterals</span><span class="params">(<span class="keyword">final</span> String literals)</span> </span>&#123;</div><div class="line">        currentSegment.append(literals);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ËøΩÂä†Ë°®Âç†‰ΩçÁ¨¶.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> tableName Ë°®ÂêçÁß∞</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendTable</span><span class="params">(<span class="keyword">final</span> String tableName)</span> </span>&#123;</div><div class="line">        <span class="comment">// Ê∑ªÂä† TableToken</span></div><div class="line">        segments.add(<span class="keyword">new</span> TableToken(tableName));</div><div class="line">        <span class="comment">// Êñ∞Âª∫ÂΩìÂâçÊÆµ</span></div><div class="line">        currentSegment = <span class="keyword">new</span> StringBuilder();</div><div class="line">        segments.add(currentSegment);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toSQL</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; tableTokens)</span> </span>&#123;</div><div class="line">        <span class="comment">// ... ÁúÅÁï•‰ª£Á†ÅÔºå„ÄêSQLÁîüÊàê„ÄëÂ§ÑÂàÜ‰∫´</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@RequiredArgsConstructor</span></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">TableToken</span> </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * Ë°®Âêç</div><div class="line">         */</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String tableName;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>Áé∞Âú®Êàë‰ª¨Êù•ÈÄê‰∏™ÂàÜÊûêÊØèÁßç SQLToken ÁöÑ<strong>ÊãºÊé•</strong>ÂÆûÁé∞„ÄÇ</p>
<h2>3.1 TableToken</h2>
<p>Ë∞ÉÁî® <code>#appendTableToken()</code> ÊñπÊ≥ïÊãºÊé•„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ÊãºÊé• TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLÊûÑÂª∫Âô®</div><div class="line">* <span class="doctag">@param</span> tableToken tableToken</div><div class="line">* <span class="doctag">@param</span> count tableToken Âú® sqlTokens ÁöÑÈ°∫Â∫è</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendTableToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> TableToken tableToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens)</span> </span>&#123;</div><div class="line">   <span class="comment">// ÊãºÊé• TableToken</span></div><div class="line">   String tableName = sqlStatement.getTables().getTableNames().contains(tableToken.getTableName()) ? tableToken.getTableName() : tableToken.getOriginalLiterals();</div><div class="line">   sqlBuilder.appendTable(tableName);</div><div class="line">   <span class="comment">// ÊãºÊé• SQLToken ÂêéÈù¢ÁöÑÂ≠óÁ¨¶‰∏≤</span></div><div class="line">   <span class="keyword">int</span> beginPosition = tableToken.getBeginPosition() + tableToken.getOriginalLiterals().length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>Ë∞ÉÁî® <code>SQLBuilder#appendTable()</code> ÊãºÊé• TableToken„ÄÇ</li>
<li><code>sqlStatement.getTables().getTableNames().contains(tableToken.getTableName())</code> ÁõÆÁöÑÊòØÂ§ÑÁêÜÊéâ<strong>Ë°®ÂêçÂâçÂêéÊúâÁöÑÁâπÊÆäÂ≠óÁ¨¶</strong>Ôºå‰æãÂ¶Ç<code>SELECT * FROM 't_order'</code> ‰∏≠ <code>t_order</code> ÂâçÂêéÊúâ <code>'</code> Á¨¶Âè∑„ÄÇ</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// TableToken.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* Ëé∑ÂèñË°®ÂêçÁß∞.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getTableName</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> SQLUtil.getExactlyValue(originalLiterals);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SQLUtil.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getExactlyValue</span><span class="params">(<span class="keyword">final</span> String value)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">null</span> == value ? <span class="keyword">null</span> : CharMatcher.anyOf(<span class="string">"[]`'\""</span>).removeFrom(value);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ÂΩì SQL ‰∏∫ <code>SELECT o.* FROM t_order o</code>
<ul>
<li>TableToken ‰∏∫Êü•ËØ¢ÂàóÂâçÁöÑË°®Âà´Âêç <code>o</code> Êó∂ËøîÂõûÁªìÊûúÔºö
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/04.png" alt=""></li>
<li>TableToken ‰∏∫Ë°®Âêç <code>t_order</code> Êó∂ËøîÂõûÁªìÊûúÔºö
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/05.png" alt=""></li>
</ul>
</li>
</ul>
<h2>3.2 ItemsToken</h2>
<p>Ë∞ÉÁî® <code>#appendItemsToken()</code> ÊñπÊ≥ïÊãºÊé•„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ÊãºÊé• TableToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLÊûÑÂª∫Âô®</div><div class="line">* <span class="doctag">@param</span> itemsToken itemsToken</div><div class="line">* <span class="doctag">@param</span> count itemsToken Âú® sqlTokens ÁöÑÈ°∫Â∫è</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendItemsToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> ItemsToken itemsToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens)</span> </span>&#123;</div><div class="line">   <span class="comment">// ÊãºÊé• ItemsToken</span></div><div class="line">   <span class="keyword">for</span> (String item : itemsToken.getItems()) &#123;</div><div class="line">       sqlBuilder.appendLiterals(<span class="string">", "</span>);</div><div class="line">       sqlBuilder.appendLiterals(item);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQLToken ÂêéÈù¢ÁöÑÂ≠óÁ¨¶‰∏≤</span></div><div class="line">   <span class="keyword">int</span> beginPosition = itemsToken.getBeginPosition();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>Á¨¨‰∏ÄÁßçÊÉÖÂÜµÔºå<strong>AVGÊü•ËØ¢Âàó</strong>ÔºåSQL ‰∏∫ <code>SELECT AVG(order_id) FROM t_order o</code> Êó∂ËøîÂõûÁªìÊûúÔºö
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/06.png" alt=""></li>
<li>Á¨¨‰∫åÁßçÊÉÖÂÜµÔºå<strong>ORDER BY Â≠óÊÆµ‰∏çÂú®Êü•ËØ¢Âàó</strong>ÔºåSQL ‰∏∫ <code>SELECT userId FROM t_order o ORDER BY order_id</code> Êó∂ËøîÂõûÁªìÊûúÔºö
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/07.png" alt=""></li>
<li>Á¨¨‰∏âÁßçÊÉÖÂÜµÔºå<strong>GROUP BY Â≠óÊÆµ‰∏çÂú®Êü•ËØ¢Âàó</strong>ÔºåÁ±ª‰ººÁ¨¨‰∫åÁßçÊÉÖÂÜµÔºåÂ∞±‰∏ç‰∏æ‰æãÂ≠êÂàó„ÄÇ</li>
</ul>
<h2>3.3 OffsetToken</h2>
<p>Ë∞ÉÁî® <code>#appendLimitOffsetToken()</code> ÊñπÊ≥ïÊãºÊé•„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ÊãºÊé• OffsetToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLÊûÑÂª∫Âô®</div><div class="line">* <span class="doctag">@param</span> offsetToken offsetToken</div><div class="line">* <span class="doctag">@param</span> count offsetToken Âú® sqlTokens ÁöÑÈ°∫Â∫è</div><div class="line">* <span class="doctag">@param</span> sqlTokens sqlTokens</div><div class="line">* <span class="doctag">@param</span> isRewrite ÊòØÂê¶ÈáçÂÜô„ÄÇÂΩìË∑ØÁî±ÁªìÊûú‰∏∫ÂçïÂàÜÁâáÊó∂Êó†ÈúÄÈáçÂÜô</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendLimitOffsetToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> OffsetToken offsetToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite)</span> </span>&#123;</div><div class="line">   <span class="comment">// ÊãºÊé• OffsetToken</span></div><div class="line">   sqlBuilder.appendLiterals(isRewrite ? <span class="string">"0"</span> : String.valueOf(offsetToken.getOffset()));</div><div class="line">   <span class="comment">// SQLToken ÂêéÈù¢ÁöÑÂ≠óÁ¨¶‰∏≤</span></div><div class="line">   <span class="keyword">int</span> beginPosition = offsetToken.getBeginPosition() + String.valueOf(offsetToken.getOffset()).length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ÂΩìÂàÜÈ°µ<strong>Ë∑®ÂàÜÁâá</strong>Êó∂ÔºåÈúÄË¶ÅÊØè‰∏™ÂàÜÁâáÈÉΩÊü•ËØ¢ÂêéÂú®<strong>ÂÜÖÂ≠ò</strong>‰∏≠ËøõË°åËÅöÂêà„ÄÇÊ≠§Êó∂ <code>isRewrite = true</code>„ÄÇ‰∏∫‰ªÄ‰πàÊòØ <code>&quot;0&quot;</code> ÂºÄÂßãÂë¢ÔºüÊØè‰∏™ÂàÜÁâáÂú® [0, offset) ÁöÑËÆ∞ÂΩï<strong>ÂèØËÉΩ</strong>Â±û‰∫éÂÆûÈôÖÂàÜÈ°µÁªìÊûúÔºåÂõ†ËÄåÊü•ËØ¢ÊØè‰∏™ÂàÜÁâáÈúÄË¶Å‰ªé 0 ÂºÄÂßã„ÄÇ</li>
<li>ÂΩìÂàÜÈ°µ<strong>ÂçïÂàÜÁâá</strong>Êó∂ÔºåÂàôÊó†ÈúÄÈáçÂÜôÔºåËØ•ÂàÜÁâáÊâßË°åÁöÑÁªìÊûúÂç≥ÊòØÊúÄÁªàÁªìÊûú„ÄÇ<strong>SQLÊîπÂÜôÂú®SQLË∑ØÁî±‰πãÂêéÂ∞±ÊúâËøô‰∏™Â•ΩÂ§Ñ</strong>„ÄÇÂ¶ÇÊûúÂÖàÊîπÂÜôÔºåÂõ†‰∏∫Ê≤°ÂäûÊ≥ïÁü•ÈÅìÊúÄÁªàÊòØÂçïÂàÜÁâáËøòÊòØË∑®ÂàÜÁâáÔºåËÄÉËôëÊ≠£Á°ÆÊÄßÔºåÂè™ËÉΩÁªü‰∏Ä‰ΩøÁî®Ë∑®ÂàÜÁâá„ÄÇ</li>
</ul>
<h2>3.4 RowCountToken</h2>
<p>Ë∞ÉÁî® <code>#appendLimitRowCount()</code> ÊñπÊ≥ïÊãºÊé•„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendLimitRowCount</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder, <span class="keyword">final</span> RowCountToken rowCountToken, <span class="keyword">final</span> <span class="keyword">int</span> count, <span class="keyword">final</span> List&lt;SQLToken&gt; sqlTokens, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite)</span> </span>&#123;</div><div class="line">   SelectStatement selectStatement = (SelectStatement) sqlStatement;</div><div class="line">   Limit limit = selectStatement.getLimit();</div><div class="line">   <span class="keyword">if</span> (!isRewrite) &#123; <span class="comment">// Ë∑ØÁî±ÁªìÊûú‰∏∫ÂçïÂàÜÁâá</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(rowCountToken.getRowCount()));</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!selectStatement.getGroupByItems().isEmpty() || <span class="comment">// [1.1] Ë∑®ÂàÜÁâáÂàÜÁªÑÈúÄË¶ÅÂú®ÂÜÖÂ≠òËÆ°ÁÆóÔºåÂèØËÉΩÈúÄË¶ÅÂÖ®ÈÉ®Âä†ËΩΩ</span></div><div class="line">           !selectStatement.getAggregationSelectItems().isEmpty()) <span class="comment">// [1.2] Ë∑®ÂàÜÁâáËÅöÂêàÂàóÈúÄË¶ÅÂú®ÂÜÖÂ≠òËÆ°ÁÆóÔºåÂèØËÉΩÈúÄË¶ÅÂÖ®ÈÉ®Âä†ËΩΩ</span></div><div class="line">           &amp;&amp; !selectStatement.isSameGroupByAndOrderByItems()) &#123; <span class="comment">// [2] Â¶ÇÊûúÊéíÂ∫è‰∏ÄËá¥ÔºåÂç≥ÂêÑÂàÜÁâáÂ∑≤ÁªèÊéíÂ∫èÂ•ΩÁªìÊûúÔºåÂ∞±‰∏çÈúÄË¶ÅÂÖ®ÈÉ®Âä†ËΩΩ</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(Integer.MAX_VALUE));</div><div class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// Ë∑ØÁî±ÁªìÊûú‰∏∫Â§öÂàÜÁâá</span></div><div class="line">       sqlBuilder.appendLiterals(String.valueOf(limit.isRowCountRewriteFlag() ? rowCountToken.getRowCount() + limit.getOffsetValue() : rowCountToken.getRowCount()));</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// SQLToken ÂêéÈù¢ÁöÑÂ≠óÁ¨¶‰∏≤</span></div><div class="line">   <span class="keyword">int</span> beginPosition = rowCountToken.getBeginPosition() + String.valueOf(rowCountToken.getRowCount()).length();</div><div class="line">   <span class="keyword">int</span> endPosition = sqlTokens.size() - <span class="number">1</span> == count ? originalSQL.length() : sqlTokens.get(count + <span class="number">1</span>).getBeginPosition();</div><div class="line">   sqlBuilder.appendLiterals(originalSQL.substring(beginPosition, endPosition));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>[1.1] <code>!selectStatement.getGroupByItems().isEmpty()</code> Ë∑®ÂàÜÁâá<strong>ÂàÜÁªÑ</strong>ÈúÄË¶ÅÂú®ÂÜÖÂ≠òËÆ°ÁÆóÔºå<strong>ÂèØËÉΩ</strong>ÈúÄË¶ÅÂÖ®ÈÉ®Âä†ËΩΩ„ÄÇÂ¶ÇÊûú‰∏çÂÖ®ÈÉ®Âä†ËΩΩÔºåÈÉ®ÂàÜÁªìÊûúË¢´ÂàÜÈ°µÊù°‰ª∂ÈîôËØØÁªìÊûúÔºå‰ºöÂØºËá¥ÁªìÊûú‰∏çÊ≠£Á°Æ„ÄÇ</li>
<li>[1.2] <code>!selectStatement.getAggregationSelectItems().isEmpty())</code> Ë∑®ÂàÜÁâá<strong>ËÅöÂêàÂàó</strong>ÈúÄË¶ÅÂú®ÂÜÖÂ≠òËÆ°ÁÆóÔºå<strong>ÂèØËÉΩ</strong>ÈúÄË¶ÅÂÖ®ÈÉ®Âä†ËΩΩ„ÄÇÂ¶ÇÊûú‰∏çÂÖ®ÈÉ®Âä†ËΩΩÔºåÈÉ®ÂàÜÁªìÊûúË¢´ÂàÜÈ°µÊù°‰ª∂ÈîôËØØÁªìÊûúÔºå‰ºöÂØºËá¥ÁªìÊûú‰∏çÊ≠£Á°Æ„ÄÇ</li>
<li>[1.1][1.2]Ôºå<strong>ÂèØËÉΩ</strong>ÂèòÊàêÂøÖÈ°ªÁöÑÂâçÊèêÊòØ GROUP BY Âíå ORDER BY ÊéíÂ∫è‰∏ç‰∏ÄËá¥„ÄÇÂ¶ÇÊûú‰∏ÄËá¥ÔºåÂêÑÂàÜÁâáÂ∑≤ÁªèÊéíÂ∫èÂÆåÊàêÔºåÊó†ÈúÄÂÜÖÂ≠ò‰∏≠ÊéíÂ∫è„ÄÇ</li>
</ul>
<h3>3.4.1 ÂàÜÈ°µË°•ÂÖÖ</h3>
<p>OffsetToken„ÄÅRowCountToken Âè™ÊúâÂú®ÂàÜÈ°µÂØπÂ∫î‰ΩçÁΩÆÈùûÂç†‰ΩçÁ¨¶ <code>?</code> ÊâçÂ≠òÂú®„ÄÇÂΩìÂØπÂ∫î‰ΩçÁΩÆÊòØÂç†‰ΩçÁ¨¶Êó∂Ôºå‰ºöÂØπ<strong>ÂàÜÈ°µÊù°‰ª∂ÂØπÂ∫îÁöÑÈ¢ÑÁºñËØë SQL Âç†‰ΩçÁ¨¶ÂèÇÊï∞</strong>ËøõË°åÈáçÂÜôÔºå<strong>Êï¥‰ΩìÈÄªËæëÂíå OffsetToken„ÄÅRowCountToken ÊòØ‰∏ÄËá¥ÁöÑ</strong>„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// üëº ParsingSQLRouter#route() Ë∞ÉÁî® #processLimit() </span></div><div class="line"></div><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* Â§ÑÁêÜÂàÜÈ°µÊù°‰ª∂</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> SQLRewriteEngine#appendLimitRowCount(SQLBuilder, RowCountToken, int, List, boolean) </div><div class="line">* <span class="doctag">@param</span> parameters Âç†‰ΩçÁ¨¶ÂØπÂ∫îÂèÇÊï∞ÂàóË°®</div><div class="line">* <span class="doctag">@param</span> selectStatement Select SQLËØ≠Âè•ÂØπË±°</div><div class="line">* <span class="doctag">@param</span> isSingleRouting ÊòØÂê¶ÂçïË°®Ë∑ØÁî±</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processLimit</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SelectStatement selectStatement, <span class="keyword">final</span> <span class="keyword">boolean</span> isSingleRouting)</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> isNeedFetchAll = (!selectStatement.getGroupByItems().isEmpty() <span class="comment">// // [1.1] Ë∑®ÂàÜÁâáÂàÜÁªÑÈúÄË¶ÅÂú®ÂÜÖÂ≠òËÆ°ÁÆóÔºåÂèØËÉΩÈúÄË¶ÅÂÖ®ÈÉ®Âä†ËΩΩ</span></div><div class="line">                               || !selectStatement.getAggregationSelectItems().isEmpty()) <span class="comment">// [1.2] Ë∑®ÂàÜÁâáËÅöÂêàÂàóÈúÄË¶ÅÂú®ÂÜÖÂ≠òËÆ°ÁÆóÔºåÂèØËÉΩÈúÄË¶ÅÂÖ®ÈÉ®Âä†ËΩΩ</span></div><div class="line">                           &amp;&amp; !selectStatement.isSameGroupByAndOrderByItems(); <span class="comment">// [2] Â¶ÇÊûúÊéíÂ∫è‰∏ÄËá¥ÔºåÂç≥ÂêÑÂàÜÁâáÂ∑≤ÁªèÊéíÂ∫èÂ•ΩÁªìÊûúÔºåÂ∞±‰∏çÈúÄË¶ÅÂÖ®ÈÉ®Âä†ËΩΩ</span></div><div class="line">   selectStatement.getLimit().processParameters(parameters, !isSingleRouting, isNeedFetchAll);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Limit.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* Â°´ÂÖÖÊîπÂÜôÂàÜÈ°µÂèÇÊï∞.</div><div class="line">* <span class="doctag">@param</span> parameters ÂèÇÊï∞</div><div class="line">* <span class="doctag">@param</span> isRewrite ÊòØÂê¶ÈáçÂÜôÂèÇÊï∞</div><div class="line">* <span class="doctag">@param</span> isFetchAll ÊòØÂê¶Ëé∑ÂèñÊâÄÊúâÊï∞ÊçÆ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processParameters</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> <span class="keyword">boolean</span> isRewrite, <span class="keyword">final</span> <span class="keyword">boolean</span> isFetchAll)</span> </span>&#123;</div><div class="line">   fill(parameters);</div><div class="line">   <span class="keyword">if</span> (isRewrite) &#123;</div><div class="line">       rewrite(parameters, isFetchAll);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Â∞ÜÂç†‰ΩçÁ¨¶ÂèÇÊï∞ÈáåÊòØÂàÜÈ°µÁöÑÂèÇÊï∞ËµãÂÄºÁªô offset „ÄÅrowCount</div><div class="line">* ËµãÂÄºÁöÑÂâçÊèêÊù°‰ª∂ÊòØ offset„ÄÅrowCount ÊòØ Âç†‰ΩçÁ¨¶</div><div class="line">* <span class="doctag">@param</span> parameters Âç†‰ΩçÁ¨¶ÂèÇÊï∞</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fill</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> offset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="keyword">this</span>.offset) &#123;</div><div class="line">       offset = -<span class="number">1</span> == <span class="keyword">this</span>.offset.getIndex() ? getOffsetValue() : NumberUtil.roundHalfUp(parameters.get(<span class="keyword">this</span>.offset.getIndex()));</div><div class="line">       <span class="keyword">this</span>.offset.setValue(offset);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">int</span> rowCount = <span class="number">0</span>;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != <span class="keyword">this</span>.rowCount) &#123;</div><div class="line">       rowCount = -<span class="number">1</span> == <span class="keyword">this</span>.rowCount.getIndex() ? getRowCountValue() : NumberUtil.roundHalfUp(parameters.get(<span class="keyword">this</span>.rowCount.getIndex()));</div><div class="line">       <span class="keyword">this</span>.rowCount.setValue(rowCount);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || rowCount &lt; <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLParsingException(<span class="string">"LIMIT offset and row count can not be a negative value."</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* ÈáçÂÜôÂàÜÈ°µÊù°‰ª∂ÂØπÂ∫îÁöÑÂèÇÊï∞</div><div class="line">* <span class="doctag">@param</span> parameters ÂèÇÊï∞</div><div class="line">* <span class="doctag">@param</span> isFetchAll ÊòØÂê¶ÊãâÂèñÊâÄÊúâ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rewrite</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> <span class="keyword">boolean</span> isFetchAll)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> rewriteOffset = <span class="number">0</span>;</div><div class="line">   <span class="keyword">int</span> rewriteRowCount;</div><div class="line">   <span class="comment">// ÈáçÂÜô</span></div><div class="line">   <span class="keyword">if</span> (isFetchAll) &#123;</div><div class="line">       rewriteRowCount = Integer.MAX_VALUE;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rowCountRewriteFlag) &#123;</div><div class="line">       rewriteRowCount = <span class="keyword">null</span> == rowCount ? -<span class="number">1</span> : getOffsetValue() + rowCount.getValue();</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       rewriteRowCount = rowCount.getValue();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ÂèÇÊï∞ËÆæÁΩÆ</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != offset &amp;&amp; offset.getIndex() &gt; -<span class="number">1</span>) &#123;</div><div class="line">       parameters.set(offset.getIndex(), rewriteOffset);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != rowCount &amp;&amp; rowCount.getIndex() &gt; -<span class="number">1</span>) &#123;</div><div class="line">       parameters.set(rowCount.getIndex(), rewriteRowCount);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>3.5 OrderByToken</h2>
<p>Ë∞ÉÁî® <code>#appendOrderByToken()</code> ÊñπÊ≥ïÊãºÊé•„ÄÇÊï∞ÊçÆÂ∫ìÈáåÔºåÂΩìÊó† ORDER BYÊù°‰ª∂ ËÄåÊúâ GROUP BY Êù°‰ª∂Êó∂ÂÄôÔºå‰ºö‰ΩøÁî® GROUP BYÊù°‰ª∂Â∞ÜÁªìÊûúÂçáÂ∫èÊéíÂ∫èÔºö</p>
<ul>
<li><code>SELECT order_id FROM t_order GROUP BY order_id</code> Á≠â‰ª∑‰∫é <code>SELECT order_id FROM t_order GROUP BY order_id ORDER BY order_id ASC</code></li>
<li><code>SELECT order_id FROM t_order GROUP BY order_id DESC</code> Á≠â‰ª∑‰∫é <code>SELECT order_id FROM t_order GROUP BY order_id ORDER BY order_id DESC</code></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ÊãºÊé• OrderByToken</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLÊûÑÂª∫Âô®</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendOrderByToken</span><span class="params">(<span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   SelectStatement selectStatement = (SelectStatement) sqlStatement;</div><div class="line">   <span class="comment">// ÊãºÊé• OrderByToken</span></div><div class="line">   StringBuilder orderByLiterals = <span class="keyword">new</span> StringBuilder(<span class="string">" ORDER BY "</span>);</div><div class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">   <span class="keyword">for</span> (OrderItem each : selectStatement.getOrderByItems()) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="number">0</span> == i) &#123;</div><div class="line">           orderByLiterals.append(each.getColumnLabel()).append(<span class="string">" "</span>).append(each.getType().name());</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           orderByLiterals.append(<span class="string">","</span>).append(each.getColumnLabel()).append(<span class="string">" "</span>).append(each.getType().name());</div><div class="line">       &#125;</div><div class="line">       i++;</div><div class="line">   &#125;</div><div class="line">   orderByLiterals.append(<span class="string">" "</span>);</div><div class="line">   sqlBuilder.appendLiterals(orderByLiterals.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>ÂΩì SQL ‰∏∫ <code>SELECT order_id FROM t_order o GROUP BY order_id</code> ËøîÂõûÁªìÊûúÔºö
<img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/08.png" alt=""></li>
</ul>
<h2>3.6 GeneratedKeyToken</h2>
<p>ÂâçÁΩÆÈòÖËØªÔºö<a href="http://www.yunai.me/Sharding-JDBC/sql-parse-4/?mp">„ÄäSQL Ëß£ÊûêÔºàÂõõÔºâ‰πãÊèíÂÖ•SQL„Äã</a></p>
<p>GeneratedKeyTokenÔºåÂíåÂÖ∂ÂÆÉ SQLToken ‰∏çÂêåÔºåÂú® <strong>SQLËß£Êûê</strong> ÂÆåËøõË°åÂ§ÑÁêÜ„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLStatement <span class="title">parse</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   SQLParsingEngine parsingEngine = <span class="keyword">new</span> SQLParsingEngine(databaseType, logicSQL, shardingRule);</div><div class="line">   Context context = MetricsContext.start(<span class="string">"Parse SQL"</span>);</div><div class="line">   SQLStatement result = parsingEngine.parse();</div><div class="line">   <span class="keyword">if</span> (result <span class="keyword">instanceof</span> InsertStatement) &#123; <span class="comment">// Â§ÑÁêÜ GenerateKeyToken</span></div><div class="line">       ((InsertStatement) result).appendGenerateKeyToken(shardingRule, parametersSize);</div><div class="line">   &#125;</div><div class="line">   MetricsContext.stop(context);</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// InsertStatement.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ËøΩÂä†Ëá™Â¢û‰∏ªÈîÆÊ†áËÆ∞ÂØπË±°.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> shardingRule ÂàÜÁâáËßÑÂàô</div><div class="line">* <span class="doctag">@param</span> parametersSize ÂèÇÊï∞‰∏™Êï∞</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="comment">// SQL ÈáåÊúâ‰∏ªÈîÆÂàó</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">null</span> != generatedKey) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// TableRule Â≠òÂú®</span></div><div class="line">   Optional&lt;TableRule&gt; tableRule = shardingRule.tryFindTableRule(getTables().getSingleTableName());</div><div class="line">   <span class="keyword">if</span> (!tableRule.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// GeneratedKeyToken Â≠òÂú®</span></div><div class="line">   Optional&lt;GeneratedKeyToken&gt; generatedKeysToken = findGeneratedKeyToken();</div><div class="line">   <span class="keyword">if</span> (!generatedKeysToken.isPresent()) &#123;</div><div class="line">       <span class="keyword">return</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// Â§ÑÁêÜ GenerateKeyToken</span></div><div class="line">   ItemsToken valuesToken = <span class="keyword">new</span> ItemsToken(generatedKeysToken.get().getBeginPosition());</div><div class="line">   <span class="keyword">if</span> (<span class="number">0</span> == parametersSize) &#123;</div><div class="line">       appendGenerateKeyToken(shardingRule, tableRule.get(), valuesToken);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       appendGenerateKeyToken(shardingRule, tableRule.get(), valuesToken, parametersSize);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ÁßªÈô§ generatedKeysToken</span></div><div class="line">   getSqlTokens().remove(generatedKeysToken.get());</div><div class="line">   <span class="comment">// Êñ∞Â¢û ItemsToken</span></div><div class="line">   getSqlTokens().add(valuesToken);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>Ê†πÊçÆ<strong>Âç†‰ΩçÁ¨¶ÂèÇÊï∞</strong>Êï∞Èáè‰∏çÂêåÔºåË∞ÉÁî®ÁöÑ <code>#appendGenerateKeyToken()</code> ÊòØ<strong>‰∏çÂêå</strong>ÁöÑÔºö</li>
<li><strong>Âç†‰ΩçÁ¨¶ÂèÇÊï∞Êï∞Èáè = 0</strong> Êó∂ÔºåÁõ¥Êé•ÁîüÊàê<strong>ÂàÜÂ∏ÉÂºè‰∏ªÈîÆ</strong>Ôºå‰øùÊåÅÊó†Âç†‰ΩçÁ¨¶ÁöÑÂÅöÊ≥ï„ÄÇ</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// InsertStatement.java</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> ItemsToken valuesToken)</span> </span>&#123;</div><div class="line">   <span class="comment">// ÁîüÊàêÂàÜÂ∏ÉÂºè‰∏ªÈîÆ</span></div><div class="line">   Number generatedKey = shardingRule.generateKey(tableRule.getLogicTable());</div><div class="line">   <span class="comment">// Ê∑ªÂä†Âà∞ ItemsToken</span></div><div class="line">   valuesToken.getItems().add(generatedKey.toString());</div><div class="line">   <span class="comment">// Â¢ûÂä† ConditionÔºåÁî®‰∫éË∑ØÁî±</span></div><div class="line">   getConditions().add(<span class="keyword">new</span> Condition(<span class="keyword">new</span> Column(tableRule.getGenerateKeyColumn(), tableRule.getLogicTable()), <span class="keyword">new</span> SQLNumberExpression(generatedKey)), shardingRule);</div><div class="line">   <span class="comment">// ÁîüÊàê GeneratedKey</span></div><div class="line">   <span class="keyword">this</span>.generatedKey = <span class="keyword">new</span> GeneratedKey(tableRule.getLogicTable(), -<span class="number">1</span>, generatedKey);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>Âç†‰ΩçÁ¨¶ÂèÇÊï∞Êï∞Èáè &gt; 0</strong> Êó∂ÔºåÁîüÊàêËá™Â¢ûÂàóÁöÑÂç†‰ΩçÁ¨¶Ôºå‰øùÊåÅÊúâÂç†‰ΩçÁ¨¶ÁöÑÂÅöÊ≥ï„ÄÇ</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">appendGenerateKeyToken</span><span class="params">(<span class="keyword">final</span> ShardingRule shardingRule, <span class="keyword">final</span> TableRule tableRule, <span class="keyword">final</span> ItemsToken valuesToken, <span class="keyword">final</span> <span class="keyword">int</span> parametersSize)</span> </span>&#123;</div><div class="line">   <span class="comment">// ÁîüÊàêÂç†‰ΩçÁ¨¶</span></div><div class="line">   valuesToken.getItems().add(<span class="string">"?"</span>);</div><div class="line">   <span class="comment">// Â¢ûÂä† ConditionÔºåÁî®‰∫éË∑ØÁî±</span></div><div class="line">   getConditions().add(<span class="keyword">new</span> Condition(<span class="keyword">new</span> Column(tableRule.getGenerateKeyColumn(), tableRule.getLogicTable()), <span class="keyword">new</span> SQLPlaceholderExpression(parametersSize)), shardingRule);</div><div class="line">   <span class="comment">// ÁîüÊàê GeneratedKey</span></div><div class="line">   generatedKey = <span class="keyword">new</span> GeneratedKey(tableRule.getGenerateKeyColumn(), parametersSize, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>Âõ†‰∏∫ GenerateKeyToken Â∑≤ÁªèÂ§ÑÁêÜÂÆåÔºåÊâÄ‰ª•ÁßªÈô§ÔºåÈÅøÂÖç <code>SQLRewriteEngine#rewrite()</code> ‰∫åÊ¨°ÊîπÂÜô„ÄÇÂè¶Â§ñÔºåÈÄöËøá ItemsToken Ë°•ÂÖÖËá™Â¢ûÂàó„ÄÇ</li>
<li>ÁîüÊàê GeneratedKey ‰ºöÂú® ParsingSQLRouter Ëøõ‰∏ÄÊ≠•Â§ÑÁêÜ„ÄÇ</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   <span class="keyword">final</span> Context context = MetricsContext.start(<span class="string">"Route SQL"</span>);</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// Â§ÑÁêÜ ÊèíÂÖ•SQL ‰∏ªÈîÆÂ≠óÊÆµ</span></div><div class="line">   <span class="keyword">if</span> (sqlStatement <span class="keyword">instanceof</span> InsertStatement &amp;&amp; <span class="keyword">null</span> != ((InsertStatement) sqlStatement).getGeneratedKey()) &#123;</div><div class="line">       processGeneratedKey(parameters, (InsertStatement) sqlStatement, result);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// ... ÁúÅÁï•ÈÉ®ÂàÜ‰ª£Á†Å</span></div><div class="line">&#125;  </div><div class="line"><span class="comment">/**</span></div><div class="line">* Â§ÑÁêÜ ÊèíÂÖ•SQL ‰∏ªÈîÆÂ≠óÊÆµ</div><div class="line">* ÂΩì ‰∏ªÈîÆÁºñÂè∑ Êú™ÁîüÊàêÊó∂Ôºå&#123;<span class="doctag">@link</span> ShardingRule#generateKey(String)&#125; ËøõË°åÁîüÊàê</div><div class="line">* <span class="doctag">@param</span> parameters Âç†‰ΩçÁ¨¶ÂèÇÊï∞</div><div class="line">* <span class="doctag">@param</span> insertStatement Insert SQLËØ≠Âè•ÂØπË±°</div><div class="line">* <span class="doctag">@param</span> sqlRouteResult SQLË∑ØÁî±ÁªìÊûú</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processGeneratedKey</span><span class="params">(<span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> InsertStatement insertStatement, <span class="keyword">final</span> SQLRouteResult sqlRouteResult)</span> </span>&#123;</div><div class="line">   GeneratedKey generatedKey = insertStatement.getGeneratedKey();</div><div class="line">   <span class="keyword">if</span> (parameters.isEmpty()) &#123; <span class="comment">// Â∑≤Êúâ‰∏ªÈîÆÔºåÊó†Âç†‰ΩçÁ¨¶ÔºåINSERT INTO t_order(order_id, user_id) VALUES (1, 100);</span></div><div class="line">       sqlRouteResult.getGeneratedKeys().add(generatedKey.getValue());</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameters.size() == generatedKey.getIndex()) &#123; <span class="comment">// ‰∏ªÈîÆÂ≠óÊÆµ‰∏çÂ≠òÂú®Â≠òÂú®ÔºåINSERT INTO t_order(user_id) VALUES(?);</span></div><div class="line">       Number key = shardingRule.generateKey(insertStatement.getTables().getSingleTableName()); <span class="comment">// ÁîüÊàê‰∏ªÈîÆÁºñÂè∑</span></div><div class="line">       parameters.add(key);</div><div class="line">       setGeneratedKeys(sqlRouteResult, key);</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> != generatedKey.getIndex()) &#123; <span class="comment">// ‰∏ªÈîÆÂ≠óÊÆµÂ≠òÂú®ÔºåINSERT INTO t_order(order_id, user_id) VALUES(?, ?);</span></div><div class="line">       setGeneratedKeys(sqlRouteResult, (Number) parameters.get(generatedKey.getIndex()));</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* ËÆæÁΩÆ ‰∏ªÈîÆÁºñÂè∑ Âà∞ SQLË∑ØÁî±ÁªìÊûú</div><div class="line">* <span class="doctag">@param</span> sqlRouteResult SQLË∑ØÁî±ÁªìÊûú</div><div class="line">* <span class="doctag">@param</span> generatedKey ‰∏ªÈîÆÁºñÂè∑</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setGeneratedKeys</span><span class="params">(<span class="keyword">final</span> SQLRouteResult sqlRouteResult, <span class="keyword">final</span> Number generatedKey)</span> </span>&#123;</div><div class="line">   generatedKeys.add(generatedKey);</div><div class="line">   sqlRouteResult.getGeneratedKeys().clear();</div><div class="line">   sqlRouteResult.getGeneratedKeys().addAll(generatedKeys);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>parameters.size() == generatedKey.getIndex()</code> Â§ÑÂØπÂ∫î <code>#appendGenerateKeyToken()</code> ÁöÑ <strong>Âç†‰ΩçÁ¨¶ÂèÇÊï∞Êï∞Èáè &gt; 0</strong> ÊÉÖÂÜµÔºåÊ≠§Êó∂‰ºöÁîüÊàê<strong>ÂàÜÂ∏ÉÂºè‰∏ªÈîÆ</strong>„ÄÇüòà ËØ•Â§ÑÊòØ‰∏çÊòØÂèØ‰ª•ËÄÉËôëÊääÁîüÊàê<strong>ÂàÜÂ∏ÉÂºè‰∏ªÈîÆ</strong>Êå™Âà∞ <code>#appendGenerateKeyToken()</code>ÔºåËøôÊ†∑Êõ¥Âä†Áªü‰∏Ä‰∏Ä‰∫õ„ÄÇ</li>
</ul>
<h1>4. SQL ÁîüÊàê</h1>
<p><strong>SQLË∑ØÁî±</strong>ÂÆåÂêéÔºå‰ºöÁîüÊàêÂêÑÊï∞ÊçÆÂàÜÁâáÁöÑ<strong>ÊâßË°åSQL</strong>„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ParsingSQLRouter.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SQLRouteResult <span class="title">route</span><span class="params">(<span class="keyword">final</span> String logicSQL, <span class="keyword">final</span> List&lt;Object&gt; parameters, <span class="keyword">final</span> SQLStatement sqlStatement)</span> </span>&#123;</div><div class="line">   SQLRouteResult result = <span class="keyword">new</span> SQLRouteResult(sqlStatement);</div><div class="line">   <span class="comment">// ÁúÅÁï•ÈÉ®ÂàÜ‰ª£Á†Å... Â§ÑÁêÜ ÊèíÂÖ•SQL ‰∏ªÈîÆÂ≠óÊÆµ</span></div><div class="line">   </div><div class="line">   <span class="comment">// Ë∑ØÁî±</span></div><div class="line">   RoutingResult routingResult = route(parameters, sqlStatement);</div><div class="line">   </div><div class="line">   <span class="comment">// ÁúÅÁï•ÈÉ®ÂàÜ‰ª£Á†Å... SQLÈáçÂÜôÂºïÊìé</span></div><div class="line">   SQLRewriteEngine rewriteEngine = <span class="keyword">new</span> SQLRewriteEngine(shardingRule, logicSQL, sqlStatement);</div><div class="line">   <span class="keyword">boolean</span> isSingleRouting = routingResult.isSingleRouting();</div><div class="line">   <span class="comment">// ÁúÅÁï•ÈÉ®ÂàÜ‰ª£Á†Å... Â§ÑÁêÜÂàÜÈ°µ</span></div><div class="line">   <span class="comment">// SQL ÈáçÂÜô</span></div><div class="line">   SQLBuilder sqlBuilder = rewriteEngine.rewrite(!isSingleRouting);</div><div class="line">   <span class="comment">// ÁîüÊàê ExecutionUnit</span></div><div class="line">   <span class="keyword">if</span> (routingResult <span class="keyword">instanceof</span> CartesianRoutingResult) &#123;</div><div class="line">       <span class="keyword">for</span> (CartesianDataSource cartesianDataSource : ((CartesianRoutingResult) routingResult).getRoutingDataSources()) &#123;</div><div class="line">           <span class="keyword">for</span> (CartesianTableReference cartesianTableReference : cartesianDataSource.getRoutingTableReferences()) &#123;</div><div class="line">               <span class="comment">// üëº ÁîüÊàê SQL</span></div><div class="line">               result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(cartesianDataSource.getDataSource(), rewriteEngine.generateSQL(cartesianTableReference, sqlBuilder)));</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       <span class="keyword">for</span> (TableUnit each : routingResult.getTableUnits().getTableUnits()) &#123;</div><div class="line">           <span class="comment">// üëº ÁîüÊàê SQL</span></div><div class="line">           result.getExecutionUnits().add(<span class="keyword">new</span> SQLExecutionUnit(each.getDataSourceName(), rewriteEngine.generateSQL(each, sqlBuilder)));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>Ë∞ÉÁî® <code>RewriteEngine#generateSQL()</code> ÁîüÊàê<strong>ÊâßË°åSQL</strong>„ÄÇÂØπ‰∫éÁ¨õÂç°Â∞îÁßØË∑ØÁî±ÁªìÊûúÂíåÁÆÄÂçïË∑ØÁî±ÁªìÊûú‰º†ÈÄíÁöÑÂèÇÊï∞Áï•Êúâ‰∏çÂêåÔºöÂâçËÄÖ‰ΩøÁî® CartesianDataSource ( CartesianTableReference )ÔºåÂêéËÄÖ‰ΩøÁî®Ë∑ØÁî±Ë°®ÂçïÂÖÉ ( TableUnit )„ÄÇÂØπË∑ØÁî±ÁªìÊûú‰∏çÊòØÂæà‰∫ÜËß£ÁöÑÂêåÂ≠¶ÔºåÂª∫ËÆÆÁúã‰∏ã <a href="http://www.yunai.me/Sharding-JDBC/sql-route-2/?mp">„ÄäSQL Ë∑ØÁî±Ôºà‰∫åÔºâ‰πãÂàÜÂ∫ìÂàÜË°®Ë∑ØÁî±„Äã</a>„ÄÇ</li>
</ul>
<p><code>RewriteEngine#generateSQL()</code> ÂØπ‰∫éÁ¨õÂç°Â∞îÁßØË∑ØÁî±ÁªìÊûúÂíåÁÆÄÂçïË∑ØÁî±ÁªìÊûú‰∏§ÁßçÊÉÖÂÜµÔºåÂ§ÑÁêÜ‰∏äÂ§ß‰ΩìÊòØ‰∏ÄËá¥ÁöÑÔºö1. Ëé∑Âæó SQL Áõ∏ÂÖ≥<strong>ÈÄªËæëË°®</strong>ÂØπÂ∫îÁöÑ<strong>ÁúüÂÆûË°®</strong>Êò†Â∞ÑÔºå2. Ê†πÊçÆÊò†Â∞ÑÊîπÂÜô SQL Áõ∏ÂÖ≥<strong>ÈÄªËæëË°®</strong>‰∏∫<strong>ÁúüÂÆûË°®</strong>„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ÁîüÊàêSQLËØ≠Âè•.</div><div class="line">* <span class="doctag">@param</span> tableUnit Ë∑ØÁî±Ë°®ÂçïÂÖÉ</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLÊûÑÂª∫Âô®</div><div class="line">* <span class="doctag">@return</span> SQLËØ≠Âè•</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateSQL</span><span class="params">(<span class="keyword">final</span> TableUnit tableUnit, <span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> sqlBuilder.toSQL(getTableTokens(tableUnit));</div><div class="line">&#125;  </div><div class="line"><span class="comment">/**</span></div><div class="line">* ÁîüÊàêSQLËØ≠Âè•.</div><div class="line">* <span class="doctag">@param</span> cartesianTableReference Á¨õÂç°Â∞îÁßØË∑ØÁî±Ë°®ÂçïÂÖÉ</div><div class="line">* <span class="doctag">@param</span> sqlBuilder SQLÊûÑÂª∫Âô®</div><div class="line">* <span class="doctag">@return</span> SQLËØ≠Âè•</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateSQL</span><span class="params">(<span class="keyword">final</span> CartesianTableReference cartesianTableReference, <span class="keyword">final</span> SQLBuilder sqlBuilder)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> sqlBuilder.toSQL(getTableTokens(cartesianTableReference));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">// SQLBuilder.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* ÁîüÊàêSQLËØ≠Âè•.</div><div class="line">* <span class="doctag">@param</span> tableTokens Âç†‰ΩçÁ¨¶ÈõÜÂêàÔºàÈÄªËæëË°®‰∏éÁúüÂÆûË°®Êò†Â∞ÑÔºâ</div><div class="line">* <span class="doctag">@return</span> SQLËØ≠Âè•</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toSQL</span><span class="params">(<span class="keyword">final</span> Map&lt;String, String&gt; tableTokens)</span> </span>&#123;</div><div class="line">   StringBuilder result = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="keyword">for</span> (Object each : segments) &#123;</div><div class="line">       <span class="keyword">if</span> (each <span class="keyword">instanceof</span> TableToken &amp;&amp; tableTokens.containsKey(((TableToken) each).tableName)) &#123;</div><div class="line">           result.append(tableTokens.get(((TableToken) each).tableName));</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           result.append(each);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>#toSQL()</code> ÁªìÊûúÂ¶ÇÂõæÔºö <img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/09.png" alt="">
üòú ÂØπ <strong>SQLÊîπÂÜô</strong> ÊòØ‰∏çÊòØÊ∏ÖÊô∞ÂæàÂ§ö‰∫Ü„ÄÇ</li>
</ul>
<hr>
<p>‰∏ãÈù¢Êàë‰ª¨‰ª•<strong>Á¨õÂç°Â∞îÁßØË∑ØÁî±ÁªìÊûú</strong>Ëé∑Âæó SQL Áõ∏ÂÖ≥<strong>ÈÄªËæëË°®</strong>ÂØπÂ∫îÁöÑ<strong>ÁúüÂÆûË°®</strong>Êò†Â∞Ñ‰∏∫‰æãÂ≠ê(<em>ÁÆÄÂçïË∑ØÁî±ÁªìÊûúÂü∫Êú¨Á±ª‰ººËÄå‰∏îÁÆÄÂçï</em>)„ÄÇ</p>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// SQLRewriteEngine.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* Ëé∑ÂæóÔºàÁ¨õÂç°Â∞îÁßØË°®Ë∑ØÁî±ÁªÑÈáåÁöÑË∑ØÁî±Ë°®ÂçïÂÖÉÈÄªËæëË°® Âíå ‰∏éÂÖ∂‰∫í‰∏∫BindingTableÂÖ≥Á≥ªÁöÑÈÄªËæëË°®ÔºâÂØπÂ∫îÁöÑÁúüÂÆûË°®Êò†Â∞ÑÔºàÈÄªËæëË°®ÈúÄË¶ÅÂú® SQL ‰∏≠Â≠òÂú®Ôºâ</div><div class="line">* <span class="doctag">@param</span> cartesianTableReference Á¨õÂç°Â∞îÁßØË°®Ë∑ØÁî±ÁªÑ</div><div class="line">* <span class="doctag">@return</span> ÈõÜÂêà</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getTableTokens</span><span class="params">(<span class="keyword">final</span> CartesianTableReference cartesianTableReference)</span> </span>&#123;</div><div class="line">   Map&lt;String, String&gt; tableTokens = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (TableUnit each : cartesianTableReference.getTableUnits()) &#123;</div><div class="line">       tableTokens.put(each.getLogicTableName(), each.getActualTableName());</div><div class="line">       <span class="comment">// Êü•Êâæ BindingTableRule</span></div><div class="line">       Optional&lt;BindingTableRule&gt; bindingTableRule = shardingRule.findBindingTableRule(each.getLogicTableName());</div><div class="line">       <span class="keyword">if</span> (bindingTableRule.isPresent()) &#123;</div><div class="line">           tableTokens.putAll(getBindingTableTokens(each, bindingTableRule.get()));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> tableTokens;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line">* Ëé∑Âæó BindingTable ÂÖ≥Á≥ªÁöÑÈÄªËæëË°®ÂØπÂ∫îÁöÑÁúüÂÆûË°®Êò†Â∞ÑÔºàÈÄªËæëË°®ÈúÄË¶ÅÂú® SQL ‰∏≠Â≠òÂú®Ôºâ</div><div class="line">* <span class="doctag">@param</span> tableUnit Ë∑ØÁî±ÂçïÂÖÉ</div><div class="line">* <span class="doctag">@param</span> bindingTableRule BindingË°®ËßÑÂàôÈÖçÁΩÆÂØπË±°</div><div class="line">* <span class="doctag">@return</span> Êò†Â∞Ñ</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getBindingTableTokens</span><span class="params">(<span class="keyword">final</span> TableUnit tableUnit, <span class="keyword">final</span> BindingTableRule bindingTableRule)</span> </span>&#123;</div><div class="line">   Map&lt;String, String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">   <span class="keyword">for</span> (String eachTable : sqlStatement.getTables().getTableNames()) &#123;</div><div class="line">       <span class="keyword">if</span> (!eachTable.equalsIgnoreCase(tableUnit.getLogicTableName()) &amp;&amp; bindingTableRule.hasLogicTable(eachTable)) &#123;</div><div class="line">           result.put(eachTable, bindingTableRule.getBindingActualTable(tableUnit.getDataSourceName(), eachTable, tableUnit.getActualTableName()));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>Á¨õÂç°Â∞îÁßØË°®Ë∑ØÁî±ÁªÑ( CartesianTableReference )ÂåÖÂê´<strong>Â§ö‰∏™</strong>Ë∑ØÁî±Ë°®ÂçïÂÖÉ( TableUnit )„ÄÇÊØè‰∏™Ë∑ØÁî±Ë°®ÂçïÂÖÉÈúÄË¶ÅÈÅçÂéÜ„ÄÇ</li>
<li>Ë∑ØÁî±Ë°®ÂçïÂÖÉÊú¨Ë∫´ÂåÖÂê´ÈÄªËæëË°®ÂíåÁúüÂÆûË°®ÔºåÁõ¥Êé•Ê∑ªÂä†Âà∞Êò†Â∞ÑÂç≥ÂèØ„ÄÇ</li>
<li>‰∫í‰∏∫ BindingTable ÂÖ≥Á≥ªÁöÑË°®Âè™ËÆ°ÁÆó‰∏ÄÊ¨°Ë∑ØÁî±ÂàÜÁâáÔºåÂõ†Ê≠§<strong>Êú™ËÆ°ÁÆó</strong>ÁöÑÁúüÂÆûË°®ÈúÄË¶Å‰ª•ÂÖ∂ÂØπÂ∫îÁöÑ<strong>Â∑≤ËÆ°ÁÆó</strong>ÁöÑÁúüÂÆûË°®ÂéªÊü•ÊâæÔºåÂç≥ <code>bindingTableRule.getBindingActualTable(tableUnit.getDataSourceName(), eachTable, tableUnit.getActualTableName())</code> Â§ÑÈÄªËæë„ÄÇ</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// BindingTableRule.java</span></div><div class="line"><span class="comment">/**</span></div><div class="line">* Ê†πÊçÆÂÖ∂‰ªñBindingË°®ÁúüÂÆûË°®ÂêçÁß∞Ëé∑ÂèñÁõ∏Â∫îÁöÑÁúüÂÆûBindingË°®ÂêçÁß∞.</div><div class="line">* </div><div class="line">* <span class="doctag">@param</span> dataSource Êï∞ÊçÆÊ∫êÂêçÁß∞</div><div class="line">* <span class="doctag">@param</span> logicTable ÈÄªËæëË°®ÂêçÁß∞</div><div class="line">* <span class="doctag">@param</span> otherActualTable ÂÖ∂‰ªñÁúüÂÆûBindingË°®ÂêçÁß∞</div><div class="line">* <span class="doctag">@return</span> ÁúüÂÆûBindingË°®ÂêçÁß∞</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getBindingActualTable</span><span class="params">(<span class="keyword">final</span> String dataSource, <span class="keyword">final</span> String logicTable, <span class="keyword">final</span> String otherActualTable)</span> </span>&#123;</div><div class="line">   <span class="comment">// ËÆ°ÁÆó otherActualTable Âú®ÂÖ∂ TableRule ÁöÑ actualTable ÊòØÁ¨¨Âá†‰∏™</span></div><div class="line">   <span class="keyword">int</span> index = -<span class="number">1</span>;</div><div class="line">   <span class="keyword">for</span> (TableRule each : tableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.isDynamic()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Dynamic table cannot support Binding table."</span>);</div><div class="line">       &#125;</div><div class="line">       index = each.findActualTableIndex(dataSource, otherActualTable);</div><div class="line">       <span class="keyword">if</span> (-<span class="number">1</span> != index) &#123;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   Preconditions.checkState(-<span class="number">1</span> != index, String.format(<span class="string">"Actual table [%s].[%s] is not in table config"</span>, dataSource, otherActualTable));</div><div class="line">   <span class="comment">// ËÆ°ÁÆó logicTable Âú®ÂÖ∂ TableRule ÁöÑ Á¨¨index ÁöÑ ÁúüÂÆûË°®</span></div><div class="line">   <span class="keyword">for</span> (TableRule each : tableRules) &#123;</div><div class="line">       <span class="keyword">if</span> (each.getLogicTable().equalsIgnoreCase(logicTable)) &#123;</div><div class="line">           <span class="keyword">return</span> each.getActualTables().get(index).getTableName();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"Cannot find binding actual table, data source: %s, logic table: %s, other actual table: %s"</span>, dataSource, logicTable, otherActualTable));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ÂèØËÉΩÁúãËµ∑Êù•Êúâ‰∫õÁªïÔºåÊàë‰ª¨ÁúãÂº†ÂõæÔºö</p>
<p><img src="http://www.yunai.me/images/Sharding-JDBC/2017_08_10/10.png" alt=""></p>
<p><strong>ÂèãÊÉÖÊèêÁ§∫</strong>ÔºöËøôÈáå‰∏çÂ´åÂï∞Âó¶Âú®Êèê‰∏ÄÂè•Ôºå‰∫í‰∏∫ BindingTable ÁöÑË°®ÔºåÈÖçÁΩÆ TableRule Êó∂Ôºå<code>actualTables</code> Êï∞Èáè‰∏ÄÂÆöË¶Å‰∏ÄËá¥ÔºåÂê¶ÂàôÂ§öÂá∫Êù•ÁöÑË°®ÔºåÂèØËÉΩ‰ºöÊó†Ê≥ïË¢´Ë∑ØÁî±Âà∞„ÄÇ</p>
<h1>666. ÂΩ©Ëõã</h1>
<p>ÂìàÂìàÂìàÔºåÁúãÂÆå<strong>SQLÊîπÂÜô</strong>ÂêéÔºå<strong>SQLËß£Êûê</strong>ÊòØ‰∏çÊòØÊ∏ÖÊô∞Â§ö‰∫ÜÔºÅÂòøÂòøÂòøÔºåÂèçÊ≠£ÊàëÁé∞Âú®ÊúâÁÇπÂó®„ÄÇÊÅ©ÔºåËõÆÂó®ÁöÑ„ÄÇ</p>
<p>ÂΩìÁÑ∂ÔºåÂ¶ÇÊûú<strong>SQLËß£Êûê</strong>ÁêÜËß£‰∏äÊúâÁÇπÁñëÊÉëÁöÑ‰Ω†Ôºå<strong>Ê¨¢Ëøé</strong>Âä†ÊàëÁöÑÂæÆ‰ø°ÔºåÂí± <strong>1ÂØπ1</strong> ÊêûÂü∫„ÄÇÂÖ≥Ê≥®ÊàëÁöÑÂæÆ‰ø°ÂÖ¨‰ºóÂè∑Ôºö<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">„ÄêËäãËâøÁöÑÂêéÁ´ØÂ∞èÂ±ã„Äë</a> Âç≥ÂèØËé∑Âæó„ÄÇ</p>
<p><img src="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg" alt=""></p>
<p>ÈÅìÂèãÔºåËΩ¨Âèë‰∏ÄÊ≥¢ÊúãÂèãÂúàÂèØÂ•ΩÔºü</p>
<p>Let's Go! <a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">„ÄäÂàÜÂ∏ÉÂºè‰∏ªÈîÆ„Äã</a>„ÄÅ<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">„ÄäSQL ÊâßË°å„Äã</a>„ÄÅ<a href="https://www.yunai.me/images/common/wechat_mp_2017_07_31.jpg">„ÄäÁªìÊûúËÅöÂêà„Äã</a> ÁªßÁª≠„ÄÇ</p>
<p><em>ÊÑüË∞¢ÊäÄÊúØÁâõÈÄºÂ¶Ç‰Ω†ËÄêÂøÉÁöÑÈòÖËØªÊú¨Êñá„ÄÇ</em></p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">1. Ê¶ÇËø∞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">2. SQLToken</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">3.SQL ÊîπÂÜô</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 TableToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ItemsToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 OffsetToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 RowCountToken</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.4.1 ÂàÜÈ°µË°•ÂÖÖ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 OrderByToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 GeneratedKeyToken</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">4. SQL ÁîüÊàê</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">666. ÂΩ©Ëõã</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/Sharding-JDBC/sql-rewrite/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&text=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&is_video=false&description=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô&body=Check out this article: http://www.yunai.me/Sharding-JDBC/sql-rewrite/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&title=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/Sharding-JDBC/sql-rewrite/&name=Sharding-JDBC Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî SQL Ë∑ØÁî±ÊîπÂÜô&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 ÁéãÊñáÊñå
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO ÂæÖ‰ºòÂåñÔºöËøáÊª§ Áà¨Ëô´
        url = $('#actions .icon').attr('href').trim(); // ÊñáÁ´†url
//        alert(url);
        title = $('.posttitle').text().trim(); // ÊñáÁ´†Ê†áÈ¢ò
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // ÊèíÂÖ•Ê¨°Êï∞
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // ÊèíÂÖ•Ê¨°Êï∞
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // Ëé∑Âèñuid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip ÊµèËßàÂô®Êó†Ê≥ïËé∑Âèñ
        // time ÊúçÂä°Á´ØÂ∑≤ÁªèËÆ∞ÂΩï
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO ÂæÖ‰ºòÂåñÔºöÊ≠§Â§ÑÊÄßËÉΩËæÉÂ∑ÆÔºåÂèØËÉΩ
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // Âà§Êñ≠ÊòØÂê¶Âú®ÊñáÁ´†È°µ
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // Â¢ûÂä†ÊñáÁ´†ËÆøÈóÆÊ¨°Êï∞
                addCount(Counter);
            }
            // ËÆ∞ÂΩïËÆøÈóÆÊó•Âøó
            addVisitLog();
            // ËÆ°ÁÆóÂ§öÂ∞ë‰∫∫ËÆøÈóÆ
            countVisitLog();
        }, 1000);
    });
</script>
