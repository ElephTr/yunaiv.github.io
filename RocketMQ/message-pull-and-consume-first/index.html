<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMQ 源码分析 —— Message 拉取与消费（上）">
<meta property="og:url" content="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/index.html">
<meta property="og:site_name" content="芋艿V的博客">
<meta property="og:description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta property="og:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/13.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/04.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/03.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/02.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/12.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/11.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/08.png">
<meta property="og:updated_time" content="2017-07-20T01:40:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RocketMQ 源码分析 —— Message 拉取与消费（上）">
<meta name="twitter:description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta name="twitter:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>RocketMQ 源码分析 —— Message 拉取与消费（上）</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- 百度统计 -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- 百度站长-被动推送 -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360搜索-自动收录 -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/RocketMQ/message-pull-and-consume-second/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$(" #i-prev").toggle();"="" onmouseout="$("></i></a></li>
        
        
        <li><a class="icon" href="/RocketMQ/message-store/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&text=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&title=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&is_video=false&description=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RocketMQ 源码分析 —— Message 拉取与消费（上）&body=Check out this article: http://www.yunai.me/RocketMQ/message-pull-and-consume-first/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&title=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&title=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&title=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&title=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&name=RocketMQ 源码分析 —— Message 拉取与消费（上）&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1、概述"><span class="toc-number">1.</span> <span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2、ConsumeQueue-结构"><span class="toc-number">2.</span> <span class="toc-text">2、ConsumeQueue 结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3、ConsumeQueue-存储"><span class="toc-number">3.</span> <span class="toc-text">3、ConsumeQueue 存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ReputMessageService"><span class="toc-number">3.1.</span> <span class="toc-text">ReputMessageService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultMessageStore-doDispatch-…"><span class="toc-number">3.1.1.</span> <span class="toc-text">DefaultMessageStore#doDispatch(…)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeQueue-putMessagePositionInfoWrapper-…"><span class="toc-number">3.1.2.</span> <span class="toc-text">ConsumeQueue#putMessagePositionInfoWrapper(…)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FlushConsumeQueueService"><span class="toc-number">3.2.</span> <span class="toc-text">FlushConsumeQueueService</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4、Broker-提供-拉取消息-接口"><span class="toc-number">4.</span> <span class="toc-text">4、Broker 提供[拉取消息]接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageRequestHeader"><span class="toc-number">4.1.</span> <span class="toc-text">PullMessageRequestHeader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageProcessor-processRequest-…"><span class="toc-number">4.2.</span> <span class="toc-text">PullMessageProcessor#processRequest(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MessageStore-getMessage-…"><span class="toc-number">4.3.</span> <span class="toc-text">MessageStore#getMessage(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMessageFilter-isMessageMatched-…"><span class="toc-number">4.4.</span> <span class="toc-text">DefaultMessageFilter#isMessageMatched(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullRequestHoldService"><span class="toc-number">4.5.</span> <span class="toc-text">PullRequestHoldService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageProcessor-executeRequestWhenWakeup-…"><span class="toc-number">4.6.</span> <span class="toc-text">PullMessageProcessor#executeRequestWhenWakeup(…)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5、Broker-提供-更新消费进度-接口"><span class="toc-number">5.</span> <span class="toc-text">5、Broker 提供[更新消费进度]接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BrokerController-initialize-…"><span class="toc-number">5.1.</span> <span class="toc-text">BrokerController#initialize(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigManager"><span class="toc-number">5.2.</span> <span class="toc-text">ConfigManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MixAll-string2File-…"><span class="toc-number">5.2.1.</span> <span class="toc-text">MixAll#string2File(…)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumerOffsetManager"><span class="toc-number">5.3.</span> <span class="toc-text">ConsumerOffsetManager</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6、Broker-提供-发回消息-接口"><span class="toc-number">6.</span> <span class="toc-text">6、Broker 提供[发回消息]接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SendMessageProcessor-consumerSendMsgBack-…"><span class="toc-number">6.1.</span> <span class="toc-text">SendMessageProcessor#consumerSendMsgBack(…)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7、结尾"><span class="toc-number">7.</span> <span class="toc-text">7、结尾</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        RocketMQ 源码分析 —— Message 拉取与消费（上）
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">芋艿V的博客</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-05-03T16:00:00.000Z" itemprop="datePublished">2017-05-04</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><a class="magnific-img" href="http://www.yunai.me/images/common/wechat_mp.jpeg"><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="" class="ui centered image"></a></p>
<blockquote>
<p>&#x1F642;&#x1F642;&#x1F642;&#x5173;&#x6CE8;<strong>&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x53F7;&#xFF1A;&#x3010;&#x828B;&#x827F;&#x7684;&#x540E;&#x7AEF;&#x5C0F;&#x5C4B;&#x3011;</strong>&#x6709;&#x798F;&#x5229;&#xFF1A;  </p>
<ol class="ui list">
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>&#x6240;&#x6709;</strong>&#x6E90;&#x7801;&#x5206;&#x6790;&#x6587;&#x7AE0;&#x5217;&#x8868;  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>&#x4E2D;&#x6587;&#x6CE8;&#x91CA;&#x6E90;&#x7801; GitHub &#x5730;&#x5740;</strong>  </li>
<li>&#x60A8;&#x5BF9;&#x4E8E;&#x6E90;&#x7801;&#x7684;&#x7591;&#x95EE;&#x6BCF;&#x6761;&#x7559;&#x8A00;<strong>&#x90FD;</strong>&#x5C06;&#x5F97;&#x5230;<strong>&#x8BA4;&#x771F;</strong>&#x56DE;&#x590D;&#x3002;<strong>&#x751A;&#x81F3;&#x4E0D;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x8BFB;&#x6E90;&#x7801;&#x4E5F;&#x53EF;&#x4EE5;&#x8BF7;&#x6559;&#x5662;</strong>&#x3002;  </li>
<li><strong>&#x65B0;&#x7684;</strong>&#x6E90;&#x7801;&#x89E3;&#x6790;&#x6587;&#x7AE0;<strong>&#x5B9E;&#x65F6;</strong>&#x6536;&#x5230;&#x901A;&#x77E5;&#x3002;<strong>&#x6BCF;&#x5468;&#x66F4;&#x65B0;&#x4E00;&#x7BC7;&#x5DE6;&#x53F3;</strong>&#x3002;</li>
</ol>
</blockquote>
<hr>
<ul class="ui list">
<li><a href="#">1&#x3001;&#x6982;&#x8FF0;</a></li>
<li><a href="#">2&#x3001;ConsumeQueue &#x7ED3;&#x6784;</a></li>
<li><a href="#">3&#x3001;ConsumeQueue &#x5B58;&#x50A8;</a><ul>
<li><a href="#">ReputMessageService</a><ul>
<li><a href="#">DefaultMessageStore#doDispatch(&#x2026;)</a></li>
<li><a href="#">ConsumeQueue#putMessagePositionInfoWrapper(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">FlushConsumeQueueService</a></li>
</ul>
</li>
<li><a href="#">4&#x3001;Broker &#x63D0;&#x4F9B;[&#x62C9;&#x53D6;&#x6D88;&#x606F;]&#x63A5;&#x53E3;</a><ul>
<li><a href="#">PullMessageRequestHeader</a></li>
<li><a href="#">PullMessageProcessor#processRequest(&#x2026;)</a></li>
<li><a href="#">MessageStore#getMessage(&#x2026;)</a></li>
<li><a href="#">DefaultMessageFilter#isMessageMatched(&#x2026;)</a></li>
<li><a href="#">PullRequestHoldService</a></li>
<li><a href="#">PullMessageProcessor#executeRequestWhenWakeup(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">5&#x3001;Broker &#x63D0;&#x4F9B;[&#x66F4;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;]&#x63A5;&#x53E3;</a><ul>
<li><a href="#">BrokerController#initialize(&#x2026;)</a></li>
<li><a href="#">ConfigManager</a><ul>
<li><a href="#">MixAll#string2File(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">ConsumerOffsetManager</a></li>
</ul>
</li>
<li><a href="#">6&#x3001;Broker &#x63D0;&#x4F9B;[&#x53D1;&#x56DE;&#x6D88;&#x606F;]&#x63A5;&#x53E3;</a><ul>
<li><a href="#">SendMessageProcessor#consumerSendMsgBack(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">7&#x3001;&#x7ED3;&#x5C3E;</a></li>
</ul>
<h1 id="1&#x3001;&#x6982;&#x8FF0;"><a href="#1&#x3001;&#x6982;&#x8FF0;" class="headerlink" title="1&#x3001;&#x6982;&#x8FF0;"></a>1&#x3001;&#x6982;&#x8FF0;</h1><p>&#x672C;&#x7AE0;&#x4E3B;&#x8981;&#x89E3;&#x6790; <strong>&#x6D88;&#x8D39;</strong> &#x903B;&#x8F91;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x6E90;&#x7801;&#x3002;<br>&#x56E0;&#x4E3A;&#x7BC7;&#x5E45;&#x8F83;&#x957F;&#xFF0C;&#x5206;&#x6210;&#x4E0A;&#x4E0B;&#x4E24;&#x7BC7;&#xFF1A;</p>
<ol class="ui list">
<li>&#x4E0A;&#x7BC7;&#xFF1A;<code>Broker</code> &#x76F8;&#x5173;&#x6E90;&#x7801;&#x3002;</li>
<li>&#x4E0B;&#x7BC7;&#xFF1A;<code>Consumer</code> &#x76F8;&#x5173;&#x6E90;&#x7801;&#x3002;</li>
</ol>
<p><em>&#x672C;&#x6587;&#x5373;&#x662F;&#x4E0A;&#x7BC7;&#x3002;</em></p>
<hr>
<p>ok&#xFF0C;&#x5148;&#x770B;&#x7B2C;&#x4E00;&#x5F20;&#x5173;&#x4E8E;&#x6D88;&#x8D39;&#x903B;&#x8F91;&#x7684;&#x56FE;&#xFF1A;</p>
<blockquote>
<p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/13.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/13.png" alt="&#x6D88;&#x8D39;&#x903B;&#x8F91;&#x56FE;" class="ui centered image"></a></p>
</blockquote>
<p>&#x518D;&#x770B;&#x6D88;&#x8D39;&#x903B;&#x8F91;&#x7CBE;&#x7B80;&#x7684;&#x987A;&#x5E8F;&#x56FE;&#xFF08;&#x5B9E;&#x9645;&#x60C5;&#x51B5;&#x4F1A;&#x7565;&#x6709;&#x5DEE;&#x522B;&#xFF09;&#xFF1A;</p>
<blockquote>
<p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/04.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/04.png" alt="Consumer&amp;Broker&#x6D88;&#x8D39;&#x7CBE;&#x7B80;&#x56FE;.png" class="ui centered image"></a></p>
</blockquote>
<h1 id="2&#x3001;ConsumeQueue-&#x7ED3;&#x6784;"><a href="#2&#x3001;ConsumeQueue-&#x7ED3;&#x6784;" class="headerlink" title="2&#x3001;ConsumeQueue &#x7ED3;&#x6784;"></a>2&#x3001;ConsumeQueue &#x7ED3;&#x6784;</h1><p><code>ConsumeQueue</code>&#x3001;<code>MappedFileQueue</code>&#x3001;<code>MappedFile</code> &#x7684;&#x5173;&#x7CFB;&#x5982;&#x4E0B;&#xFF1A;</p>
<blockquote>
<p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/03.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/03.png" alt="ConsumeQueue&#x3001;MappedFileQueue&#x3001;MappedFile&#x7684;&#x5173;&#x7CFB;" class="ui centered image"></a><br><code>ConsumeQueue</code> : <code>MappedFileQueue</code> : <code>MappedFile</code> = 1 : 1 : N&#x3002;</p>
</blockquote>
<p>&#x53CD;&#x5E94;&#x5230;&#x7CFB;&#x7EDF;&#x6587;&#x4EF6;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:consumequeue yunai$ <span class="built_in">pwd</span></div><div class="line">/Users/yunai/store/consumequeue</div><div class="line">Yunai-MacdeMacBook-Pro-2:consumequeue yunai$ <span class="built_in">cd</span> TopicRead3/</div><div class="line">Yunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ ls -ls</div><div class="line">total 0</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:52 0</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 1</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 2</div><div class="line">0 drwxr-xr-x  3 yunai  staff  102  4 27 21:55 3</div><div class="line">Yunai-MacdeMacBook-Pro-2:TopicRead3 yunai$ <span class="built_in">cd</span> 0/</div><div class="line">Yunai-MacdeMacBook-Pro-2:0 yunai$ ls -ls</div><div class="line">total 11720</div><div class="line">11720 -rw-r--r--  1 yunai  staff  6000000  4 27 21:55 00000000000000000000</div></pre></td></tr></table></figure>
<hr>
<p><code>ConsumeQueue</code>&#x3001;<code>MappedFileQueue</code>&#x3001;<code>MappedFile</code> &#x7684;&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul class="ui list">
<li><code>MappedFile</code> &#xFF1A;00000000000000000000&#x7B49;&#x6587;&#x4EF6;&#x3002;</li>
<li><code>MappedFileQueue</code> &#xFF1A;<code>MappedFile</code> &#x6240;&#x5728;&#x7684;&#x6587;&#x4EF6;&#x5939;&#xFF0C;&#x5BF9; <code>MappedFile</code> &#x8FDB;&#x884C;&#x5C01;&#x88C5;&#x6210;&#x6587;&#x4EF6;&#x961F;&#x5217;&#xFF0C;&#x5BF9;&#x4E0A;&#x5C42;&#x63D0;&#x4F9B;&#x53EF;&#x65E0;&#x9650;&#x4F7F;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x5BB9;&#x91CF;&#x3002;<ul>
<li>&#x6BCF;&#x4E2A; <code>MappedFile</code> &#x7EDF;&#x4E00;&#x6587;&#x4EF6;&#x5927;&#x5C0F;&#x3002;</li>
<li>&#x6587;&#x4EF6;&#x547D;&#x540D;&#x65B9;&#x5F0F;&#xFF1A;fileName[n] = fileName[n - 1] + mappedFileSize&#x3002;&#x5728; <code>ConsumeQueue</code> &#x91CC;&#x9ED8;&#x8BA4;&#x4E3A; 6000000B&#x3002;</li>
</ul>
</li>
<li><code>ConsumeQueue</code> &#xFF1A;&#x9488;&#x5BF9; <code>MappedFileQueue</code> &#x7684;&#x5C01;&#x88C5;&#x4F7F;&#x7528;&#x3002;<ul>
<li><code>Store : ConsumeQueue = ConcurrentHashMap&lt;String/* topic */, ConcurrentHashMap&lt;Integer/* queueId */, ConsumeQueue&gt;&gt;</code>&#x3002;</li>
</ul>
</li>
</ul>
<p><code>ConsumeQueue</code> &#x5B58;&#x50A8;&#x5728; <code>MappedFile</code> &#x7684;&#x5185;&#x5BB9;<strong>&#x5FC5;&#x987B;</strong>&#x5927;&#x5C0F;&#x662F; 20B( <code>ConsumeQueue.CQ_STORE_UNIT_SIZE</code> )&#xFF0C;&#x6709;&#x4E24;&#x79CD;&#x5185;&#x5BB9;&#x7C7B;&#x578B;&#xFF1A;</p>
<ol class="ui list">
<li><code>MESSAGE_POSITION_INFO</code> &#xFF1A;&#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#x3002;</li>
<li><code>BLANK</code> : &#x6587;&#x4EF6;&#x524D;&#x7F6E;&#x7A7A;&#x767D;&#x5360;&#x4F4D;&#x3002;&#x5F53;&#x5386;&#x53F2; <code>Message</code> &#x88AB;&#x5220;&#x9664;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x7528; <code>BLANK</code>&#x5360;&#x4F4D;&#x88AB;&#x5220;&#x9664;&#x7684;&#x6D88;&#x606F;&#x3002;</li>
</ol>
<p><code>MESSAGE_POSITION_INFO</code> &#x5728; <code>ConsumeQueue</code> &#x5B58;&#x50A8;&#x7ED3;&#x6784;&#xFF1A;</p>
<table>
<thead>
<tr>
<th style="text-align:left">&#x7B2C;&#x51E0;&#x4F4D;</th>
<th style="text-align:left">&#x5B57;&#x6BB5;</th>
<th style="text-align:left">&#x8BF4;&#x660E;</th>
<th style="text-align:left">&#x6570;&#x636E;&#x7C7B;&#x578B;</th>
<th style="text-align:left">&#x5B57;&#x8282;&#x6570;</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">offset</td>
<td style="text-align:left">&#x6D88;&#x606F; <code>CommitLog</code> &#x5B58;&#x50A8;&#x4F4D;&#x7F6E;</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">size</td>
<td style="text-align:left">&#x6D88;&#x606F;&#x957F;&#x5EA6;</td>
<td style="text-align:left">Int</td>
<td style="text-align:left">4</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">tagsCode</td>
<td style="text-align:left">&#x6D88;&#x606F;tagsCode</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
</tr>
</tbody>
</table>
<p><code>BLANK</code> &#x5728; <code>ConsumeQueue</code> &#x5B58;&#x50A8;&#x7ED3;&#x6784;&#xFF1A;</p>
<table>
<thead>
<tr>
<th style="text-align:left">&#x7B2C;&#x51E0;&#x4F4D;</th>
<th style="text-align:left">&#x5B57;&#x6BB5;</th>
<th style="text-align:left">&#x8BF4;&#x660E;</th>
<th style="text-align:left">&#x6570;&#x636E;&#x7C7B;&#x578B;</th>
<th style="text-align:left">&#x5B57;&#x8282;&#x6570;</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left"></td>
<td style="text-align:left">Integer.MAX_VALUE</td>
<td style="text-align:left">Int</td>
<td style="text-align:left">4</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left"></td>
<td style="text-align:left">0</td>
<td style="text-align:left">Long</td>
<td style="text-align:left">8</td>
</tr>
</tbody>
</table>
<h1 id="3&#x3001;ConsumeQueue-&#x5B58;&#x50A8;"><a href="#3&#x3001;ConsumeQueue-&#x5B58;&#x50A8;" class="headerlink" title="3&#x3001;ConsumeQueue &#x5B58;&#x50A8;"></a>3&#x3001;ConsumeQueue &#x5B58;&#x50A8;</h1><p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/02.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/02.png" alt="CommitLog&#x91CD;&#x653E;ConsumeQueue&#x56FE;" class="ui centered image"></a></p>
<p>&#x4E3B;&#x8981;&#x6709;&#x4E24;&#x4E2A;&#x7EC4;&#x4EF6;&#xFF1A;</p>
<ul class="ui list">
<li><code>ReputMessageService</code> &#xFF1A;write ConsumeQueue&#x3002;</li>
<li><code>FlushConsumeQueueService</code> &#xFF1A;flush ConsumeQueue&#x3002;</li>
</ul>
<h2 id="ReputMessageService"><a href="#ReputMessageService" class="headerlink" title="ReputMessageService"></a>ReputMessageService</h2><p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/12.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/12.png" alt="ReputMessageService&#x987A;&#x5E8F;&#x56FE;" class="ui centered image"></a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">ReputMessageService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>{</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line">  4:      * &#x5F00;&#x59CB;&#x91CD;&#x653E;&#x6D88;&#x606F;&#x7684;CommitLog&#x7269;&#x7406;&#x4F4D;&#x7F6E;</div><div class="line">  5:      */</div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> reputFromOffset = <span class="number">0</span>;</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getReputFromOffset</span><span class="params">()</span> </span>{</div><div class="line">  <span class="number">9</span>:         <span class="keyword">return</span> reputFromOffset;</div><div class="line"> <span class="number">10</span>:     }</div><div class="line"> <span class="number">11</span>: </div><div class="line"> <span class="number">12</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReputFromOffset</span><span class="params">(<span class="keyword">long</span> reputFromOffset)</span> </span>{</div><div class="line"> <span class="number">13</span>:         <span class="keyword">this</span>.reputFromOffset = reputFromOffset;</div><div class="line"> <span class="number">14</span>:     }</div><div class="line"> <span class="number">15</span>: </div><div class="line"> <span class="number">16</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">17</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">18</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span> &amp;&amp; <span class="keyword">this</span>.isCommitLogAvailable(); i++) {</div><div class="line"> <span class="number">19</span>:             <span class="keyword">try</span> {</div><div class="line"> <span class="number">20</span>:                 Thread.sleep(<span class="number">100</span>);</div><div class="line"> <span class="number">21</span>:             } <span class="keyword">catch</span> (InterruptedException ignored) {</div><div class="line"> <span class="number">22</span>:             }</div><div class="line"> <span class="number">23</span>:         }</div><div class="line"> <span class="number">24</span>: </div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.isCommitLogAvailable()) {</div><div class="line"> <span class="number">26</span>:             log.warn(<span class="string">&quot;shutdown ReputMessageService, but commitlog have not finish to be dispatched, CL: {} reputFromOffset: {}&quot;</span>,</div><div class="line"> <span class="number">27</span>:                 DefaultMessageStore.<span class="keyword">this</span>.commitLog.getMaxOffset(), <span class="keyword">this</span>.reputFromOffset);</div><div class="line"> <span class="number">28</span>:         }</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:         <span class="keyword">super</span>.shutdown();</div><div class="line"> <span class="number">31</span>:     }</div><div class="line"> <span class="number">32</span>: </div><div class="line"> <span class="number">33</span>:     <span class="comment">/**</span></div><div class="line"> 34:      * &#x5269;&#x4F59;&#x9700;&#x8981;&#x91CD;&#x653E;&#x6D88;&#x606F;&#x5B57;&#x8282;&#x6570;</div><div class="line"> 35:      *</div><div class="line"> 36:      * <span class="doctag">@return</span> &#x5B57;&#x8282;&#x6570;</div><div class="line"> 37:      */</div><div class="line"> <span class="number">38</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">behind</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">39</span>:         <span class="keyword">return</span> DefaultMessageStore.<span class="keyword">this</span>.commitLog.getMaxOffset() - <span class="keyword">this</span>.reputFromOffset;</div><div class="line"> <span class="number">40</span>:     }</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:     <span class="comment">/**</span></div><div class="line"> 43:      * &#x662F;&#x5426;commitLog&#x9700;&#x8981;&#x91CD;&#x653E;&#x6D88;&#x606F;</div><div class="line"> 44:      *</div><div class="line"> 45:      * <span class="doctag">@return</span> &#x662F;&#x5426;</div><div class="line"> 46:      */</div><div class="line"> <span class="number">47</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCommitLogAvailable</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">48</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.reputFromOffset &lt; DefaultMessageStore.<span class="keyword">this</span>.commitLog.getMaxOffset();</div><div class="line"> <span class="number">49</span>:     }</div><div class="line"> <span class="number">50</span>: </div><div class="line"> <span class="number">51</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReput</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">52</span>:         <span class="keyword">for</span> (<span class="keyword">boolean</span> doNext = <span class="keyword">true</span>; <span class="keyword">this</span>.isCommitLogAvailable() &amp;&amp; doNext; ) {</div><div class="line"> <span class="number">53</span>: </div><div class="line"> <span class="number">54</span>:             <span class="comment">// TODO &#x7591;&#x95EE;&#xFF1A;&#x8FD9;&#x4E2A;&#x662F;&#x5565;</span></div><div class="line"> <span class="number">55</span>:             <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().isDuplicationEnable() <span class="comment">//</span></div><div class="line"> <span class="number">56</span>:                 &amp;&amp; <span class="keyword">this</span>.reputFromOffset &gt;= DefaultMessageStore.<span class="keyword">this</span>.getConfirmOffset()) {</div><div class="line"> <span class="number">57</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">58</span>:             }</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:             <span class="comment">// &#x83B7;&#x53D6;&#x4ECE;reputFromOffset&#x5F00;&#x59CB;&#x7684;commitLog&#x5BF9;&#x5E94;&#x7684;MappeFile&#x5BF9;&#x5E94;&#x7684;MappedByteBuffer</span></div><div class="line"> <span class="number">61</span>:             SelectMappedBufferResult result = DefaultMessageStore.<span class="keyword">this</span>.commitLog.getData(reputFromOffset);</div><div class="line"> <span class="number">62</span>:             <span class="keyword">if</span> (result != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">63</span>:                 <span class="keyword">try</span> {</div><div class="line"> <span class="number">64</span>:                     <span class="keyword">this</span>.reputFromOffset = result.getStartOffset();</div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:                     <span class="comment">// &#x904D;&#x5386;MappedByteBuffer</span></div><div class="line"> <span class="number">67</span>:                     <span class="keyword">for</span> (<span class="keyword">int</span> readSize = <span class="number">0</span>; readSize &lt; result.getSize() &amp;&amp; doNext; ) {</div><div class="line"> <span class="number">68</span>:                         <span class="comment">// &#x751F;&#x6210;&#x91CD;&#x653E;&#x6D88;&#x606F;&#x91CD;&#x653E;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;</span></div><div class="line"> <span class="number">69</span>:                         DispatchRequest dispatchRequest = DefaultMessageStore.<span class="keyword">this</span>.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line"> <span class="number">70</span>:                         <span class="keyword">int</span> size = dispatchRequest.getMsgSize(); <span class="comment">// &#x6D88;&#x606F;&#x957F;&#x5EA6;</span></div><div class="line"> <span class="number">71</span>:                         <span class="comment">// &#x6839;&#x636E;&#x8BF7;&#x6C42;&#x7684;&#x7ED3;&#x679C;&#x5904;&#x7406;</span></div><div class="line"> <span class="number">72</span>:                         <span class="keyword">if</span> (dispatchRequest.isSuccess()) { <span class="comment">// &#x8BFB;&#x53D6;&#x6210;&#x529F;</span></div><div class="line"> <span class="number">73</span>:                             <span class="keyword">if</span> (size &gt; <span class="number">0</span>) { <span class="comment">// &#x8BFB;&#x53D6;Message</span></div><div class="line"> <span class="number">74</span>:                                 DefaultMessageStore.<span class="keyword">this</span>.doDispatch(dispatchRequest);</div><div class="line"> <span class="number">75</span>:                                 <span class="comment">// &#x901A;&#x77E5;&#x6709;&#x65B0;&#x6D88;&#x606F;</span></div><div class="line"> <span class="number">76</span>:                                 <span class="keyword">if</span> (BrokerRole.SLAVE != DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole()</div><div class="line"> <span class="number">77</span>:                                     &amp;&amp; DefaultMessageStore.<span class="keyword">this</span>.brokerConfig.isLongPollingEnable()) {</div><div class="line"> <span class="number">78</span>:                                     DefaultMessageStore.<span class="keyword">this</span>.messageArrivingListener.arriving(dispatchRequest.getTopic(),</div><div class="line"> <span class="number">79</span>:                                         dispatchRequest.getQueueId(), dispatchRequest.getConsumeQueueOffset() + <span class="number">1</span>,</div><div class="line"> <span class="number">80</span>:                                         dispatchRequest.getTagsCode());</div><div class="line"> <span class="number">81</span>:                                 }</div><div class="line"> <span class="number">82</span>:                                 <span class="comment">// FIXED BUG By shijia</span></div><div class="line"> <span class="number">83</span>:                                 <span class="keyword">this</span>.reputFromOffset += size;</div><div class="line"> <span class="number">84</span>:                                 readSize += size;</div><div class="line"> <span class="number">85</span>:                                 <span class="comment">// &#x7EDF;&#x8BA1;</span></div><div class="line"> <span class="number">86</span>:                                 <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE) {</div><div class="line"> <span class="number">87</span>:                                     DefaultMessageStore.<span class="keyword">this</span>.storeStatsService</div><div class="line"> <span class="number">88</span>:                                         .getSinglePutMessageTopicTimesTotal(dispatchRequest.getTopic()).incrementAndGet();</div><div class="line"> <span class="number">89</span>:                                     DefaultMessageStore.<span class="keyword">this</span>.storeStatsService</div><div class="line"> <span class="number">90</span>:                                         .getSinglePutMessageTopicSizeTotal(dispatchRequest.getTopic())</div><div class="line"> <span class="number">91</span>:                                         .addAndGet(dispatchRequest.getMsgSize());</div><div class="line"> <span class="number">92</span>:                                 }</div><div class="line"> <span class="number">93</span>:                             } <span class="keyword">else</span> <span class="keyword">if</span> (size == <span class="number">0</span>) { <span class="comment">// &#x8BFB;&#x53D6;&#x5230;MappedFile&#x6587;&#x4EF6;&#x5C3E;</span></div><div class="line"> <span class="number">94</span>:                                 <span class="keyword">this</span>.reputFromOffset = DefaultMessageStore.<span class="keyword">this</span>.commitLog.rollNextFile(<span class="keyword">this</span>.reputFromOffset);</div><div class="line"> <span class="number">95</span>:                                 readSize = result.getSize();</div><div class="line"> <span class="number">96</span>:                             }</div><div class="line"> <span class="number">97</span>:                         } <span class="keyword">else</span> <span class="keyword">if</span> (!dispatchRequest.isSuccess()) { <span class="comment">// &#x8BFB;&#x53D6;&#x5931;&#x8D25;</span></div><div class="line"> <span class="number">98</span>:                             <span class="keyword">if</span> (size &gt; <span class="number">0</span>) { <span class="comment">// &#x8BFB;&#x53D6;&#x5230;Message&#x5374;&#x4E0D;&#x662F;Message</span></div><div class="line"> <span class="number">99</span>:                                 log.error(<span class="string">&quot;[BUG]read total count not equals msg total size. reputFromOffset={}&quot;</span>, reputFromOffset);</div><div class="line"><span class="number">100</span>:                                 <span class="keyword">this</span>.reputFromOffset += size;</div><div class="line"><span class="number">101</span>:                             } <span class="keyword">else</span> { <span class="comment">// &#x8BFB;&#x53D6;&#x5230;Blank&#x5374;&#x4E0D;&#x662F;Blank</span></div><div class="line"><span class="number">102</span>:                                 doNext = <span class="keyword">false</span>;</div><div class="line"><span class="number">103</span>:                                 <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.brokerConfig.getBrokerId() == MixAll.MASTER_ID) {</div><div class="line"><span class="number">104</span>:                                     log.error(<span class="string">&quot;[BUG]the master dispatch message to consume queue error, COMMITLOG OFFSET: {}&quot;</span>,</div><div class="line"><span class="number">105</span>:                                         <span class="keyword">this</span>.reputFromOffset);</div><div class="line"><span class="number">106</span>: </div><div class="line"><span class="number">107</span>:                                     <span class="keyword">this</span>.reputFromOffset += result.getSize() - readSize;</div><div class="line"><span class="number">108</span>:                                 }</div><div class="line"><span class="number">109</span>:                             }</div><div class="line"><span class="number">110</span>:                         }</div><div class="line"><span class="number">111</span>:                     }</div><div class="line"><span class="number">112</span>:                 } <span class="keyword">finally</span> {</div><div class="line"><span class="number">113</span>:                     result.release();</div><div class="line"><span class="number">114</span>:                 }</div><div class="line"><span class="number">115</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">116</span>:                 doNext = <span class="keyword">false</span>;</div><div class="line"><span class="number">117</span>:             }</div><div class="line"><span class="number">118</span>:         }</div><div class="line"><span class="number">119</span>:     }</div><div class="line"><span class="number">120</span>: </div><div class="line"><span class="number">121</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">122</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">123</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service started&quot;</span>);</div><div class="line"><span class="number">124</span>: </div><div class="line"><span class="number">125</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) {</div><div class="line"><span class="number">126</span>:             <span class="keyword">try</span> {</div><div class="line"><span class="number">127</span>:                 Thread.sleep(<span class="number">1</span>);</div><div class="line"><span class="number">128</span>:                 <span class="keyword">this</span>.doReput();</div><div class="line"><span class="number">129</span>:             } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">130</span>:                 DefaultMessageStore.log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service has exception. &quot;</span>, e);</div><div class="line"><span class="number">131</span>:             }</div><div class="line"><span class="number">132</span>:         }</div><div class="line"><span class="number">133</span>: </div><div class="line"><span class="number">134</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service end&quot;</span>);</div><div class="line"><span class="number">135</span>:     }</div><div class="line"><span class="number">136</span>: </div><div class="line"><span class="number">137</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">138</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">139</span>:         <span class="keyword">return</span> ReputMessageService.class.getSimpleName();</div><div class="line"><span class="number">140</span>:     }</div><div class="line"><span class="number">141</span>: </div><div class="line"><span class="number">142</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E;&#xFF1A;&#x91CD;&#x653E;&#x6D88;&#x606F;&#x7EBF;&#x7A0B;&#x670D;&#x52A1;&#x3002;<ul>
<li>&#x8BE5;&#x670D;&#x52A1;&#x4E0D;&#x65AD;&#x751F;&#x6210; &#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F; &#x5230; &#x6D88;&#x8D39;&#x961F;&#x5217;(ConsumeQueue)</li>
<li>&#x8BE5;&#x670D;&#x52A1;&#x4E0D;&#x65AD;&#x751F;&#x6210; &#x6D88;&#x606F;&#x7D22;&#x5F15; &#x5230; &#x7D22;&#x5F15;&#x6587;&#x4EF6;(IndexFile)    </li>
</ul>
</li>
<li><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/11.png" alt="ReputMessageService&#x7528;&#x4F8B;&#x56FE;"><ul>
<li>&#x7B2C; 61 &#x884C; &#xFF1A;&#x83B7;&#x53D6; <code>reputFromOffset</code> &#x5F00;&#x59CB;&#x7684; <code>CommitLog</code> &#x5BF9;&#x5E94;&#x7684; <code>MappedFile</code> &#x5BF9;&#x5E94;&#x7684; <code>MappedByteBuffer</code>&#x3002;</li>
<li>&#x7B2C; 67 &#x884C; &#xFF1A;&#x904D;&#x5386; <code>MappedByteBuffer</code>&#x3002;</li>
<li>&#x7B2C; 69 &#x884C; &#xFF1A;&#x751F;&#x6210;&#x91CD;&#x653E;&#x6D88;&#x606F;&#x91CD;&#x653E;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42; (<code>DispatchRequest</code>) &#x3002;&#x8BF7;&#x6C42;&#x91CC;&#x4E3B;&#x8981;&#x5305;&#x542B;&#x4E00;&#x6761;&#x6D88;&#x606F; (<code>Message</code>) &#x6216;&#x8005; &#x6587;&#x4EF6;&#x5C3E; (<code>BLANK</code>) &#x7684;&#x57FA;&#x672C;&#x4FE1;&#x606F;&#x3002;</li>
<li>&#x7B2C; 72 &#x81F3; 96 &#x884C; &#xFF1A;&#x8BF7;&#x6C42;&#x662F;&#x6709;&#x6548;&#x8BF7;&#x6C42;&#xFF0C;&#x8FDB;&#x884C;&#x903B;&#x8F91;&#x5904;&#x7406;&#x3002;<ul>
<li>&#x7B2C; 75 &#x81F3; 81 &#x884C; &#xFF1A;&#x5F53; <code>Broker</code> &#x662F;&#x4E3B;&#x8282;&#x70B9; &amp;&amp; <code>Broker</code> &#x5F00;&#x542F;&#x7684;&#x662F;&#x957F;&#x8F6E;&#x8BE2;&#xFF0C;&#x901A;&#x77E5;&#x6D88;&#x8D39;&#x961F;&#x5217;&#x6709;&#x65B0;&#x7684;&#x6D88;&#x606F;&#x3002;<code>NotifyMessageArrivingListener</code> &#x4F1A; &#x8C03;&#x7528; <code>PullRequestHoldService#notifyMessageArriving(...)</code> &#x65B9;&#x6CD5;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#pullrequestholdservice">PullRequestHoldService</a></li>
</ul>
</li>
<li>&#x7B2C; 73 &#x81F3; 92 &#x884C; &#xFF1A;&#x8BF7;&#x6C42;&#x5BF9;&#x5E94;&#x7684;&#x662F; <code>Message</code>&#xFF0C;&#x8FDB;&#x884C;&#x8C03;&#x5EA6;&#xFF0C;&#x751F;&#x6210; <code>ConsumeQueue</code> &#x548C; <code>IndexFile</code> &#x5BF9;&#x5E94;&#x7684;&#x5185;&#x5BB9;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;</li>
<li>&#x7B2C; 93 &#x81F3; 96 &#x884C; &#xFF1A;&#x8BF7;&#x6C42;&#x5BF9;&#x5E94;&#x7684;&#x662F; <code>Blank</code>&#xFF0C;&#x5373;&#x6587;&#x4EF6;&#x5C3E;&#xFF0C;&#x8DF3;&#x8F6C;&#x6307;&#x5411;&#x4E0B;&#x4E00;&#x4E2A; <code>MappedFile</code>&#x3002;</li>
<li>&#x7B2C; 97 &#x81F3; 110 &#x884C; &#xFF1A;&#x8BF7;&#x6C42;&#x662F;&#x65E0;&#x6548;&#x8BF7;&#x6C42;&#x3002;&#x51FA;&#x73B0;&#x8BE5;&#x60C5;&#x51B5;&#xFF0C;&#x57FA;&#x672C;&#x662F;&#x4E00;&#x4E2A;<strong>BUG</strong>&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 127 &#x81F3; 128 &#x884C; &#xFF1A;&#x6BCF; 1ms &#x5FAA;&#x73AF;&#x6267;&#x884C;&#x91CD;&#x653E;&#x903B;&#x8F91;&#x3002;</li>
<li>&#x7B2C; 18 &#x81F3; 30 &#x884C; &#xFF1A;<code>shutdown</code>&#x65F6;&#xFF0C;&#x591A;&#x6B21; <code>sleep(100)</code> &#x76F4;&#x5230; <code>CommitLog</code> &#x56DE;&#x653E;&#x5230;&#x6700;&#x65B0;&#x4F4D;&#x7F6E;&#x3002;&#x6069;&#xFF0C;&#x5982;&#x679C;&#x672A;&#x56DE;&#x653E;&#x5B8C;&#xFF0C;&#x4F1A;&#x8F93;&#x51FA;&#x8B66;&#x544A;&#x65E5;&#x5FD7;&#x3002;</li>
</ul>
<h3 id="DefaultMessageStore-doDispatch-&#x2026;"><a href="#DefaultMessageStore-doDispatch-&#x2026;" class="headerlink" title="DefaultMessageStore#doDispatch(&#x2026;)"></a>DefaultMessageStore#doDispatch(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * &#x6267;&#x884C;&#x8C03;&#x5EA6;&#x8BF7;&#x6C42;</div><div class="line"> 3:  * 1. &#x975E;&#x4E8B;&#x52A1;&#x6D88;&#x606F; &#x6216; &#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#x6D88;&#x606F; &#x5EFA;&#x7ACB; &#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F; &#x5230; ConsumeQueue</div><div class="line"> 4:  * 2. &#x5EFA;&#x7ACB; &#x7D22;&#x5F15;&#x4FE1;&#x606F; &#x5230; IndexFile</div><div class="line"> 5:  *</div><div class="line"> 6:  * <span class="doctag">@param</span> req &#x8C03;&#x5EA6;&#x8BF7;&#x6C42;</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(DispatchRequest req)</span> </span>{</div><div class="line"> <span class="number">9</span>:     <span class="comment">// &#x975E;&#x4E8B;&#x52A1;&#x6D88;&#x606F; &#x6216; &#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#x6D88;&#x606F; &#x5EFA;&#x7ACB; &#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F; &#x5230; ConsumeQueue</span></div><div class="line"><span class="number">10</span>:     <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(req.getSysFlag());</div><div class="line"><span class="number">11</span>:     <span class="keyword">switch</span> (tranType) {</div><div class="line"><span class="number">12</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</div><div class="line"><span class="number">13</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</div><div class="line"><span class="number">14</span>:             DefaultMessageStore.<span class="keyword">this</span>.putMessagePositionInfo(req.getTopic(), req.getQueueId(), req.getCommitLogOffset(), req.getMsgSize(),</div><div class="line"><span class="number">15</span>:                 req.getTagsCode(), req.getStoreTimestamp(), req.getConsumeQueueOffset());</div><div class="line"><span class="number">16</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">17</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</div><div class="line"><span class="number">18</span>:         <span class="keyword">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</div><div class="line"><span class="number">19</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">20</span>:     }</div><div class="line"><span class="number">21</span>:     <span class="comment">// &#x5EFA;&#x7ACB; &#x7D22;&#x5F15;&#x4FE1;&#x606F; &#x5230; IndexFile</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().isMessageIndexEnable()) {</div><div class="line"><span class="number">23</span>:         DefaultMessageStore.<span class="keyword">this</span>.indexService.buildIndex(req);</div><div class="line"><span class="number">24</span>:     }</div><div class="line"><span class="number">25</span>: }</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>: <span class="comment">/**</span></div><div class="line">28:  * &#x5EFA;&#x7ACB; &#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F; &#x5230; ConsumeQueue</div><div class="line">29:  *</div><div class="line">30:  * <span class="doctag">@param</span> topic &#x4E3B;&#x9898;</div><div class="line">31:  * <span class="doctag">@param</span> queueId &#x961F;&#x5217;&#x7F16;&#x53F7;</div><div class="line">32:  * <span class="doctag">@param</span> offset commitLog&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;</div><div class="line">33:  * <span class="doctag">@param</span> size &#x6D88;&#x606F;&#x957F;&#x5EA6;</div><div class="line">34:  * <span class="doctag">@param</span> tagsCode &#x6D88;&#x606F;tagsCode</div><div class="line">35:  * <span class="doctag">@param</span> storeTimestamp &#x5B58;&#x50A8;&#x65F6;&#x95F4;</div><div class="line">36:  * <span class="doctag">@param</span> logicOffset &#x961F;&#x5217;&#x4F4D;&#x7F6E;</div><div class="line">37:  */</div><div class="line"><span class="number">38</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putMessagePositionInfo</span><span class="params">(String topic, <span class="keyword">int</span> queueId, <span class="keyword">long</span> offset, <span class="keyword">int</span> size, <span class="keyword">long</span> tagsCode, <span class="keyword">long</span> storeTimestamp,</span></span></div><div class="line"><span class="number">39</span>:     <span class="keyword">long</span> logicOffset) {</div><div class="line"><span class="number">40</span>:     ConsumeQueue cq = <span class="keyword">this</span>.findConsumeQueue(topic, queueId);</div><div class="line"><span class="number">41</span>:     cq.putMessagePositionInfoWrapper(offset, size, tagsCode, storeTimestamp, logicOffset);</div><div class="line"><span class="number">42</span>: }</div></pre></td></tr></table></figure>
<h3 id="ConsumeQueue-putMessagePositionInfoWrapper-&#x2026;"><a href="#ConsumeQueue-putMessagePositionInfoWrapper-&#x2026;" class="headerlink" title="ConsumeQueue#putMessagePositionInfoWrapper(&#x2026;)"></a>ConsumeQueue#putMessagePositionInfoWrapper(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line">  2:  * &#x6DFB;&#x52A0;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#x5C01;&#x88C5;</div><div class="line">  3:  *</div><div class="line">  4:  * <span class="doctag">@param</span> offset commitLog&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;</div><div class="line">  5:  * <span class="doctag">@param</span> size &#x6D88;&#x606F;&#x957F;&#x5EA6;</div><div class="line">  6:  * <span class="doctag">@param</span> tagsCode &#x6D88;&#x606F;tagsCode</div><div class="line">  7:  * <span class="doctag">@param</span> storeTimestamp &#x6D88;&#x606F;&#x5B58;&#x50A8;&#x65F6;&#x95F4;</div><div class="line">  8:  * <span class="doctag">@param</span> logicOffset &#x961F;&#x5217;&#x4F4D;&#x7F6E;</div><div class="line">  9:  */</div><div class="line"> <span class="number">10</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putMessagePositionInfoWrapper</span><span class="params">(<span class="keyword">long</span> offset, <span class="keyword">int</span> size, <span class="keyword">long</span> tagsCode, <span class="keyword">long</span> storeTimestamp,</span></span></div><div class="line"> <span class="number">11</span>:     <span class="keyword">long</span> logicOffset) {</div><div class="line"> <span class="number">12</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxRetries = <span class="number">30</span>;</div><div class="line"> <span class="number">13</span>:     <span class="keyword">boolean</span> canWrite = <span class="keyword">this</span>.defaultMessageStore.getRunningFlags().isWriteable();</div><div class="line"> <span class="number">14</span>:     <span class="comment">// &#x591A;&#x6B21;&#x5FAA;&#x73AF;&#x5199;&#xFF0C;&#x76F4;&#x5230;&#x6210;&#x529F;</span></div><div class="line"> <span class="number">15</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; maxRetries &amp;&amp; canWrite; i++) {</div><div class="line"> <span class="number">16</span>:         <span class="comment">// &#x8C03;&#x7528;&#x6DFB;&#x52A0;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;</span></div><div class="line"> <span class="number">17</span>:         <span class="keyword">boolean</span> result = <span class="keyword">this</span>.putMessagePositionInfo(offset, size, tagsCode, logicOffset);</div><div class="line"> <span class="number">18</span>:         <span class="keyword">if</span> (result) {</div><div class="line"> <span class="number">19</span>:             <span class="comment">// &#x6DFB;&#x52A0;&#x6210;&#x529F;&#xFF0C;&#x4F7F;&#x7528;&#x6D88;&#x606F;&#x5B58;&#x50A8;&#x65F6;&#x95F4; &#x4F5C;&#x4E3A; &#x5B58;&#x50A8;check point&#x3002;</span></div><div class="line"> <span class="number">20</span>:             <span class="keyword">this</span>.defaultMessageStore.getStoreCheckpoint().setLogicsMsgTimestamp(storeTimestamp);</div><div class="line"> <span class="number">21</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">22</span>:         } <span class="keyword">else</span> {</div><div class="line"> <span class="number">23</span>:             <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"> <span class="number">24</span>:             log.warn(<span class="string">&quot;[BUG]put commit log position info to &quot;</span> + topic + <span class="string">&quot;:&quot;</span> + queueId + <span class="string">&quot; &quot;</span> + offset</div><div class="line"> <span class="number">25</span>:                 + <span class="string">&quot; failed, retry &quot;</span> + i + <span class="string">&quot; times&quot;</span>);</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:             <span class="keyword">try</span> {</div><div class="line"> <span class="number">28</span>:                 Thread.sleep(<span class="number">1000</span>);</div><div class="line"> <span class="number">29</span>:             } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"> <span class="number">30</span>:                 log.warn(<span class="string">&quot;&quot;</span>, e);</div><div class="line"> <span class="number">31</span>:             }</div><div class="line"> <span class="number">32</span>:         }</div><div class="line"> <span class="number">33</span>:     }</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:     <span class="comment">// <span class="doctag">XXX:</span> warn and notify me &#x8BBE;&#x7F6E;&#x5F02;&#x5E38;&#x4E0D;&#x53EF;&#x5199;&#x5165;</span></div><div class="line"> <span class="number">36</span>:     log.error(<span class="string">&quot;[BUG]consume queue can not write, {} {}&quot;</span>, <span class="keyword">this</span>.topic, <span class="keyword">this</span>.queueId);</div><div class="line"> <span class="number">37</span>:     <span class="keyword">this</span>.defaultMessageStore.getRunningFlags().makeLogicsQueueError();</div><div class="line"> <span class="number">38</span>: }</div><div class="line"> <span class="number">39</span>: </div><div class="line"> <span class="number">40</span>: <span class="comment">/**</span></div><div class="line"> 41:  * &#x6DFB;&#x52A0;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x6DFB;&#x52A0;&#x662F;&#x5426;&#x6210;&#x529F;</div><div class="line"> 42:  *</div><div class="line"> 43:  * <span class="doctag">@param</span> offset commitLog&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;</div><div class="line"> 44:  * <span class="doctag">@param</span> size &#x6D88;&#x606F;&#x957F;&#x5EA6;</div><div class="line"> 45:  * <span class="doctag">@param</span> tagsCode &#x6D88;&#x606F;tagsCode</div><div class="line"> 46:  * <span class="doctag">@param</span> cqOffset &#x961F;&#x5217;&#x4F4D;&#x7F6E;</div><div class="line"> 47:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x6210;&#x529F;</div><div class="line"> 48:  */</div><div class="line"> <span class="number">49</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">putMessagePositionInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> offset, <span class="keyword">final</span> <span class="keyword">int</span> size, <span class="keyword">final</span> <span class="keyword">long</span> tagsCode,</span></span></div><div class="line"> <span class="number">50</span>:     <span class="keyword">final</span> <span class="keyword">long</span> cqOffset) {</div><div class="line"> <span class="number">51</span>:     <span class="comment">// &#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x91CD;&#x653E;&#x8FC7;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x6210;&#x529F;</span></div><div class="line"> <span class="number">52</span>:     <span class="keyword">if</span> (offset &lt;= <span class="keyword">this</span>.maxPhysicOffset) {</div><div class="line"> <span class="number">53</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> <span class="number">54</span>:     }</div><div class="line"> <span class="number">55</span>:     <span class="comment">// &#x5199;&#x5165;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#x5230;byteBuffer</span></div><div class="line"> <span class="number">56</span>:     <span class="keyword">this</span>.byteBufferIndex.flip();</div><div class="line"> <span class="number">57</span>:     <span class="keyword">this</span>.byteBufferIndex.limit(CQ_STORE_UNIT_SIZE);</div><div class="line"> <span class="number">58</span>:     <span class="keyword">this</span>.byteBufferIndex.putLong(offset);</div><div class="line"> <span class="number">59</span>:     <span class="keyword">this</span>.byteBufferIndex.putInt(size);</div><div class="line"> <span class="number">60</span>:     <span class="keyword">this</span>.byteBufferIndex.putLong(tagsCode);</div><div class="line"> <span class="number">61</span>:     <span class="comment">// &#x8BA1;&#x7B97;consumeQueue&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;&#xFF0C;&#x5E76;&#x83B7;&#x5F97;&#x5BF9;&#x5E94;&#x7684;MappedFile</span></div><div class="line"> <span class="number">62</span>:     <span class="keyword">final</span> <span class="keyword">long</span> expectLogicOffset = cqOffset * CQ_STORE_UNIT_SIZE;</div><div class="line"> <span class="number">63</span>:     MappedFile mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile(expectLogicOffset);</div><div class="line"> <span class="number">64</span>:     <span class="keyword">if</span> (mappedFile != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">65</span>:         <span class="comment">// &#x5F53;&#x662F;ConsumeQueue&#x7B2C;&#x4E00;&#x4E2A;MappedFile &amp;&amp; &#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x975E;&#x7B2C;&#x4E00;&#x4E2A; &amp;&amp; MappedFile&#x672A;&#x5199;&#x5165;&#x5185;&#x5BB9;&#xFF0C;&#x5219;&#x586B;&#x5145;&#x524D;&#x7F6E;&#x7A7A;&#x767D;&#x5360;&#x4F4D;</span></div><div class="line"> <span class="number">66</span>:         <span class="keyword">if</span> (mappedFile.isFirstCreateInQueue() &amp;&amp; cqOffset != <span class="number">0</span> &amp;&amp; mappedFile.getWrotePosition() == <span class="number">0</span>) { <span class="comment">// TODO &#x7591;&#x95EE;&#xFF1A;&#x4E3A;&#x5565;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x3002;&#x76EE;&#x524D;&#x80FD;&#x591F;&#x60F3;&#x8C61;&#x5230;&#x7684;&#x662F;&#xFF0C;&#x4E00;&#x4E9B;&#x8001;&#x7684;&#x6D88;&#x606F;&#x5F88;&#x4E45;&#x6CA1;&#x53D1;&#x9001;&#xFF0C;&#x7A81;&#x7136;&#x53D1;&#x9001;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x521A;&#x597D;&#x6EE1;&#x8DB3;&#x3002;</span></div><div class="line"> <span class="number">67</span>:             <span class="keyword">this</span>.minLogicOffset = expectLogicOffset;</div><div class="line"> <span class="number">68</span>:             <span class="keyword">this</span>.mappedFileQueue.setFlushedWhere(expectLogicOffset);</div><div class="line"> <span class="number">69</span>:             <span class="keyword">this</span>.mappedFileQueue.setCommittedWhere(expectLogicOffset);</div><div class="line"> <span class="number">70</span>:             <span class="keyword">this</span>.fillPreBlank(mappedFile, expectLogicOffset);</div><div class="line"> <span class="number">71</span>:             log.info(<span class="string">&quot;fill pre blank space &quot;</span> + mappedFile.getFileName() + <span class="string">&quot; &quot;</span> + expectLogicOffset + <span class="string">&quot; &quot;</span></div><div class="line"> <span class="number">72</span>:                 + mappedFile.getWrotePosition());</div><div class="line"> <span class="number">73</span>:         }</div><div class="line"> <span class="number">74</span>:         <span class="comment">// &#x6821;&#x9A8C;consumeQueue&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;&#x662F;&#x5426;&#x5408;&#x6CD5;&#x3002;TODO &#x5982;&#x679C;&#x4E0D;&#x5408;&#x6CD5;&#xFF0C;&#x7EE7;&#x7EED;&#x5199;&#x5165;&#x4F1A;&#x4E0D;&#x4F1A;&#x6709;&#x95EE;&#x9898;&#xFF1F;</span></div><div class="line"> <span class="number">75</span>:         <span class="keyword">if</span> (cqOffset != <span class="number">0</span>) {</div><div class="line"> <span class="number">76</span>:             <span class="keyword">long</span> currentLogicOffset = mappedFile.getWrotePosition() + mappedFile.getFileFromOffset();</div><div class="line"> <span class="number">77</span>:             <span class="keyword">if</span> (expectLogicOffset != currentLogicOffset) {</div><div class="line"> <span class="number">78</span>:                 LOG_ERROR.warn(</div><div class="line"> <span class="number">79</span>:                     <span class="string">&quot;[BUG]logic queue order maybe wrong, expectLogicOffset: {} currentLogicOffset: {} Topic: {} QID: {} Diff: {}&quot;</span>,</div><div class="line"> <span class="number">80</span>:                     expectLogicOffset,</div><div class="line"> <span class="number">81</span>:                     currentLogicOffset,</div><div class="line"> <span class="number">82</span>:                     <span class="keyword">this</span>.topic,</div><div class="line"> <span class="number">83</span>:                     <span class="keyword">this</span>.queueId,</div><div class="line"> <span class="number">84</span>:                     expectLogicOffset - currentLogicOffset</div><div class="line"> <span class="number">85</span>:                 );</div><div class="line"> <span class="number">86</span>:             }</div><div class="line"> <span class="number">87</span>:         }</div><div class="line"> <span class="number">88</span>:         <span class="comment">// &#x8BBE;&#x7F6E;commitLog&#x91CD;&#x653E;&#x6D88;&#x606F;&#x5230;ConsumeQueue&#x4F4D;&#x7F6E;&#x3002;</span></div><div class="line"> <span class="number">89</span>:         <span class="keyword">this</span>.maxPhysicOffset = offset;</div><div class="line"> <span class="number">90</span>:         <span class="comment">// &#x63D2;&#x5165;mappedFile</span></div><div class="line"> <span class="number">91</span>:         <span class="keyword">return</span> mappedFile.appendMessage(<span class="keyword">this</span>.byteBufferIndex.array());</div><div class="line"> <span class="number">92</span>:     }</div><div class="line"> <span class="number">93</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> <span class="number">94</span>: }</div><div class="line"> <span class="number">95</span>: </div><div class="line"> <span class="number">96</span>: <span class="comment">/**</span></div><div class="line"> 97:  * &#x586B;&#x5145;&#x524D;&#x7F6E;&#x7A7A;&#x767D;&#x5360;&#x4F4D;</div><div class="line"> 98:  *</div><div class="line"> 99:  * <span class="doctag">@param</span> mappedFile MappedFile</div><div class="line">100:  * <span class="doctag">@param</span> untilWhere consumeQueue&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;</div><div class="line">101:  */</div><div class="line"><span class="number">102</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fillPreBlank</span><span class="params">(<span class="keyword">final</span> MappedFile mappedFile, <span class="keyword">final</span> <span class="keyword">long</span> untilWhere)</span> </span>{</div><div class="line"><span class="number">103</span>:     <span class="comment">// &#x5199;&#x5165;&#x524D;&#x7F6E;&#x7A7A;&#x767D;&#x5360;&#x4F4D;&#x5230;byteBuffer</span></div><div class="line"><span class="number">104</span>:     ByteBuffer byteBuffer = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);</div><div class="line"><span class="number">105</span>:     byteBuffer.putLong(<span class="number">0L</span>);</div><div class="line"><span class="number">106</span>:     byteBuffer.putInt(Integer.MAX_VALUE);</div><div class="line"><span class="number">107</span>:     byteBuffer.putLong(<span class="number">0L</span>);</div><div class="line"><span class="number">108</span>:     <span class="comment">// &#x5FAA;&#x73AF;&#x586B;&#x7A7A;</span></div><div class="line"><span class="number">109</span>:     <span class="keyword">int</span> until = (<span class="keyword">int</span>) (untilWhere % <span class="keyword">this</span>.mappedFileQueue.getMappedFileSize());</div><div class="line"><span class="number">110</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; until; i += CQ_STORE_UNIT_SIZE) {</div><div class="line"><span class="number">111</span>:         mappedFile.appendMessage(byteBuffer.array());</div><div class="line"><span class="number">112</span>:     }</div><div class="line"><span class="number">113</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li><code>#putMessagePositionInfoWrapper(...)</code> &#x8BF4;&#x660E; &#xFF1A;&#x6DFB;&#x52A0;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#x5230; <code>ConsumeQueue</code> &#x7684;&#x5C01;&#x88C5;&#xFF0C;&#x5B9E;&#x9645;&#x9700;&#x8981;&#x8C03;&#x7528; <code>#putMessagePositionInfo(...)</code> &#x65B9;&#x6CD5;&#x3002;<ul>
<li>&#x7B2C; 13 &#x884C; &#xFF1A;&#x5224;&#x65AD; <code>ConsumeQueue</code> &#x662F;&#x5426;&#x5141;&#x8BB8;&#x5199;&#x5165;&#x3002;&#x5F53;&#x53D1;&#x751F;Bug&#x65F6;&#xFF0C;&#x4E0D;&#x5141;&#x8BB8;&#x5199;&#x5165;&#x3002;</li>
<li>&#x7B2C; 17 &#x884C; &#xFF1A;&#x8C03;&#x7528; <code>#putMessagePositionInfo(...)</code> &#x65B9;&#x6CD5;&#xFF0C;&#x6DFB;&#x52A0;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#x3002;</li>
<li>&#x7B2C; 18 &#x81F3; 21 &#x884C; &#xFF1A;&#x6DFB;&#x52A0;&#x6210;&#x529F;&#xFF0C;&#x4F7F;&#x7528;&#x6D88;&#x606F;&#x5B58;&#x50A8;&#x65F6;&#x95F4; &#x4F5C;&#x4E3A; &#x5B58;&#x50A8;&#x68C0;&#x67E5;&#x70B9;&#x3002;<code>StoreCheckpoint</code> &#x7684;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/store-init-and-shutdown/">Store&#x521D;&#x59CB;&#x5316;&#x4E0E;&#x5173;&#x95ED;</a>&#x3002;</li>
<li>&#x7B2C; 22 &#x81F3; 32 &#x884C; &#xFF1A;&#x6DFB;&#x52A0;&#x5931;&#x8D25;&#xFF0C;&#x76EE;&#x524D;&#x57FA;&#x672C;&#x53EF;&#x4EE5;&#x8BA4;&#x4E3A;&#x662F;BUG&#x3002;</li>
<li>&#x7B2C; 35 &#x81F3; 37 &#x884C; &#xFF1A;&#x5199;&#x5165;&#x5931;&#x8D25;&#x65F6;&#xFF0C;&#x6807;&#x8BB0; <code>ConsumeQueue</code> &#x5199;&#x5165;&#x5F02;&#x5E38;&#xFF0C;&#x4E0D;&#x5141;&#x8BB8;&#x7EE7;&#x7EED;&#x5199;&#x5165;&#x3002;</li>
</ul>
</li>
<li><code>#putMessagePositionInfo(...)</code> &#x8BF4;&#x660E; &#xFF1A;&#x6DFB;&#x52A0;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#x5230; <code>ConsumeQueue</code>&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x6DFB;&#x52A0;&#x662F;&#x5426;&#x6210;&#x529F;&#x3002;<ul>
<li>&#x7B2C; 51 &#x81F3; 54 &#x884C; &#xFF1A;&#x5982;&#x679C; <code>offset</code>(&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;) &#x5C0F;&#x4E8E;&#x7B49;&#x4E8E;  <code>maxPhysicOffset</code>(<code>CommitLog</code> &#x6D88;&#x606F;&#x91CD;&#x653E;&#x5230; <code>ConsumeQueue</code> &#x6700;&#x5927;&#x7684; <code>CommitLog</code> &#x5B58;&#x50A8;&#x4F4D;&#x7F6E;)&#xFF0C;&#x8868;&#x793A;&#x5DF2;&#x7ECF;&#x91CD;&#x653E;&#x8FC7;&#xFF0C;&#x6B64;&#x65F6;&#xFF0C;&#x4E0D;&#x518D;&#x91CD;&#x590D;&#x5199;&#x5165;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x5199;&#x5165;&#x6210;&#x529F;&#x3002;</li>
<li>&#x7B2C; 55 &#x81F3; 60 &#x884C; &#xFF1A;&#x5199; &#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#x5230;byteBuffer&#x3002;</li>
<li>&#x7B2C; 62 &#x81F3; 63 &#x884C; &#xFF1A;&#x8BA1;&#x7B97; <code>ConsumeQueue</code>&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;&#xFF0C;&#x5E76;&#x83B7;&#x5F97;&#x5BF9;&#x5E94;&#x7684;MappedFile&#x3002;</li>
<li>&#x7B2C; 65 &#x81F3; 73 &#x884C; &#xFF1A;&#x5F53; <code>MappedFile</code> &#x662F; <code>ConsumeQueue</code> &#x5F53;&#x524D;&#x7B2C;&#x4E00;&#x4E2A;&#x6587;&#x4EF6; &amp;&amp; <code>MappedFile</code> &#x672A;&#x5199;&#x5165;&#x5185;&#x5BB9; &amp;&amp; &#x91CD;&#x653E;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x5927;&#x4E8E;0&#xFF0C;&#x5219;&#x9700;&#x8981;&#x8FDB;&#x884C; <code>MappedFile</code> &#x586B;&#x5145;&#x524D;&#x7F6E;  <code>BLANK</code>&#x3002;<ul>
<li><em>&#x8FD9;&#x5757;&#x6BD4;&#x8F83;&#x6709;&#x7591;&#x95EE;&#xFF0C;&#x4EC0;&#x4E48;&#x573A;&#x666F;&#x4E0B;&#x4F1A;&#x9700;&#x8981;&#x3002;&#x731C;&#x6D4B;&#x4EA7;&#x751F;&#x7684;&#x539F;&#x56E0;&#xFF1A;&#x4E00;&#x4E2A; <code>Topic</code> &#x957F;&#x671F;&#x65E0;&#x6D88;&#x606F;&#x4EA7;&#x751F;&#xFF0C;&#x7A81;&#x7136;N&#x5929;&#x540E;&#x8FDB;&#x884C;&#x53D1;&#x9001;&#xFF0C;<code>Topic</code> &#x5BF9;&#x5E94;&#x7684;&#x5386;&#x53F2;&#x6D88;&#x606F;&#x4EE5;&#x53CA;&#x548C;&#x6D88;&#x8D39;&#x961F;&#x5217;&#x6570;&#x636E;&#x5DF2;&#x7ECF;&#x88AB;&#x6E05;&#x7406;&#xFF0C;&#x65B0;&#x751F;&#x6210;&#x7684;<code>MappedFile</code>&#x9700;&#x8981;&#x524D;&#x7F6E;&#x5360;&#x4F4D;&#x3002;</em></li>
</ul>
</li>
<li>&#x7B2C; 74 &#x81F3; 87 &#x884C; &#xFF1A;&#x6821;&#x9A8C; <code>ConsumeQueue</code> &#x5B58;&#x50A8;&#x4F4D;&#x7F6E;&#x662F;&#x5426;&#x5408;&#x6CD5;&#xFF0C;&#x4E0D;&#x5408;&#x6CD5;&#x5219;&#x8F93;&#x51FA;&#x65E5;&#x5FD7;&#x3002;<ul>
<li><em>&#x8FD9;&#x5757;&#x6BD4;&#x8F83;&#x6709;&#x7591;&#x95EE;&#xFF0C;&#x5982;&#x679C;&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#x7684;&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;&#x4E0D;&#x5408;&#x6CD5;&#xFF0C;&#x4E0D;&#x8FD4;&#x56DE;&#x6DFB;&#x52A0;&#x5931;&#x8D25;&#xFF0C;&#x7EE7;&#x7EED;&#x8FDB;&#x884C;&#x6DFB;&#x52A0;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x6709;&#x95EE;&#x9898;&#xFF1F;&#xFF1F;&#xFF1F;</em></li>
</ul>
</li>
<li>&#x7B2C; 89 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E; <code>CommitLog</code> &#x91CD;&#x653E;&#x6D88;&#x606F;&#x5230; <code>ConsumeQueue</code> &#x7684;&#x6700;&#x5927;&#x4F4D;&#x7F6E;&#x3002;</li>
<li>&#x7B2C; 91 &#x884C; &#xFF1A;&#x63D2;&#x5165;&#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x5230; <code>MappedFile</code>&#x3002;</li>
</ul>
</li>
</ul>
<h2 id="FlushConsumeQueueService"><a href="#FlushConsumeQueueService" class="headerlink" title="FlushConsumeQueueService"></a>FlushConsumeQueueService</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">FlushConsumeQueueService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RETRY_TIMES_OVER = <span class="number">3</span>;</div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * &#x6700;&#x540E;flush&#x65F6;&#x95F4;&#x6233;</div><div class="line"> 5:      */</div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">long</span> lastFlushTimestamp = <span class="number">0</span>;</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doFlush</span><span class="params">(<span class="keyword">int</span> retryTimes)</span> </span>{</div><div class="line"> <span class="number">9</span>:         <span class="keyword">int</span> flushConsumeQueueLeastPages = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushConsumeQueueLeastPages();</div><div class="line"><span class="number">10</span>: </div><div class="line"><span class="number">11</span>:         <span class="comment">// retryTimes == RETRY_TIMES_OVER&#x65F6;&#xFF0C;&#x8FDB;&#x884C;&#x5F3A;&#x5236;flush&#x3002;&#x4E3B;&#x8981;&#x7528;&#x4E8E;shutdown&#x65F6;&#x3002;</span></div><div class="line"><span class="number">12</span>:         <span class="keyword">if</span> (retryTimes == RETRY_TIMES_OVER) {</div><div class="line"><span class="number">13</span>:             flushConsumeQueueLeastPages = <span class="number">0</span>;</div><div class="line"><span class="number">14</span>:         }</div><div class="line"><span class="number">15</span>:         <span class="comment">// &#x5F53;&#x65F6;&#x95F4;&#x6EE1;&#x8DB3;flushConsumeQueueThoroughInterval&#x65F6;&#xFF0C;&#x5373;&#x4F7F;&#x5199;&#x5165;&#x7684;&#x6570;&#x91CF;&#x4E0D;&#x8DB3;flushConsumeQueueLeastPages&#xFF0C;&#x4E5F;&#x8FDB;&#x884C;flush</span></div><div class="line"><span class="number">16</span>:         <span class="keyword">long</span> logicsMsgTimestamp = <span class="number">0</span>;</div><div class="line"><span class="number">17</span>:         <span class="keyword">int</span> flushConsumeQueueThoroughInterval = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushConsumeQueueThoroughInterval();</div><div class="line"><span class="number">18</span>:         <span class="keyword">long</span> currentTimeMillis = System.currentTimeMillis();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (currentTimeMillis &gt;= (<span class="keyword">this</span>.lastFlushTimestamp + flushConsumeQueueThoroughInterval)) {</div><div class="line"><span class="number">20</span>:             <span class="keyword">this</span>.lastFlushTimestamp = currentTimeMillis;</div><div class="line"><span class="number">21</span>:             flushConsumeQueueLeastPages = <span class="number">0</span>;</div><div class="line"><span class="number">22</span>:             logicsMsgTimestamp = DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().getLogicsMsgTimestamp();</div><div class="line"><span class="number">23</span>:         }</div><div class="line"><span class="number">24</span>:         <span class="comment">// flush&#x6D88;&#x8D39;&#x961F;&#x5217;</span></div><div class="line"><span class="number">25</span>:         ConcurrentHashMap&lt;String, ConcurrentHashMap&lt;Integer, ConsumeQueue&gt;&gt; tables = DefaultMessageStore.<span class="keyword">this</span>.consumeQueueTable;</div><div class="line"><span class="number">26</span>:         <span class="keyword">for</span> (ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; maps : tables.values()) {</div><div class="line"><span class="number">27</span>:             <span class="keyword">for</span> (ConsumeQueue cq : maps.values()) {</div><div class="line"><span class="number">28</span>:                 <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line"><span class="number">29</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; retryTimes &amp;&amp; !result; i++) {</div><div class="line"><span class="number">30</span>:                     result = cq.flush(flushConsumeQueueLeastPages);</div><div class="line"><span class="number">31</span>:                 }</div><div class="line"><span class="number">32</span>:             }</div><div class="line"><span class="number">33</span>:         }</div><div class="line"><span class="number">34</span>:         <span class="comment">// flush &#x5B58;&#x50A8; check point</span></div><div class="line"><span class="number">35</span>:         <span class="keyword">if</span> (<span class="number">0</span> == flushConsumeQueueLeastPages) {</div><div class="line"><span class="number">36</span>:             <span class="keyword">if</span> (logicsMsgTimestamp &gt; <span class="number">0</span>) {</div><div class="line"><span class="number">37</span>:                 DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().setLogicsMsgTimestamp(logicsMsgTimestamp);</div><div class="line"><span class="number">38</span>:             }</div><div class="line"><span class="number">39</span>:             DefaultMessageStore.<span class="keyword">this</span>.getStoreCheckpoint().flush();</div><div class="line"><span class="number">40</span>:         }</div><div class="line"><span class="number">41</span>:     }</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">44</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service started&quot;</span>);</div><div class="line"><span class="number">45</span>: </div><div class="line"><span class="number">46</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) {</div><div class="line"><span class="number">47</span>:             <span class="keyword">try</span> {</div><div class="line"><span class="number">48</span>:                 <span class="keyword">int</span> interval = DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getFlushIntervalConsumeQueue();</div><div class="line"><span class="number">49</span>:                 <span class="keyword">this</span>.waitForRunning(interval);</div><div class="line"><span class="number">50</span>:                 <span class="keyword">this</span>.doFlush(<span class="number">1</span>);</div><div class="line"><span class="number">51</span>:             } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">52</span>:                 DefaultMessageStore.log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service has exception. &quot;</span>, e);</div><div class="line"><span class="number">53</span>:             }</div><div class="line"><span class="number">54</span>:         }</div><div class="line"><span class="number">55</span>: </div><div class="line"><span class="number">56</span>:         <span class="keyword">this</span>.doFlush(RETRY_TIMES_OVER);</div><div class="line"><span class="number">57</span>: </div><div class="line"><span class="number">58</span>:         DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service end&quot;</span>);</div><div class="line"><span class="number">59</span>:     }</div><div class="line"><span class="number">60</span>: </div><div class="line"><span class="number">61</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">62</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">63</span>:         <span class="keyword">return</span> FlushConsumeQueueService.class.getSimpleName();</div><div class="line"><span class="number">64</span>:     }</div><div class="line"><span class="number">65</span>: </div><div class="line"><span class="number">66</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">67</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJointime</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">68</span>:         <span class="keyword">return</span> <span class="number">1000</span> * <span class="number">60</span>;</div><div class="line"><span class="number">69</span>:     }</div><div class="line"><span class="number">70</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;flush <code>ConsumeQueue</code>(&#x6D88;&#x8D39;&#x961F;&#x5217;) &#x7EBF;&#x7A0B;&#x670D;&#x52A1;&#x3002;</li>
<li>&#x7B2C; 11 &#x81F3; 14 &#x884C; &#xFF1A;&#x5F53; <code>retryTimes == RETRY_TIMES_OVER</code> &#x65F6;&#xFF0C;&#x8FDB;&#x884C;&#x5F3A;&#x5236;flush&#x3002;&#x7528;&#x4E8E; <code>shutdown</code> &#x65F6;&#x3002;</li>
<li>&#x7B2C; 15 &#x81F3; 23 &#x884C; &#xFF1A;&#x6BCF; flushConsumeQueueThoroughInterval &#x5468;&#x671F;&#xFF0C;&#x6267;&#x884C;&#x4E00;&#x6B21; flush &#x3002;&#x56E0;&#x4E3A;&#x4E0D;&#x662F;&#x6BCF;&#x6B21;&#x5FAA;&#x73AF;&#x5230;&#x90FD;&#x80FD;&#x6EE1;&#x8DB3; flushConsumeQueueLeastPages &#x5927;&#x5C0F;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x9700;&#x8981;&#x4E00;&#x5B9A;&#x5468;&#x671F;&#x8FDB;&#x884C;&#x4E00;&#x6B21;&#x5F3A;&#x5236; flush &#x3002;&#x5F53;&#x7136;&#xFF0C;&#x4E0D;&#x80FD;&#x6BCF;&#x6B21;&#x5FAA;&#x73AF;&#x90FD;&#x53BB;&#x6267;&#x884C;&#x5F3A;&#x5236; flush&#xFF0C;&#x8FD9;&#x6837;&#x6027;&#x80FD;&#x8F83;&#x5DEE;&#x3002;</li>
<li>&#x7B2C; 24 &#x81F3; 33 &#x884C; &#xFF1A;flush <code>ConsumeQueue</code>(&#x6D88;&#x8D39;&#x961F;&#x5217;)&#x3002;<ul>
<li>flush &#x903B;&#x8F91;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/message-store/#MappedFile-&#x843D;&#x76D8;">MappedFile#&#x843D;&#x76D8;</a>&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 34 &#x81F3; 40 &#x884C; &#xFF1A;flush <code>StoreCheckpoint</code>&#x3002;<code>StoreCheckpoint</code> &#x7684;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/store-init-and-shutdown/">Store&#x521D;&#x59CB;&#x5316;&#x4E0E;&#x5173;&#x95ED;</a>&#x3002;</li>
<li>&#x7B2C; 43 &#x81F3; 59 &#x884C; &#xFF1A;&#x6BCF; 1000ms &#x6267;&#x884C;&#x4E00;&#x6B21; <code>flush</code>&#x3002;&#x5982;&#x679C; wakeup() &#x65F6;&#xFF0C;&#x5219;&#x4F1A;&#x7ACB;&#x5373;&#x8FDB;&#x884C;&#x4E00;&#x6B21; <code>flush</code>&#x3002;&#x76EE;&#x524D;&#xFF0C;&#x6682;&#x65F6;&#x4E0D;&#x5B58;&#x5728; wakeup() &#x7684;&#x8C03;&#x7528;&#x3002;</li>
</ul>
<h1 id="4&#x3001;Broker-&#x63D0;&#x4F9B;-&#x62C9;&#x53D6;&#x6D88;&#x606F;-&#x63A5;&#x53E3;"><a href="#4&#x3001;Broker-&#x63D0;&#x4F9B;-&#x62C9;&#x53D6;&#x6D88;&#x606F;-&#x63A5;&#x53E3;" class="headerlink" title="4&#x3001;Broker &#x63D0;&#x4F9B;[&#x62C9;&#x53D6;&#x6D88;&#x606F;]&#x63A5;&#x53E3;"></a>4&#x3001;Broker &#x63D0;&#x4F9B;[&#x62C9;&#x53D6;&#x6D88;&#x606F;]&#x63A5;&#x53E3;</h1><h2 id="PullMessageRequestHeader"><a href="#PullMessageRequestHeader" class="headerlink" title="PullMessageRequestHeader"></a>PullMessageRequestHeader</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullMessageRequestHeader</span> <span class="keyword">implements</span> <span class="title">CommandCustomHeader</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="comment">/**</span></div><div class="line"> 3:      * &#x6D88;&#x8D39;&#x8005;&#x5206;&#x7EC4;</div><div class="line"> 4:      */</div><div class="line"> <span class="number">5</span>:     <span class="meta">@CFNotNull</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> String consumerGroup;</div><div class="line"> <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line"> 8:      * Topic</div><div class="line"> 9:      */</div><div class="line"><span class="number">10</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">private</span> String topic;</div><div class="line"><span class="number">12</span>:     <span class="comment">/**</span></div><div class="line">13:      * &#x961F;&#x5217;&#x7F16;&#x53F7;</div><div class="line">14:      */</div><div class="line"><span class="number">15</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">private</span> Integer queueId;</div><div class="line"><span class="number">17</span>:     <span class="comment">/**</span></div><div class="line">18:      * &#x961F;&#x5217;&#x5F00;&#x59CB;&#x4F4D;&#x7F6E;</div><div class="line">19:      */</div><div class="line"><span class="number">20</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">21</span>:     <span class="keyword">private</span> Long queueOffset;</div><div class="line"><span class="number">22</span>:     <span class="comment">/**</span></div><div class="line">23:      * &#x6D88;&#x606F;&#x6570;&#x91CF;</div><div class="line">24:      */</div><div class="line"><span class="number">25</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">26</span>:     <span class="keyword">private</span> Integer maxMsgNums;</div><div class="line"><span class="number">27</span>:     <span class="comment">/**</span></div><div class="line">28:      * &#x7CFB;&#x7EDF;&#x6807;&#x8BC6;</div><div class="line">29:      */</div><div class="line"><span class="number">30</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">31</span>:     <span class="keyword">private</span> Integer sysFlag;</div><div class="line"><span class="number">32</span>:     <span class="comment">/**</span></div><div class="line">33:      * &#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x4F4D;&#x7F6E;</div><div class="line">34:      */</div><div class="line"><span class="number">35</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">36</span>:     <span class="keyword">private</span> Long commitOffset;</div><div class="line"><span class="number">37</span>:     <span class="comment">/**</span></div><div class="line">38:      * &#x6302;&#x8D77;&#x8D85;&#x65F6;&#x65F6;&#x95F4;</div><div class="line">39:      */</div><div class="line"><span class="number">40</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">41</span>:     <span class="keyword">private</span> Long suspendTimeoutMillis;</div><div class="line"><span class="number">42</span>:     <span class="comment">/**</span></div><div class="line">43:      * &#x8BA2;&#x9605;&#x8868;&#x8FBE;&#x5F0F;</div><div class="line">44:      */</div><div class="line"><span class="number">45</span>:     <span class="meta">@CFNullable</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">private</span> String subscription;</div><div class="line"><span class="number">47</span>:     <span class="comment">/**</span></div><div class="line">48:      * &#x8BA2;&#x9605;&#x7248;&#x672C;&#x53F7;</div><div class="line">49:      */</div><div class="line"><span class="number">50</span>:     <span class="meta">@CFNotNull</span></div><div class="line"><span class="number">51</span>:     <span class="keyword">private</span> Long subVersion;</div><div class="line"><span class="number">52</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E;&#xFF1A;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;Header</li>
<li>topic +  queueId + queueOffset + maxMsgNums</li>
<li>sysFlag &#xFF1A;&#x7CFB;&#x7EDF;&#x6807;&#x8BC6;&#x3002;<ul>
<li>&#x7B2C; 0 &#x4F4D; <code>FLAG_COMMIT_OFFSET</code> &#xFF1A;&#x6807;&#x8BB0;&#x8BF7;&#x6C42;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x4F4D;&#x7F6E;&#xFF0C;&#x548C; <code>commitOffset</code> &#x914D;&#x5408;&#x3002;</li>
<li>&#x7B2C; 1 &#x4F4D; <code>FLAG_SUSPEND</code> &#xFF1A;&#x6807;&#x8BB0;&#x8BF7;&#x6C42;&#x662F;&#x5426;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#xFF0C;&#x548C; <code>suspendTimeoutMillis</code> &#x914D;&#x5408;&#x3002;&#x5F53;&#x62C9;&#x53D6;&#x4E0D;&#x5230;&#x6D88;&#x606F;&#x65F6;&#xFF0C; <code>Broker</code> &#x4F1A;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#xFF0C;&#x76F4;&#x5230;&#x6709;&#x6D88;&#x606F;&#x3002;&#x6700;&#x5927;&#x6302;&#x8D77;&#x65F6;&#x95F4;&#xFF1A;<code>suspendTimeoutMillis</code> &#x6BEB;&#x79D2;&#x3002;</li>
<li>&#x7B2C; 2 &#x4F4D; <code>FLAG_SUBSCRIPTION</code> &#xFF1A;&#x662F;&#x5426;&#x8FC7;&#x6EE4;&#x8BA2;&#x9605;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x548C; <code>subscription</code> &#x914D;&#x7F6E;&#x3002;</li>
</ul>
</li>
<li>subVersion &#xFF1A;&#x8BA2;&#x9605;&#x7248;&#x672C;&#x53F7;&#x3002;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x7248;&#x672C;&#x53F7;&#x4E0D;&#x5BF9;&#xFF0C;&#x5219;&#x65E0;&#x6CD5;&#x62C9;&#x53D6;&#x5230;&#x6D88;&#x606F;&#xFF0C;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x83B7;&#x53D6;&#x8BA2;&#x9605;&#x4FE1;&#x606F;&#xFF0C;&#x4F7F;&#x7528;&#x6700;&#x65B0;&#x7684;&#x8BA2;&#x9605;&#x7248;&#x672C;&#x53F7;&#x3002;</li>
</ul>
<h2 id="PullMessageProcessor-processRequest-&#x2026;"><a href="#PullMessageProcessor-processRequest-&#x2026;" class="headerlink" title="PullMessageProcessor#processRequest(&#x2026;)"></a>PullMessageProcessor#processRequest(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> RemotingCommand <span class="title">processRequest</span><span class="params">(<span class="keyword">final</span> Channel channel, RemotingCommand request, <span class="keyword">boolean</span> brokerAllowSuspend)</span></span></div><div class="line">  2:     <span class="keyword">throws</span> RemotingCommandException {</div><div class="line">  <span class="number">3</span>:     RemotingCommand response = RemotingCommand.createResponseCommand(PullMessageResponseHeader.class);</div><div class="line">  <span class="number">4</span>:     <span class="keyword">final</span> PullMessageResponseHeader responseHeader = (PullMessageResponseHeader) response.readCustomHeader();</div><div class="line">  <span class="number">5</span>:     <span class="keyword">final</span> PullMessageRequestHeader requestHeader =</div><div class="line">  <span class="number">6</span>:         (PullMessageRequestHeader) request.decodeCommandCustomHeader(PullMessageRequestHeader.class);</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     response.setOpaque(request.getOpaque());</div><div class="line">  <span class="number">9</span>: </div><div class="line"> <span class="number">10</span>:     <span class="keyword">if</span> (LOG.isDebugEnabled()) {</div><div class="line"> <span class="number">11</span>:         LOG.debug(<span class="string">&quot;receive PullMessage request command, {}&quot;</span>, request);</div><div class="line"> <span class="number">12</span>:     }</div><div class="line"> <span class="number">13</span>: </div><div class="line"> <span class="number">14</span>:     <span class="comment">// &#x6821;&#x9A8C; broker &#x662F;&#x5426;&#x53EF;&#x8BFB;</span></div><div class="line"> <span class="number">15</span>:     <span class="keyword">if</span> (!PermName.isReadable(<span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerPermission())) {</div><div class="line"> <span class="number">16</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">17</span>:         response.setRemark(String.format(<span class="string">&quot;the broker[%s] pulling message is forbidden&quot;</span>, <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerIP1()));</div><div class="line"> <span class="number">18</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">19</span>:     }</div><div class="line"> <span class="number">20</span>: </div><div class="line"> <span class="number">21</span>:     <span class="comment">// &#x6821;&#x9A8C; consumer&#x5206;&#x7EC4;&#x914D;&#x7F6E; &#x662F;&#x5426;&#x5B58;&#x5728;</span></div><div class="line"> <span class="number">22</span>:     SubscriptionGroupConfig subscriptionGroupConfig = <span class="keyword">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">23</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionGroupConfig) {</div><div class="line"> <span class="number">24</span>:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class="line"> <span class="number">25</span>:         response.setRemark(String.format(<span class="string">&quot;subscription group [%s] does not exist, %s&quot;</span>, requestHeader.getConsumerGroup(), FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST)));</div><div class="line"> <span class="number">26</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">27</span>:     }</div><div class="line"> <span class="number">28</span>:     <span class="comment">// &#x6821;&#x9A8C; consumer&#x5206;&#x7EC4;&#x914D;&#x7F6E; &#x662F;&#x5426;&#x53EF;&#x6D88;&#x8D39;</span></div><div class="line"> <span class="number">29</span>:     <span class="keyword">if</span> (!subscriptionGroupConfig.isConsumeEnable()) {</div><div class="line"> <span class="number">30</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">31</span>:         response.setRemark(<span class="string">&quot;subscription group no permission, &quot;</span> + requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">32</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">33</span>:     }</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> hasSuspendFlag = PullSysFlag.hasSuspendFlag(requestHeader.getSysFlag()); <span class="comment">// &#x662F;&#x5426;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#xFF0C;&#x5F53;&#x6CA1;&#x6709;&#x6D88;&#x606F;&#x65F6;</span></div><div class="line"> <span class="number">36</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> hasCommitOffsetFlag = PullSysFlag.hasCommitOffsetFlag(requestHeader.getSysFlag()); <span class="comment">// &#x662F;&#x5426;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</span></div><div class="line"> <span class="number">37</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> hasSubscriptionFlag = PullSysFlag.hasSubscriptionFlag(requestHeader.getSysFlag()); <span class="comment">// &#x662F;&#x5426;&#x8FC7;&#x6EE4;&#x8BA2;&#x9605;&#x8868;&#x8FBE;&#x5F0F;(subscription)</span></div><div class="line"> <span class="number">38</span>:     <span class="keyword">final</span> <span class="keyword">long</span> suspendTimeoutMillisLong = hasSuspendFlag ? requestHeader.getSuspendTimeoutMillis() : <span class="number">0</span>; <span class="comment">// &#x6302;&#x8D77;&#x8BF7;&#x6C42;&#x8D85;&#x65F6;&#x65F6;&#x957F;</span></div><div class="line"> <span class="number">39</span>: </div><div class="line"> <span class="number">40</span>:     <span class="comment">// &#x6821;&#x9A8C; topic&#x914D;&#x7F6E; &#x5B58;&#x5728;</span></div><div class="line"> <span class="number">41</span>:     TopicConfig topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class="line"> <span class="number">42</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) {</div><div class="line"> <span class="number">43</span>:         LOG.error(<span class="string">&quot;The topic {} not exist, consumer: {} &quot;</span>, requestHeader.getTopic(), RemotingHelper.parseChannelRemoteAddr(channel));</div><div class="line"> <span class="number">44</span>:         response.setCode(ResponseCode.TOPIC_NOT_EXIST);</div><div class="line"> <span class="number">45</span>:         response.setRemark(String.format(<span class="string">&quot;topic[%s] not exist, apply first please! %s&quot;</span>, requestHeader.getTopic(), FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL)));</div><div class="line"> <span class="number">46</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">47</span>:     }</div><div class="line"> <span class="number">48</span>:     <span class="comment">// &#x6821;&#x9A8C; topic&#x914D;&#x7F6E; &#x6743;&#x9650;&#x53EF;&#x8BFB;</span></div><div class="line"> <span class="number">49</span>:     <span class="keyword">if</span> (!PermName.isReadable(topicConfig.getPerm())) {</div><div class="line"> <span class="number">50</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">51</span>:         response.setRemark(<span class="string">&quot;the topic[&quot;</span> + requestHeader.getTopic() + <span class="string">&quot;] pulling message is forbidden&quot;</span>);</div><div class="line"> <span class="number">52</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">53</span>:     }</div><div class="line"> <span class="number">54</span>:     <span class="comment">// &#x6821;&#x9A8C; &#x8BFB;&#x53D6;&#x961F;&#x5217; &#x5728; topic&#x914D;&#x7F6E; &#x961F;&#x5217;&#x8303;&#x56F4;&#x5185;</span></div><div class="line"> <span class="number">55</span>:     <span class="keyword">if</span> (requestHeader.getQueueId() &lt; <span class="number">0</span> || requestHeader.getQueueId() &gt;= topicConfig.getReadQueueNums()) {</div><div class="line"> <span class="number">56</span>:         String errorInfo = String.format(<span class="string">&quot;queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]&quot;</span>,</div><div class="line"> <span class="number">57</span>:                 requestHeader.getQueueId(), requestHeader.getTopic(), topicConfig.getReadQueueNums(), channel.remoteAddress());</div><div class="line"> <span class="number">58</span>:         LOG.warn(errorInfo);</div><div class="line"> <span class="number">59</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">60</span>:         response.setRemark(errorInfo);</div><div class="line"> <span class="number">61</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">62</span>:     }</div><div class="line"> <span class="number">63</span>: </div><div class="line"> <span class="number">64</span>:     <span class="comment">// &#x6821;&#x9A8C; &#x8BA2;&#x9605;&#x5173;&#x7CFB;</span></div><div class="line"> <span class="number">65</span>:     SubscriptionData subscriptionData;</div><div class="line"> <span class="number">66</span>:     <span class="keyword">if</span> (hasSubscriptionFlag) {</div><div class="line"> <span class="number">67</span>:         <span class="keyword">try</span> {</div><div class="line"> <span class="number">68</span>:             subscriptionData = FilterAPI.buildSubscriptionData(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"> <span class="number">69</span>:                 requestHeader.getSubscription());</div><div class="line"> <span class="number">70</span>:         } <span class="keyword">catch</span> (Exception e) {</div><div class="line"> <span class="number">71</span>:             LOG.warn(<span class="string">&quot;Parse the consumer&apos;s subscription[{}] failed, group: {}&quot;</span>, requestHeader.getSubscription(), <span class="comment">//</span></div><div class="line"> <span class="number">72</span>:                     requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">73</span>:             response.setCode(ResponseCode.SUBSCRIPTION_PARSE_FAILED);</div><div class="line"> <span class="number">74</span>:             response.setRemark(<span class="string">&quot;parse the consumer&apos;s subscription failed&quot;</span>);</div><div class="line"> <span class="number">75</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">76</span>:         }</div><div class="line"> <span class="number">77</span>:     } <span class="keyword">else</span> {</div><div class="line"> <span class="number">78</span>:         <span class="comment">// &#x6821;&#x9A8C; &#x6D88;&#x8D39;&#x5206;&#x7EC4;&#x4FE1;&#x606F; &#x662F;&#x5426;&#x5B58;&#x5728;</span></div><div class="line"> <span class="number">79</span>:         ConsumerGroupInfo consumerGroupInfo = <span class="keyword">this</span>.brokerController.getConsumerManager().getConsumerGroupInfo(requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">80</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == consumerGroupInfo) {</div><div class="line"> <span class="number">81</span>:             LOG.warn(<span class="string">&quot;The consumer&apos;s group info not exist, group: {}&quot;</span>, requestHeader.getConsumerGroup());</div><div class="line"> <span class="number">82</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</div><div class="line"> <span class="number">83</span>:             response.setRemark(<span class="string">&quot;the consumer&apos;s group info not exist&quot;</span> + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</div><div class="line"> <span class="number">84</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">85</span>:         }</div><div class="line"> <span class="number">86</span>:         <span class="comment">// &#x6821;&#x9A8C; &#x6D88;&#x8D39;&#x5206;&#x7EC4;&#x4FE1;&#x606F; &#x6D88;&#x606F;&#x6A21;&#x578B;&#x662F;&#x5426;&#x5339;&#x914D;</span></div><div class="line"> <span class="number">87</span>:         <span class="keyword">if</span> (!subscriptionGroupConfig.isConsumeBroadcastEnable() <span class="comment">//</span></div><div class="line"> <span class="number">88</span>:             &amp;&amp; consumerGroupInfo.getMessageModel() == MessageModel.BROADCASTING) {</div><div class="line"> <span class="number">89</span>:             response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">90</span>:             response.setRemark(<span class="string">&quot;the consumer group[&quot;</span> + requestHeader.getConsumerGroup() + <span class="string">&quot;] can not consume by broadcast way&quot;</span>);</div><div class="line"> <span class="number">91</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">92</span>:         }</div><div class="line"> <span class="number">93</span>: </div><div class="line"> <span class="number">94</span>:         <span class="comment">// &#x6821;&#x9A8C; &#x8BA2;&#x9605;&#x4FE1;&#x606F; &#x662F;&#x5426;&#x5B58;&#x5728;</span></div><div class="line"> <span class="number">95</span>:         subscriptionData = consumerGroupInfo.findSubscriptionData(requestHeader.getTopic());</div><div class="line"> <span class="number">96</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) {</div><div class="line"> <span class="number">97</span>:             LOG.warn(<span class="string">&quot;The consumer&apos;s subscription not exist, group: {}, topic:{}&quot;</span>, requestHeader.getConsumerGroup(), requestHeader.getTopic());</div><div class="line"> <span class="number">98</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_EXIST);</div><div class="line"> <span class="number">99</span>:             response.setRemark(<span class="string">&quot;the consumer&apos;s subscription not exist&quot;</span> + FAQUrl.suggestTodo(FAQUrl.SAME_GROUP_DIFFERENT_TOPIC));</div><div class="line"><span class="number">100</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">101</span>:         }</div><div class="line"><span class="number">102</span>:         <span class="comment">// &#x6821;&#x9A8C; &#x8BA2;&#x9605;&#x4FE1;&#x606F;&#x7248;&#x672C; &#x662F;&#x5426;&#x5408;&#x6CD5;</span></div><div class="line"><span class="number">103</span>:         <span class="keyword">if</span> (subscriptionData.getSubVersion() &lt; requestHeader.getSubVersion()) {</div><div class="line"><span class="number">104</span>:             LOG.warn(<span class="string">&quot;The broker&apos;s subscription is not latest, group: {} {}&quot;</span>, requestHeader.getConsumerGroup(),</div><div class="line"><span class="number">105</span>:                     subscriptionData.getSubString());</div><div class="line"><span class="number">106</span>:             response.setCode(ResponseCode.SUBSCRIPTION_NOT_LATEST);</div><div class="line"><span class="number">107</span>:             response.setRemark(<span class="string">&quot;the consumer&apos;s subscription not latest&quot;</span>);</div><div class="line"><span class="number">108</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">109</span>:         }</div><div class="line"><span class="number">110</span>:     }</div><div class="line"><span class="number">111</span>: </div><div class="line"><span class="number">112</span>:     <span class="comment">// &#x83B7;&#x53D6;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">113</span>:     <span class="keyword">final</span> GetMessageResult getMessageResult = <span class="keyword">this</span>.brokerController.getMessageStore().getMessage(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"><span class="number">114</span>:             requestHeader.getQueueId(), requestHeader.getQueueOffset(), requestHeader.getMaxMsgNums(), subscriptionData);</div><div class="line"><span class="number">115</span>:     <span class="keyword">if</span> (getMessageResult != <span class="keyword">null</span>) {</div><div class="line"><span class="number">116</span>:         response.setRemark(getMessageResult.getStatus().name());</div><div class="line"><span class="number">117</span>:         responseHeader.setNextBeginOffset(getMessageResult.getNextBeginOffset());</div><div class="line"><span class="number">118</span>:         responseHeader.setMinOffset(getMessageResult.getMinOffset());</div><div class="line"><span class="number">119</span>:         responseHeader.setMaxOffset(getMessageResult.getMaxOffset());</div><div class="line"><span class="number">120</span>: </div><div class="line"><span class="number">121</span>:         <span class="comment">// TODO &#x5F85;&#x8BFB;</span></div><div class="line"><span class="number">122</span>:         <span class="comment">// &#x8BA1;&#x7B97;&#x5EFA;&#x8BAE;&#x8BFB;&#x53D6;brokerId</span></div><div class="line"><span class="number">123</span>:         <span class="keyword">if</span> (getMessageResult.isSuggestPullingFromSlave()) {</div><div class="line"><span class="number">124</span>:             responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</div><div class="line"><span class="number">125</span>:         } <span class="keyword">else</span> {</div><div class="line"><span class="number">126</span>:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class="line"><span class="number">127</span>:         }</div><div class="line"><span class="number">128</span>: </div><div class="line"><span class="number">129</span>:         <span class="keyword">switch</span> (<span class="keyword">this</span>.brokerController.getMessageStoreConfig().getBrokerRole()) {</div><div class="line"><span class="number">130</span>:             <span class="keyword">case</span> ASYNC_MASTER:</div><div class="line"><span class="number">131</span>:             <span class="keyword">case</span> SYNC_MASTER:</div><div class="line"><span class="number">132</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">133</span>:             <span class="keyword">case</span> SLAVE:</div><div class="line"><span class="number">134</span>:                 <span class="keyword">if</span> (!<span class="keyword">this</span>.brokerController.getBrokerConfig().isSlaveReadEnable()) { <span class="comment">// &#x4ECE;&#x8282;&#x70B9;&#x4E0D;&#x5141;&#x8BB8;&#x8BFB;&#x53D6;&#xFF0C;&#x544A;&#x8BC9;consumer&#x8BFB;&#x53D6;&#x4E3B;&#x8282;&#x70B9;&#x3002;</span></div><div class="line"><span class="number">135</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">136</span>:                     responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class="line"><span class="number">137</span>:                 }</div><div class="line"><span class="number">138</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">139</span>:         }</div><div class="line"><span class="number">140</span>: </div><div class="line"><span class="number">141</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isSlaveReadEnable()) {</div><div class="line"><span class="number">142</span>:             <span class="comment">// consume too slow ,redirect to another machine</span></div><div class="line"><span class="number">143</span>:             <span class="keyword">if</span> (getMessageResult.isSuggestPullingFromSlave()) {</div><div class="line"><span class="number">144</span>:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getWhichBrokerWhenConsumeSlowly());</div><div class="line"><span class="number">145</span>:             }</div><div class="line"><span class="number">146</span>:             <span class="comment">// consume ok</span></div><div class="line"><span class="number">147</span>:             <span class="keyword">else</span> {</div><div class="line"><span class="number">148</span>:                 responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</div><div class="line"><span class="number">149</span>:             }</div><div class="line"><span class="number">150</span>:         } <span class="keyword">else</span> {</div><div class="line"><span class="number">151</span>:             responseHeader.setSuggestWhichBrokerId(MixAll.MASTER_ID);</div><div class="line"><span class="number">152</span>:         }</div><div class="line"><span class="number">153</span>: </div><div class="line"><span class="number">154</span>:         <span class="keyword">switch</span> (getMessageResult.getStatus()) {</div><div class="line"><span class="number">155</span>:             <span class="keyword">case</span> FOUND:</div><div class="line"><span class="number">156</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class="line"><span class="number">157</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">158</span>:             <span class="keyword">case</span> MESSAGE_WAS_REMOVING:</div><div class="line"><span class="number">159</span>:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">160</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">161</span>:             <span class="keyword">case</span> NO_MATCHED_LOGIC_QUEUE:</div><div class="line"><span class="number">162</span>:             <span class="keyword">case</span> NO_MESSAGE_IN_QUEUE:</div><div class="line"><span class="number">163</span>:                 <span class="keyword">if</span> (<span class="number">0</span> != requestHeader.getQueueOffset()) {</div><div class="line"><span class="number">164</span>:                     response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class="line"><span class="number">165</span>: </div><div class="line"><span class="number">166</span>:                     <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"><span class="number">167</span>:                     LOG.info(<span class="string">&quot;the broker store no queue data, fix the request offset {} to {}, Topic: {} QueueId: {} Consumer Group: {}&quot;</span>, <span class="comment">//</span></div><div class="line"><span class="number">168</span>:                         requestHeader.getQueueOffset(), <span class="comment">//</span></div><div class="line"><span class="number">169</span>:                         getMessageResult.getNextBeginOffset(), <span class="comment">//</span></div><div class="line"><span class="number">170</span>:                         requestHeader.getTopic(), <span class="comment">//</span></div><div class="line"><span class="number">171</span>:                         requestHeader.getQueueId(), <span class="comment">//</span></div><div class="line"><span class="number">172</span>:                         requestHeader.getConsumerGroup()<span class="comment">//</span></div><div class="line"><span class="number">173</span>:                     );</div><div class="line"><span class="number">174</span>:                 } <span class="keyword">else</span> {</div><div class="line"><span class="number">175</span>:                     response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class="line"><span class="number">176</span>:                 }</div><div class="line"><span class="number">177</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">178</span>:             <span class="keyword">case</span> NO_MATCHED_MESSAGE:</div><div class="line"><span class="number">179</span>:                 response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">180</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">181</span>:             <span class="keyword">case</span> OFFSET_FOUND_NULL:</div><div class="line"><span class="number">182</span>:                 response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class="line"><span class="number">183</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">184</span>:             <span class="keyword">case</span> OFFSET_OVERFLOW_BADLY:</div><div class="line"><span class="number">185</span>:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class="line"><span class="number">186</span>:                 <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></div><div class="line"><span class="number">187</span>:                 LOG.info(<span class="string">&quot;The request offset:{} over flow badly, broker max offset:{} , consumer: {}&quot;</span>, requestHeader.getQueueOffset(), getMessageResult.getMaxOffset(), channel.remoteAddress());</div><div class="line"><span class="number">188</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">189</span>:             <span class="keyword">case</span> OFFSET_OVERFLOW_ONE:</div><div class="line"><span class="number">190</span>:                 response.setCode(ResponseCode.PULL_NOT_FOUND);</div><div class="line"><span class="number">191</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">192</span>:             <span class="keyword">case</span> OFFSET_TOO_SMALL:</div><div class="line"><span class="number">193</span>:                 response.setCode(ResponseCode.PULL_OFFSET_MOVED);</div><div class="line"><span class="number">194</span>:                 LOG.info(<span class="string">&quot;The request offset is too small. group={}, topic={}, requestOffset={}, brokerMinOffset={}, clientIp={}&quot;</span>,</div><div class="line"><span class="number">195</span>:                     requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueOffset(),</div><div class="line"><span class="number">196</span>:                     getMessageResult.getMinOffset(), channel.remoteAddress());</div><div class="line"><span class="number">197</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">198</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">199</span>:                 <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">200</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">201</span>:         }</div><div class="line"><span class="number">202</span>: </div><div class="line"><span class="number">203</span>:         <span class="comment">// hook&#xFF1A;before</span></div><div class="line"><span class="number">204</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.hasConsumeMessageHook()) {</div><div class="line"><span class="number">205</span>:             ConsumeMessageContext context = <span class="keyword">new</span> ConsumeMessageContext();</div><div class="line"><span class="number">206</span>:             context.setConsumerGroup(requestHeader.getConsumerGroup());</div><div class="line"><span class="number">207</span>:             context.setTopic(requestHeader.getTopic());</div><div class="line"><span class="number">208</span>:             context.setQueueId(requestHeader.getQueueId());</div><div class="line"><span class="number">209</span>: </div><div class="line"><span class="number">210</span>:             String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);</div><div class="line"><span class="number">211</span>: </div><div class="line"><span class="number">212</span>:             <span class="keyword">switch</span> (response.getCode()) {</div><div class="line"><span class="number">213</span>:                 <span class="keyword">case</span> ResponseCode.SUCCESS:</div><div class="line"><span class="number">214</span>:                     <span class="keyword">int</span> commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();</div><div class="line"><span class="number">215</span>:                     <span class="keyword">int</span> incValue = getMessageResult.getMsgCount4Commercial() * commercialBaseCount;</div><div class="line"><span class="number">216</span>: </div><div class="line"><span class="number">217</span>:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_SUCCESS);</div><div class="line"><span class="number">218</span>:                     context.setCommercialRcvTimes(incValue);</div><div class="line"><span class="number">219</span>:                     context.setCommercialRcvSize(getMessageResult.getBufferTotalSize());</div><div class="line"><span class="number">220</span>:                     context.setCommercialOwner(owner);</div><div class="line"><span class="number">221</span>: </div><div class="line"><span class="number">222</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">223</span>:                 <span class="keyword">case</span> ResponseCode.PULL_NOT_FOUND:</div><div class="line"><span class="number">224</span>:                     <span class="keyword">if</span> (!brokerAllowSuspend) {</div><div class="line"><span class="number">225</span>: </div><div class="line"><span class="number">226</span>:                         context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</div><div class="line"><span class="number">227</span>:                         context.setCommercialRcvTimes(<span class="number">1</span>);</div><div class="line"><span class="number">228</span>:                         context.setCommercialOwner(owner);</div><div class="line"><span class="number">229</span>: </div><div class="line"><span class="number">230</span>:                     }</div><div class="line"><span class="number">231</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">232</span>:                 <span class="keyword">case</span> ResponseCode.PULL_RETRY_IMMEDIATELY:</div><div class="line"><span class="number">233</span>:                 <span class="keyword">case</span> ResponseCode.PULL_OFFSET_MOVED:</div><div class="line"><span class="number">234</span>:                     context.setCommercialRcvStats(BrokerStatsManager.StatsType.RCV_EPOLLS);</div><div class="line"><span class="number">235</span>:                     context.setCommercialRcvTimes(<span class="number">1</span>);</div><div class="line"><span class="number">236</span>:                     context.setCommercialOwner(owner);</div><div class="line"><span class="number">237</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">238</span>:                 <span class="keyword">default</span>:</div><div class="line"><span class="number">239</span>:                     <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">240</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">241</span>:             }</div><div class="line"><span class="number">242</span>: </div><div class="line"><span class="number">243</span>:             <span class="keyword">this</span>.executeConsumeMessageHookBefore(context);</div><div class="line"><span class="number">244</span>:         }</div><div class="line"><span class="number">245</span>: </div><div class="line"><span class="number">246</span>:         <span class="keyword">switch</span> (response.getCode()) {</div><div class="line"><span class="number">247</span>:             <span class="keyword">case</span> ResponseCode.SUCCESS:</div><div class="line"><span class="number">248</span>: </div><div class="line"><span class="number">249</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incGroupGetNums(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"><span class="number">250</span>:                     getMessageResult.getMessageCount());</div><div class="line"><span class="number">251</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incGroupGetSize(requestHeader.getConsumerGroup(), requestHeader.getTopic(),</div><div class="line"><span class="number">252</span>:                     getMessageResult.getBufferTotalSize());</div><div class="line"><span class="number">253</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incBrokerGetNums(getMessageResult.getMessageCount());</div><div class="line"><span class="number">254</span>:                 <span class="comment">// &#x8BFB;&#x53D6;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">255</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isTransferMsgByHeap()) { <span class="comment">// &#x5185;&#x5B58;&#x4E2D;</span></div><div class="line"><span class="number">256</span>:                     <span class="keyword">final</span> <span class="keyword">long</span> beginTimeMills = <span class="keyword">this</span>.brokerController.getMessageStore().now();</div><div class="line"><span class="number">257</span>: </div><div class="line"><span class="number">258</span>:                     <span class="keyword">final</span> <span class="keyword">byte</span>[] r = <span class="keyword">this</span>.readGetMessageResult(getMessageResult, requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId());</div><div class="line"><span class="number">259</span>: </div><div class="line"><span class="number">260</span>:                     <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incGroupGetLatency(requestHeader.getConsumerGroup(),</div><div class="line"><span class="number">261</span>:                         requestHeader.getTopic(), requestHeader.getQueueId(),</div><div class="line"><span class="number">262</span>:                         (<span class="keyword">int</span>) (<span class="keyword">this</span>.brokerController.getMessageStore().now() - beginTimeMills));</div><div class="line"><span class="number">263</span>:                     response.setBody(r);</div><div class="line"><span class="number">264</span>:                 } <span class="keyword">else</span> { <span class="comment">// zero-copy</span></div><div class="line"><span class="number">265</span>:                     <span class="keyword">try</span> {</div><div class="line"><span class="number">266</span>:                         FileRegion fileRegion = <span class="keyword">new</span> ManyMessageTransfer(response.encodeHeader(getMessageResult.getBufferTotalSize()), getMessageResult);</div><div class="line"><span class="number">267</span>:                         channel.writeAndFlush(fileRegion).addListener(<span class="keyword">new</span> ChannelFutureListener() {</div><div class="line"><span class="number">268</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">269</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</div><div class="line"><span class="number">270</span>:                                 getMessageResult.release();</div><div class="line"><span class="number">271</span>:                                 <span class="keyword">if</span> (!future.isSuccess()) {</div><div class="line"><span class="number">272</span>:                                     LOG.error(<span class="string">&quot;Fail to transfer messages from page cache to {}&quot;</span>, channel.remoteAddress(), future.cause());</div><div class="line"><span class="number">273</span>:                                 }</div><div class="line"><span class="number">274</span>:                             }</div><div class="line"><span class="number">275</span>:                         });</div><div class="line"><span class="number">276</span>:                     } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"><span class="number">277</span>:                         LOG.error(<span class="string">&quot;Error occurred when transferring messages from page cache&quot;</span>, e);</div><div class="line"><span class="number">278</span>:                         getMessageResult.release();</div><div class="line"><span class="number">279</span>:                     }</div><div class="line"><span class="number">280</span>: </div><div class="line"><span class="number">281</span>:                     response = <span class="keyword">null</span>;</div><div class="line"><span class="number">282</span>:                 }</div><div class="line"><span class="number">283</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">284</span>:             <span class="keyword">case</span> ResponseCode.PULL_NOT_FOUND:</div><div class="line"><span class="number">285</span>:                 <span class="comment">// &#x6D88;&#x606F;&#x672A;&#x67E5;&#x8BE2;&#x5230; &amp;&amp; broker&#x5141;&#x8BB8;&#x6302;&#x8D77;&#x8BF7;&#x6C42; &amp;&amp; &#x8BF7;&#x6C42;&#x5141;&#x8BB8;&#x6302;&#x8D77;</span></div><div class="line"><span class="number">286</span>:                 <span class="keyword">if</span> (brokerAllowSuspend &amp;&amp; hasSuspendFlag) {</div><div class="line"><span class="number">287</span>:                     <span class="keyword">long</span> pollingTimeMills = suspendTimeoutMillisLong;</div><div class="line"><span class="number">288</span>:                     <span class="keyword">if</span> (!<span class="keyword">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) {</div><div class="line"><span class="number">289</span>:                         pollingTimeMills = <span class="keyword">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills();</div><div class="line"><span class="number">290</span>:                     }</div><div class="line"><span class="number">291</span>: </div><div class="line"><span class="number">292</span>:                     String topic = requestHeader.getTopic();</div><div class="line"><span class="number">293</span>:                     <span class="keyword">long</span> offset = requestHeader.getQueueOffset();</div><div class="line"><span class="number">294</span>:                     <span class="keyword">int</span> queueId = requestHeader.getQueueId();</div><div class="line"><span class="number">295</span>:                     PullRequest pullRequest = <span class="keyword">new</span> PullRequest(request, channel, pollingTimeMills,</div><div class="line"><span class="number">296</span>:                         <span class="keyword">this</span>.brokerController.getMessageStore().now(), offset, subscriptionData);</div><div class="line"><span class="number">297</span>:                     <span class="keyword">this</span>.brokerController.getPullRequestHoldService().suspendPullRequest(topic, queueId, pullRequest);</div><div class="line"><span class="number">298</span>:                     response = <span class="keyword">null</span>;</div><div class="line"><span class="number">299</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">300</span>:                 }</div><div class="line"><span class="number">301</span>: </div><div class="line"><span class="number">302</span>:             <span class="keyword">case</span> ResponseCode.PULL_RETRY_IMMEDIATELY:</div><div class="line"><span class="number">303</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">304</span>:             <span class="keyword">case</span> ResponseCode.PULL_OFFSET_MOVED:</div><div class="line"><span class="number">305</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE</div><div class="line"><span class="number">306</span>:                     || <span class="keyword">this</span>.brokerController.getMessageStoreConfig().isOffsetCheckInSlave()) { <span class="comment">// TODO &#x5F85;&#x535A;&#x5BA2;&#x8865;&#x5145;</span></div><div class="line"><span class="number">307</span>:                     MessageQueue mq = <span class="keyword">new</span> MessageQueue();</div><div class="line"><span class="number">308</span>:                     mq.setTopic(requestHeader.getTopic());</div><div class="line"><span class="number">309</span>:                     mq.setQueueId(requestHeader.getQueueId());</div><div class="line"><span class="number">310</span>:                     mq.setBrokerName(<span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerName());</div><div class="line"><span class="number">311</span>: </div><div class="line"><span class="number">312</span>:                     OffsetMovedEvent event = <span class="keyword">new</span> OffsetMovedEvent();</div><div class="line"><span class="number">313</span>:                     event.setConsumerGroup(requestHeader.getConsumerGroup());</div><div class="line"><span class="number">314</span>:                     event.setMessageQueue(mq);</div><div class="line"><span class="number">315</span>:                     event.setOffsetRequest(requestHeader.getQueueOffset());</div><div class="line"><span class="number">316</span>:                     event.setOffsetNew(getMessageResult.getNextBeginOffset());</div><div class="line"><span class="number">317</span>:                     <span class="keyword">this</span>.generateOffsetMovedEvent(event);</div><div class="line"><span class="number">318</span>:                     LOG.warn(</div><div class="line"><span class="number">319</span>:                         <span class="string">&quot;PULL_OFFSET_MOVED:correction offset. topic={}, groupId={}, requestOffset={}, newOffset={}, suggestBrokerId={}&quot;</span>,</div><div class="line"><span class="number">320</span>:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), event.getOffsetRequest(), event.getOffsetNew(),</div><div class="line"><span class="number">321</span>:                         responseHeader.getSuggestWhichBrokerId());</div><div class="line"><span class="number">322</span>:                 } <span class="keyword">else</span> {</div><div class="line"><span class="number">323</span>:                     responseHeader.setSuggestWhichBrokerId(subscriptionGroupConfig.getBrokerId());</div><div class="line"><span class="number">324</span>:                     response.setCode(ResponseCode.PULL_RETRY_IMMEDIATELY);</div><div class="line"><span class="number">325</span>:                     LOG.warn(<span class="string">&quot;PULL_OFFSET_MOVED:none correction. topic={}, groupId={}, requestOffset={}, suggestBrokerId={}&quot;</span>,</div><div class="line"><span class="number">326</span>:                         requestHeader.getTopic(), requestHeader.getConsumerGroup(), requestHeader.getQueueOffset(),</div><div class="line"><span class="number">327</span>:                         responseHeader.getSuggestWhichBrokerId());</div><div class="line"><span class="number">328</span>:                 }</div><div class="line"><span class="number">329</span>: </div><div class="line"><span class="number">330</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">331</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">332</span>:                 <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">333</span>:         }</div><div class="line"><span class="number">334</span>:     } <span class="keyword">else</span> {</div><div class="line"><span class="number">335</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">336</span>:         response.setRemark(<span class="string">&quot;store getMessage return null&quot;</span>);</div><div class="line"><span class="number">337</span>:     }</div><div class="line"><span class="number">338</span>: </div><div class="line"><span class="number">339</span>:     <span class="comment">// &#x8BF7;&#x6C42;&#x8981;&#x6C42;&#x6301;&#x4E45;&#x5316;&#x8FDB;&#x5EA6; &amp;&amp; broker&#x975E;&#x4E3B;&#xFF0C;&#x8FDB;&#x884C;&#x6301;&#x4E45;&#x5316;&#x8FDB;&#x5EA6;&#x3002;</span></div><div class="line"><span class="number">340</span>:     <span class="keyword">boolean</span> storeOffsetEnable = brokerAllowSuspend;</div><div class="line"><span class="number">341</span>:     storeOffsetEnable = storeOffsetEnable &amp;&amp; hasCommitOffsetFlag;</div><div class="line"><span class="number">342</span>:     storeOffsetEnable = storeOffsetEnable &amp;&amp; <span class="keyword">this</span>.brokerController.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE;</div><div class="line"><span class="number">343</span>:     <span class="keyword">if</span> (storeOffsetEnable) {</div><div class="line"><span class="number">344</span>:         <span class="keyword">this</span>.brokerController.getConsumerOffsetManager().commitOffset(RemotingHelper.parseChannelRemoteAddr(channel),</div><div class="line"><span class="number">345</span>:             requestHeader.getConsumerGroup(), requestHeader.getTopic(), requestHeader.getQueueId(), requestHeader.getCommitOffset());</div><div class="line"><span class="number">346</span>:     }</div><div class="line"><span class="number">347</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">348</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E;&#xFF1A;&#x5904;&#x7406;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#xFF0C;&#x8FD4;&#x56DE;&#x54CD;&#x5E94;&#x3002;</li>
<li>&#x7B2C; 14 &#x81F3; 19 &#x884C; &#xFF1A;&#x6821;&#x9A8C; <code>Broker</code> &#x662F;&#x5426;&#x53EF;&#x8BFB;&#x3002;</li>
<li>&#x7B2C; 21 &#x81F3; 33 &#x884C; &#xFF1A;&#x6821;&#x9A8C; <code>SubscriptionGroupConfig</code>(&#x8BA2;&#x9605;&#x5206;&#x7EC4;&#x914D;&#x7F6E;) &#x662F;&#x5426;&#x5B58;&#x5728; &amp;&amp; &#x53EF;&#x4EE5;&#x6D88;&#x8D39;&#x3002;</li>
<li>&#x7B2C; 35 &#x81F3; 38 &#x884C; &#xFF1A;&#x5904;&#x7406; <code>PullMessageRequestHeader.sysFlag</code> &#x5BF9;&#x5E94;&#x7684;&#x6807;&#x5FD7;&#x4F4D;&#x3002;</li>
<li>&#x7B2C; 40 &#x81F3; 62 &#x884C; &#xFF1A;&#x6821;&#x9A8C; <code>TopicConfig</code>(&#x4E3B;&#x9898;&#x914D;&#x7F6E;) &#x662F;&#x5426;&#x5B58;&#x5728; &amp;&amp; &#x53EF;&#x8BFB; &amp;&amp; &#x961F;&#x5217;&#x7F16;&#x53F7;&#x6B63;&#x786E;&#x3002;</li>
<li>&#x7B2C; 64 &#x81F3; 110 &#x884C; &#xFF1A;&#x6821;&#x9A8C; <code>SubscriptionData</code>(&#x8BA2;&#x9605;&#x4FE1;&#x606F;) &#x662F;&#x5426;&#x6B63;&#x786E;&#x3002;</li>
<li>&#x7B2C; 113 &#x884C; &#xFF1A;&#x8C03;&#x7528; <code>MessageStore#getMessage(...)</code> &#x83B7;&#x53D6; <code>GetMessageResult</code>(&#x6D88;&#x606F;)&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#messagestoregetmessage">MessageStore#getMessage(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 122 &#x81F3; 152 &#x884C; &#xFF1A;&#x8BA1;&#x7B97;&#x5EFA;&#x8BAE;&#x62C9;&#x53D6;&#x6D88;&#x606F; <code>brokerId</code> &#x3002;</li>
<li>&#x7B2C; 154 &#x81F3; 201 &#x884C; &#xFF1A;<img src="http://www.yunai.me/images/RocketMQ/2017_05_04/08.png" alt="PullMessageProcessor&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x72B6;&#x6001;&#x56FE;"></li>
<li>&#x7B2C; 204 &#x81F3; 244 &#x884C; &#xFF1A;<code>Hook</code> &#x903B;&#x8F91;&#xFF0C;<code>#executeConsumeMessageHookBefore(...)</code> &#x3002;</li>
<li>&#x7B2C; 247 &#x81F3; 283 &#x884C; &#xFF1A;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x6210;&#x529F;&#xFF0C;&#x5373;&#x62C9;&#x53D6;&#x5230;&#x6D88;&#x606F;&#x3002;<ul>
<li>&#x7B2C; 255 &#x81F3; 263 &#x884C; &#xFF1A;&#x65B9;&#x5F0F;&#x4E00; &#xFF1A;&#x8C03;&#x7528; <code>readGetMessageResult(...)</code> &#x83B7;&#x53D6;&#x6D88;&#x606F;&#x5185;&#x5BB9;&#x5230;&#x5806;&#x5185;&#x5185;&#x5B58;&#xFF0C;&#x8BBE;&#x7F6E;&#x5230; &#x54CD;&#x5E94;<code>body</code>&#x3002;</li>
<li>&#x7B2C; 265 &#x81F3; 281 &#x884C; &#xFF1A;&#x65B9;&#x5F0F;&#x4E8C; &#xFF1A;&#x57FA;&#x4E8E; <code>zero-copy</code> &#x5B9E;&#x73B0;&#xFF0C;&#x76F4;&#x63A5;&#x54CD;&#x5E94;&#xFF0C;&#x65E0;&#x9700;&#x5806;&#x5185;&#x5185;&#x5B58;&#xFF0C;&#x6027;&#x80FD;&#x66F4;&#x4F18;&#x3002;<em>TODO &#xFF1A;&#x6B64;&#x5904;&#x7B49;&#x5BF9;zero-copy&#x6709;&#x7814;&#x7A76;&#xFF0C;&#x518D;&#x8865;&#x5145;&#x4E00;&#x4E9B;</em>&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 284 &#x81F3; 300 &#x884C; &#xFF1A;&#x62C9;&#x53D6;&#x4E0D;&#x5230;&#x6D88;&#x606F;&#xFF0C;&#x5F53;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6; (<code>Broker</code> &#x5141;&#x8BB8;&#x6302;&#x8D77; &amp;&amp; &#x8BF7;&#x6C42;&#x8981;&#x6C42;&#x6302;&#x8D77;)&#xFF0C;&#x6267;&#x884C;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#pullrequestholdservice">PullRequestHoldService</a>&#x3002;</li>
<li>&#x7B2C; 304 &#x81F3; 328 &#x884C; &#xFF1A;<em>TODO &#xFF1A;&#x6B64;&#x5904;&#x7B49;&#x5BF9;<code>tools</code>&#x6A21;&#x5757;&#x7814;&#x7A76;&#x540E;&#x518D;&#x8865;&#x5145;</em>&#x3002;</li>
<li>&#x7B2C; 339 &#x81F3; 346 &#xFF1A;&#x6301;&#x4E45;&#x5316;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#xFF0C;&#x5F53;&#x6EE1;&#x8DB3; (<code>Broker</code> &#x975E;&#x4E3B; &amp;&amp; &#x8BF7;&#x6C42;&#x8981;&#x6C42;&#x6301;&#x4E45;&#x5316;&#x8FDB;&#x5EA6;)&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#3broker-&#x63D0;&#x4F9B;&#x66F4;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x63A5;&#x53E3;">&#x66F4;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</a>&#x3002;</li>
</ul>
<h2 id="MessageStore-getMessage-&#x2026;"><a href="#MessageStore-getMessage-&#x2026;" class="headerlink" title="MessageStore#getMessage(&#x2026;)"></a>MessageStore#getMessage(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line">  2:  * &#x83B7;&#x53D6;&#x6D88;&#x606F;&#x7ED3;&#x679C;</div><div class="line">  3:  *</div><div class="line">  4:  * <span class="doctag">@param</span> group &#x6D88;&#x8D39;&#x5206;&#x7EC4;</div><div class="line">  5:  * <span class="doctag">@param</span> topic &#x4E3B;&#x9898;</div><div class="line">  6:  * <span class="doctag">@param</span> queueId &#x961F;&#x5217;&#x7F16;&#x53F7;</div><div class="line">  7:  * <span class="doctag">@param</span> offset &#x961F;&#x5217;&#x4F4D;&#x7F6E;</div><div class="line">  8:  * <span class="doctag">@param</span> maxMsgNums &#x6D88;&#x606F;&#x6570;&#x91CF;</div><div class="line">  9:  * <span class="doctag">@param</span> subscriptionData &#x8BA2;&#x9605;&#x4FE1;&#x606F;</div><div class="line"> 10:  * <span class="doctag">@return</span> &#x6D88;&#x606F;&#x7ED3;&#x679C;</div><div class="line"> 11:  */</div><div class="line"> <span class="number">12</span>: <span class="function"><span class="keyword">public</span> GetMessageResult <span class="title">getMessage</span><span class="params">(<span class="keyword">final</span> String group, <span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> offset, <span class="keyword">final</span> <span class="keyword">int</span> maxMsgNums,</span></span></div><div class="line"> <span class="number">13</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData) {</div><div class="line"> <span class="number">14</span>:     <span class="comment">// &#x662F;&#x5426;&#x5173;&#x95ED;</span></div><div class="line"> <span class="number">15</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.shutdown) {</div><div class="line"> <span class="number">16</span>:         log.warn(<span class="string">&quot;message store has shutdown, so getMessage is forbidden&quot;</span>);</div><div class="line"> <span class="number">17</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">18</span>:     }</div><div class="line"> <span class="number">19</span>:     <span class="comment">// &#x662F;&#x5426;&#x53EF;&#x8BFB;</span></div><div class="line"> <span class="number">20</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.runningFlags.isReadable()) {</div><div class="line"> <span class="number">21</span>:         log.warn(<span class="string">&quot;message store is not readable, so getMessage is forbidden &quot;</span> + <span class="keyword">this</span>.runningFlags.getFlagBits());</div><div class="line"> <span class="number">22</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">23</span>:     }</div><div class="line"> <span class="number">24</span>: </div><div class="line"> <span class="number">25</span>:     <span class="keyword">long</span> beginTime = <span class="keyword">this</span>.getSystemClock().now();</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:     GetMessageStatus status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</div><div class="line"> <span class="number">28</span>:     <span class="keyword">long</span> nextBeginOffset = offset;</div><div class="line"> <span class="number">29</span>:     <span class="keyword">long</span> minOffset = <span class="number">0</span>;</div><div class="line"> <span class="number">30</span>:     <span class="keyword">long</span> maxOffset = <span class="number">0</span>;</div><div class="line"> <span class="number">31</span>: </div><div class="line"> <span class="number">32</span>:     GetMessageResult getResult = <span class="keyword">new</span> GetMessageResult();</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:     <span class="keyword">final</span> <span class="keyword">long</span> maxOffsetPy = <span class="keyword">this</span>.commitLog.getMaxOffset();</div><div class="line"> <span class="number">35</span>: </div><div class="line"> <span class="number">36</span>:     <span class="comment">// &#x83B7;&#x53D6;&#x6D88;&#x8D39;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">37</span>:     ConsumeQueue consumeQueue = findConsumeQueue(topic, queueId);</div><div class="line"> <span class="number">38</span>:     <span class="keyword">if</span> (consumeQueue != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">39</span>:         minOffset = consumeQueue.getMinOffsetInQueue(); <span class="comment">// &#x6D88;&#x8D39;&#x961F;&#x5217; &#x6700;&#x5C0F;&#x961F;&#x5217;&#x7F16;&#x53F7;</span></div><div class="line"> <span class="number">40</span>:         maxOffset = consumeQueue.getMaxOffsetInQueue(); <span class="comment">// &#x6D88;&#x8D39;&#x961F;&#x5217; &#x6700;&#x5927;&#x961F;&#x5217;&#x7F16;&#x53F7;</span></div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:         <span class="comment">// &#x5224;&#x65AD; &#x961F;&#x5217;&#x4F4D;&#x7F6E;(offset)</span></div><div class="line"> <span class="number">43</span>:         <span class="keyword">if</span> (maxOffset == <span class="number">0</span>) { <span class="comment">// &#x6D88;&#x8D39;&#x961F;&#x5217;&#x65E0;&#x6D88;&#x606F;</span></div><div class="line"> <span class="number">44</span>:             status = GetMessageStatus.NO_MESSAGE_IN_QUEUE;</div><div class="line"> <span class="number">45</span>:             nextBeginOffset = nextOffsetCorrection(offset, <span class="number">0</span>);</div><div class="line"> <span class="number">46</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (offset &lt; minOffset) { <span class="comment">// &#x67E5;&#x8BE2;offset &#x592A;&#x5C0F;</span></div><div class="line"> <span class="number">47</span>:             status = GetMessageStatus.OFFSET_TOO_SMALL;</div><div class="line"> <span class="number">48</span>:             nextBeginOffset = nextOffsetCorrection(offset, minOffset);</div><div class="line"> <span class="number">49</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (offset == maxOffset) { <span class="comment">// &#x67E5;&#x8BE2;offset &#x8D85;&#x8FC7; &#x6D88;&#x8D39;&#x961F;&#x5217; &#x4E00;&#x4E2A;&#x4F4D;&#x7F6E;</span></div><div class="line"> <span class="number">50</span>:             status = GetMessageStatus.OFFSET_OVERFLOW_ONE;</div><div class="line"> <span class="number">51</span>:             nextBeginOffset = nextOffsetCorrection(offset, offset);</div><div class="line"> <span class="number">52</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (offset &gt; maxOffset) { <span class="comment">// &#x67E5;&#x8BE2;offset &#x8D85;&#x8FC7; &#x6D88;&#x8D39;&#x961F;&#x5217; &#x592A;&#x591A;(&#x5927;&#x4E8E;&#x4E00;&#x4E2A;&#x4F4D;&#x7F6E;)</span></div><div class="line"> <span class="number">53</span>:             status = GetMessageStatus.OFFSET_OVERFLOW_BADLY;</div><div class="line"> <span class="number">54</span>:             <span class="keyword">if</span> (<span class="number">0</span> == minOffset) { <span class="comment">// TODO blog &#x8FD9;&#x91CC;&#x662F;&#xFF1F;&#xFF1F;&#x4E3A;&#x5565;0 == minOffset&#x505A;&#x4E86;&#x7279;&#x6B8A;&#x5224;&#x65AD;</span></div><div class="line"> <span class="number">55</span>:                 nextBeginOffset = nextOffsetCorrection(offset, minOffset);</div><div class="line"> <span class="number">56</span>:             } <span class="keyword">else</span> {</div><div class="line"> <span class="number">57</span>:                 nextBeginOffset = nextOffsetCorrection(offset, maxOffset);</div><div class="line"> <span class="number">58</span>:             }</div><div class="line"> <span class="number">59</span>:         } <span class="keyword">else</span> {</div><div class="line"> <span class="number">60</span>:             <span class="comment">// &#x83B7;&#x5F97; &#x6620;&#x5C04;Buffer&#x7ED3;&#x679C;(MappedFile)</span></div><div class="line"> <span class="number">61</span>:             SelectMappedBufferResult bufferConsumeQueue = consumeQueue.getIndexBuffer(offset);</div><div class="line"> <span class="number">62</span>:             <span class="keyword">if</span> (bufferConsumeQueue != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">63</span>:                 <span class="keyword">try</span> {</div><div class="line"> <span class="number">64</span>:                     status = GetMessageStatus.NO_MATCHED_MESSAGE;</div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:                     <span class="keyword">long</span> nextPhyFileStartOffset = Long.MIN_VALUE; <span class="comment">// commitLog&#x4E0B;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;(MappedFile)&#x5BF9;&#x5E94;&#x7684;&#x5F00;&#x59CB;offset&#x3002;</span></div><div class="line"> <span class="number">67</span>:                     <span class="keyword">long</span> maxPhyOffsetPulling = <span class="number">0</span>; <span class="comment">// &#x6D88;&#x606F;&#x7269;&#x7406;&#x4F4D;&#x7F6E;&#x62C9;&#x53D6;&#x5230;&#x7684;&#x6700;&#x5927;offset</span></div><div class="line"> <span class="number">68</span>: </div><div class="line"> <span class="number">69</span>:                     <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"> <span class="number">70</span>:                     <span class="keyword">final</span> <span class="keyword">int</span> maxFilterMessageCount = <span class="number">16000</span>;</div><div class="line"> <span class="number">71</span>:                     <span class="keyword">final</span> <span class="keyword">boolean</span> diskFallRecorded = <span class="keyword">this</span>.messageStoreConfig.isDiskFallRecorded();</div><div class="line"> <span class="number">72</span>:                     <span class="comment">// &#x5FAA;&#x73AF;&#x83B7;&#x53D6; &#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;</span></div><div class="line"> <span class="number">73</span>:                     <span class="keyword">for</span> (; i &lt; bufferConsumeQueue.getSize() &amp;&amp; i &lt; maxFilterMessageCount; i += ConsumeQueue.CQ_STORE_UNIT_SIZE) {</div><div class="line"> <span class="number">74</span>:                         <span class="keyword">long</span> offsetPy = bufferConsumeQueue.getByteBuffer().getLong(); <span class="comment">// &#x6D88;&#x606F;&#x7269;&#x7406;&#x4F4D;&#x7F6E;offset</span></div><div class="line"> <span class="number">75</span>:                         <span class="keyword">int</span> sizePy = bufferConsumeQueue.getByteBuffer().getInt(); <span class="comment">// &#x6D88;&#x606F;&#x957F;&#x5EA6;</span></div><div class="line"> <span class="number">76</span>:                         <span class="keyword">long</span> tagsCode = bufferConsumeQueue.getByteBuffer().getLong(); <span class="comment">// &#x6D88;&#x606F;tagsCode</span></div><div class="line"> <span class="number">77</span>:                         <span class="comment">// &#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x7269;&#x7406;&#x4F4D;&#x7F6E;&#x62C9;&#x53D6;&#x5230;&#x7684;&#x6700;&#x5927;offset</span></div><div class="line"> <span class="number">78</span>:                         maxPhyOffsetPulling = offsetPy;</div><div class="line"> <span class="number">79</span>:                         <span class="comment">// &#x5F53; offsetPy &#x5C0F;&#x4E8E; nextPhyFileStartOffset &#x65F6;&#xFF0C;&#x610F;&#x5473;&#x7740;&#x5BF9;&#x5E94;&#x7684; Message &#x5DF2;&#x7ECF;&#x79FB;&#x9664;&#xFF0C;&#x6240;&#x4EE5;&#x76F4;&#x63A5;continue&#xFF0C;&#x76F4;&#x5230;&#x53EF;&#x8BFB;&#x53D6;&#x7684;Message&#x3002;</span></div><div class="line"> <span class="number">80</span>:                         <span class="keyword">if</span> (nextPhyFileStartOffset != Long.MIN_VALUE) {</div><div class="line"> <span class="number">81</span>:                             <span class="keyword">if</span> (offsetPy &lt; nextPhyFileStartOffset)</div><div class="line"> <span class="number">82</span>:                                 <span class="keyword">continue</span>;</div><div class="line"> <span class="number">83</span>:                         }</div><div class="line"> <span class="number">84</span>:                         <span class="comment">// &#x6821;&#x9A8C; commitLog &#x662F;&#x5426;&#x9700;&#x8981;&#x786C;&#x76D8;&#xFF0C;&#x65E0;&#x6CD5;&#x5168;&#x90E8;&#x653E;&#x5728;&#x5185;&#x5B58;</span></div><div class="line"> <span class="number">85</span>:                         <span class="keyword">boolean</span> isInDisk = checkInDiskByCommitOffset(offsetPy, maxOffsetPy);</div><div class="line"> <span class="number">86</span>:                         <span class="comment">// &#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x83B7;&#x5F97;&#x8DB3;&#x591F;&#x6D88;&#x606F;</span></div><div class="line"> <span class="number">87</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.isTheBatchFull(sizePy, maxMsgNums, getResult.getBufferTotalSize(), getResult.getMessageCount(),</div><div class="line"> <span class="number">88</span>:                             isInDisk)) {</div><div class="line"> <span class="number">89</span>:                             <span class="keyword">break</span>;</div><div class="line"> <span class="number">90</span>:                         }</div><div class="line"> <span class="number">91</span>:                         <span class="comment">// &#x5224;&#x65AD;&#x6D88;&#x606F;&#x662F;&#x5426;&#x7B26;&#x5408;&#x6761;&#x4EF6;</span></div><div class="line"> <span class="number">92</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.messageFilter.isMessageMatched(subscriptionData, tagsCode)) {</div><div class="line"> <span class="number">93</span>:                             <span class="comment">// &#x4ECE;commitLog&#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x6D88;&#x606F;ByteBuffer</span></div><div class="line"> <span class="number">94</span>:                             SelectMappedBufferResult selectResult = <span class="keyword">this</span>.commitLog.getMessage(offsetPy, sizePy);</div><div class="line"> <span class="number">95</span>:                             <span class="keyword">if</span> (selectResult != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">96</span>:                                 <span class="keyword">this</span>.storeStatsService.getGetMessageTransferedMsgCount().incrementAndGet();</div><div class="line"> <span class="number">97</span>:                                 getResult.addMessage(selectResult);</div><div class="line"> <span class="number">98</span>:                                 status = GetMessageStatus.FOUND;</div><div class="line"> <span class="number">99</span>:                                 nextPhyFileStartOffset = Long.MIN_VALUE;</div><div class="line"><span class="number">100</span>:                             } <span class="keyword">else</span> {</div><div class="line"><span class="number">101</span>:                                 <span class="comment">// &#x4ECE;commitLog&#x65E0;&#x6CD5;&#x8BFB;&#x53D6;&#x5230;&#x6D88;&#x606F;&#xFF0C;&#x8BF4;&#x660E;&#x8BE5;&#x6D88;&#x606F;&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;&#xFF08;MappedFile&#xFF09;&#x5DF2;&#x7ECF;&#x5220;&#x9664;&#xFF0C;&#x8BA1;&#x7B97;&#x4E0B;&#x4E00;&#x4E2A;MappedFile&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;</span></div><div class="line"><span class="number">102</span>:                                 <span class="keyword">if</span> (getResult.getBufferTotalSize() == <span class="number">0</span>) {</div><div class="line"><span class="number">103</span>:                                     status = GetMessageStatus.MESSAGE_WAS_REMOVING;</div><div class="line"><span class="number">104</span>:                                 }</div><div class="line"><span class="number">105</span>:                                 nextPhyFileStartOffset = <span class="keyword">this</span>.commitLog.rollNextFile(offsetPy);</div><div class="line"><span class="number">106</span>:                             }</div><div class="line"><span class="number">107</span>:                         } <span class="keyword">else</span> {</div><div class="line"><span class="number">108</span>:                             <span class="keyword">if</span> (getResult.getBufferTotalSize() == <span class="number">0</span>) {</div><div class="line"><span class="number">109</span>:                                 status = GetMessageStatus.NO_MATCHED_MESSAGE;</div><div class="line"><span class="number">110</span>:                             }</div><div class="line"><span class="number">111</span>: </div><div class="line"><span class="number">112</span>:                             <span class="keyword">if</span> (log.isDebugEnabled()) {</div><div class="line"><span class="number">113</span>:                                 log.debug(<span class="string">&quot;message type not matched, client: &quot;</span> + subscriptionData + <span class="string">&quot; server: &quot;</span> + tagsCode);</div><div class="line"><span class="number">114</span>:                             }</div><div class="line"><span class="number">115</span>:                         }</div><div class="line"><span class="number">116</span>:                     }</div><div class="line"><span class="number">117</span>:                     <span class="comment">// &#x7EDF;&#x8BA1;&#x5269;&#x4F59;&#x53EF;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x5B57;&#x8282;&#x6570;</span></div><div class="line"><span class="number">118</span>:                     <span class="keyword">if</span> (diskFallRecorded) {</div><div class="line"><span class="number">119</span>:                         <span class="keyword">long</span> fallBehind = maxOffsetPy - maxPhyOffsetPulling;</div><div class="line"><span class="number">120</span>:                         brokerStatsManager.recordDiskFallBehindSize(group, topic, queueId, fallBehind);</div><div class="line"><span class="number">121</span>:                     }</div><div class="line"><span class="number">122</span>:                     <span class="comment">// &#x8BA1;&#x7B97;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7F16;&#x53F7;</span></div><div class="line"><span class="number">123</span>:                     nextBeginOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</div><div class="line"><span class="number">124</span>:                     <span class="comment">// &#x6839;&#x636E;&#x5269;&#x4F59;&#x53EF;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x5B57;&#x8282;&#x6570;&#x4E0E;&#x5185;&#x5B58;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5EFA;&#x8BAE;&#x8BFB;&#x53D6;&#x4ECE;&#x8282;&#x70B9;</span></div><div class="line"><span class="number">125</span>:                     <span class="keyword">long</span> diff = maxOffsetPy - maxPhyOffsetPulling;</div><div class="line"><span class="number">126</span>:                     <span class="keyword">long</span> memory = (<span class="keyword">long</span>) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE</div><div class="line"><span class="number">127</span>:                             * (<span class="keyword">this</span>.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / <span class="number">100.0</span>));</div><div class="line"><span class="number">128</span>:                     getResult.setSuggestPullingFromSlave(diff &gt; memory);</div><div class="line"><span class="number">129</span>:                 } <span class="keyword">finally</span> {</div><div class="line"><span class="number">130</span>:                     bufferConsumeQueue.release();</div><div class="line"><span class="number">131</span>:                 }</div><div class="line"><span class="number">132</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">133</span>:                 status = GetMessageStatus.OFFSET_FOUND_NULL;</div><div class="line"><span class="number">134</span>:                 nextBeginOffset = nextOffsetCorrection(offset, consumeQueue.rollNextFile(offset));</div><div class="line"><span class="number">135</span>:                 log.warn(<span class="string">&quot;consumer request topic: &quot;</span> + topic + <span class="string">&quot;offset: &quot;</span> + offset + <span class="string">&quot; minOffset: &quot;</span> + minOffset + <span class="string">&quot; maxOffset: &quot;</span></div><div class="line"><span class="number">136</span>:                     + maxOffset + <span class="string">&quot;, but access logic queue failed.&quot;</span>);</div><div class="line"><span class="number">137</span>:             }</div><div class="line"><span class="number">138</span>:         }</div><div class="line"><span class="number">139</span>:     } <span class="keyword">else</span> {</div><div class="line"><span class="number">140</span>:         status = GetMessageStatus.NO_MATCHED_LOGIC_QUEUE;</div><div class="line"><span class="number">141</span>:         nextBeginOffset = nextOffsetCorrection(offset, <span class="number">0</span>);</div><div class="line"><span class="number">142</span>:     }</div><div class="line"><span class="number">143</span>:     <span class="comment">// &#x7EDF;&#x8BA1;</span></div><div class="line"><span class="number">144</span>:     <span class="keyword">if</span> (GetMessageStatus.FOUND == status) {</div><div class="line"><span class="number">145</span>:         <span class="keyword">this</span>.storeStatsService.getGetMessageTimesTotalFound().incrementAndGet();</div><div class="line"><span class="number">146</span>:     } <span class="keyword">else</span> {</div><div class="line"><span class="number">147</span>:         <span class="keyword">this</span>.storeStatsService.getGetMessageTimesTotalMiss().incrementAndGet();</div><div class="line"><span class="number">148</span>:     }</div><div class="line"><span class="number">149</span>:     <span class="keyword">long</span> eclipseTime = <span class="keyword">this</span>.getSystemClock().now() - beginTime;</div><div class="line"><span class="number">150</span>:     <span class="keyword">this</span>.storeStatsService.setGetMessageEntireTimeMax(eclipseTime);</div><div class="line"><span class="number">151</span>:     <span class="comment">// &#x8BBE;&#x7F6E;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;</span></div><div class="line"><span class="number">152</span>:     getResult.setStatus(status);</div><div class="line"><span class="number">153</span>:     getResult.setNextBeginOffset(nextBeginOffset);</div><div class="line"><span class="number">154</span>:     getResult.setMaxOffset(maxOffset);</div><div class="line"><span class="number">155</span>:     getResult.setMinOffset(minOffset);</div><div class="line"><span class="number">156</span>:     <span class="keyword">return</span> getResult;</div><div class="line"><span class="number">157</span>: }</div><div class="line"><span class="number">158</span>: </div><div class="line"><span class="number">159</span>: <span class="comment">/**</span></div><div class="line">160:  * &#x6839;&#x636E; &#x4E3B;&#x9898; + &#x961F;&#x5217;&#x7F16;&#x53F7; &#x83B7;&#x53D6; &#x6D88;&#x8D39;&#x961F;&#x5217;</div><div class="line">161:  *</div><div class="line">162:  * <span class="doctag">@param</span> topic &#x4E3B;&#x9898;</div><div class="line">163:  * <span class="doctag">@param</span> queueId &#x961F;&#x5217;&#x7F16;&#x53F7;</div><div class="line">164:  * <span class="doctag">@return</span> &#x6D88;&#x8D39;&#x961F;&#x5217;</div><div class="line">165:  */</div><div class="line"><span class="number">166</span>: <span class="function"><span class="keyword">public</span> ConsumeQueue <span class="title">findConsumeQueue</span><span class="params">(String topic, <span class="keyword">int</span> queueId)</span> </span>{</div><div class="line"><span class="number">167</span>:     <span class="comment">// &#x83B7;&#x53D6; topic &#x5BF9;&#x5E94;&#x7684; &#x6240;&#x6709;&#x6D88;&#x8D39;&#x961F;&#x5217;</span></div><div class="line"><span class="number">168</span>:     ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; map = consumeQueueTable.get(topic);</div><div class="line"><span class="number">169</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == map) {</div><div class="line"><span class="number">170</span>:         ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; newMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">128</span>);</div><div class="line"><span class="number">171</span>:         ConcurrentHashMap&lt;Integer, ConsumeQueue&gt; oldMap = consumeQueueTable.putIfAbsent(topic, newMap);</div><div class="line"><span class="number">172</span>:         <span class="keyword">if</span> (oldMap != <span class="keyword">null</span>) {</div><div class="line"><span class="number">173</span>:             map = oldMap;</div><div class="line"><span class="number">174</span>:         } <span class="keyword">else</span> {</div><div class="line"><span class="number">175</span>:             map = newMap;</div><div class="line"><span class="number">176</span>:         }</div><div class="line"><span class="number">177</span>:     }</div><div class="line"><span class="number">178</span>:     <span class="comment">// &#x83B7;&#x53D6; queueId &#x5BF9;&#x5E94;&#x7684; &#x6D88;&#x8D39;&#x961F;&#x5217;</span></div><div class="line"><span class="number">179</span>:     ConsumeQueue logic = map.get(queueId);</div><div class="line"><span class="number">180</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == logic) {</div><div class="line"><span class="number">181</span>:         ConsumeQueue newLogic = <span class="keyword">new</span> ConsumeQueue(<span class="comment">//</span></div><div class="line"><span class="number">182</span>:             topic, <span class="comment">//</span></div><div class="line"><span class="number">183</span>:             queueId, <span class="comment">//</span></div><div class="line"><span class="number">184</span>:             StorePathConfigHelper.getStorePathConsumeQueue(<span class="keyword">this</span>.messageStoreConfig.getStorePathRootDir()), <span class="comment">//</span></div><div class="line"><span class="number">185</span>:             <span class="keyword">this</span>.getMessageStoreConfig().getMapedFileSizeConsumeQueue(), <span class="comment">//</span></div><div class="line"><span class="number">186</span>:             <span class="keyword">this</span>);</div><div class="line"><span class="number">187</span>:         ConsumeQueue oldLogic = map.putIfAbsent(queueId, newLogic);</div><div class="line"><span class="number">188</span>:         <span class="keyword">if</span> (oldLogic != <span class="keyword">null</span>) {</div><div class="line"><span class="number">189</span>:             logic = oldLogic;</div><div class="line"><span class="number">190</span>:         } <span class="keyword">else</span> {</div><div class="line"><span class="number">191</span>:             logic = newLogic;</div><div class="line"><span class="number">192</span>:         }</div><div class="line"><span class="number">193</span>:     }</div><div class="line"><span class="number">194</span>: </div><div class="line"><span class="number">195</span>:     <span class="keyword">return</span> logic;</div><div class="line"><span class="number">196</span>: }</div><div class="line"><span class="number">197</span>: </div><div class="line"><span class="number">198</span>: <span class="comment">/**</span></div><div class="line">199:  * &#x4E0B;&#x4E00;&#x4E2A;&#x83B7;&#x53D6;&#x961F;&#x5217;offset&#x4FEE;&#x6B63;</div><div class="line">200:  * &#x4FEE;&#x6B63;&#x6761;&#x4EF6;&#xFF1A;&#x4E3B;&#x8282;&#x70B9; &#x6216;&#x8005; &#x4ECE;&#x8282;&#x70B9;&#x5F00;&#x542F;&#x6821;&#x9A8C;offset&#x5F00;&#x5173;</div><div class="line">201:  *</div><div class="line">202:  * <span class="doctag">@param</span> oldOffset &#x8001;&#x961F;&#x5217;offset</div><div class="line">203:  * <span class="doctag">@param</span> newOffset &#x65B0;&#x961F;&#x5217;offset</div><div class="line">204:  * <span class="doctag">@return</span> &#x4FEE;&#x6B63;&#x540E;&#x7684;&#x961F;&#x5217;offset</div><div class="line">205:  */</div><div class="line"><span class="number">206</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">nextOffsetCorrection</span><span class="params">(<span class="keyword">long</span> oldOffset, <span class="keyword">long</span> newOffset)</span> </span>{</div><div class="line"><span class="number">207</span>:     <span class="keyword">long</span> nextOffset = oldOffset;</div><div class="line"><span class="number">208</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole() != BrokerRole.SLAVE || <span class="keyword">this</span>.getMessageStoreConfig().isOffsetCheckInSlave()) {</div><div class="line"><span class="number">209</span>:         nextOffset = newOffset;</div><div class="line"><span class="number">210</span>:     }</div><div class="line"><span class="number">211</span>:     <span class="keyword">return</span> nextOffset;</div><div class="line"><span class="number">212</span>: }</div><div class="line"><span class="number">213</span>: </div><div class="line"><span class="number">214</span>: <span class="comment">/**</span></div><div class="line">215:  * &#x6821;&#x9A8C; commitLog &#x662F;&#x5426;&#x9700;&#x8981;&#x786C;&#x76D8;&#xFF0C;&#x65E0;&#x6CD5;&#x5168;&#x90E8;&#x653E;&#x5728;&#x5185;&#x5B58;</div><div class="line">216:  *</div><div class="line">217:  * <span class="doctag">@param</span> offsetPy commitLog &#x6307;&#x5B9A;offset</div><div class="line">218:  * <span class="doctag">@param</span> maxOffsetPy commitLog &#x6700;&#x5927;offset</div><div class="line">219:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x9700;&#x8981;&#x786C;&#x76D8;</div><div class="line">220:  */</div><div class="line"><span class="number">221</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkInDiskByCommitOffset</span><span class="params">(<span class="keyword">long</span> offsetPy, <span class="keyword">long</span> maxOffsetPy)</span> </span>{</div><div class="line"><span class="number">222</span>:     <span class="keyword">long</span> memory = (<span class="keyword">long</span>) (StoreUtil.TOTAL_PHYSICAL_MEMORY_SIZE * (<span class="keyword">this</span>.messageStoreConfig.getAccessMessageInMemoryMaxRatio() / <span class="number">100.0</span>));</div><div class="line"><span class="number">223</span>:     <span class="keyword">return</span> (maxOffsetPy - offsetPy) &gt; memory;</div><div class="line"><span class="number">224</span>: }</div><div class="line"><span class="number">225</span>: </div><div class="line"><span class="number">226</span>: <span class="comment">/**</span></div><div class="line">227:  * &#x5224;&#x65AD;&#x83B7;&#x53D6;&#x6D88;&#x606F;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x6EE1;</div><div class="line">228:  *</div><div class="line">229:  * <span class="doctag">@param</span> sizePy &#x5B57;&#x8282;&#x6570;</div><div class="line">230:  * <span class="doctag">@param</span> maxMsgNums &#x6700;&#x5927;&#x6D88;&#x606F;&#x6570;</div><div class="line">231:  * <span class="doctag">@param</span> bufferTotal &#x76EE;&#x524D;&#x5DF2;&#x7ECF;&#x8BA1;&#x7B97;&#x5B57;&#x8282;&#x6570;</div><div class="line">232:  * <span class="doctag">@param</span> messageTotal &#x76EE;&#x524D;&#x5DF2;&#x7ECF;&#x8BA1;&#x7B97;&#x6D88;&#x606F;&#x6570;</div><div class="line">233:  * <span class="doctag">@param</span> isInDisk &#x662F;&#x5426;&#x5728;&#x786C;&#x76D8;&#x4E2D;</div><div class="line">234:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x5DF2;&#x6EE1;</div><div class="line">235:  */</div><div class="line"><span class="number">236</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isTheBatchFull</span><span class="params">(<span class="keyword">int</span> sizePy, <span class="keyword">int</span> maxMsgNums, <span class="keyword">int</span> bufferTotal, <span class="keyword">int</span> messageTotal, <span class="keyword">boolean</span> isInDisk)</span> </span>{</div><div class="line"><span class="number">237</span>:     <span class="keyword">if</span> (<span class="number">0</span> == bufferTotal || <span class="number">0</span> == messageTotal) {</div><div class="line"><span class="number">238</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">239</span>:     }</div><div class="line"><span class="number">240</span>:     <span class="comment">// &#x6D88;&#x606F;&#x6570;&#x91CF;&#x5DF2;&#x7ECF;&#x6EE1;&#x8DB3;&#x8BF7;&#x6C42;&#x6570;&#x91CF;(maxMsgNums)</span></div><div class="line"><span class="number">241</span>:     <span class="keyword">if</span> ((messageTotal + <span class="number">1</span>) &gt;= maxMsgNums) {</div><div class="line"><span class="number">242</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">243</span>:     }</div><div class="line"><span class="number">244</span>:     <span class="comment">// &#x6839;&#x636E;&#x6D88;&#x606F;&#x5B58;&#x50A8;&#x914D;&#x7F6E;&#x7684;&#x6700;&#x5927;&#x4F20;&#x8F93;&#x5B57;&#x8282;&#x6570;&#x3001;&#x6700;&#x5927;&#x4F20;&#x8F93;&#x6D88;&#x606F;&#x6570;&#x662F;&#x5426;&#x5DF2;&#x6EE1;</span></div><div class="line"><span class="number">245</span>:     <span class="keyword">if</span> (isInDisk) {</div><div class="line"><span class="number">246</span>:         <span class="keyword">if</span> ((bufferTotal + sizePy) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferBytesOnMessageInDisk()) {</div><div class="line"><span class="number">247</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">248</span>:         }</div><div class="line"><span class="number">249</span>: </div><div class="line"><span class="number">250</span>:         <span class="keyword">if</span> ((messageTotal + <span class="number">1</span>) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferCountOnMessageInDisk()) {</div><div class="line"><span class="number">251</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">252</span>:         }</div><div class="line"><span class="number">253</span>:     } <span class="keyword">else</span> {</div><div class="line"><span class="number">254</span>:         <span class="keyword">if</span> ((bufferTotal + sizePy) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferBytesOnMessageInMemory()) {</div><div class="line"><span class="number">255</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">256</span>:         }</div><div class="line"><span class="number">257</span>: </div><div class="line"><span class="number">258</span>:         <span class="keyword">if</span> ((messageTotal + <span class="number">1</span>) &gt; <span class="keyword">this</span>.messageStoreConfig.getMaxTransferCountOnMessageInMemory()) {</div><div class="line"><span class="number">259</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">260</span>:         }</div><div class="line"><span class="number">261</span>:     }</div><div class="line"><span class="number">262</span>: </div><div class="line"><span class="number">263</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">264</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x6839;&#x636E; &#x6D88;&#x606F;&#x5206;&#x7EC4;(<code>group</code>) + &#x4E3B;&#x9898;(<code>Topic</code>) + &#x961F;&#x5217;&#x7F16;&#x53F7;(<code>queueId</code>) + &#x961F;&#x5217;&#x4F4D;&#x7F6E;(<code>offset</code>) + &#x8BA2;&#x9605;&#x4FE1;&#x606F;(<code>subscriptionData</code>) &#x83B7;&#x53D6; &#x6307;&#x5B9A;&#x6761;&#x6570;(<code>maxMsgNums</code>) &#x6D88;&#x606F;(<code>Message</code>)&#x3002;</li>
<li>&#x7B2C; 14 &#x81F3; 18 &#x884C; &#xFF1A;&#x5224;&#x65AD; <code>Store</code> &#x662F;&#x5426;&#x5904;&#x4E8E;&#x5173;&#x95ED;&#x72B6;&#x6001;&#xFF0C;&#x82E5;&#x5173;&#x95ED;&#xFF0C;&#x5219;&#x65E0;&#x6CD5;&#x83B7;&#x53D6;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 19 &#x81F3; 23 &#x884C; &#xFF1A;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x72B6;&#x6001;&#x662F;&#x5426;&#x53EF;&#x8BFB;&#xFF0C;&#x82E5;&#x4E0D;&#x53EF;&#x8BFB;&#xFF0C;&#x5219;&#x65E0;&#x6CD5;&#x83B7;&#x53D6;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 37 &#x884C; &#xFF1A;&#x6839;&#x636E; &#x4E3B;&#x9898;(<code>Topic</code>) + &#x961F;&#x5217;&#x7F16;&#x53F7;(<code>queueId</code>) &#x83B7;&#x53D6; &#x6D88;&#x606F;&#x961F;&#x5217;(<code>ConsumeQueue</code>)&#x3002;<ul>
<li><code>#findConsumeQueue(...)</code> &#xFF1A;&#x7B2C; 159 &#x81F3; 196 &#x884C;&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 43 &#x81F3; 58 &#x884C; &#xFF1A;&#x5404;&#x79CD;&#x961F;&#x5217;&#x4F4D;&#x7F6E;(<code>offset</code>) &#x65E0;&#x6CD5;&#x8BFB;&#x53D6;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x9488;&#x5BF9;&#x5BF9;&#x5E94;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x8BA1;&#x7B97;&#x4E0B;&#x4E00;&#x6B21; <code>Client</code> &#x961F;&#x5217;&#x62C9;&#x53D6;&#x4F4D;&#x7F6E;&#x3002;<ul>
<li>&#x7B2C; 43 &#x81F3; 45 &#x884C; &#xFF1A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x65E0;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 46 &#x81F3; 48 &#x884C; &#xFF1A;&#x67E5;&#x8BE2;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#xFF08;<code>offset</code>&#xFF09; &#x592A;&#x5C0F;&#x3002;</li>
<li>&#x7B2C; 49 &#x81F3; 51 &#x884C; &#xFF1A;&#x67E5;&#x8BE2;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#xFF08;<code>offset</code>&#xFF09; &#x6070;&#x597D;&#x7B49;&#x4E8E; &#x6D88;&#x606F;&#x961F;&#x5217;&#x6700;&#x5927;&#x7684;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x3002;&#x8BE5;&#x60C5;&#x51B5;&#x662F;&#x6B63;&#x5E38;&#x73B0;&#x8C61;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x67E5;&#x8BE2;&#x6700;&#x65B0;&#x7684;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 52 &#x81F3; 58 &#x884C; &#xFF1A;&#x67E5;&#x8BE2;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#xFF08;<code>offset</code>&#xFF09; &#x8D85;&#x8FC7;&#x8FC7;&#x591A;&#x3002;</li>
<li><code>#nextOffsetCorrection(...)</code> &#xFF1A;&#x7B2C; 198 &#x81F3; 212 &#x884C;&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 61 &#x884C; &#xFF1A;&#x6839;&#x636E; &#x6D88;&#x8D39;&#x961F;&#x5217;&#x4F4D;&#x7F6E;(<code>offset</code>) &#x83B7;&#x53D6; &#x5BF9;&#x5E94;&#x7684;<code>MappedFile</code>&#x3002;</li>
<li>&#x7B2C; 72 &#x81F3; 128 &#x884C; &#xFF1A;<strong>&#x5FAA;&#x73AF;</strong>&#x83B7;&#x53D6; <code>&#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;</code>&#x3002;<ul>
<li>&#x7B2C; 74 &#x81F3; 76 &#x884C; &#xFF1A;&#x8BFB;&#x53D6;&#x6BCF;&#x4E00;&#x4E2A; <code>&#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x4FE1;&#x606F;</code>&#x3002;</li>
<li>&#x7B2C; 79 &#x81F3; 83 &#x884C; &#xFF1A;&#x5F53; <code>offsetPy</code> &#x5C0F;&#x4E8E; <code>nextPhyFileStartOffset</code> &#x65F6;&#xFF0C;&#x610F;&#x5473;&#x7740;&#x5BF9;<br>&#x5E94;&#x7684; <code>Message</code> &#x5DF2;&#x7ECF;&#x79FB;&#x9664;&#xFF0C;&#x6240;&#x4EE5;&#x76F4;&#x63A5;continue&#xFF0C;&#x76F4;&#x5230;&#x53EF;&#x8BFB;&#x53D6;&#x7684; <code>Message</code>&#x3002;</li>
<li>&#x7B2C; 84 &#x81F3; 90 &#x884C; &#xFF1A;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x83B7;&#x5F97;&#x8DB3;&#x591F;&#x7684;&#x6D88;&#x606F;&#x3002;<ul>
<li><code>#checkInDiskByCommitOffset(...)</code> &#xFF1A;&#x7B2C; 214 &#x81F3; 224 &#x884C;&#x3002;</li>
<li><code>#isTheBatchFull(...)</code> &#xFF1A;&#x7B2C; 226 &#x81F3; 264 &#x884C;&#x3002;</li>
</ul>
</li>
</ul>
</li>
<li>&#x7B2C; 92 &#x884C; &#xFF1A;&#x5224;&#x65AD;&#x6D88;&#x606F;&#x662F;&#x5426;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="defaultmessagefilterismessagematched">DefaultMessageFilter#isMessageMatched(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 94 &#x884C; &#xFF1A;&#x4ECE; <code>CommitLog</code> &#x83B7;&#x53D6;&#x5BF9;&#x5E94; &#x6D88;&#x606F;&#x7684;<code>MappedByteBuffer</code>&#x3002;</li>
<li>&#x7B2C; 95 &#x81F3; 99 &#x884C; &#xFF1A;&#x83B7;&#x53D6; <code>&#x6D88;&#x606F;MappedByteBuffer</code> &#x6210;&#x529F;&#x3002;</li>
<li>&#x7B2C; 100 &#x81F3; 106 &#x884C; &#xFF1A;&#x83B7;&#x53D6; <code>&#x6D88;&#x606F;MappedByteBuffer</code> &#x5931;&#x8D25;&#x3002;&#x4ECE; <code>CommitLog</code> &#x65E0;&#x6CD5;&#x8BFB;&#x53D6;&#x5230;&#x6D88;&#x606F;&#xFF0C;&#x8BF4;&#x660E; &#x8BE5;&#x6D88;&#x606F;&#x5BF9;&#x5E94;&#x7684;&#x6587;&#x4EF6;(<code>MappedFile</code>) &#x5DF2;&#x7ECF;&#x5220;&#x9664;&#xFF0C;&#x6B64;&#x65F6;&#x8BA1;&#x7B97;&#x4E0B;&#x4E00;&#x4E2A;<code>MappedFile</code>&#x7684;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;&#x3002;<strong>&#x8BE5;&#x903B;&#x8F91;&#x9700;&#x8981;&#x914D;&#x5408;&#xFF08;&#x7B2C; 79 &#x81F3; 83 &#x884C;&#xFF09;&#x4E00;&#x8D77;&#x7406;&#x89E3;&#x3002;</strong></li>
<li>&#x7B2C; 117 &#x81F3; 120 &#x884C; &#xFF1A;&#x7EDF;&#x8BA1;&#x5269;&#x4F59;&#x53EF;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x5B57;&#x8282;&#x6570;&#x3002;</li>
<li>&#x7B2C; 123 &#x884C; &#xFF1A;&#x8BA1;&#x7B97;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7F16;&#x53F7;&#x3002;</li>
<li>&#x7B2C; 124 &#x81F3; 128 &#x884C; &#xFF1A;&#x6839;&#x636E;&#x5269;&#x4F59;&#x53EF;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x5B57;&#x8282;&#x6570;&#x4E0E;&#x5185;&#x5B58;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5EFA;&#x8BAE;&#x8BFB;&#x53D6;&#x4ECE;&#x8282;&#x70B9;&#x3002;</li>
<li>&#x7B2C; 130 &#x884C; &#xFF1A;&#x91CA;&#x653E; <code>bufferConsumeQueue</code> &#x5BF9; <code>MappedFile</code> &#x7684;&#x6307;&#x5411;&#x3002;&#x6B64;&#x5904; <code>MappedFile</code> &#x662F; <code>ConsumeQueue</code> &#x91CC;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x4E0D;&#x662F; <code>CommitLog</code> &#x4E0B;&#x7684;&#x6587;&#x4EF6;&#x3002;</li>
<li>&#x7B2C; 133 &#x81F3; 136 &#x884C; &#xFF1A;&#x83B7;&#x5F97;&#x6D88;&#x8D39;&#x961F;&#x5217;&#x4F4D;&#x7F6E;(<code>offset</code>) &#x83B7;&#x53D6; &#x5BF9;&#x5E94;&#x7684;<code>MappedFile</code> &#x4E3A;<strong>&#x7A7A;</strong>&#xFF0C;&#x8BA1;&#x7B97;<code>ConsumeQueue</code> &#x4ECE; <code>offset</code> &#x5F00;&#x59CB;&#x7684;&#x4E0B;&#x4E00;&#x4E2A; <code>MappedFile</code> &#x5BF9;&#x5E94;&#x7684;&#x4F4D;&#x7F6E;&#x3002;</li>
<li>&#x7B2C; 143 &#x81F3; 150 &#x884C; &#xFF1A;&#x8BB0;&#x5F55;&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;&#xFF1A;&#x6D88;&#x8017;&#x65F6;&#x95F4;&#x3001;&#x62C9;&#x53D6;&#x5230;&#x6D88;&#x606F;/&#x672A;&#x62C9;&#x53D6;&#x5230;&#x6D88;&#x606F;&#x6B21;&#x6570;&#x3002;</li>
<li>&#x7B2C; 151 &#x81F3; 156 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x5E76;&#x8FD4;&#x56DE;&#x3002; </li>
</ul>
<h2 id="DefaultMessageFilter-isMessageMatched-&#x2026;"><a href="#DefaultMessageFilter-isMessageMatched-&#x2026;" class="headerlink" title="DefaultMessageFilter#isMessageMatched(&#x2026;)"></a>DefaultMessageFilter#isMessageMatched(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMessageFilter</span> <span class="keyword">implements</span> <span class="title">MessageFilter</span> </span>{</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">4</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMessageMatched</span><span class="params">(SubscriptionData subscriptionData, Long tagsCode)</span> </span>{</div><div class="line"> <span class="number">5</span>:         <span class="comment">// &#x6D88;&#x606F;tagsCode &#x7A7A;</span></div><div class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (tagsCode == <span class="keyword">null</span>) {</div><div class="line"> <span class="number">7</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> <span class="number">8</span>:         }</div><div class="line"> <span class="number">9</span>:         <span class="comment">// &#x8BA2;&#x9605;&#x6570;&#x636E; &#x7A7A;</span></div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) {</div><div class="line"><span class="number">11</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">12</span>:         }</div><div class="line"><span class="number">13</span>:         <span class="comment">// classFilter</span></div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (subscriptionData.isClassFilterMode())</div><div class="line"><span class="number">15</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">16</span>:         <span class="comment">// &#x8BA2;&#x9605;&#x8868;&#x8FBE;&#x5F0F; &#x5168;&#x5339;&#x914D;</span></div><div class="line"><span class="number">17</span>:         <span class="keyword">if</span> (subscriptionData.getSubString().equals(SubscriptionData.SUB_ALL)) {</div><div class="line"><span class="number">18</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">19</span>:         }</div><div class="line"><span class="number">20</span>:         <span class="comment">// &#x8BA2;&#x9605;&#x6570;&#x636E;code&#x6570;&#x7EC4; &#x662F;&#x5426;&#x5305;&#x542B; &#x6D88;&#x606F;tagsCode</span></div><div class="line"><span class="number">21</span>:         <span class="keyword">return</span> subscriptionData.getCodeSet().contains(tagsCode.intValue());</div><div class="line"><span class="number">22</span>:     }</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x6D88;&#x606F;&#x8FC7;&#x6EE4;&#x5668;&#x9ED8;&#x8BA4;&#x5B9E;&#x73B0;&#x3002;</li>
</ul>
<h2 id="PullRequestHoldService"><a href="#PullRequestHoldService" class="headerlink" title="PullRequestHoldService"></a>PullRequestHoldService</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullRequestHoldService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>{</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</div><div class="line">  <span class="number">4</span>: </div><div class="line">  <span class="number">5</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_QUEUEID_SEPARATOR = <span class="string">&quot;@&quot;</span>;</div><div class="line">  <span class="number">6</span>: </div><div class="line">  <span class="number">7</span>:     <span class="keyword">private</span> <span class="keyword">final</span> BrokerController brokerController;</div><div class="line">  <span class="number">8</span>: </div><div class="line">  <span class="number">9</span>:     <span class="keyword">private</span> <span class="keyword">final</span> SystemClock systemClock = <span class="keyword">new</span> SystemClock();</div><div class="line"> <span class="number">10</span>:     <span class="comment">/**</span></div><div class="line"> 11:      * &#x6D88;&#x606F;&#x8FC7;&#x6EE4;&#x5668;</div><div class="line"> 12:      */</div><div class="line"> <span class="number">13</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MessageFilter messageFilter = <span class="keyword">new</span> DefaultMessageFilter();</div><div class="line"> <span class="number">14</span>:     <span class="comment">/**</span></div><div class="line"> 15:      * &#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x96C6;&#x5408;</div><div class="line"> 16:      */</div><div class="line"> <span class="number">17</span>:     <span class="keyword">private</span> ConcurrentHashMap&lt;String<span class="comment">/* topic@queueId */</span>, ManyPullRequest&gt; pullRequestTable =</div><div class="line"> <span class="number">18</span>:             <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">1024</span>);</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:     <span class="function"><span class="keyword">public</span> <span class="title">PullRequestHoldService</span><span class="params">(<span class="keyword">final</span> BrokerController brokerController)</span> </span>{</div><div class="line"> <span class="number">21</span>:         <span class="keyword">this</span>.brokerController = brokerController;</div><div class="line"> <span class="number">22</span>:     }</div><div class="line"> <span class="number">23</span>: </div><div class="line"> <span class="number">24</span>:     <span class="comment">/**</span></div><div class="line"> 25:      * &#x6DFB;&#x52A0;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x6302;&#x8D77;&#x8BF7;&#x6C42;</div><div class="line"> 26:      *</div><div class="line"> 27:      * <span class="doctag">@param</span> topic &#x4E3B;&#x9898;</div><div class="line"> 28:      * <span class="doctag">@param</span> queueId &#x961F;&#x5217;&#x7F16;&#x53F7;</div><div class="line"> 29:      * <span class="doctag">@param</span> pullRequest &#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</div><div class="line"> 30:      */</div><div class="line"> <span class="number">31</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">suspendPullRequest</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> PullRequest pullRequest)</span> </span>{</div><div class="line"> <span class="number">32</span>:         String key = <span class="keyword">this</span>.buildKey(topic, queueId);</div><div class="line"> <span class="number">33</span>:         ManyPullRequest mpr = <span class="keyword">this</span>.pullRequestTable.get(key);</div><div class="line"> <span class="number">34</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == mpr) {</div><div class="line"> <span class="number">35</span>:             mpr = <span class="keyword">new</span> ManyPullRequest();</div><div class="line"> <span class="number">36</span>:             ManyPullRequest prev = <span class="keyword">this</span>.pullRequestTable.putIfAbsent(key, mpr);</div><div class="line"> <span class="number">37</span>:             <span class="keyword">if</span> (prev != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">38</span>:                 mpr = prev;</div><div class="line"> <span class="number">39</span>:             }</div><div class="line"> <span class="number">40</span>:         }</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:         mpr.addPullRequest(pullRequest);</div><div class="line"> <span class="number">43</span>:     }</div><div class="line"> <span class="number">44</span>: </div><div class="line"> <span class="number">45</span>:     <span class="comment">/**</span></div><div class="line"> 46:      * &#x6839;&#x636E; &#x4E3B;&#x9898; + &#x961F;&#x5217;&#x7F16;&#x53F7; &#x521B;&#x5EFA;&#x552F;&#x4E00;&#x6807;&#x8BC6;</div><div class="line"> 47:      *</div><div class="line"> 48:      * <span class="doctag">@param</span> topic &#x4E3B;&#x9898;</div><div class="line"> 49:      * <span class="doctag">@param</span> queueId &#x961F;&#x5217;&#x7F16;&#x53F7;</div><div class="line"> 50:      * <span class="doctag">@return</span> key</div><div class="line"> 51:      */</div><div class="line"> <span class="number">52</span>:     <span class="function"><span class="keyword">private</span> String <span class="title">buildKey</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId)</span> </span>{</div><div class="line"> <span class="number">53</span>:         StringBuilder sb = <span class="keyword">new</span> StringBuilder();</div><div class="line"> <span class="number">54</span>:         sb.append(topic);</div><div class="line"> <span class="number">55</span>:         sb.append(TOPIC_QUEUEID_SEPARATOR);</div><div class="line"> <span class="number">56</span>:         sb.append(queueId);</div><div class="line"> <span class="number">57</span>:         <span class="keyword">return</span> sb.toString();</div><div class="line"> <span class="number">58</span>:     }</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">61</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">62</span>:         log.info(<span class="string">&quot;{} service started&quot;</span>, <span class="keyword">this</span>.getServiceName());</div><div class="line"> <span class="number">63</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) {</div><div class="line"> <span class="number">64</span>:             <span class="keyword">try</span> {</div><div class="line"> <span class="number">65</span>:                 <span class="comment">// &#x6839;&#x636E; &#x957F;&#x8F6E;&#x8BAD; &#x8FD8;&#x662F; &#x77ED;&#x8F6E;&#x8BAD; &#x8BBE;&#x7F6E;&#x4E0D;&#x540C;&#x7684;&#x7B49;&#x5F85;&#x65F6;&#x95F4;</span></div><div class="line"> <span class="number">66</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isLongPollingEnable()) {</div><div class="line"> <span class="number">67</span>:                     <span class="keyword">this</span>.waitForRunning(<span class="number">5</span> * <span class="number">1000</span>);</div><div class="line"> <span class="number">68</span>:                 } <span class="keyword">else</span> {</div><div class="line"> <span class="number">69</span>:                     <span class="keyword">this</span>.waitForRunning(<span class="keyword">this</span>.brokerController.getBrokerConfig().getShortPollingTimeMills());</div><div class="line"> <span class="number">70</span>:                 }</div><div class="line"> <span class="number">71</span>:                 <span class="comment">// &#x68C0;&#x67E5;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#x662F;&#x5426;&#x6709;&#x9700;&#x8981;&#x901A;&#x77E5;&#x7684;</span></div><div class="line"> <span class="number">72</span>:                 <span class="keyword">long</span> beginLockTimestamp = <span class="keyword">this</span>.systemClock.now();</div><div class="line"> <span class="number">73</span>:                 <span class="keyword">this</span>.checkHoldRequest();</div><div class="line"> <span class="number">74</span>:                 <span class="keyword">long</span> costTime = <span class="keyword">this</span>.systemClock.now() - beginLockTimestamp;</div><div class="line"> <span class="number">75</span>:                 <span class="keyword">if</span> (costTime &gt; <span class="number">5</span> * <span class="number">1000</span>) {</div><div class="line"> <span class="number">76</span>:                     log.info(<span class="string">&quot;[NOTIFYME] check hold request cost {} ms.&quot;</span>, costTime);</div><div class="line"> <span class="number">77</span>:                 }</div><div class="line"> <span class="number">78</span>:             } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"> <span class="number">79</span>:                 log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service has exception. &quot;</span>, e);</div><div class="line"> <span class="number">80</span>:             }</div><div class="line"> <span class="number">81</span>:         }</div><div class="line"> <span class="number">82</span>: </div><div class="line"> <span class="number">83</span>:         log.info(<span class="string">&quot;{} service end&quot;</span>, <span class="keyword">this</span>.getServiceName());</div><div class="line"> <span class="number">84</span>:     }</div><div class="line"> <span class="number">85</span>: </div><div class="line"> <span class="number">86</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">87</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">88</span>:         <span class="keyword">return</span> PullRequestHoldService.class.getSimpleName();</div><div class="line"> <span class="number">89</span>:     }</div><div class="line"> <span class="number">90</span>: </div><div class="line"> <span class="number">91</span>:     <span class="comment">/**</span></div><div class="line"> 92:      * &#x904D;&#x5386;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#xFF0C;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709;&#x9700;&#x8981;&#x901A;&#x77E5;&#x7684;&#x8BF7;&#x6C42;&#x3002;</div><div class="line"> 93:      */</div><div class="line"> <span class="number">94</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkHoldRequest</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">95</span>:         <span class="keyword">for</span> (String key : <span class="keyword">this</span>.pullRequestTable.keySet()) {</div><div class="line"> <span class="number">96</span>:             String[] kArray = key.split(TOPIC_QUEUEID_SEPARATOR);</div><div class="line"> <span class="number">97</span>:             <span class="keyword">if</span> (<span class="number">2</span> == kArray.length) {</div><div class="line"> <span class="number">98</span>:                 String topic = kArray[<span class="number">0</span>];</div><div class="line"> <span class="number">99</span>:                 <span class="keyword">int</span> queueId = Integer.parseInt(kArray[<span class="number">1</span>]);</div><div class="line"><span class="number">100</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> offset = <span class="keyword">this</span>.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);</div><div class="line"><span class="number">101</span>:                 <span class="keyword">try</span> {</div><div class="line"><span class="number">102</span>:                     <span class="keyword">this</span>.notifyMessageArriving(topic, queueId, offset);</div><div class="line"><span class="number">103</span>:                 } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"><span class="number">104</span>:                     log.error(<span class="string">&quot;check hold request failed. topic={}, queueId={}&quot;</span>, topic, queueId, e);</div><div class="line"><span class="number">105</span>:                 }</div><div class="line"><span class="number">106</span>:             }</div><div class="line"><span class="number">107</span>:         }</div><div class="line"><span class="number">108</span>:     }</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:     <span class="comment">/**</span></div><div class="line">111:      * &#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709;&#x9700;&#x8981;&#x901A;&#x77E5;&#x7684;&#x8BF7;&#x6C42;</div><div class="line">112:      *</div><div class="line">113:      * <span class="doctag">@param</span> topic &#x4E3B;&#x9898;</div><div class="line">114:      * <span class="doctag">@param</span> queueId &#x961F;&#x5217;&#x7F16;&#x53F7;</div><div class="line">115:      * <span class="doctag">@param</span> maxOffset &#x6D88;&#x8D39;&#x961F;&#x5217;&#x6700;&#x5927;offset</div><div class="line">116:      */</div><div class="line"><span class="number">117</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyMessageArriving</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> maxOffset)</span> </span>{</div><div class="line"><span class="number">118</span>:         notifyMessageArriving(topic, queueId, maxOffset, <span class="keyword">null</span>);</div><div class="line"><span class="number">119</span>:     }</div><div class="line"><span class="number">120</span>: </div><div class="line"><span class="number">121</span>:     <span class="comment">/**</span></div><div class="line">122:      * &#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709;&#x9700;&#x8981;&#x901A;&#x77E5;&#x7684;&#x8BF7;&#x6C42;</div><div class="line">123:      *</div><div class="line">124:      * <span class="doctag">@param</span> topic &#x4E3B;&#x9898;</div><div class="line">125:      * <span class="doctag">@param</span> queueId &#x961F;&#x5217;&#x7F16;&#x53F7;</div><div class="line">126:      * <span class="doctag">@param</span> maxOffset &#x6D88;&#x8D39;&#x961F;&#x5217;&#x6700;&#x5927;offset</div><div class="line">127:      * <span class="doctag">@param</span> tagsCode &#x8FC7;&#x6EE4;tagsCode</div><div class="line">128:      */</div><div class="line"><span class="number">129</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyMessageArriving</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> maxOffset, <span class="keyword">final</span> Long tagsCode)</span> </span>{</div><div class="line"><span class="number">130</span>:         String key = <span class="keyword">this</span>.buildKey(topic, queueId);</div><div class="line"><span class="number">131</span>:         ManyPullRequest mpr = <span class="keyword">this</span>.pullRequestTable.get(key);</div><div class="line"><span class="number">132</span>:         <span class="keyword">if</span> (mpr != <span class="keyword">null</span>) {</div><div class="line"><span class="number">133</span>:             <span class="comment">//</span></div><div class="line"><span class="number">134</span>:             List&lt;PullRequest&gt; requestList = mpr.cloneListAndClear();</div><div class="line"><span class="number">135</span>:             <span class="keyword">if</span> (requestList != <span class="keyword">null</span>) {</div><div class="line"><span class="number">136</span>:                 List&lt;PullRequest&gt; replayList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// &#x4E0D;&#x7B26;&#x5408;&#x5524;&#x9192;&#x7684;&#x8BF7;&#x6C42;&#x6570;&#x7EC4;</span></div><div class="line"><span class="number">137</span>: </div><div class="line"><span class="number">138</span>:                 <span class="keyword">for</span> (PullRequest request : requestList) {</div><div class="line"><span class="number">139</span>:                     <span class="comment">// &#x5982;&#x679C; maxOffset &#x8FC7;&#x5C0F;&#xFF0C;&#x5219;&#x91CD;&#x65B0;&#x8BFB;&#x53D6;&#x4E00;&#x6B21;&#x3002;</span></div><div class="line"><span class="number">140</span>:                     <span class="keyword">long</span> newestOffset = maxOffset;</div><div class="line"><span class="number">141</span>:                     <span class="keyword">if</span> (newestOffset &lt;= request.getPullFromThisOffset()) {</div><div class="line"><span class="number">142</span>:                         newestOffset = <span class="keyword">this</span>.brokerController.getMessageStore().getMaxOffsetInQuque(topic, queueId);</div><div class="line"><span class="number">143</span>:                     }</div><div class="line"><span class="number">144</span>:                     <span class="comment">// &#x6709;&#x65B0;&#x7684;&#x5339;&#x914D;&#x6D88;&#x606F;&#xFF0C;&#x5524;&#x9192;&#x8BF7;&#x6C42;&#xFF0C;&#x5373;&#x518D;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3002;</span></div><div class="line"><span class="number">145</span>:                     <span class="keyword">if</span> (newestOffset &gt; request.getPullFromThisOffset()) {</div><div class="line"><span class="number">146</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.messageFilter.isMessageMatched(request.getSubscriptionData(), tagsCode)) {</div><div class="line"><span class="number">147</span>:                             <span class="keyword">try</span> {</div><div class="line"><span class="number">148</span>:                                 <span class="keyword">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</div><div class="line"><span class="number">149</span>:                                     request.getRequestCommand());</div><div class="line"><span class="number">150</span>:                             } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"><span class="number">151</span>:                                 log.error(<span class="string">&quot;execute request when wakeup failed.&quot;</span>, e);</div><div class="line"><span class="number">152</span>:                             }</div><div class="line"><span class="number">153</span>:                             <span class="keyword">continue</span>;</div><div class="line"><span class="number">154</span>:                         }</div><div class="line"><span class="number">155</span>:                     }</div><div class="line"><span class="number">156</span>:                     <span class="comment">// &#x8D85;&#x8FC7;&#x6302;&#x8D77;&#x65F6;&#x95F4;&#xFF0C;&#x5524;&#x9192;&#x8BF7;&#x6C42;&#xFF0C;&#x5373;&#x518D;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3002;</span></div><div class="line"><span class="number">157</span>:                     <span class="keyword">if</span> (System.currentTimeMillis() &gt;= (request.getSuspendTimestamp() + request.getTimeoutMillis())) {</div><div class="line"><span class="number">158</span>:                         <span class="keyword">try</span> {</div><div class="line"><span class="number">159</span>:                             <span class="keyword">this</span>.brokerController.getPullMessageProcessor().executeRequestWhenWakeup(request.getClientChannel(),</div><div class="line"><span class="number">160</span>:                                 request.getRequestCommand());</div><div class="line"><span class="number">161</span>:                         } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"><span class="number">162</span>:                             log.error(<span class="string">&quot;execute request when wakeup failed.&quot;</span>, e);</div><div class="line"><span class="number">163</span>:                         }</div><div class="line"><span class="number">164</span>:                         <span class="keyword">continue</span>;</div><div class="line"><span class="number">165</span>:                     }</div><div class="line"><span class="number">166</span>:                     <span class="comment">// &#x4E0D;&#x7B26;&#x5408;&#x518D;&#x6B21;&#x62C9;&#x53D6;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x518D;&#x6B21;&#x6DFB;&#x52A0;&#x56DE;&#x53BB;</span></div><div class="line"><span class="number">167</span>:                     replayList.add(request);</div><div class="line"><span class="number">168</span>:                 }</div><div class="line"><span class="number">169</span>:                 <span class="comment">// &#x6DFB;&#x52A0;&#x56DE;&#x53BB;</span></div><div class="line"><span class="number">170</span>:                 <span class="keyword">if</span> (!replayList.isEmpty()) {</div><div class="line"><span class="number">171</span>:                     mpr.addPullRequest(replayList);</div><div class="line"><span class="number">172</span>:                 }</div><div class="line"><span class="number">173</span>:             }</div><div class="line"><span class="number">174</span>:         }</div><div class="line"><span class="number">175</span>:     }</div><div class="line"><span class="number">176</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li><code>PullRequestHoldService</code> &#x8BF4;&#x660E; &#xFF1A;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x6302;&#x8D77;&#x7EF4;&#x62A4;&#x7EBF;&#x7A0B;&#x670D;&#x52A1;&#x3002;<ul>
<li>&#x5F53;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x83B7;&#x5F97;&#x4E0D;&#x4E86;&#x6D88;&#x606F;&#x65F6;&#xFF0C;&#x5219;&#x4F1A;&#x5C06;&#x8BF7;&#x6C42;&#x8FDB;&#x884C;&#x6302;&#x8D77;&#xFF0C;&#x6DFB;&#x52A0;&#x5230;&#x8BE5;&#x670D;&#x52A1;&#x3002;</li>
<li>&#x5F53;&#x6709;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x4FE1;&#x606F;&#x65F6; &#x6216; &#x6302;&#x8D77;&#x8D85;&#x65F6;&#x65F6;&#xFF0C;&#x91CD;&#x65B0;&#x6267;&#x884C;&#x83B7;&#x53D6;&#x6D88;&#x606F;&#x903B;&#x8F91;&#x3002;</li>
</ul>
</li>
<li><code>#suspendPullRequest(...)</code> &#x8BF4;&#x660E; &#xFF1A;&#x6DFB;&#x52A0;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#x5230;&#x96C6;&#x5408;( <code>pullRequestTable</code> )&#x3002;</li>
<li><code>#run(...)</code> &#x8BF4;&#x660E; &#xFF1A;<strong>&#x5B9A;&#x65F6;</strong>&#x68C0;&#x67E5;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#x662F;&#x5426;&#x6709;&#x9700;&#x8981;&#x901A;&#x77E5;&#x91CD;&#x65B0;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x5E76;&#x8FDB;&#x884C;&#x901A;&#x77E5;&#x3002;<ul>
<li>&#x7B2C; 65 &#x81F3; 70 &#x884C; &#xFF1A;&#x6839;&#x636E;<code>&#x957F;&#x8F6E;&#x8BAD;</code>or<code>&#x77ED;&#x8F6E;&#x8BAD;</code>&#x8BBE;&#x7F6E;&#x4E0D;&#x540C;&#x7684;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#x3002;</li>
<li>&#x7B2C; 71 &#x81F3; 77 &#x884C; &#xFF1A;&#x68C0;&#x67E5;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#x662F;&#x5426;&#x6709;&#x9700;&#x8981;&#x901A;&#x77E5;&#x7684;&#x3002;</li>
</ul>
</li>
<li><code>#checkHoldRequest(...)</code> &#x8BF4;&#x660E; &#xFF1A;&#x904D;&#x5386;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#xFF0C;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x6709;&#x9700;&#x8981;&#x901A;&#x77E5;&#x7684;&#x3002;</li>
<li><code>#notifyMessageArriving(...)</code> &#x8BF4;&#x660E; &#xFF1A;&#x68C0;&#x67E5;<strong>&#x6307;&#x5B9A;&#x961F;&#x5217;</strong>&#x662F;&#x5426;&#x6709;&#x9700;&#x8981;&#x901A;&#x77E5;&#x7684;&#x8BF7;&#x6C42;&#x3002;<ul>
<li>&#x7B2C; 139 &#x81F3; 143 &#x884C; &#xFF1A;&#x5982;&#x679C; <code>maxOffset</code> &#x8FC7;&#x5C0F;&#xFF0C;&#x91CD;&#x65B0;&#x83B7;&#x53D6;&#x4E00;&#x6B21;&#x6700;&#x65B0;&#x7684;&#x3002;</li>
<li>&#x7B2C; 144 &#x81F3; 155 &#x884C; &#xFF1A;&#x6709;&#x65B0;&#x7684;&#x5339;&#x914D;&#x6D88;&#x606F;&#xFF0C;&#x5524;&#x9192;&#x8BF7;&#x6C42;&#xFF0C;&#x5373;&#x518D;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 156 &#x81F3; 165 &#x884C; &#xFF1A;&#x8D85;&#x8FC7;&#x6302;&#x8D77;&#x65F6;&#x95F4;&#xFF0C;&#x5524;&#x9192;&#x8BF7;&#x6C42;&#xFF0C;&#x5373;&#x518D;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 148 || 159 &#x884C; &#xFF1A;&#x5524;&#x9192;&#x8BF7;&#x6C42;&#xFF0C;&#x518D;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3002;&#x539F;&#x5148;&#x62C5;&#x5FC3;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x65F6;&#x95F4;&#x8FC7;&#x957F;&#xFF0C;&#x5BFC;&#x81F4;&#x5F71;&#x54CD;&#x6574;&#x4E2A;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#x7684;&#x904D;&#x5386;&#xFF0C;&#x540E;&#x9762;&#x67E5;&#x770B;<code>#executeRequestWhenWakeup(...)</code>&#xFF0C;&#x5B9E;&#x9645;&#x662F;&#x4E22;&#x5230;&#x7EBF;&#x7A0B;&#x6C60;&#x8FDB;&#x884C;&#x4E00;&#x6B65;&#x7684;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#xFF0C;&#x4E0D;&#x4F1A;&#x6709;&#x6027;&#x80FD;&#x4E0A;&#x7684;&#x95EE;&#x9898;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="pullmessageprocessorexecuterequestwhenwakeup">PullMessageProcessor#executeRequestWhenWakeup(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 166 &#x81F3; 172 &#x884C; &#xFF1A;&#x4E0D;&#x7B26;&#x5408;&#x5524;&#x9192;&#x7684;&#x8BF7;&#x6C42;&#x91CD;&#x65B0;&#x6DFB;&#x52A0;&#x5230;&#x96C6;&#x5408;(<code>pullRequestTable</code>)&#x3002;</li>
</ul>
</li>
</ul>
<h2 id="PullMessageProcessor-executeRequestWhenWakeup-&#x2026;"><a href="#PullMessageProcessor-executeRequestWhenWakeup-&#x2026;" class="headerlink" title="PullMessageProcessor#executeRequestWhenWakeup(&#x2026;)"></a>PullMessageProcessor#executeRequestWhenWakeup(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeRequestWhenWakeup</span><span class="params">(<span class="keyword">final</span> Channel channel, <span class="keyword">final</span> RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>{</div><div class="line"> <span class="number">2</span>:     Runnable run = <span class="keyword">new</span> Runnable() {</div><div class="line"> <span class="number">3</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">4</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">5</span>:             <span class="keyword">try</span> {</div><div class="line"> <span class="number">6</span>:                 <span class="comment">// &#x8C03;&#x7528;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x3002;&#x672C;&#x6B21;&#x8C03;&#x7528;&#xFF0C;&#x8BBE;&#x7F6E;&#x4E0D;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#x3002;</span></div><div class="line"> <span class="number">7</span>:                 <span class="keyword">final</span> RemotingCommand response = PullMessageProcessor.<span class="keyword">this</span>.processRequest(channel, request, <span class="keyword">false</span>);</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:                 <span class="keyword">if</span> (response != <span class="keyword">null</span>) {</div><div class="line"><span class="number">10</span>:                     response.setOpaque(request.getOpaque());</div><div class="line"><span class="number">11</span>:                     response.markResponseType();</div><div class="line"><span class="number">12</span>:                     <span class="keyword">try</span> {</div><div class="line"><span class="number">13</span>:                         channel.writeAndFlush(response).addListener(<span class="keyword">new</span> ChannelFutureListener() {</div><div class="line"><span class="number">14</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">15</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</div><div class="line"><span class="number">16</span>:                                 <span class="keyword">if</span> (!future.isSuccess()) {</div><div class="line"><span class="number">17</span>:                                     LOG.error(<span class="string">&quot;ProcessRequestWrapper response to {} failed&quot;</span>, future.channel().remoteAddress(), future.cause());</div><div class="line"><span class="number">18</span>:                                     LOG.error(request.toString());</div><div class="line"><span class="number">19</span>:                                     LOG.error(response.toString());</div><div class="line"><span class="number">20</span>:                                 }</div><div class="line"><span class="number">21</span>:                             }</div><div class="line"><span class="number">22</span>:                         });</div><div class="line"><span class="number">23</span>:                     } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"><span class="number">24</span>:                         LOG.error(<span class="string">&quot;ProcessRequestWrapper process request over, but response failed&quot;</span>, e);</div><div class="line"><span class="number">25</span>:                         LOG.error(request.toString());</div><div class="line"><span class="number">26</span>:                         LOG.error(response.toString());</div><div class="line"><span class="number">27</span>:                     }</div><div class="line"><span class="number">28</span>:                 }</div><div class="line"><span class="number">29</span>:             } <span class="keyword">catch</span> (RemotingCommandException e1) {</div><div class="line"><span class="number">30</span>:                 LOG.error(<span class="string">&quot;ExecuteRequestWhenWakeup run&quot;</span>, e1);</div><div class="line"><span class="number">31</span>:             }</div><div class="line"><span class="number">32</span>:         }</div><div class="line"><span class="number">33</span>:     };</div><div class="line"><span class="number">34</span>:     <span class="comment">// &#x63D0;&#x4EA4;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x5230;&#x7EBF;&#x7A0B;&#x6C60;</span></div><div class="line"><span class="number">35</span>:     <span class="keyword">this</span>.brokerController.getPullMessageExecutor().submit(<span class="keyword">new</span> RequestTask(run, channel, request));</div><div class="line"><span class="number">36</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x6267;&#x884C;&#x8BF7;&#x6C42;&#x5524;&#x9192;&#xFF0C;&#x5373;&#x518D;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3002;&#x8BE5;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x7EBF;&#x7A0B;&#x6C60;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x4E0D;&#x4F1A;&#x963B;&#x585E;&#x3002;</li>
<li>&#x7B2C; 7 &#x884C; &#xFF1A;&#x8C03;&#x7528;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;&#x672C;&#x6B21;&#x8C03;&#x7528;&#xFF0C;&#x8BBE;&#x7F6E;&#x5373;&#x4F7F;&#x8BF7;&#x6C42;&#x4E0D;&#x5230;&#x6D88;&#x606F;&#xFF0C;&#x4E5F;&#x4E0D;&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x8BBE;&#x7F6E;&#xFF0C;&#x8BF7;&#x6C42;&#x53EF;&#x80FD;&#x88AB;&#x65E0;&#x9650;&#x6302;&#x8D77;&#xFF0C;&#x88AB; <code>Broker</code> &#x65E0;&#x9650;&#x5FAA;&#x73AF;&#x3002;</li>
<li>&#x7B2C; 35 &#x884C; &#xFF1A;<strong>&#x63D0;&#x4EA4;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x5230;&#x7EBF;&#x7A0B;&#x6C60;</strong>&#x3002;</li>
</ul>
<h1 id="5&#x3001;Broker-&#x63D0;&#x4F9B;-&#x66F4;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;-&#x63A5;&#x53E3;"><a href="#5&#x3001;Broker-&#x63D0;&#x4F9B;-&#x66F4;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;-&#x63A5;&#x53E3;" class="headerlink" title="5&#x3001;Broker &#x63D0;&#x4F9B;[&#x66F4;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;]&#x63A5;&#x53E3;"></a>5&#x3001;Broker &#x63D0;&#x4F9B;[&#x66F4;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;]&#x63A5;&#x53E3;</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ <span class="built_in">pwd</span></div><div class="line">/Users/yunai/store/config</div><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ ls -ls</div><div class="line">total 40</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 consumerOffset.json.bak</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json</div><div class="line">8 -rw-r--r--  1 yunai  staff    21  4 28 16:58 delayOffset.json.bak</div><div class="line">8 -rw-r--r--  1 yunai  staff  1401  4 27 21:51 topics.json</div><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ cat consumerOffset.json</div><div class="line">{</div><div class="line">	<span class="string">&quot;offsetTable&quot;</span>:{</div><div class="line">		<span class="string">&quot;%RETRY%please_rename_unique_group_name_4@please_rename_unique_group_name_4&quot;</span>:{0:0</div><div class="line">		},</div><div class="line">		<span class="string">&quot;TopicRead3@please_rename_unique_group_name_4&quot;</span>:{1:5</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>
<ul class="ui list">
<li><code>consumerOffset.json</code> &#xFF1A;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x5B58;&#x50A8;&#x6587;&#x4EF6;&#x3002;</li>
<li><code>consumerOffset.json.bak</code> &#xFF1A;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x5B58;&#x50A8;&#x6587;&#x4EF6;&#x5907;&#x4EFD;&#x3002;</li>
<li>&#x6BCF;&#x6B21;&#x5199;&#x5165; <code>consumerOffset.json</code>&#xFF0C;&#x5C06;&#x539F;&#x5185;&#x5BB9;&#x5907;&#x4EFD;&#x5230; <code>consumerOffset.json.bak</code>&#x3002;&#x5B9E;&#x73B0;&#x89C1;&#xFF1A;<a href="mixallstring2file">MixAll#string2File(&#x2026;)</a>&#x3002;</li>
</ul>
<h2 id="BrokerController-initialize-&#x2026;"><a href="#BrokerController-initialize-&#x2026;" class="headerlink" title="BrokerController#initialize(&#x2026;)"></a>BrokerController#initialize(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>:<span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() {</div><div class="line"> <span class="number">2</span>:    <span class="meta">@Override</span></div><div class="line"> <span class="number">3</span>:    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">4</span>:        <span class="keyword">try</span> {</div><div class="line"> <span class="number">5</span>:            BrokerController.<span class="keyword">this</span>.consumerOffsetManager.persist();</div><div class="line"> <span class="number">6</span>:        } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"> <span class="number">7</span>:            log.error(<span class="string">&quot;schedule persist consumerOffset error.&quot;</span>, e);</div><div class="line"> <span class="number">8</span>:        }</div><div class="line"> <span class="number">9</span>:    }</div><div class="line"><span class="number">10</span>:}, <span class="number">1000</span> * <span class="number">10</span>, <span class="keyword">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x6BCF; 5s &#x6267;&#x884C;&#x4E00;&#x6B21;&#x6301;&#x4E45;&#x5316;&#x903B;&#x8F91;&#x3002;</li>
</ul>
<h2 id="ConfigManager"><a href="#ConfigManager" class="headerlink" title="ConfigManager"></a>ConfigManager</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigManager</span> </span>{</div><div class="line"> <span class="number">2</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger PLOG = LoggerFactory.getLogger(LoggerName.COMMON_LOGGER_NAME);</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>: <span class="comment">/**</span></div><div class="line"> 5:  * &#x7F16;&#x7801;&#x5185;&#x5BB9;</div><div class="line"> 6:  * <span class="doctag">@return</span> &#x7F16;&#x7801;&#x540E;&#x7684;&#x5185;&#x5BB9;</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">encode</span><span class="params">()</span></span>;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line">11:  * &#x52A0;&#x8F7D;&#x6587;&#x4EF6;</div><div class="line">12:  *</div><div class="line">13:  * <span class="doctag">@return</span> &#x52A0;&#x8F7D;&#x662F;&#x5426;&#x6210;&#x529F;</div><div class="line">14:  */</div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">16</span>:     String fileName = <span class="keyword">null</span>;</div><div class="line"><span class="number">17</span>:     <span class="keyword">try</span> {</div><div class="line"><span class="number">18</span>:         fileName = <span class="keyword">this</span>.configFilePath();</div><div class="line"><span class="number">19</span>:         String jsonString = MixAll.file2String(fileName);</div><div class="line"><span class="number">20</span>:         <span class="comment">// &#x5982;&#x679C;&#x5185;&#x5BB9;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x52A0;&#x8F7D;&#x5907;&#x4EFD;&#x6587;&#x4EF6;</span></div><div class="line"><span class="number">21</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == jsonString || jsonString.length() == <span class="number">0</span>) {</div><div class="line"><span class="number">22</span>:             <span class="keyword">return</span> <span class="keyword">this</span>.loadBak();</div><div class="line"><span class="number">23</span>:         } <span class="keyword">else</span> {</div><div class="line"><span class="number">24</span>:             <span class="keyword">this</span>.decode(jsonString);</div><div class="line"><span class="number">25</span>:             PLOG.info(<span class="string">&quot;load {} OK&quot;</span>, fileName);</div><div class="line"><span class="number">26</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">27</span>:         }</div><div class="line"><span class="number">28</span>:     } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">29</span>:         PLOG.error(<span class="string">&quot;load &quot;</span> + fileName + <span class="string">&quot; Failed, and try to load backup file&quot;</span>, e);</div><div class="line"><span class="number">30</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.loadBak();</div><div class="line"><span class="number">31</span>:     }</div><div class="line"><span class="number">32</span>: }</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>: <span class="comment">/**</span></div><div class="line">35:  * &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5730;&#x5740;</div><div class="line">36:  *</div><div class="line">37:  * <span class="doctag">@return</span> &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5730;&#x5740;</div><div class="line">38:  */</div><div class="line"><span class="number">39</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">configFilePath</span><span class="params">()</span></span>;</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>: <span class="comment">/**</span></div><div class="line">42:  * &#x52A0;&#x8F7D;&#x5907;&#x4EFD;&#x6587;&#x4EF6;</div><div class="line">43:  *</div><div class="line">44:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x6210;&#x529F;</div><div class="line">45:  */</div><div class="line"><span class="number">46</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">loadBak</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">47</span>:     String fileName = <span class="keyword">null</span>;</div><div class="line"><span class="number">48</span>:     <span class="keyword">try</span> {</div><div class="line"><span class="number">49</span>:         fileName = <span class="keyword">this</span>.configFilePath();</div><div class="line"><span class="number">50</span>:         String jsonString = MixAll.file2String(fileName + <span class="string">&quot;.bak&quot;</span>);</div><div class="line"><span class="number">51</span>:         <span class="keyword">if</span> (jsonString != <span class="keyword">null</span> &amp;&amp; jsonString.length() &gt; <span class="number">0</span>) {</div><div class="line"><span class="number">52</span>:             <span class="keyword">this</span>.decode(jsonString);</div><div class="line"><span class="number">53</span>:             PLOG.info(<span class="string">&quot;load &quot;</span> + fileName + <span class="string">&quot; OK&quot;</span>);</div><div class="line"><span class="number">54</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">55</span>:         }</div><div class="line"><span class="number">56</span>:     } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">57</span>:         PLOG.error(<span class="string">&quot;load &quot;</span> + fileName + <span class="string">&quot; Failed&quot;</span>, e);</div><div class="line"><span class="number">58</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">59</span>:     }</div><div class="line"><span class="number">60</span>: </div><div class="line"><span class="number">61</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">62</span>: }</div><div class="line"><span class="number">63</span>: </div><div class="line"><span class="number">64</span>: <span class="comment">/**</span></div><div class="line">65:  * &#x89E3;&#x7801;&#x5185;&#x5BB9;</div><div class="line">66:  *</div><div class="line">67:  * <span class="doctag">@param</span> jsonString &#x5185;&#x5BB9;</div><div class="line">68:  */</div><div class="line"><span class="number">69</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(<span class="keyword">final</span> String jsonString)</span></span>;</div><div class="line"><span class="number">70</span>: </div><div class="line"><span class="number">71</span>: <span class="comment">/**</span></div><div class="line">72:  * &#x6301;&#x4E45;&#x5316;</div><div class="line">73:  */</div><div class="line"><span class="number">74</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">persist</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">75</span>:     String jsonString = <span class="keyword">this</span>.encode(<span class="keyword">true</span>);</div><div class="line"><span class="number">76</span>:     <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) {</div><div class="line"><span class="number">77</span>:         String fileName = <span class="keyword">this</span>.configFilePath();</div><div class="line"><span class="number">78</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">79</span>:             MixAll.string2File(jsonString, fileName);</div><div class="line"><span class="number">80</span>:         } <span class="keyword">catch</span> (IOException e) {</div><div class="line"><span class="number">81</span>:             PLOG.error(<span class="string">&quot;persist file Exception, &quot;</span> + fileName, e);</div><div class="line"><span class="number">82</span>:         }</div><div class="line"><span class="number">83</span>:     }</div><div class="line"><span class="number">84</span>: }</div><div class="line"><span class="number">85</span>: </div><div class="line"><span class="number">86</span>: <span class="comment">/**</span></div><div class="line">87:  * &#x7F16;&#x7801;&#x5B58;&#x50A8;&#x5185;&#x5BB9;</div><div class="line">88:  *</div><div class="line">89:  * <span class="doctag">@param</span> prettyFormat &#x662F;&#x5426;&#x683C;&#x5F0F;&#x5316;</div><div class="line">90:  * <span class="doctag">@return</span> &#x5185;&#x5BB9;</div><div class="line">91:  */</div><div class="line"><span class="number">92</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">encode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> prettyFormat)</span></span>;</div><div class="line"><span class="number">93</span>: }</div></pre></td></tr></table></figure>
<h3 id="MixAll-string2File-&#x2026;"><a href="#MixAll-string2File-&#x2026;" class="headerlink" title="MixAll#string2File(&#x2026;)"></a>MixAll#string2File(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * &#x5C06;&#x5185;&#x5BB9;&#x5199;&#x5230;&#x6587;&#x4EF6;</div><div class="line"> 3:  * &#x5B89;&#x5168;&#x5199;</div><div class="line"> 4:  * 1. &#x5199;&#x5230;.tmp&#x6587;&#x4EF6;</div><div class="line"> 5:  * 2. &#x5907;&#x4EFD;&#x51C6;&#x5907;&#x5199;&#x5165;&#x6587;&#x4EF6;&#x5230;.bak&#x6587;&#x4EF6;</div><div class="line"> 6:  * 3. &#x5220;&#x9664;&#x539F;&#x6587;&#x4EF6;&#xFF0C;&#x5C06;.tmp&#x4FEE;&#x6539;&#x6210;&#x6587;&#x4EF6;</div><div class="line"> 7:  *</div><div class="line"> 8:  * <span class="doctag">@param</span> str &#x5185;&#x5BB9;</div><div class="line"> 9:  * <span class="doctag">@param</span> fileName &#x6587;&#x4EF6;&#x540D;</div><div class="line">10:  * <span class="doctag">@throws</span> IOException &#x5F53;IO&#x53D1;&#x751F;&#x5F02;&#x5E38;&#x65F6;</div><div class="line">11:  */</div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">string2File</span><span class="params">(<span class="keyword">final</span> String str, <span class="keyword">final</span> String fileName)</span> <span class="keyword">throws</span> IOException </span>{</div><div class="line"><span class="number">13</span>:     <span class="comment">// &#x5199;&#x5230; tmp&#x6587;&#x4EF6;</span></div><div class="line"><span class="number">14</span>:     String tmpFile = fileName + <span class="string">&quot;.tmp&quot;</span>;</div><div class="line"><span class="number">15</span>:     string2FileNotSafe(str, tmpFile);</div><div class="line"><span class="number">16</span>:     <span class="comment">//</span></div><div class="line"><span class="number">17</span>:     String bakFile = fileName + <span class="string">&quot;.bak&quot;</span>;</div><div class="line"><span class="number">18</span>:     String prevContent = file2String(fileName);</div><div class="line"><span class="number">19</span>:     <span class="keyword">if</span> (prevContent != <span class="keyword">null</span>) {</div><div class="line"><span class="number">20</span>:         string2FileNotSafe(prevContent, bakFile);</div><div class="line"><span class="number">21</span>:     }</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>:     File file = <span class="keyword">new</span> File(fileName);</div><div class="line"><span class="number">24</span>:     file.delete();</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     file = <span class="keyword">new</span> File(tmpFile);</div><div class="line"><span class="number">27</span>:     file.renameTo(<span class="keyword">new</span> File(fileName));</div><div class="line"><span class="number">28</span>: }</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">/**</span></div><div class="line">31:  * &#x5C06;&#x5185;&#x5BB9;&#x5199;&#x5230;&#x6587;&#x4EF6;</div><div class="line">32:  * &#x975E;&#x5B89;&#x5168;&#x5199;</div><div class="line">33:  *</div><div class="line">34:  * <span class="doctag">@param</span> str &#x5185;&#x5BB9;</div><div class="line">35:  * <span class="doctag">@param</span> fileName &#x6587;&#x4EF6;&#x5185;&#x5BB9;</div><div class="line">36:  * <span class="doctag">@throws</span> IOException &#x5F53;IO&#x53D1;&#x751F;&#x5F02;&#x5E38;&#x65F6;</div><div class="line">37:  */</div><div class="line"><span class="number">38</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">string2FileNotSafe</span><span class="params">(<span class="keyword">final</span> String str, <span class="keyword">final</span> String fileName)</span> <span class="keyword">throws</span> IOException </span>{</div><div class="line"><span class="number">39</span>:     File file = <span class="keyword">new</span> File(fileName);</div><div class="line"><span class="number">40</span>:     <span class="comment">// &#x521B;&#x5EFA;&#x4E0A;&#x7EA7;&#x76EE;&#x5F55;</span></div><div class="line"><span class="number">41</span>:     File fileParent = file.getParentFile();</div><div class="line"><span class="number">42</span>:     <span class="keyword">if</span> (fileParent != <span class="keyword">null</span>) {</div><div class="line"><span class="number">43</span>:         fileParent.mkdirs();</div><div class="line"><span class="number">44</span>:     }</div><div class="line"><span class="number">45</span>:     <span class="comment">// &#x5199;&#x5185;&#x5BB9;</span></div><div class="line"><span class="number">46</span>:     FileWriter fileWriter = <span class="keyword">null</span>;</div><div class="line"><span class="number">47</span>:     <span class="keyword">try</span> {</div><div class="line"><span class="number">48</span>:         fileWriter = <span class="keyword">new</span> FileWriter(file);</div><div class="line"><span class="number">49</span>:         fileWriter.write(str);</div><div class="line"><span class="number">50</span>:     } <span class="keyword">catch</span> (IOException e) {</div><div class="line"><span class="number">51</span>:         <span class="keyword">throw</span> e;</div><div class="line"><span class="number">52</span>:     } <span class="keyword">finally</span> {</div><div class="line"><span class="number">53</span>:         <span class="keyword">if</span> (fileWriter != <span class="keyword">null</span>) {</div><div class="line"><span class="number">54</span>:             fileWriter.close();</div><div class="line"><span class="number">55</span>:         }</div><div class="line"><span class="number">56</span>:     }</div><div class="line"><span class="number">57</span>: }</div></pre></td></tr></table></figure>
<h2 id="ConsumerOffsetManager"><a href="#ConsumerOffsetManager" class="headerlink" title="ConsumerOffsetManager"></a>ConsumerOffsetManager</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerOffsetManager</span> <span class="keyword">extends</span> <span class="title">ConfigManager</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(LoggerName.BROKER_LOGGER_NAME);</div><div class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_GROUP_SEPARATOR = <span class="string">&quot;@&quot;</span>;</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="comment">/**</span></div><div class="line"> 6:      * &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x96C6;&#x5408;</div><div class="line"> 7:      */</div><div class="line"> <span class="number">8</span>:     <span class="keyword">private</span> ConcurrentHashMap&lt;String<span class="comment">/* topic@group */</span>, ConcurrentHashMap&lt;Integer, Long&gt;&gt; offsetTable = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">512</span>);</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">transient</span> BrokerController brokerController;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ConsumerOffsetManager</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">13</span>:     }</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ConsumerOffsetManager</span><span class="params">(BrokerController brokerController)</span> </span>{</div><div class="line"><span class="number">16</span>:         <span class="keyword">this</span>.brokerController = brokerController;</div><div class="line"><span class="number">17</span>:     }</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">/**</span></div><div class="line">20:      * &#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</div><div class="line">21:      *</div><div class="line">22:      * <span class="doctag">@param</span> clientHost &#x63D0;&#x4EA4;client&#x5730;&#x5740;</div><div class="line">23:      * <span class="doctag">@param</span> group &#x6D88;&#x8D39;&#x5206;&#x7EC4;</div><div class="line">24:      * <span class="doctag">@param</span> topic &#x4E3B;&#x9898;</div><div class="line">25:      * <span class="doctag">@param</span> queueId &#x961F;&#x5217;&#x7F16;&#x53F7;</div><div class="line">26:      * <span class="doctag">@param</span> offset &#x8FDB;&#x5EA6;&#xFF08;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#xFF09;</div><div class="line">27:      */</div><div class="line"><span class="number">28</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commitOffset</span><span class="params">(<span class="keyword">final</span> String clientHost, <span class="keyword">final</span> String group, <span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> offset)</span> </span>{</div><div class="line"><span class="number">29</span>:         <span class="comment">// topic@group</span></div><div class="line"><span class="number">30</span>:         String key = topic + TOPIC_GROUP_SEPARATOR + group;</div><div class="line"><span class="number">31</span>:         <span class="keyword">this</span>.commitOffset(clientHost, key, queueId, offset);</div><div class="line"><span class="number">32</span>:     }</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">/**</span></div><div class="line">35:      * &#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</div><div class="line">36:      *</div><div class="line">37:      * <span class="doctag">@param</span> clientHost &#x63D0;&#x4EA4;client&#x5730;&#x5740;</div><div class="line">38:      * <span class="doctag">@param</span> key &#x4E3B;&#x9898;@&#x6D88;&#x8D39;&#x5206;&#x7EC4;</div><div class="line">39:      * <span class="doctag">@param</span> queueId &#x961F;&#x5217;&#x7F16;&#x53F7;</div><div class="line">40:      * <span class="doctag">@param</span> offset &#x8FDB;&#x5EA6;&#xFF08;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#xFF09;</div><div class="line">41:      */</div><div class="line"><span class="number">42</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitOffset</span><span class="params">(<span class="keyword">final</span> String clientHost, <span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> <span class="keyword">long</span> offset)</span> </span>{</div><div class="line"><span class="number">43</span>:         ConcurrentHashMap&lt;Integer, Long&gt; map = <span class="keyword">this</span>.offsetTable.get(key);</div><div class="line"><span class="number">44</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == map) {</div><div class="line"><span class="number">45</span>:             map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">32</span>);</div><div class="line"><span class="number">46</span>:             map.put(queueId, offset);</div><div class="line"><span class="number">47</span>:             <span class="keyword">this</span>.offsetTable.put(key, map);</div><div class="line"><span class="number">48</span>:         } <span class="keyword">else</span> {</div><div class="line"><span class="number">49</span>:             Long storeOffset = map.put(queueId, offset);</div><div class="line"><span class="number">50</span>:             <span class="keyword">if</span> (storeOffset != <span class="keyword">null</span> &amp;&amp; offset &lt; storeOffset) {</div><div class="line"><span class="number">51</span>:                 log.warn(<span class="string">&quot;[NOTIFYME]update consumer offset less than store. clientHost={}, key={}, queueId={}, requestOffset={}, storeOffset={}&quot;</span>, clientHost, key, queueId, offset, storeOffset);</div><div class="line"><span class="number">52</span>:             }</div><div class="line"><span class="number">53</span>:         }</div><div class="line"><span class="number">54</span>:     }</div><div class="line"><span class="number">55</span>: </div><div class="line"><span class="number">56</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">57</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.encode(<span class="keyword">false</span>);</div><div class="line"><span class="number">58</span>:     }</div><div class="line"><span class="number">59</span>: </div><div class="line"><span class="number">60</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">61</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">configFilePath</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">62</span>:         <span class="keyword">return</span> BrokerPathConfigHelper.getConsumerOffsetPath(<span class="keyword">this</span>.brokerController.getMessageStoreConfig().getStorePathRootDir());</div><div class="line"><span class="number">63</span>:     }</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:     <span class="comment">/**</span></div><div class="line">66:      * &#x89E3;&#x7801;&#x5185;&#x5BB9;</div><div class="line">67:      * &#x683C;&#x5F0F;:JSON</div><div class="line">68:      *</div><div class="line">69:      * <span class="doctag">@param</span> jsonString &#x5185;&#x5BB9;</div><div class="line">70:      */</div><div class="line"><span class="number">71</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">72</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(String jsonString)</span> </span>{</div><div class="line"><span class="number">73</span>:         <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) {</div><div class="line"><span class="number">74</span>:             ConsumerOffsetManager obj = RemotingSerializable.fromJson(jsonString, ConsumerOffsetManager.class);</div><div class="line"><span class="number">75</span>:             <span class="keyword">if</span> (obj != <span class="keyword">null</span>) {</div><div class="line"><span class="number">76</span>:                 <span class="keyword">this</span>.offsetTable = obj.offsetTable;</div><div class="line"><span class="number">77</span>:             }</div><div class="line"><span class="number">78</span>:         }</div><div class="line"><span class="number">79</span>:     }</div><div class="line"><span class="number">80</span>: </div><div class="line"><span class="number">81</span>:     <span class="comment">/**</span></div><div class="line">82:      * &#x7F16;&#x7801;&#x5185;&#x5BB9;</div><div class="line">83:      * &#x683C;&#x5F0F;&#x4E3A;JSON</div><div class="line">84:      *</div><div class="line">85:      * <span class="doctag">@param</span> prettyFormat &#x662F;&#x5426;&#x683C;&#x5F0F;&#x5316;</div><div class="line">86:      * <span class="doctag">@return</span> &#x7F16;&#x7801;&#x540E;&#x7684;&#x5185;&#x5BB9;</div><div class="line">87:      */</div><div class="line"><span class="number">88</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> prettyFormat)</span> </span>{</div><div class="line"><span class="number">89</span>:         <span class="keyword">return</span> RemotingSerializable.toJson(<span class="keyword">this</span>, prettyFormat);</div><div class="line"><span class="number">90</span>:     }</div><div class="line"><span class="number">91</span>: </div><div class="line"><span class="number">92</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x7BA1;&#x7406;&#x5668;&#x3002;</li>
</ul>
<h1 id="6&#x3001;Broker-&#x63D0;&#x4F9B;-&#x53D1;&#x56DE;&#x6D88;&#x606F;-&#x63A5;&#x53E3;"><a href="#6&#x3001;Broker-&#x63D0;&#x4F9B;-&#x53D1;&#x56DE;&#x6D88;&#x606F;-&#x63A5;&#x53E3;" class="headerlink" title="6&#x3001;Broker &#x63D0;&#x4F9B;[&#x53D1;&#x56DE;&#x6D88;&#x606F;]&#x63A5;&#x53E3;"></a>6&#x3001;Broker &#x63D0;&#x4F9B;[&#x53D1;&#x56DE;&#x6D88;&#x606F;]&#x63A5;&#x53E3;</h1><p>&#x5927;&#x90E8;&#x5206;&#x903B;&#x8F91;&#x548C; <a href="http://www.yunai.me/RocketMQ/message-send-and-receive/#3&#x3001;Broker-&#x63A5;&#x6536;&#x6D88;&#x606F;"><code>Broker</code> &#x63D0;&#x4F9B;[&#x63A5;&#x6536;&#x6D88;&#x606F;]&#x63A5;&#x53E3;</a> &#x7C7B;&#x4F3C;&#xFF0C;&#x53EF;&#x4EE5;&#x5148;&#x770B;&#x4E0B;&#x76F8;&#x5173;&#x5185;&#x5BB9;&#x3002;</p>
<h2 id="SendMessageProcessor-consumerSendMsgBack-&#x2026;"><a href="#SendMessageProcessor-consumerSendMsgBack-&#x2026;" class="headerlink" title="SendMessageProcessor#consumerSendMsgBack(&#x2026;)"></a>SendMessageProcessor#consumerSendMsgBack(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> RemotingCommand <span class="title">consumerSendMsgBack</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> RemotingCommand request)</span></span></div><div class="line">  2:     <span class="keyword">throws</span> RemotingCommandException {</div><div class="line">  <span class="number">3</span>: </div><div class="line">  <span class="number">4</span>:     <span class="comment">// &#x521D;&#x59CB;&#x5316;&#x54CD;&#x5E94;</span></div><div class="line">  <span class="number">5</span>:     <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(<span class="keyword">null</span>);</div><div class="line">  <span class="number">6</span>:     <span class="keyword">final</span> ConsumerSendMsgBackRequestHeader requestHeader =</div><div class="line">  <span class="number">7</span>:         (ConsumerSendMsgBackRequestHeader) request.decodeCommandCustomHeader(ConsumerSendMsgBackRequestHeader.class);</div><div class="line">  <span class="number">8</span>: </div><div class="line">  <span class="number">9</span>:     <span class="comment">// hook&#xFF08;&#x72EC;&#x6709;&#xFF09;</span></div><div class="line"> <span class="number">10</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.hasConsumeMessageHook() &amp;&amp; !UtilAll.isBlank(requestHeader.getOriginMsgId())) {</div><div class="line"> <span class="number">11</span>: </div><div class="line"> <span class="number">12</span>:         ConsumeMessageContext context = <span class="keyword">new</span> ConsumeMessageContext();</div><div class="line"> <span class="number">13</span>:         context.setConsumerGroup(requestHeader.getGroup());</div><div class="line"> <span class="number">14</span>:         context.setTopic(requestHeader.getOriginTopic());</div><div class="line"> <span class="number">15</span>:         context.setCommercialRcvStats(BrokerStatsManager.StatsType.SEND_BACK);</div><div class="line"> <span class="number">16</span>:         context.setCommercialRcvTimes(<span class="number">1</span>);</div><div class="line"> <span class="number">17</span>:         context.setCommercialOwner(request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER));</div><div class="line"> <span class="number">18</span>: </div><div class="line"> <span class="number">19</span>:         <span class="keyword">this</span>.executeConsumeMessageHookAfter(context);</div><div class="line"> <span class="number">20</span>:     }</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="comment">// &#x5224;&#x65AD;&#x6D88;&#x8D39;&#x5206;&#x7EC4;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF08;&#x72EC;&#x6709;&#xFF09;</span></div><div class="line"> <span class="number">23</span>:     SubscriptionGroupConfig subscriptionGroupConfig =</div><div class="line"> <span class="number">24</span>:         <span class="keyword">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(requestHeader.getGroup());</div><div class="line"> <span class="number">25</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionGroupConfig) {</div><div class="line"> <span class="number">26</span>:         response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class="line"> <span class="number">27</span>:         response.setRemark(<span class="string">&quot;subscription group not exist, &quot;</span> + requestHeader.getGroup() + <span class="string">&quot; &quot;</span></div><div class="line"> <span class="number">28</span>:             + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));</div><div class="line"> <span class="number">29</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">30</span>:     }</div><div class="line"> <span class="number">31</span>: </div><div class="line"> <span class="number">32</span>:     <span class="comment">// &#x68C0;&#x67E5; broker &#x662F;&#x5426;&#x6709;&#x5199;&#x5165;&#x6743;&#x9650;</span></div><div class="line"> <span class="number">33</span>:     <span class="keyword">if</span> (!PermName.isWriteable(<span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerPermission())) {</div><div class="line"> <span class="number">34</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">35</span>:         response.setRemark(<span class="string">&quot;the broker[&quot;</span> + <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerIP1() + <span class="string">&quot;] sending message is forbidden&quot;</span>);</div><div class="line"> <span class="number">36</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">37</span>:     }</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="comment">// &#x68C0;&#x67E5; &#x91CD;&#x8BD5;&#x961F;&#x5217;&#x6570; &#x662F;&#x5426;&#x5927;&#x4E8E;0&#xFF08;&#x72EC;&#x6709;&#xFF09;</span></div><div class="line"> <span class="number">40</span>:     <span class="keyword">if</span> (subscriptionGroupConfig.getRetryQueueNums() &lt;= <span class="number">0</span>) {</div><div class="line"> <span class="number">41</span>:         response.setCode(ResponseCode.SUCCESS);</div><div class="line"> <span class="number">42</span>:         response.setRemark(<span class="keyword">null</span>);</div><div class="line"> <span class="number">43</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">44</span>:     }</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:     <span class="comment">// &#x8BA1;&#x7B97;retry Topic</span></div><div class="line"> <span class="number">47</span>:     String newTopic = MixAll.getRetryTopic(requestHeader.getGroup());</div><div class="line"> <span class="number">48</span>: </div><div class="line"> <span class="number">49</span>:     <span class="comment">// &#x8BA1;&#x7B97;&#x961F;&#x5217;&#x7F16;&#x53F7;&#xFF08;&#x72EC;&#x6709;&#xFF09;</span></div><div class="line"> <span class="number">50</span>:     <span class="keyword">int</span> queueIdInt = Math.abs(<span class="keyword">this</span>.random.nextInt() % <span class="number">99999999</span>) % subscriptionGroupConfig.getRetryQueueNums();</div><div class="line"> <span class="number">51</span>: </div><div class="line"> <span class="number">52</span>:     <span class="comment">// &#x8BA1;&#x7B97;sysFlag&#xFF08;&#x72EC;&#x6709;&#xFF09;</span></div><div class="line"> <span class="number">53</span>:     <span class="keyword">int</span> topicSysFlag = <span class="number">0</span>;</div><div class="line"> <span class="number">54</span>:     <span class="keyword">if</span> (requestHeader.isUnitMode()) {</div><div class="line"> <span class="number">55</span>:         topicSysFlag = TopicSysFlag.buildSysFlag(<span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line"> <span class="number">56</span>:     }</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:     <span class="comment">// &#x83B7;&#x53D6;topicConfig&#x3002;&#x5982;&#x679C;&#x83B7;&#x53D6;&#x4E0D;&#x5230;&#xFF0C;&#x5219;&#x8FDB;&#x884C;&#x521B;&#x5EFA;</span></div><div class="line"> <span class="number">59</span>:     TopicConfig topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(<span class="comment">//</span></div><div class="line"> <span class="number">60</span>:         newTopic, <span class="comment">//</span></div><div class="line"> <span class="number">61</span>:         subscriptionGroupConfig.getRetryQueueNums(), <span class="comment">//</span></div><div class="line"> <span class="number">62</span>:         PermName.PERM_WRITE | PermName.PERM_READ, topicSysFlag);</div><div class="line"> <span class="number">63</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) { <span class="comment">// &#x6CA1;&#x6709;&#x914D;&#x7F6E;</span></div><div class="line"> <span class="number">64</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">65</span>:         response.setRemark(<span class="string">&quot;topic[&quot;</span> + newTopic + <span class="string">&quot;] not exist&quot;</span>);</div><div class="line"> <span class="number">66</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">67</span>:     }</div><div class="line"> <span class="number">68</span>:     <span class="keyword">if</span> (!PermName.isWriteable(topicConfig.getPerm())) { <span class="comment">// &#x4E0D;&#x5141;&#x8BB8;&#x5199;&#x5165;</span></div><div class="line"> <span class="number">69</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">70</span>:         response.setRemark(String.format(<span class="string">&quot;the topic[%s] sending message is forbidden&quot;</span>, newTopic));</div><div class="line"> <span class="number">71</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">72</span>:     }</div><div class="line"> <span class="number">73</span>: </div><div class="line"> <span class="number">74</span>:     <span class="comment">// &#x67E5;&#x8BE2;&#x6D88;&#x606F;&#x3002;&#x82E5;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x8FD4;&#x56DE;&#x5F02;&#x5E38;&#x9519;&#x8BEF;&#x3002;&#xFF08;&#x72EC;&#x6709;&#xFF09;</span></div><div class="line"> <span class="number">75</span>:     MessageExt msgExt = <span class="keyword">this</span>.brokerController.getMessageStore().lookMessageByOffset(requestHeader.getOffset());</div><div class="line"> <span class="number">76</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == msgExt) {</div><div class="line"> <span class="number">77</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">78</span>:         response.setRemark(<span class="string">&quot;look message by offset failed, &quot;</span> + requestHeader.getOffset());</div><div class="line"> <span class="number">79</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">80</span>:     }</div><div class="line"> <span class="number">81</span>: </div><div class="line"> <span class="number">82</span>:     <span class="comment">// &#x8BBE;&#x7F6E;retryTopic&#x5230;&#x62D3;&#x5C55;&#x5C5E;&#x6027;&#xFF08;&#x72EC;&#x6709;&#xFF09;</span></div><div class="line"> <span class="number">83</span>:     <span class="keyword">final</span> String retryTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</div><div class="line"> <span class="number">84</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == retryTopic) {</div><div class="line"> <span class="number">85</span>:         MessageAccessor.putProperty(msgExt, MessageConst.PROPERTY_RETRY_TOPIC, msgExt.getTopic());</div><div class="line"> <span class="number">86</span>:     }</div><div class="line"> <span class="number">87</span>: </div><div class="line"> <span class="number">88</span>:     <span class="comment">// &#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x4E0D;&#x7B49;&#x5F85;&#x5B58;&#x50A8;&#x5B8C;&#x6210;&#xFF08;&#x72EC;&#x6709;&#xFF09; TODO &#x7591;&#x95EE;&#xFF1A;&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x6210;&#x4E0D;&#x7B49;&#x5F85;&#x5B58;&#x50A8;&#xFF0C;broker&#x8BBE;&#x7F6E;&#x6210;&#x540C;&#x6B65;&#x843D;&#x76D8;&#xFF0C;&#x5C82;&#x4E0D;&#x662F;&#x4E0D;&#x80FD;&#x6279;&#x91CF;&#x63D0;&#x4EA4;&#x4E86;&#xFF1F;</span></div><div class="line"> <span class="number">89</span>:     msgExt.setWaitStoreMsgOK(<span class="keyword">false</span>);</div><div class="line"> <span class="number">90</span>: </div><div class="line"> <span class="number">91</span>:     <span class="comment">// &#x5904;&#x7406; delayLevel&#xFF08;&#x72EC;&#x6709;&#xFF09;&#x3002;</span></div><div class="line"> <span class="number">92</span>:     <span class="keyword">int</span> delayLevel = requestHeader.getDelayLevel();</div><div class="line"> <span class="number">93</span>:     <span class="keyword">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class="line"> <span class="number">94</span>:     <span class="keyword">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) {</div><div class="line"> <span class="number">95</span>:         maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class="line"> <span class="number">96</span>:     }</div><div class="line"> <span class="number">97</span>:     <span class="keyword">if</span> (msgExt.getReconsumeTimes() &gt;= maxReconsumeTimes<span class="comment">//</span></div><div class="line"> <span class="number">98</span>:         || delayLevel &lt; <span class="number">0</span>) { <span class="comment">// &#x5982;&#x679C;&#x8D85;&#x8FC7;&#x6700;&#x5927;&#x6D88;&#x8D39;&#x6B21;&#x6570;&#xFF0C;&#x5219;topic&#x4FEE;&#x6539;&#x6210;&quot;%DLQ%&quot; + &#x5206;&#x7EC4;&#x540D;&#xFF0C;&#x5373;&#x52A0;&#x5165; &#x6B7B;&#x4FE1;&#x961F;&#x5217;(Dead Letter Queue)</span></div><div class="line"> <span class="number">99</span>:         newTopic = MixAll.getDLQTopic(requestHeader.getGroup());</div><div class="line"><span class="number">100</span>:         queueIdInt = Math.abs(<span class="keyword">this</span>.random.nextInt() % <span class="number">99999999</span>) % DLQ_NUMS_PER_GROUP;</div><div class="line"><span class="number">101</span>: </div><div class="line"><span class="number">102</span>:         topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, <span class="comment">//</span></div><div class="line"><span class="number">103</span>:             DLQ_NUMS_PER_GROUP, <span class="comment">//</span></div><div class="line"><span class="number">104</span>:             PermName.PERM_WRITE, <span class="number">0</span></div><div class="line"><span class="number">105</span>:         );</div><div class="line"><span class="number">106</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) {</div><div class="line"><span class="number">107</span>:             response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">108</span>:             response.setRemark(<span class="string">&quot;topic[&quot;</span> + newTopic + <span class="string">&quot;] not exist&quot;</span>);</div><div class="line"><span class="number">109</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">110</span>:         }</div><div class="line"><span class="number">111</span>:     } <span class="keyword">else</span> {</div><div class="line"><span class="number">112</span>:         <span class="keyword">if</span> (<span class="number">0</span> == delayLevel) {</div><div class="line"><span class="number">113</span>:             delayLevel = <span class="number">3</span> + msgExt.getReconsumeTimes();</div><div class="line"><span class="number">114</span>:         }</div><div class="line"><span class="number">115</span>:         msgExt.setDelayTimeLevel(delayLevel);</div><div class="line"><span class="number">116</span>:     }</div><div class="line"><span class="number">117</span>: </div><div class="line"><span class="number">118</span>:     <span class="comment">// &#x521B;&#x5EFA;MessageExtBrokerInner</span></div><div class="line"><span class="number">119</span>:     MessageExtBrokerInner msgInner = <span class="keyword">new</span> MessageExtBrokerInner();</div><div class="line"><span class="number">120</span>:     msgInner.setTopic(newTopic);</div><div class="line"><span class="number">121</span>:     msgInner.setBody(msgExt.getBody());</div><div class="line"><span class="number">122</span>:     msgInner.setFlag(msgExt.getFlag());</div><div class="line"><span class="number">123</span>:     MessageAccessor.setProperties(msgInner, msgExt.getProperties());</div><div class="line"><span class="number">124</span>:     msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgExt.getProperties()));</div><div class="line"><span class="number">125</span>:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(<span class="keyword">null</span>, msgExt.getTags()));</div><div class="line"><span class="number">126</span>:     msgInner.setQueueId(queueIdInt);</div><div class="line"><span class="number">127</span>:     msgInner.setSysFlag(msgExt.getSysFlag());</div><div class="line"><span class="number">128</span>:     msgInner.setBornTimestamp(msgExt.getBornTimestamp());</div><div class="line"><span class="number">129</span>:     msgInner.setBornHost(msgExt.getBornHost());</div><div class="line"><span class="number">130</span>:     msgInner.setStoreHost(<span class="keyword">this</span>.getStoreHost());</div><div class="line"><span class="number">131</span>:     msgInner.setReconsumeTimes(msgExt.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">132</span>: </div><div class="line"><span class="number">133</span>:     <span class="comment">// &#x8BBE;&#x7F6E;&#x539F;&#x59CB;&#x6D88;&#x606F;&#x7F16;&#x53F7;&#x5230;&#x62D3;&#x5C55;&#x5B57;&#x6BB5;&#xFF08;&#x72EC;&#x6709;&#xFF09;</span></div><div class="line"><span class="number">134</span>:     String originMsgId = MessageAccessor.getOriginMessageId(msgExt);</div><div class="line"><span class="number">135</span>:     MessageAccessor.setOriginMessageId(msgInner, UtilAll.isBlank(originMsgId) ? msgExt.getMsgId() : originMsgId);</div><div class="line"><span class="number">136</span>: </div><div class="line"><span class="number">137</span>:     <span class="comment">// &#x6DFB;&#x52A0;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">138</span>:     PutMessageResult putMessageResult = <span class="keyword">this</span>.brokerController.getMessageStore().putMessage(msgInner);</div><div class="line"><span class="number">139</span>:     <span class="keyword">if</span> (putMessageResult != <span class="keyword">null</span>) {</div><div class="line"><span class="number">140</span>:         <span class="keyword">switch</span> (putMessageResult.getPutMessageStatus()) {</div><div class="line"><span class="number">141</span>:             <span class="keyword">case</span> PUT_OK:</div><div class="line"><span class="number">142</span>:                 String backTopic = msgExt.getTopic();</div><div class="line"><span class="number">143</span>:                 String correctTopic = msgExt.getProperty(MessageConst.PROPERTY_RETRY_TOPIC);</div><div class="line"><span class="number">144</span>:                 <span class="keyword">if</span> (correctTopic != <span class="keyword">null</span>) {</div><div class="line"><span class="number">145</span>:                     backTopic = correctTopic;</div><div class="line"><span class="number">146</span>:                 }</div><div class="line"><span class="number">147</span>: </div><div class="line"><span class="number">148</span>:                 <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incSendBackNums(requestHeader.getGroup(), backTopic);</div><div class="line"><span class="number">149</span>: </div><div class="line"><span class="number">150</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class="line"><span class="number">151</span>:                 response.setRemark(<span class="keyword">null</span>);</div><div class="line"><span class="number">152</span>: </div><div class="line"><span class="number">153</span>:                 <span class="keyword">return</span> response;</div><div class="line"><span class="number">154</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">155</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">156</span>:         }</div><div class="line"><span class="number">157</span>: </div><div class="line"><span class="number">158</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">159</span>:         response.setRemark(putMessageResult.getPutMessageStatus().name());</div><div class="line"><span class="number">160</span>:         <span class="keyword">return</span> response;</div><div class="line"><span class="number">161</span>:     }</div><div class="line"><span class="number">162</span>: </div><div class="line"><span class="number">163</span>:     response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">164</span>:     response.setRemark(<span class="string">&quot;putMessageResult is null&quot;</span>);</div><div class="line"><span class="number">165</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">166</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x5F53; <code>Consumer</code> &#x6D88;&#x8D39;&#x67D0;&#x6761;&#x6D88;&#x606F;&#x5931;&#x8D25;&#x65F6;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;&#x8BE5;&#x63A5;&#x53E3;&#x53D1;&#x56DE;&#x6D88;&#x606F;&#x3002;<code>Broker</code> &#x4F1A;&#x5B58;&#x50A8;&#x53D1;&#x56DE;&#x7684;&#x6D88;&#x606F;&#x3002;&#x8FD9;&#x6837;&#xFF0C;&#x4E0B;&#x6B21; <code>Consumer</code> &#x62C9;&#x53D6;&#x8BE5;&#x6D88;&#x606F;&#xFF0C;&#x80FD;&#x591F;&#x4ECE; <code>CommitLog</code> &#x548C; <code>ConsumeQueue</code> &#x987A;&#x5E8F;&#x8BFB;&#x53D6;&#x3002;</li>
<li>[x] &#x56E0;&#x4E3A;&#x5927;&#x591A;&#x6570;&#x903B;&#x8F91;&#x548C; <strong><code>Broker</code> &#x63A5;&#x6536;&#x666E;&#x901A;&#x6D88;&#x606F;</strong> &#x5F88;&#x76F8;&#x4F3C;&#xFF0C;&#x65F6;&#x5019; <code>TODO</code> &#x6807;&#x8BB0;&#x6210;&#x72EC;&#x6709;&#x7684;&#x903B;&#x8F91;&#x3002;</li>
<li>&#x7B2C; 4 &#x81F3; 7 &#x884C; &#xFF1A;&#x521D;&#x59CB;&#x5316;&#x54CD;&#x5E94;&#x3002;</li>
<li>[x] &#x7B2C; 9 &#x81F3; 20 &#x884C; &#xFF1A;Hook&#x903B;&#x8F91;&#x3002;</li>
<li>[x] &#x7B2C;22 &#x81F3; 30 &#x884C; &#xFF1A;&#x5224;&#x65AD;&#x6D88;&#x8D39;&#x5206;&#x7EC4;&#x662F;&#x5426;&#x5B58;&#x5728;&#x3002;</li>
<li>&#x7B2C; 32 &#x81F3; 37 &#x884C; &#xFF1A;&#x68C0;&#x67E5; <code>Broker</code> &#x662F;&#x5426;&#x6709;&#x5199;&#x5165;&#x6743;&#x9650;&#x3002;</li>
<li>[x] &#x7B2C; 39 &#x81F3; 44 &#x884C; &#xFF1A;&#x68C0;&#x67E5;&#x91CD;&#x8BD5;&#x961F;&#x5217;&#x6570;&#x662F;&#x5426;&#x5927;&#x4E8E;0&#x3002;</li>
<li>&#x7B2C; 47 &#x884C; &#xFF1A;&#x8BA1;&#x7B97; retry topic&#x3002;</li>
<li>[x] &#x7B2C; 50 &#x884C; &#xFF1A;&#x968F;&#x673A;&#x5206;&#x914D;&#x961F;&#x5217;&#x7F16;&#x53F7;&#xFF0C;&#x4F9D;&#x8D56; <code>retryQueueNums</code>&#x3002;</li>
<li>[x] &#x7B2C; 52 &#x81F3; 56 &#x884C; &#xFF1A;&#x8BA1;&#x7B97; <code>sysFlag</code>&#x3002;</li>
<li>&#x7B2C; 58 &#x81F3; 72 &#x884C; &#xFF1A;&#x83B7;&#x53D6; <code>TopicConfig</code>&#x3002;&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x521B;&#x5EFA;&#x3002;</li>
<li>[x] &#x7B2C; 74 &#x81F3; 80 &#x884C; &#xFF1A;&#x67E5;&#x8BE2;&#x6D88;&#x606F;&#x3002;&#x82E5;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x8FD4;&#x56DE;&#x5F02;&#x5E38;&#x9519;&#x8BEF;&#x3002;</li>
<li>[x] &#x7B2C; 82 &#x81F3; 86 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E; <code>retryTopic</code> &#x5230;&#x6D88;&#x606F;&#x62D3;&#x5C55;&#x5C5E;&#x6027;&#x3002;</li>
<li>[x] &#x7B2C; 89 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x4E0D;&#x7B49;&#x5F85;&#x5B58;&#x50A8;&#x5B8C;&#x6210;&#x3002;<ul>
<li>&#x5F53; <code>Broker</code> &#x5237;&#x76D8;&#x65B9;&#x5F0F;&#x4E3A;&#x540C;&#x6B65;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4;&#x540C;&#x6B65;&#x843D;&#x76D8;&#x4E0D;&#x80FD;&#x6279;&#x91CF;&#x63D0;&#x4EA4;&#xFF0C;&#x8FD9;&#x6837;&#x4F1A;&#x4E0D;&#x4F1A;&#x5B58;&#x5728;&#x95EE;&#x9898;&#xFF1F;&#x6709;&#x77E5;&#x9053;&#x7684;&#x540C;&#x5B66;&#x9EBB;&#x70E6;&#x544A;&#x77E5;&#x4E0B;&#x3002;&#x1F608;&#x3002;</li>
</ul>
</li>
<li>[x] &#x7B2C; 91 &#x81F3; 116 &#x884C; &#xFF1A;&#x5904;&#x7406; <code>delayLevel</code> &#x3002;</li>
<li>&#x7B2C; 118 &#x81F3; 131 &#x884C; &#xFF1A;&#x521B;&#x5EFA; <code>MessageExtBrokerInner</code> &#x3002;</li>
<li>[x] &#x7B2C; 133 &#x81F3; 135 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E;&#x539F;&#x59CB;&#x6D88;&#x606F;&#x7F16;&#x53F7;&#x5230;&#x62D3;&#x5C55;&#x5C5E;&#x6027;&#x3002;</li>
<li>&#x7B2C; 137 &#x81F3; 161 &#x884C; &#xFF1A;&#x6DFB;&#x52A0;&#x6D88;&#x606F;&#x3002;</li>
</ul>
<h1 id="7&#x3001;&#x7ED3;&#x5C3E;"><a href="#7&#x3001;&#x7ED3;&#x5C3E;" class="headerlink" title="7&#x3001;&#x7ED3;&#x5C3E;"></a>7&#x3001;&#x7ED3;&#x5C3E;</h1><p>&#x611F;&#x8C22;&#x540C;&#x5B66;&#x4EEC;&#x5BF9;&#x672C;&#x6587;&#x7684;&#x9605;&#x8BFB;&#x3001;&#x6536;&#x85CF;&#x3001;&#x70B9;&#x8D5E;&#x3002;</p>
<p>&#x1F608;&#x5982;&#x679C;&#x89E3;&#x6790;&#x5B58;&#x5728;&#x95EE;&#x9898;&#x6216;&#x8005;&#x8868;&#x8FBE;&#x8BEF;&#x89E3;&#x7684;&#xFF0C;&#x8868;&#x793A;&#x62B1;&#x6B49;&#x3002;&#x5982;&#x679C;&#x65B9;&#x4FBF;&#x7684;&#x8BDD;&#xFF0C;&#x53EF;&#x4EE5;&#x52A0;&#x4E0B; <strong>QQ&#xFF1A;7685413</strong>&#x3002;&#x8BA9;&#x6211;&#x4EEC;&#x6765;&#x4E00;&#x573A; 1 &#xFF1A;1 &#x4EA4;&#x6D41;&#xFF08;&#x641E;&#x57FA;&#xFF09;&#x3002;</p>
<p>&#x518D;&#x6B21;&#x8868;&#x793A;&#x5341;&#x5206;&#x611F;&#x8C22;&#x3002;</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1、概述"><span class="toc-number">1.</span> <span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2、ConsumeQueue-结构"><span class="toc-number">2.</span> <span class="toc-text">2、ConsumeQueue 结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3、ConsumeQueue-存储"><span class="toc-number">3.</span> <span class="toc-text">3、ConsumeQueue 存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ReputMessageService"><span class="toc-number">3.1.</span> <span class="toc-text">ReputMessageService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultMessageStore-doDispatch-…"><span class="toc-number">3.1.1.</span> <span class="toc-text">DefaultMessageStore#doDispatch(…)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeQueue-putMessagePositionInfoWrapper-…"><span class="toc-number">3.1.2.</span> <span class="toc-text">ConsumeQueue#putMessagePositionInfoWrapper(…)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FlushConsumeQueueService"><span class="toc-number">3.2.</span> <span class="toc-text">FlushConsumeQueueService</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4、Broker-提供-拉取消息-接口"><span class="toc-number">4.</span> <span class="toc-text">4、Broker 提供[拉取消息]接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageRequestHeader"><span class="toc-number">4.1.</span> <span class="toc-text">PullMessageRequestHeader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageProcessor-processRequest-…"><span class="toc-number">4.2.</span> <span class="toc-text">PullMessageProcessor#processRequest(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MessageStore-getMessage-…"><span class="toc-number">4.3.</span> <span class="toc-text">MessageStore#getMessage(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMessageFilter-isMessageMatched-…"><span class="toc-number">4.4.</span> <span class="toc-text">DefaultMessageFilter#isMessageMatched(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullRequestHoldService"><span class="toc-number">4.5.</span> <span class="toc-text">PullRequestHoldService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageProcessor-executeRequestWhenWakeup-…"><span class="toc-number">4.6.</span> <span class="toc-text">PullMessageProcessor#executeRequestWhenWakeup(…)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5、Broker-提供-更新消费进度-接口"><span class="toc-number">5.</span> <span class="toc-text">5、Broker 提供[更新消费进度]接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#BrokerController-initialize-…"><span class="toc-number">5.1.</span> <span class="toc-text">BrokerController#initialize(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigManager"><span class="toc-number">5.2.</span> <span class="toc-text">ConfigManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MixAll-string2File-…"><span class="toc-number">5.2.1.</span> <span class="toc-text">MixAll#string2File(…)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumerOffsetManager"><span class="toc-number">5.3.</span> <span class="toc-text">ConsumerOffsetManager</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6、Broker-提供-发回消息-接口"><span class="toc-number">6.</span> <span class="toc-text">6、Broker 提供[发回消息]接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SendMessageProcessor-consumerSendMsgBack-…"><span class="toc-number">6.1.</span> <span class="toc-text">SendMessageProcessor#consumerSendMsgBack(…)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7、结尾"><span class="toc-number">7.</span> <span class="toc-text">7、结尾</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&text=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&title=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&is_video=false&description=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RocketMQ 源码分析 —— Message 拉取与消费（上）&body=Check out this article: http://www.yunai.me/RocketMQ/message-pull-and-consume-first/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&title=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&title=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&title=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&title=RocketMQ 源码分析 —— Message 拉取与消费（上）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-first/&name=RocketMQ 源码分析 —— Message 拉取与消费（上）&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 王文斌
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO 待优化：过滤 爬虫
        url = $('#actions .icon').attr('href').trim(); // 文章url
//        alert(url);
        title = $('.posttitle').text().trim(); // 文章标题
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // 插入次数
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // 插入次数
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // 获取uid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip 浏览器无法获取
        // time 服务端已经记录
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO 待优化：此处性能较差，可能
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // 判断是否在文章页
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // 增加文章访问次数
                addCount(Counter);
            }
            // 记录访问日志
            addVisitLog();
            // 计算多少人访问
            countVisitLog();
        }, 1000);
    });
</script>
