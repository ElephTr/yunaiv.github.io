<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMQ 源码分析 —— Message 拉取与消费（下）">
<meta property="og:url" content="http://www.yunai.me/RocketMQ/message-pull-and-consume-second/index.html">
<meta property="og:site_name" content="芋艿V的博客">
<meta property="og:description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta property="og:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/09.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/10.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/01.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/05.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/06.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_04/07.png">
<meta property="og:updated_time" content="2017-07-20T01:40:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RocketMQ 源码分析 —— Message 拉取与消费（下）">
<meta name="twitter:description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta name="twitter:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>RocketMQ 源码分析 —— Message 拉取与消费（下）</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- 百度统计 -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- 百度站长-被动推送 -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360搜索-自动收录 -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/RocketMQ/store-init-and-shutdown/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$(" #i-prev").toggle();"="" onmouseout="$("></i></a></li>
        
        
        <li><a class="icon" href="/RocketMQ/message-pull-and-consume-first/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&text=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&title=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&is_video=false&description=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RocketMQ 源码分析 —— Message 拉取与消费（下）&body=Check out this article: http://www.yunai.me/RocketMQ/message-pull-and-consume-second/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&title=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&title=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&title=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&title=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&name=RocketMQ 源码分析 —— Message 拉取与消费（下）&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1、概述"><span class="toc-number">1.</span> <span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2、Consumer"><span class="toc-number">2.</span> <span class="toc-text">2、Consumer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3、PushConsumer-一览"><span class="toc-number">3.</span> <span class="toc-text">3、PushConsumer 一览</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4、PushConsumer-订阅"><span class="toc-number">4.</span> <span class="toc-text">4、PushConsumer 订阅</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-subscribe-…"><span class="toc-number">4.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#subscribe(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FilterAPI-buildSubscriptionData-…"><span class="toc-number">4.1.1.</span> <span class="toc-text">FilterAPI.buildSubscriptionData(…)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumer-registerMessageListener-…"><span class="toc-number">4.2.</span> <span class="toc-text">DefaultMQPushConsumer#registerMessageListener(…)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5、PushConsumer-消息队列分配"><span class="toc-number">5.</span> <span class="toc-text">5、PushConsumer 消息队列分配</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalanceService"><span class="toc-number">5.1.</span> <span class="toc-text">RebalanceService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQClientInstance-doRebalance-…"><span class="toc-number">5.2.</span> <span class="toc-text">MQClientInstance#doRebalance(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-doRebalance-…"><span class="toc-number">5.3.</span> <span class="toc-text">DefaultMQPushConsumerImpl#doRebalance(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalanceImpl-doRebalance-…"><span class="toc-number">5.4.</span> <span class="toc-text">RebalanceImpl#doRebalance(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalanceImpl-rebalanceByTopic-…"><span class="toc-number">5.4.1.</span> <span class="toc-text">RebalanceImpl#rebalanceByTopic(…)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalanceImpl-removeUnnecessaryMessageQueue-…"><span class="toc-number">5.4.2.</span> <span class="toc-text">RebalanceImpl#removeUnnecessaryMessageQueue(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RebalancePushImpl-removeUnnecessaryMessageQueue-…"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">RebalancePushImpl#removeUnnecessaryMessageQueue(…)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PullConsumer-RebalancePullImpl-removeUnnecessaryMessageQueue-…"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(…)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalancePushImpl-dispatchPullRequest-…"><span class="toc-number">5.4.3.</span> <span class="toc-text">RebalancePushImpl#dispatchPullRequest(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DefaultMQPushConsumerImpl-executePullRequestImmediately-…"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#executePullRequestImmediately(…)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AllocateMessageQueueStrategy"><span class="toc-number">5.4.4.</span> <span class="toc-text">AllocateMessageQueueStrategy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueAveragely"><span class="toc-number">5.4.4.1.</span> <span class="toc-text">AllocateMessageQueueAveragely</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueByMachineRoom"><span class="toc-number">5.4.4.2.</span> <span class="toc-text">AllocateMessageQueueByMachineRoom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueAveragelyByCircle"><span class="toc-number">5.4.4.3.</span> <span class="toc-text">AllocateMessageQueueAveragelyByCircle</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueByConfig"><span class="toc-number">5.4.4.4.</span> <span class="toc-text">AllocateMessageQueueByConfig</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5、PushConsumer-消费进度读取"><span class="toc-number">6.</span> <span class="toc-text">5、PushConsumer 消费进度读取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalancePushImpl-computePullFromWhere-…"><span class="toc-number">6.1.</span> <span class="toc-text">RebalancePushImpl#computePullFromWhere(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullConsumer-RebalancePullImpl-computePullFromWhere-…"><span class="toc-number">6.2.</span> <span class="toc-text">[PullConsumer] RebalancePullImpl#computePullFromWhere(…)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6、PushConsumer-拉取消息"><span class="toc-number">7.</span> <span class="toc-text">6、PushConsumer 拉取消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageService"><span class="toc-number">7.1.</span> <span class="toc-text">PullMessageService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-pullMessage-…"><span class="toc-number">7.2.</span> <span class="toc-text">DefaultMQPushConsumerImpl#pullMessage(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PullAPIWrapper-pullKernelImpl-…"><span class="toc-number">7.2.1.</span> <span class="toc-text">PullAPIWrapper#pullKernelImpl(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PullAPIWrapper-recalculatePullFromWhichNode-…"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">PullAPIWrapper#recalculatePullFromWhichNode(…)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQClientInstance-findBrokerAddressInSubscribe-…"><span class="toc-number">7.2.1.2.</span> <span class="toc-text">MQClientInstance#findBrokerAddressInSubscribe(…)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PullAPIWrapper-processPullResult-…"><span class="toc-number">7.2.2.</span> <span class="toc-text">PullAPIWrapper#processPullResult(…)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-putMessage-…"><span class="toc-number">7.2.3.</span> <span class="toc-text">ProcessQueue#putMessage(…)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">7.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6、PushConsumer-消费消息"><span class="toc-number">8.</span> <span class="toc-text">6、PushConsumer 消费消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-提交消费请求"><span class="toc-number">8.1.</span> <span class="toc-text">ConsumeMessageConcurrentlyService 提交消费请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-submitConsumeRequest-…"><span class="toc-number">8.1.1.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#submitConsumeRequest(…)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-submitConsumeRequestLater"><span class="toc-number">8.1.2.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeRequest"><span class="toc-number">8.2.</span> <span class="toc-text">ConsumeRequest</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-processConsumeResult-…"><span class="toc-number">8.3.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#processConsumeResult(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-removeMessage-…"><span class="toc-number">8.3.1.</span> <span class="toc-text">ProcessQueue#removeMessage(…)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-cleanExpireMsg-…"><span class="toc-number">8.4.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#cleanExpireMsg(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-cleanExpiredMsg-…"><span class="toc-number">8.4.1.</span> <span class="toc-text">ProcessQueue#cleanExpiredMsg(…)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7、PushConsumer-发回消费失败消息"><span class="toc-number">9.</span> <span class="toc-text">7、PushConsumer 发回消费失败消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-sendMessageBack-…"><span class="toc-number">9.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#sendMessageBack(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MQClientAPIImpl-consumerSendMessageBack-…"><span class="toc-number">9.1.1.</span> <span class="toc-text">MQClientAPIImpl#consumerSendMessageBack(…)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8、Consumer-消费进度"><span class="toc-number">10.</span> <span class="toc-text">8、Consumer 消费进度</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#OffsetStore"><span class="toc-number">10.1.</span> <span class="toc-text">OffsetStore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-load-…"><span class="toc-number">10.1.1.</span> <span class="toc-text">OffsetStore#load(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-load-…"><span class="toc-number">10.1.1.1.</span> <span class="toc-text">LocalFileOffsetStore#load(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#OffsetSerializeWrapper"><span class="toc-number">10.1.1.1.1.</span> <span class="toc-text">OffsetSerializeWrapper</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-load-…"><span class="toc-number">10.1.1.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#load(…)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-readOffset-…"><span class="toc-number">10.1.2.</span> <span class="toc-text">OffsetStore#readOffset(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-readOffset-…"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">LocalFileOffsetStore#readOffset(…)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-readOffset-…"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#readOffset(…)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-updateOffset-…"><span class="toc-number">10.1.3.</span> <span class="toc-text">OffsetStore#updateOffset(…)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-persistAll-…"><span class="toc-number">10.1.4.</span> <span class="toc-text">OffsetStore#persistAll(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-persistAll-…"><span class="toc-number">10.1.4.1.</span> <span class="toc-text">LocalFileOffsetStore#persistAll(…)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-persistAll-…"><span class="toc-number">10.1.4.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#persistAll(…)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQClientInstance-persistAllConsumerOffset-…"><span class="toc-number">10.1.4.3.</span> <span class="toc-text">MQClientInstance#persistAllConsumerOffset(…)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9、结尾"><span class="toc-number">11.</span> <span class="toc-text">9、结尾</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        RocketMQ 源码分析 —— Message 拉取与消费（下）
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">芋艿V的博客</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-05-10T16:00:00.000Z" itemprop="datePublished">2017-05-11</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><a class="magnific-img" href="http://www.yunai.me/images/common/wechat_mp.jpeg"><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="" class="ui centered image"></a></p>
<blockquote>
<p>&#x1F642;&#x1F642;&#x1F642;&#x5173;&#x6CE8;<strong>&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x53F7;&#xFF1A;&#x3010;&#x828B;&#x827F;&#x7684;&#x540E;&#x7AEF;&#x5C0F;&#x5C4B;&#x3011;</strong>&#x6709;&#x798F;&#x5229;&#xFF1A;  </p>
<ol class="ui list">
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>&#x6240;&#x6709;</strong>&#x6E90;&#x7801;&#x5206;&#x6790;&#x6587;&#x7AE0;&#x5217;&#x8868;  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>&#x4E2D;&#x6587;&#x6CE8;&#x91CA;&#x6E90;&#x7801; GitHub &#x5730;&#x5740;</strong>  </li>
<li>&#x60A8;&#x5BF9;&#x4E8E;&#x6E90;&#x7801;&#x7684;&#x7591;&#x95EE;&#x6BCF;&#x6761;&#x7559;&#x8A00;<strong>&#x90FD;</strong>&#x5C06;&#x5F97;&#x5230;<strong>&#x8BA4;&#x771F;</strong>&#x56DE;&#x590D;&#x3002;<strong>&#x751A;&#x81F3;&#x4E0D;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x8BFB;&#x6E90;&#x7801;&#x4E5F;&#x53EF;&#x4EE5;&#x8BF7;&#x6559;&#x5662;</strong>&#x3002;  </li>
<li><strong>&#x65B0;&#x7684;</strong>&#x6E90;&#x7801;&#x89E3;&#x6790;&#x6587;&#x7AE0;<strong>&#x5B9E;&#x65F6;</strong>&#x6536;&#x5230;&#x901A;&#x77E5;&#x3002;<strong>&#x6BCF;&#x5468;&#x66F4;&#x65B0;&#x4E00;&#x7BC7;&#x5DE6;&#x53F3;</strong>&#x3002;</li>
</ol>
</blockquote>
<hr>
<ul class="ui list">
<li><a href="#">1&#x3001;&#x6982;&#x8FF0;</a></li>
<li><a href="#">2&#x3001;Consumer</a></li>
<li><a href="#">3&#x3001;PushConsumer &#x4E00;&#x89C8;</a></li>
<li><a href="#">4&#x3001;PushConsumer &#x8BA2;&#x9605;</a><ul>
<li><a href="#">DefaultMQPushConsumerImpl#subscribe(&#x2026;)</a><ul>
<li><a href="#">FilterAPI.buildSubscriptionData(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">DefaultMQPushConsumer#registerMessageListener(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">5&#x3001;PushConsumer &#x6D88;&#x606F;&#x961F;&#x5217;&#x5206;&#x914D;</a><ul>
<li><a href="#">RebalanceService</a></li>
<li><a href="#">MQClientInstance#doRebalance(&#x2026;)</a></li>
<li><a href="#">DefaultMQPushConsumerImpl#doRebalance(&#x2026;)</a></li>
<li><a href="#">RebalanceImpl#doRebalance(&#x2026;)</a><ul>
<li><a href="#">RebalanceImpl#rebalanceByTopic(&#x2026;)</a></li>
<li><a href="#">RebalanceImpl#removeUnnecessaryMessageQueue(&#x2026;)</a><ul>
<li><a href="#">RebalancePushImpl#removeUnnecessaryMessageQueue(&#x2026;)</a></li>
<li><a href="#">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">RebalancePushImpl#dispatchPullRequest(&#x2026;)</a><ul>
<li><a href="#">DefaultMQPushConsumerImpl#executePullRequestImmediately(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">AllocateMessageQueueStrategy</a><ul>
<li><a href="#">AllocateMessageQueueAveragely</a></li>
<li><a href="#">AllocateMessageQueueByMachineRoom</a></li>
<li><a href="#">AllocateMessageQueueAveragelyByCircle</a></li>
<li><a href="#">AllocateMessageQueueByConfig</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#">5&#x3001;PushConsumer &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x8BFB;&#x53D6;</a><ul>
<li><a href="#">RebalancePushImpl#computePullFromWhere(&#x2026;)</a></li>
<li><a href="#">[PullConsumer] RebalancePullImpl#computePullFromWhere(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">6&#x3001;PushConsumer &#x62C9;&#x53D6;&#x6D88;&#x606F;</a><ul>
<li><a href="#">PullMessageService</a></li>
<li><a href="#">DefaultMQPushConsumerImpl#pullMessage(&#x2026;)</a><ul>
<li><a href="#">PullAPIWrapper#pullKernelImpl(&#x2026;)</a><ul>
<li><a href="#">PullAPIWrapper#recalculatePullFromWhichNode(&#x2026;)</a></li>
<li><a href="#">MQClientInstance#findBrokerAddressInSubscribe(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">PullAPIWrapper#processPullResult(&#x2026;)</a></li>
<li><a href="#">ProcessQueue#putMessage(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">&#x603B;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#">6&#x3001;PushConsumer &#x6D88;&#x8D39;&#x6D88;&#x606F;</a><ul>
<li><a href="#">ConsumeMessageConcurrentlyService &#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</a><ul>
<li><a href="#">ConsumeMessageConcurrentlyService#submitConsumeRequest(&#x2026;)</a></li>
<li><a href="#">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</a></li>
</ul>
</li>
<li><a href="#">ConsumeRequest</a></li>
<li><a href="#">ConsumeMessageConcurrentlyService#processConsumeResult(&#x2026;)</a><ul>
<li><a href="#">ProcessQueue#removeMessage(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">ConsumeMessageConcurrentlyService#cleanExpireMsg(&#x2026;)</a><ul>
<li><a href="#">ProcessQueue#cleanExpiredMsg(&#x2026;)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">7&#x3001;PushConsumer &#x53D1;&#x56DE;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x6D88;&#x606F;</a><ul>
<li><a href="#">DefaultMQPushConsumerImpl#sendMessageBack(&#x2026;)</a><ul>
<li><a href="#">MQClientAPIImpl#consumerSendMessageBack(&#x2026;)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">8&#x3001;Consumer &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</a><ul>
<li><a href="#">OffsetStore</a><ul>
<li><a href="#">OffsetStore#load(&#x2026;)</a><ul>
<li><a href="#">LocalFileOffsetStore#load(&#x2026;)</a><ul>
<li><a href="#">OffsetSerializeWrapper</a></li>
</ul>
</li>
<li><a href="#">RemoteBrokerOffsetStore#load(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">OffsetStore#readOffset(&#x2026;)</a><ul>
<li><a href="#">LocalFileOffsetStore#readOffset(&#x2026;)</a></li>
<li><a href="#">RemoteBrokerOffsetStore#readOffset(&#x2026;)</a></li>
</ul>
</li>
<li><a href="#">OffsetStore#updateOffset(&#x2026;)</a></li>
<li><a href="#">OffsetStore#persistAll(&#x2026;)</a><ul>
<li><a href="#">LocalFileOffsetStore#persistAll(&#x2026;)</a></li>
<li><a href="#">RemoteBrokerOffsetStore#persistAll(&#x2026;)</a></li>
<li><a href="#">MQClientInstance#persistAllConsumerOffset(&#x2026;)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#">9&#x3001;&#x7ED3;&#x5C3E;</a></li>
</ul>
<hr>
<h1 id="1&#x3001;&#x6982;&#x8FF0;"><a href="#1&#x3001;&#x6982;&#x8FF0;" class="headerlink" title="1&#x3001;&#x6982;&#x8FF0;"></a>1&#x3001;&#x6982;&#x8FF0;</h1><p>&#x672C;&#x6587;&#x63A5;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Message &#x62C9;&#x53D6;&#x4E0E;&#x6D88;&#x8D39;&#xFF08;&#x4E0A;&#xFF09;&#x300B;</a>&#x3002;</p>
<p>&#x4E3B;&#x8981;&#x89E3;&#x6790; <code>Consumer</code> &#x5728; <strong>&#x6D88;&#x8D39;</strong> &#x903B;&#x8F91;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x6E90;&#x7801;&#x3002;</p>
<h1 id="2&#x3001;Consumer"><a href="#2&#x3001;Consumer" class="headerlink" title="2&#x3001;Consumer"></a>2&#x3001;Consumer</h1><p>MQ &#x63D0;&#x4F9B;&#x4E86;&#x4E24;&#x7C7B;&#x6D88;&#x8D39;&#x8005;&#xFF1A;</p>
<ul class="ui list">
<li>PushConsumer&#xFF1A;<ul>
<li>&#x5728;&#x5927;&#x591A;&#x6570;&#x573A;&#x666F;&#x4E0B;&#x4F7F;&#x7528;&#x3002;</li>
<li>&#x540D;&#x5B57;&#x867D;&#x7136;&#x662F; <code>Push</code> &#x5F00;&#x5934;&#xFF0C;&#x5B9E;&#x9645;&#x5728;&#x5B9E;&#x73B0;&#x65F6;&#xFF0C;&#x4F7F;&#x7528; <code>Pull</code> &#x65B9;&#x5F0F;&#x5B9E;&#x73B0;&#x3002;&#x901A;&#x8FC7; <code>Pull</code> <strong>&#x4E0D;&#x65AD;&#x4E0D;&#x65AD;&#x4E0D;&#x65AD;</strong>&#x8F6E;&#x8BE2; <code>Broker</code> &#x83B7;&#x53D6;&#x6D88;&#x606F;&#x3002;&#x5F53;&#x4E0D;&#x5B58;&#x5728;&#x65B0;&#x6D88;&#x606F;&#x65F6;&#xFF0C;<code>Broker</code> &#x4F1A;<strong>&#x6302;&#x8D77;&#x8BF7;&#x6C42;</strong>&#xFF0C;&#x76F4;&#x5230;&#x6709;&#x65B0;&#x6D88;&#x606F;&#x4EA7;&#x751F;&#xFF0C;&#x53D6;&#x6D88;&#x6302;&#x8D77;&#xFF0C;&#x8FD4;&#x56DE;&#x65B0;&#x6D88;&#x606F;&#x3002;&#x8FD9;&#x6837;&#xFF0C;&#x57FA;&#x672C;&#x548C; <code>Broker</code> &#x4E3B;&#x52A8; <code>Push</code> &#x505A;&#x5230;<strong>&#x63A5;&#x8FD1;</strong>&#x7684;&#x5B9E;&#x65F6;&#x6027;&#xFF08;&#x5F53;&#x7136;&#xFF0C;&#x8FD8;&#x662F;&#x6709;&#x76F8;&#x5E94;&#x7684;&#x5B9E;&#x65F6;&#x6027;&#x635F;&#x5931;&#xFF09;&#x3002;&#x539F;&#x7406;&#x7C7B;&#x4F3C; <strong><a href="https://www.ibm.com/developerworks/cn/web/wa-lo-comet/" rel="external nofollow noopener noreferrer" target="_blank">&#x957F;&#x8F6E;&#x8BE2;( <code>Long-Polling</code> )</a></strong>&#x3002;</li>
</ul>
</li>
<li>PullConsumer</li>
</ul>
<p><strong>&#x672C;&#x6587;&#x4E3B;&#x8981;&#x8BB2;&#x89E3;<code>PushConsumer</code>&#xFF0C;&#x90E8;&#x5206;&#x8BB2;&#x89E3;<code>PullConsumer</code>&#xFF0C;&#x8DF3;&#x8FC7;<code>&#x987A;&#x5E8F;&#x6D88;&#x8D39;</code>&#x3002;</strong><br><strong>&#x672C;&#x6587;&#x4E3B;&#x8981;&#x8BB2;&#x89E3;<code>PushConsumer</code>&#xFF0C;&#x90E8;&#x5206;&#x8BB2;&#x89E3;<code>PullConsumer</code>&#xFF0C;&#x8DF3;&#x8FC7;<code>&#x987A;&#x5E8F;&#x6D88;&#x8D39;</code>&#x3002;</strong><br><strong>&#x672C;&#x6587;&#x4E3B;&#x8981;&#x8BB2;&#x89E3;<code>PushConsumer</code>&#xFF0C;&#x90E8;&#x5206;&#x8BB2;&#x89E3;<code>PullConsumer</code>&#xFF0C;&#x8DF3;&#x8FC7;<code>&#x987A;&#x5E8F;&#x6D88;&#x8D39;</code>&#x3002;</strong>  </p>
<h1 id="3&#x3001;PushConsumer-&#x4E00;&#x89C8;"><a href="#3&#x3001;PushConsumer-&#x4E00;&#x89C8;" class="headerlink" title="3&#x3001;PushConsumer &#x4E00;&#x89C8;"></a>3&#x3001;PushConsumer &#x4E00;&#x89C8;</h1><p>&#x5148;&#x770B;&#x4E00;&#x5F20; <code>PushConsumer</code> &#x5305;&#x542B;&#x7684;&#x7EC4;&#x4EF6;&#x4EE5;&#x53CA;&#x7EC4;&#x4EF6;&#x4E4B;&#x95F4;&#x7684;&#x4EA4;&#x4E92;&#x56FE;&#xFF1A;</p>
<p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/09.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/09.png" alt="PushConsumer&#x624B;&#x7ED8;&#x56FE;.png" class="ui centered image"></a></p>
<ul class="ui list">
<li><code>RebalanceService</code>&#xFF1A;&#x5747;&#x8861;&#x6D88;&#x606F;&#x961F;&#x5217;&#x670D;&#x52A1;&#xFF0C;&#x8D1F;&#x8D23;&#x5206;&#x914D;&#x5F53;&#x524D; <code>Consumer</code> &#x53EF;&#x6D88;&#x8D39;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;( <code>MessageQueue</code> )&#x3002;&#x5F53;&#x6709;&#x65B0;&#x7684; <code>Consumer</code> &#x7684;&#x52A0;&#x5165;&#x6216;&#x79FB;&#x9664;&#xFF0C;&#x90FD;&#x4F1A;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li><code>PullMessageService</code>&#xFF1A;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x670D;&#x52A1;&#xFF0C;<strong>&#x4E0D;&#x65AD;&#x4E0D;&#x65AD;&#x4E0D;&#x65AD;</strong>&#x4ECE; <code>Broker</code> &#x62C9;&#x53D6;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x4EFB;&#x52A1;&#x5230; <code>ConsumeMessageService</code>&#x3002;</li>
<li><code>ConsumeMessageService</code>&#xFF1A;&#x6D88;&#x8D39;&#x6D88;&#x606F;&#x670D;&#x52A1;&#xFF0C;<strong>&#x4E0D;&#x65AD;&#x4E0D;&#x65AD;&#x4E0D;&#x65AD;</strong>&#x6D88;&#x8D39;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;&#x3002;</li>
<li><code>RemoteBrokerOffsetStore</code>&#xFF1A;<code>Consumer</code> &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x7BA1;&#x7406;&#xFF0C;&#x8D1F;&#x8D23;&#x4ECE; <code>Broker</code> &#x83B7;&#x53D6;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#xFF0C;&#x540C;&#x6B65;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x5230; <code>Broker</code>&#x3002;</li>
<li><code>ProcessQueue</code> &#xFF1A;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x3002;</li>
<li><code>MQClientInstance</code> &#xFF1A;&#x5C01;&#x88C5;&#x5BF9; <code>Namesrv</code>&#xFF0C;<code>Broker</code> &#x7684; API&#x8C03;&#x7528;&#xFF0C;&#x63D0;&#x4F9B;&#x7ED9; <code>Producer</code>&#x3001;<code>Consumer</code> &#x4F7F;&#x7528;&#x3002;</li>
</ul>
<h1 id="4&#x3001;PushConsumer-&#x8BA2;&#x9605;"><a href="#4&#x3001;PushConsumer-&#x8BA2;&#x9605;" class="headerlink" title="4&#x3001;PushConsumer &#x8BA2;&#x9605;"></a>4&#x3001;PushConsumer &#x8BA2;&#x9605;</h1><h2 id="DefaultMQPushConsumerImpl-subscribe-&#x2026;"><a href="#DefaultMQPushConsumerImpl-subscribe-&#x2026;" class="headerlink" title="DefaultMQPushConsumerImpl#subscribe(&#x2026;)"></a>DefaultMQPushConsumerImpl#subscribe(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(String topic, String subExpression)</span> <span class="keyword">throws</span> MQClientException </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">try</span> {</div><div class="line"> <span class="number">3</span>:         <span class="comment">// &#x521B;&#x5EFA;&#x8BA2;&#x9605;&#x6570;&#x636E;</span></div><div class="line"> <span class="number">4</span>:         SubscriptionData subscriptionData = FilterAPI.buildSubscriptionData(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), <span class="comment">//</span></div><div class="line"> <span class="number">5</span>:             topic, subExpression);</div><div class="line"> <span class="number">6</span>:         <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().put(topic, subscriptionData);</div><div class="line"> <span class="number">7</span>:         <span class="comment">// &#x901A;&#x8FC7;&#x5FC3;&#x8DF3;&#x540C;&#x6B65;Consumer&#x4FE1;&#x606F;&#x5230;Broker</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.mQClientFactory != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">9</span>:             <span class="keyword">this</span>.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</div><div class="line"><span class="number">10</span>:         }</div><div class="line"><span class="number">11</span>:     } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">12</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">&quot;subscription exception&quot;</span>, e);</div><div class="line"><span class="number">13</span>:     }</div><div class="line"><span class="number">14</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x8BA2;&#x9605; <code>Topic</code> &#x3002;</li>
<li>&#x7B2C; 3 &#x81F3; 6 &#x884C; &#xFF1A;&#x521B;&#x5EFA;&#x8BA2;&#x9605;&#x6570;&#x636E;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#filterapibuildsubscriptiondata">FilterAPI.buildSubscriptionData(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 7 &#x81F3; 10 &#x884C; &#xFF1A;&#x901A;&#x8FC7;&#x5FC3;&#x8DF3;&#x540C;&#x6B65; <code>Consumer</code> &#x4FE1;&#x606F;&#x5230; <code>Broker</code>&#x3002;</li>
</ul>
<h3 id="FilterAPI-buildSubscriptionData-&#x2026;"><a href="#FilterAPI-buildSubscriptionData-&#x2026;" class="headerlink" title="FilterAPI.buildSubscriptionData(&#x2026;)"></a>FilterAPI.buildSubscriptionData(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SubscriptionData <span class="title">buildSubscriptionData</span><span class="params">(<span class="keyword">final</span> String consumerGroup, String topic,</span></span></div><div class="line"> <span class="number">2</span>:     String subString) <span class="keyword">throws</span> Exception {</div><div class="line"> <span class="number">3</span>:     SubscriptionData subscriptionData = <span class="keyword">new</span> SubscriptionData();</div><div class="line"> <span class="number">4</span>:     subscriptionData.setTopic(topic);</div><div class="line"> <span class="number">5</span>:     subscriptionData.setSubString(subString);</div><div class="line"> <span class="number">6</span>:     <span class="comment">// &#x5904;&#x7406;&#x8BA2;&#x9605;&#x8868;&#x8FBE;&#x5F0F;</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subString || subString.equals(SubscriptionData.SUB_ALL) || subString.length() == <span class="number">0</span>) {</div><div class="line"> <span class="number">8</span>:         subscriptionData.setSubString(SubscriptionData.SUB_ALL);</div><div class="line"> <span class="number">9</span>:     } <span class="keyword">else</span> {</div><div class="line"><span class="number">10</span>:         String[] tags = subString.split(<span class="string">&quot;\\|\\|&quot;</span>);</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (tags.length &gt; <span class="number">0</span>) {</div><div class="line"><span class="number">12</span>:             <span class="keyword">for</span> (String tag : tags) {</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (tag.length() &gt; <span class="number">0</span>) {</div><div class="line"><span class="number">14</span>:                     String trimString = tag.trim();</div><div class="line"><span class="number">15</span>:                     <span class="keyword">if</span> (trimString.length() &gt; <span class="number">0</span>) {</div><div class="line"><span class="number">16</span>:                         subscriptionData.getTagsSet().add(trimString);</div><div class="line"><span class="number">17</span>:                         subscriptionData.getCodeSet().add(trimString.hashCode());</div><div class="line"><span class="number">18</span>:                     }</div><div class="line"><span class="number">19</span>:                 }</div><div class="line"><span class="number">20</span>:             }</div><div class="line"><span class="number">21</span>:         } <span class="keyword">else</span> {</div><div class="line"><span class="number">22</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;subString split error&quot;</span>);</div><div class="line"><span class="number">23</span>:         }</div><div class="line"><span class="number">24</span>:     }</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     <span class="keyword">return</span> subscriptionData;</div><div class="line"><span class="number">27</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x6839;&#x636E; <code>Topic</code> &#x548C; &#x8BA2;&#x9605;&#x8868;&#x8FBE;&#x5F0F; &#x521B;&#x5EFA;&#x8BA2;&#x9605;&#x6570;&#x636E;</li>
<li>subscriptionData.subVersion = System.currentTimeMillis()&#x3002;</li>
</ul>
<h2 id="DefaultMQPushConsumer-registerMessageListener-&#x2026;"><a href="#DefaultMQPushConsumer-registerMessageListener-&#x2026;" class="headerlink" title="DefaultMQPushConsumer#registerMessageListener(&#x2026;)"></a>DefaultMQPushConsumer#registerMessageListener(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMessageListener</span><span class="params">(MessageListenerConcurrently messageListener)</span> </span>{</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.messageListener = messageListener;</div><div class="line"><span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.registerMessageListener(messageListener);</div><div class="line"><span class="number">4</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x6CE8;&#x518C;&#x6D88;&#x606F;&#x76D1;&#x542C;&#x5668;&#x3002;</li>
</ul>
<h1 id="5&#x3001;PushConsumer-&#x6D88;&#x606F;&#x961F;&#x5217;&#x5206;&#x914D;"><a href="#5&#x3001;PushConsumer-&#x6D88;&#x606F;&#x961F;&#x5217;&#x5206;&#x914D;" class="headerlink" title="5&#x3001;PushConsumer &#x6D88;&#x606F;&#x961F;&#x5217;&#x5206;&#x914D;"></a>5&#x3001;PushConsumer &#x6D88;&#x606F;&#x961F;&#x5217;&#x5206;&#x914D;</h1><p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/10.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/10.png" alt="RebalanceService&amp;PushConsumer&#x5206;&#x914D;&#x961F;&#x5217;" class="ui centered image"></a></p>
<h2 id="RebalanceService"><a href="#RebalanceService" class="headerlink" title="RebalanceService"></a>RebalanceService</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RebalanceService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>{</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * &#x7B49;&#x5F85;&#x95F4;&#x9694;&#xFF0C;&#x5355;&#x4F4D;&#xFF1A;&#x6BEB;&#x79D2;</div><div class="line"> 5:      */</div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> waitInterval =</div><div class="line"> <span class="number">7</span>:         Long.parseLong(System.getProperty(</div><div class="line"> <span class="number">8</span>:             <span class="string">&quot;rocketmq.client.rebalance.waitInterval&quot;</span>, <span class="string">&quot;20000&quot;</span>));</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"><span class="number">11</span>:     <span class="comment">/**</span></div><div class="line">12:      * MQClient&#x5BF9;&#x8C61;</div><div class="line">13:      */</div><div class="line"><span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MQClientInstance mqClientFactory;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:     <span class="function"><span class="keyword">public</span> <span class="title">RebalanceService</span><span class="params">(MQClientInstance mqClientFactory)</span> </span>{</div><div class="line"><span class="number">17</span>:         <span class="keyword">this</span>.mqClientFactory = mqClientFactory;</div><div class="line"><span class="number">18</span>:     }</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">21</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">22</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service started&quot;</span>);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) {</div><div class="line"><span class="number">25</span>:             <span class="keyword">this</span>.waitForRunning(waitInterval);</div><div class="line"><span class="number">26</span>:             <span class="keyword">this</span>.mqClientFactory.doRebalance();</div><div class="line"><span class="number">27</span>:         }</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service end&quot;</span>);</div><div class="line"><span class="number">30</span>:     }</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">33</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">34</span>:         <span class="keyword">return</span> RebalanceService.class.getSimpleName();</div><div class="line"><span class="number">35</span>:     }</div><div class="line"><span class="number">36</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x5747;&#x8861;&#x6D88;&#x606F;&#x961F;&#x5217;&#x670D;&#x52A1;&#xFF0C;&#x8D1F;&#x8D23;&#x5206;&#x914D;&#x5F53;&#x524D; <code>Consumer</code> &#x53EF;&#x6D88;&#x8D39;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;( <code>MessageQueue</code> )&#x3002;</li>
<li><p>&#x7B2C; 26 &#x884C; &#xFF1A;&#x8C03;&#x7528; <code>MQClientInstance#doRebalance(...)</code> &#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;&#x76EE;&#x524D;&#x6709;&#x4E09;&#x79CD;&#x60C5;&#x51B5;&#x60C5;&#x51B5;&#x4E0B;&#x89E6;&#x53D1;&#xFF1A;</p>
<ul>
<li>&#x5982; <code>&#x7B2C; 25 &#x884C;</code> &#x7B49;&#x5F85;&#x8D85;&#x65F6;&#xFF0C;&#x6BCF; 20s &#x8C03;&#x7528;&#x4E00;&#x6B21;&#x3002;</li>
<li><code>PushConsumer</code> &#x542F;&#x52A8;&#x65F6;&#xFF0C;&#x8C03;&#x7528; <code>rebalanceService#wakeup(...)</code> &#x89E6;&#x53D1;&#x3002;</li>
<li><code>Broker</code> &#x901A;&#x77E5; <code>Consumer</code> &#x52A0;&#x5165; &#x6216; &#x79FB;&#x9664;&#x65F6;&#xFF0C;<code>Consumer</code> &#x54CD;&#x5E94;&#x901A;&#x77E5;&#xFF0C;&#x8C03;&#x7528; <code>rebalanceService#wakeup(...)</code> &#x89E6;&#x53D1;&#x3002;</li>
</ul>
<p>&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#mqclientinstancedorebalance">MQClientInstance#doRebalance(&#x2026;)</a>&#x3002;</p>
</li>
</ul>
<h2 id="MQClientInstance-doRebalance-&#x2026;"><a href="#MQClientInstance-doRebalance-&#x2026;" class="headerlink" title="MQClientInstance#doRebalance(&#x2026;)"></a>MQClientInstance#doRebalance(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, MQConsumerInner&gt; entry : <span class="keyword">this</span>.consumerTable.entrySet()) {</div><div class="line"> <span class="number">3</span>:         MQConsumerInner impl = entry.getValue();</div><div class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (impl != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">5</span>:             <span class="keyword">try</span> {</div><div class="line"> <span class="number">6</span>:                 impl.doRebalance();</div><div class="line"> <span class="number">7</span>:             } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"> <span class="number">8</span>:                 log.error(<span class="string">&quot;doRebalance exception&quot;</span>, e);</div><div class="line"> <span class="number">9</span>:             }</div><div class="line"><span class="number">10</span>:         }</div><div class="line"><span class="number">11</span>:     }</div><div class="line"><span class="number">12</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x904D;&#x5386;&#x5F53;&#x524D; <code>Client</code> &#x5305;&#x542B;&#x7684; <code>consumerTable</code>( <code>Consumer</code>&#x96C6;&#x5408; )&#xFF0C;&#x6267;&#x884C;&#x6D88;&#x606F;&#x961F;&#x5217;&#x5206;&#x914D;&#x3002;</li>
<li><strong>&#x7591;&#x95EE;</strong>&#xFF1A;&#x76EE;&#x524D;&#x4EE3;&#x7801;&#x8C03;&#x8BD5;&#x4E0B;&#x6765;&#xFF0C;<code>consumerTable</code> &#x53EA;&#x5305;&#x542B; <code>Consumer</code> &#x81EA;&#x5DF1;&#x3002;&#x1F608;&#x6709;&#x5927;&#x5927;&#x5BF9;&#x8FD9;&#x4E2A;&#x7591;&#x95EE;&#x6709;&#x89E3;&#x7B54;&#x7684;&#xFF0C;&#x70E6;&#x8BF7;&#x89E3;&#x7B54;&#x4E0B;&#x3002;</li>
<li>&#x7B2C; 6 &#x884C; &#xFF1A;&#x8C03;&#x7528; <code>MQConsumerInner#doRebalance(...)</code> &#x8FDB;&#x884C;&#x961F;&#x5217;&#x5206;&#x914D;&#x3002;<code>DefaultMQPushConsumerImpl</code>&#x3001;<code>DefaultMQPullConsumerImpl</code> &#x5206;&#x522B;&#x5BF9;&#x8BE5;&#x63A5;&#x53E3;&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x4E86;&#x5B9E;&#x73B0;&#x3002;<code>DefaultMQPushConsumerImpl#doRebalance(...)</code> &#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="defaultmqpushconsumerimpldorebalance">DefaultMQPushConsumerImpl#doRebalance(&#x2026;)</a>&#x3002;</li>
</ul>
<h2 id="DefaultMQPushConsumerImpl-doRebalance-&#x2026;"><a href="#DefaultMQPushConsumerImpl-doRebalance-&#x2026;" class="headerlink" title="DefaultMQPushConsumerImpl#doRebalance(&#x2026;)"></a>DefaultMQPushConsumerImpl#doRebalance(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">2</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.pause) {</div><div class="line"><span class="number">3</span>:         <span class="keyword">this</span>.rebalanceImpl.doRebalance(<span class="keyword">this</span>.isConsumeOrderly());</div><div class="line"><span class="number">4</span>:     }</div><div class="line"><span class="number">5</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E;&#xFF1A;&#x6267;&#x884C;&#x6D88;&#x606F;&#x961F;&#x5217;&#x5206;&#x914D;&#x3002;</li>
<li>&#x7B2C; 3 &#x884C; &#xFF1A;&#x8C03;&#x7528; <code>RebalanceImpl#doRebalance(...)</code> &#x8FDB;&#x884C;&#x961F;&#x5217;&#x5206;&#x914D;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#rebalancepushimpldorebalance">RebalancePushImpl#doRebalance(&#x2026;)</a>&#x3002;</li>
</ul>
<h2 id="RebalanceImpl-doRebalance-&#x2026;"><a href="#RebalanceImpl-doRebalance-&#x2026;" class="headerlink" title="RebalanceImpl#doRebalance(&#x2026;)"></a>RebalanceImpl#doRebalance(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * &#x6267;&#x884C;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> isOrder &#x662F;&#x5426;&#x987A;&#x5E8F;&#x6D88;&#x606F;</div><div class="line"> 5:  */</div><div class="line"> <span class="number">6</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>{</div><div class="line"> <span class="number">7</span>:     <span class="comment">// &#x5206;&#x914D;&#x6BCF;&#x4E2A; topic &#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">8</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class="keyword">this</span>.getSubscriptionInner();</div><div class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (subTable != <span class="keyword">null</span>) {</div><div class="line"><span class="number">10</span>:         <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) {</div><div class="line"><span class="number">11</span>:             <span class="keyword">final</span> String topic = entry.getKey();</div><div class="line"><span class="number">12</span>:             <span class="keyword">try</span> {</div><div class="line"><span class="number">13</span>:                 <span class="keyword">this</span>.rebalanceByTopic(topic, isOrder);</div><div class="line"><span class="number">14</span>:             } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"><span class="number">15</span>:                 <span class="keyword">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</div><div class="line"><span class="number">16</span>:                     log.warn(<span class="string">&quot;rebalanceByTopic Exception&quot;</span>, e);</div><div class="line"><span class="number">17</span>:                 }</div><div class="line"><span class="number">18</span>:             }</div><div class="line"><span class="number">19</span>:         }</div><div class="line"><span class="number">20</span>:     }</div><div class="line"><span class="number">21</span>:     <span class="comment">// &#x79FB;&#x9664;&#x672A;&#x8BA2;&#x9605;&#x7684;topic&#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">this</span>.truncateMessageQueueNotMyTopic();</div><div class="line"><span class="number">23</span>: }</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>: <span class="comment">/**</span></div><div class="line">26:  * &#x79FB;&#x9664;&#x672A;&#x8BA2;&#x9605;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line">27:  */</div><div class="line"><span class="number">28</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">truncateMessageQueueNotMyTopic</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">29</span>:     Map&lt;String, SubscriptionData&gt; subTable = <span class="keyword">this</span>.getSubscriptionInner();</div><div class="line"><span class="number">30</span>:     <span class="keyword">for</span> (MessageQueue mq : <span class="keyword">this</span>.processQueueTable.keySet()) {</div><div class="line"><span class="number">31</span>:         <span class="keyword">if</span> (!subTable.containsKey(mq.getTopic())) {</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:             ProcessQueue pq = <span class="keyword">this</span>.processQueueTable.remove(mq);</div><div class="line"><span class="number">34</span>:             <span class="keyword">if</span> (pq != <span class="keyword">null</span>) {</div><div class="line"><span class="number">35</span>:                 pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">36</span>:                 log.info(<span class="string">&quot;doRebalance, {}, truncateMessageQueueNotMyTopic remove unnecessary mq, {}&quot;</span>, consumerGroup, mq);</div><div class="line"><span class="number">37</span>:             }</div><div class="line"><span class="number">38</span>:         }</div><div class="line"><span class="number">39</span>:     }</div><div class="line"><span class="number">40</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li><code>#doRebalance(...)</code> &#x8BF4;&#x660E; &#xFF1A;&#x6267;&#x884C;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;<ul>
<li>&#x7B2C; 7 &#x81F3; 20 &#x884C; &#xFF1A;&#x5FAA;&#x73AF;&#x8BA2;&#x9605;&#x4E3B;&#x9898;&#x96C6;&#x5408;( <code>subscriptionInner</code> )&#xFF0C;&#x5206;&#x914D;&#x6BCF;&#x4E00;&#x4E2A; <code>Topic</code> &#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li>&#x7B2C; 22 &#x884C; &#xFF1A;&#x79FB;&#x9664;&#x672A;&#x8BA2;&#x9605;&#x7684; <code>Topic</code> &#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
</ul>
</li>
<li><code>#truncateMessageQueueNotMyTopic(...)</code> &#x8BF4;&#x660E; &#xFF1A;&#x79FB;&#x9664;&#x672A;&#x8BA2;&#x9605;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;<strong>&#x5F53;&#x8C03;&#x7528; <code>DefaultMQPushConsumer#unsubscribe(topic)</code> &#x65F6;&#xFF0C;&#x53EA;&#x79FB;&#x9664;&#x8BA2;&#x9605;&#x4E3B;&#x9898;&#x96C6;&#x5408;( <code>subscriptionInner</code> )&#xFF0C;&#x5BF9;&#x5E94;&#x6D88;&#x606F;&#x961F;&#x5217;&#x79FB;&#x9664;&#x5728;&#x8BE5;&#x65B9;&#x6CD5;&#x3002;</strong></li>
</ul>
<h3 id="RebalanceImpl-rebalanceByTopic-&#x2026;"><a href="#RebalanceImpl-rebalanceByTopic-&#x2026;" class="headerlink" title="RebalanceImpl#rebalanceByTopic(&#x2026;)"></a>RebalanceImpl#rebalanceByTopic(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rebalanceByTopic</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>{</div><div class="line">  <span class="number">2</span>:     <span class="keyword">switch</span> (messageModel) {</div><div class="line">  <span class="number">3</span>:         <span class="keyword">case</span> BROADCASTING: {</div><div class="line">  <span class="number">4</span>:             Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</div><div class="line">  <span class="number">5</span>:             <span class="keyword">if</span> (mqSet != <span class="keyword">null</span>) {</div><div class="line">  <span class="number">6</span>:                 <span class="keyword">boolean</span> changed = <span class="keyword">this</span>.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);</div><div class="line">  <span class="number">7</span>:                 <span class="keyword">if</span> (changed) {</div><div class="line">  <span class="number">8</span>:                     <span class="keyword">this</span>.messageQueueChanged(topic, mqSet, mqSet);</div><div class="line">  <span class="number">9</span>:                     log.info(<span class="string">&quot;messageQueueChanged {} {} {} {}&quot;</span>, <span class="comment">//</span></div><div class="line"> <span class="number">10</span>:                         consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">11</span>:                         topic, <span class="comment">//</span></div><div class="line"> <span class="number">12</span>:                         mqSet, <span class="comment">//</span></div><div class="line"> <span class="number">13</span>:                         mqSet);</div><div class="line"> <span class="number">14</span>:                 }</div><div class="line"> <span class="number">15</span>:             } <span class="keyword">else</span> {</div><div class="line"> <span class="number">16</span>:                 log.warn(<span class="string">&quot;doRebalance, {}, but the topic[{}] not exist.&quot;</span>, consumerGroup, topic);</div><div class="line"> <span class="number">17</span>:             }</div><div class="line"> <span class="number">18</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">19</span>:         }</div><div class="line"> <span class="number">20</span>:         <span class="keyword">case</span> CLUSTERING: {</div><div class="line"> <span class="number">21</span>:             <span class="comment">// &#x83B7;&#x53D6; topic &#x5BF9;&#x5E94;&#x7684; &#x961F;&#x5217; &#x548C; consumer&#x4FE1;&#x606F;</span></div><div class="line"> <span class="number">22</span>:             Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</div><div class="line"> <span class="number">23</span>:             List&lt;String&gt; cidAll = <span class="keyword">this</span>.mQClientFactory.findConsumerIdList(topic, consumerGroup);</div><div class="line"> <span class="number">24</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> == mqSet) {</div><div class="line"> <span class="number">25</span>:                 <span class="keyword">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</div><div class="line"> <span class="number">26</span>:                     log.warn(<span class="string">&quot;doRebalance, {}, but the topic[{}] not exist.&quot;</span>, consumerGroup, topic);</div><div class="line"> <span class="number">27</span>:                 }</div><div class="line"> <span class="number">28</span>:             }</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> == cidAll) {</div><div class="line"> <span class="number">31</span>:                 log.warn(<span class="string">&quot;doRebalance, {} {}, get consumer id list failed&quot;</span>, consumerGroup, topic);</div><div class="line"> <span class="number">32</span>:             }</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:             <span class="keyword">if</span> (mqSet != <span class="keyword">null</span> &amp;&amp; cidAll != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">35</span>:                 <span class="comment">// &#x6392;&#x5E8F; &#x6D88;&#x606F;&#x961F;&#x5217; &#x548C; &#x6D88;&#x8D39;&#x8005;&#x6570;&#x7EC4;&#x3002;&#x56E0;&#x4E3A;&#x662F;&#x5728;Client&#x8FDB;&#x884C;&#x5206;&#x914D;&#x961F;&#x5217;&#xFF0C;&#x6392;&#x5E8F;&#x540E;&#xFF0C;&#x5404;Client&#x7684;&#x987A;&#x5E8F;&#x624D;&#x80FD;&#x4FDD;&#x6301;&#x4E00;&#x81F4;&#x3002;</span></div><div class="line"> <span class="number">36</span>:                 List&lt;MessageQueue&gt; mqAll = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"> <span class="number">37</span>:                 mqAll.addAll(mqSet);</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:                 Collections.sort(mqAll);</div><div class="line"> <span class="number">40</span>:                 Collections.sort(cidAll);</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:                 AllocateMessageQueueStrategy strategy = <span class="keyword">this</span>.allocateMessageQueueStrategy;</div><div class="line"> <span class="number">43</span>: </div><div class="line"> <span class="number">44</span>:                 <span class="comment">// &#x6839;&#x636E; &#x961F;&#x5217;&#x5206;&#x914D;&#x7B56;&#x7565; &#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">45</span>:                 List&lt;MessageQueue&gt; allocateResult;</div><div class="line"> <span class="number">46</span>:                 <span class="keyword">try</span> {</div><div class="line"> <span class="number">47</span>:                     allocateResult = strategy.allocate(<span class="comment">//</span></div><div class="line"> <span class="number">48</span>:                         <span class="keyword">this</span>.consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">49</span>:                         <span class="keyword">this</span>.mQClientFactory.getClientId(), <span class="comment">//</span></div><div class="line"> <span class="number">50</span>:                         mqAll, <span class="comment">//</span></div><div class="line"> <span class="number">51</span>:                         cidAll);</div><div class="line"> <span class="number">52</span>:                 } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"> <span class="number">53</span>:                     log.error(<span class="string">&quot;AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName={}&quot;</span>, strategy.getName(),</div><div class="line"> <span class="number">54</span>:                         e);</div><div class="line"> <span class="number">55</span>:                     <span class="keyword">return</span>;</div><div class="line"> <span class="number">56</span>:                 }</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:                 Set&lt;MessageQueue&gt; allocateResultSet = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"> <span class="number">59</span>:                 <span class="keyword">if</span> (allocateResult != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">60</span>:                     allocateResultSet.addAll(allocateResult);</div><div class="line"> <span class="number">61</span>:                 }</div><div class="line"> <span class="number">62</span>: </div><div class="line"> <span class="number">63</span>:                 <span class="comment">// &#x66F4;&#x65B0;&#x6D88;&#x606F;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">64</span>:                 <span class="keyword">boolean</span> changed = <span class="keyword">this</span>.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);</div><div class="line"> <span class="number">65</span>:                 <span class="keyword">if</span> (changed) {</div><div class="line"> <span class="number">66</span>:                     log.info(</div><div class="line"> <span class="number">67</span>:                         <span class="string">&quot;rebalanced result changed. allocateMessageQueueStrategyName={}, group={}, topic={}, clientId={}, mqAllSize={}, cidAllSize={}, rebalanceResultSize={}, rebalanceResultSet={}&quot;</span>,</div><div class="line"> <span class="number">68</span>:                         strategy.getName(), consumerGroup, topic, <span class="keyword">this</span>.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),</div><div class="line"> <span class="number">69</span>:                         allocateResultSet.size(), allocateResultSet);</div><div class="line"> <span class="number">70</span>:                     <span class="keyword">this</span>.messageQueueChanged(topic, mqSet, allocateResultSet);</div><div class="line"> <span class="number">71</span>:                 }</div><div class="line"> <span class="number">72</span>:             }</div><div class="line"> <span class="number">73</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">74</span>:         }</div><div class="line"> <span class="number">75</span>:         <span class="keyword">default</span>:</div><div class="line"> <span class="number">76</span>:             <span class="keyword">break</span>;</div><div class="line"> <span class="number">77</span>:     }</div><div class="line"> <span class="number">78</span>: }</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>: <span class="comment">/**</span></div><div class="line"> 81:  * &#x5F53;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x65F6;&#xFF0C;&#x66F4;&#x65B0; &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;</div><div class="line"> 82:  * - &#x79FB;&#x9664; &#x5728;processQueueTable &amp;&amp; &#x4E0D;&#x5B58;&#x5728;&#x4E8E; mqSet &#x91CC;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 83:  * - &#x589E;&#x52A0; &#x4E0D;&#x5728;processQueueTable &amp;&amp; &#x5B58;&#x5728;&#x4E8E;mqSet &#x91CC;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 84:  *</div><div class="line"> 85:  * <span class="doctag">@param</span> topic Topic</div><div class="line"> 86:  * <span class="doctag">@param</span> mqSet &#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x7ED3;&#x679C;&#x540E;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x6570;&#x7EC4;</div><div class="line"> 87:  * <span class="doctag">@param</span> isOrder &#x662F;&#x5426;&#x987A;&#x5E8F;</div><div class="line"> 88:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x53D8;&#x66F4;</div><div class="line"> 89:  */</div><div class="line"> <span class="number">90</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateProcessQueueTableInRebalance</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> Set&lt;MessageQueue&gt; mqSet, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>{</div><div class="line"> <span class="number">91</span>:     <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:     <span class="comment">// &#x79FB;&#x9664; &#x5728;processQueueTable &amp;&amp; &#x4E0D;&#x5B58;&#x5728;&#x4E8E; mqSet &#x91CC;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">94</span>:     Iterator&lt;Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it = <span class="keyword">this</span>.processQueueTable.entrySet().iterator();</div><div class="line"> <span class="number">95</span>:     <span class="keyword">while</span> (it.hasNext()) { <span class="comment">// TODO &#x5F85;&#x8BFB;&#xFF1A;</span></div><div class="line"> <span class="number">96</span>:         Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class="line"> <span class="number">97</span>:         MessageQueue mq = next.getKey();</div><div class="line"> <span class="number">98</span>:         ProcessQueue pq = next.getValue();</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:         <span class="keyword">if</span> (mq.getTopic().equals(topic)) {</div><div class="line"><span class="number">101</span>:             <span class="keyword">if</span> (!mqSet.contains(mq)) { <span class="comment">// &#x4E0D;&#x5305;&#x542B;&#x7684;&#x961F;&#x5217;</span></div><div class="line"><span class="number">102</span>:                 pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">103</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.removeUnnecessaryMessageQueue(mq, pq)) {</div><div class="line"><span class="number">104</span>:                     it.remove();</div><div class="line"><span class="number">105</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">106</span>:                     log.info(<span class="string">&quot;doRebalance, {}, remove unnecessary mq, {}&quot;</span>, consumerGroup, mq);</div><div class="line"><span class="number">107</span>:                 }</div><div class="line"><span class="number">108</span>:             } <span class="keyword">else</span> <span class="keyword">if</span> (pq.isPullExpired()) { <span class="comment">// &#x961F;&#x5217;&#x62C9;&#x53D6;&#x8D85;&#x65F6;&#xFF0C;&#x8FDB;&#x884C;&#x6E05;&#x7406;</span></div><div class="line"><span class="number">109</span>:                 <span class="keyword">switch</span> (<span class="keyword">this</span>.consumeType()) {</div><div class="line"><span class="number">110</span>:                     <span class="keyword">case</span> CONSUME_ACTIVELY:</div><div class="line"><span class="number">111</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">112</span>:                     <span class="keyword">case</span> CONSUME_PASSIVELY:</div><div class="line"><span class="number">113</span>:                         pq.setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">114</span>:                         <span class="keyword">if</span> (<span class="keyword">this</span>.removeUnnecessaryMessageQueue(mq, pq)) {</div><div class="line"><span class="number">115</span>:                             it.remove();</div><div class="line"><span class="number">116</span>:                             changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">117</span>:                             log.error(<span class="string">&quot;[BUG]doRebalance, {}, remove unnecessary mq, {}, because pull is pause, so try to fixed it&quot;</span>,</div><div class="line"><span class="number">118</span>:                                 consumerGroup, mq);</div><div class="line"><span class="number">119</span>:                         }</div><div class="line"><span class="number">120</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">121</span>:                     <span class="keyword">default</span>:</div><div class="line"><span class="number">122</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">123</span>:                 }</div><div class="line"><span class="number">124</span>:             }</div><div class="line"><span class="number">125</span>:         }</div><div class="line"><span class="number">126</span>:     }</div><div class="line"><span class="number">127</span>: </div><div class="line"><span class="number">128</span>:     <span class="comment">// &#x589E;&#x52A0; &#x4E0D;&#x5728;processQueueTable &amp;&amp; &#x5B58;&#x5728;&#x4E8E;mqSet &#x91CC;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</span></div><div class="line"><span class="number">129</span>:     List&lt;PullRequest&gt; pullRequestList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// &#x62C9;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x6570;&#x7EC4;</span></div><div class="line"><span class="number">130</span>:     <span class="keyword">for</span> (MessageQueue mq : mqSet) {</div><div class="line"><span class="number">131</span>:         <span class="keyword">if</span> (!<span class="keyword">this</span>.processQueueTable.containsKey(mq)) {</div><div class="line"><span class="number">132</span>:             <span class="keyword">if</span> (isOrder &amp;&amp; !<span class="keyword">this</span>.lock(mq)) {</div><div class="line"><span class="number">133</span>:                 log.warn(<span class="string">&quot;doRebalance, {}, add a new mq failed, {}, because lock failed&quot;</span>, consumerGroup, mq);</div><div class="line"><span class="number">134</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">135</span>:             }</div><div class="line"><span class="number">136</span>: </div><div class="line"><span class="number">137</span>:             <span class="keyword">this</span>.removeDirtyOffset(mq);</div><div class="line"><span class="number">138</span>:             ProcessQueue pq = <span class="keyword">new</span> ProcessQueue();</div><div class="line"><span class="number">139</span>:             <span class="keyword">long</span> nextOffset = <span class="keyword">this</span>.computePullFromWhere(mq);</div><div class="line"><span class="number">140</span>:             <span class="keyword">if</span> (nextOffset &gt;= <span class="number">0</span>) {</div><div class="line"><span class="number">141</span>:                 ProcessQueue pre = <span class="keyword">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class="line"><span class="number">142</span>:                 <span class="keyword">if</span> (pre != <span class="keyword">null</span>) {</div><div class="line"><span class="number">143</span>:                     log.info(<span class="string">&quot;doRebalance, {}, mq already exists, {}&quot;</span>, consumerGroup, mq);</div><div class="line"><span class="number">144</span>:                 } <span class="keyword">else</span> {</div><div class="line"><span class="number">145</span>:                     log.info(<span class="string">&quot;doRebalance, {}, add a new mq, {}&quot;</span>, consumerGroup, mq);</div><div class="line"><span class="number">146</span>:                     PullRequest pullRequest = <span class="keyword">new</span> PullRequest();</div><div class="line"><span class="number">147</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class="line"><span class="number">148</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class="line"><span class="number">149</span>:                     pullRequest.setMessageQueue(mq);</div><div class="line"><span class="number">150</span>:                     pullRequest.setProcessQueue(pq);</div><div class="line"><span class="number">151</span>:                     pullRequestList.add(pullRequest);</div><div class="line"><span class="number">152</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">153</span>:                 }</div><div class="line"><span class="number">154</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">155</span>:                 log.warn(<span class="string">&quot;doRebalance, {}, add new mq failed, {}&quot;</span>, consumerGroup, mq);</div><div class="line"><span class="number">156</span>:             }</div><div class="line"><span class="number">157</span>:         }</div><div class="line"><span class="number">158</span>:     }</div><div class="line"><span class="number">159</span>: </div><div class="line"><span class="number">160</span>:     <span class="comment">// &#x53D1;&#x8D77;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;</span></div><div class="line"><span class="number">161</span>:     <span class="keyword">this</span>.dispatchPullRequest(pullRequestList);</div><div class="line"><span class="number">162</span>: </div><div class="line"><span class="number">163</span>:     <span class="keyword">return</span> changed;</div><div class="line"><span class="number">164</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li><code>#rebalanceByTopic(...)</code> &#x8BF4;&#x660E; &#xFF1A;&#x5206;&#x914D; <code>Topic</code> &#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;<ul>
<li>&#x7B2C; 3 &#x81F3; 19 &#x884C; &#xFF1A;&#x5E7F;&#x64AD;&#x6A21;&#x5F0F;( <code>BROADCASTING</code> ) &#x4E0B;&#xFF0C;&#x5206;&#x914D; <code>Topic</code> &#x5BF9;&#x5E94;&#x7684;<strong>&#x6240;&#x6709;</strong>&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;   </li>
<li>&#x7B2C; 20 &#x81F3; 74 &#x884C; &#xFF1A;&#x96C6;&#x7FA4;&#x6A21;&#x5F0F;( <code>CLUSTERING</code> ) &#x4E0B;&#xFF0C;&#x5206;&#x914D; <code>Topic</code> &#x5BF9;&#x5E94;&#x7684;<strong>&#x90E8;&#x5206;</strong>&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;<ul>
<li>&#x7B2C; 21 &#x81F3; 40 &#x884C; &#xFF1A;&#x83B7;&#x53D6; <code>Topic</code> &#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x548C;&#x6D88;&#x8D39;&#x8005;&#x4EEC;&#xFF0C;&#x5E76;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x3002;&#x56E0;&#x4E3A;&#x5404; <code>Consumer</code> &#x662F;&#x5728;&#x672C;&#x5730;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x6392;&#x5E8F;&#x540E;&#x624D;&#x80FD;&#x4FDD;&#x8BC1;&#x5404; <code>Consumer</code> &#x987A;&#x5E8F;&#x4E00;&#x81F4;&#x3002;</li>
<li>&#x7B2C; 42 &#x81F3; 61 &#x884C; &#xFF1A;&#x6839;&#x636E; &#x961F;&#x5217;&#x5206;&#x914D;&#x7B56;&#x7565;( <code>AllocateMessageQueueStrategy</code> ) &#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#allocatemessagequeuestrategy">AllocateMessageQueueStrategy</a>&#x3002;</li>
<li>&#x7B2C; 63 &#x81F3; 72 &#x884C; &#xFF1A;&#x66F4;&#x65B0; <code>Topic</code> &#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
</ul>
</li>
</ul>
</li>
<li><code>#updateProcessQueueTableInRebalance(...)</code> &#x8BF4;&#x660E; &#xFF1A;&#x5F53;&#x5206;&#x914D;&#x961F;&#x5217;&#x65F6;&#xFF0C;&#x66F4;&#x65B0; <code>Topic</code> &#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x662F;&#x5426;&#x6709;&#x53D8;&#x66F4;&#x3002;<ul>
<li>&#x7B2C; 93 &#x81F3; 126 &#x884C; &#xFF1A;&#x79FB;&#x9664;&#x4E0D;&#x5B58;&#x5728;&#x4E8E;&#x5206;&#x914D;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;( <code>mqSet</code> ) &#x7684; &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;( <code>processQueueTable</code> )&#x3002;<ul>
<li>&#x7B2C; 103 &#x884C; &#xFF1A;&#x79FB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#rebalancepushimplremoveunnecessarymessagequeue">RebalancePushImpl#removeUnnecessaryMessageQueue(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 108 &#x81F3; 120 &#x884C; &#xFF1A;&#x961F;&#x5217;&#x62C9;&#x53D6;&#x8D85;&#x65F6;&#xFF0C;&#x5373; <code>&#x5F53;&#x524D;&#x65F6;&#x95F4; - &#x6700;&#x540E;&#x4E00;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x65F6;&#x95F4; &gt; 120s</code> ( 120s &#x53EF;&#x914D;&#x7F6E;)&#xFF0C;&#x5224;&#x5B9A;&#x53D1;&#x751F; <strong>BUG</strong>&#xFF0C;&#x8FC7;&#x4E45;&#x672A;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#xFF0C;&#x79FB;&#x9664;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;&#x79FB;&#x9664;&#x540E;&#xFF0C;&#x4E0B;&#x9762;<strong>#&#x65B0;&#x589E;&#x961F;&#x5217;&#x903B;&#x8F91;#</strong>&#x53EF;&#x4EE5;&#x91CD;&#x65B0;&#x52A0;&#x5165;&#x65B0;&#x7684;&#x8BE5;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 128 &#x81F3; 158 &#x884C; &#xFF1A;&#x589E;&#x52A0; &#x5206;&#x914D;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;( <code>mqSet</code> ) &#x65B0;&#x589E;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;<ul>
<li>&#x7B2C; 132 &#x81F3; 135 &#x884C; &#xFF1A;<code>&#x987A;&#x5E8F;&#x6D88;&#x8D39;</code> &#x76F8;&#x5173;&#x8DF3;&#x8FC7;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Message &#x987A;&#x5E8F;&#x53D1;&#x9001;&#x4E0E;&#x6D88;&#x8D39;&#x300B;</a>&#x3002;</li>
<li>&#x7B2C; 137 &#x884C; &#xFF1A;&#x79FB;&#x9664;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7684;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;</li>
<li>&#x7B2C; 139 &#x884C; &#xFF1A;&#x83B7;&#x53D6;&#x961F;&#x5217;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#rebalancepushimplcomputepullfromwhere">RebalancePushImpl#computePullFromWhere(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 140 &#x81F3; 156 &#x884C; &#xFF1A;<strong>&#x6DFB;&#x52A0;&#x65B0;&#x6D88;&#x8D39;&#x5904;&#x7406;&#x961F;&#x5217;&#xFF0C;&#x6DFB;&#x52A0;&#x6D88;&#x8D39;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</strong>&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 161 &#x884C; &#xFF1A;<strong>&#x53D1;&#x8D77;&#x65B0;&#x589E;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;</strong>&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#rebalancepushimpldispatchpullrequest">RebalancePushImpl#dispatchPullRequest(&#x2026;)</a>&#x3002;</li>
</ul>
</li>
</ul>
<h3 id="RebalanceImpl-removeUnnecessaryMessageQueue-&#x2026;"><a href="#RebalanceImpl-removeUnnecessaryMessageQueue-&#x2026;" class="headerlink" title="RebalanceImpl#removeUnnecessaryMessageQueue(&#x2026;)"></a>RebalanceImpl#removeUnnecessaryMessageQueue(&#x2026;)</h3><h4 id="RebalancePushImpl-removeUnnecessaryMessageQueue-&#x2026;"><a href="#RebalancePushImpl-removeUnnecessaryMessageQueue-&#x2026;" class="headerlink" title="RebalancePushImpl#removeUnnecessaryMessageQueue(&#x2026;)"></a>RebalancePushImpl#removeUnnecessaryMessageQueue(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="comment">// &#x540C;&#x6B65;&#x961F;&#x5217;&#x7684;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#xFF0C;&#x5E76;&#x79FB;&#x9664;&#x4E4B;&#x3002;</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"> <span class="number">4</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"> <span class="number">5</span>:     <span class="comment">// TODO &#x987A;&#x5E8F;&#x6D88;&#x8D39;</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class="line"> <span class="number">7</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())) {</div><div class="line"> <span class="number">8</span>:         <span class="keyword">try</span> {</div><div class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (pq.getLockConsume().tryLock(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) {</div><div class="line"><span class="number">10</span>:                 <span class="keyword">try</span> {</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> <span class="keyword">this</span>.unlockDelay(mq, pq);</div><div class="line"><span class="number">12</span>:                 } <span class="keyword">finally</span> {</div><div class="line"><span class="number">13</span>:                     pq.getLockConsume().unlock();</div><div class="line"><span class="number">14</span>:                 }</div><div class="line"><span class="number">15</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">16</span>:                 log.warn(<span class="string">&quot;[WRONG]mq is consuming, so can not unlock it, {}. maybe hanged for a while, {}&quot;</span>, <span class="comment">//</span></div><div class="line"><span class="number">17</span>:                     mq, <span class="comment">//</span></div><div class="line"><span class="number">18</span>:                     pq.getTryUnlockTimes());</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:                 pq.incTryUnlockTimes();</div><div class="line"><span class="number">21</span>:             }</div><div class="line"><span class="number">22</span>:         } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">23</span>:             log.error(<span class="string">&quot;removeUnnecessaryMessageQueue Exception&quot;</span>, e);</div><div class="line"><span class="number">24</span>:         }</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">27</span>:     }</div><div class="line"><span class="number">28</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">29</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x79FB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x76F8;&#x5173;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x662F;&#x5426;&#x79FB;&#x9664;&#x6210;&#x529F;&#x3002;</li>
<li>&#x7B2C; 2 &#x81F3; 4 &#x884C; &#xFF1A;<strong>&#x540C;&#x6B65;</strong>&#x961F;&#x5217;&#x7684;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#xFF0C;&#x5E76;&#x79FB;&#x9664;&#x4E4B;&#x3002;</li>
<li>&#x7B2C; 5 &#x81F3; 27 &#x884C; &#xFF1A;<code>&#x987A;&#x5E8F;&#x6D88;&#x8D39;</code> &#x76F8;&#x5173;&#x8DF3;&#x8FC7;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Message &#x987A;&#x5E8F;&#x53D1;&#x9001;&#x4E0E;&#x6D88;&#x8D39;&#x300B;</a>&#x3002;</li>
</ul>
<h4 id="PullConsumer-RebalancePullImpl-removeUnnecessaryMessageQueue-&#x2026;"><a href="#PullConsumer-RebalancePullImpl-removeUnnecessaryMessageQueue-&#x2026;" class="headerlink" title="[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(&#x2026;)"></a><code>[PullConsumer]</code> RebalancePullImpl#removeUnnecessaryMessageQueue(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>{</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.defaultMQPullConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"><span class="number">3</span>:     <span class="keyword">this</span>.defaultMQPullConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"><span class="number">4</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">5</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x79FB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x76F8;&#x5173;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x79FB;&#x9664;&#x6210;&#x529F;&#x3002;<strong>&#x548C;<code>RebalancePushImpl#removeUnnecessaryMessageQueue(...)</code>&#x57FA;&#x672C;&#x4E00;&#x81F4;&#x3002;</strong></li>
</ul>
<h3 id="RebalancePushImpl-dispatchPullRequest-&#x2026;"><a href="#RebalancePushImpl-dispatchPullRequest-&#x2026;" class="headerlink" title="RebalancePushImpl#dispatchPullRequest(&#x2026;)"></a>RebalancePushImpl#dispatchPullRequest(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchPullRequest</span><span class="params">(List&lt;PullRequest&gt; pullRequestList)</span> </span>{</div><div class="line"><span class="number">2</span>:     <span class="keyword">for</span> (PullRequest pullRequest : pullRequestList) {</div><div class="line"><span class="number">3</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">4</span>:         log.info(<span class="string">&quot;doRebalance, {}, add a new pull request {}&quot;</span>, consumerGroup, pullRequest);</div><div class="line"><span class="number">5</span>:     }</div><div class="line"><span class="number">6</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x53D1;&#x8D77;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x3002;<strong>&#x8BE5;&#x8C03;&#x7528;&#x662F;<code>PushConsumer</code>&#x4E0D;&#x65AD;&#x4E0D;&#x65AD;&#x4E0D;&#x65AD;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x7684;&#x8D77;&#x70B9;</strong>&#x3002;</li>
</ul>
<h4 id="DefaultMQPushConsumerImpl-executePullRequestImmediately-&#x2026;"><a href="#DefaultMQPushConsumerImpl-executePullRequestImmediately-&#x2026;" class="headerlink" title="DefaultMQPushConsumerImpl#executePullRequestImmediately(&#x2026;)"></a>DefaultMQPushConsumerImpl#executePullRequestImmediately(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>{</div><div class="line"><span class="number">2</span>:     <span class="keyword">this</span>.mQClientFactory.getPullMessageService().executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">3</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x63D0;&#x4EA4;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x3002;&#x63D0;&#x4EA4;&#x540E;&#xFF0C;<code>PullMessageService</code> <strong>&#x5F02;&#x6B65;&#x6267;&#x884C;</strong>&#xFF0C;<strong>&#x975E;&#x963B;&#x585E;</strong>&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="pullmessageservice">PullMessageService</a>&#x3002;</li>
</ul>
<h3 id="AllocateMessageQueueStrategy"><a href="#AllocateMessageQueueStrategy" class="headerlink" title="AllocateMessageQueueStrategy"></a>AllocateMessageQueueStrategy</h3><p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/01.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/01.png" alt="AllocateMessageQueueStrategy&#x7C7B;&#x56FE;" class="ui centered image"></a></p>
<h4 id="AllocateMessageQueueAveragely"><a href="#AllocateMessageQueueAveragely" class="headerlink" title="AllocateMessageQueueAveragely"></a>AllocateMessageQueueAveragely</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueAveragely</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">6</span>:         List&lt;String&gt; cidAll) {</div><div class="line"> <span class="number">7</span>:         <span class="comment">// &#x6821;&#x9A8C;&#x53C2;&#x6570;&#x662F;&#x5426;&#x6B63;&#x786E;</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (currentCID == <span class="keyword">null</span> || currentCID.length() &lt; <span class="number">1</span>) {</div><div class="line"> <span class="number">9</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;currentCID is empty&quot;</span>);</div><div class="line"><span class="number">10</span>:         }</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (mqAll == <span class="keyword">null</span> || mqAll.isEmpty()) {</div><div class="line"><span class="number">12</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;mqAll is null or mqAll empty&quot;</span>);</div><div class="line"><span class="number">13</span>:         }</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (cidAll == <span class="keyword">null</span> || cidAll.isEmpty()) {</div><div class="line"><span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;cidAll is null or cidAll empty&quot;</span>);</div><div class="line"><span class="number">16</span>:         }</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (!cidAll.contains(currentCID)) {</div><div class="line"><span class="number">20</span>:             log.info(<span class="string">&quot;[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}&quot;</span>,</div><div class="line"><span class="number">21</span>:                 consumerGroup,</div><div class="line"><span class="number">22</span>:                 currentCID,</div><div class="line"><span class="number">23</span>:                 cidAll);</div><div class="line"><span class="number">24</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">25</span>:         }</div><div class="line"><span class="number">26</span>:         <span class="comment">// &#x5E73;&#x5747;&#x5206;&#x914D;</span></div><div class="line"><span class="number">27</span>:         <span class="keyword">int</span> index = cidAll.indexOf(currentCID); <span class="comment">// &#x7B2C;&#x51E0;&#x4E2A;consumer&#x3002;</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> mod = mqAll.size() % cidAll.size(); <span class="comment">// &#x4F59;&#x6570;&#xFF0C;&#x5373;&#x591A;&#x5C11;&#x6D88;&#x606F;&#x961F;&#x5217;&#x65E0;&#x6CD5;&#x5E73;&#x5747;&#x5206;&#x914D;&#x3002;</span></div><div class="line"><span class="number">29</span>:         <span class="keyword">int</span> averageSize =</div><div class="line"><span class="number">30</span>:             mqAll.size() &lt;= cidAll.size() ? <span class="number">1</span> : (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()</div><div class="line"><span class="number">31</span>:                 + <span class="number">1</span> : mqAll.size() / cidAll.size());</div><div class="line"><span class="number">32</span>:         <span class="keyword">int</span> startIndex = (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod; <span class="comment">// &#x6709;&#x4F59;&#x6570;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;[0, mod) &#x5E73;&#x5206;&#x4F59;&#x6570;&#xFF0C;&#x5373;&#x6BCF;consumer&#x591A;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#xFF1B;&#x7B2C;index&#x5F00;&#x59CB;&#xFF0C;&#x8DF3;&#x8FC7;&#x524D;mod&#x4F59;&#x6570;&#x3002;</span></div><div class="line"><span class="number">33</span>:         <span class="keyword">int</span> range = Math.min(averageSize, mqAll.size() - startIndex); <span class="comment">// &#x5206;&#x914D;&#x961F;&#x5217;&#x6570;&#x91CF;&#x3002;&#x4E4B;&#x6240;&#x4EE5;&#x8981;Math.min()&#x7684;&#x539F;&#x56E0;&#x662F;&#xFF0C;mqAll.size() &lt;= cidAll.size()&#xFF0C;&#x90E8;&#x5206;consumer&#x5206;&#x914D;&#x4E0D;&#x5230;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</span></div><div class="line"><span class="number">34</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; range; i++) {</div><div class="line"><span class="number">35</span>:             result.add(mqAll.get((startIndex + i) % mqAll.size()));</div><div class="line"><span class="number">36</span>:         }</div><div class="line"><span class="number">37</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">38</span>:     }</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">41</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">42</span>:         <span class="keyword">return</span> <span class="string">&quot;AVG&quot;</span>;</div><div class="line"><span class="number">43</span>:     }</div><div class="line"><span class="number">44</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;<strong>&#x5E73;&#x5747;</strong>&#x5206;&#x914D;&#x961F;&#x5217;&#x7B56;&#x7565;&#x3002;</li>
<li>&#x7B2C; 7 &#x81F3; 25 &#x884C; &#xFF1A;&#x53C2;&#x6570;&#x6821;&#x9A8C;&#x3002;</li>
<li>&#x7B2C; 26 &#x81F3; 36 &#x884C; &#xFF1A;&#x5E73;&#x5747;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;<ul>
<li>&#x7B2C; 27 &#x884C; &#xFF1A;<code>index</code> &#xFF1A;&#x5F53;&#x524D; <code>Consumer</code> &#x5728;&#x6D88;&#x8D39;&#x96C6;&#x7FA4;&#x91CC;&#x662F;&#x7B2C;&#x51E0;&#x4E2A;&#x3002;&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x5BF9;&#x4F20;&#x5165;&#x7684; <code>cidAll</code> &#x53C2;&#x6570;&#x5FC5;&#x987B;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x7684;&#x539F;&#x56E0;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x6392;&#x5E8F;&#xFF0C;<code>Consumer</code> &#x5728;&#x672C;&#x5730;&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#x7684; <code>index</code> &#x65E0;&#x6CD5;&#x4E00;&#x81F4;&#xFF0C;&#x5F71;&#x54CD;&#x8BA1;&#x7B97;&#x7ED3;&#x679C;&#x3002;</li>
<li>&#x7B2C; 28 &#x884C; &#xFF1A;<code>mod</code> &#xFF1A;&#x4F59;&#x6570;&#xFF0C;&#x5373;&#x591A;&#x5C11;&#x6D88;&#x606F;&#x961F;&#x5217;&#x65E0;&#x6CD5;&#x5E73;&#x5747;&#x5206;&#x914D;&#x3002;</li>
<li>&#x7B2C; 29 &#x81F3; 31 &#x884C; &#xFF1A;<code>averageSize</code> &#xFF1A;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x7B80;&#x5316;&#x6210; <code>(mod &gt; 0 &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size() + 1 : mqAll.size() / cidAll.size())</code>&#x3002;<ul>
<li><code>[ 0, mod )</code> &#xFF1A;<code>mqAll.size() / cidAll.size() + 1</code>&#x3002;&#x524D;&#x9762; <code>mod</code> &#x4E2A; <code>Consumer</code> &#x5E73;&#x5206;&#x4F59;&#x6570;&#xFF0C;&#x591A;&#x83B7;&#x5F97; 1 &#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li><code>[ mod, cidAll.size() )</code> &#xFF1A;<code>mqAll.size() / cidAll.size()</code>&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 32 &#x884C; &#xFF1A;<code>startIndex</code> &#xFF1A;<code>Consumer</code> &#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x5F00;&#x59CB;&#x4F4D;&#x7F6E;&#x3002;</li>
<li>&#x7B2C; 33 &#x884C; &#xFF1A;<code>range</code> &#xFF1A;&#x5206;&#x914D;&#x961F;&#x5217;&#x6570;&#x91CF;&#x3002;&#x4E4B;&#x6240;&#x4EE5;&#x8981; <code>Math#min(...)</code> &#x7684;&#x539F;&#x56E0;&#xFF1A;&#x5F53; <code>mqAll.size() &lt;= cidAll.size()</code> &#x65F6;&#xFF0C;&#x6700;&#x540E;&#x51E0;&#x4E2A; <code>Consumer</code> &#x5206;&#x914D;&#x4E0D;&#x5230;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li>&#x7B2C; 34 &#x81F3; 36 &#x884C; &#xFF1A;&#x751F;&#x6210;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7ED3;&#x679C;&#x3002;</li>
</ul>
</li>
<li>&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</li>
</ul>
<p>&#x56FA;&#x5B9A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x957F;&#x5EA6;&#x4E3A;<strong>4</strong>&#x3002;</p>
<table>
<thead>
<tr>
<th></th>
<th>Consumer <em> 2 </em>&#x53EF;&#x4EE5;&#x6574;&#x9664;*</th>
<th>Consumer <em> 3 </em>&#x4E0D;&#x53EF;&#x6574;&#x9664;*</th>
<th>Consumer <em> 5 </em>&#x65E0;&#x6CD5;&#x90FD;&#x5206;&#x914D;*</th>
</tr>
</thead>
<tbody>
<tr>
<td>&#x6D88;&#x606F;&#x961F;&#x5217;[0]</td>
<td>Consumer[0]</td>
<td>Consumer[0]</td>
<td>Consumer[0]</td>
</tr>
<tr>
<td>&#x6D88;&#x606F;&#x961F;&#x5217;[1]</td>
<td>Consumer[0]</td>
<td>Consumer[0]</td>
<td>Consumer[1]</td>
</tr>
<tr>
<td>&#x6D88;&#x606F;&#x961F;&#x5217;[2]</td>
<td>Consumer[1]</td>
<td>Consumer[1]</td>
<td>Consumer[2]</td>
</tr>
<tr>
<td>&#x6D88;&#x606F;&#x961F;&#x5217;[3]</td>
<td>Consumer[1]</td>
<td>Consumer[2]</td>
<td>Consumer[3]</td>
</tr>
</tbody>
</table>
<h4 id="AllocateMessageQueueByMachineRoom"><a href="#AllocateMessageQueueByMachineRoom" class="headerlink" title="AllocateMessageQueueByMachineRoom"></a>AllocateMessageQueueByMachineRoom</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueByMachineRoom</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="comment">/**</span></div><div class="line"> 3:      * &#x6D88;&#x8D39;&#x8005;&#x6D88;&#x8D39;brokerName&#x96C6;&#x5408;</div><div class="line"> 4:      */</div><div class="line"> <span class="number">5</span>:     <span class="keyword">private</span> Set&lt;String&gt; consumeridcs;</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">9</span>:         List&lt;String&gt; cidAll) {</div><div class="line"><span class="number">10</span>:         <span class="comment">// &#x53C2;&#x6570;&#x6821;&#x9A8C;</span></div><div class="line"><span class="number">11</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">12</span>:         <span class="keyword">int</span> currentIndex = cidAll.indexOf(currentCID);</div><div class="line"><span class="number">13</span>:         <span class="keyword">if</span> (currentIndex &lt; <span class="number">0</span>) {</div><div class="line"><span class="number">14</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">15</span>:         }</div><div class="line"><span class="number">16</span>:         <span class="comment">// &#x8BA1;&#x7B97;&#x7B26;&#x5408;&#x5F53;&#x524D;&#x914D;&#x7F6E;&#x7684;&#x6D88;&#x8D39;&#x8005;&#x6570;&#x7EC4;(&apos;consumeridcs&apos;)&#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;</span></div><div class="line"><span class="number">17</span>:         List&lt;MessageQueue&gt; premqAll = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">18</span>:         <span class="keyword">for</span> (MessageQueue mq : mqAll) {</div><div class="line"><span class="number">19</span>:             String[] temp = mq.getBrokerName().split(<span class="string">&quot;@&quot;</span>);</div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (temp.length == <span class="number">2</span> &amp;&amp; consumeridcs.contains(temp[<span class="number">0</span>])) {</div><div class="line"><span class="number">21</span>:                 premqAll.add(mq);</div><div class="line"><span class="number">22</span>:             }</div><div class="line"><span class="number">23</span>:         }</div><div class="line"><span class="number">24</span>:         <span class="comment">// &#x5E73;&#x5747;&#x5206;&#x914D;</span></div><div class="line"><span class="number">25</span>:         <span class="keyword">int</span> mod = premqAll.size() / cidAll.size();</div><div class="line"><span class="number">26</span>:         <span class="keyword">int</span> rem = premqAll.size() % cidAll.size();</div><div class="line"><span class="number">27</span>:         <span class="keyword">int</span> startIndex = mod * currentIndex;</div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> endIndex = startIndex + mod;</div><div class="line"><span class="number">29</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; endIndex; i++) {</div><div class="line"><span class="number">30</span>:             result.add(mqAll.get(i));</div><div class="line"><span class="number">31</span>:         }</div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (rem &gt; currentIndex) {</div><div class="line"><span class="number">33</span>:             result.add(premqAll.get(currentIndex + mod * cidAll.size()));</div><div class="line"><span class="number">34</span>:         }</div><div class="line"><span class="number">35</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">36</span>:     }</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">39</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">40</span>:         <span class="keyword">return</span> <span class="string">&quot;MACHINE_ROOM&quot;</span>;</div><div class="line"><span class="number">41</span>:     }</div><div class="line"><span class="number">42</span>: </div><div class="line"><span class="number">43</span>:     <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getConsumeridcs</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">44</span>:         <span class="keyword">return</span> consumeridcs;</div><div class="line"><span class="number">45</span>:     }</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConsumeridcs</span><span class="params">(Set&lt;String&gt; consumeridcs)</span> </span>{</div><div class="line"><span class="number">48</span>:         <span class="keyword">this</span>.consumeridcs = consumeridcs;</div><div class="line"><span class="number">49</span>:     }</div><div class="line"><span class="number">50</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;<strong>&#x5E73;&#x5747;</strong>&#x5206;&#x914D;<strong>&#x53EF;&#x6D88;&#x8D39;&#x7684;</strong> <code>Broker</code> &#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li>&#x7B2C; 7 &#x81F3; 15 &#x884C; &#xFF1A;&#x53C2;&#x6570;&#x6821;&#x9A8C;&#x3002;</li>
<li>&#x7B2C; 16 &#x81F3; 23 &#x884C; &#xFF1A;&#x8BA1;&#x7B97;<strong>&#x53EF;&#x6D88;&#x8D39;&#x7684;</strong> <code>Broker</code> &#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li>&#x7B2C; 25 &#x81F3; 34 &#x884C; &#xFF1A;&#x5E73;&#x5747;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;&#x8BE5;<strong>&#x5E73;&#x5747;&#x5206;&#x914D;</strong>&#x65B9;&#x5F0F;&#x548C; <code>AllocateMessageQueueAveragely</code> &#x7565;&#x6709;&#x4E0D;&#x540C;&#xFF0C;&#x5176;&#x662F;&#x5C06;&#x591A;&#x4F59;&#x7684;&#x7ED3;&#x5C3E;&#x90E8;&#x5206;&#x5206;&#x914D;&#x7ED9;&#x524D; <code>rem</code> &#x4E2A; <code>Consumer</code>&#x3002;</li>
<li>&#x7591;&#x95EE;&#xFF1A;<em>&#x4F7F;&#x7528;&#x8BE5;&#x5206;&#x914D;&#x7B56;&#x7565;&#x65F6;&#xFF0C;<code>Consumer</code> &#x548C; <code>Broker</code> &#x5206;&#x914D;&#x9700;&#x8981;&#x600E;&#x4E48;&#x914D;&#x7F6E;</em>&#x3002;&#x1F608;&#x7B49;&#x7814;&#x7A76;<strong>&#x4E3B;&#x4ECE;</strong>&#x76F8;&#x5173;&#x6E90;&#x7801;&#x65F6;&#xFF0C;&#x4ED4;&#x7EC6;&#x8003;&#x8651;&#x4E0B;&#x3002;</li>
</ul>
<h4 id="AllocateMessageQueueAveragelyByCircle"><a href="#AllocateMessageQueueAveragelyByCircle" class="headerlink" title="AllocateMessageQueueAveragelyByCircle"></a>AllocateMessageQueueAveragelyByCircle</h4> <figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueAveragelyByCircle</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">6</span>:         List&lt;String&gt; cidAll) {</div><div class="line"> <span class="number">7</span>:         <span class="comment">// &#x6821;&#x9A8C;&#x53C2;&#x6570;&#x662F;&#x5426;&#x6B63;&#x786E;</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (currentCID == <span class="keyword">null</span> || currentCID.length() &lt; <span class="number">1</span>) {</div><div class="line"> <span class="number">9</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;currentCID is empty&quot;</span>);</div><div class="line"><span class="number">10</span>:         }</div><div class="line"><span class="number">11</span>:         <span class="keyword">if</span> (mqAll == <span class="keyword">null</span> || mqAll.isEmpty()) {</div><div class="line"><span class="number">12</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;mqAll is null or mqAll empty&quot;</span>);</div><div class="line"><span class="number">13</span>:         }</div><div class="line"><span class="number">14</span>:         <span class="keyword">if</span> (cidAll == <span class="keyword">null</span> || cidAll.isEmpty()) {</div><div class="line"><span class="number">15</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;cidAll is null or cidAll empty&quot;</span>);</div><div class="line"><span class="number">16</span>:         }</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         List&lt;MessageQueue&gt; result = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</div><div class="line"><span class="number">19</span>:         <span class="keyword">if</span> (!cidAll.contains(currentCID)) {</div><div class="line"><span class="number">20</span>:             log.info(<span class="string">&quot;[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}&quot;</span>,</div><div class="line"><span class="number">21</span>:                 consumerGroup,</div><div class="line"><span class="number">22</span>:                 currentCID,</div><div class="line"><span class="number">23</span>:                 cidAll);</div><div class="line"><span class="number">24</span>:             <span class="keyword">return</span> result;</div><div class="line"><span class="number">25</span>:         }</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:         <span class="comment">// &#x73AF;&#x72B6;&#x5206;&#x914D;</span></div><div class="line"><span class="number">28</span>:         <span class="keyword">int</span> index = cidAll.indexOf(currentCID);</div><div class="line"><span class="number">29</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt; mqAll.size(); i++) {</div><div class="line"><span class="number">30</span>:             <span class="keyword">if</span> (i % cidAll.size() == index) {</div><div class="line"><span class="number">31</span>:                 result.add(mqAll.get(i));</div><div class="line"><span class="number">32</span>:             }</div><div class="line"><span class="number">33</span>:         }</div><div class="line"><span class="number">34</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">35</span>:     }</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">38</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">39</span>:         <span class="keyword">return</span> <span class="string">&quot;AVG_BY_CIRCLE&quot;</span>;</div><div class="line"><span class="number">40</span>:     }</div><div class="line"><span class="number">41</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x73AF;&#x72B6;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
</ul>
<h4 id="AllocateMessageQueueByConfig"><a href="#AllocateMessageQueueByConfig" class="headerlink" title="AllocateMessageQueueByConfig"></a>AllocateMessageQueueByConfig</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllocateMessageQueueByConfig</span> <span class="keyword">implements</span> <span class="title">AllocateMessageQueueStrategy</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> List&lt;MessageQueue&gt; messageQueueList;</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></div><div class="line"> <span class="number">6</span>:         List&lt;String&gt; cidAll) {</div><div class="line"> <span class="number">7</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.messageQueueList;</div><div class="line"> <span class="number">8</span>:     }</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">11</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="string">&quot;CONFIG&quot;</span>;</div><div class="line"><span class="number">13</span>:     }</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">getMessageQueueList</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span> messageQueueList;</div><div class="line"><span class="number">17</span>:     }</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessageQueueList</span><span class="params">(List&lt;MessageQueue&gt; messageQueueList)</span> </span>{</div><div class="line"><span class="number">20</span>:         <span class="keyword">this</span>.messageQueueList = messageQueueList;</div><div class="line"><span class="number">21</span>:     }</div><div class="line"><span class="number">22</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x5206;&#x914D;<strong>&#x914D;&#x7F6E;&#x7684;</strong>&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li>&#x7591;&#x95EE; &#xFF1A;<em>&#x8BE5;&#x5206;&#x914D;&#x7B56;&#x7565;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x3002;</em></li>
</ul>
<h1 id="5&#x3001;PushConsumer-&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x8BFB;&#x53D6;"><a href="#5&#x3001;PushConsumer-&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x8BFB;&#x53D6;" class="headerlink" title="5&#x3001;PushConsumer &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x8BFB;&#x53D6;"></a>5&#x3001;PushConsumer &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x8BFB;&#x53D6;</h1><h2 id="RebalancePushImpl-computePullFromWhere-&#x2026;"><a href="#RebalancePushImpl-computePullFromWhere-&#x2026;" class="headerlink" title="RebalancePushImpl#computePullFromWhere(&#x2026;)"></a>RebalancePushImpl#computePullFromWhere(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">computePullFromWhere</span><span class="params">(MessageQueue mq)</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">long</span> result = -<span class="number">1</span>;</div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> ConsumeFromWhere consumeFromWhere = <span class="keyword">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeFromWhere();</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> OffsetStore offsetStore = <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">switch</span> (consumeFromWhere) {</div><div class="line"> <span class="number">6</span>:         <span class="keyword">case</span> CONSUME_FROM_LAST_OFFSET_AND_FROM_MIN_WHEN_BOOT_FIRST: <span class="comment">// &#x5E9F;&#x5F03;</span></div><div class="line"> <span class="number">7</span>:         <span class="keyword">case</span> CONSUME_FROM_MIN_OFFSET: <span class="comment">// &#x5E9F;&#x5F03;</span></div><div class="line"> <span class="number">8</span>:         <span class="keyword">case</span> CONSUME_FROM_MAX_OFFSET: <span class="comment">// &#x5E9F;&#x5F03;</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">case</span> CONSUME_FROM_LAST_OFFSET: {</div><div class="line"><span class="number">10</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">11</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) {</div><div class="line"><span class="number">12</span>:                 result = lastOffset;</div><div class="line"><span class="number">13</span>:             }</div><div class="line"><span class="number">14</span>:             <span class="comment">// First start,no offset</span></div><div class="line"><span class="number">15</span>:             <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) {</div><div class="line"><span class="number">16</span>:                 <span class="keyword">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</div><div class="line"><span class="number">17</span>:                     result = <span class="number">0L</span>;</div><div class="line"><span class="number">18</span>:                 } <span class="keyword">else</span> {</div><div class="line"><span class="number">19</span>:                     <span class="keyword">try</span> {</div><div class="line"><span class="number">20</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class="line"><span class="number">21</span>:                     } <span class="keyword">catch</span> (MQClientException e) {</div><div class="line"><span class="number">22</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">23</span>:                     }</div><div class="line"><span class="number">24</span>:                 }</div><div class="line"><span class="number">25</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">26</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">27</span>:             }</div><div class="line"><span class="number">28</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">29</span>:         }</div><div class="line"><span class="number">30</span>:         <span class="keyword">case</span> CONSUME_FROM_FIRST_OFFSET: {</div><div class="line"><span class="number">31</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">32</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) {</div><div class="line"><span class="number">33</span>:                 result = lastOffset;</div><div class="line"><span class="number">34</span>:             } <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) {</div><div class="line"><span class="number">35</span>:                 result = <span class="number">0L</span>;</div><div class="line"><span class="number">36</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">37</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">38</span>:             }</div><div class="line"><span class="number">39</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">40</span>:         }</div><div class="line"><span class="number">41</span>:         <span class="keyword">case</span> CONSUME_FROM_TIMESTAMP: {</div><div class="line"><span class="number">42</span>:             <span class="keyword">long</span> lastOffset = offsetStore.readOffset(mq, ReadOffsetType.READ_FROM_STORE);</div><div class="line"><span class="number">43</span>:             <span class="keyword">if</span> (lastOffset &gt;= <span class="number">0</span>) {</div><div class="line"><span class="number">44</span>:                 result = lastOffset;</div><div class="line"><span class="number">45</span>:             } <span class="keyword">else</span> <span class="keyword">if</span> (-<span class="number">1</span> == lastOffset) {</div><div class="line"><span class="number">46</span>:                 <span class="keyword">if</span> (mq.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</div><div class="line"><span class="number">47</span>:                     <span class="keyword">try</span> {</div><div class="line"><span class="number">48</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().maxOffset(mq);</div><div class="line"><span class="number">49</span>:                     } <span class="keyword">catch</span> (MQClientException e) {</div><div class="line"><span class="number">50</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">51</span>:                     }</div><div class="line"><span class="number">52</span>:                 } <span class="keyword">else</span> {</div><div class="line"><span class="number">53</span>:                     <span class="keyword">try</span> {</div><div class="line"><span class="number">54</span>:                         <span class="keyword">long</span> timestamp = UtilAll.parseDate(<span class="keyword">this</span>.defaultMQPushConsumerImpl.getDefaultMQPushConsumer().getConsumeTimestamp(),</div><div class="line"><span class="number">55</span>:                             UtilAll.YYYY_MMDD_HHMMSS).getTime();</div><div class="line"><span class="number">56</span>:                         result = <span class="keyword">this</span>.mQClientFactory.getMQAdminImpl().searchOffset(mq, timestamp);</div><div class="line"><span class="number">57</span>:                     } <span class="keyword">catch</span> (MQClientException e) {</div><div class="line"><span class="number">58</span>:                         result = -<span class="number">1</span>;</div><div class="line"><span class="number">59</span>:                     }</div><div class="line"><span class="number">60</span>:                 }</div><div class="line"><span class="number">61</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">62</span>:                 result = -<span class="number">1</span>;</div><div class="line"><span class="number">63</span>:             }</div><div class="line"><span class="number">64</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">65</span>:         }</div><div class="line"><span class="number">66</span>: </div><div class="line"><span class="number">67</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">68</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">69</span>:     }</div><div class="line"><span class="number">70</span>: </div><div class="line"><span class="number">71</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">72</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x8BA1;&#x7B97;&#x6D88;&#x606F;&#x961F;&#x5217;&#x5F00;&#x59CB;&#x6D88;&#x8D39;&#x4F4D;&#x7F6E;&#x3002;</li>
<li><code>PushConsumer</code> &#x8BFB;&#x53D6;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x6709;&#x4E09;&#x79CD;&#x9009;&#x9879;&#xFF1A;<ul>
<li><code>CONSUME_FROM_LAST_OFFSET</code> &#xFF1A;&#x7B2C; 6 &#x81F3; 29 &#x884C; &#xFF1A;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x6D88;&#x8D39;&#x96C6;&#x7FA4;&#x7B2C;&#x4E00;&#x6B21;&#x542F;&#x52A8;&#x4ECE;<strong>&#x961F;&#x5217;&#x7684;&#x6700;&#x540E;&#x4F4D;&#x7F6E;</strong>&#x5F00;&#x59CB;&#x6D88;&#x8D39;&#x3002;<strong>&#x540E;&#x7EED;&#x518D;&#x542F;&#x52A8;&#x63A5;&#x7740;&#x4E0A;&#x6B21;&#x6D88;&#x8D39;&#x7684;&#x8FDB;&#x5EA6;&#x5F00;&#x59CB;&#x6D88;&#x8D39;</strong>&#x3002;</li>
<li><code>CONSUME_FROM_FIRST_OFFSET</code> &#xFF1A;&#x7B2C; 30 &#x81F3; 40 &#x884C; &#xFF1A;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x6D88;&#x8D39;&#x96C6;&#x7FA4;&#x7B2C;&#x4E00;&#x6B21;&#x542F;&#x52A8;&#x4ECE;&#x961F;&#x5217;&#x7684;<strong>&#x6700;&#x524D;&#x4F4D;&#x7F6E;</strong>&#x5F00;&#x59CB;&#x6D88;&#x8D39;&#x3002;<strong>&#x540E;&#x7EED;&#x518D;&#x542F;&#x52A8;&#x63A5;&#x7740;&#x4E0A;&#x6B21;&#x6D88;&#x8D39;&#x7684;&#x8FDB;&#x5EA6;&#x5F00;&#x59CB;&#x6D88;&#x8D39;</strong>&#x3002;</li>
<li><code>CONSUME_FROM_TIMESTAMP</code> &#xFF1A;&#x7B2C; 41 &#x81F3; 65 &#x884C; &#xFF1A;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x6D88;&#x8D39;&#x96C6;&#x7FA4;&#x7B2C;&#x4E00;&#x6B21;&#x542F;&#x52A8;&#x4ECE;<strong>&#x6307;&#x5B9A;&#x65F6;&#x95F4;&#x70B9;</strong>&#x5F00;&#x59CB;&#x6D88;&#x8D39;&#x3002;<strong>&#x540E;&#x7EED;&#x518D;&#x542F;&#x52A8;&#x63A5;&#x7740;&#x4E0A;&#x6B21;&#x6D88;&#x8D39;&#x7684;&#x8FDB;&#x5EA6;&#x5F00;&#x59CB;&#x6D88;&#x8D39;</strong>&#x3002;</li>
</ul>
</li>
</ul>
<h2 id="PullConsumer-RebalancePullImpl-computePullFromWhere-&#x2026;"><a href="#PullConsumer-RebalancePullImpl-computePullFromWhere-&#x2026;" class="headerlink" title="[PullConsumer] RebalancePullImpl#computePullFromWhere(&#x2026;)"></a><code>[PullConsumer]</code> RebalancePullImpl#computePullFromWhere(&#x2026;)</h2><p>&#x6682;&#x65F6;&#x8DF3;&#x8FC7;&#x3002;&#x1F608;</p>
<h1 id="6&#x3001;PushConsumer-&#x62C9;&#x53D6;&#x6D88;&#x606F;"><a href="#6&#x3001;PushConsumer-&#x62C9;&#x53D6;&#x6D88;&#x606F;" class="headerlink" title="6&#x3001;PushConsumer &#x62C9;&#x53D6;&#x6D88;&#x606F;"></a>6&#x3001;PushConsumer &#x62C9;&#x53D6;&#x6D88;&#x606F;</h1><p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/05.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/05.png" alt="DefaultMQPushConsumerImpl&#x62C9;&#x53D6;&#x6D88;&#x606F;" class="ui centered image"></a></p>
<h2 id="PullMessageService"><a href="#PullMessageService" class="headerlink" title="PullMessageService"></a>PullMessageService</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PullMessageService</span> <span class="keyword">extends</span> <span class="title">ServiceThread</span> </span>{</div><div class="line">  <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger log = ClientLogger.getLog();</div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line">  4:      * &#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x961F;&#x5217;</div><div class="line">  5:      */</div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> LinkedBlockingQueue&lt;PullRequest&gt; pullRequestQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</div><div class="line">  <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line">  8:      * MQClient&#x5BF9;&#x8C61;</div><div class="line">  9:      */</div><div class="line"> <span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MQClientInstance mQClientFactory;</div><div class="line"> <span class="number">11</span>:     <span class="comment">/**</span></div><div class="line"> 12:      * &#x5B9A;&#x65F6;&#x5668;&#x3002;&#x7528;&#x4E8E;&#x5EF6;&#x8FDF;&#x63D0;&#x4EA4;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;</div><div class="line"> 13:      */</div><div class="line"> <span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService = Executors</div><div class="line"> <span class="number">15</span>:         .newSingleThreadScheduledExecutor(<span class="keyword">new</span> ThreadFactory() {</div><div class="line"> <span class="number">16</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">17</span>:             <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>{</div><div class="line"> <span class="number">18</span>:                 <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">&quot;PullMessageServiceScheduledThread&quot;</span>);</div><div class="line"> <span class="number">19</span>:             }</div><div class="line"> <span class="number">20</span>:         });</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="function"><span class="keyword">public</span> <span class="title">PullMessageService</span><span class="params">(MQClientInstance mQClientFactory)</span> </span>{</div><div class="line"> <span class="number">23</span>:         <span class="keyword">this</span>.mQClientFactory = mQClientFactory;</div><div class="line"> <span class="number">24</span>:     }</div><div class="line"> <span class="number">25</span>: </div><div class="line"> <span class="number">26</span>:     <span class="comment">/**</span></div><div class="line"> 27:      * &#x6267;&#x884C;&#x5EF6;&#x8FDF;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</div><div class="line"> 28:      *</div><div class="line"> 29:      * <span class="doctag">@param</span> pullRequest &#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</div><div class="line"> 30:      * <span class="doctag">@param</span> timeDelay &#x5EF6;&#x8FDF;&#x65F6;&#x957F;</div><div class="line"> 31:      */</div><div class="line"> <span class="number">32</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestLater</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest, <span class="keyword">final</span> <span class="keyword">long</span> timeDelay)</span> </span>{</div><div class="line"> <span class="number">33</span>:         <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() {</div><div class="line"> <span class="number">34</span>: </div><div class="line"> <span class="number">35</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">36</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">37</span>:                 PullMessageService.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"> <span class="number">38</span>:             }</div><div class="line"> <span class="number">39</span>:         }, timeDelay, TimeUnit.MILLISECONDS);</div><div class="line"> <span class="number">40</span>:     }</div><div class="line"> <span class="number">41</span>: </div><div class="line"> <span class="number">42</span>:     <span class="comment">/**</span></div><div class="line"> 43:      * &#x6267;&#x884C;&#x7ACB;&#x5373;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</div><div class="line"> 44:      *</div><div class="line"> 45:      * <span class="doctag">@param</span> pullRequest &#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</div><div class="line"> 46:      */</div><div class="line"> <span class="number">47</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>{</div><div class="line"> <span class="number">48</span>:         <span class="keyword">try</span> {</div><div class="line"> <span class="number">49</span>:             <span class="keyword">this</span>.pullRequestQueue.put(pullRequest);</div><div class="line"> <span class="number">50</span>:         } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"> <span class="number">51</span>:             log.error(<span class="string">&quot;executePullRequestImmediately pullRequestQueue.put&quot;</span>, e);</div><div class="line"> <span class="number">52</span>:         }</div><div class="line"> <span class="number">53</span>:     }</div><div class="line"> <span class="number">54</span>: </div><div class="line"> <span class="number">55</span>:     <span class="comment">/**</span></div><div class="line"> 56:      * &#x6267;&#x884C;&#x5EF6;&#x8FDF;&#x4EFB;&#x52A1;</div><div class="line"> 57:      *</div><div class="line"> 58:      * <span class="doctag">@param</span> r &#x4EFB;&#x52A1;</div><div class="line"> 59:      * <span class="doctag">@param</span> timeDelay &#x5EF6;&#x8FDF;&#x65F6;&#x957F;</div><div class="line"> 60:      */</div><div class="line"> <span class="number">61</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeTaskLater</span><span class="params">(<span class="keyword">final</span> Runnable r, <span class="keyword">final</span> <span class="keyword">long</span> timeDelay)</span> </span>{</div><div class="line"> <span class="number">62</span>:         <span class="keyword">this</span>.scheduledExecutorService.schedule(r, timeDelay, TimeUnit.MILLISECONDS);</div><div class="line"> <span class="number">63</span>:     }</div><div class="line"> <span class="number">64</span>: </div><div class="line"> <span class="number">65</span>:     <span class="function"><span class="keyword">public</span> ScheduledExecutorService <span class="title">getScheduledExecutorService</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">66</span>:         <span class="keyword">return</span> scheduledExecutorService;</div><div class="line"> <span class="number">67</span>:     }</div><div class="line"> <span class="number">68</span>: </div><div class="line"> <span class="number">69</span>:     <span class="comment">/**</span></div><div class="line"> 70:      * &#x62C9;&#x53D6;&#x6D88;&#x606F;</div><div class="line"> 71:      *</div><div class="line"> 72:      * <span class="doctag">@param</span> pullRequest &#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</div><div class="line"> 73:      */</div><div class="line"> <span class="number">74</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>{</div><div class="line"> <span class="number">75</span>:         <span class="keyword">final</span> MQConsumerInner consumer = <span class="keyword">this</span>.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());</div><div class="line"> <span class="number">76</span>:         <span class="keyword">if</span> (consumer != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">77</span>:             DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;</div><div class="line"> <span class="number">78</span>:             impl.pullMessage(pullRequest);</div><div class="line"> <span class="number">79</span>:         } <span class="keyword">else</span> {</div><div class="line"> <span class="number">80</span>:             log.warn(<span class="string">&quot;No matched consumer for the PullRequest {}, drop it&quot;</span>, pullRequest);</div><div class="line"> <span class="number">81</span>:         }</div><div class="line"> <span class="number">82</span>:     }</div><div class="line"> <span class="number">83</span>: </div><div class="line"> <span class="number">84</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">85</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">86</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service started&quot;</span>);</div><div class="line"> <span class="number">87</span>: </div><div class="line"> <span class="number">88</span>:         <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) {</div><div class="line"> <span class="number">89</span>:             <span class="keyword">try</span> {</div><div class="line"> <span class="number">90</span>:                 PullRequest pullRequest = <span class="keyword">this</span>.pullRequestQueue.take();</div><div class="line"> <span class="number">91</span>:                 <span class="keyword">if</span> (pullRequest != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">92</span>:                     <span class="keyword">this</span>.pullMessage(pullRequest);</div><div class="line"> <span class="number">93</span>:                 }</div><div class="line"> <span class="number">94</span>:             } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"> <span class="number">95</span>:             } <span class="keyword">catch</span> (Exception e) {</div><div class="line"> <span class="number">96</span>:                 log.error(<span class="string">&quot;Pull Message Service Run Method exception&quot;</span>, e);</div><div class="line"> <span class="number">97</span>:             }</div><div class="line"> <span class="number">98</span>:         }</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:         log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">&quot; service end&quot;</span>);</div><div class="line"><span class="number">101</span>:     }</div><div class="line"><span class="number">102</span>: </div><div class="line"><span class="number">103</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">104</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">getServiceName</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">105</span>:         <span class="keyword">return</span> PullMessageService.class.getSimpleName();</div><div class="line"><span class="number">106</span>:     }</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x670D;&#x52A1;&#xFF0C;&#x4E0D;&#x65AD;&#x4E0D;&#x65AD;&#x4E0D;&#x65AD;&#x4ECE; <code>Broker</code> &#x62C9;&#x53D6;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x4EFB;&#x52A1;&#x5230; <code>ConsumeMessageService</code>&#x3002;</li>
<li><code>#executePullRequestLater(...)</code> &#xFF1A;&#x7B2C; 26 &#x81F3; 40 &#x884C; &#xFF1A; &#x63D0;&#x4EA4;<strong>&#x5EF6;&#x8FDF;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</li>
<li><code>#executePullRequestImmediately(...)</code> &#xFF1A;&#x7B2C; 42 &#x81F3; 53 &#x884C; &#xFF1A;&#x63D0;&#x4EA4;<strong>&#x7ACB;&#x5373;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</li>
<li><code>#executeTaskLater(...)</code> &#xFF1A;&#x7B2C; 55 &#x81F3; 63 &#x884C; &#xFF1A;&#x63D0;&#x4EA4;<strong>&#x5EF6;&#x8FDF;&#x4EFB;&#x52A1;</strong>&#x3002;</li>
<li><code>#pullMessage(...)</code> &#xFF1A;&#x7B2C; 69 &#x81F3; 82 &#x884C; &#xFF1A;&#x6267;&#x884C;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x903B;&#x8F91;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#defaultmqpushconsumerimplpullmessage">DefaultMQPushConsumerImpl#pullMessage(&#x2026;)</a>&#x3002;</li>
<li><code>#run(...)</code> &#xFF1A;&#x7B2C; 84 &#x81F3; 101 &#x884C; &#xFF1A;&#x5FAA;&#x73AF;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x961F;&#x5217;( <code>pullRequestQueue</code> )&#xFF0C;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#x3002;</li>
</ul>
<h2 id="DefaultMQPushConsumerImpl-pullMessage-&#x2026;"><a href="#DefaultMQPushConsumerImpl-pullMessage-&#x2026;" class="headerlink" title="DefaultMQPushConsumerImpl#pullMessage(&#x2026;)"></a>DefaultMQPushConsumerImpl#pullMessage(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>{</div><div class="line">  <span class="number">2</span>:     <span class="keyword">final</span> ProcessQueue processQueue = pullRequest.getProcessQueue();</div><div class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (processQueue.isDropped()) {</div><div class="line">  <span class="number">4</span>:         log.info(<span class="string">&quot;the pull request[{}] is dropped.&quot;</span>, pullRequest.toString());</div><div class="line">  <span class="number">5</span>:         <span class="keyword">return</span>;</div><div class="line">  <span class="number">6</span>:     }</div><div class="line">  <span class="number">7</span>: </div><div class="line">  <span class="number">8</span>:     <span class="comment">// &#x8BBE;&#x7F6E;&#x961F;&#x5217;&#x6700;&#x540E;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x65F6;&#x95F4;</span></div><div class="line">  <span class="number">9</span>:     pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>:     <span class="comment">// &#x5224;&#x65AD;consumer&#x72B6;&#x6001;&#x662F;&#x5426;&#x8FD0;&#x884C;&#x4E2D;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x662F;&#xFF0C;&#x5219;&#x5EF6;&#x8FDF;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3002;</span></div><div class="line"> <span class="number">12</span>:     <span class="keyword">try</span> {</div><div class="line"> <span class="number">13</span>:         <span class="keyword">this</span>.makeSureStateOK();</div><div class="line"> <span class="number">14</span>:     } <span class="keyword">catch</span> (MQClientException e) {</div><div class="line"> <span class="number">15</span>:         log.warn(<span class="string">&quot;pullMessage exception, consumer state not ok&quot;</span>, e);</div><div class="line"> <span class="number">16</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">17</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">18</span>:     }</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:     <span class="comment">// &#x5224;&#x65AD;&#x662F;&#x5426;&#x6682;&#x505C;&#x4E2D;&#x3002;</span></div><div class="line"> <span class="number">21</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.isPause()) {</div><div class="line"> <span class="number">22</span>:         log.warn(<span class="string">&quot;consumer was paused, execute pull request later. instanceName={}, group={}&quot;</span>, <span class="keyword">this</span>.defaultMQPushConsumer.getInstanceName(), <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup());</div><div class="line"> <span class="number">23</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_SUSPEND);</div><div class="line"> <span class="number">24</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">25</span>:     }</div><div class="line"> <span class="number">26</span>: </div><div class="line"> <span class="number">27</span>:     <span class="comment">// &#x5224;&#x65AD;&#x662F;&#x5426;&#x8D85;&#x8FC7;&#x6700;&#x5927;&#x6301;&#x6709;&#x6D88;&#x606F;&#x6570;&#x91CF;&#x3002;&#x9ED8;&#x8BA4;&#x6700;&#x5927;&#x503C;&#x4E3A;1000&#x3002;</span></div><div class="line"> <span class="number">28</span>:     <span class="keyword">long</span> size = processQueue.getMsgCount().get();</div><div class="line"> <span class="number">29</span>:     <span class="keyword">if</span> (size &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getPullThresholdForQueue()) {</div><div class="line"> <span class="number">30</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class="comment">// &#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x3002;50ms&#x3002;</span></div><div class="line"> <span class="number">31</span>:         <span class="keyword">if</span> ((flowControlTimes1++ % <span class="number">1000</span>) == <span class="number">0</span>) {</div><div class="line"> <span class="number">32</span>:             log.warn(</div><div class="line"> <span class="number">33</span>:                 <span class="string">&quot;the consumer message buffer is full, so do flow control, minOffset={}, maxOffset={}, size={}, pullRequest={}, flowControlTimes={}&quot;</span>,</div><div class="line"> <span class="number">34</span>:                 processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), size, pullRequest, flowControlTimes1);</div><div class="line"> <span class="number">35</span>:         }</div><div class="line"> <span class="number">36</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">37</span>:     }</div><div class="line"> <span class="number">38</span>: </div><div class="line"> <span class="number">39</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.consumeOrderly) { <span class="comment">// &#x5224;&#x65AD;&#x6D88;&#x606F;&#x8DE8;&#x5EA6;&#x662F;&#x5426;&#x8FC7;&#x5927;&#x3002;</span></div><div class="line"> <span class="number">40</span>:         <span class="keyword">if</span> (processQueue.getMaxSpan() &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) {</div><div class="line"> <span class="number">41</span>:             <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL); <span class="comment">// &#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x3002;50ms&#x3002;</span></div><div class="line"> <span class="number">42</span>:             <span class="keyword">if</span> ((flowControlTimes2++ % <span class="number">1000</span>) == <span class="number">0</span>) {</div><div class="line"> <span class="number">43</span>:                 log.warn(</div><div class="line"> <span class="number">44</span>:                     <span class="string">&quot;the queue&apos;s messages, span too long, so do flow control, minOffset={}, maxOffset={}, maxSpan={}, pullRequest={}, flowControlTimes={}&quot;</span>,</div><div class="line"> <span class="number">45</span>:                     processQueue.getMsgTreeMap().firstKey(), processQueue.getMsgTreeMap().lastKey(), processQueue.getMaxSpan(),</div><div class="line"> <span class="number">46</span>:                     pullRequest, flowControlTimes2);</div><div class="line"> <span class="number">47</span>:             }</div><div class="line"> <span class="number">48</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">49</span>:         }</div><div class="line"> <span class="number">50</span>:     } <span class="keyword">else</span> { <span class="comment">// TODO &#x987A;&#x5E8F;&#x6D88;&#x8D39;</span></div><div class="line"> <span class="number">51</span>:         <span class="keyword">if</span> (processQueue.isLocked()) {</div><div class="line"> <span class="number">52</span>:             <span class="keyword">if</span> (!pullRequest.isLockedFirst()) {</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> offset = <span class="keyword">this</span>.rebalanceImpl.computePullFromWhere(pullRequest.getMessageQueue());</div><div class="line"> <span class="number">54</span>:                 <span class="keyword">boolean</span> brokerBusy = offset &lt; pullRequest.getNextOffset();</div><div class="line"> <span class="number">55</span>:                 log.info(<span class="string">&quot;the first time to pull message, so fix offset from broker. pullRequest: {} NewOffset: {} brokerBusy: {}&quot;</span>,</div><div class="line"> <span class="number">56</span>:                     pullRequest, offset, brokerBusy);</div><div class="line"> <span class="number">57</span>:                 <span class="keyword">if</span> (brokerBusy) {</div><div class="line"> <span class="number">58</span>:                     log.info(<span class="string">&quot;[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: {} NewOffset: {}&quot;</span>,</div><div class="line"> <span class="number">59</span>:                         pullRequest, offset);</div><div class="line"> <span class="number">60</span>:                 }</div><div class="line"> <span class="number">61</span>: </div><div class="line"> <span class="number">62</span>:                 pullRequest.setLockedFirst(<span class="keyword">true</span>);</div><div class="line"> <span class="number">63</span>:                 pullRequest.setNextOffset(offset);</div><div class="line"> <span class="number">64</span>:             }</div><div class="line"> <span class="number">65</span>:         } <span class="keyword">else</span> {</div><div class="line"> <span class="number">66</span>:             <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">67</span>:             log.info(<span class="string">&quot;pull message later because not locked in broker, {}&quot;</span>, pullRequest);</div><div class="line"> <span class="number">68</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">69</span>:         }</div><div class="line"> <span class="number">70</span>:     }</div><div class="line"> <span class="number">71</span>: </div><div class="line"> <span class="number">72</span>:     <span class="comment">// &#x83B7;&#x53D6;Topic &#x5BF9;&#x5E94;&#x7684;&#x8BA2;&#x9605;&#x4FE1;&#x606F;&#x3002;&#x82E5;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x5EF6;&#x8FDF;&#x62C9;&#x53D6;&#x6D88;&#x606F;</span></div><div class="line"> <span class="number">73</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData = <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class="line"> <span class="number">74</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) {</div><div class="line"> <span class="number">75</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"> <span class="number">76</span>:         log.warn(<span class="string">&quot;find the consumer&apos;s subscription failed, {}&quot;</span>, pullRequest);</div><div class="line"> <span class="number">77</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">78</span>:     }</div><div class="line"> <span class="number">79</span>: </div><div class="line"> <span class="number">80</span>:     <span class="keyword">final</span> <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">81</span>: </div><div class="line"> <span class="number">82</span>:     PullCallback pullCallback = <span class="keyword">new</span> PullCallback() {</div><div class="line"> <span class="number">83</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">84</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(PullResult pullResult)</span> </span>{</div><div class="line"> <span class="number">85</span>:             <span class="keyword">if</span> (pullResult != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">86</span>:                 pullResult = DefaultMQPushConsumerImpl.<span class="keyword">this</span>.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,</div><div class="line"> <span class="number">87</span>:                     subscriptionData);</div><div class="line"> <span class="number">88</span>: </div><div class="line"> <span class="number">89</span>:                 <span class="keyword">switch</span> (pullResult.getPullStatus()) {</div><div class="line"> <span class="number">90</span>:                     <span class="keyword">case</span> FOUND:</div><div class="line"> <span class="number">91</span>:                         <span class="comment">// &#x8BBE;&#x7F6E;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;</span></div><div class="line"> <span class="number">92</span>:                         <span class="keyword">long</span> prevRequestOffset = pullRequest.getNextOffset();</div><div class="line"> <span class="number">93</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"> <span class="number">94</span>: </div><div class="line"> <span class="number">95</span>:                         <span class="comment">// &#x7EDF;&#x8BA1;</span></div><div class="line"> <span class="number">96</span>:                         <span class="keyword">long</span> pullRT = System.currentTimeMillis() - beginTimestamp;</div><div class="line"> <span class="number">97</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),</div><div class="line"> <span class="number">98</span>:                             pullRequest.getMessageQueue().getTopic(), pullRT);</div><div class="line"> <span class="number">99</span>: </div><div class="line"><span class="number">100</span>:                         <span class="keyword">long</span> firstMsgOffset = Long.MAX_VALUE;</div><div class="line"><span class="number">101</span>:                         <span class="keyword">if</span> (pullResult.getMsgFoundList() == <span class="keyword">null</span> || pullResult.getMsgFoundList().isEmpty()) {</div><div class="line"><span class="number">102</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">103</span>:                         } <span class="keyword">else</span> {</div><div class="line"><span class="number">104</span>:                             firstMsgOffset = pullResult.getMsgFoundList().get(<span class="number">0</span>).getQueueOffset();</div><div class="line"><span class="number">105</span>: </div><div class="line"><span class="number">106</span>:                             <span class="comment">// &#x7EDF;&#x8BA1;</span></div><div class="line"><span class="number">107</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),</div><div class="line"><span class="number">108</span>:                                 pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:                             <span class="comment">// &#x63D0;&#x4EA4;&#x62C9;&#x53D6;&#x5230;&#x7684;&#x6D88;&#x606F;&#x5230;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;</span></div><div class="line"><span class="number">111</span>:                             <span class="keyword">boolean</span> dispathToConsume = processQueue.putMessage(pullResult.getMsgFoundList());</div><div class="line"><span class="number">112</span>: </div><div class="line"><span class="number">113</span>:                             <span class="comment">// &#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</span></div><div class="line"><span class="number">114</span>:                             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.consumeMessageService.submitConsumeRequest(<span class="comment">//</span></div><div class="line"><span class="number">115</span>:                                 pullResult.getMsgFoundList(), <span class="comment">//</span></div><div class="line"><span class="number">116</span>:                                 processQueue, <span class="comment">//</span></div><div class="line"><span class="number">117</span>:                                 pullRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"><span class="number">118</span>:                                 dispathToConsume);</div><div class="line"><span class="number">119</span>: </div><div class="line"><span class="number">120</span>:                             <span class="comment">// &#x63D0;&#x4EA4;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</span></div><div class="line"><span class="number">121</span>:                             <span class="keyword">if</span> (DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval() &gt; <span class="number">0</span>) {</div><div class="line"><span class="number">122</span>:                                 DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest,</div><div class="line"><span class="number">123</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval());</div><div class="line"><span class="number">124</span>:                             } <span class="keyword">else</span> {</div><div class="line"><span class="number">125</span>:                                 DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">126</span>:                             }</div><div class="line"><span class="number">127</span>:                         }</div><div class="line"><span class="number">128</span>: </div><div class="line"><span class="number">129</span>:                         <span class="comment">// &#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x5C0F;&#x4E8E;&#x4E0A;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E; &#x6216;&#x8005; &#x7B2C;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x5C0F;&#x4E8E;&#x4E0A;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#xFF0C;&#x5219;&#x5224;&#x5B9A;&#x4E3A;BUG&#xFF0C;&#x8F93;&#x51FA;log</span></div><div class="line"><span class="number">130</span>:                         <span class="keyword">if</span> (pullResult.getNextBeginOffset() &lt; prevRequestOffset<span class="comment">//</span></div><div class="line"><span class="number">131</span>:                             || firstMsgOffset &lt; prevRequestOffset) {</div><div class="line"><span class="number">132</span>:                             log.warn(</div><div class="line"><span class="number">133</span>:                                 <span class="string">&quot;[BUG] pull message result maybe data wrong, nextBeginOffset: {} firstMsgOffset: {} prevRequestOffset: {}&quot;</span>, <span class="comment">//</span></div><div class="line"><span class="number">134</span>:                                 pullResult.getNextBeginOffset(), <span class="comment">//</span></div><div class="line"><span class="number">135</span>:                                 firstMsgOffset, <span class="comment">//</span></div><div class="line"><span class="number">136</span>:                                 prevRequestOffset);</div><div class="line"><span class="number">137</span>:                         }</div><div class="line"><span class="number">138</span>: </div><div class="line"><span class="number">139</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">140</span>:                     <span class="keyword">case</span> NO_NEW_MSG:</div><div class="line"><span class="number">141</span>:                         <span class="comment">// &#x8BBE;&#x7F6E;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;</span></div><div class="line"><span class="number">142</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">143</span>: </div><div class="line"><span class="number">144</span>:                         <span class="comment">// &#x6301;&#x4E45;&#x5316;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</span></div><div class="line"><span class="number">145</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.correctTagsOffset(pullRequest);</div><div class="line"><span class="number">146</span>: </div><div class="line"><span class="number">147</span>:                         <span class="comment">// &#x7ACB;&#x5373;&#x63D0;&#x4EA4;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</span></div><div class="line"><span class="number">148</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">149</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">150</span>:                     <span class="keyword">case</span> NO_MATCHED_MSG:</div><div class="line"><span class="number">151</span>:                         <span class="comment">// &#x8BBE;&#x7F6E;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;</span></div><div class="line"><span class="number">152</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">153</span>: </div><div class="line"><span class="number">154</span>:                         <span class="comment">// &#x6301;&#x4E45;&#x5316;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</span></div><div class="line"><span class="number">155</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.correctTagsOffset(pullRequest);</div><div class="line"><span class="number">156</span>: </div><div class="line"><span class="number">157</span>:                         <span class="comment">// &#x63D0;&#x4EA4;&#x7ACB;&#x5373;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</span></div><div class="line"><span class="number">158</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</div><div class="line"><span class="number">159</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">160</span>:                     <span class="keyword">case</span> OFFSET_ILLEGAL:</div><div class="line"><span class="number">161</span>:                         log.warn(<span class="string">&quot;the pull request offset illegal, {} {}&quot;</span>, <span class="comment">//</span></div><div class="line"><span class="number">162</span>:                             pullRequest.toString(), pullResult.toString());</div><div class="line"><span class="number">163</span>:                         <span class="comment">// &#x8BBE;&#x7F6E;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;</span></div><div class="line"><span class="number">164</span>:                         pullRequest.setNextOffset(pullResult.getNextBeginOffset());</div><div class="line"><span class="number">165</span>: </div><div class="line"><span class="number">166</span>:                         <span class="comment">// &#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x4E3A;dropped</span></div><div class="line"><span class="number">167</span>:                         pullRequest.getProcessQueue().setDropped(<span class="keyword">true</span>);</div><div class="line"><span class="number">168</span>: </div><div class="line"><span class="number">169</span>:                         <span class="comment">// &#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x4EFB;&#x52A1;&#xFF0C;&#x8FDB;&#x884C;&#x6D88;&#x8D39;&#x5904;&#x7406;&#x961F;&#x5217;&#x79FB;&#x9664;&#x3002;&#x4E0D;&#x7ACB;&#x5373;&#x79FB;&#x9664;&#x7684;&#x539F;&#x56E0;&#xFF1A;&#x53EF;&#x80FD;&#x6709;&#x5730;&#x65B9;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#xFF0C;&#x907F;&#x514D;&#x53D7;&#x5230;&#x5F71;&#x54CD;&#x3002;</span></div><div class="line"><span class="number">170</span>:                         DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executeTaskLater(<span class="keyword">new</span> Runnable() {</div><div class="line"><span class="number">171</span>: </div><div class="line"><span class="number">172</span>:                             <span class="meta">@Override</span></div><div class="line"><span class="number">173</span>:                             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">174</span>:                                 <span class="keyword">try</span> {</div><div class="line"><span class="number">175</span>:                                     <span class="comment">// &#x66F4;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#xFF0C;&#x540C;&#x6B65;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x5230;Broker</span></div><div class="line"><span class="number">176</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(),</div><div class="line"><span class="number">177</span>:                                         pullRequest.getNextOffset(), <span class="keyword">false</span>);</div><div class="line"><span class="number">178</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.offsetStore.persist(pullRequest.getMessageQueue());</div><div class="line"><span class="number">179</span>: </div><div class="line"><span class="number">180</span>:                                     <span class="comment">// &#x79FB;&#x9664;&#x6D88;&#x8D39;&#x5904;&#x7406;&#x961F;&#x5217;</span></div><div class="line"><span class="number">181</span>:                                     DefaultMQPushConsumerImpl.<span class="keyword">this</span>.rebalanceImpl.removeProcessQueue(pullRequest.getMessageQueue());</div><div class="line"><span class="number">182</span>: </div><div class="line"><span class="number">183</span>:                                     log.warn(<span class="string">&quot;fix the pull request offset, {}&quot;</span>, pullRequest);</div><div class="line"><span class="number">184</span>:                                 } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"><span class="number">185</span>:                                     log.error(<span class="string">&quot;executeTaskLater Exception&quot;</span>, e);</div><div class="line"><span class="number">186</span>:                                 }</div><div class="line"><span class="number">187</span>:                             }</div><div class="line"><span class="number">188</span>:                         }, <span class="number">10000</span>);</div><div class="line"><span class="number">189</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">190</span>:                     <span class="keyword">default</span>:</div><div class="line"><span class="number">191</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">192</span>:                 }</div><div class="line"><span class="number">193</span>:             }</div><div class="line"><span class="number">194</span>:         }</div><div class="line"><span class="number">195</span>: </div><div class="line"><span class="number">196</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">197</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Throwable e)</span> </span>{</div><div class="line"><span class="number">198</span>:             <span class="keyword">if</span> (!pullRequest.getMessageQueue().getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</div><div class="line"><span class="number">199</span>:                 log.warn(<span class="string">&quot;execute the pull request exception&quot;</span>, e);</div><div class="line"><span class="number">200</span>:             }</div><div class="line"><span class="number">201</span>: </div><div class="line"><span class="number">202</span>:             <span class="comment">// &#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</span></div><div class="line"><span class="number">203</span>:             DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"><span class="number">204</span>:         }</div><div class="line"><span class="number">205</span>:     };</div><div class="line"><span class="number">206</span>: </div><div class="line"><span class="number">207</span>:     <span class="comment">// &#x96C6;&#x7FA4;&#x6D88;&#x606F;&#x6A21;&#x578B;&#x4E0B;&#xFF0C;&#x8BA1;&#x7B97;&#x63D0;&#x4EA4;&#x7684;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;</span></div><div class="line"><span class="number">208</span>:     <span class="keyword">boolean</span> commitOffsetEnable = <span class="keyword">false</span>;</div><div class="line"><span class="number">209</span>:     <span class="keyword">long</span> commitOffsetValue = <span class="number">0L</span>;</div><div class="line"><span class="number">210</span>:     <span class="keyword">if</span> (MessageModel.CLUSTERING == <span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel()) {</div><div class="line"><span class="number">211</span>:         commitOffsetValue = <span class="keyword">this</span>.offsetStore.readOffset(pullRequest.getMessageQueue(), ReadOffsetType.READ_FROM_MEMORY);</div><div class="line"><span class="number">212</span>:         <span class="keyword">if</span> (commitOffsetValue &gt; <span class="number">0</span>) {</div><div class="line"><span class="number">213</span>:             commitOffsetEnable = <span class="keyword">true</span>;</div><div class="line"><span class="number">214</span>:         }</div><div class="line"><span class="number">215</span>:     }</div><div class="line"><span class="number">216</span>: </div><div class="line"><span class="number">217</span>:     <span class="comment">// &#x8BA1;&#x7B97;&#x8BF7;&#x6C42;&#x7684; &#x8BA2;&#x9605;&#x8868;&#x8FBE;&#x5F0F; &#x548C; &#x662F;&#x5426;&#x8FDB;&#x884C;filtersrv&#x8FC7;&#x6EE4;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">218</span>:     String subExpression = <span class="keyword">null</span>;</div><div class="line"><span class="number">219</span>:     <span class="keyword">boolean</span> classFilter = <span class="keyword">false</span>;</div><div class="line"><span class="number">220</span>:     SubscriptionData sd = <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</div><div class="line"><span class="number">221</span>:     <span class="keyword">if</span> (sd != <span class="keyword">null</span>) {</div><div class="line"><span class="number">222</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumer.isPostSubscriptionWhenPull() &amp;&amp; !sd.isClassFilterMode()) {</div><div class="line"><span class="number">223</span>:             subExpression = sd.getSubString();</div><div class="line"><span class="number">224</span>:         }</div><div class="line"><span class="number">225</span>: </div><div class="line"><span class="number">226</span>:         classFilter = sd.isClassFilterMode();</div><div class="line"><span class="number">227</span>:     }</div><div class="line"><span class="number">228</span>: </div><div class="line"><span class="number">229</span>:     <span class="comment">// &#x8BA1;&#x7B97;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x7CFB;&#x7EDF;&#x6807;&#x8BC6;</span></div><div class="line"><span class="number">230</span>:     <span class="keyword">int</span> sysFlag = PullSysFlag.buildSysFlag(<span class="comment">//</span></div><div class="line"><span class="number">231</span>:         commitOffsetEnable, <span class="comment">// commitOffset</span></div><div class="line"><span class="number">232</span>:         <span class="keyword">true</span>, <span class="comment">// suspend</span></div><div class="line"><span class="number">233</span>:         subExpression != <span class="keyword">null</span>, <span class="comment">// subscription</span></div><div class="line"><span class="number">234</span>:         classFilter <span class="comment">// class filter</span></div><div class="line"><span class="number">235</span>:     );</div><div class="line"><span class="number">236</span>: </div><div class="line"><span class="number">237</span>:     <span class="comment">// &#x6267;&#x884C;&#x62C9;&#x53D6;&#x3002;&#x5982;&#x679C;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x53D1;&#x751F;&#x5F02;&#x5E38;&#x65F6;&#xFF0C;&#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</span></div><div class="line"><span class="number">238</span>:     <span class="keyword">try</span> {</div><div class="line"><span class="number">239</span>:         <span class="keyword">this</span>.pullAPIWrapper.pullKernelImpl(<span class="comment">//</span></div><div class="line"><span class="number">240</span>:             pullRequest.getMessageQueue(), <span class="comment">// 1</span></div><div class="line"><span class="number">241</span>:             subExpression, <span class="comment">// 2</span></div><div class="line"><span class="number">242</span>:             subscriptionData.getSubVersion(), <span class="comment">// 3</span></div><div class="line"><span class="number">243</span>:             pullRequest.getNextOffset(), <span class="comment">// 4</span></div><div class="line"><span class="number">244</span>:             <span class="keyword">this</span>.defaultMQPushConsumer.getPullBatchSize(), <span class="comment">// 5</span></div><div class="line"><span class="number">245</span>:             sysFlag, <span class="comment">// 6</span></div><div class="line"><span class="number">246</span>:             commitOffsetValue, <span class="comment">// 7</span></div><div class="line"><span class="number">247</span>:             BROKER_SUSPEND_MAX_TIME_MILLIS, <span class="comment">// 8</span></div><div class="line"><span class="number">248</span>:             CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND, <span class="comment">// 9</span></div><div class="line"><span class="number">249</span>:             CommunicationMode.ASYNC, <span class="comment">// 10</span></div><div class="line"><span class="number">250</span>:             pullCallback<span class="comment">// 11</span></div><div class="line"><span class="number">251</span>:         );</div><div class="line"><span class="number">252</span>:     } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">253</span>:         log.error(<span class="string">&quot;pullKernelImpl exception&quot;</span>, e);</div><div class="line"><span class="number">254</span>:         <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</div><div class="line"><span class="number">255</span>:     }</div><div class="line"><span class="number">256</span>: }</div><div class="line"><span class="number">257</span>: </div><div class="line"><span class="number">258</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">correctTagsOffset</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>{</div><div class="line"><span class="number">259</span>:     <span class="keyword">if</span> (<span class="number">0L</span> == pullRequest.getProcessQueue().getMsgCount().get()) {</div><div class="line"><span class="number">260</span>:         <span class="keyword">this</span>.offsetStore.updateOffset(pullRequest.getMessageQueue(), pullRequest.getNextOffset(), <span class="keyword">true</span>);</div><div class="line"><span class="number">261</span>:     }</div><div class="line"><span class="number">262</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li><code>#pullMessage(...)</code> &#x8BF4;&#x660E; &#xFF1A;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3002;<ul>
<li>&#x7B2C; 3 &#x81F3; 6 &#x884C; &#xFF1A;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x5DF2;&#x7ECF;&#x7EC8;&#x6B62;&#xFF0C;&#x4E0D;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#x3002;</li>
<li>&#x7B2C; 9 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x6700;&#x540E;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x65F6;&#x95F4;&#x3002;</li>
<li>&#x7B2C; 11 &#x81F3; 18 &#x884C; &#xFF1A;<code>Consumer</code> &#x672A;&#x5904;&#x4E8E;&#x8FD0;&#x884C;&#x4E2D;&#x72B6;&#x6001;&#xFF0C;&#x4E0D;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#xFF0C;&#x63D0;&#x4EA4;<strong>&#x5EF6;&#x8FDF;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x7B2C; 20 &#x81F3; 25 &#x884C; &#xFF1A; <code>Consumer</code> &#x5904;&#x4E8E;&#x6682;&#x505C;&#x4E2D;&#xFF0C;&#x4E0D;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#xFF0C;&#x63D0;&#x4EA4;<strong>&#x5EF6;&#x8FDF;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x7B2C; 27 &#x81F3; 37 &#x884C; &#xFF1A;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x6301;&#x6709;&#x6D88;&#x606F;&#x8D85;&#x8FC7;&#x6700;&#x5927;&#x5141;&#x8BB8;&#x503C;&#xFF08;&#x9ED8;&#x8BA4;&#xFF1A;1000&#x6761;&#xFF09;&#xFF0C;&#x4E0D;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#xFF0C;&#x63D0;&#x4EA4;<strong>&#x5EF6;&#x8FDF;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x7B2C; 39 &#x81F3; 49 &#x884C; &#xFF1A;<code>Consumer</code> &#x4E3A;<strong>&#x5E76;&#x53D1;&#x6D88;&#x8D39;</strong> &#x5E76;&#x4E14; &#x6D88;&#x606F;&#x961F;&#x5217;&#x6301;&#x6709;&#x6D88;&#x606F;&#x8DE8;&#x5EA6;&#x8FC7;&#x5927;&#xFF08;&#x6D88;&#x606F;&#x8DE8;&#x5EA6; = &#x6301;&#x6709;&#x6D88;&#x606F;&#x6700;&#x540E;&#x4E00;&#x6761;&#x548C;&#x7B2C;&#x4E00;&#x6761;&#x7684;&#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x5DEE;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;2000&#xFF09;&#xFF0C;&#x4E0D;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#xFF0C;&#x63D0;&#x4EA4;<strong>&#x5EF6;&#x8FDF;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x7B2C; 50 &#x81F3; 70 &#x884C; &#xFF1A;<code>&#x987A;&#x5E8F;&#x6D88;&#x8D39;</code> &#x76F8;&#x5173;&#x8DF3;&#x8FC7;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Message &#x987A;&#x5E8F;&#x53D1;&#x9001;&#x4E0E;&#x6D88;&#x8D39;&#x300B;</a>&#x3002;</li>
<li>&#x7B2C; 72 &#x81F3; 78 &#x884C; &#xFF1A;<code>Topic</code> &#x5BF9;&#x5E94;&#x7684;&#x8BA2;&#x9605;&#x4FE1;&#x606F;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x4E0D;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#xFF0C;&#x63D0;&#x4EA4;<strong>&#x5EF6;&#x8FDF;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x7B2C; 222 &#x81F3; 224 &#x884C; &#xFF1A;&#x5224;&#x65AD;&#x8BF7;&#x6C42;&#x662F;&#x5426;&#x4F7F;&#x7528; <code>Consumer</code> <strong>&#x672C;&#x5730;</strong>&#x7684;&#x8BA2;&#x9605;&#x4FE1;&#x606F;( <code>SubscriptionData</code> )&#xFF0C;&#x800C;&#x4E0D;&#x4F7F;&#x7528; <code>Broker</code> &#x91CC;&#x7684;&#x8BA2;&#x9605;&#x4FE1;&#x606F;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-&#x2026;">PullMessageProcessor#processRequest(&#x2026;) &#x7B2C; 64 &#x81F3; 110 &#x884C;&#x4EE3;&#x7801;</a>&#x3002;</li>
<li>&#x7B2C; 226 &#x884C; &#xFF1A;&#x662F;&#x5426;&#x5F00;&#x542F;&#x8FC7;&#x6EE4;&#x7C7B;&#x8FC7;&#x6EE4;&#x6A21;&#x5F0F;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/filtersrv/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Filtersrv&#x300B;</a>&#x3002;</li>
<li>&#x7B2C; 229 &#x81F3; 235 &#x884C; &#xFF1A;&#x8BA1;&#x7B97;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x7CFB;&#x7EDF;&#x6807;&#x8BC6;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageRequestHeader">PullMessageRequestHeader.sysFlag</a>&#x3002;</li>
<li>&#x7B2C; 237 &#x81F3; 255 &#x884C; &#xFF1A;<ul>
<li>&#x6267;&#x884C;&#x6D88;&#x606F;&#x62C9;&#x53D6;<strong>&#x5F02;&#x6B65;</strong>&#x8BF7;&#x6C42;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#pullapiwrapperpullkernelimpl">PullAPIWrapper#pullKernelImpl(&#x2026;)</a>&#x3002;</li>
<li>&#x5F53;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#x4EA7;&#x751F;&#x5F02;&#x5E38;&#x65F6;&#xFF0C;&#x63D0;&#x4EA4;<strong>&#x5EF6;&#x8FDF;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;&#x5BF9;&#x5E94; <code>Broker</code> &#x5904;&#x7406;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x903B;&#x8F91;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-first/#PullMessageProcessor-processRequest-&#x2026;">PullMessageProcessor#processRequest(&#x2026;)</a>&#x3002;</li>
</ul>
</li>
</ul>
</li>
<li><code>PullCallback</code> &#xFF1A;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x56DE;&#x8C03;&#xFF1A;<ul>
<li>&#x7B2C; 86 &#x884C; &#xFF1A;&#x5904;&#x7406;&#x62C9;&#x53D6;&#x7ED3;&#x679C;&#x3002;&#x8BE6;&#x7EC6;&#x903B;&#x8F91;&#x89C1;&#xFF1A;<a href="#pullapiwrapperprocesspullresult">PullAPIWrapper#processPullResult(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 89 &#x81F3; 192 &#x884C; &#xFF1A;&#x5904;&#x7406;&#x62C9;&#x53D6;&#x72B6;&#x6001;&#x7ED3;&#x679C;&#xFF1A;<ul>
<li>&#x7B2C; 90 &#x81F3; 139 &#x884C; &#xFF1A;&#x62C9;&#x53D6;&#x5230;&#x6D88;&#x606F;( <code>FOUND</code> ) &#xFF1A;<ul>
<li>&#x7B2C; 91 &#x81F3; 93 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x3002;</li>
<li>&#x7B2C; 95 &#x81F3; 97 &#x884C; &#xFF1A;&#x7EDF;&#x8BA1;&#x3002;</li>
<li>&#x7B2C; 101 &#x81F3; 102 &#x884C; &#xFF1A;&#x62C9;&#x53D6;&#x5230;&#x6D88;&#x606F;&#x7684;&#x6D88;&#x606F;&#x5217;&#x8868;&#x4E3A;&#x7A7A;&#xFF0C;&#x63D0;&#x4EA4;<strong>&#x7ACB;&#x5373;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x5B58;&#x5728;&#x62C9;&#x53D6;&#x5230;&#x6D88;&#x606F;&#xFF0C;&#x4F46;&#x662F;&#x6D88;&#x606F;&#x7ED3;&#x679C;&#x672A;&#x7A7A;&#x5462;&#xFF1F;&#x539F;&#x56E0;&#x89C1;&#xFF1A;<a href="#pullapiwrapperprocesspullresult">PullAPIWrapper#processPullResult(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 106 &#x81F3; 108 &#x884C; &#xFF1A;&#x7EDF;&#x8BA1;&#x3002;</li>
<li>&#x7B2C; 111 &#x884C; &#xFF1A;&#x63D0;&#x4EA4;&#x62C9;&#x53D6;&#x5230;&#x7684;&#x6D88;&#x606F;&#x5230;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#processqueueputmessage">ProcessQueue#putMessage(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 113 &#x81F3; 118 &#x884C; &#xFF1A;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#x5230; <code>ConsumeMessageService</code>&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#consumemessageconcurrentlyservice">ConsumeMessageConcurrentlyService</a>&#x3002;</li>
<li>&#x7B2C; 120 &#x81F3; 126 &#x884C; &#xFF1A;&#x6839;&#x636E;&#x62C9;&#x53D6;&#x9891;&#x7387;( <code>pullInterval</code> )&#xFF0C;&#x63D0;&#x4EA4;<strong>&#x7ACB;&#x5373;&#x6216;&#x8005;&#x5EF6;&#x8FDF;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;&#x9ED8;&#x8BA4;&#x62C9;&#x53D6;&#x9891;&#x7387;&#x4E3A; 0ms &#xFF0C;&#x63D0;&#x4EA4;<strong>&#x7ACB;&#x5373;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x7B2C; 129 &#x81F3; 137 &#x884C; &#xFF1A;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x5C0F;&#x4E8E;&#x4E0A;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E; &#x6216;&#x8005; &#x7B2C;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x5C0F;&#x4E8E;&#x4E0A;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#xFF0C;&#x5219;&#x5224;&#x5B9A;&#x4E3A;<strong>BUG</strong>&#xFF0C;&#x8F93;&#x51FA;&#x8B66;&#x544A;&#x65E5;&#x5FD7;&#x3002;<ul>
<li>&#x7B2C; 140 &#x81F3; 149 &#x884C; &#xFF1A;&#x6CA1;&#x6709;&#x65B0;&#x6D88;&#x606F;( <code>NO_NEW_MSG</code> ) &#xFF1A;</li>
</ul>
</li>
<li>&#x7B2C; 142 &#x884C; &#xFF1A; &#x8BBE;&#x7F6E;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x3002;</li>
<li>&#x7B2C; 145 &#x884C; &#xFF1A;&#x66F4;&#x6B63;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<code>#correctTagsOffset(...)</code>&#x3002;</li>
<li>&#x7B2C; 148 &#x884C; &#xFF1A;&#x63D0;&#x4EA4;<strong>&#x7ACB;&#x5373;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;<ul>
<li>&#x7B2C; 150 &#x81F3; 159 &#x884C; &#xFF1A;&#x6709;&#x65B0;&#x6D88;&#x606F;&#x4F46;&#x662F;&#x4E0D;&#x5339;&#x914D;( <code>NO_MATCHED_MSG</code> )&#x3002;&#x903B;&#x8F91;&#x540C; <code>NO_NEW_MSG</code> &#x3002;</li>
<li>&#x7B2C; 160 &#x81F3; 189 &#x884C; &#xFF1A;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x4E0D;&#x5408;&#x6CD5; (<code>OFFSET_ILLEGAL</code>)&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 164 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x3002;</li>
<li>&#x7B2C; 167 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x4E3A; <code>dropped</code>&#x3002;</li>
<li>&#x7B2C; 169 &#x81F3; 188 &#x884C; &#xFF1A;&#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x4EFB;&#x52A1;&#xFF0C;&#x8FDB;&#x884C;&#x961F;&#x5217;&#x79FB;&#x9664;&#x3002;<ul>
<li>&#x7B2C; 175 &#x81F3; 178 &#x884C; &#xFF1A;&#x66F4;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#xFF0C;&#x540C;&#x6B65;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x5230; <code>Broker</code>&#x3002;</li>
<li>&#x7B2C; 181 &#x884C; &#xFF1A;&#x79FB;&#x9664;&#x6D88;&#x8D39;&#x5904;&#x7406;&#x961F;&#x5217;&#x3002;<ul>
<li>&#x7591;&#x95EE;&#xFF1A;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x7ACB;&#x5373;&#x79FB;&#x9664;&#xFF1F;&#xFF1F;&#xFF1F; <ul>
<li>&#x7B2C; 196 &#x81F3; 204 &#x884C; &#xFF1A;&#x53D1;&#x751F;&#x5F02;&#x5E38;&#xFF0C;&#x63D0;&#x4EA4;<strong>&#x5EF6;&#x8FDF;</strong>&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>#correctTagsOffset(...)</code> &#xFF1A;&#x66F4;&#x6B63;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;<ul>
<li>&#x7B2C; 258 &#x81F3; 261 &#x884C; &#xFF1A; &#x5F53;&#x6D88;&#x8D39;&#x5904;&#x7406;&#x961F;&#x5217;&#x6301;&#x6709;&#x6D88;&#x606F;&#x6570;&#x91CF;&#x4E3A; <strong>0</strong> &#x65F6;&#xFF0C;&#x66F4;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x4E3A;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x7684;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;&#x3002;</li>
</ul>
</li>
</ul>
<h3 id="PullAPIWrapper-pullKernelImpl-&#x2026;"><a href="#PullAPIWrapper-pullKernelImpl-&#x2026;" class="headerlink" title="PullAPIWrapper#pullKernelImpl(&#x2026;)"></a>PullAPIWrapper#pullKernelImpl(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * &#x62C9;&#x53D6;&#x6D88;&#x606F;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> mq &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 5:  * <span class="doctag">@param</span> subExpression &#x8BA2;&#x9605;&#x8868;&#x8FBE;&#x5F0F;</div><div class="line"> 6:  * <span class="doctag">@param</span> subVersion &#x8BA2;&#x9605;&#x7248;&#x672C;&#x53F7;</div><div class="line"> 7:  * <span class="doctag">@param</span> offset &#x62C9;&#x53D6;&#x961F;&#x5217;&#x5F00;&#x59CB;&#x4F4D;&#x7F6E;</div><div class="line"> 8:  * <span class="doctag">@param</span> maxNums &#x62C9;&#x53D6;&#x6D88;&#x606F;&#x6570;&#x91CF;</div><div class="line"> 9:  * <span class="doctag">@param</span> sysFlag &#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x7CFB;&#x7EDF;&#x6807;&#x8BC6;</div><div class="line">10:  * <span class="doctag">@param</span> commitOffset &#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</div><div class="line">11:  * <span class="doctag">@param</span> brokerSuspendMaxTimeMillis broker&#x6302;&#x8D77;&#x8BF7;&#x6C42;&#x6700;&#x5927;&#x65F6;&#x95F4;</div><div class="line">12:  * <span class="doctag">@param</span> timeoutMillis &#x8BF7;&#x6C42;broker&#x8D85;&#x65F6;&#x65F6;&#x957F;</div><div class="line">13:  * <span class="doctag">@param</span> communicationMode &#x901A;&#x8BAF;&#x6A21;&#x5F0F;</div><div class="line">14:  * <span class="doctag">@param</span> pullCallback &#x62C9;&#x53D6;&#x56DE;&#x8C03;</div><div class="line">15:  * <span class="doctag">@return</span> &#x62C9;&#x53D6;&#x6D88;&#x606F;&#x7ED3;&#x679C;&#x3002;&#x53EA;&#x6709;&#x901A;&#x8BAF;&#x6A21;&#x5F0F;&#x4E3A;&#x540C;&#x6B65;&#x65F6;&#xFF0C;&#x624D;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#xFF0C;&#x5426;&#x5219;&#x8FD4;&#x56DE;null&#x3002;</div><div class="line">16:  * <span class="doctag">@throws</span> MQClientException &#x5F53;&#x5BFB;&#x627E;&#x4E0D;&#x5230; broker &#x65F6;&#xFF0C;&#x6216;&#x53D1;&#x751F;&#x5176;&#x4ED6;client&#x5F02;&#x5E38;</div><div class="line">17:  * <span class="doctag">@throws</span> RemotingException &#x5F53;&#x8FDC;&#x7A0B;&#x8C03;&#x7528;&#x53D1;&#x751F;&#x5F02;&#x5E38;&#x65F6;</div><div class="line">18:  * <span class="doctag">@throws</span> MQBrokerException &#x5F53; broker &#x53D1;&#x751F;&#x5F02;&#x5E38;&#x65F6;&#x3002;&#x53EA;&#x6709;&#x901A;&#x8BAF;&#x6A21;&#x5F0F;&#x4E3A;&#x540C;&#x6B65;&#x65F6;&#x624D;&#x4F1A;&#x53D1;&#x751F;&#x8BE5;&#x5F02;&#x5E38;&#x3002;</div><div class="line">19:  * <span class="doctag">@throws</span> InterruptedException &#x5F53;&#x53D1;&#x751F;&#x4E2D;&#x65AD;&#x5F02;&#x5E38;&#x65F6;</div><div class="line">20:  */</div><div class="line"><span class="number">21</span>: <span class="function"><span class="keyword">protected</span> PullResult <span class="title">pullKernelImpl</span><span class="params">(</span></span></div><div class="line"><span class="number">22</span>:     <span class="keyword">final</span> MessageQueue mq,</div><div class="line"><span class="number">23</span>:     <span class="keyword">final</span> String subExpression,</div><div class="line"><span class="number">24</span>:     <span class="keyword">final</span> <span class="keyword">long</span> subVersion,</div><div class="line"><span class="number">25</span>:     <span class="keyword">final</span> <span class="keyword">long</span> offset,</div><div class="line"><span class="number">26</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxNums,</div><div class="line"><span class="number">27</span>:     <span class="keyword">final</span> <span class="keyword">int</span> sysFlag,</div><div class="line"><span class="number">28</span>:     <span class="keyword">final</span> <span class="keyword">long</span> commitOffset,</div><div class="line"><span class="number">29</span>:     <span class="keyword">final</span> <span class="keyword">long</span> brokerSuspendMaxTimeMillis,</div><div class="line"><span class="number">30</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</div><div class="line"><span class="number">31</span>:     <span class="keyword">final</span> CommunicationMode communicationMode,</div><div class="line"><span class="number">32</span>:     <span class="keyword">final</span> PullCallback pullCallback</div><div class="line"><span class="number">33</span>: ) <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException {</div><div class="line"><span class="number">34</span>:     <span class="comment">// &#x83B7;&#x53D6;Broker&#x4FE1;&#x606F;</span></div><div class="line"><span class="number">35</span>:     FindBrokerResult findBrokerResult =</div><div class="line"><span class="number">36</span>:         <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class="line"><span class="number">37</span>:             <span class="keyword">this</span>.recalculatePullFromWhichNode(mq), <span class="keyword">false</span>);</div><div class="line"><span class="number">38</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == findBrokerResult) {</div><div class="line"><span class="number">39</span>:         <span class="keyword">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(mq.getTopic());</div><div class="line"><span class="number">40</span>:         findBrokerResult =</div><div class="line"><span class="number">41</span>:             <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(),</div><div class="line"><span class="number">42</span>:                 <span class="keyword">this</span>.recalculatePullFromWhichNode(mq), <span class="keyword">false</span>);</div><div class="line"><span class="number">43</span>:     }</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// &#x8BF7;&#x6C42;&#x62C9;&#x53D6;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">if</span> (findBrokerResult != <span class="keyword">null</span>) {</div><div class="line"><span class="number">47</span>:         <span class="keyword">int</span> sysFlagInner = sysFlag;</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:         <span class="keyword">if</span> (findBrokerResult.isSlave()) {</div><div class="line"><span class="number">50</span>:             sysFlagInner = PullSysFlag.clearCommitOffsetFlag(sysFlagInner);</div><div class="line"><span class="number">51</span>:         }</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:         PullMessageRequestHeader requestHeader = <span class="keyword">new</span> PullMessageRequestHeader();</div><div class="line"><span class="number">54</span>:         requestHeader.setConsumerGroup(<span class="keyword">this</span>.consumerGroup);</div><div class="line"><span class="number">55</span>:         requestHeader.setTopic(mq.getTopic());</div><div class="line"><span class="number">56</span>:         requestHeader.setQueueId(mq.getQueueId());</div><div class="line"><span class="number">57</span>:         requestHeader.setQueueOffset(offset);</div><div class="line"><span class="number">58</span>:         requestHeader.setMaxMsgNums(maxNums);</div><div class="line"><span class="number">59</span>:         requestHeader.setSysFlag(sysFlagInner);</div><div class="line"><span class="number">60</span>:         requestHeader.setCommitOffset(commitOffset);</div><div class="line"><span class="number">61</span>:         requestHeader.setSuspendTimeoutMillis(brokerSuspendMaxTimeMillis);</div><div class="line"><span class="number">62</span>:         requestHeader.setSubscription(subExpression);</div><div class="line"><span class="number">63</span>:         requestHeader.setSubVersion(subVersion);</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:         String brokerAddr = findBrokerResult.getBrokerAddr();</div><div class="line"><span class="number">66</span>:         <span class="keyword">if</span> (PullSysFlag.hasClassFilterFlag(sysFlagInner)) { <span class="comment">// TODO filtersrv</span></div><div class="line"><span class="number">67</span>:             brokerAddr = computPullFromWhichFilterServer(mq.getTopic(), brokerAddr);</div><div class="line"><span class="number">68</span>:         }</div><div class="line"><span class="number">69</span>: </div><div class="line"><span class="number">70</span>:         PullResult pullResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().pullMessage(</div><div class="line"><span class="number">71</span>:             brokerAddr,</div><div class="line"><span class="number">72</span>:             requestHeader,</div><div class="line"><span class="number">73</span>:             timeoutMillis,</div><div class="line"><span class="number">74</span>:             communicationMode,</div><div class="line"><span class="number">75</span>:             pullCallback);</div><div class="line"><span class="number">76</span>: </div><div class="line"><span class="number">77</span>:         <span class="keyword">return</span> pullResult;</div><div class="line"><span class="number">78</span>:     }</div><div class="line"><span class="number">79</span>: </div><div class="line"><span class="number">80</span>:     <span class="comment">// Broker&#x4FE1;&#x606F;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span></div><div class="line"><span class="number">81</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">&quot;The broker[&quot;</span> + mq.getBrokerName() + <span class="string">&quot;] not exist&quot;</span>, <span class="keyword">null</span>);</div><div class="line"><span class="number">82</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;&#x3002;<strong>&#x8BE5;&#x65B9;&#x6CD5;&#x53C2;&#x6570;&#x8F83;&#x591A;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x4E0B;&#x4EE3;&#x7801;&#x6CE8;&#x91CA;&#x4E0A;&#x6BCF;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x8BF4;&#x660E;</strong>&#x1F608;&#x3002;</li>
<li>&#x7B2C; 34 &#x81F3; 43 &#x884C; &#xFF1A;&#x83B7;&#x53D6; <code>Broker</code> &#x4FE1;&#x606F;(<code>Broker</code> &#x5730;&#x5740;&#x3001;&#x662F;&#x5426;&#x4E3A;&#x4ECE;&#x8282;&#x70B9;)&#x3002;<ul>
<li><a href="#pullapiwrapperrecalculatepullfromwhichnode">#recalculatePullFromWhichNode(&#x2026;)</a></li>
<li><a href="#mqclientinstancefindbrokeraddressinsubscribe">#MQClientInstance#findBrokerAddressInSubscribe(&#x2026;)</a></li>
</ul>
</li>
<li>&#x7B2C; 45 &#x81F3; 78 &#x884C; &#xFF1A;<strong>&#x8BF7;&#x6C42;&#x62C9;&#x53D6;&#x6D88;&#x606F;</strong>&#x3002;</li>
<li>&#x7B2C; 81 &#x884C; &#xFF1A;&#x5F53; <code>Broker</code> &#x4FE1;&#x606F;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x3002;</li>
</ul>
<h4 id="PullAPIWrapper-recalculatePullFromWhichNode-&#x2026;"><a href="#PullAPIWrapper-recalculatePullFromWhichNode-&#x2026;" class="headerlink" title="PullAPIWrapper#recalculatePullFromWhichNode(&#x2026;)"></a>PullAPIWrapper#recalculatePullFromWhichNode(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * &#x6D88;&#x606F;&#x961F;&#x5217; &#x4E0E; &#x62C9;&#x53D6;Broker &#x7684;&#x6620;&#x5C04;</div><div class="line"> 3:  * &#x5F53;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x65F6;&#xFF0C;&#x4F1A;&#x901A;&#x8FC7;&#x8BE5;&#x6620;&#x5C04;&#x83B7;&#x53D6;&#x62C9;&#x53D6;&#x8BF7;&#x6C42;&#x5BF9;&#x5E94;&#x7684;Broker</div><div class="line"> 4:  */</div><div class="line"> <span class="number">5</span>: <span class="keyword">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong<span class="comment">/* brokerId */</span>&gt; pullFromWhichNodeTable =</div><div class="line"> <span class="number">6</span>:     <span class="keyword">new</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt;(<span class="number">32</span>);</div><div class="line"> <span class="number">7</span>: <span class="comment">/**</span></div><div class="line"> 8:  * &#x662F;&#x5426;&#x4F7F;&#x7528;&#x9ED8;&#x8BA4;Broker</div><div class="line"> 9:  */</div><div class="line"><span class="number">10</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> connectBrokerByUser = <span class="keyword">false</span>;</div><div class="line"><span class="number">11</span>: <span class="comment">/**</span></div><div class="line">12:  * &#x9ED8;&#x8BA4;Broker&#x7F16;&#x53F7;</div><div class="line">13:  */</div><div class="line"><span class="number">14</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> defaultBrokerId = MixAll.MASTER_ID;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="comment">/**</span></div><div class="line">17:  * &#x8BA1;&#x7B97;&#x6D88;&#x606F;&#x961F;&#x5217;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x5BF9;&#x5E94;&#x7684;Broker&#x7F16;&#x53F7;</div><div class="line">18:  *</div><div class="line">19:  * <span class="doctag">@param</span> mq &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line">20:  * <span class="doctag">@return</span> Broker&#x7F16;&#x53F7;</div><div class="line">21:  */</div><div class="line"><span class="number">22</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">recalculatePullFromWhichNode</span><span class="params">(<span class="keyword">final</span> MessageQueue mq)</span> </span>{</div><div class="line"><span class="number">23</span>:     <span class="comment">// &#x82E5;&#x5F00;&#x542F;&#x9ED8;&#x8BA4;Broker&#x5F00;&#x5173;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x9ED8;&#x8BA4;Broker&#x7F16;&#x53F7;</span></div><div class="line"><span class="number">24</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.isConnectBrokerByUser()) {</div><div class="line"><span class="number">25</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.defaultBrokerId;</div><div class="line"><span class="number">26</span>:     }</div><div class="line"><span class="number">27</span>: </div><div class="line"><span class="number">28</span>:     <span class="comment">// &#x82E5;&#x6D88;&#x606F;&#x961F;&#x5217;&#x6620;&#x5C04;&#x62C9;&#x53D6;Broker&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x6620;&#x5C04;Broker&#x7F16;&#x53F7;</span></div><div class="line"><span class="number">29</span>:     AtomicLong suggest = <span class="keyword">this</span>.pullFromWhichNodeTable.get(mq);</div><div class="line"><span class="number">30</span>:     <span class="keyword">if</span> (suggest != <span class="keyword">null</span>) {</div><div class="line"><span class="number">31</span>:         <span class="keyword">return</span> suggest.get();</div><div class="line"><span class="number">32</span>:     }</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">// &#x8FD4;&#x56DE;Broker&#x4E3B;&#x8282;&#x70B9;&#x7F16;&#x53F7;</span></div><div class="line"><span class="number">35</span>:     <span class="keyword">return</span> MixAll.MASTER_ID;</div><div class="line"><span class="number">36</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x8BA1;&#x7B97;&#x6D88;&#x606F;&#x961F;&#x5217;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x5BF9;&#x5E94;&#x7684; <code>Broker</code> &#x7F16;&#x53F7;&#x3002;</li>
</ul>
<h4 id="MQClientInstance-findBrokerAddressInSubscribe-&#x2026;"><a href="#MQClientInstance-findBrokerAddressInSubscribe-&#x2026;" class="headerlink" title="MQClientInstance#findBrokerAddressInSubscribe(&#x2026;)"></a>MQClientInstance#findBrokerAddressInSubscribe(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * Broker&#x540D;&#x5B57; &#x548C; Broker&#x5730;&#x5740;&#x76F8;&#x5173; Map</div><div class="line"> 3:  */</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String<span class="comment">/* Broker Name */</span>, HashMap&lt;Long<span class="comment">/* brokerId */</span>, String<span class="comment">/* address */</span>&gt;&gt; brokerAddrTable =</div><div class="line"> <span class="number">5</span>:         <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>: <span class="comment">/**</span></div><div class="line"> 8:  * &#x83B7;&#x5F97;Broker&#x4FE1;&#x606F;</div><div class="line"> 9:  *</div><div class="line">10:  * <span class="doctag">@param</span> brokerName broker&#x540D;&#x5B57;</div><div class="line">11:  * <span class="doctag">@param</span> brokerId broker&#x7F16;&#x53F7;</div><div class="line">12:  * <span class="doctag">@param</span> onlyThisBroker &#x662F;&#x5426;&#x5FC5;&#x987B;&#x662F;&#x8BE5;broker</div><div class="line">13:  * <span class="doctag">@return</span> Broker&#x4FE1;&#x606F;</div><div class="line">14:  */</div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">public</span> FindBrokerResult <span class="title">findBrokerAddressInSubscribe</span><span class="params">(//</span></span></div><div class="line"><span class="number">16</span>:     <span class="keyword">final</span> String brokerName, //</div><div class="line"><span class="number">17</span>:     <span class="keyword">final</span> <span class="keyword">long</span> brokerId, //</div><div class="line"><span class="number">18</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> onlyThisBroker//</div><div class="line"><span class="number">19</span>: ) {</div><div class="line"><span class="number">20</span>:     String brokerAddr = <span class="keyword">null</span>; <span class="comment">// broker&#x5730;&#x5740;</span></div><div class="line"><span class="number">21</span>:     <span class="keyword">boolean</span> slave = <span class="keyword">false</span>; <span class="comment">// &#x662F;&#x5426;&#x4E3A;&#x4ECE;&#x8282;&#x70B9;</span></div><div class="line"><span class="number">22</span>:     <span class="keyword">boolean</span> found = <span class="keyword">false</span>; <span class="comment">// &#x662F;&#x5426;&#x627E;&#x5230;</span></div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:     <span class="comment">// &#x83B7;&#x5F97;Broker&#x4FE1;&#x606F;</span></div><div class="line"><span class="number">25</span>:     HashMap&lt;Long<span class="comment">/* brokerId */</span>, String<span class="comment">/* address */</span>&gt; map = <span class="keyword">this</span>.brokerAddrTable.get(brokerName);</div><div class="line"><span class="number">26</span>:     <span class="keyword">if</span> (map != <span class="keyword">null</span> &amp;&amp; !map.isEmpty()) {</div><div class="line"><span class="number">27</span>:         brokerAddr = map.get(brokerId);</div><div class="line"><span class="number">28</span>:         slave = brokerId != MixAll.MASTER_ID;</div><div class="line"><span class="number">29</span>:         found = brokerAddr != <span class="keyword">null</span>;</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:         <span class="comment">// &#x5982;&#x679C;&#x4E0D;&#x5F3A;&#x5236;&#x83B7;&#x5F97;&#xFF0C;&#x9009;&#x62E9;&#x4E00;&#x4E2A;Broker</span></div><div class="line"><span class="number">32</span>:         <span class="keyword">if</span> (!found &amp;&amp; !onlyThisBroker) {</div><div class="line"><span class="number">33</span>:             Entry&lt;Long, String&gt; entry = map.entrySet().iterator().next();</div><div class="line"><span class="number">34</span>:             brokerAddr = entry.getValue();</div><div class="line"><span class="number">35</span>:             slave = entry.getKey() != MixAll.MASTER_ID;</div><div class="line"><span class="number">36</span>:             found = <span class="keyword">true</span>;</div><div class="line"><span class="number">37</span>:         }</div><div class="line"><span class="number">38</span>:     }</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:     <span class="comment">// &#x627E;&#x5230;broker&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x4FE1;&#x606F;</span></div><div class="line"><span class="number">41</span>:     <span class="keyword">if</span> (found) {</div><div class="line"><span class="number">42</span>:         <span class="keyword">return</span> <span class="keyword">new</span> FindBrokerResult(brokerAddr, slave);</div><div class="line"><span class="number">43</span>:     }</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="comment">// &#x627E;&#x4E0D;&#x5230;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x7A7A;</span></div><div class="line"><span class="number">46</span>:     <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">47</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x83B7;&#x53D6; <code>Broker</code> &#x4FE1;&#x606F;(<code>Broker</code> &#x5730;&#x5740;&#x3001;&#x662F;&#x5426;&#x4E3A;&#x4ECE;&#x8282;&#x70B9;)&#x3002;</li>
</ul>
<h3 id="PullAPIWrapper-processPullResult-&#x2026;"><a href="#PullAPIWrapper-processPullResult-&#x2026;" class="headerlink" title="PullAPIWrapper#processPullResult(&#x2026;)"></a>PullAPIWrapper#processPullResult(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * &#x5904;&#x7406;&#x62C9;&#x53D6;&#x7ED3;&#x679C;</div><div class="line"> 3:  * 1. &#x66F4;&#x65B0;&#x6D88;&#x606F;&#x961F;&#x5217;&#x62C9;&#x53D6;&#x6D88;&#x606F;Broker&#x7F16;&#x53F7;&#x7684;&#x6620;&#x5C04;</div><div class="line"> 4:  * 2. &#x89E3;&#x6790;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x8BA2;&#x9605;&#x4FE1;&#x606F;&#x6D88;&#x606F;tagCode&#x5339;&#x914D;&#x5408;&#x9002;&#x6D88;&#x606F;</div><div class="line"> 5:  *</div><div class="line"> 6:  * <span class="doctag">@param</span> mq &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 7:  * <span class="doctag">@param</span> pullResult &#x62C9;&#x53D6;&#x7ED3;&#x679C;</div><div class="line"> 8:  * <span class="doctag">@param</span> subscriptionData &#x8BA2;&#x9605;&#x4FE1;&#x606F;</div><div class="line"> 9:  * <span class="doctag">@return</span> &#x62C9;&#x53D6;&#x7ED3;&#x679C;</div><div class="line">10:  */</div><div class="line"><span class="number">11</span>: <span class="function"><span class="keyword">public</span> PullResult <span class="title">processPullResult</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> PullResult pullResult,</span></span></div><div class="line"><span class="number">12</span>:     <span class="keyword">final</span> SubscriptionData subscriptionData) {</div><div class="line"><span class="number">13</span>:     PullResultExt pullResultExt = (PullResultExt) pullResult;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="comment">// &#x66F4;&#x65B0;&#x6D88;&#x606F;&#x961F;&#x5217;&#x62C9;&#x53D6;&#x6D88;&#x606F;Broker&#x7F16;&#x53F7;&#x7684;&#x6620;&#x5C04;</span></div><div class="line"><span class="number">16</span>:     <span class="keyword">this</span>.updatePullFromWhichNode(mq, pullResultExt.getSuggestWhichBrokerId());</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:     <span class="comment">// &#x89E3;&#x6790;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x8BA2;&#x9605;&#x4FE1;&#x606F;&#x6D88;&#x606F;tagCode&#x5339;&#x914D;&#x5408;&#x9002;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">19</span>:     <span class="keyword">if</span> (PullStatus.FOUND == pullResult.getPullStatus()) {</div><div class="line"><span class="number">20</span>:         <span class="comment">// &#x89E3;&#x6790;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">21</span>:         ByteBuffer byteBuffer = ByteBuffer.wrap(pullResultExt.getMessageBinary());</div><div class="line"><span class="number">22</span>:         List&lt;MessageExt&gt; msgList = MessageDecoder.decodes(byteBuffer);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:         <span class="comment">// &#x6839;&#x636E;&#x8BA2;&#x9605;&#x4FE1;&#x606F;&#x6D88;&#x606F;tagCode&#x5339;&#x914D;&#x5408;&#x9002;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">25</span>:         List&lt;MessageExt&gt; msgListFilterAgain = msgList;</div><div class="line"><span class="number">26</span>:         <span class="keyword">if</span> (!subscriptionData.getTagsSet().isEmpty() &amp;&amp; !subscriptionData.isClassFilterMode()) {</div><div class="line"><span class="number">27</span>:             msgListFilterAgain = <span class="keyword">new</span> ArrayList&lt;&gt;(msgList.size());</div><div class="line"><span class="number">28</span>:             <span class="keyword">for</span> (MessageExt msg : msgList) {</div><div class="line"><span class="number">29</span>:                 <span class="keyword">if</span> (msg.getTags() != <span class="keyword">null</span>) {</div><div class="line"><span class="number">30</span>:                     <span class="keyword">if</span> (subscriptionData.getTagsSet().contains(msg.getTags())) {</div><div class="line"><span class="number">31</span>:                         msgListFilterAgain.add(msg);</div><div class="line"><span class="number">32</span>:                     }</div><div class="line"><span class="number">33</span>:                 }</div><div class="line"><span class="number">34</span>:             }</div><div class="line"><span class="number">35</span>:         }</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:         <span class="comment">// Hook</span></div><div class="line"><span class="number">38</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.hasHook()) {</div><div class="line"><span class="number">39</span>:             FilterMessageContext filterMessageContext = <span class="keyword">new</span> FilterMessageContext();</div><div class="line"><span class="number">40</span>:             filterMessageContext.setUnitMode(unitMode);</div><div class="line"><span class="number">41</span>:             filterMessageContext.setMsgList(msgListFilterAgain);</div><div class="line"><span class="number">42</span>:             <span class="keyword">this</span>.executeHook(filterMessageContext);</div><div class="line"><span class="number">43</span>:         }</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:         <span class="comment">// &#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x961F;&#x5217;&#x5F53;&#x524D;&#x6700;&#x5C0F;/&#x6700;&#x5927;&#x4F4D;&#x7F6E;&#x5230;&#x6D88;&#x606F;&#x62D3;&#x5C55;&#x5B57;&#x6BB5;</span></div><div class="line"><span class="number">46</span>:         <span class="keyword">for</span> (MessageExt msg : msgListFilterAgain) {</div><div class="line"><span class="number">47</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MIN_OFFSET,</div><div class="line"><span class="number">48</span>:                 Long.toString(pullResult.getMinOffset()));</div><div class="line"><span class="number">49</span>:             MessageAccessor.putProperty(msg, MessageConst.PROPERTY_MAX_OFFSET,</div><div class="line"><span class="number">50</span>:                 Long.toString(pullResult.getMaxOffset()));</div><div class="line"><span class="number">51</span>:         }</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:         <span class="comment">// &#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x5217;&#x8868;</span></div><div class="line"><span class="number">54</span>:         pullResultExt.setMsgFoundList(msgListFilterAgain);</div><div class="line"><span class="number">55</span>:     }</div><div class="line"><span class="number">56</span>: </div><div class="line"><span class="number">57</span>:     <span class="comment">// &#x6E05;&#x7A7A;&#x6D88;&#x606F;&#x4E8C;&#x8FDB;&#x5236;&#x6570;&#x7EC4;</span></div><div class="line"><span class="number">58</span>:     pullResultExt.setMessageBinary(<span class="keyword">null</span>);</div><div class="line"><span class="number">59</span>: </div><div class="line"><span class="number">60</span>:     <span class="keyword">return</span> pullResult;</div><div class="line"><span class="number">61</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x5904;&#x7406;&#x62C9;&#x53D6;&#x7ED3;&#x679C;&#x3002;<ul>
<li>&#x66F4;&#x65B0;&#x6D88;&#x606F;&#x961F;&#x5217;&#x62C9;&#x53D6;&#x6D88;&#x606F; <code>Broker</code> &#x7F16;&#x53F7;&#x7684;&#x6620;&#x5C04;&#x3002;</li>
<li>&#x89E3;&#x6790;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x8BA2;&#x9605;&#x4FE1;&#x606F;&#x6D88;&#x606F; <code>tagCode</code>&#x5339;&#x914D;&#x5408;&#x9002;&#x6D88;&#x606F;&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 16 &#x884C; &#xFF1A;&#x66F4;&#x65B0;&#x6D88;&#x606F;&#x961F;&#x5217;&#x62C9;&#x53D6;&#x6D88;&#x606F; <code>Broker</code> &#x7F16;&#x53F7;&#x7684;&#x6620;&#x5C04;&#x3002;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#x9ED8;&#x8BA4;&#x62C9;&#x53D6;&#x7684; <code>Broker</code> &#x7F16;&#x53F7;&#xFF0C;&#x4F1A;&#x4F7F;&#x7528;&#x66F4;&#x65B0;&#x540E;&#x7684; <code>Broker</code> &#x7F16;&#x53F7;&#x3002;</li>
<li>&#x7B2C; 18 &#x81F3; 55 &#x884C; &#xFF1A;&#x89E3;&#x6790;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x8BA2;&#x9605;&#x4FE1;&#x606F;&#x6D88;&#x606F; <code>tagCode</code> &#x5339;&#x914D;&#x5408;&#x9002;&#x6D88;&#x606F;&#x3002;<ul>
<li>&#x7B2C; 20 &#x81F3; 22 &#x884C; &#xFF1A;&#x89E3;&#x6790;&#x6D88;&#x606F;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/message/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Message&#x57FA;&#x7840;&#x300B;</a> &#x3002;</li>
<li>&#x7B2C; 24 &#x81F3; 35 &#x884C; &#xFF1A;&#x6839;&#x636E;&#x8BA2;&#x9605;&#x4FE1;&#x606F;<code>tagCode</code> &#x5339;&#x914D;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 37 &#x81F3; 43 &#x884C; &#xFF1A;<code>Hook</code>&#x3002;</li>
<li>&#x7B2C; 45 &#x81F3; 51 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x961F;&#x5217;&#x5F53;&#x524D;&#x6700;&#x5C0F;/&#x6700;&#x5927;&#x4F4D;&#x7F6E;&#x5230;&#x6D88;&#x606F;&#x62D3;&#x5C55;&#x5B57;&#x6BB5;&#x3002;</li>
<li>&#x7B2C; 54 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
</ul>
</li>
<li>&#x7B2C; 58 &#x884C; &#xFF1A;&#x6E05;&#x7A7A;&#x6D88;&#x606F;&#x4E8C;&#x8FDB;&#x5236;&#x6570;&#x7EC4;&#x3002;</li>
</ul>
<h3 id="ProcessQueue-putMessage-&#x2026;"><a href="#ProcessQueue-putMessage-&#x2026;" class="headerlink" title="ProcessQueue#putMessage(&#x2026;)"></a>ProcessQueue#putMessage(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>:  <span class="comment">/**</span></div><div class="line"> 2:  * &#x6D88;&#x606F;&#x6620;&#x5C04;&#x8BFB;&#x5199;&#x9501;</div><div class="line"> 3:  */</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lockTreeMap = <span class="keyword">new</span> ReentrantReadWriteLock();</div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"> 6:  * &#x6D88;&#x606F;&#x6620;&#x5C04;</div><div class="line"> 7:  * key&#xFF1A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;</div><div class="line"> 8:  */</div><div class="line"> <span class="number">9</span>: <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line"><span class="number">10</span>: <span class="comment">/**</span></div><div class="line">11:  * &#x6D88;&#x606F;&#x6570;</div><div class="line">12:  */</div><div class="line"><span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong msgCount = <span class="keyword">new</span> AtomicLong();</div><div class="line"><span class="number">14</span>: <span class="comment">/**</span></div><div class="line">15:  * &#x6DFB;&#x52A0;&#x6D88;&#x606F;&#x6700;&#x5927;&#x961F;&#x5217;&#x4F4D;&#x7F6E;</div><div class="line">16:  */</div><div class="line"><span class="number">17</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> queueOffsetMax = <span class="number">0L</span>;</div><div class="line"><span class="number">18</span>: <span class="comment">/**</span></div><div class="line">19:  * &#x662F;&#x5426;&#x6B63;&#x5728;&#x6D88;&#x8D39;</div><div class="line">20:  */</div><div class="line"><span class="number">21</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> consuming = <span class="keyword">false</span>;</div><div class="line"><span class="number">22</span>: <span class="comment">/**</span></div><div class="line">23:  * Broker&#x7D2F;&#x8BA1;&#x6D88;&#x606F;&#x6570;&#x91CF;</div><div class="line">24:  * &#x8BA1;&#x7B97;&#x516C;&#x5F0F; = queueMaxOffset - &#x65B0;&#x6DFB;&#x52A0;&#x6D88;&#x606F;&#x6570;&#x7EC4;[n - 1].queueOffset</div><div class="line">25:  * Acc = Accumulation</div><div class="line">26:  * cnt = &#xFF08;&#x731C;&#x6D4B;&#xFF09;&#x5BF9;&#x6BD4;&#x5EA6;</div><div class="line">27:  */</div><div class="line"><span class="number">28</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> msgAccCnt = <span class="number">0</span>;</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>: <span class="comment">/**</span></div><div class="line">31:  * &#x6DFB;&#x52A0;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x662F;&#x5426;&#x63D0;&#x4EA4;&#x7ED9;&#x6D88;&#x8D39;&#x8005;</div><div class="line">32:  * &#x8FD4;&#x56DE;true&#xFF0C;&#x5F53;&#x6709;&#x65B0;&#x6D88;&#x606F;&#x6DFB;&#x52A0;&#x6210;&#x529F;&#x65F6;&#xFF0C;</div><div class="line">33:  *</div><div class="line">34:  * <span class="doctag">@param</span> msgs &#x6D88;&#x606F;</div><div class="line">35:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x63D0;&#x4EA4;&#x7ED9;&#x6D88;&#x8D39;&#x8005;</div><div class="line">36:  */</div><div class="line"><span class="number">37</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">putMessage</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs)</span> </span>{</div><div class="line"><span class="number">38</span>:     <span class="keyword">boolean</span> dispatchToConsume = <span class="keyword">false</span>;</div><div class="line"><span class="number">39</span>:     <span class="keyword">try</span> {</div><div class="line"><span class="number">40</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">41</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">42</span>:             <span class="comment">// &#x6DFB;&#x52A0;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">43</span>:             <span class="keyword">int</span> validMsgCnt = <span class="number">0</span>;</div><div class="line"><span class="number">44</span>:             <span class="keyword">for</span> (MessageExt msg : msgs) {</div><div class="line"><span class="number">45</span>:                 MessageExt old = msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class="line"><span class="number">46</span>:                 <span class="keyword">if</span> (<span class="keyword">null</span> == old) {</div><div class="line"><span class="number">47</span>:                     validMsgCnt++;</div><div class="line"><span class="number">48</span>:                     <span class="keyword">this</span>.queueOffsetMax = msg.getQueueOffset();</div><div class="line"><span class="number">49</span>:                 }</div><div class="line"><span class="number">50</span>:             }</div><div class="line"><span class="number">51</span>:             msgCount.addAndGet(validMsgCnt);</div><div class="line"><span class="number">52</span>: </div><div class="line"><span class="number">53</span>:             <span class="comment">// &#x8BA1;&#x7B97;&#x662F;&#x5426;&#x6B63;&#x5728;&#x6D88;&#x8D39;</span></div><div class="line"><span class="number">54</span>:             <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; !<span class="keyword">this</span>.consuming) {</div><div class="line"><span class="number">55</span>:                 dispatchToConsume = <span class="keyword">true</span>;</div><div class="line"><span class="number">56</span>:                 <span class="keyword">this</span>.consuming = <span class="keyword">true</span>;</div><div class="line"><span class="number">57</span>:             }</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>:             <span class="comment">// Broker&#x7D2F;&#x8BA1;&#x6D88;&#x606F;&#x6570;&#x91CF;</span></div><div class="line"><span class="number">60</span>:             <span class="keyword">if</span> (!msgs.isEmpty()) {</div><div class="line"><span class="number">61</span>:                 MessageExt messageExt = msgs.get(msgs.size() - <span class="number">1</span>);</div><div class="line"><span class="number">62</span>:                 String property = messageExt.getProperty(MessageConst.PROPERTY_MAX_OFFSET);</div><div class="line"><span class="number">63</span>:                 <span class="keyword">if</span> (property != <span class="keyword">null</span>) {</div><div class="line"><span class="number">64</span>:                     <span class="keyword">long</span> accTotal = Long.parseLong(property) - messageExt.getQueueOffset();</div><div class="line"><span class="number">65</span>:                     <span class="keyword">if</span> (accTotal &gt; <span class="number">0</span>) {</div><div class="line"><span class="number">66</span>:                         <span class="keyword">this</span>.msgAccCnt = accTotal;</div><div class="line"><span class="number">67</span>:                     }</div><div class="line"><span class="number">68</span>:                 }</div><div class="line"><span class="number">69</span>:             }</div><div class="line"><span class="number">70</span>:         } <span class="keyword">finally</span> {</div><div class="line"><span class="number">71</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">72</span>:         }</div><div class="line"><span class="number">73</span>:     } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"><span class="number">74</span>:         log.error(<span class="string">&quot;putMessage exception&quot;</span>, e);</div><div class="line"><span class="number">75</span>:     }</div><div class="line"><span class="number">76</span>: </div><div class="line"><span class="number">77</span>:     <span class="keyword">return</span> dispatchToConsume;</div><div class="line"><span class="number">78</span>: }</div></pre></td></tr></table></figure>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>&#x5982;&#x679C;&#x7528;&#x6700;&#x7B80;&#x5355;&#x7C97;&#x66B4;&#x7684;&#x65B9;&#x5F0F;&#x63CF;&#x8FF0; <code>PullConsumer</code> &#x62C9;&#x53D6;&#x6D88;&#x606F;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x90A3;&#x5C31;&#x662F;&#x5982;&#x4E0B;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">    <span class="keyword">if</span> (&#x4E0D;&#x6EE1;&#x8DB3;&#x62C9;&#x53D6;&#x6D88;&#x606F;) {</div><div class="line">        Thread.sleep(&#x95F4;&#x9694;);</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    }</div><div class="line">    &#x4E3B;&#x52A8;&#x62C9;&#x53D6;&#x6D88;&#x606F;();</div><div class="line">}</div></pre></td></tr></table></figure>
<h1 id="6&#x3001;PushConsumer-&#x6D88;&#x8D39;&#x6D88;&#x606F;"><a href="#6&#x3001;PushConsumer-&#x6D88;&#x8D39;&#x6D88;&#x606F;" class="headerlink" title="6&#x3001;PushConsumer &#x6D88;&#x8D39;&#x6D88;&#x606F;"></a>6&#x3001;PushConsumer &#x6D88;&#x8D39;&#x6D88;&#x606F;</h1><p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/06.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/06.png" alt="DefaultMQPushConsumerImpl&#x6D88;&#x8D39;&#x6D88;&#x606F;" class="ui centered image"></a></p>
<h2 id="ConsumeMessageConcurrentlyService-&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;"><a href="#ConsumeMessageConcurrentlyService-&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;" class="headerlink" title="ConsumeMessageConcurrentlyService &#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;"></a>ConsumeMessageConcurrentlyService &#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</h2><h3 id="ConsumeMessageConcurrentlyService-submitConsumeRequest-&#x2026;"><a href="#ConsumeMessageConcurrentlyService-submitConsumeRequest-&#x2026;" class="headerlink" title="ConsumeMessageConcurrentlyService#submitConsumeRequest(&#x2026;)"></a>ConsumeMessageConcurrentlyService#submitConsumeRequest(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * &#x6D88;&#x8D39;&#x7EBF;&#x7A0B;&#x6C60;&#x961F;&#x5217;</div><div class="line"> 3:  */</div><div class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; consumeRequestQueue;</div><div class="line"> <span class="number">5</span>: <span class="comment">/**</span></div><div class="line"> 6:  * &#x6D88;&#x8D39;&#x7EBF;&#x7A0B;&#x6C60;</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor consumeExecutor;</div><div class="line"> <span class="number">9</span>: </div><div class="line"><span class="number">10</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitConsumeRequest</span><span class="params">(//</span></span></div><div class="line"><span class="number">11</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</div><div class="line"><span class="number">12</span>:     <span class="keyword">final</span> ProcessQueue processQueue, //</div><div class="line"><span class="number">13</span>:     <span class="keyword">final</span> MessageQueue messageQueue, //</div><div class="line"><span class="number">14</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> dispatchToConsume) {</div><div class="line"><span class="number">15</span>:     <span class="keyword">final</span> <span class="keyword">int</span> consumeBatchSize = <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class="line"><span class="number">16</span>:     <span class="keyword">if</span> (msgs.size() &lt;= consumeBatchSize) { <span class="comment">// &#x63D0;&#x4EA4;&#x6D88;&#x606F;&#x5C0F;&#x4E8E;&#x6279;&#x91CF;&#x6D88;&#x606F;&#x6570;&#xFF0C;&#x76F4;&#x63A5;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</span></div><div class="line"><span class="number">17</span>:         ConsumeRequest consumeRequest = <span class="keyword">new</span> ConsumeRequest(msgs, processQueue, messageQueue);</div><div class="line"><span class="number">18</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">19</span>:             <span class="keyword">this</span>.consumeExecutor.submit(consumeRequest);</div><div class="line"><span class="number">20</span>:         } <span class="keyword">catch</span> (RejectedExecutionException e) {</div><div class="line"><span class="number">21</span>:             <span class="keyword">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class="line"><span class="number">22</span>:         }</div><div class="line"><span class="number">23</span>:     } <span class="keyword">else</span> { <span class="comment">// &#x63D0;&#x4EA4;&#x6D88;&#x606F;&#x5927;&#x4E8E;&#x6279;&#x91CF;&#x6D88;&#x606F;&#x6570;&#xFF0C;&#x8FDB;&#x884C;&#x5206;&#x62C6;&#x6210;&#x591A;&#x4E2A;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</span></div><div class="line"><span class="number">24</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> total = <span class="number">0</span>; total &lt; msgs.size(); ) {</div><div class="line"><span class="number">25</span>:             <span class="comment">// &#x8BA1;&#x7B97;&#x5F53;&#x524D;&#x62C6;&#x5206;&#x8BF7;&#x6C42;&#x5305;&#x542B;&#x7684;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">26</span>:             List&lt;MessageExt&gt; msgThis = <span class="keyword">new</span> ArrayList&lt;&gt;(consumeBatchSize);</div><div class="line"><span class="number">27</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; consumeBatchSize; i++, total++) {</div><div class="line"><span class="number">28</span>:                 <span class="keyword">if</span> (total &lt; msgs.size()) {</div><div class="line"><span class="number">29</span>:                     msgThis.add(msgs.get(total));</div><div class="line"><span class="number">30</span>:                 } <span class="keyword">else</span> {</div><div class="line"><span class="number">31</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>:                 }</div><div class="line"><span class="number">33</span>:             }</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>:             <span class="comment">// &#x63D0;&#x4EA4;&#x62C6;&#x5206;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</span></div><div class="line"><span class="number">36</span>:             ConsumeRequest consumeRequest = <span class="keyword">new</span> ConsumeRequest(msgThis, processQueue, messageQueue);</div><div class="line"><span class="number">37</span>:             <span class="keyword">try</span> {</div><div class="line"><span class="number">38</span>:                 <span class="keyword">this</span>.consumeExecutor.submit(consumeRequest);</div><div class="line"><span class="number">39</span>:             } <span class="keyword">catch</span> (RejectedExecutionException e) {</div><div class="line"><span class="number">40</span>:                 <span class="comment">// &#x5982;&#x679C;&#x88AB;&#x62D2;&#x7EDD;&#xFF0C;&#x5219;&#x5C06;&#x5F53;&#x524D;&#x62C6;&#x5206;&#x6D88;&#x606F;+&#x5269;&#x4F59;&#x6D88;&#x606F;&#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#x3002;</span></div><div class="line"><span class="number">41</span>:                 <span class="keyword">for</span> (; total &lt; msgs.size(); total++) {</div><div class="line"><span class="number">42</span>:                     msgThis.add(msgs.get(total));</div><div class="line"><span class="number">43</span>:                 }</div><div class="line"><span class="number">44</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(consumeRequest);</div><div class="line"><span class="number">45</span>:             }</div><div class="line"><span class="number">46</span>:         }</div><div class="line"><span class="number">47</span>:     }</div><div class="line"><span class="number">48</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x63D0;&#x4EA4;<strong>&#x7ACB;&#x5373;</strong>&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x7B2C; 16 &#x81F3; 22 &#x884C; &#xFF1A;&#x63D0;&#x4EA4;&#x6D88;&#x606F;&#x5C0F;&#x4E8E;&#x7B49;&#x4E8E;&#x6279;&#x91CF;&#x6D88;&#x8D39;&#x6570;&#xFF0C;&#x76F4;&#x63A5;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x7B2C; 23 &#x81F3; 47 &#x884C; &#xFF1A;&#x5F53;&#x63D0;&#x4EA4;&#x6D88;&#x606F;&#x5927;&#x4E8E;&#x6279;&#x91CF;&#x6D88;&#x8D39;&#x6570;&#xFF0C;&#x8FDB;&#x884C;&#x5206;&#x62C6;&#x6210;&#x591A;&#x4E2A;&#x8BF7;&#x6C42;&#x3002;<ul>
<li>&#x7B2C; 25 &#x81F3; 33 &#x884C; &#xFF1A;&#x8BA1;&#x7B97;&#x5F53;&#x524D;&#x62C6;&#x5206;&#x8BF7;&#x6C42;&#x5305;&#x542B;&#x7684;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 35 &#x81F3; 38 &#x884C; &#xFF1A;&#x63D0;&#x4EA4;&#x62C6;&#x5206;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x7B2C; 39 &#x81F3; 44 &#x884C; &#xFF1A;&#x63D0;&#x4EA4;&#x8BF7;&#x6C42;&#x88AB;&#x62D2;&#x7EDD;&#xFF0C;&#x5219;&#x5C06;&#x5F53;&#x524D;&#x62C6;&#x5206;&#x6D88;&#x606F; + &#x5269;&#x4F59;&#x6D88;&#x606F;&#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#xFF0C;&#x7ED3;&#x675F;&#x62C6;&#x5206;&#x5FAA;&#x73AF;&#x3002;</li>
</ul>
</li>
</ul>
<h3 id="ConsumeMessageConcurrentlyService-submitConsumeRequestLater"><a href="#ConsumeMessageConcurrentlyService-submitConsumeRequestLater" class="headerlink" title="ConsumeMessageConcurrentlyService#submitConsumeRequestLater"></a>ConsumeMessageConcurrentlyService#submitConsumeRequestLater</h3> <figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * &#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> msgs &#x6D88;&#x606F;&#x5217;&#x8868;</div><div class="line"> 5:  * <span class="doctag">@param</span> processQueue &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;</div><div class="line"> 6:  * <span class="doctag">@param</span> messageQueue &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 7:  */</div><div class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitConsumeRequestLater</span><span class="params">(//</span></span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</div><div class="line"><span class="number">10</span>:     <span class="keyword">final</span> ProcessQueue processQueue, //</div><div class="line"><span class="number">11</span>:     <span class="keyword">final</span> MessageQueue messageQueue//</div><div class="line"><span class="number">12</span>: ) {</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() {</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">17</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">18</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.submitConsumeRequest(msgs, processQueue, messageQueue, <span class="keyword">true</span>);</div><div class="line"><span class="number">19</span>:         }</div><div class="line"><span class="number">20</span>:     }, <span class="number">5000</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">21</span>: }</div><div class="line"><span class="number">22</span>: </div><div class="line"><span class="number">23</span>: <span class="comment">/**</span></div><div class="line">24:  * &#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</div><div class="line">25:  * <span class="doctag">@param</span> consumeRequest &#x6D88;&#x8D39;&#x8BF7;&#x6C42;</div><div class="line">26:  */</div><div class="line"><span class="number">27</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitConsumeRequestLater</span><span class="params">(<span class="keyword">final</span> ConsumeRequest consumeRequest//</span></span></div><div class="line"><span class="number">28</span>: ) {</div><div class="line"><span class="number">29</span>: </div><div class="line"><span class="number">30</span>:     <span class="keyword">this</span>.scheduledExecutorService.schedule(<span class="keyword">new</span> Runnable() {</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:         <span class="meta">@Override</span></div><div class="line"><span class="number">33</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">34</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumeExecutor.submit(consumeRequest); <span class="comment">// TODO BUG ?</span></div><div class="line"><span class="number">35</span>:         }</div><div class="line"><span class="number">36</span>:     }, <span class="number">5000</span>, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">37</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x7B2C; 34 &#x884C; &#xFF1A;&#x76F4;&#x63A5;&#x8C03;&#x7528; <code>ConsumeMessageConcurrentlyService.this.consumeExecutor.submit(consumeRequest);</code>&#x3002;&#x5982;&#x679C;&#x6D88;&#x606F;&#x6570;&#x8D85;&#x8FC7;&#x6279;&#x91CF;&#x6D88;&#x8D39;&#x4E0A;&#x9650;&#xFF0C;&#x4F1A;&#x4E0D;&#x4F1A;&#x662F;<strong>BUG</strong>&#x3002;</li>
</ul>
<h2 id="ConsumeRequest"><a href="#ConsumeRequest" class="headerlink" title="ConsumeRequest"></a>ConsumeRequest</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">ConsumeRequest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</div><div class="line">  <span class="number">2</span>: </div><div class="line">  <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line">  4:      * &#x6D88;&#x8D39;&#x6D88;&#x606F;&#x5217;&#x8868;</div><div class="line">  5:      */</div><div class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MessageExt&gt; msgs;</div><div class="line">  <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line">  8:      * &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;</div><div class="line">  9:      */</div><div class="line"> <span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ProcessQueue processQueue;</div><div class="line"> <span class="number">11</span>:     <span class="comment">/**</span></div><div class="line"> 12:      * &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 13:      */</div><div class="line"> <span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MessageQueue messageQueue;</div><div class="line"> <span class="number">15</span>: </div><div class="line"> <span class="number">16</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ConsumeRequest</span><span class="params">(List&lt;MessageExt&gt; msgs, ProcessQueue processQueue, MessageQueue messageQueue)</span> </span>{</div><div class="line"> <span class="number">17</span>:         <span class="keyword">this</span>.msgs = msgs;</div><div class="line"> <span class="number">18</span>:         <span class="keyword">this</span>.processQueue = processQueue;</div><div class="line"> <span class="number">19</span>:         <span class="keyword">this</span>.messageQueue = messageQueue;</div><div class="line"> <span class="number">20</span>:     }</div><div class="line"> <span class="number">21</span>: </div><div class="line"> <span class="number">22</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">23</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">24</span>:         <span class="comment">// &#x5E9F;&#x5F03;&#x961F;&#x5217;&#x4E0D;&#x8FDB;&#x884C;&#x6D88;&#x8D39;</span></div><div class="line"> <span class="number">25</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) {</div><div class="line"> <span class="number">26</span>:             log.info(<span class="string">&quot;the message queue not be able to consume, because it&apos;s dropped. group={} {}&quot;</span>, ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">27</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">28</span>:         }</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:         MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.messageListener; <span class="comment">// &#x76D1;&#x542C;&#x5668;</span></div><div class="line"> <span class="number">31</span>:         ConsumeConcurrentlyContext context = <span class="keyword">new</span> ConsumeConcurrentlyContext(messageQueue); <span class="comment">// &#x6D88;&#x8D39;Context</span></div><div class="line"> <span class="number">32</span>:         ConsumeConcurrentlyStatus status = <span class="keyword">null</span>; <span class="comment">// &#x6D88;&#x8D39;&#x7ED3;&#x679C;&#x72B6;&#x6001;</span></div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:         <span class="comment">// Hook</span></div><div class="line"> <span class="number">35</span>:         ConsumeMessageContext consumeMessageContext = <span class="keyword">null</span>;</div><div class="line"> <span class="number">36</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) {</div><div class="line"> <span class="number">37</span>:             consumeMessageContext = <span class="keyword">new</span> ConsumeMessageContext();</div><div class="line"> <span class="number">38</span>:             consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());</div><div class="line"> <span class="number">39</span>:             consumeMessageContext.setProps(<span class="keyword">new</span> HashMap&lt;String, String&gt;());</div><div class="line"> <span class="number">40</span>:             consumeMessageContext.setMq(messageQueue);</div><div class="line"> <span class="number">41</span>:             consumeMessageContext.setMsgList(msgs);</div><div class="line"> <span class="number">42</span>:             consumeMessageContext.setSuccess(<span class="keyword">false</span>);</div><div class="line"> <span class="number">43</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);</div><div class="line"> <span class="number">44</span>:         }</div><div class="line"> <span class="number">45</span>: </div><div class="line"> <span class="number">46</span>:         <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">47</span>:         <span class="keyword">boolean</span> hasException = <span class="keyword">false</span>;</div><div class="line"> <span class="number">48</span>:         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS; <span class="comment">// &#x6D88;&#x8D39;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x7C7B;&#x578B;</span></div><div class="line"> <span class="number">49</span>:         <span class="keyword">try</span> {</div><div class="line"> <span class="number">50</span>:             <span class="comment">// &#x5F53;&#x6D88;&#x606F;&#x4E3A;&#x91CD;&#x8BD5;&#x6D88;&#x606F;&#xFF0C;&#x8BBE;&#x7F6E;Topic&#x4E3A;&#x539F;&#x59CB;Topic</span></div><div class="line"> <span class="number">51</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.resetRetryTopic(msgs);</div><div class="line"> <span class="number">52</span>: </div><div class="line"> <span class="number">53</span>:             <span class="comment">// &#x8BBE;&#x7F6E;&#x5F00;&#x59CB;&#x6D88;&#x8D39;&#x65F6;&#x95F4;</span></div><div class="line"> <span class="number">54</span>:             <span class="keyword">if</span> (msgs != <span class="keyword">null</span> &amp;&amp; !msgs.isEmpty()) {</div><div class="line"> <span class="number">55</span>:                 <span class="keyword">for</span> (MessageExt msg : msgs) {</div><div class="line"> <span class="number">56</span>:                     MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));</div><div class="line"> <span class="number">57</span>:                 }</div><div class="line"> <span class="number">58</span>:             }</div><div class="line"> <span class="number">59</span>: </div><div class="line"> <span class="number">60</span>:             <span class="comment">// &#x8FDB;&#x884C;&#x6D88;&#x8D39;</span></div><div class="line"> <span class="number">61</span>:             status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class="line"> <span class="number">62</span>:         } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"> <span class="number">63</span>:             log.warn(<span class="string">&quot;consumeMessage exception: {} Group: {} Msgs: {} MQ: {}&quot;</span>,</div><div class="line"> <span class="number">64</span>:                 RemotingHelper.exceptionSimpleDesc(e), <span class="comment">//</span></div><div class="line"> <span class="number">65</span>:                 ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup,</div><div class="line"> <span class="number">66</span>:                 msgs,</div><div class="line"> <span class="number">67</span>:                 messageQueue);</div><div class="line"> <span class="number">68</span>:             hasException = <span class="keyword">true</span>;</div><div class="line"> <span class="number">69</span>:         }</div><div class="line"> <span class="number">70</span>: </div><div class="line"> <span class="number">71</span>:         <span class="comment">// &#x89E3;&#x6790;&#x6D88;&#x8D39;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x7C7B;&#x578B;</span></div><div class="line"> <span class="number">72</span>:         <span class="keyword">long</span> consumeRT = System.currentTimeMillis() - beginTimestamp;</div><div class="line"> <span class="number">73</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == status) {</div><div class="line"> <span class="number">74</span>:             <span class="keyword">if</span> (hasException) {</div><div class="line"> <span class="number">75</span>:                 returnType = ConsumeReturnType.EXCEPTION;</div><div class="line"> <span class="number">76</span>:             } <span class="keyword">else</span> {</div><div class="line"> <span class="number">77</span>:                 returnType = ConsumeReturnType.RETURNNULL;</div><div class="line"> <span class="number">78</span>:             }</div><div class="line"> <span class="number">79</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (consumeRT &gt;= defaultMQPushConsumer.getConsumeTimeout() * <span class="number">60</span> * <span class="number">1000</span>) {</div><div class="line"> <span class="number">80</span>:             returnType = ConsumeReturnType.TIME_OUT;</div><div class="line"> <span class="number">81</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) {</div><div class="line"> <span class="number">82</span>:             returnType = ConsumeReturnType.FAILED;</div><div class="line"> <span class="number">83</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) {</div><div class="line"> <span class="number">84</span>:             returnType = ConsumeReturnType.SUCCESS;</div><div class="line"> <span class="number">85</span>:         }</div><div class="line"> <span class="number">86</span>: </div><div class="line"> <span class="number">87</span>:         <span class="comment">// Hook</span></div><div class="line"> <span class="number">88</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) {</div><div class="line"> <span class="number">89</span>:             consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());</div><div class="line"> <span class="number">90</span>:         }</div><div class="line"> <span class="number">91</span>: </div><div class="line"> <span class="number">92</span>:         <span class="comment">// &#x6D88;&#x8D39;&#x7ED3;&#x679C;&#x72B6;&#x6001;&#x4E3A;&#x7A7A;&#x65F6;&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;&#x4E3A;&#x7A0D;&#x540E;&#x91CD;&#x65B0;&#x6D88;&#x8D39;</span></div><div class="line"> <span class="number">93</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == status) {</div><div class="line"> <span class="number">94</span>:             log.warn(<span class="string">&quot;consumeMessage return null, Group: {} Msgs: {} MQ: {}&quot;</span>,</div><div class="line"> <span class="number">95</span>:                 ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup,</div><div class="line"> <span class="number">96</span>:                 msgs,</div><div class="line"> <span class="number">97</span>:                 messageQueue);</div><div class="line"> <span class="number">98</span>:             status = ConsumeConcurrentlyStatus.RECONSUME_LATER;</div><div class="line"> <span class="number">99</span>:         }</div><div class="line"><span class="number">100</span>: </div><div class="line"><span class="number">101</span>:         <span class="comment">// Hook</span></div><div class="line"><span class="number">102</span>:         <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) {</div><div class="line"><span class="number">103</span>:             consumeMessageContext.setStatus(status.toString());</div><div class="line"><span class="number">104</span>:             consumeMessageContext.setSuccess(ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status);</div><div class="line"><span class="number">105</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.executeHookAfter(consumeMessageContext);</div><div class="line"><span class="number">106</span>:         }</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>:         <span class="comment">// &#x7EDF;&#x8BA1;</span></div><div class="line"><span class="number">109</span>:         ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.getConsumerStatsManager()</div><div class="line"><span class="number">110</span>:             .incConsumeRT(ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class="line"><span class="number">111</span>: </div><div class="line"><span class="number">112</span>:         <span class="comment">// &#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;</span></div><div class="line"><span class="number">113</span>:         <span class="keyword">if</span> (!processQueue.isDropped()) {</div><div class="line"><span class="number">114</span>:             ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.processConsumeResult(status, context, <span class="keyword">this</span>);</div><div class="line"><span class="number">115</span>:         } <span class="keyword">else</span> {</div><div class="line"><span class="number">116</span>:             log.warn(<span class="string">&quot;processQueue is dropped without process consume result. messageQueue={}, msgs={}&quot;</span>, messageQueue, msgs);</div><div class="line"><span class="number">117</span>:         }</div><div class="line"><span class="number">118</span>:     }</div><div class="line"><span class="number">119</span>: </div><div class="line"><span class="number">120</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#x3002;&#x63D0;&#x4EA4;&#x8BF7;&#x6C42;&#x6267;&#x884C;&#x6D88;&#x8D39;&#x3002;</li>
<li>&#x7B2C; 24 &#x81F3; 28 &#x884C; &#xFF1A;&#x5E9F;&#x5F03;&#x5904;&#x7406;&#x961F;&#x5217;&#x4E0D;&#x8FDB;&#x884C;&#x6D88;&#x8D39;&#x3002;</li>
<li>&#x7B2C; 34 &#x81F3; 44 &#x884C; &#xFF1A;Hook&#x3002;</li>
<li>&#x7B2C; 51 &#x884C; &#xFF1A;&#x5F53;&#x6D88;&#x606F;&#x4E3A;&#x91CD;&#x8BD5;&#x6D88;&#x606F;&#xFF0C;&#x8BBE;&#x7F6E; <code>Topic</code>&#x4E3A;&#x539F;&#x59CB; <code>Topic</code>&#x3002;&#x4F8B;&#x5982;&#xFF1A;&#x539F;&#x59CB; <code>Topic</code> &#x4E3A; <code>TopicTest</code>&#xFF0C;&#x91CD;&#x8BD5;&#x65F6; <code>Topic</code> &#x4E3A; <code>%RETRY%please_rename_unique_group_name_4</code>&#xFF0C;&#x7ECF;&#x8FC7;&#x8BE5;&#x65B9;&#x6CD5;&#xFF0C;<code>Topic</code> &#x8BBE;&#x7F6E;&#x56DE; <code>TopicTest</code>&#x3002;</li>
<li>&#x7B2C; 53 &#x81F3; 58 &#x884C; &#xFF1A;&#x8BBE;&#x7F6E;&#x5F00;&#x59CB;&#x6D88;&#x8D39;&#x65F6;&#x95F4;&#x3002;</li>
<li>&#x7B2C; 61 &#x884C; &#xFF1A;<strong>&#x8FDB;&#x884C;&#x6D88;&#x8D39;</strong>&#x3002;</li>
<li>&#x7B2C; 71 &#x81F3; 85 &#x884C; &#xFF1A;&#x89E3;&#x6790;&#x6D88;&#x8D39;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x7C7B;&#x578B;</li>
<li>&#x7B2C; 87 &#x81F3; 90 &#x884C; &#xFF1A;<code>Hook</code>&#x3002;</li>
<li>&#x7B2C; 92 &#x81F3; 99 &#x884C; &#xFF1A;&#x6D88;&#x8D39;&#x7ED3;&#x679C;&#x72B6;&#x6001;&#x672A;&#x7A7A;&#x65F6;&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;&#x6D88;&#x8D39;&#x7ED3;&#x679C;&#x72B6;&#x6001;&#x4E3A;&#x7A0D;&#x540E;&#x6D88;&#x8D39;&#x3002;</li>
<li>&#x7B2C; 101 &#x81F3; 106 &#x884C; &#xFF1A;<code>Hook</code>&#x3002;</li>
<li>&#x7B2C; 108 &#x81F3; 110 &#x884C; &#xFF1A;&#x7EDF;&#x8BA1;&#x3002;</li>
<li>&#x7B2C; 112 &#x81F3; 117 &#x884C; &#xFF1A;&#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;&#x3002;<strong>&#x5982;&#x679C;&#x6D88;&#x8D39;&#x5904;&#x7406;&#x961F;&#x5217;&#x88AB;&#x79FB;&#x9664;&#xFF0C;&#x6070;&#x597D;&#x6D88;&#x606F;&#x88AB;&#x6D88;&#x8D39;&#xFF0C;&#x5219;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x6D88;&#x606F;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x6D88;&#x606F;&#x6D88;&#x8D39;&#x8981;&#x5C3D;&#x6700;&#x5927;&#x53EF;&#x80FD;&#x6027;&#x5B9E;&#x73B0;&#x5E42;&#x7B49;&#x6027;</strong>&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#consumemessageconcurrentlyserviceprocessconsumeresult">ConsumeMessageConcurrentlyService#processConsumeResult(&#x2026;)</a>&#x3002;</li>
</ul>
<h2 id="ConsumeMessageConcurrentlyService-processConsumeResult-&#x2026;"><a href="#ConsumeMessageConcurrentlyService-processConsumeResult-&#x2026;" class="headerlink" title="ConsumeMessageConcurrentlyService#processConsumeResult(&#x2026;)"></a>ConsumeMessageConcurrentlyService#processConsumeResult(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processConsumeResult</span><span class="params">(//</span></span></div><div class="line"> <span class="number">2</span>:     <span class="keyword">final</span> ConsumeConcurrentlyStatus status, //</div><div class="line"> <span class="number">3</span>:     <span class="keyword">final</span> ConsumeConcurrentlyContext context, //</div><div class="line"> <span class="number">4</span>:     <span class="keyword">final</span> ConsumeRequest consumeRequest//</div><div class="line"> <span class="number">5</span>: ) {</div><div class="line"> <span class="number">6</span>:     <span class="keyword">int</span> ackIndex = context.getAckIndex();</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:     <span class="comment">// &#x6D88;&#x606F;&#x4E3A;&#x7A7A;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (consumeRequest.getMsgs().isEmpty())</div><div class="line"><span class="number">10</span>:         <span class="keyword">return</span>;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="comment">// &#x8BA1;&#x7B97;&#x4ECE;consumeRequest.msgs[0]&#x5230;consumeRequest.msgs[ackIndex]&#x7684;&#x6D88;&#x606F;&#x6D88;&#x8D39;&#x6210;&#x529F;</span></div><div class="line"><span class="number">13</span>:     <span class="keyword">switch</span> (status) {</div><div class="line"><span class="number">14</span>:         <span class="keyword">case</span> CONSUME_SUCCESS:</div><div class="line"><span class="number">15</span>:             <span class="keyword">if</span> (ackIndex &gt;= consumeRequest.getMsgs().size()) {</div><div class="line"><span class="number">16</span>:                 ackIndex = consumeRequest.getMsgs().size() - <span class="number">1</span>;</div><div class="line"><span class="number">17</span>:             }</div><div class="line"><span class="number">18</span>:             <span class="comment">// &#x7EDF;&#x8BA1;&#x6210;&#x529F;/&#x5931;&#x8D25;&#x6570;&#x91CF;</span></div><div class="line"><span class="number">19</span>:             <span class="keyword">int</span> ok = ackIndex + <span class="number">1</span>;</div><div class="line"><span class="number">20</span>:             <span class="keyword">int</span> failed = consumeRequest.getMsgs().size() - ok;</div><div class="line"><span class="number">21</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);</div><div class="line"><span class="number">22</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);</div><div class="line"><span class="number">23</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">24</span>:         <span class="keyword">case</span> RECONSUME_LATER:</div><div class="line"><span class="number">25</span>:             ackIndex = -<span class="number">1</span>;</div><div class="line"><span class="number">26</span>:             <span class="comment">// &#x7EDF;&#x8BA1;&#x6210;&#x529F;/&#x5931;&#x8D25;&#x6570;&#x91CF;</span></div><div class="line"><span class="number">27</span>:             <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),</div><div class="line"><span class="number">28</span>:                 consumeRequest.getMsgs().size());</div><div class="line"><span class="number">29</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">30</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">31</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">32</span>:     }</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="comment">// &#x5904;&#x7406;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x7684;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">35</span>:     <span class="keyword">switch</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel()) {</div><div class="line"><span class="number">36</span>:         <span class="keyword">case</span> BROADCASTING: <span class="comment">// &#x5E7F;&#x64AD;&#x6A21;&#x5F0F;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x5426;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#xFF0C;&#x4E0D;&#x53D1;&#x56DE;&#x6D88;&#x606F;&#x5230;Broker&#xFF0C;&#x53EA;&#x6253;&#x5370;Log</span></div><div class="line"><span class="number">37</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) {</div><div class="line"><span class="number">38</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class="line"><span class="number">39</span>:                 log.warn(<span class="string">&quot;BROADCASTING, the message consume failed, drop it, {}&quot;</span>, msg.toString());</div><div class="line"><span class="number">40</span>:             }</div><div class="line"><span class="number">41</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">42</span>:         <span class="keyword">case</span> CLUSTERING:</div><div class="line"><span class="number">43</span>:             <span class="comment">// &#x53D1;&#x56DE;&#x6D88;&#x606F;&#x5931;&#x8D25;&#x5230;Broker&#x3002;</span></div><div class="line"><span class="number">44</span>:             List&lt;MessageExt&gt; msgBackFailed = <span class="keyword">new</span> ArrayList&lt;&gt;(consumeRequest.getMsgs().size());</div><div class="line"><span class="number">45</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) {</div><div class="line"><span class="number">46</span>:                 MessageExt msg = consumeRequest.getMsgs().get(i);</div><div class="line"><span class="number">47</span>:                 <span class="keyword">boolean</span> result = <span class="keyword">this</span>.sendMessageBack(msg, context);</div><div class="line"><span class="number">48</span>:                 <span class="keyword">if</span> (!result) {</div><div class="line"><span class="number">49</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">50</span>:                     msgBackFailed.add(msg);</div><div class="line"><span class="number">51</span>:                 }</div><div class="line"><span class="number">52</span>:             }</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>:             <span class="comment">// &#x53D1;&#x56DE;Broker&#x5931;&#x8D25;&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x76F4;&#x63A5;&#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x91CD;&#x65B0;&#x6D88;&#x8D39;</span></div><div class="line"><span class="number">55</span>:             <span class="keyword">if</span> (!msgBackFailed.isEmpty()) {</div><div class="line"><span class="number">56</span>:                 consumeRequest.getMsgs().removeAll(msgBackFailed);</div><div class="line"><span class="number">57</span>: </div><div class="line"><span class="number">58</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());</div><div class="line"><span class="number">59</span>:             }</div><div class="line"><span class="number">60</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">61</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">62</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">63</span>:     }</div><div class="line"><span class="number">64</span>: </div><div class="line"><span class="number">65</span>:     <span class="comment">// &#x79FB;&#x9664;&#x6D88;&#x8D39;&#x6210;&#x529F;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x66F4;&#x65B0;&#x6700;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</span></div><div class="line"><span class="number">66</span>:     <span class="keyword">long</span> offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());</div><div class="line"><span class="number">67</span>:     <span class="keyword">if</span> (offset &gt;= <span class="number">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) {</div><div class="line"><span class="number">68</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, <span class="keyword">true</span>);</div><div class="line"><span class="number">69</span>:     }</div><div class="line"><span class="number">70</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;&#x3002;</li>
<li>&#x7B2C; 8 &#x81F3; 10 &#x884C; &#xFF1A;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#x6D88;&#x606F;&#x672A;&#x7A7A;&#x65F6;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x3002;</li>
<li>&#x7B2C; 12 &#x81F3; 32 &#x884C; &#xFF1A;&#x8BA1;&#x7B97; <code>ackIndex</code> &#x503C;&#x3002;<code>consumeRequest.msgs[0 - ackIndex]</code>&#x4E3A;&#x6D88;&#x8D39;&#x6210;&#x529F;&#xFF0C;&#x9700;&#x8981;&#x8FDB;&#x884C; <code>ack</code> &#x786E;&#x8BA4;&#x3002;<ul>
<li>&#x7B2C; 14 &#x81F3; 23 &#x884C; &#xFF1A;<code>CONSUME_SUCCESS</code> &#xFF1A;<code>ackIndex = context.getAckIndex()</code>&#x3002;</li>
<li>&#x7B2C; 24 &#x81F3; 29 &#x884C; &#xFF1A;<code>RECONSUME_LATER</code> &#xFF1A;<code>ackIndex = -1</code>&#x3002;</li>
</ul>
</li>
<li>&#x7B2C;34 &#x81F3; 63 &#x884C; &#xFF1A;&#x5904;&#x7406;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x7684;&#x6D88;&#x606F;&#x3002;<ul>
<li>&#x7B2C; 36 &#x81F3; 41 &#x884C; &#xFF1A;<code>BROADCASTING</code> &#xFF1A;&#x5E7F;&#x64AD;&#x6A21;&#x5F0F;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x5426;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#xFF0C;&#x4E0D;&#x53D1;&#x56DE;&#x6D88;&#x606F;&#x5230; <code>Broker</code>&#xFF0C;&#x53EA;&#x6253;&#x5370;&#x65E5;&#x5FD7;&#x3002;</li>
<li>&#x7B2C; 42 &#x81F3; 60 &#x884C; &#xFF1A;<code>CLUSTERING</code> &#xFF1A;&#x96C6;&#x7FA4;&#x6A21;&#x5F0F;&#xFF0C;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x7684;&#x6D88;&#x606F;&#x53D1;&#x56DE;&#x5230; <code>Broker</code>&#x3002;<ul>
<li>&#x7B2C; 43 &#x81F3; 52 &#x884C; &#xFF1A;&#x53D1;&#x56DE;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x7684;&#x6D88;&#x606F;&#x5230; <code>Broker</code>&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#defaultmqpushconsumerimplsendmessageback">DefaultMQPushConsumerImpl#sendMessageBack(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 54 &#x81F3; 59 &#x884C; &#xFF1A;&#x53D1;&#x56DE; <code>Broker</code> &#x5931;&#x8D25;&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x76F4;&#x63A5;&#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x91CD;&#x65B0;&#x6D88;&#x8D39;&#x3002;</li>
<li><strong>&#x5982;&#x679C;&#x53D1;&#x56DE; <code>Broker</code> &#x6210;&#x529F;&#xFF0C;&#x7ED3;&#x679C;&#x56E0;&#x4E3A;&#x4F8B;&#x5982;&#x7F51;&#x7EDC;&#x5F02;&#x5E38;&#xFF0C;&#x5BFC;&#x81F4; <code>Consumer</code>&#x4EE5;&#x4E3A;&#x53D1;&#x56DE;&#x5931;&#x8D25;&#xFF0C;&#x5224;&#x5B9A;&#x6D88;&#x8D39;&#x53D1;&#x56DE;&#x5931;&#x8D25;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4;&#x6D88;&#x606F;&#x91CD;&#x590D;&#x6D88;&#x8D39;&#xFF0C;&#x56E0;&#x6B64;&#xFF0C;&#x6D88;&#x606F;&#x6D88;&#x8D39;&#x8981;&#x5C3D;&#x6700;&#x5927;&#x53EF;&#x80FD;&#x6027;&#x5B9E;&#x73B0;&#x5E42;&#x7B49;&#x6027;&#x3002;</strong></li>
</ul>
</li>
</ul>
</li>
<li>&#x7B2C; 65 &#x81F3; 69 &#x884C; &#xFF1A;&#x79FB;&#x9664;<strong>&#x3010;&#x6D88;&#x8D39;&#x6210;&#x529F;&#x3011;</strong>&#x548C;<strong>&#x3010;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x4F46;&#x53D1;&#x56DE;<code>Broker</code>&#x6210;&#x529F;&#x3011;</strong>&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x66F4;&#x65B0;&#x6700;&#x65B0;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;<ul>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x4F1A;&#x6709;<strong>&#x3010;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x4F46;&#x53D1;&#x56DE;<code>Broker</code>&#x6210;&#x529F;&#x3011;</strong>&#x7684;&#x6D88;&#x606F;&#xFF1F;&#x89C1;<strong>&#x7B2C; 56 &#x884C;</strong>&#x3002;</li>
<li><a href="#processqueueremovemessage">ProcessQueue#removeMessage(&#x2026;)</a></li>
</ul>
</li>
</ul>
<h3 id="ProcessQueue-removeMessage-&#x2026;"><a href="#ProcessQueue-removeMessage-&#x2026;" class="headerlink" title="ProcessQueue#removeMessage(&#x2026;)"></a>ProcessQueue#removeMessage(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * &#x79FB;&#x9664;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x7B2C;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;</div><div class="line"> 3:  *</div><div class="line"> 4:  * <span class="doctag">@param</span> msgs &#x6D88;&#x606F;</div><div class="line"> 5:  * <span class="doctag">@return</span> &#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;</div><div class="line"> 6:  */</div><div class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">removeMessage</span><span class="params">(<span class="keyword">final</span> List&lt;MessageExt&gt; msgs)</span> </span>{</div><div class="line"> <span class="number">8</span>:     <span class="keyword">long</span> result = -<span class="number">1</span>;</div><div class="line"> <span class="number">9</span>:     <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"><span class="number">10</span>:     <span class="keyword">try</span> {</div><div class="line"><span class="number">11</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">12</span>:         <span class="keyword">this</span>.lastConsumeTimestamp = now;</div><div class="line"><span class="number">13</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">14</span>:             <span class="keyword">if</span> (!msgTreeMap.isEmpty()) {</div><div class="line"><span class="number">15</span>:                 result = <span class="keyword">this</span>.queueOffsetMax + <span class="number">1</span>; <span class="comment">// &#x8FD9;&#x91CC;+1&#x7684;&#x539F;&#x56E0;&#x662F;&#xFF1A;&#x5982;&#x679C;msgTreeMap&#x4E3A;&#x7A7A;&#x65F6;&#xFF0C;&#x4E0B;&#x4E00;&#x6761;&#x83B7;&#x5F97;&#x7684;&#x6D88;&#x606F;&#x4F4D;&#x7F6E;&#x4E3A;queueOffsetMax+1</span></div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:                 <span class="comment">// &#x79FB;&#x9664;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">18</span>:                 <span class="keyword">int</span> removedCnt = <span class="number">0</span>;</div><div class="line"><span class="number">19</span>:                 <span class="keyword">for</span> (MessageExt msg : msgs) {</div><div class="line"><span class="number">20</span>:                     MessageExt prev = msgTreeMap.remove(msg.getQueueOffset());</div><div class="line"><span class="number">21</span>:                     <span class="keyword">if</span> (prev != <span class="keyword">null</span>) {</div><div class="line"><span class="number">22</span>:                         removedCnt--;</div><div class="line"><span class="number">23</span>:                     }</div><div class="line"><span class="number">24</span>:                 }</div><div class="line"><span class="number">25</span>:                 msgCount.addAndGet(removedCnt);</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:                 <span class="keyword">if</span> (!msgTreeMap.isEmpty()) {</div><div class="line"><span class="number">28</span>:                     result = msgTreeMap.firstKey();</div><div class="line"><span class="number">29</span>:                 }</div><div class="line"><span class="number">30</span>:             }</div><div class="line"><span class="number">31</span>:         } <span class="keyword">finally</span> {</div><div class="line"><span class="number">32</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">33</span>:         }</div><div class="line"><span class="number">34</span>:     } <span class="keyword">catch</span> (Throwable t) {</div><div class="line"><span class="number">35</span>:         log.error(<span class="string">&quot;removeMessage exception&quot;</span>, t);</div><div class="line"><span class="number">36</span>:     }</div><div class="line"><span class="number">37</span>: </div><div class="line"><span class="number">38</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">39</span>: }</div></pre></td></tr></table></figure>
<h2 id="ConsumeMessageConcurrentlyService-cleanExpireMsg-&#x2026;"><a href="#ConsumeMessageConcurrentlyService-cleanExpireMsg-&#x2026;" class="headerlink" title="ConsumeMessageConcurrentlyService#cleanExpireMsg(&#x2026;)"></a>ConsumeMessageConcurrentlyService#cleanExpireMsg(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">this</span>.cleanExpireMsgExecutors.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() {</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">5</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">6</span>:             cleanExpireMsg();</div><div class="line"> <span class="number">7</span>:         }</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     }, <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeTimeout(), <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeTimeout(), TimeUnit.MINUTES);</div><div class="line"><span class="number">10</span>: }</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>: <span class="comment">/**</span></div><div class="line">13:  * &#x6E05;&#x7406;&#x8FC7;&#x671F;&#x6D88;&#x606F;</div><div class="line">14:  */</div><div class="line"><span class="number">15</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanExpireMsg</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">16</span>:     Iterator&lt;Map.Entry&lt;MessageQueue, ProcessQueue&gt;&gt; it =</div><div class="line"><span class="number">17</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getRebalanceImpl().getProcessQueueTable().entrySet().iterator();</div><div class="line"><span class="number">18</span>:     <span class="keyword">while</span> (it.hasNext()) {</div><div class="line"><span class="number">19</span>:         Map.Entry&lt;MessageQueue, ProcessQueue&gt; next = it.next();</div><div class="line"><span class="number">20</span>:         ProcessQueue pq = next.getValue();</div><div class="line"><span class="number">21</span>:         pq.cleanExpiredMsg(<span class="keyword">this</span>.defaultMQPushConsumer);</div><div class="line"><span class="number">22</span>:     }</div><div class="line"><span class="number">23</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x5B9A;&#x65F6;&#x6E05;&#x7406;&#x8FC7;&#x671F;&#x6D88;&#x606F;&#xFF0C;&#x9ED8;&#x8BA4;&#x5468;&#x671F;&#xFF1A;15min&#x3002;</li>
</ul>
<h3 id="ProcessQueue-cleanExpiredMsg-&#x2026;"><a href="#ProcessQueue-cleanExpiredMsg-&#x2026;" class="headerlink" title="ProcessQueue#cleanExpiredMsg(&#x2026;)"></a>ProcessQueue#cleanExpiredMsg(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanExpiredMsg</span><span class="params">(DefaultMQPushConsumer pushConsumer)</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="comment">// &#x987A;&#x5E8F;&#x6D88;&#x8D39;&#x65F6;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (pushConsumer.getDefaultMQPushConsumerImpl().isConsumeOrderly()) {</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>:     }</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// &#x5FAA;&#x73AF;&#x79FB;&#x9664;&#x6D88;&#x606F;</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">int</span> loop = msgTreeMap.size() &lt; <span class="number">16</span> ? msgTreeMap.size() : <span class="number">16</span>; <span class="comment">// &#x6BCF;&#x6B21;&#x5FAA;&#x73AF;&#x6700;&#x591A;&#x79FB;&#x9664;16&#x6761;</span></div><div class="line"> <span class="number">9</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loop; i++) {</div><div class="line"><span class="number">10</span>:         <span class="comment">// &#x83B7;&#x53D6;&#x7B2C;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x3002;&#x5224;&#x65AD;&#x662F;&#x5426;&#x8D85;&#x65F6;&#xFF0C;&#x82E5;&#x4E0D;&#x8D85;&#x65F6;&#xFF0C;&#x5219;&#x7ED3;&#x675F;&#x5FAA;&#x73AF;</span></div><div class="line"><span class="number">11</span>:         MessageExt msg = <span class="keyword">null</span>;</div><div class="line"><span class="number">12</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">13</span>:             <span class="keyword">this</span>.lockTreeMap.readLock().lockInterruptibly();</div><div class="line"><span class="number">14</span>:             <span class="keyword">try</span> {</div><div class="line"><span class="number">15</span>:                 <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; System.currentTimeMillis() - Long.parseLong(MessageAccessor.getConsumeStartTimeStamp(msgTreeMap.firstEntry().getValue())) &gt; pushConsumer.getConsumeTimeout() * <span class="number">60</span> * <span class="number">1000</span>) {</div><div class="line"><span class="number">16</span>:                     msg = msgTreeMap.firstEntry().getValue();</div><div class="line"><span class="number">17</span>:                 } <span class="keyword">else</span> {</div><div class="line"><span class="number">18</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">19</span>:                 }</div><div class="line"><span class="number">20</span>:             } <span class="keyword">finally</span> {</div><div class="line"><span class="number">21</span>:                 <span class="keyword">this</span>.lockTreeMap.readLock().unlock();</div><div class="line"><span class="number">22</span>:             }</div><div class="line"><span class="number">23</span>:         } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"><span class="number">24</span>:             log.error(<span class="string">&quot;getExpiredMsg exception&quot;</span>, e);</div><div class="line"><span class="number">25</span>:         }</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">28</span>:             <span class="comment">// &#x53D1;&#x56DE;&#x8D85;&#x65F6;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">29</span>:             pushConsumer.sendMessageBack(msg, <span class="number">3</span>);</div><div class="line"><span class="number">30</span>:             log.info(<span class="string">&quot;send expire msg back. topic={}, msgId={}, storeHost={}, queueId={}, queueOffset={}&quot;</span>, msg.getTopic(), msg.getMsgId(), msg.getStoreHost(), msg.getQueueId(), msg.getQueueOffset());</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:             <span class="comment">// &#x5224;&#x65AD;&#x6B64;&#x65F6;&#x6D88;&#x606F;&#x662F;&#x5426;&#x4F9D;&#x7136;&#x662F;&#x7B2C;&#x4E00;&#x6761;&#xFF0C;&#x82E5;&#x662F;&#xFF0C;&#x5219;&#x8FDB;&#x884C;&#x79FB;&#x9664;</span></div><div class="line"><span class="number">33</span>:             <span class="keyword">try</span> {</div><div class="line"><span class="number">34</span>:                 <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"><span class="number">35</span>:                 <span class="keyword">try</span> {</div><div class="line"><span class="number">36</span>:                     <span class="keyword">if</span> (!msgTreeMap.isEmpty() &amp;&amp; msg.getQueueOffset() == msgTreeMap.firstKey()) {</div><div class="line"><span class="number">37</span>:                         <span class="keyword">try</span> {</div><div class="line"><span class="number">38</span>:                             msgTreeMap.remove(msgTreeMap.firstKey());</div><div class="line"><span class="number">39</span>:                         } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">40</span>:                             log.error(<span class="string">&quot;send expired msg exception&quot;</span>, e);</div><div class="line"><span class="number">41</span>:                         }</div><div class="line"><span class="number">42</span>:                     }</div><div class="line"><span class="number">43</span>:                 } <span class="keyword">finally</span> {</div><div class="line"><span class="number">44</span>:                     <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">45</span>:                 }</div><div class="line"><span class="number">46</span>:             } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"><span class="number">47</span>:                 log.error(<span class="string">&quot;getExpiredMsg exception&quot;</span>, e);</div><div class="line"><span class="number">48</span>:             }</div><div class="line"><span class="number">49</span>:         } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">50</span>:             log.error(<span class="string">&quot;send expired msg exception&quot;</span>, e);</div><div class="line"><span class="number">51</span>:         }</div><div class="line"><span class="number">52</span>:     }</div><div class="line"><span class="number">53</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x79FB;&#x9664;&#x8FC7;&#x671F;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 2 &#x81F3; 5 &#x884C; &#xFF1A;&#x987A;&#x5E8F;&#x6D88;&#x8D39;&#x65F6;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x3002;</li>
<li>&#x7B2C; 7 &#x81F3; 9 &#x884C; &#xFF1A;&#x5FAA;&#x73AF;&#x79FB;&#x9664;&#x6D88;&#x606F;&#x3002;&#x9ED8;&#x8BA4;&#x6700;&#x5927;&#x5FAA;&#x73AF;&#x6B21;&#x6570;&#xFF1A;16&#x6B21;&#x3002;</li>
<li>&#x7B2C; 10 &#x81F3; 25 &#x884C; &#xFF1A;&#x83B7;&#x53D6;&#x7B2C;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x3002;&#x5224;&#x65AD;&#x662F;&#x5426;&#x8D85;&#x65F6;&#xFF0C;&#x82E5;&#x4E0D;&#x8D85;&#x65F6;&#xFF0C;&#x5219;&#x7ED3;&#x675F;&#x5FAA;&#x73AF;&#x3002;</li>
<li>&#x7B2C; 29 &#x884C; &#xFF1A;<strong>&#x53D1;&#x56DE;&#x8D85;&#x65F6;&#x6D88;&#x606F;&#x5230;<code>Broker</code></strong>&#x3002;</li>
<li>&#x7B2C; 32 &#x81F3; 48 &#x884C; &#xFF1A;&#x5224;&#x65AD;&#x6B64;&#x65F6;&#x6D88;&#x606F;&#x662F;&#x5426;&#x4F9D;&#x7136;&#x662F;&#x7B2C;&#x4E00;&#x6761;&#xFF0C;&#x82E5;&#x662F;&#xFF0C;&#x5219;&#x8FDB;&#x884C;&#x79FB;&#x9664;&#x3002;</li>
</ul>
<h1 id="7&#x3001;PushConsumer-&#x53D1;&#x56DE;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x6D88;&#x606F;"><a href="#7&#x3001;PushConsumer-&#x53D1;&#x56DE;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x6D88;&#x606F;" class="headerlink" title="7&#x3001;PushConsumer &#x53D1;&#x56DE;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x6D88;&#x606F;"></a>7&#x3001;PushConsumer &#x53D1;&#x56DE;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x6D88;&#x606F;</h1><h2 id="DefaultMQPushConsumerImpl-sendMessageBack-&#x2026;"><a href="#DefaultMQPushConsumerImpl-sendMessageBack-&#x2026;" class="headerlink" title="DefaultMQPushConsumerImpl#sendMessageBack(&#x2026;)"></a>DefaultMQPushConsumerImpl#sendMessageBack(&#x2026;)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageBack</span><span class="params">(MessageExt msg, <span class="keyword">int</span> delayLevel, <span class="keyword">final</span> String brokerName)</span></span></div><div class="line"> 2:     <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException, MQClientException {</div><div class="line"> <span class="number">3</span>:     <span class="keyword">try</span> {</div><div class="line"> <span class="number">4</span>:         <span class="comment">// Consumer&#x53D1;&#x56DE;&#x6D88;&#x606F;</span></div><div class="line"> <span class="number">5</span>:         String brokerAddr = (<span class="keyword">null</span> != brokerName) ? <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(brokerName)</div><div class="line"> <span class="number">6</span>:             : RemotingHelper.parseSocketAddressAddr(msg.getStoreHost());</div><div class="line"> <span class="number">7</span>:         <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().consumerSendMessageBack(brokerAddr, msg,</div><div class="line"> <span class="number">8</span>:             <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), delayLevel, <span class="number">5000</span>, getMaxReconsumeTimes());</div><div class="line"> <span class="number">9</span>:     } <span class="keyword">catch</span> (Exception e) { <span class="comment">// TODO &#x7591;&#x95EE;&#xFF1A;&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x53D1;&#x751F;&#x5F02;&#x5E38;</span></div><div class="line"><span class="number">10</span>:         <span class="comment">// &#x5F02;&#x5E38;&#x65F6;&#xFF0C;&#x4F7F;&#x7528;Client&#x5185;&#x7F6E;Producer&#x53D1;&#x56DE;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">11</span>:         log.error(<span class="string">&quot;sendMessageBack Exception, &quot;</span> + <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), e);</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:         Message newMsg = <span class="keyword">new</span> Message(MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class="line"><span class="number">16</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class="line"><span class="number">17</span>: </div><div class="line"><span class="number">18</span>:         newMsg.setFlag(msg.getFlag());</div><div class="line"><span class="number">19</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class="line"><span class="number">20</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class="line"><span class="number">21</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes() + <span class="number">1</span>));</div><div class="line"><span class="number">22</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class="line"><span class="number">23</span>:         newMsg.setDelayTimeLevel(<span class="number">3</span> + msg.getReconsumeTimes());</div><div class="line"><span class="number">24</span>: </div><div class="line"><span class="number">25</span>:         <span class="keyword">this</span>.mQClientFactory.getDefaultMQProducer().send(newMsg);</div><div class="line"><span class="number">26</span>:     }</div><div class="line"><span class="number">27</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x53D1;&#x56DE;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 4 &#x81F3; 8 &#x884C; &#xFF1A;<code>Consumer</code> &#x53D1;&#x56DE;&#x6D88;&#x606F;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#mqclientapiimplconsumersendmessageback">MQClientAPIImpl#consumerSendMessageBack(&#x2026;)</a>&#x3002;</li>
<li>&#x7B2C; 10 &#x81F3; 25 &#x884C; &#xFF1A;&#x53D1;&#x751F;&#x5F02;&#x5E38;&#x65F6;&#xFF0C;<code>Consumer</code> &#x5185;&#x7F6E;&#x9ED8;&#x8BA4; <code>Producer</code> &#x53D1;&#x9001;&#x6D88;&#x606F;&#x3002;<ul>
<li>&#x1F608;&#x7591;&#x95EE;&#xFF1A;&#x4EC0;&#x4E48;&#x6837;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x53D1;&#x751F;&#x5F02;&#x5E38;&#x5462;&#xFF1F;</li>
</ul>
</li>
</ul>
<h3 id="MQClientAPIImpl-consumerSendMessageBack-&#x2026;"><a href="#MQClientAPIImpl-consumerSendMessageBack-&#x2026;" class="headerlink" title="MQClientAPIImpl#consumerSendMessageBack(&#x2026;)"></a>MQClientAPIImpl#consumerSendMessageBack(&#x2026;)</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">/**</span></div><div class="line"> 2:  * Consumer&#x53D1;&#x56DE;&#x6D88;&#x606F;</div><div class="line"> 3:  * <span class="doctag">@param</span> addr Broker&#x5730;&#x5740;</div><div class="line"> 4:  * <span class="doctag">@param</span> msg &#x6D88;&#x606F;</div><div class="line"> 5:  * <span class="doctag">@param</span> consumerGroup &#x6D88;&#x8D39;&#x5206;&#x7EC4;</div><div class="line"> 6:  * <span class="doctag">@param</span> delayLevel &#x5EF6;&#x8FDF;&#x7EA7;&#x522B;</div><div class="line"> 7:  * <span class="doctag">@param</span> timeoutMillis &#x8D85;&#x65F6;</div><div class="line"> 8:  * <span class="doctag">@param</span> maxConsumeRetryTimes &#x6D88;&#x8D39;&#x6700;&#x5927;&#x91CD;&#x8BD5;&#x6B21;&#x6570;</div><div class="line"> 9:  * <span class="doctag">@throws</span> RemotingException &#x5F53;&#x8FDC;&#x7A0B;&#x8C03;&#x7528;&#x53D1;&#x751F;&#x5F02;&#x5E38;&#x65F6;</div><div class="line">10:  * <span class="doctag">@throws</span> MQBrokerException &#x5F53;Broker&#x53D1;&#x751F;&#x5F02;&#x5E38;&#x65F6;</div><div class="line">11:  * <span class="doctag">@throws</span> InterruptedException &#x5F53;&#x7EBF;&#x7A0B;&#x4E2D;&#x65AD;&#x65F6;</div><div class="line">12:  */</div><div class="line"><span class="number">13</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumerSendMessageBack</span><span class="params">(</span></span></div><div class="line"><span class="number">14</span>:     <span class="keyword">final</span> String addr,</div><div class="line"><span class="number">15</span>:     <span class="keyword">final</span> MessageExt msg,</div><div class="line"><span class="number">16</span>:     <span class="keyword">final</span> String consumerGroup,</div><div class="line"><span class="number">17</span>:     <span class="keyword">final</span> <span class="keyword">int</span> delayLevel,</div><div class="line"><span class="number">18</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</div><div class="line"><span class="number">19</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxConsumeRetryTimes</div><div class="line"><span class="number">20</span>: ) <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException {</div><div class="line"><span class="number">21</span>:     ConsumerSendMsgBackRequestHeader requestHeader = <span class="keyword">new</span> ConsumerSendMsgBackRequestHeader();</div><div class="line"><span class="number">22</span>:     RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:     requestHeader.setGroup(consumerGroup);</div><div class="line"><span class="number">25</span>:     requestHeader.setOriginTopic(msg.getTopic());</div><div class="line"><span class="number">26</span>:     requestHeader.setOffset(msg.getCommitLogOffset());</div><div class="line"><span class="number">27</span>:     requestHeader.setDelayLevel(delayLevel);</div><div class="line"><span class="number">28</span>:     requestHeader.setOriginMsgId(msg.getMsgId());</div><div class="line"><span class="number">29</span>:     requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     RemotingCommand response = <span class="keyword">this</span>.remotingClient.invokeSync(MixAll.brokerVIPChannel(<span class="keyword">this</span>.clientConfig.isVipChannelEnabled(), addr),</div><div class="line"><span class="number">32</span>:         request, timeoutMillis);</div><div class="line"><span class="number">33</span>:     <span class="keyword">assert</span> response != <span class="keyword">null</span>;</div><div class="line"><span class="number">34</span>:     <span class="keyword">switch</span> (response.getCode()) {</div><div class="line"><span class="number">35</span>:         <span class="keyword">case</span> ResponseCode.SUCCESS: {</div><div class="line"><span class="number">36</span>:             <span class="keyword">return</span>;</div><div class="line"><span class="number">37</span>:         }</div><div class="line"><span class="number">38</span>:         <span class="keyword">default</span>:</div><div class="line"><span class="number">39</span>:             <span class="keyword">break</span>;</div><div class="line"><span class="number">40</span>:     }</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQBrokerException(response.getCode(), response.getRemark());</div><div class="line"><span class="number">43</span>: }</div></pre></td></tr></table></figure>
<h1 id="8&#x3001;Consumer-&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;"><a href="#8&#x3001;Consumer-&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;" class="headerlink" title="8&#x3001;Consumer &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;"></a>8&#x3001;Consumer &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</h1><h2 id="OffsetStore"><a href="#OffsetStore" class="headerlink" title="OffsetStore"></a>OffsetStore</h2><p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_04/07.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_04/07.png" alt="OffsetStore&#x7C7B;&#x56FE;.png" class="ui centered image"></a></p>
<ul class="ui list">
<li><code>RemoteBrokerOffsetStore</code> &#xFF1A;<code>Consumer</code> <strong>&#x96C6;&#x7FA4;&#x6A21;&#x5F0F;</strong> &#x4E0B;&#xFF0C;&#x4F7F;&#x7528;&#x8FDC;&#x7A0B; <code>Broker</code> &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;</li>
<li><code>LocalFileOffsetStore</code> &#xFF1A;<code>Consumer</code> <strong>&#x5E7F;&#x64AD;&#x6A21;&#x5F0F;</strong>&#x4E0B;&#xFF0C;&#x4F7F;&#x7528;&#x672C;&#x5730; <code>&#x6587;&#x4EF6;</code> &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;</li>
</ul>
<h3 id="OffsetStore-load-&#x2026;"><a href="#OffsetStore-load-&#x2026;" class="headerlink" title="OffsetStore#load(&#x2026;)"></a>OffsetStore#load(&#x2026;)</h3><h4 id="LocalFileOffsetStore-load-&#x2026;"><a href="#LocalFileOffsetStore-load-&#x2026;" class="headerlink" title="LocalFileOffsetStore#load(&#x2026;)"></a>LocalFileOffsetStore#load(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>{</div><div class="line"> <span class="number">3</span>:     <span class="comment">// &#x4ECE;&#x672C;&#x5730;&#x786C;&#x76D8;&#x8BFB;&#x53D6;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</span></div><div class="line"> <span class="number">4</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class="keyword">this</span>.readLocalOffset();</div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (offsetSerializeWrapper != <span class="keyword">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">6</span>:         offsetTable.putAll(offsetSerializeWrapper.getOffsetTable());</div><div class="line"> <span class="number">7</span>: </div><div class="line"> <span class="number">8</span>:         <span class="comment">// &#x6253;&#x5370;&#x6BCF;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7684;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</span></div><div class="line"> <span class="number">9</span>:         <span class="keyword">for</span> (MessageQueue mq : offsetSerializeWrapper.getOffsetTable().keySet()) {</div><div class="line"><span class="number">10</span>:             AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class="line"><span class="number">11</span>:             log.info(<span class="string">&quot;load consumer&apos;s offset, {} {} {}&quot;</span>,</div><div class="line"><span class="number">12</span>:                 <span class="keyword">this</span>.groupName,</div><div class="line"><span class="number">13</span>:                 mq,</div><div class="line"><span class="number">14</span>:                 offset.get());</div><div class="line"><span class="number">15</span>:         }</div><div class="line"><span class="number">16</span>:     }</div><div class="line"><span class="number">17</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x4ECE;&#x672C;&#x5730;&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x5230;&#x5185;&#x5B58;&#x3002;</li>
</ul>
<h5 id="OffsetSerializeWrapper"><a href="#OffsetSerializeWrapper" class="headerlink" title="OffsetSerializeWrapper"></a>OffsetSerializeWrapper</h5><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OffsetSerializeWrapper</span> <span class="keyword">extends</span> <span class="title">RemotingSerializable</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable =</div><div class="line"> <span class="number">3</span>:             <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; <span class="title">getOffsetTable</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">6</span>:         <span class="keyword">return</span> offsetTable;</div><div class="line"> <span class="number">7</span>:     }</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOffsetTable</span><span class="params">(ConcurrentHashMap&lt;MessageQueue, AtomicLong&gt; offsetTable)</span> </span>{</div><div class="line"><span class="number">10</span>:         <span class="keyword">this</span>.offsetTable = offsetTable;</div><div class="line"><span class="number">11</span>:     }</div><div class="line"><span class="number">12</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x672C;&#x5730; <code>Offset</code> &#x5B58;&#x50A8;&#x5E8F;&#x5217;&#x5316;&#x3002;</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">Yunai-MacdeMacBook-Pro-2:config yunai$ cat /Users/yunai/.rocketmq_offsets/192.168.17.0@DEFAULT/please_rename_unique_group_name_1/offsets.json</div><div class="line">{</div><div class="line">	<span class="string">&quot;offsetTable&quot;</span>:{{</div><div class="line">			<span class="string">&quot;brokerName&quot;</span>:<span class="string">&quot;broker-a&quot;</span>,</div><div class="line">			<span class="string">&quot;queueId&quot;</span>:3,</div><div class="line">			<span class="string">&quot;topic&quot;</span>:<span class="string">&quot;TopicTest&quot;</span></div><div class="line">		}:1470,{</div><div class="line">			<span class="string">&quot;brokerName&quot;</span>:<span class="string">&quot;broker-a&quot;</span>,</div><div class="line">			<span class="string">&quot;queueId&quot;</span>:2,</div><div class="line">			<span class="string">&quot;topic&quot;</span>:<span class="string">&quot;TopicTest&quot;</span></div><div class="line">		}:1471,{</div><div class="line">			<span class="string">&quot;brokerName&quot;</span>:<span class="string">&quot;broker-a&quot;</span>,</div><div class="line">			<span class="string">&quot;queueId&quot;</span>:1,</div><div class="line">			<span class="string">&quot;topic&quot;</span>:<span class="string">&quot;TopicTest&quot;</span></div><div class="line">		}:1470,{</div><div class="line">			<span class="string">&quot;brokerName&quot;</span>:<span class="string">&quot;broker-a&quot;</span>,</div><div class="line">			<span class="string">&quot;queueId&quot;</span>:0,</div><div class="line">			<span class="string">&quot;topic&quot;</span>:<span class="string">&quot;TopicTest&quot;</span></div><div class="line">		}:1470</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="RemoteBrokerOffsetStore-load-&#x2026;"><a href="#RemoteBrokerOffsetStore-load-&#x2026;" class="headerlink" title="RemoteBrokerOffsetStore#load(&#x2026;)"></a>RemoteBrokerOffsetStore#load(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">3</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x4E0D;&#x8FDB;&#x884C;&#x52A0;&#x8F7D;&#xFF0C;&#x5B9E;&#x9645;&#x8BFB;&#x53D6;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x65F6;&#xFF0C;&#x4ECE; <code>Broker</code> &#x83B7;&#x53D6;&#x3002;</li>
</ul>
<h3 id="OffsetStore-readOffset-&#x2026;"><a href="#OffsetStore-readOffset-&#x2026;" class="headerlink" title="OffsetStore#readOffset(&#x2026;)"></a>OffsetStore#readOffset(&#x2026;)</h3><p>&#x8BFB;&#x53D6;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x7C7B;&#x578B;&#xFF1A;</p>
<ul class="ui list">
<li><code>READ_FROM_MEMORY</code> &#xFF1A;&#x4ECE;&#x5185;&#x5B58;&#x8BFB;&#x53D6;&#x3002;</li>
<li><code>READ_FROM_STORE</code> &#xFF1A;&#x4ECE;&#x5B58;&#x50A8;( <code>Broker</code> &#x6216; <code>&#x6587;&#x4EF6;</code> )&#x8BFB;&#x53D6;&#x3002;</li>
<li><code>MEMORY_FIRST_THEN_STORE</code> &#xFF1A;&#x4F18;&#x5148;&#x4ECE;&#x5185;&#x5B58;&#x8BFB;&#x53D6;&#xFF0C;&#x8BFB;&#x53D6;&#x4E0D;&#x5230;&#xFF0C;&#x4ECE;&#x5B58;&#x50A8;&#x8BFB;&#x53D6;&#x3002;</li>
</ul>
<h4 id="LocalFileOffsetStore-readOffset-&#x2026;"><a href="#LocalFileOffsetStore-readOffset-&#x2026;" class="headerlink" title="LocalFileOffsetStore#readOffset(&#x2026;)"></a>LocalFileOffsetStore#readOffset(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">readOffset</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ReadOffsetType type)</span> </span>{</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">4</span>:         <span class="keyword">switch</span> (type) {</div><div class="line"> <span class="number">5</span>:             <span class="keyword">case</span> MEMORY_FIRST_THEN_STORE:</div><div class="line"> <span class="number">6</span>:             <span class="keyword">case</span> READ_FROM_MEMORY: {</div><div class="line"> <span class="number">7</span>:                 AtomicLong offset = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">8</span>:                 <span class="keyword">if</span> (offset != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">10</span>:                 } <span class="keyword">else</span> <span class="keyword">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) {</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">12</span>:                 }</div><div class="line"><span class="number">13</span>:             }</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> READ_FROM_STORE: {</div><div class="line"><span class="number">15</span>:                 OffsetSerializeWrapper offsetSerializeWrapper;</div><div class="line"><span class="number">16</span>:                 <span class="keyword">try</span> {</div><div class="line"><span class="number">17</span>:                     offsetSerializeWrapper = <span class="keyword">this</span>.readLocalOffset();</div><div class="line"><span class="number">18</span>:                 } <span class="keyword">catch</span> (MQClientException e) {</div><div class="line"><span class="number">19</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">20</span>:                 }</div><div class="line"><span class="number">21</span>:                 <span class="keyword">if</span> (offsetSerializeWrapper != <span class="keyword">null</span> &amp;&amp; offsetSerializeWrapper.getOffsetTable() != <span class="keyword">null</span>) {</div><div class="line"><span class="number">22</span>:                     AtomicLong offset = offsetSerializeWrapper.getOffsetTable().get(mq);</div><div class="line"><span class="number">23</span>:                     <span class="keyword">if</span> (offset != <span class="keyword">null</span>) {</div><div class="line"><span class="number">24</span>:                         <span class="keyword">this</span>.updateOffset(mq, offset.get(), <span class="keyword">false</span>);</div><div class="line"><span class="number">25</span>:                         <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">26</span>:                     }</div><div class="line"><span class="number">27</span>:                 }</div><div class="line"><span class="number">28</span>:             }</div><div class="line"><span class="number">29</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">30</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">31</span>:         }</div><div class="line"><span class="number">32</span>:     }</div><div class="line"><span class="number">33</span>: </div><div class="line"><span class="number">34</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">35</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x7B2C; 16 &#x884C; &#xFF1A;&#x4ECE; <code>&#x6587;&#x4EF6;</code> &#x8BFB;&#x53D6;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;</li>
</ul>
<h4 id="RemoteBrokerOffsetStore-readOffset-&#x2026;"><a href="#RemoteBrokerOffsetStore-readOffset-&#x2026;" class="headerlink" title="RemoteBrokerOffsetStore#readOffset(&#x2026;)"></a>RemoteBrokerOffsetStore#readOffset(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">readOffset</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ReadOffsetType type)</span> </span>{</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">4</span>:         <span class="keyword">switch</span> (type) {</div><div class="line"> <span class="number">5</span>:             <span class="keyword">case</span> MEMORY_FIRST_THEN_STORE:</div><div class="line"> <span class="number">6</span>:             <span class="keyword">case</span> READ_FROM_MEMORY: {</div><div class="line"> <span class="number">7</span>:                 AtomicLong offset = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">8</span>:                 <span class="keyword">if</span> (offset != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">9</span>:                     <span class="keyword">return</span> offset.get();</div><div class="line"><span class="number">10</span>:                 } <span class="keyword">else</span> <span class="keyword">if</span> (ReadOffsetType.READ_FROM_MEMORY == type) {</div><div class="line"><span class="number">11</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">12</span>:                 }</div><div class="line"><span class="number">13</span>:             }</div><div class="line"><span class="number">14</span>:             <span class="keyword">case</span> READ_FROM_STORE: {</div><div class="line"><span class="number">15</span>:                 <span class="keyword">try</span> {</div><div class="line"><span class="number">16</span>:                     <span class="keyword">long</span> brokerOffset = <span class="keyword">this</span>.fetchConsumeOffsetFromBroker(mq);</div><div class="line"><span class="number">17</span>:                     AtomicLong offset = <span class="keyword">new</span> AtomicLong(brokerOffset);</div><div class="line"><span class="number">18</span>:                     <span class="keyword">this</span>.updateOffset(mq, offset.get(), <span class="keyword">false</span>);</div><div class="line"><span class="number">19</span>:                     <span class="keyword">return</span> brokerOffset;</div><div class="line"><span class="number">20</span>:                 }</div><div class="line"><span class="number">21</span>:                 <span class="comment">// No offset in broker</span></div><div class="line"><span class="number">22</span>:                 <span class="keyword">catch</span> (MQBrokerException e) {</div><div class="line"><span class="number">23</span>:                     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">24</span>:                 }</div><div class="line"><span class="number">25</span>:                 <span class="comment">//Other exceptions</span></div><div class="line"><span class="number">26</span>:                 <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">27</span>:                     log.warn(<span class="string">&quot;fetchConsumeOffsetFromBroker exception, &quot;</span> + mq, e);</div><div class="line"><span class="number">28</span>:                     <span class="keyword">return</span> -<span class="number">2</span>;</div><div class="line"><span class="number">29</span>:                 }</div><div class="line"><span class="number">30</span>:             }</div><div class="line"><span class="number">31</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">32</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">33</span>:         }</div><div class="line"><span class="number">34</span>:     }</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">37</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x7B2C; 16 &#x884C; &#xFF1A;&#x4ECE; <code>Broker</code> &#x8BFB;&#x53D6;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;</li>
</ul>
<h3 id="OffsetStore-updateOffset-&#x2026;"><a href="#OffsetStore-updateOffset-&#x2026;" class="headerlink" title="OffsetStore#updateOffset(&#x2026;)"></a>OffsetStore#updateOffset(&#x2026;)</h3><p>&#x8BE5;&#x65B9;&#x6CD5; <code>RemoteBrokerOffsetStore</code> &#x4E0E; <code>LocalFileOffsetStore</code> &#x5B9E;&#x73B0;&#x76F8;&#x540C;&#x3002;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateOffset</span><span class="params">(MessageQueue mq, <span class="keyword">long</span> offset, <span class="keyword">boolean</span> increaseOnly)</span> </span>{</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mq != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">4</span>:         AtomicLong offsetOld = <span class="keyword">this</span>.offsetTable.get(mq);</div><div class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == offsetOld) {</div><div class="line"> <span class="number">6</span>:             offsetOld = <span class="keyword">this</span>.offsetTable.putIfAbsent(mq, <span class="keyword">new</span> AtomicLong(offset));</div><div class="line"> <span class="number">7</span>:         }</div><div class="line"> <span class="number">8</span>: </div><div class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> != offsetOld) {</div><div class="line"><span class="number">10</span>:             <span class="keyword">if</span> (increaseOnly) {</div><div class="line"><span class="number">11</span>:                 MixAll.compareAndIncreaseOnly(offsetOld, offset);</div><div class="line"><span class="number">12</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">13</span>:                 offsetOld.set(offset);</div><div class="line"><span class="number">14</span>:             }</div><div class="line"><span class="number">15</span>:         }</div><div class="line"><span class="number">16</span>:     }</div><div class="line"><span class="number">17</span>: }</div></pre></td></tr></table></figure>
<h3 id="OffsetStore-persistAll-&#x2026;"><a href="#OffsetStore-persistAll-&#x2026;" class="headerlink" title="OffsetStore#persistAll(&#x2026;)"></a>OffsetStore#persistAll(&#x2026;)</h3><h4 id="LocalFileOffsetStore-persistAll-&#x2026;"><a href="#LocalFileOffsetStore-persistAll-&#x2026;" class="headerlink" title="LocalFileOffsetStore#persistAll(&#x2026;)"></a>LocalFileOffsetStore#persistAll(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistAll</span><span class="params">(Set&lt;MessageQueue&gt; mqs)</span> </span>{</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == mqs || mqs.isEmpty())</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     OffsetSerializeWrapper offsetSerializeWrapper = <span class="keyword">new</span> OffsetSerializeWrapper();</div><div class="line"> <span class="number">7</span>:     <span class="keyword">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class="keyword">this</span>.offsetTable.entrySet()) {</div><div class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (mqs.contains(entry.getKey())) {</div><div class="line"> <span class="number">9</span>:             AtomicLong offset = entry.getValue();</div><div class="line"><span class="number">10</span>:             offsetSerializeWrapper.getOffsetTable().put(entry.getKey(), offset);</div><div class="line"><span class="number">11</span>:         }</div><div class="line"><span class="number">12</span>:     }</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:     String jsonString = offsetSerializeWrapper.toJson(<span class="keyword">true</span>);</div><div class="line"><span class="number">15</span>:     <span class="keyword">if</span> (jsonString != <span class="keyword">null</span>) {</div><div class="line"><span class="number">16</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">17</span>:             MixAll.string2File(jsonString, <span class="keyword">this</span>.storePath);</div><div class="line"><span class="number">18</span>:         } <span class="keyword">catch</span> (IOException e) {</div><div class="line"><span class="number">19</span>:             log.error(<span class="string">&quot;persistAll consumer offset Exception, &quot;</span> + <span class="keyword">this</span>.storePath, e);</div><div class="line"><span class="number">20</span>:         }</div><div class="line"><span class="number">21</span>:     }</div><div class="line"><span class="number">22</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x6301;&#x4E45;&#x5316;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;<strong>&#x5C06;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x5199;&#x5165;&#x6587;&#x4EF6;</strong>&#x3002;</li>
</ul>
<h4 id="RemoteBrokerOffsetStore-persistAll-&#x2026;"><a href="#RemoteBrokerOffsetStore-persistAll-&#x2026;" class="headerlink" title="RemoteBrokerOffsetStore#persistAll(&#x2026;)"></a>RemoteBrokerOffsetStore#persistAll(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">persistAll</span><span class="params">(Set&lt;MessageQueue&gt; mqs)</span> </span>{</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == mqs || mqs.isEmpty())</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</div><div class="line"> <span class="number">5</span>: </div><div class="line"> <span class="number">6</span>:     <span class="comment">// &#x6301;&#x4E45;&#x5316;&#x6D88;&#x606F;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">7</span>:     <span class="keyword">final</span> HashSet&lt;MessageQueue&gt; unusedMQ = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (!mqs.isEmpty()) {</div><div class="line"> <span class="number">9</span>:         <span class="keyword">for</span> (Map.Entry&lt;MessageQueue, AtomicLong&gt; entry : <span class="keyword">this</span>.offsetTable.entrySet()) {</div><div class="line"><span class="number">10</span>:             MessageQueue mq = entry.getKey();</div><div class="line"><span class="number">11</span>:             AtomicLong offset = entry.getValue();</div><div class="line"><span class="number">12</span>:             <span class="keyword">if</span> (offset != <span class="keyword">null</span>) {</div><div class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (mqs.contains(mq)) {</div><div class="line"><span class="number">14</span>:                     <span class="keyword">try</span> {</div><div class="line"><span class="number">15</span>:                         <span class="keyword">this</span>.updateConsumeOffsetToBroker(mq, offset.get());</div><div class="line"><span class="number">16</span>:                         log.info(<span class="string">&quot;[persistAll] Group: {} ClientId: {} updateConsumeOffsetToBroker {} {}&quot;</span>,</div><div class="line"><span class="number">17</span>:                             <span class="keyword">this</span>.groupName,</div><div class="line"><span class="number">18</span>:                             <span class="keyword">this</span>.mQClientFactory.getClientId(),</div><div class="line"><span class="number">19</span>:                             mq,</div><div class="line"><span class="number">20</span>:                             offset.get());</div><div class="line"><span class="number">21</span>:                     } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">22</span>:                         log.error(<span class="string">&quot;updateConsumeOffsetToBroker exception, &quot;</span> + mq.toString(), e);</div><div class="line"><span class="number">23</span>:                     }</div><div class="line"><span class="number">24</span>:                 } <span class="keyword">else</span> {</div><div class="line"><span class="number">25</span>:                     unusedMQ.add(mq);</div><div class="line"><span class="number">26</span>:                 }</div><div class="line"><span class="number">27</span>:             }</div><div class="line"><span class="number">28</span>:         }</div><div class="line"><span class="number">29</span>:     }</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:     <span class="comment">// &#x79FB;&#x9664;&#x4E0D;&#x9002;&#x7528;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;</span></div><div class="line"><span class="number">32</span>:     <span class="keyword">if</span> (!unusedMQ.isEmpty()) {</div><div class="line"><span class="number">33</span>:         <span class="keyword">for</span> (MessageQueue mq : unusedMQ) {</div><div class="line"><span class="number">34</span>:             <span class="keyword">this</span>.offsetTable.remove(mq);</div><div class="line"><span class="number">35</span>:             log.info(<span class="string">&quot;remove unused mq, {}, {}&quot;</span>, mq, <span class="keyword">this</span>.groupName);</div><div class="line"><span class="number">36</span>:         }</div><div class="line"><span class="number">37</span>:     }</div><div class="line"><span class="number">38</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x6301;&#x4E45;&#x5316;&#x6307;&#x5B9A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x6570;&#x7EC4;&#x7684;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x5230; <code>Broker</code>&#xFF0C;&#x5E76;&#x79FB;&#x9664;&#x975E;&#x6307;&#x5B9A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
</ul>
<h4 id="MQClientInstance-persistAllConsumerOffset-&#x2026;"><a href="#MQClientInstance-persistAllConsumerOffset-&#x2026;" class="headerlink" title="MQClientInstance#persistAllConsumerOffset(&#x2026;)"></a>MQClientInstance#persistAllConsumerOffset(&#x2026;)</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startScheduledTask</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="comment">// &#x5B9A;&#x65F6;&#x540C;&#x6B65;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</span></div><div class="line"> <span class="number">3</span>:     <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() {</div><div class="line"> <span class="number">4</span>: </div><div class="line"> <span class="number">5</span>:         <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">7</span>:             <span class="keyword">try</span> {</div><div class="line"> <span class="number">8</span>:                 MQClientInstance.<span class="keyword">this</span>.cleanOfflineBroker();</div><div class="line"> <span class="number">9</span>:                 MQClientInstance.<span class="keyword">this</span>.sendHeartbeatToAllBrokerWithLock();</div><div class="line"><span class="number">10</span>:             } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">11</span>:                 log.error(<span class="string">&quot;ScheduledTask sendHeartbeatToAllBroker exception&quot;</span>, e);</div><div class="line"><span class="number">12</span>:             }</div><div class="line"><span class="number">13</span>:         }</div><div class="line"><span class="number">14</span>:     }, <span class="number">1000</span>, <span class="keyword">this</span>.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">15</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x5B9A;&#x65F6;&#x8FDB;&#x884C;&#x6301;&#x4E45;&#x5316;&#xFF0C;&#x9ED8;&#x8BA4;&#x5468;&#x671F;&#xFF1A;5000ms&#x3002;</li>
<li><strong>&#x91CD;&#x8981;&#x8BF4;&#x660E; &#xFF1A;</strong><ul>
<li><strong>&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x6301;&#x4E45;&#x5316;&#x4E0D;&#x4EC5;&#x4EC5;&#x53EA;&#x6709;&#x5B9A;&#x65F6;&#x6301;&#x4E45;&#x5316;&#xFF0C;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3001;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7B49;&#x7B49;&#x64CD;&#x4F5C;&#xFF0C;&#x90FD;&#x4F1A;&#x8FDB;&#x884C;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x6301;&#x4E45;&#x5316;&#x3002;</strong> </li>
<li><strong>&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x6301;&#x4E45;&#x5316;&#x4E0D;&#x4EC5;&#x4EC5;&#x53EA;&#x6709;&#x5B9A;&#x65F6;&#x6301;&#x4E45;&#x5316;&#xFF0C;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3001;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7B49;&#x7B49;&#x64CD;&#x4F5C;&#xFF0C;&#x90FD;&#x4F1A;&#x8FDB;&#x884C;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x6301;&#x4E45;&#x5316;&#x3002;</strong> </li>
<li><strong>&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x6301;&#x4E45;&#x5316;&#x4E0D;&#x4EC5;&#x4EC5;&#x53EA;&#x6709;&#x5B9A;&#x65F6;&#x6301;&#x4E45;&#x5316;&#xFF0C;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x3001;&#x5206;&#x914D;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7B49;&#x7B49;&#x64CD;&#x4F5C;&#xFF0C;&#x90FD;&#x4F1A;&#x8FDB;&#x884C;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x6301;&#x4E45;&#x5316;&#x3002;</strong> </li>
</ul>
</li>
</ul>
<h1 id="9&#x3001;&#x7ED3;&#x5C3E;"><a href="#9&#x3001;&#x7ED3;&#x5C3E;" class="headerlink" title="9&#x3001;&#x7ED3;&#x5C3E;"></a>9&#x3001;&#x7ED3;&#x5C3E;</h1><p>&#x1F608;&#x53EF;&#x80FD;&#x662F;&#x672C;&#x7CFB;&#x5217;&#x6700;&#x957F;&#x7684;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x5982;&#x6709;&#x8868;&#x8FBE;&#x9519;&#x8BEF;&#x548C;&#x4E0D;&#x6E05;&#x6670;&#xFF0C;&#x8BF7;&#x591A;&#x591A;&#x89C1;&#x8C05;&#x3002;<br>&#x611F;&#x8C22;&#x5BF9;&#x672C;&#x7CFB;&#x5217;&#x7684;&#x9605;&#x8BFB;&#x3001;&#x6536;&#x85CF;&#x3001;&#x70B9;&#x8D5E;&#x3001;&#x5206;&#x4EAB;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x7FFB;&#x5230;&#x7ED3;&#x5C3E;&#x3002;&#x1F61C;&#x771F;&#x7684;&#x6709;&#x4E22;&#x4E22;&#x957F;&#x3002;</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1、概述"><span class="toc-number">1.</span> <span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2、Consumer"><span class="toc-number">2.</span> <span class="toc-text">2、Consumer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3、PushConsumer-一览"><span class="toc-number">3.</span> <span class="toc-text">3、PushConsumer 一览</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4、PushConsumer-订阅"><span class="toc-number">4.</span> <span class="toc-text">4、PushConsumer 订阅</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-subscribe-…"><span class="toc-number">4.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#subscribe(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FilterAPI-buildSubscriptionData-…"><span class="toc-number">4.1.1.</span> <span class="toc-text">FilterAPI.buildSubscriptionData(…)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumer-registerMessageListener-…"><span class="toc-number">4.2.</span> <span class="toc-text">DefaultMQPushConsumer#registerMessageListener(…)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5、PushConsumer-消息队列分配"><span class="toc-number">5.</span> <span class="toc-text">5、PushConsumer 消息队列分配</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalanceService"><span class="toc-number">5.1.</span> <span class="toc-text">RebalanceService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQClientInstance-doRebalance-…"><span class="toc-number">5.2.</span> <span class="toc-text">MQClientInstance#doRebalance(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-doRebalance-…"><span class="toc-number">5.3.</span> <span class="toc-text">DefaultMQPushConsumerImpl#doRebalance(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalanceImpl-doRebalance-…"><span class="toc-number">5.4.</span> <span class="toc-text">RebalanceImpl#doRebalance(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalanceImpl-rebalanceByTopic-…"><span class="toc-number">5.4.1.</span> <span class="toc-text">RebalanceImpl#rebalanceByTopic(…)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalanceImpl-removeUnnecessaryMessageQueue-…"><span class="toc-number">5.4.2.</span> <span class="toc-text">RebalanceImpl#removeUnnecessaryMessageQueue(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RebalancePushImpl-removeUnnecessaryMessageQueue-…"><span class="toc-number">5.4.2.1.</span> <span class="toc-text">RebalancePushImpl#removeUnnecessaryMessageQueue(…)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PullConsumer-RebalancePullImpl-removeUnnecessaryMessageQueue-…"><span class="toc-number">5.4.2.2.</span> <span class="toc-text">[PullConsumer] RebalancePullImpl#removeUnnecessaryMessageQueue(…)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RebalancePushImpl-dispatchPullRequest-…"><span class="toc-number">5.4.3.</span> <span class="toc-text">RebalancePushImpl#dispatchPullRequest(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DefaultMQPushConsumerImpl-executePullRequestImmediately-…"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#executePullRequestImmediately(…)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AllocateMessageQueueStrategy"><span class="toc-number">5.4.4.</span> <span class="toc-text">AllocateMessageQueueStrategy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueAveragely"><span class="toc-number">5.4.4.1.</span> <span class="toc-text">AllocateMessageQueueAveragely</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueByMachineRoom"><span class="toc-number">5.4.4.2.</span> <span class="toc-text">AllocateMessageQueueByMachineRoom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueAveragelyByCircle"><span class="toc-number">5.4.4.3.</span> <span class="toc-text">AllocateMessageQueueAveragelyByCircle</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AllocateMessageQueueByConfig"><span class="toc-number">5.4.4.4.</span> <span class="toc-text">AllocateMessageQueueByConfig</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5、PushConsumer-消费进度读取"><span class="toc-number">6.</span> <span class="toc-text">5、PushConsumer 消费进度读取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RebalancePushImpl-computePullFromWhere-…"><span class="toc-number">6.1.</span> <span class="toc-text">RebalancePushImpl#computePullFromWhere(…)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PullConsumer-RebalancePullImpl-computePullFromWhere-…"><span class="toc-number">6.2.</span> <span class="toc-text">[PullConsumer] RebalancePullImpl#computePullFromWhere(…)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6、PushConsumer-拉取消息"><span class="toc-number">7.</span> <span class="toc-text">6、PushConsumer 拉取消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PullMessageService"><span class="toc-number">7.1.</span> <span class="toc-text">PullMessageService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-pullMessage-…"><span class="toc-number">7.2.</span> <span class="toc-text">DefaultMQPushConsumerImpl#pullMessage(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PullAPIWrapper-pullKernelImpl-…"><span class="toc-number">7.2.1.</span> <span class="toc-text">PullAPIWrapper#pullKernelImpl(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PullAPIWrapper-recalculatePullFromWhichNode-…"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">PullAPIWrapper#recalculatePullFromWhichNode(…)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQClientInstance-findBrokerAddressInSubscribe-…"><span class="toc-number">7.2.1.2.</span> <span class="toc-text">MQClientInstance#findBrokerAddressInSubscribe(…)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PullAPIWrapper-processPullResult-…"><span class="toc-number">7.2.2.</span> <span class="toc-text">PullAPIWrapper#processPullResult(…)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-putMessage-…"><span class="toc-number">7.2.3.</span> <span class="toc-text">ProcessQueue#putMessage(…)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">7.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6、PushConsumer-消费消息"><span class="toc-number">8.</span> <span class="toc-text">6、PushConsumer 消费消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-提交消费请求"><span class="toc-number">8.1.</span> <span class="toc-text">ConsumeMessageConcurrentlyService 提交消费请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-submitConsumeRequest-…"><span class="toc-number">8.1.1.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#submitConsumeRequest(…)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-submitConsumeRequestLater"><span class="toc-number">8.1.2.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#submitConsumeRequestLater</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeRequest"><span class="toc-number">8.2.</span> <span class="toc-text">ConsumeRequest</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-processConsumeResult-…"><span class="toc-number">8.3.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#processConsumeResult(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-removeMessage-…"><span class="toc-number">8.3.1.</span> <span class="toc-text">ProcessQueue#removeMessage(…)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConsumeMessageConcurrentlyService-cleanExpireMsg-…"><span class="toc-number">8.4.</span> <span class="toc-text">ConsumeMessageConcurrentlyService#cleanExpireMsg(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessQueue-cleanExpiredMsg-…"><span class="toc-number">8.4.1.</span> <span class="toc-text">ProcessQueue#cleanExpiredMsg(…)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7、PushConsumer-发回消费失败消息"><span class="toc-number">9.</span> <span class="toc-text">7、PushConsumer 发回消费失败消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQPushConsumerImpl-sendMessageBack-…"><span class="toc-number">9.1.</span> <span class="toc-text">DefaultMQPushConsumerImpl#sendMessageBack(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MQClientAPIImpl-consumerSendMessageBack-…"><span class="toc-number">9.1.1.</span> <span class="toc-text">MQClientAPIImpl#consumerSendMessageBack(…)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8、Consumer-消费进度"><span class="toc-number">10.</span> <span class="toc-text">8、Consumer 消费进度</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#OffsetStore"><span class="toc-number">10.1.</span> <span class="toc-text">OffsetStore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-load-…"><span class="toc-number">10.1.1.</span> <span class="toc-text">OffsetStore#load(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-load-…"><span class="toc-number">10.1.1.1.</span> <span class="toc-text">LocalFileOffsetStore#load(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#OffsetSerializeWrapper"><span class="toc-number">10.1.1.1.1.</span> <span class="toc-text">OffsetSerializeWrapper</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-load-…"><span class="toc-number">10.1.1.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#load(…)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-readOffset-…"><span class="toc-number">10.1.2.</span> <span class="toc-text">OffsetStore#readOffset(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-readOffset-…"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">LocalFileOffsetStore#readOffset(…)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-readOffset-…"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#readOffset(…)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-updateOffset-…"><span class="toc-number">10.1.3.</span> <span class="toc-text">OffsetStore#updateOffset(…)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OffsetStore-persistAll-…"><span class="toc-number">10.1.4.</span> <span class="toc-text">OffsetStore#persistAll(…)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LocalFileOffsetStore-persistAll-…"><span class="toc-number">10.1.4.1.</span> <span class="toc-text">LocalFileOffsetStore#persistAll(…)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RemoteBrokerOffsetStore-persistAll-…"><span class="toc-number">10.1.4.2.</span> <span class="toc-text">RemoteBrokerOffsetStore#persistAll(…)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MQClientInstance-persistAllConsumerOffset-…"><span class="toc-number">10.1.4.3.</span> <span class="toc-text">MQClientInstance#persistAllConsumerOffset(…)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9、结尾"><span class="toc-number">11.</span> <span class="toc-text">9、结尾</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&text=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&title=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&is_video=false&description=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RocketMQ 源码分析 —— Message 拉取与消费（下）&body=Check out this article: http://www.yunai.me/RocketMQ/message-pull-and-consume-second/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&title=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&title=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&title=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&title=RocketMQ 源码分析 —— Message 拉取与消费（下）" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/&name=RocketMQ 源码分析 —— Message 拉取与消费（下）&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 王文斌
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO 待优化：过滤 爬虫
        url = $('#actions .icon').attr('href').trim(); // 文章url
//        alert(url);
        title = $('.posttitle').text().trim(); // 文章标题
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // 插入次数
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // 插入次数
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // 获取uid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip 浏览器无法获取
        // time 服务端已经记录
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO 待优化：此处性能较差，可能
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // 判断是否在文章页
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // 增加文章访问次数
                addCount(Counter);
            }
            // 记录访问日志
            addVisitLog();
            // 计算多少人访问
            countVisitLog();
        }, 1000);
    });
</script>
