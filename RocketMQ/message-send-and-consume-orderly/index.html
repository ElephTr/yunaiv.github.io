<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMQ 源码分析 —— Message 顺序发送与消费">
<meta property="og:url" content="http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/index.html">
<meta property="og:site_name" content="芋艿V的博客">
<meta property="og:description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta property="og:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_05_13/01.png">
<meta property="og:updated_time" content="2017-07-20T01:40:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RocketMQ 源码分析 —— Message 顺序发送与消费">
<meta name="twitter:description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta name="twitter:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>RocketMQ 源码分析 —— Message 顺序发送与消费</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- 百度统计 -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- 百度站长-被动推送 -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360搜索-自动收录 -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/RocketMQ/high-availability/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$(" #i-prev").toggle();"="" onmouseout="$("></i></a></li>
        
        
        <li><a class="icon" href="/RocketMQ/store-init-and-shutdown/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&text=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&is_video=false&description=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RocketMQ 源码分析 —— Message 顺序发送与消费&body=Check out this article: http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&name=RocketMQ 源码分析 —— Message 顺序发送与消费&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-概述"><span class="toc-number">1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Producer-顺序发送"><span class="toc-number">2.</span> <span class="toc-text">2. Producer 顺序发送</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Consumer-严格顺序消费"><span class="toc-number">3.</span> <span class="toc-text">3. Consumer 严格顺序消费</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-获得-锁定-消息队列"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 获得(锁定)消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-移除消息队列"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 移除消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-消费消息队列"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 消费消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-消费消息"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1.1 消费消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-处理消费结果"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.1.2 处理消费结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-13-消息处理队列核心方法"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.13 消息处理队列核心方法</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        RocketMQ 源码分析 —— Message 顺序发送与消费
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">芋艿V的博客</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-05-12T16:00:00.000Z" itemprop="datePublished">2017-05-13</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><a class="magnific-img" href="http://www.yunai.me/images/common/wechat_mp.jpeg"><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="" class="ui centered image"></a></p>
<blockquote>
<p>&#x1F642;&#x1F642;&#x1F642;&#x5173;&#x6CE8;<strong>&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x53F7;&#xFF1A;&#x3010;&#x828B;&#x827F;&#x7684;&#x540E;&#x7AEF;&#x5C0F;&#x5C4B;&#x3011;</strong>&#x6709;&#x798F;&#x5229;&#xFF1A;  </p>
<ol class="ui list">
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>&#x6240;&#x6709;</strong>&#x6E90;&#x7801;&#x5206;&#x6790;&#x6587;&#x7AE0;&#x5217;&#x8868;  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>&#x4E2D;&#x6587;&#x6CE8;&#x91CA;&#x6E90;&#x7801; GitHub &#x5730;&#x5740;</strong>  </li>
<li>&#x60A8;&#x5BF9;&#x4E8E;&#x6E90;&#x7801;&#x7684;&#x7591;&#x95EE;&#x6BCF;&#x6761;&#x7559;&#x8A00;<strong>&#x90FD;</strong>&#x5C06;&#x5F97;&#x5230;<strong>&#x8BA4;&#x771F;</strong>&#x56DE;&#x590D;&#x3002;<strong>&#x751A;&#x81F3;&#x4E0D;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x8BFB;&#x6E90;&#x7801;&#x4E5F;&#x53EF;&#x4EE5;&#x8BF7;&#x6559;&#x5662;</strong>&#x3002;  </li>
<li><strong>&#x65B0;&#x7684;</strong>&#x6E90;&#x7801;&#x89E3;&#x6790;&#x6587;&#x7AE0;<strong>&#x5B9E;&#x65F6;</strong>&#x6536;&#x5230;&#x901A;&#x77E5;&#x3002;<strong>&#x6BCF;&#x5468;&#x66F4;&#x65B0;&#x4E00;&#x7BC7;&#x5DE6;&#x53F3;</strong>&#x3002;</li>
</ol>
</blockquote>
<hr>
<ul class="ui list">
<li><a href="#">1. &#x6982;&#x8FF0;</a></li>
<li><a href="#">2. Producer &#x987A;&#x5E8F;&#x53D1;&#x9001;</a></li>
<li><a href="#">3. Consumer &#x987A;&#x5E8F;&#x6D88;&#x8D39;</a><ul>
<li><a href="#">3.1 &#x83B7;&#x5F97;(&#x9501;&#x5B9A;)&#x6D88;&#x606F;&#x961F;&#x5217;</a></li>
<li><a href="#">3.2 &#x79FB;&#x9664;&#x6D88;&#x606F;&#x961F;&#x5217;</a></li>
<li><a href="#">3.3 &#x6D88;&#x8D39;&#x6D88;&#x606F;&#x961F;&#x5217;</a><ul>
<li><a href="#">3.1.1 &#x6D88;&#x8D39;&#x6D88;&#x606F;</a></li>
<li><a href="#">3.1.2 &#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;</a></li>
<li><a href="#">3.13 &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="1-&#x6982;&#x8FF0;"><a href="#1-&#x6982;&#x8FF0;" class="headerlink" title="1. &#x6982;&#x8FF0;"></a>1. &#x6982;&#x8FF0;</h1><p><strong>&#x5EFA;&#x8BAE;</strong>&#x524D;&#x7F6E;&#x9605;&#x8BFB;&#x5185;&#x5BB9;&#xFF1A;</p>
<ul class="ui list">
<li><a href="http://www.yunai.me/RocketMQ/message-send-and-receive/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Message &#x53D1;&#x9001;&#x4E0E;&#x63A5;&#x6536;&#x300B;</a></li>
<li><a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-second/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Message &#x62C9;&#x53D6;&#x4E0E;&#x6D88;&#x8D39;&#xFF08;&#x4E0B;&#xFF09;&#x300B;</a></li>
</ul>
<p>&#x5F53;&#x7136;&#x5BF9; <code>Message</code> &#x53D1;&#x9001;&#x4E0E;&#x6D88;&#x8D39;&#x5DF2;&#x7ECF;&#x6709;&#x4E00;&#x5B9A;&#x4E86;&#x89E3;&#x7684;&#x540C;&#x5B66;&#xFF0C;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x8DF3;&#x8FC7;&#x3002;</p>
<hr>
<p><code>RocketMQ</code> &#x63D0;&#x4F9B;&#x4E86;&#x4E24;&#x79CD;&#x987A;&#x5E8F;&#x7EA7;&#x522B;&#xFF1A;</p>
<ul class="ui list">
<li>&#x666E;&#x901A;&#x987A;&#x5E8F;&#x6D88;&#x606F; &#xFF1A;<code>Producer</code> &#x5C06;&#x76F8;&#x5173;&#x8054;&#x7684;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x5230;&#x76F8;&#x540C;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li>&#x5B8C;&#x5168;&#x4E25;&#x683C;&#x987A;&#x5E8F; &#xFF1A;&#x5728; <code>&#x666E;&#x901A;&#x987A;&#x5E8F;&#x6D88;&#x606F;</code> &#x7684;&#x57FA;&#x7840;&#x4E0A;&#xFF0C;<code>Consumer</code> &#x4E25;&#x683C;&#x987A;&#x5E8F;&#x6D88;&#x8D39;&#x3002;</li>
</ul>
<p>&#x7EDD;&#x5927;&#x90E8;&#x5206;&#x573A;&#x666F;&#x4E0B;&#x53EA;&#x9700;&#x8981;&#x7528;&#x5230;<strong>&#x666E;&#x901A;&#x987A;&#x5E8F;&#x6D88;&#x606F;</strong>&#x3002;<br>&#x4F8B;&#x5982;&#x8BF4;&#xFF1A;&#x7ED9;&#x7528;&#x6237;&#x53D1;&#x9001;&#x77ED;&#x4FE1;&#x6D88;&#x606F; + &#x53D1;&#x9001;&#x63A8;&#x9001;&#x6D88;&#x606F;&#xFF0C;&#x5C06;&#x4E24;&#x6761;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x82E5;&#x5176;&#x4E2D;&#x4E00;&#x6761;&#x6D88;&#x606F;&#x961F;&#x5217;&#x6D88;&#x8D39;&#x8F83;&#x6162;&#x9020;&#x6210;&#x5835;&#x585E;&#xFF0C;&#x7528;&#x6237;&#x53EF;&#x80FD;&#x4F1A;&#x6536;&#x5230;&#x4E24;&#x6761;&#x6D88;&#x606F;&#x4F1A;&#x5B58;&#x5728;&#x4E00;&#x5B9A;&#x7684;&#x65F6;&#x95F4;&#x5DEE;&#xFF0C;&#x5E26;&#x6765;&#x7684;&#x4F53;&#x9A8C;&#x4F1A;&#x76F8;&#x5BF9;&#x8F83;&#x5DEE;&#x3002;&#x5F53;&#x7136;&#x7C7B;&#x4F3C;&#x8FD9;&#x79CD;&#x573A;&#x666F;&#xFF0C;&#x5373;&#x4F7F;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x65F6;&#x95F4;&#x5DEE;&#xFF0C;<strong>&#x4E0D;&#x4F1A;&#x4EA7;&#x751F;&#x7CFB;&#x7EDF;&#x903B;&#x8F91;&#x4E0A;BUG</strong>&#x3002;&#x53E6;&#x5916;&#xFF0C;<code>&#x666E;&#x901A;&#x987A;&#x5E8F;&#x6D88;&#x606F;</code>&#x6027;&#x80FD;&#x80FD;&#x66F4;&#x52A0;&#x597D;&#x3002;<br>&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x4F7F;&#x7528;&#x4F7F;&#x7528;<strong>&#x5B8C;&#x5168;&#x4E25;&#x683C;&#x987A;&#x5E8F;</strong>&#xFF1F;&#x5982;&#x4E0B;&#x662F;&#x6765;&#x81EA;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x7684;&#x8BF4;&#x660E;&#xFF1A;</p>
<blockquote>
<p>&#x76EE;&#x524D;&#x5DF2;&#x77E5;&#x7684;&#x5E94;&#x7528;&#x53EA;&#x6709;&#x6570;&#x636E;&#x5E93; <code>binlog</code> &#x540C;&#x6B65;&#x5F3A;&#x4F9D;&#x8D56;&#x4E25;&#x683C;&#x987A;&#x5E8F;&#x6D88;&#x606F;&#xFF0C;&#x5176;&#x4ED6;&#x5E94;&#x7528;&#x7EDD;&#x5927;&#x90E8;&#x5206;&#x90FD;&#x53EF;&#x4EE5;&#x5BB9;&#x5FCD;&#x77ED;&#x6682;&#x4E71;&#x5E8F;&#xFF0C;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x666E;&#x901A;&#x7684;&#x987A;&#x5E8F;&#x6D88;&#x606F;</p>
</blockquote>
<hr>
<p>&#x1F608;&#x4E0A;&#x4EE3;&#x7801;&#xFF01;&#xFF01;&#xFF01;</p>
<h1 id="2-Producer-&#x987A;&#x5E8F;&#x53D1;&#x9001;"><a href="#2-Producer-&#x987A;&#x5E8F;&#x53D1;&#x9001;" class="headerlink" title="2. Producer &#x987A;&#x5E8F;&#x53D1;&#x9001;"></a>2. <code>Producer</code> &#x987A;&#x5E8F;&#x53D1;&#x9001;</h1><p>&#x5B98;&#x65B9;&#x53D1;&#x9001;&#x987A;&#x5E8F;&#x6D88;&#x606F;&#x7684;<strong>&#x4F8B;&#x5B50;</strong>&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">package</span> org.apache.rocketmq.example.ordermessage;</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>: <span class="keyword">import</span> java.io.UnsupportedEncodingException;</div><div class="line"> <span class="number">4</span>: <span class="keyword">import</span> java.util.List;</div><div class="line"> <span class="number">5</span>: <span class="keyword">import</span> org.apache.rocketmq.client.exception.MQBrokerException;</div><div class="line"> <span class="number">6</span>: <span class="keyword">import</span> org.apache.rocketmq.client.exception.MQClientException;</div><div class="line"> <span class="number">7</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</div><div class="line"> <span class="number">8</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.MQProducer;</div><div class="line"> <span class="number">9</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.MessageQueueSelector;</div><div class="line"><span class="number">10</span>: <span class="keyword">import</span> org.apache.rocketmq.client.producer.SendResult;</div><div class="line"><span class="number">11</span>: <span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</div><div class="line"><span class="number">12</span>: <span class="keyword">import</span> org.apache.rocketmq.common.message.MessageQueue;</div><div class="line"><span class="number">13</span>: <span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</div><div class="line"><span class="number">14</span>: <span class="keyword">import</span> org.apache.rocketmq.remoting.exception.RemotingException;</div><div class="line"><span class="number">15</span>: </div><div class="line"><span class="number">16</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>{</div><div class="line"><span class="number">17</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>{</div><div class="line"><span class="number">18</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">19</span>:             MQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">&quot;please_rename_unique_group_name&quot;</span>);</div><div class="line"><span class="number">20</span>:             producer.start();</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>:             String[] tags = <span class="keyword">new</span> String[] {<span class="string">&quot;TagA&quot;</span>, <span class="string">&quot;TagB&quot;</span>, <span class="string">&quot;TagC&quot;</span>, <span class="string">&quot;TagD&quot;</span>, <span class="string">&quot;TagE&quot;</span>};</div><div class="line"><span class="number">23</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</div><div class="line"><span class="number">24</span>:                 <span class="keyword">int</span> orderId = i % <span class="number">10</span>;</div><div class="line"><span class="number">25</span>:                 Message msg =</div><div class="line"><span class="number">26</span>:                     <span class="keyword">new</span> Message(<span class="string">&quot;TopicTestjjj&quot;</span>, tags[i % tags.length], <span class="string">&quot;KEY&quot;</span> + i,</div><div class="line"><span class="number">27</span>:                         (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</div><div class="line"><span class="number">28</span>:                 SendResult sendResult = producer.send(msg, <span class="keyword">new</span> MessageQueueSelector() {</div><div class="line"><span class="number">29</span>:                     <span class="meta">@Override</span></div><div class="line"><span class="number">30</span>:                     <span class="function"><span class="keyword">public</span> MessageQueue <span class="title">select</span><span class="params">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> </span>{</div><div class="line"><span class="number">31</span>:                         Integer id = (Integer) arg;</div><div class="line"><span class="number">32</span>:                         <span class="keyword">int</span> index = id % mqs.size();</div><div class="line"><span class="number">33</span>:                         <span class="keyword">return</span> mqs.get(index);</div><div class="line"><span class="number">34</span>:                     }</div><div class="line"><span class="number">35</span>:                 }, orderId);</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:                 System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</div><div class="line"><span class="number">38</span>:             }</div><div class="line"><span class="number">39</span>: </div><div class="line"><span class="number">40</span>:             producer.shutdown();</div><div class="line"><span class="number">41</span>:         } <span class="keyword">catch</span> (MQClientException | RemotingException | MQBrokerException | InterruptedException e) {</div><div class="line"><span class="number">42</span>:             e.printStackTrace();</div><div class="line"><span class="number">43</span>:         }</div><div class="line"><span class="number">44</span>:     }</div><div class="line"><span class="number">45</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x7B2C; 28 &#x81F3; 35 &#x884C; &#xFF1A;&#x5B9E;&#x73B0;&#x4E86;&#x6839;&#x636E; <code>id % mqs.size()</code> &#x6765;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7684;&#x9009;&#x62E9;&#x3002;&#x5F53;&#x524D;&#x4F8B;&#x5B50;&#xFF0C;<strong>&#x6211;&#x4EEC;&#x4F20;&#x9012; <code>orderId</code> &#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#xFF0C;&#x90A3;&#x4E48;&#x76F8;&#x540C;&#x7684; <code>orderId</code> &#x80FD;&#x591F;&#x8FDB;&#x5165;&#x76F8;&#x540C;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;</strong>&#x3002;</li>
</ul>
<hr>
<p><code>MessageQueueSelector</code> &#x63A5;&#x53E3;&#x7684;<strong>&#x6E90;&#x7801;</strong>&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageQueueSelector</span> </span>{</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * &#x9009;&#x62E9;&#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 5:      *</div><div class="line"> 6:      * <span class="doctag">@param</span> mqs &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 7:      * <span class="doctag">@param</span> msg &#x6D88;&#x606F;</div><div class="line"> 8:      * <span class="doctag">@param</span> arg &#x53C2;&#x6570;</div><div class="line"> 9:      * <span class="doctag">@return</span> &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line">10:      */</div><div class="line"><span class="number">11</span>:     <span class="function">MessageQueue <span class="title">select</span><span class="params">(<span class="keyword">final</span> List&lt;MessageQueue&gt; mqs, <span class="keyword">final</span> Message msg, <span class="keyword">final</span> Object arg)</span></span>;</div><div class="line"><span class="number">12</span>: }</div></pre></td></tr></table></figure>
<hr>
<p><code>Producer</code> &#x9009;&#x62E9;&#x961F;&#x5217;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x65B9;&#x6CD5;&#x7684;<strong>&#x6E90;&#x7801;</strong>&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">16</span>: <span class="function"><span class="keyword">private</span> SendResult <span class="title">sendSelectImpl</span><span class="params">(//</span></span></div><div class="line"><span class="number">17</span>:     Message msg, //</div><div class="line"><span class="number">18</span>:     MessageQueueSelector selector, //</div><div class="line"><span class="number">19</span>:     Object arg, //</div><div class="line"><span class="number">20</span>:     <span class="keyword">final</span> CommunicationMode communicationMode, //</div><div class="line"><span class="number">21</span>:     <span class="keyword">final</span> SendCallback sendCallback, <span class="keyword">final</span> <span class="keyword">long</span> timeout//</div><div class="line"><span class="number">22</span>: ) <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException {</div><div class="line"><span class="number">23</span>:     <span class="keyword">this</span>.makeSureStateOK();</div><div class="line"><span class="number">24</span>:     Validators.checkMessage(msg, <span class="keyword">this</span>.defaultMQProducer);</div><div class="line"><span class="number">25</span>: </div><div class="line"><span class="number">26</span>:     TopicPublishInfo topicPublishInfo = <span class="keyword">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class="line"><span class="number">27</span>:     <span class="keyword">if</span> (topicPublishInfo != <span class="keyword">null</span> &amp;&amp; topicPublishInfo.ok()) {</div><div class="line"><span class="number">28</span>:         MessageQueue mq = <span class="keyword">null</span>;</div><div class="line"><span class="number">29</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">30</span>:             mq = selector.select(topicPublishInfo.getMessageQueueList(), msg, arg);</div><div class="line"><span class="number">31</span>:         } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"><span class="number">32</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">&quot;select message queue throwed exception.&quot;</span>, e);</div><div class="line"><span class="number">33</span>:         }</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>:         <span class="keyword">if</span> (mq != <span class="keyword">null</span>) {</div><div class="line"><span class="number">36</span>:             <span class="keyword">return</span> <span class="keyword">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, <span class="keyword">null</span>, timeout);</div><div class="line"><span class="number">37</span>:         } <span class="keyword">else</span> {</div><div class="line"><span class="number">38</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">&quot;select message queue return null.&quot;</span>, <span class="keyword">null</span>);</div><div class="line"><span class="number">39</span>:         }</div><div class="line"><span class="number">40</span>:     }</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">&quot;No route info for this topic, &quot;</span> + msg.getTopic(), <span class="keyword">null</span>);</div><div class="line"><span class="number">43</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x7B2C; 30 &#x884C; &#xFF1A;&#x9009;&#x62E9;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li>&#x7B2C; 36 &#x884C; &#xFF1A;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x3002;</li>
</ul>
<h1 id="3-Consumer-&#x4E25;&#x683C;&#x987A;&#x5E8F;&#x6D88;&#x8D39;"><a href="#3-Consumer-&#x4E25;&#x683C;&#x987A;&#x5E8F;&#x6D88;&#x8D39;" class="headerlink" title="3. Consumer &#x4E25;&#x683C;&#x987A;&#x5E8F;&#x6D88;&#x8D39;"></a>3. <code>Consumer</code> &#x4E25;&#x683C;&#x987A;&#x5E8F;&#x6D88;&#x8D39;</h1><p><code>Consumer</code> &#x5728;&#x4E25;&#x683C;&#x987A;&#x5E8F;&#x6D88;&#x8D39;&#x65F6;&#xFF0C;&#x901A;&#x8FC7; <strong>&#x4E09;</strong> &#x628A;&#x9501;&#x4FDD;&#x8BC1;&#x4E25;&#x683C;&#x987A;&#x5E8F;&#x6D88;&#x8D39;&#x3002;</p>
<ul class="ui list">
<li><code>Broker</code> &#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;&#xFF08;<strong>&#x5206;&#x5E03;&#x5F0F;&#x9501;</strong>&#xFF09; &#xFF1A;<ul>
<li>&#x96C6;&#x7FA4;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;<code>Consumer</code> &#x4ECE; <code>Broker</code> &#x83B7;&#x5F97;&#x8BE5;&#x9501;&#x540E;&#xFF0C;&#x624D;&#x80FD;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x62C9;&#x53D6;&#x3001;&#x6D88;&#x8D39;&#x3002;</li>
<li>&#x5E7F;&#x64AD;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;<code>Consumer</code> &#x65E0;&#x9700;&#x8BE5;&#x9501;&#x3002;</li>
</ul>
</li>
<li><code>Consumer</code> &#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;&#xFF08;<strong>&#x672C;&#x5730;&#x9501;</strong>&#xFF09; &#xFF1A;<code>Consumer</code> &#x83B7;&#x5F97;&#x8BE5;&#x9501;&#x624D;&#x80FD;&#x64CD;&#x4F5C;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li><code>Consumer</code> &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x6D88;&#x8D39;&#x9501;&#xFF08;<strong>&#x672C;&#x5730;&#x9501;</strong>&#xFF09; &#xFF1A;<code>Consumer</code> &#x83B7;&#x5F97;&#x8BE5;&#x9501;&#x624D;&#x80FD;&#x6D88;&#x8D39;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
</ul>
<p><strong>&#x53EF;&#x80FD;&#x540C;&#x5B66;&#x6709;&#x7591;&#x95EE;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x6709; <code>Consumer</code> &#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;&#x8FD8;&#x9700;&#x8981;&#x6709; <code>Consumer</code> &#x6D88;&#x606F;&#x961F;&#x5217;&#x6D88;&#x8D39;&#x9501;&#x5462;</strong>&#xFF1F;&#x1F608;&#x8BA9;&#x6211;&#x4EEC;&#x5E26;&#x7740;&#x7591;&#x95EE;&#x7EE7;&#x7EED;&#x5F80;&#x4E0B;&#x770B;&#x3002;</p>
<hr>
<h2 id="3-1-&#x83B7;&#x5F97;-&#x9501;&#x5B9A;-&#x6D88;&#x606F;&#x961F;&#x5217;"><a href="#3-1-&#x83B7;&#x5F97;-&#x9501;&#x5B9A;-&#x6D88;&#x606F;&#x961F;&#x5217;" class="headerlink" title="3.1 &#x83B7;&#x5F97;(&#x9501;&#x5B9A;)&#x6D88;&#x606F;&#x961F;&#x5217;"></a>3.1 &#x83B7;&#x5F97;(&#x9501;&#x5B9A;)&#x6D88;&#x606F;&#x961F;&#x5217;</h2><p><strong>&#x96C6;&#x7FA4;&#x6A21;&#x5F0F;</strong>&#x4E0B;&#xFF0C;<code>Consumer</code> &#x66F4;&#x65B0;&#x5C5E;&#x4E8E;&#x81EA;&#x5DF1;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x65F6;&#xFF0C;&#x4F1A;&#x5411; <code>Broker</code> &#x9501;&#x5B9A;&#x8BE5;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF08;<em>&#x5E7F;&#x64AD;&#x6A21;&#x5F0F;&#x4E0B;&#x4E0D;&#x9700;&#x8981;</em>&#xFF09;&#x3002;&#x5982;&#x679C;&#x9501;&#x5B9A;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x66F4;&#x65B0;&#x5931;&#x8D25;&#xFF0C;&#x5373;&#x8BE5;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4E0D;&#x5C5E;&#x4E8E;&#x81EA;&#x5DF1;&#xFF0C;&#x4E0D;&#x80FD;&#x8FDB;&#x884C;&#x6D88;&#x8D39;&#x3002;&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// &#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x3010;RebalanceImpl.java&#x3011;</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateProcessQueueTableInRebalance</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> Set&lt;MessageQueue&gt; mqSet, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>{</div><div class="line"> <span class="number">3</span>: <span class="comment">// ..... &#x6B64;&#x5904;&#x7701;&#x7565;&#x90E8;&#x5206;&#x4EE3;&#x7801; </span></div><div class="line"> <span class="number">4</span>:     <span class="comment">// &#x589E;&#x52A0; &#x4E0D;&#x5728;processQueueTable &amp;&amp; &#x5B58;&#x5728;&#x4E8E;mqSet &#x91CC;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</span></div><div class="line"> <span class="number">5</span>:     List&lt;PullRequest&gt; pullRequestList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// &#x62C9;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x6570;&#x7EC4;</span></div><div class="line"> <span class="number">6</span>:     <span class="keyword">for</span> (MessageQueue mq : mqSet) {</div><div class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (!<span class="keyword">this</span>.processQueueTable.containsKey(mq)) {</div><div class="line"> <span class="number">8</span>:             <span class="keyword">if</span> (isOrder &amp;&amp; !<span class="keyword">this</span>.lock(mq)) { <span class="comment">// &#x987A;&#x5E8F;&#x6D88;&#x606F;&#x9501;&#x5B9A;&#x6D88;&#x606F;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">9</span>:                 log.warn(<span class="string">&quot;doRebalance, {}, add a new mq failed, {}, because lock failed&quot;</span>, consumerGroup, mq);</div><div class="line"><span class="number">10</span>:                 <span class="keyword">continue</span>;</div><div class="line"><span class="number">11</span>:             }</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:             <span class="keyword">this</span>.removeDirtyOffset(mq);</div><div class="line"><span class="number">14</span>:             ProcessQueue pq = <span class="keyword">new</span> ProcessQueue();</div><div class="line"><span class="number">15</span>:             <span class="keyword">long</span> nextOffset = <span class="keyword">this</span>.computePullFromWhere(mq);</div><div class="line"><span class="number">16</span>:             <span class="keyword">if</span> (nextOffset &gt;= <span class="number">0</span>) {</div><div class="line"><span class="number">17</span>:                 ProcessQueue pre = <span class="keyword">this</span>.processQueueTable.putIfAbsent(mq, pq);</div><div class="line"><span class="number">18</span>:                 <span class="keyword">if</span> (pre != <span class="keyword">null</span>) {</div><div class="line"><span class="number">19</span>:                     log.info(<span class="string">&quot;doRebalance, {}, mq already exists, {}&quot;</span>, consumerGroup, mq);</div><div class="line"><span class="number">20</span>:                 } <span class="keyword">else</span> {</div><div class="line"><span class="number">21</span>:                     log.info(<span class="string">&quot;doRebalance, {}, add a new mq, {}&quot;</span>, consumerGroup, mq);</div><div class="line"><span class="number">22</span>:                     PullRequest pullRequest = <span class="keyword">new</span> PullRequest();</div><div class="line"><span class="number">23</span>:                     pullRequest.setConsumerGroup(consumerGroup);</div><div class="line"><span class="number">24</span>:                     pullRequest.setNextOffset(nextOffset);</div><div class="line"><span class="number">25</span>:                     pullRequest.setMessageQueue(mq);</div><div class="line"><span class="number">26</span>:                     pullRequest.setProcessQueue(pq);</div><div class="line"><span class="number">27</span>:                     pullRequestList.add(pullRequest);</div><div class="line"><span class="number">28</span>:                     changed = <span class="keyword">true</span>;</div><div class="line"><span class="number">29</span>:                 }</div><div class="line"><span class="number">30</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">31</span>:                 log.warn(<span class="string">&quot;doRebalance, {}, add new mq failed, {}&quot;</span>, consumerGroup, mq);</div><div class="line"><span class="number">32</span>:             }</div><div class="line"><span class="number">33</span>:         }</div><div class="line"><span class="number">34</span>:     }</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>: <span class="comment">// ..... &#x6B64;&#x5904;&#x7701;&#x7565;&#x90E8;&#x5206;&#x4EE3;&#x7801; </span></div><div class="line"><span class="number">37</span>: }</div><div class="line"><span class="number">38</span>: </div><div class="line"><span class="number">39</span>: <span class="comment">// &#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x3010;RebalanceImpl.java&#x3011;</span></div><div class="line"><span class="number">40</span>: <span class="comment">/**</span></div><div class="line">41:  * &#x8BF7;&#x6C42;Broker&#x83B7;&#x5F97;&#x6307;&#x5B9A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x9501;</div><div class="line">42:  *</div><div class="line">43:  * <span class="doctag">@param</span> mq &#x961F;&#x5217;</div><div class="line">44:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x6210;&#x529F;</div><div class="line">45:  */</div><div class="line"><span class="number">46</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(<span class="keyword">final</span> MessageQueue mq)</span> </span>{</div><div class="line"><span class="number">47</span>:     FindBrokerResult findBrokerResult = <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(), MixAll.MASTER_ID, <span class="keyword">true</span>);</div><div class="line"><span class="number">48</span>:     <span class="keyword">if</span> (findBrokerResult != <span class="keyword">null</span>) {</div><div class="line"><span class="number">49</span>:         LockBatchRequestBody requestBody = <span class="keyword">new</span> LockBatchRequestBody();</div><div class="line"><span class="number">50</span>:         requestBody.setConsumerGroup(<span class="keyword">this</span>.consumerGroup);</div><div class="line"><span class="number">51</span>:         requestBody.setClientId(<span class="keyword">this</span>.mQClientFactory.getClientId());</div><div class="line"><span class="number">52</span>:         requestBody.getMqSet().add(mq);</div><div class="line"><span class="number">53</span>: </div><div class="line"><span class="number">54</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">55</span>:             <span class="comment">// &#x8BF7;&#x6C42;Broker&#x83B7;&#x5F97;&#x6307;&#x5B9A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7684;&#x5206;&#x5E03;&#x5F0F;&#x9501;</span></div><div class="line"><span class="number">56</span>:             Set&lt;MessageQueue&gt; lockedMq =</div><div class="line"><span class="number">57</span>:                 <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().lockBatchMQ(findBrokerResult.getBrokerAddr(), requestBody, <span class="number">1000</span>);</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>:             <span class="comment">// &#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x9501;&#x5B9A;&#x6210;&#x529F;&#x3002;&#x9501;&#x5B9A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x6210;&#x529F;&#xFF0C;&#x53EF;&#x80FD;&#x672C;&#x5730;&#x6CA1;&#x6709;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#xFF0C;&#x8BBE;&#x7F6E;&#x9501;&#x5B9A;&#x6210;&#x529F;&#x4F1A;&#x5728;lockAll()&#x65B9;&#x6CD5;&#x3002;</span></div><div class="line"><span class="number">60</span>:             <span class="keyword">for</span> (MessageQueue mmqq : lockedMq) {</div><div class="line"><span class="number">61</span>:                 ProcessQueue processQueue = <span class="keyword">this</span>.processQueueTable.get(mmqq);</div><div class="line"><span class="number">62</span>:                 <span class="keyword">if</span> (processQueue != <span class="keyword">null</span>) {</div><div class="line"><span class="number">63</span>:                     processQueue.setLocked(<span class="keyword">true</span>);</div><div class="line"><span class="number">64</span>:                     processQueue.setLastLockTimestamp(System.currentTimeMillis());</div><div class="line"><span class="number">65</span>:                 }</div><div class="line"><span class="number">66</span>:             }</div><div class="line"><span class="number">67</span>: </div><div class="line"><span class="number">68</span>:             <span class="keyword">boolean</span> lockOK = lockedMq.contains(mq);</div><div class="line"><span class="number">69</span>:             log.info(<span class="string">&quot;the message queue lock {}, {} {}&quot;</span>,</div><div class="line"><span class="number">70</span>:                 lockOK ? <span class="string">&quot;OK&quot;</span> : <span class="string">&quot;Failed&quot;</span>,</div><div class="line"><span class="number">71</span>:                 <span class="keyword">this</span>.consumerGroup,</div><div class="line"><span class="number">72</span>:                 mq);</div><div class="line"><span class="number">73</span>:             <span class="keyword">return</span> lockOK;</div><div class="line"><span class="number">74</span>:         } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">75</span>:             log.error(<span class="string">&quot;lockBatchMQ exception, &quot;</span> + mq, e);</div><div class="line"><span class="number">76</span>:         }</div><div class="line"><span class="number">77</span>:     }</div><div class="line"><span class="number">78</span>: </div><div class="line"><span class="number">79</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">80</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x2B06;&#xFE0F;&#x2B06;&#xFE0F;&#x2B06;&#xFE0F;</li>
<li>&#x7B2C; 8 &#x81F3; 11 &#x884C; &#xFF1A;&#x987A;&#x5E8F;&#x6D88;&#x8D39;&#x65F6;&#xFF0C;&#x9501;&#x5B9A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;&#x5982;&#x679C;&#x9501;&#x5B9A;&#x5931;&#x8D25;&#xFF0C;&#x65B0;&#x589E;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x5931;&#x8D25;&#x3002;</li>
</ul>
<hr>
<p><code>Broker</code> &#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;&#x4F1A;&#x8FC7;&#x671F;&#xFF0C;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E; 30s&#x3002;&#x56E0;&#x6B64;&#xFF0C;<code>Consumer</code> &#x9700;&#x8981;&#x4E0D;&#x65AD;&#x5411; <code>Broker</code> &#x5237;&#x65B0;&#x8BE5;&#x9501;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#xFF0C;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E; 20s &#x5237;&#x65B0;&#x4E00;&#x6B21;&#x3002;&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// &#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x3010;ConsumeMessageOrderlyService.java&#x3011;</span></div><div class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())) {</div><div class="line"> <span class="number">4</span>:         <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() {</div><div class="line"> <span class="number">5</span>:             <span class="meta">@Override</span></div><div class="line"> <span class="number">6</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">7</span>:                 ConsumeMessageOrderlyService.<span class="keyword">this</span>.lockMQPeriodically();</div><div class="line"> <span class="number">8</span>:             }</div><div class="line"> <span class="number">9</span>:         }, <span class="number">1000</span> * <span class="number">1</span>, ProcessQueue.REBALANCE_LOCK_INTERVAL, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">10</span>:     }</div><div class="line"><span class="number">11</span>: }</div></pre></td></tr></table></figure>
<h2 id="3-2-&#x79FB;&#x9664;&#x6D88;&#x606F;&#x961F;&#x5217;"><a href="#3-2-&#x79FB;&#x9664;&#x6D88;&#x606F;&#x961F;&#x5217;" class="headerlink" title="3.2 &#x79FB;&#x9664;&#x6D88;&#x606F;&#x961F;&#x5217;"></a>3.2 &#x79FB;&#x9664;&#x6D88;&#x606F;&#x961F;&#x5217;</h2><p>&#x96C6;&#x7FA4;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;<code>Consumer</code> &#x79FB;&#x9664;&#x81EA;&#x5DF1;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x65F6;&#xFF0C;&#x4F1A;&#x5411; <code>Broker</code> &#x89E3;&#x9501;&#x8BE5;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF08;&#x5E7F;&#x64AD;&#x6A21;&#x5F0F;&#x4E0B;&#x4E0D;&#x9700;&#x8981;&#xFF09;&#x3002;&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="comment">// &#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x3010;RebalancePushImpl.java&#x3011;</span></div><div class="line"> <span class="number">2</span>: <span class="comment">/**</span></div><div class="line"> 3:  * &#x79FB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x961F;&#x5217;&#x76F8;&#x5173;&#x7684;&#x4FE1;&#x606F;</div><div class="line"> 4:  * 1. &#x6301;&#x4E45;&#x5316;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#xFF0C;&#x5E76;&#x79FB;&#x9664;&#x4E4B;</div><div class="line"> 5:  * 2. &#x987A;&#x5E8F;&#x6D88;&#x8D39;&amp;&#x96C6;&#x7FA4;&#x6A21;&#x5F0F;&#xFF0C;&#x89E3;&#x9501;&#x5BF9;&#x8BE5;&#x961F;&#x5217;&#x7684;&#x9501;&#x5B9A;</div><div class="line"> 6:  *</div><div class="line"> 7:  * <span class="doctag">@param</span> mq &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 8:  * <span class="doctag">@param</span> pq &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;</div><div class="line"> 9:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x79FB;&#x9664;&#x6210;&#x529F;</div><div class="line">10:  */</div><div class="line"><span class="number">11</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">12</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeUnnecessaryMessageQueue</span><span class="params">(MessageQueue mq, ProcessQueue pq)</span> </span>{</div><div class="line"><span class="number">13</span>:     <span class="comment">// &#x540C;&#x6B65;&#x961F;&#x5217;&#x7684;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#xFF0C;&#x5E76;&#x79FB;&#x9664;&#x4E4B;&#x3002;</span></div><div class="line"><span class="number">14</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);</div><div class="line"><span class="number">15</span>:     <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);</div><div class="line"><span class="number">16</span>:     <span class="comment">// &#x96C6;&#x7FA4;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;&#x987A;&#x5E8F;&#x6D88;&#x8D39;&#x79FB;&#x9664;&#x65F6;&#xFF0C;&#x89E3;&#x9501;&#x5BF9;&#x961F;&#x5217;&#x7684;&#x9501;&#x5B9A;</span></div><div class="line"><span class="number">17</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumerImpl.isConsumeOrderly()</div><div class="line"><span class="number">18</span>:         &amp;&amp; MessageModel.CLUSTERING.equals(<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())) {</div><div class="line"><span class="number">19</span>:         <span class="keyword">try</span> {</div><div class="line"><span class="number">20</span>:             <span class="keyword">if</span> (pq.getLockConsume().tryLock(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) {</div><div class="line"><span class="number">21</span>:                 <span class="keyword">try</span> {</div><div class="line"><span class="number">22</span>:                     <span class="keyword">return</span> <span class="keyword">this</span>.unlockDelay(mq, pq);</div><div class="line"><span class="number">23</span>:                 } <span class="keyword">finally</span> {</div><div class="line"><span class="number">24</span>:                     pq.getLockConsume().unlock();</div><div class="line"><span class="number">25</span>:                 }</div><div class="line"><span class="number">26</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">27</span>:                 log.warn(<span class="string">&quot;[WRONG]mq is consuming, so can not unlock it, {}. maybe hanged for a while, {}&quot;</span>, <span class="comment">//</span></div><div class="line"><span class="number">28</span>:                     mq, <span class="comment">//</span></div><div class="line"><span class="number">29</span>:                     pq.getTryUnlockTimes());</div><div class="line"><span class="number">30</span>: </div><div class="line"><span class="number">31</span>:                 pq.incTryUnlockTimes();</div><div class="line"><span class="number">32</span>:             }</div><div class="line"><span class="number">33</span>:         } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">34</span>:             log.error(<span class="string">&quot;removeUnnecessaryMessageQueue Exception&quot;</span>, e);</div><div class="line"><span class="number">35</span>:         }</div><div class="line"><span class="number">36</span>: </div><div class="line"><span class="number">37</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">38</span>:     }</div><div class="line"><span class="number">39</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">40</span>: }</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>: <span class="comment">// &#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x3010;RebalancePushImpl.java&#x3011;</span></div><div class="line"><span class="number">43</span>: <span class="comment">/**</span></div><div class="line">44:  * &#x5EF6;&#x8FDF;&#x89E3;&#x9501; Broker &#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;</div><div class="line">45:  * &#x5F53;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x4E0D;&#x5B58;&#x5728;&#x6D88;&#x606F;&#xFF0C;&#x5219;&#x76F4;&#x63A5;&#x89E3;&#x9501;</div><div class="line">46:  *</div><div class="line">47:  * <span class="doctag">@param</span> mq &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line">48:  * <span class="doctag">@param</span> pq &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;</div><div class="line">49:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x89E3;&#x9501;&#x6210;&#x529F;</div><div class="line">50:  */</div><div class="line"><span class="number">51</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">unlockDelay</span><span class="params">(<span class="keyword">final</span> MessageQueue mq, <span class="keyword">final</span> ProcessQueue pq)</span> </span>{</div><div class="line"><span class="number">52</span>:     <span class="keyword">if</span> (pq.hasTempMessage()) { <span class="comment">// TODO &#x7591;&#x95EE;&#xFF1A;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x5EF6;&#x8FDF;&#x79FB;&#x9664;</span></div><div class="line"><span class="number">53</span>:         log.info(<span class="string">&quot;[{}]unlockDelay, begin {} &quot;</span>, mq.hashCode(), mq);</div><div class="line"><span class="number">54</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getmQClientFactory().getScheduledExecutorService().schedule(<span class="keyword">new</span> Runnable() {</div><div class="line"><span class="number">55</span>:             <span class="meta">@Override</span></div><div class="line"><span class="number">56</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">57</span>:                 log.info(<span class="string">&quot;[{}]unlockDelay, execute at once {}&quot;</span>, mq.hashCode(), mq);</div><div class="line"><span class="number">58</span>:                 RebalancePushImpl.<span class="keyword">this</span>.unlock(mq, <span class="keyword">true</span>);</div><div class="line"><span class="number">59</span>:             }</div><div class="line"><span class="number">60</span>:         }, UNLOCK_DELAY_TIME_MILLS, TimeUnit.MILLISECONDS);</div><div class="line"><span class="number">61</span>:     } <span class="keyword">else</span> {</div><div class="line"><span class="number">62</span>:         <span class="keyword">this</span>.unlock(mq, <span class="keyword">true</span>);</div><div class="line"><span class="number">63</span>:     }</div><div class="line"><span class="number">64</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">65</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x2B06;&#xFE0F;&#x2B06;&#xFE0F;&#x2B06;&#xFE0F;</li>
<li>&#x7B2C; 20 &#x81F3; 32 &#x884C; &#xFF1A;&#x83B7;&#x53D6;<strong>&#x6D88;&#x606F;&#x961F;&#x5217;&#x6D88;&#x8D39;&#x9501;</strong>&#xFF0C;&#x907F;&#x514D;&#x548C;&#x6D88;&#x606F;&#x961F;&#x5217;&#x6D88;&#x8D39;&#x51B2;&#x7A81;&#x3002;&#x5982;&#x679C;&#x83B7;&#x53D6;&#x9501;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x79FB;&#x9664;&#x6D88;&#x606F;&#x961F;&#x5217;&#x5931;&#x8D25;&#xFF0C;&#x7B49;&#x5F85;&#x4E0B;&#x6B21;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x6D88;&#x8D39;&#x961F;&#x5217;&#x65F6;&#xFF0C;&#x518D;&#x8FDB;&#x884C;&#x79FB;&#x9664;&#x3002;&#x5982;&#x679C;&#x672A;&#x83B7;&#x5F97;&#x9501;&#x800C;&#x8FDB;&#x884C;&#x79FB;&#x9664;&#xFF0C;&#x5219;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x53E6;&#x5916;&#x7684;  <code>Consumer</code> &#x548C;&#x5F53;&#x524D; <code>Consumer</code> &#x540C;&#x65F6;&#x6D88;&#x8D39;&#x8BE5;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x5BFC;&#x81F4;&#x6D88;&#x606F;&#x65E0;&#x6CD5;&#x4E25;&#x683C;&#x987A;&#x5E8F;&#x6D88;&#x8D39;&#x3002;</li>
<li>&#x7B2C; 51 &#x81F3; 64 &#x884C; &#xFF1A;&#x89E3;&#x9501; <code>Broker</code> &#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;&#x3002;&#x5982;&#x679C;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x5B58;&#x5728;&#x5269;&#x4F59;&#x6D88;&#x606F;&#xFF0C;&#x5219;&#x5EF6;&#x8FDF;&#x89E3;&#x9501; <code>Broker</code> &#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;&#x3002;&#x2753;&#x4E3A;&#x4EC0;&#x4E48;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x5B58;&#x5728;&#x5269;&#x4F59;&#x6D88;&#x606F;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x89E3;&#x9501;&#x5462;&#xFF1F;&#x1F608;&#x6211;&#x4E5F;&#x4E0D;&#x77E5;&#x9053;&#xFF0C;&#x767E;&#x601D;&#x4E0D;&#x5F97;&#x5176;&#x89E3;&#x3002;&#x5982;&#x679C;&#x6709;&#x77E5;&#x9053;&#x7684;&#x540C;&#x5B66;&#x9EBB;&#x70E6;&#x6559;&#x80B2;&#x4E0B;&#x4FFA;&#x3002;</li>
</ul>
<h2 id="3-3-&#x6D88;&#x8D39;&#x6D88;&#x606F;&#x961F;&#x5217;"><a href="#3-3-&#x6D88;&#x8D39;&#x6D88;&#x606F;&#x961F;&#x5217;" class="headerlink" title="3.3 &#x6D88;&#x8D39;&#x6D88;&#x606F;&#x961F;&#x5217;"></a>3.3 &#x6D88;&#x8D39;&#x6D88;&#x606F;&#x961F;&#x5217;</h2><p>&#x1F60F;&#x672C;&#x8282;&#x4F1A;&#x7C7B;&#x6BD4;<strong>&#x5E76;&#x53D1;&#x6D88;&#x8D39;&#x6D88;&#x8D39;&#x961F;&#x5217;</strong>&#xFF0C;&#x5EFA;&#x8BAE;&#x5BF9;&#x7167; <a href="http://www.yunai.me/RocketMQ/message-pull-and-consume-second/#6&#x3001;PushConsumer-&#x6D88;&#x8D39;&#x6D88;&#x606F;">PushConsumer&#x5E76;&#x53D1;&#x6D88;&#x8D39;&#x6D88;&#x606F;</a> &#x4E00;&#x8D77;&#x7406;&#x89E3;&#x3002;</p>
<h3 id="3-1-1-&#x6D88;&#x8D39;&#x6D88;&#x606F;"><a href="#3-1-1-&#x6D88;&#x8D39;&#x6D88;&#x606F;" class="headerlink" title="3.1.1 &#x6D88;&#x8D39;&#x6D88;&#x606F;"></a>3.1.1 &#x6D88;&#x8D39;&#x6D88;&#x606F;</h3><p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_05_13/01.png"><img src="http://www.yunai.me/images/RocketMQ/2017_05_13/01.png" alt="&#x987A;&#x5E8F;&#x6D88;&#x8D39;&#x6D3B;&#x52A8;&#x56FE;-&#x6D88;&#x8D39;&#x6D88;&#x606F;" class="ui centered image"></a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// &#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x3010;ConsumeMessageOrderlyService.java&#x3011;</span></div><div class="line">  <span class="number">2</span>: <span class="class"><span class="keyword">class</span> <span class="title">ConsumeRequest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</div><div class="line">  <span class="number">3</span>: </div><div class="line">  <span class="number">4</span>:     <span class="comment">/**</span></div><div class="line">  5:      * &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;</div><div class="line">  6:      */</div><div class="line">  <span class="number">7</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ProcessQueue processQueue;</div><div class="line">  <span class="number">8</span>:     <span class="comment">/**</span></div><div class="line">  9:      * &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line"> 10:      */</div><div class="line"> <span class="number">11</span>:     <span class="keyword">private</span> <span class="keyword">final</span> MessageQueue messageQueue;</div><div class="line"> <span class="number">12</span>: </div><div class="line"> <span class="number">13</span>:     <span class="meta">@Override</span></div><div class="line"> <span class="number">14</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">15</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) {</div><div class="line"> <span class="number">16</span>:             log.warn(<span class="string">&quot;run, the message queue not be able to consume, because it&apos;s dropped. {}&quot;</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">17</span>:             <span class="keyword">return</span>;</div><div class="line"> <span class="number">18</span>:         }</div><div class="line"> <span class="number">19</span>: </div><div class="line"> <span class="number">20</span>:         <span class="comment">// &#x83B7;&#x5F97; Consumer &#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;</span></div><div class="line"> <span class="number">21</span>:         <span class="keyword">final</span> Object objLock = messageQueueLock.fetchLockObject(<span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">22</span>:         <span class="keyword">synchronized</span> (objLock) {</div><div class="line"> <span class="number">23</span>:             <span class="comment">// (&#x5E7F;&#x64AD;&#x6A21;&#x5F0F;) &#x6216;&#x8005; (&#x96C6;&#x7FA4;&#x6A21;&#x5F0F; &amp;&amp; Broker&#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;&#x6709;&#x6548;)</span></div><div class="line"> <span class="number">24</span>:             <span class="keyword">if</span> (MessageModel.BROADCASTING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class="line"> <span class="number">25</span>:                 || (<span class="keyword">this</span>.processQueue.isLocked() &amp;&amp; !<span class="keyword">this</span>.processQueue.isLockExpired())) {</div><div class="line"> <span class="number">26</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> beginTime = System.currentTimeMillis();</div><div class="line"> <span class="number">27</span>:                 <span class="comment">// &#x5FAA;&#x73AF;</span></div><div class="line"> <span class="number">28</span>:                 <span class="keyword">for</span> (<span class="keyword">boolean</span> continueConsume = <span class="keyword">true</span>; continueConsume; ) {</div><div class="line"> <span class="number">29</span>:                     <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) {</div><div class="line"> <span class="number">30</span>:                         log.warn(<span class="string">&quot;the message queue not be able to consume, because it&apos;s dropped. {}&quot;</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">31</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">32</span>:                     }</div><div class="line"> <span class="number">33</span>: </div><div class="line"> <span class="number">34</span>:                     <span class="comment">// &#x6D88;&#x606F;&#x961F;&#x5217;&#x5206;&#x5E03;&#x5F0F;&#x9501;&#x672A;&#x9501;&#x5B9A;&#xFF0C;&#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x83B7;&#x5F97;&#x9501;&#x5E76;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</span></div><div class="line"> <span class="number">35</span>:                     <span class="keyword">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class="line"> <span class="number">36</span>:                         &amp;&amp; !<span class="keyword">this</span>.processQueue.isLocked()) {</div><div class="line"> <span class="number">37</span>:                         log.warn(<span class="string">&quot;the message queue not locked, so consume later, {}&quot;</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">38</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.tryLockLaterAndReconsume(<span class="keyword">this</span>.messageQueue, <span class="keyword">this</span>.processQueue, <span class="number">10</span>);</div><div class="line"> <span class="number">39</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">40</span>:                     }</div><div class="line"> <span class="number">41</span>:                     <span class="comment">// &#x6D88;&#x606F;&#x961F;&#x5217;&#x5206;&#x5E03;&#x5F0F;&#x9501;&#x5DF2;&#x7ECF;&#x8FC7;&#x671F;&#xFF0C;&#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x83B7;&#x5F97;&#x9501;&#x5E76;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</span></div><div class="line"> <span class="number">42</span>:                     <span class="keyword">if</span> (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.messageModel())</div><div class="line"> <span class="number">43</span>:                         &amp;&amp; <span class="keyword">this</span>.processQueue.isLockExpired()) {</div><div class="line"> <span class="number">44</span>:                         log.warn(<span class="string">&quot;the message queue lock expired, so consume later, {}&quot;</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">45</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.tryLockLaterAndReconsume(<span class="keyword">this</span>.messageQueue, <span class="keyword">this</span>.processQueue, <span class="number">10</span>);</div><div class="line"> <span class="number">46</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">47</span>:                     }</div><div class="line"> <span class="number">48</span>: </div><div class="line"> <span class="number">49</span>:                     <span class="comment">// &#x5F53;&#x524D;&#x5468;&#x671F;&#x6D88;&#x8D39;&#x65F6;&#x95F4;&#x8D85;&#x8FC7;&#x8FDE;&#x7EED;&#x65F6;&#x957F;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;60s&#xFF0C;&#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#x3002;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6BCF;&#x6D88;&#x8D39;1&#x5206;&#x949F;&#x4F11;&#x606F;10ms&#x3002;</span></div><div class="line"> <span class="number">50</span>:                     <span class="keyword">long</span> interval = System.currentTimeMillis() - beginTime;</div><div class="line"> <span class="number">51</span>:                     <span class="keyword">if</span> (interval &gt; MAX_TIME_CONSUME_CONTINUOUSLY) {</div><div class="line"> <span class="number">52</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.submitConsumeRequestLater(processQueue, messageQueue, <span class="number">10</span>);</div><div class="line"> <span class="number">53</span>:                         <span class="keyword">break</span>;</div><div class="line"> <span class="number">54</span>:                     }</div><div class="line"> <span class="number">55</span>: </div><div class="line"> <span class="number">56</span>:                     <span class="comment">// &#x83B7;&#x53D6;&#x6D88;&#x8D39;&#x6D88;&#x606F;&#x3002;&#x6B64;&#x5904;&#x548C;&#x5E76;&#x53D1;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x4E0D;&#x540C;&#xFF0C;&#x5E76;&#x53D1;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x5DF2;&#x7ECF;&#x5E26;&#x4E86;&#x6D88;&#x8D39;&#x54EA;&#x4E9B;&#x6D88;&#x606F;&#x3002;</span></div><div class="line"> <span class="number">57</span>:                     <span class="keyword">final</span> <span class="keyword">int</span> consumeBatchSize = ConsumeMessageOrderlyService.<span class="keyword">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</div><div class="line"> <span class="number">58</span>:                     List&lt;MessageExt&gt; msgs = <span class="keyword">this</span>.processQueue.takeMessags(consumeBatchSize);</div><div class="line"> <span class="number">59</span>:                     <span class="keyword">if</span> (!msgs.isEmpty()) {</div><div class="line"> <span class="number">60</span>:                         <span class="keyword">final</span> ConsumeOrderlyContext context = <span class="keyword">new</span> ConsumeOrderlyContext(<span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">61</span>: </div><div class="line"> <span class="number">62</span>:                         ConsumeOrderlyStatus status = <span class="keyword">null</span>;</div><div class="line"> <span class="number">63</span>: </div><div class="line"> <span class="number">64</span>:                         <span class="comment">// ....&#x7701;&#x7565;&#x4EE3;&#x7801;&#xFF1A;Hook&#xFF1A;before</span></div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:                         <span class="comment">// &#x6267;&#x884C;&#x6D88;&#x8D39;</span></div><div class="line"> <span class="number">67</span>:                         <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">68</span>:                         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS;</div><div class="line"> <span class="number">69</span>:                         <span class="keyword">boolean</span> hasException = <span class="keyword">false</span>;</div><div class="line"> <span class="number">70</span>:                         <span class="keyword">try</span> {</div><div class="line"> <span class="number">71</span>:                             <span class="keyword">this</span>.processQueue.getLockConsume().lock(); <span class="comment">// &#x9501;&#x5B9A;&#x961F;&#x5217;&#x6D88;&#x8D39;&#x9501;</span></div><div class="line"> <span class="number">72</span>: </div><div class="line"> <span class="number">73</span>:                             <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) {</div><div class="line"> <span class="number">74</span>:                                 log.warn(<span class="string">&quot;consumeMessage, the message queue not be able to consume, because it&apos;s dropped. {}&quot;</span>,</div><div class="line"> <span class="number">75</span>:                                     <span class="keyword">this</span>.messageQueue);</div><div class="line"> <span class="number">76</span>:                                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">77</span>:                             }</div><div class="line"> <span class="number">78</span>: </div><div class="line"> <span class="number">79</span>:                             status = messageListener.consumeMessage(Collections.unmodifiableList(msgs), context);</div><div class="line"> <span class="number">80</span>:                         } <span class="keyword">catch</span> (Throwable e) {</div><div class="line"> <span class="number">81</span>:                             log.warn(<span class="string">&quot;consumeMessage exception: {} Group: {} Msgs: {} MQ: {}&quot;</span>, <span class="comment">//</span></div><div class="line"> <span class="number">82</span>:                                 RemotingHelper.exceptionSimpleDesc(e), <span class="comment">//</span></div><div class="line"> <span class="number">83</span>:                                 ConsumeMessageOrderlyService.<span class="keyword">this</span>.consumerGroup, <span class="comment">//</span></div><div class="line"> <span class="number">84</span>:                                 msgs, <span class="comment">//</span></div><div class="line"> <span class="number">85</span>:                                 messageQueue);</div><div class="line"> <span class="number">86</span>:                             hasException = <span class="keyword">true</span>;</div><div class="line"> <span class="number">87</span>:                         } <span class="keyword">finally</span> {</div><div class="line"> <span class="number">88</span>:                             <span class="keyword">this</span>.processQueue.getLockConsume().unlock(); <span class="comment">// &#x9501;&#x5B9A;&#x961F;&#x5217;&#x6D88;&#x8D39;&#x9501;</span></div><div class="line"> <span class="number">89</span>:                         }</div><div class="line"> <span class="number">90</span>: </div><div class="line"> <span class="number">91</span>:                         <span class="comment">// ....&#x7701;&#x7565;&#x4EE3;&#x7801;&#xFF1A;&#x89E3;&#x6790;&#x6D88;&#x8D39;&#x7ED3;&#x679C;&#x72B6;&#x6001;</span></div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>:                         <span class="comment">// ....&#x7701;&#x7565;&#x4EE3;&#x7801;&#xFF1A;Hook&#xFF1A;after</span></div><div class="line"> <span class="number">94</span>: </div><div class="line"> <span class="number">95</span>:                         ConsumeMessageOrderlyService.<span class="keyword">this</span>.getConsumerStatsManager()</div><div class="line"> <span class="number">96</span>:                             .incConsumeRT(ConsumeMessageOrderlyService.<span class="keyword">this</span>.consumerGroup, messageQueue.getTopic(), consumeRT);</div><div class="line"> <span class="number">97</span>: </div><div class="line"> <span class="number">98</span>:                         <span class="comment">// &#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;</span></div><div class="line"> <span class="number">99</span>:                         continueConsume = ConsumeMessageOrderlyService.<span class="keyword">this</span>.processConsumeResult(msgs, status, context, <span class="keyword">this</span>);</div><div class="line"><span class="number">100</span>:                     } <span class="keyword">else</span> {</div><div class="line"><span class="number">101</span>:                         continueConsume = <span class="keyword">false</span>;</div><div class="line"><span class="number">102</span>:                     }</div><div class="line"><span class="number">103</span>:                 }</div><div class="line"><span class="number">104</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">105</span>:                 <span class="keyword">if</span> (<span class="keyword">this</span>.processQueue.isDropped()) {</div><div class="line"><span class="number">106</span>:                     log.warn(<span class="string">&quot;the message queue not be able to consume, because it&apos;s dropped. {}&quot;</span>, <span class="keyword">this</span>.messageQueue);</div><div class="line"><span class="number">107</span>:                     <span class="keyword">return</span>;</div><div class="line"><span class="number">108</span>:                 }</div><div class="line"><span class="number">109</span>: </div><div class="line"><span class="number">110</span>:                 ConsumeMessageOrderlyService.<span class="keyword">this</span>.tryLockLaterAndReconsume(<span class="keyword">this</span>.messageQueue, <span class="keyword">this</span>.processQueue, <span class="number">100</span>);</div><div class="line"><span class="number">111</span>:             }</div><div class="line"><span class="number">112</span>:         }</div><div class="line"><span class="number">113</span>:     }</div><div class="line"><span class="number">114</span>: </div><div class="line"><span class="number">115</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x2B06;&#xFE0F;&#x2B06;&#xFE0F;&#x2B06;&#xFE0F;</li>
<li>&#x7B2C; 20 &#x884C; &#xFF1A;&#x83B7;&#x5F97; <code>Consumer</code> &#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;&#x3002;</li>
<li>&#x7B2C; 58 &#x884C; &#xFF1A;&#x4ECE;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x987A;&#x5E8F;&#x83B7;&#x5F97;&#x6D88;&#x606F;&#x3002;<strong>&#x548C;&#x5E76;&#x53D1;&#x6D88;&#x8D39;&#x83B7;&#x5F97;&#x6D88;&#x606F;&#x4E0D;&#x540C;&#x3002;&#x5E76;&#x53D1;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;&#x5728;&#x8BF7;&#x6C42;&#x521B;&#x5EFA;&#x65F6;&#xFF0C;&#x5DF2;&#x7ECF;&#x8BBE;&#x7F6E;&#x597D;&#x6D88;&#x8D39;&#x54EA;&#x4E9B;&#x6D88;&#x606F;&#x3002;</strong></li>
<li>&#x7B2C; 71 &#x884C; &#xFF1A;&#x83B7;&#x5F97; <code>Consumer</code> &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x6D88;&#x8D39;&#x9501;&#x3002;&#x76F8;&#x6BD4;&#x3010;<code>Consumer</code>&#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;&#x3011;&#xFF0C;&#x5176;&#x7C92;&#x5EA6;&#x8F83;&#x5C0F;&#x3002;&#x8FD9;&#x5C31;&#x662F;&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x7684;&#x2753;<strong>&#x4E3A;&#x4EC0;&#x4E48;&#x6709;<code>Consumer</code>&#x6D88;&#x606F;&#x961F;&#x5217;&#x9501;&#x8FD8;&#x9700;&#x8981;&#x6709; Consumer &#x6D88;&#x606F;&#x961F;&#x5217;&#x6D88;&#x8D39;&#x9501;&#x5462;</strong>&#x7684;&#x539F;&#x56E0;&#x3002;</li>
<li>&#x7B2C; 79 &#x884C; &#xFF1A;<strong>&#x6267;&#x884C;&#x6D88;&#x8D39;</strong>&#x3002;</li>
<li>&#x7B2C; 99 &#x884C; &#xFF1A;&#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;&#x3002;</li>
</ul>
<h3 id="3-1-2-&#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;"><a href="#3-1-2-&#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;" class="headerlink" title="3.1.2 &#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;"></a>3.1.2 &#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;</h3><p>&#x987A;&#x5E8F;&#x6D88;&#x8D39;&#x6D88;&#x606F;&#x7ED3;&#x679C; (<code>ConsumeOrderlyStatus</code>) &#x6709;&#x56DB;&#x79CD;&#x60C5;&#x51B5;&#xFF1A;</p>
<ul class="ui list">
<li><code>SUCCESS</code> &#xFF1A;&#x6D88;&#x8D39;&#x6210;&#x529F;<strong>&#x4F46;&#x4E0D;&#x63D0;&#x4EA4;</strong>&#x3002;</li>
<li><code>ROLLBACK</code> &#xFF1A;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#xFF0C;&#x6D88;&#x8D39;&#x56DE;&#x6EDA;&#x3002;</li>
<li><code>COMMIT</code> &#xFF1A;&#x6D88;&#x8D39;&#x6210;&#x529F;&#x63D0;&#x4EA4;&#x5E76;&#x4E14;&#x63D0;&#x4EA4;&#x3002;</li>
<li><code>SUSPEND_CURRENT_QUEUE_A_MOMENT</code> &#xFF1A;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#xFF0C;&#x6302;&#x8D77;&#x6D88;&#x8D39;&#x961F;&#x5217;&#x4E00;&#x4F1A;&#x4F1A;&#xFF0C;&#x7A0D;&#x540E;&#x7EE7;&#x7EED;&#x6D88;&#x8D39;&#x3002;</li>
</ul>
<p>&#x8003;&#x8651;&#x5230; <code>ROLLBACK</code> &#x3001;<code>COMMIT</code> &#x6682;&#x65F6;&#x53EA;&#x4F7F;&#x7528;&#x5728; <code>MySQL binlog</code> &#x573A;&#x666F;&#xFF0C;&#x5B98;&#x65B9;&#x5C06;&#x8FD9;&#x4E24;&#x72B6;&#x6001;&#x6807;&#x8BB0;&#x4E3A; <code>@Deprecated</code>&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x76F8;&#x5E94;&#x7684;&#x5B9E;&#x73B0;&#x903B;&#x8F91;&#x4F9D;&#x7136;&#x4FDD;&#x7559;&#x3002;</p>
<p>&#x5728;<strong>&#x5E76;&#x53D1;&#x6D88;&#x8D39;</strong>&#x573A;&#x666F;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#xFF0C;<code>Consumer</code> &#x4F1A;&#x5C06;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x6D88;&#x606F;&#x53D1;&#x56DE;&#x5230; <code>Broker</code> &#x91CD;&#x8BD5;&#x961F;&#x5217;&#xFF0C;&#x8DF3;&#x8FC7;&#x5F53;&#x524D;&#x6D88;&#x606F;&#xFF0C;&#x7B49;&#x5F85;&#x4E0B;&#x6B21;&#x62C9;&#x53D6;&#x8BE5;&#x6D88;&#x606F;&#x518D;&#x8FDB;&#x884C;&#x6D88;&#x8D39;&#x3002;</p>
<p>&#x4F46;&#x662F;&#x5728;<strong>&#x5B8C;&#x5168;&#x4E25;&#x683C;&#x987A;&#x5E8F;&#x6D88;&#x8D39;</strong>&#x6D88;&#x8D39;&#x65F6;&#xFF0C;&#x8FD9;&#x6837;&#x505A;&#x663E;&#x7136;&#x4E0D;&#x884C;&#x3002;&#x4E5F;&#x56E0;&#x6B64;&#xFF0C;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x4F1A;&#x6302;&#x8D77;&#x961F;&#x5217;&#x4E00;&#x4F1A;&#x4F1A;&#xFF0C;&#x7A0D;&#x540E;&#x7EE7;&#x7EED;&#x6D88;&#x8D39;&#x3002; </p>
<p>&#x4E0D;&#x8FC7;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x7684;&#x6D88;&#x606F;&#x4E00;&#x76F4;&#x5931;&#x8D25;&#xFF0C;&#x4E5F;&#x4E0D;&#x53EF;&#x80FD;&#x4E00;&#x76F4;&#x6D88;&#x8D39;&#x3002;&#x5F53;&#x8D85;&#x8FC7;&#x6D88;&#x8D39;&#x91CD;&#x8BD5;&#x4E0A;&#x9650;&#x65F6;&#xFF0C;<code>Consumer</code> &#x4F1A;&#x5C06;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x8D85;&#x8FC7;&#x4E0A;&#x9650;&#x7684;&#x6D88;&#x606F;&#x53D1;&#x56DE;&#x5230; <code>Broker</code> &#x6B7B;&#x4FE1;&#x961F;&#x5217;&#x3002;</p>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x4EE3;&#x7801;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// &#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x3010;ConsumeMessageOrderlyService.java&#x3011;</span></div><div class="line">  <span class="number">2</span>: <span class="comment">/**</span></div><div class="line">  3:  * &#x5904;&#x7406;&#x6D88;&#x8D39;&#x7ED3;&#x679C;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x662F;&#x5426;&#x7EE7;&#x7EED;&#x6D88;&#x8D39;</div><div class="line">  4:  *</div><div class="line">  5:  * <span class="doctag">@param</span> msgs &#x6D88;&#x606F;</div><div class="line">  6:  * <span class="doctag">@param</span> status &#x6D88;&#x8D39;&#x7ED3;&#x679C;&#x72B6;&#x6001;</div><div class="line">  7:  * <span class="doctag">@param</span> context &#x6D88;&#x8D39;Context</div><div class="line">  8:  * <span class="doctag">@param</span> consumeRequest &#x6D88;&#x8D39;&#x8BF7;&#x6C42;</div><div class="line">  9:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x7EE7;&#x7EED;&#x6D88;&#x8D39;</div><div class="line"> 10:  */</div><div class="line"> <span class="number">11</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processConsumeResult</span><span class="params">(//</span></span></div><div class="line"> <span class="number">12</span>:     <span class="keyword">final</span> List&lt;MessageExt&gt; msgs, //</div><div class="line"> <span class="number">13</span>:     <span class="keyword">final</span> ConsumeOrderlyStatus status, //</div><div class="line"> <span class="number">14</span>:     <span class="keyword">final</span> ConsumeOrderlyContext context, //</div><div class="line"> <span class="number">15</span>:     <span class="keyword">final</span> ConsumeRequest consumeRequest//</div><div class="line"> <span class="number">16</span>: ) {</div><div class="line"> <span class="number">17</span>:     <span class="keyword">boolean</span> continueConsume = <span class="keyword">true</span>;</div><div class="line"> <span class="number">18</span>:     <span class="keyword">long</span> commitOffset = -<span class="number">1L</span>;</div><div class="line"> <span class="number">19</span>:     <span class="keyword">if</span> (context.isAutoCommit()) {</div><div class="line"> <span class="number">20</span>:         <span class="keyword">switch</span> (status) {</div><div class="line"> <span class="number">21</span>:             <span class="keyword">case</span> COMMIT:</div><div class="line"> <span class="number">22</span>:             <span class="keyword">case</span> ROLLBACK:</div><div class="line"> <span class="number">23</span>:                 log.warn(<span class="string">&quot;the message queue consume result is illegal, we think you want to ack these message {}&quot;</span>, consumeRequest.getMessageQueue());</div><div class="line"> <span class="number">24</span>:             <span class="keyword">case</span> SUCCESS:</div><div class="line"> <span class="number">25</span>:                 <span class="comment">// &#x63D0;&#x4EA4;&#x6D88;&#x606F;&#x5DF2;&#x6D88;&#x8D39;&#x6210;&#x529F;&#x5230;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">26</span>:                 commitOffset = consumeRequest.getProcessQueue().commit();</div><div class="line"> <span class="number">27</span>:                 <span class="comment">// &#x7EDF;&#x8BA1;</span></div><div class="line"> <span class="number">28</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">29</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">30</span>:             <span class="keyword">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT:</div><div class="line"> <span class="number">31</span>:                 <span class="comment">// &#x7EDF;&#x8BA1;</span></div><div class="line"> <span class="number">32</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">33</span>:                 <span class="keyword">if</span> (checkReconsumeTimes(msgs)) { <span class="comment">// &#x8BA1;&#x7B97;&#x662F;&#x5426;&#x6682;&#x65F6;&#x6302;&#x8D77;&#xFF08;&#x6682;&#x505C;&#xFF09;&#x6D88;&#x8D39;N&#x6BEB;&#x79D2;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;10ms</span></div><div class="line"> <span class="number">34</span>:                     <span class="comment">// &#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x91CD;&#x65B0;&#x6D88;&#x8D39;</span></div><div class="line"> <span class="number">35</span>:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);</div><div class="line"> <span class="number">36</span>:                     <span class="comment">// &#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</span></div><div class="line"> <span class="number">37</span>:                     <span class="keyword">this</span>.submitConsumeRequestLater(<span class="comment">//</span></div><div class="line"> <span class="number">38</span>:                         consumeRequest.getProcessQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">39</span>:                         consumeRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">40</span>:                         context.getSuspendCurrentQueueTimeMillis());</div><div class="line"> <span class="number">41</span>:                     continueConsume = <span class="keyword">false</span>;</div><div class="line"> <span class="number">42</span>:                 } <span class="keyword">else</span> {</div><div class="line"> <span class="number">43</span>:                     commitOffset = consumeRequest.getProcessQueue().commit();</div><div class="line"> <span class="number">44</span>:                 }</div><div class="line"> <span class="number">45</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">46</span>:             <span class="keyword">default</span>:</div><div class="line"> <span class="number">47</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">48</span>:         }</div><div class="line"> <span class="number">49</span>:     } <span class="keyword">else</span> {</div><div class="line"> <span class="number">50</span>:         <span class="keyword">switch</span> (status) {</div><div class="line"> <span class="number">51</span>:             <span class="keyword">case</span> SUCCESS:</div><div class="line"> <span class="number">52</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">53</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">54</span>:             <span class="keyword">case</span> COMMIT:</div><div class="line"> <span class="number">55</span>:                 <span class="comment">// &#x63D0;&#x4EA4;&#x6D88;&#x606F;&#x5DF2;&#x6D88;&#x8D39;&#x6210;&#x529F;&#x5230;&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">56</span>:                 commitOffset = consumeRequest.getProcessQueue().commit();</div><div class="line"> <span class="number">57</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">58</span>:             <span class="keyword">case</span> ROLLBACK:</div><div class="line"> <span class="number">59</span>:                 <span class="comment">// &#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x91CD;&#x65B0;&#x6D88;&#x8D39;</span></div><div class="line"> <span class="number">60</span>:                 consumeRequest.getProcessQueue().rollback();</div><div class="line"> <span class="number">61</span>:                 <span class="keyword">this</span>.submitConsumeRequestLater(<span class="comment">//</span></div><div class="line"> <span class="number">62</span>:                     consumeRequest.getProcessQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">63</span>:                     consumeRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">64</span>:                     context.getSuspendCurrentQueueTimeMillis());</div><div class="line"> <span class="number">65</span>:                 continueConsume = <span class="keyword">false</span>;</div><div class="line"> <span class="number">66</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">67</span>:             <span class="keyword">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT: <span class="comment">// &#x8BA1;&#x7B97;&#x662F;&#x5426;&#x6682;&#x65F6;&#x6302;&#x8D77;&#xFF08;&#x6682;&#x505C;&#xFF09;&#x6D88;&#x8D39;N&#x6BEB;&#x79D2;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;10ms</span></div><div class="line"> <span class="number">68</span>:                 <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());</div><div class="line"> <span class="number">69</span>:                 <span class="keyword">if</span> (checkReconsumeTimes(msgs)) {</div><div class="line"> <span class="number">70</span>:                     <span class="comment">// &#x8BBE;&#x7F6E;&#x6D88;&#x606F;&#x91CD;&#x65B0;&#x6D88;&#x8D39;</span></div><div class="line"> <span class="number">71</span>:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);</div><div class="line"> <span class="number">72</span>:                     <span class="comment">// &#x63D0;&#x4EA4;&#x5EF6;&#x8FDF;&#x6D88;&#x8D39;&#x8BF7;&#x6C42;</span></div><div class="line"> <span class="number">73</span>:                     <span class="keyword">this</span>.submitConsumeRequestLater(<span class="comment">//</span></div><div class="line"> <span class="number">74</span>:                         consumeRequest.getProcessQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">75</span>:                         consumeRequest.getMessageQueue(), <span class="comment">//</span></div><div class="line"> <span class="number">76</span>:                         context.getSuspendCurrentQueueTimeMillis());</div><div class="line"> <span class="number">77</span>:                     continueConsume = <span class="keyword">false</span>;</div><div class="line"> <span class="number">78</span>:                 }</div><div class="line"> <span class="number">79</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">80</span>:             <span class="keyword">default</span>:</div><div class="line"> <span class="number">81</span>:                 <span class="keyword">break</span>;</div><div class="line"> <span class="number">82</span>:         }</div><div class="line"> <span class="number">83</span>:     }</div><div class="line"> <span class="number">84</span>: </div><div class="line"> <span class="number">85</span>:     <span class="comment">// &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x672A;dropped&#xFF0C;&#x63D0;&#x4EA4;&#x6709;&#x6548;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</span></div><div class="line"> <span class="number">86</span>:     <span class="keyword">if</span> (commitOffset &gt;= <span class="number">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) {</div><div class="line"> <span class="number">87</span>:         <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), commitOffset, <span class="keyword">false</span>);</div><div class="line"> <span class="number">88</span>:     }</div><div class="line"> <span class="number">89</span>: </div><div class="line"> <span class="number">90</span>:     <span class="keyword">return</span> continueConsume;</div><div class="line"> <span class="number">91</span>: }</div><div class="line"> <span class="number">92</span>: </div><div class="line"> <span class="number">93</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getMaxReconsumeTimes</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">94</span>:     <span class="comment">// default reconsume times: Integer.MAX_VALUE</span></div><div class="line"> <span class="number">95</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getMaxReconsumeTimes() == -<span class="number">1</span>) {</div><div class="line"> <span class="number">96</span>:         <span class="keyword">return</span> Integer.MAX_VALUE;</div><div class="line"> <span class="number">97</span>:     } <span class="keyword">else</span> {</div><div class="line"> <span class="number">98</span>:         <span class="keyword">return</span> <span class="keyword">this</span>.defaultMQPushConsumer.getMaxReconsumeTimes();</div><div class="line"> <span class="number">99</span>:     }</div><div class="line"><span class="number">100</span>: }</div><div class="line"><span class="number">101</span>: </div><div class="line"><span class="number">102</span>: <span class="comment">/**</span></div><div class="line">103:  * &#x8BA1;&#x7B97;&#x662F;&#x5426;&#x8981;&#x6682;&#x505C;&#x6D88;&#x8D39;</div><div class="line">104:  * &#x4E0D;&#x6682;&#x505C;&#x6761;&#x4EF6;&#xFF1A;&#x5B58;&#x5728;&#x6D88;&#x606F;&#x90FD;&#x8D85;&#x8FC7;&#x6700;&#x5927;&#x6D88;&#x8D39;&#x6B21;&#x6570;&#x5E76;&#x4E14;&#x90FD;&#x53D1;&#x56DE;broker&#x6210;&#x529F;</div><div class="line">105:  *</div><div class="line">106:  * <span class="doctag">@param</span> msgs &#x6D88;&#x606F;</div><div class="line">107:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x8981;&#x6682;&#x505C;</div><div class="line">108:  */</div><div class="line"><span class="number">109</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkReconsumeTimes</span><span class="params">(List&lt;MessageExt&gt; msgs)</span> </span>{</div><div class="line"><span class="number">110</span>:     <span class="keyword">boolean</span> suspend = <span class="keyword">false</span>;</div><div class="line"><span class="number">111</span>:     <span class="keyword">if</span> (msgs != <span class="keyword">null</span> &amp;&amp; !msgs.isEmpty()) {</div><div class="line"><span class="number">112</span>:         <span class="keyword">for</span> (MessageExt msg : msgs) {</div><div class="line"><span class="number">113</span>:             <span class="keyword">if</span> (msg.getReconsumeTimes() &gt;= getMaxReconsumeTimes()) {</div><div class="line"><span class="number">114</span>:                 MessageAccessor.setReconsumeTime(msg, String.valueOf(msg.getReconsumeTimes()));</div><div class="line"><span class="number">115</span>:                 <span class="keyword">if</span> (!sendMessageBack(msg)) { <span class="comment">// &#x53D1;&#x56DE;&#x5931;&#x8D25;&#xFF0C;&#x4E2D;&#x65AD;</span></div><div class="line"><span class="number">116</span>:                     suspend = <span class="keyword">true</span>;</div><div class="line"><span class="number">117</span>:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">118</span>:                 }</div><div class="line"><span class="number">119</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">120</span>:                 suspend = <span class="keyword">true</span>;</div><div class="line"><span class="number">121</span>:                 msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</div><div class="line"><span class="number">122</span>:             }</div><div class="line"><span class="number">123</span>:         }</div><div class="line"><span class="number">124</span>:     }</div><div class="line"><span class="number">125</span>:     <span class="keyword">return</span> suspend;</div><div class="line"><span class="number">126</span>: }</div><div class="line"><span class="number">127</span>: </div><div class="line"><span class="number">128</span>: <span class="comment">/**</span></div><div class="line">129:  * &#x53D1;&#x56DE;&#x6D88;&#x606F;&#x3002;</div><div class="line">130:  * &#x6D88;&#x606F;&#x53D1;&#x56DE;broker&#x540E;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x662F;&#x6B7B;&#x4FE1;&#x961F;&#x5217;&#x3002;</div><div class="line">131:  *</div><div class="line">132:  * <span class="doctag">@param</span> msg &#x6D88;&#x606F;</div><div class="line">133:  * <span class="doctag">@return</span> &#x662F;&#x5426;&#x53D1;&#x9001;&#x6210;&#x529F;</div><div class="line">134:  */</div><div class="line"><span class="number">135</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageBack</span><span class="params">(<span class="keyword">final</span> MessageExt msg)</span> </span>{</div><div class="line"><span class="number">136</span>:     <span class="keyword">try</span> {</div><div class="line"><span class="number">137</span>:         <span class="comment">// max reconsume times exceeded then send to dead letter queue.</span></div><div class="line"><span class="number">138</span>:         Message newMsg = <span class="keyword">new</span> Message(MixAll.getRetryTopic(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());</div><div class="line"><span class="number">139</span>:         String originMsgId = MessageAccessor.getOriginMessageId(msg);</div><div class="line"><span class="number">140</span>:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);</div><div class="line"><span class="number">141</span>:         newMsg.setFlag(msg.getFlag());</div><div class="line"><span class="number">142</span>:         MessageAccessor.setProperties(newMsg, msg.getProperties());</div><div class="line"><span class="number">143</span>:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());</div><div class="line"><span class="number">144</span>:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes()));</div><div class="line"><span class="number">145</span>:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));</div><div class="line"><span class="number">146</span>:         newMsg.setDelayTimeLevel(<span class="number">3</span> + msg.getReconsumeTimes());</div><div class="line"><span class="number">147</span>: </div><div class="line"><span class="number">148</span>:         <span class="keyword">this</span>.defaultMQPushConsumer.getDefaultMQPushConsumerImpl().getmQClientFactory().getDefaultMQProducer().send(newMsg);</div><div class="line"><span class="number">149</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">150</span>:     } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">151</span>:         log.error(<span class="string">&quot;sendMessageBack exception, group: &quot;</span> + <span class="keyword">this</span>.consumerGroup + <span class="string">&quot; msg: &quot;</span> + msg.toString(), e);</div><div class="line"><span class="number">152</span>:     }</div><div class="line"><span class="number">153</span>: </div><div class="line"><span class="number">154</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">155</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x2B06;&#xFE0F;&#x2B06;&#xFE0F;&#x2B06;&#xFE0F;</li>
<li>&#x7B2C; 21 &#x81F3; 29 &#x884C; &#xFF1A;&#x6D88;&#x8D39;&#x6210;&#x529F;&#x3002;&#x5728;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x8FDB;&#x5EA6;( <code>AutoCommit</code> )&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;<code>COMMIT</code>&#x3001;<code>ROLLBACK</code>&#x3001;<code>SUCCESS</code> &#x903B;&#x8F91;<strong>&#x5DF2;&#x7ECF;&#x7EDF;&#x4E00;</strong>&#x3002;</li>
<li>&#x7B2C; 30 &#x81F3; 45 &#x884C; &#xFF1A;&#x6D88;&#x8D39;&#x5931;&#x8D25;&#x3002;&#x5F53;&#x6D88;&#x606F;&#x91CD;&#x8BD5;&#x6B21;&#x6570;&#x8D85;&#x8FC7;&#x4E0A;&#x9650;&#xFF08;&#x9ED8;&#x8BA4; &#xFF1A;16&#x6B21;&#xFF09;&#x65F6;&#xFF0C;&#x5C06;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x5230; <code>Broker</code> &#x6B7B;&#x4FE1;&#x961F;&#x5217;&#xFF0C;&#x8DF3;&#x8FC7;&#x8FD9;&#x4E9B;&#x6D88;&#x606F;&#x3002;&#x6B64;&#x65F6;&#xFF0C;&#x6D88;&#x606F;&#x961F;&#x5217;&#x65E0;&#x9700;&#x6302;&#x8D77;&#xFF0C;&#x7EE7;&#x7EED;&#x6D88;&#x8D39;&#x540E;&#x9762;&#x7684;&#x6D88;&#x606F;&#x3002;</li>
<li>&#x7B2C; 85 &#x81F3; 88 &#x884C; &#xFF1A;&#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;&#x3002;</li>
</ul>
<h3 id="3-13-&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;"><a href="#3-13-&#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;" class="headerlink" title="3.13 &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;"></a>3.13 &#x6D88;&#x606F;&#x5904;&#x7406;&#x961F;&#x5217;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;</h3><p>&#x1F608;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x56DB;&#x4E2A;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;&#x7684;&#x6E90;&#x7801;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="comment">// &#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x2B07;&#xFE0F;&#x3010;ProcessQueue.java&#x3011;</span></div><div class="line">  <span class="number">2</span>: <span class="comment">/**</span></div><div class="line">  3:  * &#x6D88;&#x606F;&#x6620;&#x5C04;</div><div class="line">  4:  * key&#xFF1A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x4F4D;&#x7F6E;</div><div class="line">  5:  */</div><div class="line">  <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMap = <span class="keyword">new</span> TreeMap&lt;&gt;();    <span class="comment">/**</span></div><div class="line">  7:  * &#x6D88;&#x606F;&#x6620;&#x5C04;&#x4E34;&#x65F6;&#x5B58;&#x50A8;&#xFF08;&#x6D88;&#x8D39;&#x4E2D;&#x7684;&#x6D88;&#x606F;&#xFF09;</div><div class="line">  8:  */</div><div class="line">  <span class="number">9</span>: <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, MessageExt&gt; msgTreeMapTemp = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line"> <span class="number">10</span>: </div><div class="line"> <span class="number">11</span>: <span class="comment">/**</span></div><div class="line"> 12:  * &#x56DE;&#x6EDA;&#x6D88;&#x8D39;&#x4E2D;&#x7684;&#x6D88;&#x606F;</div><div class="line"> 13:  * &#x903B;&#x8F91;&#x7C7B;&#x4F3C;&#x4E8E;{<span class="doctag">@link</span> #makeMessageToCosumeAgain(List)}</div><div class="line"> 14:  */</div><div class="line"> <span class="number">15</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">16</span>:     <span class="keyword">try</span> {</div><div class="line"> <span class="number">17</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">18</span>:         <span class="keyword">try</span> {</div><div class="line"> <span class="number">19</span>:             <span class="keyword">this</span>.msgTreeMap.putAll(<span class="keyword">this</span>.msgTreeMapTemp);</div><div class="line"> <span class="number">20</span>:             <span class="keyword">this</span>.msgTreeMapTemp.clear();</div><div class="line"> <span class="number">21</span>:         } <span class="keyword">finally</span> {</div><div class="line"> <span class="number">22</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"> <span class="number">23</span>:         }</div><div class="line"> <span class="number">24</span>:     } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"> <span class="number">25</span>:         log.error(<span class="string">&quot;rollback exception&quot;</span>, e);</div><div class="line"> <span class="number">26</span>:     }</div><div class="line"> <span class="number">27</span>: }</div><div class="line"> <span class="number">28</span>: </div><div class="line"> <span class="number">29</span>: <span class="comment">/**</span></div><div class="line"> 30:  * &#x63D0;&#x4EA4;&#x6D88;&#x8D39;&#x4E2D;&#x7684;&#x6D88;&#x606F;&#x5DF2;&#x6D88;&#x8D39;&#x6210;&#x529F;&#xFF0C;&#x8FD4;&#x56DE;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</div><div class="line"> 31:  *</div><div class="line"> 32:  * <span class="doctag">@return</span> &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</div><div class="line"> 33:  */</div><div class="line"> <span class="number">34</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">commit</span><span class="params">()</span> </span>{</div><div class="line"> <span class="number">35</span>:     <span class="keyword">try</span> {</div><div class="line"> <span class="number">36</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">37</span>:         <span class="keyword">try</span> {</div><div class="line"> <span class="number">38</span>:             <span class="comment">// &#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</span></div><div class="line"> <span class="number">39</span>:             Long offset = <span class="keyword">this</span>.msgTreeMapTemp.lastKey();</div><div class="line"> <span class="number">40</span>: </div><div class="line"> <span class="number">41</span>:             <span class="comment">//</span></div><div class="line"> <span class="number">42</span>:             msgCount.addAndGet(<span class="keyword">this</span>.msgTreeMapTemp.size() * (-<span class="number">1</span>));</div><div class="line"> <span class="number">43</span>: </div><div class="line"> <span class="number">44</span>:             <span class="comment">//</span></div><div class="line"> <span class="number">45</span>:             <span class="keyword">this</span>.msgTreeMapTemp.clear();</div><div class="line"> <span class="number">46</span>: </div><div class="line"> <span class="number">47</span>:             <span class="comment">// &#x8FD4;&#x56DE;&#x6D88;&#x8D39;&#x8FDB;&#x5EA6;</span></div><div class="line"> <span class="number">48</span>:             <span class="keyword">if</span> (offset != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">49</span>:                 <span class="keyword">return</span> offset + <span class="number">1</span>;</div><div class="line"> <span class="number">50</span>:             }</div><div class="line"> <span class="number">51</span>:         } <span class="keyword">finally</span> {</div><div class="line"> <span class="number">52</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"> <span class="number">53</span>:         }</div><div class="line"> <span class="number">54</span>:     } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"> <span class="number">55</span>:         log.error(<span class="string">&quot;commit exception&quot;</span>, e);</div><div class="line"> <span class="number">56</span>:     }</div><div class="line"> <span class="number">57</span>: </div><div class="line"> <span class="number">58</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"> <span class="number">59</span>: }</div><div class="line"> <span class="number">60</span>: </div><div class="line"> <span class="number">61</span>: <span class="comment">/**</span></div><div class="line"> 62:  * &#x6307;&#x5B9A;&#x6D88;&#x606F;&#x91CD;&#x65B0;&#x6D88;&#x8D39;</div><div class="line"> 63:  * &#x903B;&#x8F91;&#x7C7B;&#x4F3C;&#x4E8E;{<span class="doctag">@link</span> #rollback()}</div><div class="line"> 64:  *</div><div class="line"> 65:  * <span class="doctag">@param</span> msgs &#x6D88;&#x606F;</div><div class="line"> 66:  */</div><div class="line"> <span class="number">67</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeMessageToCosumeAgain</span><span class="params">(List&lt;MessageExt&gt; msgs)</span> </span>{</div><div class="line"> <span class="number">68</span>:     <span class="keyword">try</span> {</div><div class="line"> <span class="number">69</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">70</span>:         <span class="keyword">try</span> {</div><div class="line"> <span class="number">71</span>:             <span class="keyword">for</span> (MessageExt msg : msgs) {</div><div class="line"> <span class="number">72</span>:                 <span class="keyword">this</span>.msgTreeMapTemp.remove(msg.getQueueOffset());</div><div class="line"> <span class="number">73</span>:                 <span class="keyword">this</span>.msgTreeMap.put(msg.getQueueOffset(), msg);</div><div class="line"> <span class="number">74</span>:             }</div><div class="line"> <span class="number">75</span>:         } <span class="keyword">finally</span> {</div><div class="line"> <span class="number">76</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"> <span class="number">77</span>:         }</div><div class="line"> <span class="number">78</span>:     } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"> <span class="number">79</span>:         log.error(<span class="string">&quot;makeMessageToCosumeAgain exception&quot;</span>, e);</div><div class="line"> <span class="number">80</span>:     }</div><div class="line"> <span class="number">81</span>: }</div><div class="line"> <span class="number">82</span>: </div><div class="line"> <span class="number">83</span>: <span class="comment">/**</span></div><div class="line"> 84:  * &#x83B7;&#x5F97;&#x6301;&#x6709;&#x6D88;&#x606F;&#x524D;N&#x6761;</div><div class="line"> 85:  *</div><div class="line"> 86:  * <span class="doctag">@param</span> batchSize &#x6761;&#x6570;</div><div class="line"> 87:  * <span class="doctag">@return</span> &#x6D88;&#x606F;</div><div class="line"> 88:  */</div><div class="line"> <span class="number">89</span>: <span class="function"><span class="keyword">public</span> List&lt;MessageExt&gt; <span class="title">takeMessags</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> batchSize)</span> </span>{</div><div class="line"> <span class="number">90</span>:     List&lt;MessageExt&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(batchSize);</div><div class="line"> <span class="number">91</span>:     <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</div><div class="line"> <span class="number">92</span>:     <span class="keyword">try</span> {</div><div class="line"> <span class="number">93</span>:         <span class="keyword">this</span>.lockTreeMap.writeLock().lockInterruptibly();</div><div class="line"> <span class="number">94</span>:         <span class="keyword">this</span>.lastConsumeTimestamp = now;</div><div class="line"> <span class="number">95</span>:         <span class="keyword">try</span> {</div><div class="line"> <span class="number">96</span>:             <span class="keyword">if</span> (!<span class="keyword">this</span>.msgTreeMap.isEmpty()) {</div><div class="line"> <span class="number">97</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; batchSize; i++) {</div><div class="line"> <span class="number">98</span>:                     Map.Entry&lt;Long, MessageExt&gt; entry = <span class="keyword">this</span>.msgTreeMap.pollFirstEntry();</div><div class="line"> <span class="number">99</span>:                     <span class="keyword">if</span> (entry != <span class="keyword">null</span>) {</div><div class="line"><span class="number">100</span>:                         result.add(entry.getValue());</div><div class="line"><span class="number">101</span>:                         msgTreeMapTemp.put(entry.getKey(), entry.getValue());</div><div class="line"><span class="number">102</span>:                     } <span class="keyword">else</span> {</div><div class="line"><span class="number">103</span>:                         <span class="keyword">break</span>;</div><div class="line"><span class="number">104</span>:                     }</div><div class="line"><span class="number">105</span>:                 }</div><div class="line"><span class="number">106</span>:             }</div><div class="line"><span class="number">107</span>: </div><div class="line"><span class="number">108</span>:             <span class="keyword">if</span> (result.isEmpty()) {</div><div class="line"><span class="number">109</span>:                 consuming = <span class="keyword">false</span>;</div><div class="line"><span class="number">110</span>:             }</div><div class="line"><span class="number">111</span>:         } <span class="keyword">finally</span> {</div><div class="line"><span class="number">112</span>:             <span class="keyword">this</span>.lockTreeMap.writeLock().unlock();</div><div class="line"><span class="number">113</span>:         }</div><div class="line"><span class="number">114</span>:     } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"><span class="number">115</span>:         log.error(<span class="string">&quot;take Messages exception&quot;</span>, e);</div><div class="line"><span class="number">116</span>:     }</div><div class="line"><span class="number">117</span>: </div><div class="line"><span class="number">118</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">119</span>: }</div></pre></td></tr></table></figure>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-概述"><span class="toc-number">1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Producer-顺序发送"><span class="toc-number">2.</span> <span class="toc-text">2. Producer 顺序发送</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Consumer-严格顺序消费"><span class="toc-number">3.</span> <span class="toc-text">3. Consumer 严格顺序消费</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-获得-锁定-消息队列"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 获得(锁定)消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-移除消息队列"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 移除消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-消费消息队列"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 消费消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-消费消息"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1.1 消费消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-处理消费结果"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.1.2 处理消费结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-13-消息处理队列核心方法"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.13 消息处理队列核心方法</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&text=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&is_video=false&description=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RocketMQ 源码分析 —— Message 顺序发送与消费&body=Check out this article: http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&title=RocketMQ 源码分析 —— Message 顺序发送与消费" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/RocketMQ/message-send-and-consume-orderly/&name=RocketMQ 源码分析 —— Message 顺序发送与消费&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 王文斌
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO 待优化：过滤 爬虫
        url = $('#actions .icon').attr('href').trim(); // 文章url
//        alert(url);
        title = $('.posttitle').text().trim(); // 文章标题
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // 插入次数
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // 插入次数
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // 获取uid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip 浏览器无法获取
        // time 服务端已经记录
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO 待优化：此处性能较差，可能
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // 判断是否在文章页
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // 增加文章访问次数
                addCount(Counter);
            }
            // 记录访问日志
            addVisitLog();
            // 计算多少人访问
            countVisitLog();
        }, 1000);
    });
</script>
