<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="google-site-verification" content="GkJ68PCnxM9Ih7Zm9v8p91FOCV7ymNCO2KdGbflLh3E">
    <meta name="360-site-verification" content="dd6547587641bfede036f7c79561e8a0">
    <meta name="shenma-site-verification" content="fd96cf3751972c9b05f8471d2ccadddc_1496951214">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="msvalidate.01" content="1D38B05050A977F6FDEDA481198343F1">
    <meta name="sogou_site_verification" content="MpPsku240L">
    <meta name="description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMQ 源码分析 —— Message 发送与接收">
<meta property="og:url" content="http://www.yunai.me/RocketMQ/message-send-and-receive/index.html">
<meta property="og:site_name" content="芋艿V的博客">
<meta property="og:description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta property="og:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_04_18/01.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_04_18/02.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_04_18/03.png">
<meta property="og:image" content="http://www.yunai.me/images/RocketMQ/2017_04_18/04.png">
<meta property="og:updated_time" content="2017-07-20T01:40:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RocketMQ 源码分析 —— Message 发送与接收">
<meta name="twitter:description" content="&amp;#x1F642;&amp;#x1F642;&amp;#x1F642;&amp;#x5173;&amp;#x6CE8;&amp;#x5FAE;&amp;#x4FE1;&amp;#x516C;&amp;#x4F17;&amp;#x53F7;&amp;#xFF1A;&amp;#x3010;&amp;#x828B;&amp;#x827F;&amp;#x7684;&amp;#x540E;&amp;#x7AEF;&amp;#x5C0F;&amp;#x5C4B;&amp;#x3011;&amp;#x6709;&amp;#x798F;&amp;#x5229;&amp;#xFF1A;">
<meta name="twitter:image" content="http://www.yunai.me/images/common/wechat_mp.jpeg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>RocketMQ 源码分析 —— Message 发送与接收</title>
    <!-- keywords -->
    
    <meta name="keywords" content="Java,架构,后端,服务端,RocketMQ,MyCAT,分布式消息队列,分布式存储,技术博客">
    
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    


    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>AV.initialize("uxUSudJeAFuAk0PKwFMY7MJW-gzGzoHsz", "NTPUE2VIEE0gyPPGbAaLPtLb");</script>
    <!-- 百度统计 -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ef4ed89f6dc83d01803a2440ae21e666";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <!-- 百度站长-被动推送 -->
    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- 360搜索-自动收录 -->
    <script>
        (function(){
            var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?f05b61dd54bbc38386611a5238672938":"https://jspassport.ssl.qhimg.com/11.0.1.js?f05b61dd54bbc38386611a5238672938";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" class="active"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:visible;">
    <i class="fa fa-chevron-up fa-lg"></i>
  </a>
  <span id="menu" style="visibility: visible;">
    <span id="nav">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/RocketMQ/message-store/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$(" #i-prev").toggle();"="" onmouseout="$("></i></a></li>
        
        
        <li><a class="icon" href="/RocketMQ/message/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$(" #i-next").toggle();"="" onmouseout="$("></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$(" #i-top").toggle();"="" onmouseout="$("></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$(" #i-share").toggle();"="" onmouseout="$(" onclick="$(" #share").toggle();return="" false;"=""></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/RocketMQ/message-send-and-receive/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&text=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&title=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&is_video=false&description=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RocketMQ 源码分析 —— Message 发送与接收&body=Check out this article: http://www.yunai.me/RocketMQ/message-send-and-receive/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&title=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&title=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&title=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&title=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&name=RocketMQ 源码分析 —— Message 发送与接收&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1、概述"><span class="toc-number">1.</span> <span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2、Producer-发送消息"><span class="toc-number">2.</span> <span class="toc-text">2、Producer 发送消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQProducer-send-Message"><span class="toc-number">2.1.</span> <span class="toc-text">DefaultMQProducer#send(Message)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQProducerImpl-sendDefaultImpl"><span class="toc-number">2.2.</span> <span class="toc-text">DefaultMQProducerImpl#sendDefaultImpl()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultMQProducerImpl-tryToFindTopicPublishInfo"><span class="toc-number">2.2.1.</span> <span class="toc-text">DefaultMQProducerImpl#tryToFindTopicPublishInfo()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQFaultStrategy"><span class="toc-number">2.2.2.</span> <span class="toc-text">MQFaultStrategy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MQFaultStrategy-1"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">MQFaultStrategy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LatencyFaultTolerance"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">LatencyFaultTolerance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LatencyFaultToleranceImpl"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">LatencyFaultToleranceImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FaultItem"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">FaultItem</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultMQProducerImpl-sendKernelImpl"><span class="toc-number">2.2.3.</span> <span class="toc-text">DefaultMQProducerImpl#sendKernelImpl()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3、Broker-接收消息"><span class="toc-number">3.</span> <span class="toc-text">3、Broker 接收消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SendMessageProcessor-sendMessage"><span class="toc-number">3.1.</span> <span class="toc-text">SendMessageProcessor#sendMessage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractSendMessageProcessor-msgCheck"><span class="toc-number">3.1.1.</span> <span class="toc-text">AbstractSendMessageProcessor#msgCheck</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMessageStore-putMessage"><span class="toc-number">3.2.</span> <span class="toc-text">DefaultMessageStore#putMessage</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4、某种结尾"><span class="toc-number">4.</span> <span class="toc-text">4、某种结尾</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        RocketMQ 源码分析 —— Message 发送与接收
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">芋艿V的博客</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-04-17T16:00:00.000Z" itemprop="datePublished">2017-04-18</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><a class="magnific-img" href="http://www.yunai.me/images/common/wechat_mp.jpeg"><img src="http://www.yunai.me/images/common/wechat_mp.jpeg" alt="" class="ui centered image"></a></p>
<blockquote>
<p>&#x1F642;&#x1F642;&#x1F642;&#x5173;&#x6CE8;<strong>&#x5FAE;&#x4FE1;&#x516C;&#x4F17;&#x53F7;&#xFF1A;&#x3010;&#x828B;&#x827F;&#x7684;&#x540E;&#x7AEF;&#x5C0F;&#x5C4B;&#x3011;</strong>&#x6709;&#x798F;&#x5229;&#xFF1A;  </p>
<ol class="ui list">
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>&#x6240;&#x6709;</strong>&#x6E90;&#x7801;&#x5206;&#x6790;&#x6587;&#x7AE0;&#x5217;&#x8868;  </li>
<li>RocketMQ / MyCAT / Sharding-JDBC <strong>&#x4E2D;&#x6587;&#x6CE8;&#x91CA;&#x6E90;&#x7801; GitHub &#x5730;&#x5740;</strong>  </li>
<li>&#x60A8;&#x5BF9;&#x4E8E;&#x6E90;&#x7801;&#x7684;&#x7591;&#x95EE;&#x6BCF;&#x6761;&#x7559;&#x8A00;<strong>&#x90FD;</strong>&#x5C06;&#x5F97;&#x5230;<strong>&#x8BA4;&#x771F;</strong>&#x56DE;&#x590D;&#x3002;<strong>&#x751A;&#x81F3;&#x4E0D;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x8BFB;&#x6E90;&#x7801;&#x4E5F;&#x53EF;&#x4EE5;&#x8BF7;&#x6559;&#x5662;</strong>&#x3002;  </li>
<li><strong>&#x65B0;&#x7684;</strong>&#x6E90;&#x7801;&#x89E3;&#x6790;&#x6587;&#x7AE0;<strong>&#x5B9E;&#x65F6;</strong>&#x6536;&#x5230;&#x901A;&#x77E5;&#x3002;<strong>&#x6BCF;&#x5468;&#x66F4;&#x65B0;&#x4E00;&#x7BC7;&#x5DE6;&#x53F3;</strong>&#x3002;</li>
</ol>
</blockquote>
<hr>
<ul class="ui list">
<li><a href="#">1&#x3001;&#x6982;&#x8FF0;</a></li>
<li><a href="#">2&#x3001;Producer &#x53D1;&#x9001;&#x6D88;&#x606F;</a><ul>
<li><a href="#">DefaultMQProducer#send(Message)</a></li>
<li><a href="#">DefaultMQProducerImpl#sendDefaultImpl()</a><ul>
<li><a href="#">DefaultMQProducerImpl#tryToFindTopicPublishInfo()</a></li>
<li><a href="#">MQFaultStrategy</a><ul>
<li><a href="#">MQFaultStrategy</a></li>
<li><a href="#">LatencyFaultTolerance</a></li>
<li><a href="#">LatencyFaultToleranceImpl</a></li>
<li><a href="#">FaultItem</a></li>
</ul>
</li>
<li><a href="#">DefaultMQProducerImpl#sendKernelImpl()</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#">3&#x3001;Broker &#x63A5;&#x6536;&#x6D88;&#x606F;</a><ul>
<li><a href="#">SendMessageProcessor#sendMessage</a><ul>
<li><a href="#">AbstractSendMessageProcessor#msgCheck</a></li>
</ul>
</li>
<li><a href="#">DefaultMessageStore#putMessage</a></li>
</ul>
</li>
<li><a href="#">4&#x3001;&#x67D0;&#x79CD;&#x7ED3;&#x5C3E;</a></li>
</ul>
<h1 id="1&#x3001;&#x6982;&#x8FF0;"><a href="#1&#x3001;&#x6982;&#x8FF0;" class="headerlink" title="1&#x3001;&#x6982;&#x8FF0;"></a>1&#x3001;&#x6982;&#x8FF0;</h1><ol class="ui list">
<li><code>Producer</code> &#x53D1;&#x9001;&#x6D88;&#x606F;&#x3002;&#x4E3B;&#x8981;&#x662F;<strong>&#x540C;&#x6B65;</strong>&#x53D1;&#x9001;&#x6D88;&#x606F;&#x6E90;&#x7801;&#xFF0C;&#x6D89;&#x53CA;&#x5230; &#x5F02;&#x6B65;/Oneway&#x53D1;&#x9001;&#x6D88;&#x606F;&#xFF0C;&#x4E8B;&#x52A1;&#x6D88;&#x606F;&#x4F1A;&#x8DF3;&#x8FC7;&#x3002;</li>
<li><code>Broker</code> &#x63A5;&#x6536;&#x6D88;&#x606F;&#x3002;(<em>&#x5B58;&#x50A8;&#x6D88;&#x606F;&#x5728;<a href="http://www.yunai.me/RocketMQ/message-store/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Message &#x5B58;&#x50A8;&#x300B;</a>&#x89E3;&#x6790;</em>)</li>
</ol>
<blockquote>
<p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_04_18/01.png"><img src="http://www.yunai.me/images/RocketMQ/2017_04_18/01.png" alt="Producer&#x53D1;&#x9001;&#x6D88;&#x606F;&#x5168;&#x5C40;&#x987A;&#x5E8F;&#x56FE;" class="ui centered image"></a></p>
</blockquote>
<h1 id="2&#x3001;Producer-&#x53D1;&#x9001;&#x6D88;&#x606F;"><a href="#2&#x3001;Producer-&#x53D1;&#x9001;&#x6D88;&#x606F;" class="headerlink" title="2&#x3001;Producer &#x53D1;&#x9001;&#x6D88;&#x606F;"></a>2&#x3001;Producer &#x53D1;&#x9001;&#x6D88;&#x606F;</h1><blockquote>
<p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_04_18/02.png"><img src="http://www.yunai.me/images/RocketMQ/2017_04_18/02.png" alt="Producer&#x53D1;&#x9001;&#x6D88;&#x606F;&#x987A;&#x5E8F;&#x56FE;" class="ui centered image"></a></p>
</blockquote>
<h2 id="DefaultMQProducer-send-Message"><a href="#DefaultMQProducer-send-Message" class="headerlink" title="DefaultMQProducer#send(Message)"></a>DefaultMQProducer#send(Message)</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span>: <span class="meta">@Override</span></div><div class="line"><span class="number">2</span>: <span class="function"><span class="keyword">public</span> SendResult <span class="title">send</span><span class="params">(Message msg)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>{</div><div class="line"><span class="number">3</span>:     <span class="keyword">return</span> <span class="keyword">this</span>.defaultMQProducerImpl.send(msg);</div><div class="line"><span class="number">4</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E;&#xFF1A;&#x53D1;&#x9001;&#x540C;&#x6B65;&#x6D88;&#x606F;&#xFF0C;<code>DefaultMQProducer#send(Message)</code> &#x5BF9; <code>DefaultMQProducerImpl#send(Message)</code> &#x8FDB;&#x884C;&#x5C01;&#x88C5;&#x3002;  </li>
</ul>
<h2 id="DefaultMQProducerImpl-sendDefaultImpl"><a href="#DefaultMQProducerImpl-sendDefaultImpl" class="headerlink" title="DefaultMQProducerImpl#sendDefaultImpl()"></a>DefaultMQProducerImpl#sendDefaultImpl()</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> SendResult <span class="title">send</span><span class="params">(Message msg)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>{</div><div class="line">  <span class="number">2</span>:     <span class="keyword">return</span> send(msg, <span class="keyword">this</span>.defaultMQProducer.getSendMsgTimeout());</div><div class="line">  <span class="number">3</span>: }</div><div class="line">  <span class="number">4</span>: </div><div class="line">  <span class="number">5</span>: <span class="function"><span class="keyword">public</span> SendResult <span class="title">send</span><span class="params">(Message msg, <span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>{</div><div class="line">  <span class="number">6</span>:     <span class="keyword">return</span> <span class="keyword">this</span>.sendDefaultImpl(msg, CommunicationMode.SYNC, <span class="keyword">null</span>, timeout);</div><div class="line">  <span class="number">7</span>: }</div><div class="line">  <span class="number">8</span>: </div><div class="line">  <span class="number">9</span>: <span class="function"><span class="keyword">private</span> SendResult <span class="title">sendDefaultImpl</span><span class="params">(//</span></span></div><div class="line"> <span class="number">10</span>:     Message msg, //</div><div class="line"> <span class="number">11</span>:     <span class="keyword">final</span> CommunicationMode communicationMode, //</div><div class="line"> <span class="number">12</span>:     <span class="keyword">final</span> SendCallback sendCallback, //</div><div class="line"> <span class="number">13</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeout//</div><div class="line"> <span class="number">14</span>: ) <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException {</div><div class="line"> <span class="number">15</span>:     <span class="comment">// &#x6821;&#x9A8C; Producer &#x5904;&#x4E8E;&#x8FD0;&#x884C;&#x72B6;&#x6001;</span></div><div class="line"> <span class="number">16</span>:     <span class="keyword">this</span>.makeSureStateOK();</div><div class="line"> <span class="number">17</span>:     <span class="comment">// &#x6821;&#x9A8C;&#x6D88;&#x606F;&#x683C;&#x5F0F;</span></div><div class="line"> <span class="number">18</span>:     Validators.checkMessage(msg, <span class="keyword">this</span>.defaultMQProducer);</div><div class="line"> <span class="number">19</span>:     <span class="comment">//</span></div><div class="line"> <span class="number">20</span>:     <span class="keyword">final</span> <span class="keyword">long</span> invokeID = random.nextLong(); <span class="comment">// &#x8C03;&#x7528;&#x7F16;&#x53F7;&#xFF1B;&#x7528;&#x4E8E;&#x4E0B;&#x9762;&#x6253;&#x5370;&#x65E5;&#x5FD7;&#xFF0C;&#x6807;&#x8BB0;&#x4E3A;&#x540C;&#x4E00;&#x6B21;&#x53D1;&#x9001;&#x6D88;&#x606F;</span></div><div class="line"> <span class="number">21</span>:     <span class="keyword">long</span> beginTimestampFirst = System.currentTimeMillis();</div><div class="line"> <span class="number">22</span>:     <span class="keyword">long</span> beginTimestampPrev = beginTimestampFirst;</div><div class="line"> <span class="number">23</span>:     <span class="keyword">long</span> endTimestamp = beginTimestampFirst;</div><div class="line"> <span class="number">24</span>:     <span class="comment">// &#x83B7;&#x53D6; Topic&#x8DEF;&#x7531;&#x4FE1;&#x606F;</span></div><div class="line"> <span class="number">25</span>:     TopicPublishInfo topicPublishInfo = <span class="keyword">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</div><div class="line"> <span class="number">26</span>:     <span class="keyword">if</span> (topicPublishInfo != <span class="keyword">null</span> &amp;&amp; topicPublishInfo.ok()) {</div><div class="line"> <span class="number">27</span>:         MessageQueue mq = <span class="keyword">null</span>; <span class="comment">// &#x6700;&#x540E;&#x9009;&#x62E9;&#x6D88;&#x606F;&#x8981;&#x53D1;&#x9001;&#x5230;&#x7684;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">28</span>:         Exception exception = <span class="keyword">null</span>;</div><div class="line"> <span class="number">29</span>:         SendResult sendResult = <span class="keyword">null</span>; <span class="comment">// &#x6700;&#x540E;&#x4E00;&#x6B21;&#x53D1;&#x9001;&#x7ED3;&#x679C;</span></div><div class="line"> <span class="number">30</span>:         <span class="keyword">int</span> timesTotal = communicationMode == CommunicationMode.SYNC ? <span class="number">1</span> + <span class="keyword">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class="number">1</span>; <span class="comment">// &#x540C;&#x6B65;&#x591A;&#x6B21;&#x8C03;&#x7528;</span></div><div class="line"> <span class="number">31</span>:         <span class="keyword">int</span> times = <span class="number">0</span>; <span class="comment">// &#x7B2C;&#x51E0;&#x6B21;&#x53D1;&#x9001;</span></div><div class="line"> <span class="number">32</span>:         String[] brokersSent = <span class="keyword">new</span> String[timesTotal]; <span class="comment">// &#x5B58;&#x50A8;&#x6BCF;&#x6B21;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x9009;&#x62E9;&#x7684;broker&#x540D;</span></div><div class="line"> <span class="number">33</span>:         <span class="comment">// &#x5FAA;&#x73AF;&#x8C03;&#x7528;&#x53D1;&#x9001;&#x6D88;&#x606F;&#xFF0C;&#x76F4;&#x5230;&#x6210;&#x529F;</span></div><div class="line"> <span class="number">34</span>:         <span class="keyword">for</span> (; times &lt; timesTotal; times++) {</div><div class="line"> <span class="number">35</span>:             String lastBrokerName = <span class="keyword">null</span> == mq ? <span class="keyword">null</span> : mq.getBrokerName();</div><div class="line"> <span class="number">36</span>:             MessageQueue tmpmq = <span class="keyword">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName); <span class="comment">// &#x9009;&#x62E9;&#x6D88;&#x606F;&#x8981;&#x53D1;&#x9001;&#x5230;&#x7684;&#x961F;&#x5217;</span></div><div class="line"> <span class="number">37</span>:             <span class="keyword">if</span> (tmpmq != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">38</span>:                 mq = tmpmq;</div><div class="line"> <span class="number">39</span>:                 brokersSent[times] = mq.getBrokerName();</div><div class="line"> <span class="number">40</span>:                 <span class="keyword">try</span> {</div><div class="line"> <span class="number">41</span>:                     beginTimestampPrev = System.currentTimeMillis();</div><div class="line"> <span class="number">42</span>:                     <span class="comment">// &#x8C03;&#x7528;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;</span></div><div class="line"> <span class="number">43</span>:                     sendResult = <span class="keyword">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);</div><div class="line"> <span class="number">44</span>:                     endTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">45</span>:                     <span class="comment">// &#x66F4;&#x65B0;Broker&#x53EF;&#x7528;&#x6027;&#x4FE1;&#x606F;</span></div><div class="line"> <span class="number">46</span>:                     <span class="keyword">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="keyword">false</span>);</div><div class="line"> <span class="number">47</span>:                     <span class="keyword">switch</span> (communicationMode) {</div><div class="line"> <span class="number">48</span>:                         <span class="keyword">case</span> ASYNC:</div><div class="line"> <span class="number">49</span>:                             <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">50</span>:                         <span class="keyword">case</span> ONEWAY:</div><div class="line"> <span class="number">51</span>:                             <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">52</span>:                         <span class="keyword">case</span> SYNC:</div><div class="line"> <span class="number">53</span>:                             <span class="keyword">if</span> (sendResult.getSendStatus() != SendStatus.SEND_OK) {</div><div class="line"> <span class="number">54</span>:                                 <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) { <span class="comment">// &#x540C;&#x6B65;&#x53D1;&#x9001;&#x6210;&#x529F;&#x4F46;&#x5B58;&#x50A8;&#x6709;&#x95EE;&#x9898;&#x65F6; &amp;&amp; &#x914D;&#x7F6E;&#x5B58;&#x50A8;&#x5F02;&#x5E38;&#x65F6;&#x91CD;&#x65B0;&#x53D1;&#x9001;&#x5F00;&#x5173; &#x65F6;&#xFF0C;&#x8FDB;&#x884C;&#x91CD;&#x8BD5;</span></div><div class="line"> <span class="number">55</span>:                                     <span class="keyword">continue</span>;</div><div class="line"> <span class="number">56</span>:                                 }</div><div class="line"> <span class="number">57</span>:                             }</div><div class="line"> <span class="number">58</span>:                             <span class="keyword">return</span> sendResult;</div><div class="line"> <span class="number">59</span>:                         <span class="keyword">default</span>:</div><div class="line"> <span class="number">60</span>:                             <span class="keyword">break</span>;</div><div class="line"> <span class="number">61</span>:                     }</div><div class="line"> <span class="number">62</span>:                 } <span class="keyword">catch</span> (RemotingException e) { <span class="comment">// &#x6253;&#x5370;&#x5F02;&#x5E38;&#xFF0C;&#x66F4;&#x65B0;Broker&#x53EF;&#x7528;&#x6027;&#x4FE1;&#x606F;&#xFF0C;&#x66F4;&#x65B0;&#x7EE7;&#x7EED;&#x5FAA;&#x73AF;</span></div><div class="line"> <span class="number">63</span>:                     endTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">64</span>:                     <span class="keyword">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="keyword">true</span>);</div><div class="line"> <span class="number">65</span>:                     log.warn(String.format(<span class="string">&quot;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&quot;</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class="line"> <span class="number">66</span>:                     log.warn(msg.toString());</div><div class="line"> <span class="number">67</span>:                     exception = e;</div><div class="line"> <span class="number">68</span>:                     <span class="keyword">continue</span>;</div><div class="line"> <span class="number">69</span>:                 } <span class="keyword">catch</span> (MQClientException e) { <span class="comment">// &#x6253;&#x5370;&#x5F02;&#x5E38;&#xFF0C;&#x66F4;&#x65B0;Broker&#x53EF;&#x7528;&#x6027;&#x4FE1;&#x606F;&#xFF0C;&#x7EE7;&#x7EED;&#x5FAA;&#x73AF;</span></div><div class="line"> <span class="number">70</span>:                     endTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">71</span>:                     <span class="keyword">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="keyword">true</span>);</div><div class="line"> <span class="number">72</span>:                     log.warn(String.format(<span class="string">&quot;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&quot;</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class="line"> <span class="number">73</span>:                     log.warn(msg.toString());</div><div class="line"> <span class="number">74</span>:                     exception = e;</div><div class="line"> <span class="number">75</span>:                     <span class="keyword">continue</span>;</div><div class="line"> <span class="number">76</span>:                 } <span class="keyword">catch</span> (MQBrokerException e) { <span class="comment">// &#x6253;&#x5370;&#x5F02;&#x5E38;&#xFF0C;&#x66F4;&#x65B0;Broker&#x53EF;&#x7528;&#x6027;&#x4FE1;&#x606F;&#xFF0C;&#x90E8;&#x5206;&#x60C5;&#x51B5;&#x4E0B;&#x7684;&#x5F02;&#x5E38;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#xFF0C;&#x7ED3;&#x675F;&#x5FAA;&#x73AF;</span></div><div class="line"> <span class="number">77</span>:                     endTimestamp = System.currentTimeMillis();</div><div class="line"> <span class="number">78</span>:                     <span class="keyword">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="keyword">true</span>);</div><div class="line"> <span class="number">79</span>:                     log.warn(String.format(<span class="string">&quot;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&quot;</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class="line"> <span class="number">80</span>:                     log.warn(msg.toString());</div><div class="line"> <span class="number">81</span>:                     exception = e;</div><div class="line"> <span class="number">82</span>:                     <span class="keyword">switch</span> (e.getResponseCode()) {</div><div class="line"> <span class="number">83</span>:                         <span class="comment">// &#x5982;&#x4E0B;&#x5F02;&#x5E38;continue&#xFF0C;&#x8FDB;&#x884C;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x91CD;&#x8BD5;</span></div><div class="line"> <span class="number">84</span>:                         <span class="keyword">case</span> ResponseCode.TOPIC_NOT_EXIST:</div><div class="line"> <span class="number">85</span>:                         <span class="keyword">case</span> ResponseCode.SERVICE_NOT_AVAILABLE:</div><div class="line"> <span class="number">86</span>:                         <span class="keyword">case</span> ResponseCode.SYSTEM_ERROR:</div><div class="line"> <span class="number">87</span>:                         <span class="keyword">case</span> ResponseCode.NO_PERMISSION:</div><div class="line"> <span class="number">88</span>:                         <span class="keyword">case</span> ResponseCode.NO_BUYER_ID:</div><div class="line"> <span class="number">89</span>:                         <span class="keyword">case</span> ResponseCode.NOT_IN_CURRENT_UNIT:</div><div class="line"> <span class="number">90</span>:                             <span class="keyword">continue</span>;</div><div class="line"> <span class="number">91</span>:                         <span class="comment">// &#x5982;&#x679C;&#x6709;&#x53D1;&#x9001;&#x7ED3;&#x679C;&#xFF0C;&#x8FDB;&#x884C;&#x8FD4;&#x56DE;&#xFF0C;&#x5426;&#x5219;&#xFF0C;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#xFF1B;</span></div><div class="line"> <span class="number">92</span>:                         <span class="keyword">default</span>:</div><div class="line"> <span class="number">93</span>:                             <span class="keyword">if</span> (sendResult != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">94</span>:                                 <span class="keyword">return</span> sendResult;</div><div class="line"> <span class="number">95</span>:                             }</div><div class="line"> <span class="number">96</span>:                             <span class="keyword">throw</span> e;</div><div class="line"> <span class="number">97</span>:                     }</div><div class="line"> <span class="number">98</span>:                 } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"> <span class="number">99</span>:                     endTimestamp = System.currentTimeMillis();</div><div class="line"><span class="number">100</span>:                     <span class="keyword">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="keyword">false</span>);</div><div class="line"><span class="number">101</span>:                     log.warn(String.format(<span class="string">&quot;sendKernelImpl exception, throw exception, InvokeID: %s, RT: %sms, Broker: %s&quot;</span>, invokeID, endTimestamp - beginTimestampPrev, mq), e);</div><div class="line"><span class="number">102</span>:                     log.warn(msg.toString());</div><div class="line"><span class="number">103</span>:                     <span class="keyword">throw</span> e;</div><div class="line"><span class="number">104</span>:                 }</div><div class="line"><span class="number">105</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">106</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">107</span>:             }</div><div class="line"><span class="number">108</span>:         }</div><div class="line"><span class="number">109</span>:         <span class="comment">// &#x8FD4;&#x56DE;&#x53D1;&#x9001;&#x7ED3;&#x679C;</span></div><div class="line"><span class="number">110</span>:         <span class="keyword">if</span> (sendResult != <span class="keyword">null</span>) {</div><div class="line"><span class="number">111</span>:             <span class="keyword">return</span> sendResult;</div><div class="line"><span class="number">112</span>:         }</div><div class="line"><span class="number">113</span>:         <span class="comment">// &#x6839;&#x636E;&#x4E0D;&#x540C;&#x60C5;&#x51B5;&#xFF0C;&#x629B;&#x51FA;&#x4E0D;&#x540C;&#x7684;&#x5F02;&#x5E38;</span></div><div class="line"><span class="number">114</span>:         String info = String.format(<span class="string">&quot;Send [%d] times, still failed, cost [%d]ms, Topic: %s, BrokersSent: %s&quot;</span>, times, System.currentTimeMillis() - beginTimestampFirst,</div><div class="line"><span class="number">115</span>:                 msg.getTopic(), Arrays.toString(brokersSent)) + FAQUrl.suggestTodo(FAQUrl.SEND_MSG_FAILED);</div><div class="line"><span class="number">116</span>:         MQClientException mqClientException = <span class="keyword">new</span> MQClientException(info, exception);</div><div class="line"><span class="number">117</span>:         <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> MQBrokerException) {</div><div class="line"><span class="number">118</span>:             mqClientException.setResponseCode(((MQBrokerException) exception).getResponseCode());</div><div class="line"><span class="number">119</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> RemotingConnectException) {</div><div class="line"><span class="number">120</span>:             mqClientException.setResponseCode(ClientErrorCode.CONNECT_BROKER_EXCEPTION);</div><div class="line"><span class="number">121</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> RemotingTimeoutException) {</div><div class="line"><span class="number">122</span>:             mqClientException.setResponseCode(ClientErrorCode.ACCESS_BROKER_TIMEOUT);</div><div class="line"><span class="number">123</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> MQClientException) {</div><div class="line"><span class="number">124</span>:             mqClientException.setResponseCode(ClientErrorCode.BROKER_NOT_EXIST_EXCEPTION);</div><div class="line"><span class="number">125</span>:         }</div><div class="line"><span class="number">126</span>:         <span class="keyword">throw</span> mqClientException;</div><div class="line"><span class="number">127</span>:     }</div><div class="line"><span class="number">128</span>:     <span class="comment">// Namesrv&#x627E;&#x4E0D;&#x5230;&#x5F02;&#x5E38;</span></div><div class="line"><span class="number">129</span>:     List&lt;String&gt; nsList = <span class="keyword">this</span>.getmQClientFactory().getMQClientAPIImpl().getNameServerAddressList();</div><div class="line"><span class="number">130</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == nsList || nsList.isEmpty()) {</div><div class="line"><span class="number">131</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(</div><div class="line"><span class="number">132</span>:             <span class="string">&quot;No name server address, please set it.&quot;</span> + FAQUrl.suggestTodo(FAQUrl.NAME_SERVER_ADDR_NOT_EXIST_URL), <span class="keyword">null</span>).setResponseCode(ClientErrorCode.NO_NAME_SERVER_EXCEPTION);</div><div class="line"><span class="number">133</span>:     }</div><div class="line"><span class="number">134</span>:     <span class="comment">// &#x6D88;&#x606F;&#x8DEF;&#x7531;&#x627E;&#x4E0D;&#x5230;&#x5F02;&#x5E38;</span></div><div class="line"><span class="number">135</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">&quot;No route info of this topic, &quot;</span> + msg.getTopic() + FAQUrl.suggestTodo(FAQUrl.NO_TOPIC_ROUTE_INFO),</div><div class="line"><span class="number">136</span>:         <span class="keyword">null</span>).setResponseCode(ClientErrorCode.NOT_FOUND_TOPIC_EXCEPTION);</div><div class="line"><span class="number">137</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x3002;&#x6B65;&#x9AA4;&#xFF1A;&#x83B7;&#x53D6;&#x6D88;&#x606F;&#x8DEF;&#x7531;&#x4FE1;&#x606F;&#xFF0C;&#x9009;&#x62E9;&#x8981;&#x53D1;&#x9001;&#x5230;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x6267;&#x884C;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x5BF9;&#x53D1;&#x9001;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x5C01;&#x88C5;&#x8FD4;&#x56DE;&#x3002;</li>
<li>&#x7B2C; 1  &#x81F3; 7 &#x884C;&#xFF1A;&#x5BF9;<code>sendsendDefaultImpl(...)</code>&#x8FDB;&#x884C;&#x5C01;&#x88C5;&#x3002;</li>
<li>&#x7B2C; 20 &#x884C; &#xFF1A;<code>invokeID</code>&#x4EC5;&#x4EC5;&#x7528;&#x4E8E;&#x6253;&#x5370;&#x65E5;&#x5FD7;&#xFF0C;&#x65E0;&#x5B9E;&#x9645;&#x7684;&#x4E1A;&#x52A1;&#x7528;&#x9014;&#x3002;</li>
<li>&#x7B2C; 25 &#x884C; &#xFF1A;&#x83B7;&#x53D6; Topic&#x8DEF;&#x7531;&#x4FE1;&#x606F;&#xFF0C; &#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#defaultmqproducerimpltrytofindtopicpublishinfo">DefaultMQProducerImpl#tryToFindTopicPublishInfo()</a></li>
<li>&#x7B2C; 30 &amp; 34 &#x884C; &#xFF1A;&#x8BA1;&#x7B97;&#x8C03;&#x7528;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x5230;&#x6210;&#x529F;&#x4E3A;&#x6B62;&#x7684;&#x6700;&#x5927;&#x6B21;&#x6570;&#xFF0C;&#x5E76;&#x8FDB;&#x884C;&#x5FAA;&#x73AF;&#x3002;&#x540C;&#x6B65;&#x6216;&#x5F02;&#x6B65;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x4F1A;&#x8C03;&#x7528;&#x591A;&#x6B21;&#xFF0C;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#x4E3A;3&#x6B21;&#x3002;</li>
<li>&#x7B2C; 36 &#x884C; &#xFF1A;&#x9009;&#x62E9;&#x6D88;&#x606F;&#x8981;&#x53D1;&#x9001;&#x5230;&#x7684;&#x961F;&#x5217;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#mqfaultstrategy">MQFaultStrategy</a></li>
<li>&#x7B2C; 43 &#x884C; &#xFF1A;&#x8C03;&#x7528;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#defaultmqproducerimplsendkernelimpl">DefaultMQProducerImpl#sendKernelImpl()</a></li>
<li>&#x7B2C; 46 &#x884C; &#xFF1A;&#x66F4;&#x65B0;<code>Broker</code>&#x53EF;&#x7528;&#x6027;&#x4FE1;&#x606F;&#x3002;&#x5728;&#x9009;&#x62E9;&#x53D1;&#x9001;&#x5230;&#x7684;&#x6D88;&#x606F;&#x961F;&#x5217;&#x65F6;&#xFF0C;&#x4F1A;&#x53C2;&#x8003;<code>Broker</code>&#x53D1;&#x9001;&#x6D88;&#x606F;&#x7684;&#x5EF6;&#x8FDF;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#mqfaultstrategy">MQFaultStrategy</a></li>
<li>&#x7B2C; 62 &#x81F3; 68 &#x884C;&#xFF1A;&#x5F53;&#x629B;&#x51FA;<code>RemotingException</code>&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x8FDB;&#x884C;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x5931;&#x8D25;&#x91CD;&#x8BD5;&#xFF0C;&#x5219;<strong>&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x91CD;&#x590D;</strong>&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x8D85;&#x65F6;(<code>RemotingTimeoutException</code>)&#xFF0C;&#x5B9E;&#x9645;<code>Broker</code>&#x63A5;&#x6536;&#x5230;&#x8BE5;&#x6D88;&#x606F;&#x5E76;&#x5904;&#x7406;&#x6210;&#x529F;&#x3002;&#x56E0;&#x6B64;&#xFF0C;<code>Consumer</code>&#x5728;&#x6D88;&#x8D39;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x4FDD;&#x8BC1;&#x5E42;&#x7B49;&#x6027;&#x3002;</li>
</ul>
<h3 id="DefaultMQProducerImpl-tryToFindTopicPublishInfo"><a href="#DefaultMQProducerImpl-tryToFindTopicPublishInfo" class="headerlink" title="DefaultMQProducerImpl#tryToFindTopicPublishInfo()"></a>DefaultMQProducerImpl#tryToFindTopicPublishInfo()</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> TopicPublishInfo <span class="title">tryToFindTopicPublishInfo</span><span class="params">(<span class="keyword">final</span> String topic)</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="comment">// &#x7F13;&#x5B58;&#x4E2D;&#x83B7;&#x53D6; Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F;</span></div><div class="line"> <span class="number">3</span>:     TopicPublishInfo topicPublishInfo = <span class="keyword">this</span>.topicPublishInfoTable.get(topic);</div><div class="line"> <span class="number">4</span>:     <span class="comment">// &#x5F53;&#x65E0;&#x53EF;&#x7528;&#x7684; Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F;&#x65F6;&#xFF0C;&#x4ECE;Namesrv&#x83B7;&#x53D6;&#x4E00;&#x6B21;</span></div><div class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == topicPublishInfo || !topicPublishInfo.ok()) {</div><div class="line"> <span class="number">6</span>:         <span class="keyword">this</span>.topicPublishInfoTable.putIfAbsent(topic, <span class="keyword">new</span> TopicPublishInfo());</div><div class="line"> <span class="number">7</span>:         <span class="keyword">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);</div><div class="line"> <span class="number">8</span>:         topicPublishInfo = <span class="keyword">this</span>.topicPublishInfoTable.get(topic);</div><div class="line"> <span class="number">9</span>:     }</div><div class="line"><span class="number">10</span>:     <span class="comment">// &#x82E5;&#x83B7;&#x53D6;&#x7684; Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F;&#x65F6;&#x5019;&#x53EF;&#x7528;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;</span></div><div class="line"><span class="number">11</span>:     <span class="keyword">if</span> (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) {</div><div class="line"><span class="number">12</span>:         <span class="keyword">return</span> topicPublishInfo;</div><div class="line"><span class="number">13</span>:     } <span class="keyword">else</span> { <span class="comment">// &#x4F7F;&#x7528; {@link DefaultMQProducer#createTopicKey} &#x5BF9;&#x5E94;&#x7684; Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F;&#x3002;&#x7528;&#x4E8E; Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F;&#x4E0D;&#x5B58;&#x5728; &amp;&amp; Broker&#x652F;&#x6301;&#x81EA;&#x52A8;&#x521B;&#x5EFA;Topic</span></div><div class="line"><span class="number">14</span>:         <span class="keyword">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, <span class="keyword">true</span>, <span class="keyword">this</span>.defaultMQProducer);</div><div class="line"><span class="number">15</span>:         topicPublishInfo = <span class="keyword">this</span>.topicPublishInfoTable.get(topic);</div><div class="line"><span class="number">16</span>:         <span class="keyword">return</span> topicPublishInfo;</div><div class="line"><span class="number">17</span>:     }</div><div class="line"><span class="number">18</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x83B7;&#x5F97; Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F;&#x3002;&#x4F18;&#x5148;&#x4ECE;&#x7F13;&#x5B58;<code>topicPublishInfoTable</code>&#xFF0C;&#x5176;&#x6B21;&#x4ECE;<code>Namesrv</code>&#x4E2D;&#x83B7;&#x5F97;&#x3002;</li>
<li>&#x7B2C; 3 &#x884C; &#xFF1A;&#x4ECE;&#x7F13;&#x5B58;<code>topicPublishInfoTable</code>&#x4E2D;&#x83B7;&#x5F97; Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F;&#x3002;</li>
<li>&#x7B2C; 5 &#x81F3; 9 &#x884C; &#xFF1A;&#x4ECE; <code>Namesrv</code> &#x4E2D;&#x83B7;&#x5F97; Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F;&#x3002;</li>
<li>&#x7B2C; 13 &#x81F3; 17 &#x884C; &#xFF1A;&#x5F53;&#x4ECE; <code>Namesrv</code> &#x65E0;&#x6CD5;&#x83B7;&#x53D6;&#x65F6;&#xFF0C;&#x4F7F;&#x7528; <code>{@link DefaultMQProducer#createTopicKey}</code> &#x5BF9;&#x5E94;&#x7684; Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F;&#x3002;&#x76EE;&#x7684;&#x662F;&#x5F53; <code>Broker</code> &#x5F00;&#x542F;&#x81EA;&#x52A8;&#x521B;&#x5EFA; Topic&#x5F00;&#x5173;&#x65F6;&#xFF0C;<code>Broker</code> &#x63A5;&#x6536;&#x5230;&#x6D88;&#x606F;&#x540E;&#x81EA;&#x52A8;&#x521B;&#x5EFA;Topic&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;<a href="http://www.yunai.me/RocketMQ/topic/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Topic&#x300B;</a>&#x3002;</li>
</ul>
<h3 id="MQFaultStrategy"><a href="#MQFaultStrategy" class="headerlink" title="MQFaultStrategy"></a>MQFaultStrategy</h3><blockquote>
<p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_04_18/03.png"><img src="http://www.yunai.me/images/RocketMQ/2017_04_18/03.png" alt="Latency&#x7C7B;&#x56FE;" class="ui centered image"></a></p>
</blockquote>
<h4 id="MQFaultStrategy-1"><a href="#MQFaultStrategy-1" class="headerlink" title="MQFaultStrategy"></a>MQFaultStrategy</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQFaultStrategy</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger log = ClientLogger.getLog();</div><div class="line"> <span class="number">3</span>: </div><div class="line"> <span class="number">4</span>:     <span class="comment">/**</span></div><div class="line"> 5:      * &#x5EF6;&#x8FDF;&#x6545;&#x969C;&#x5BB9;&#x9519;&#xFF0C;&#x7EF4;&#x62A4;&#x6BCF;&#x4E2A;Broker&#x7684;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x7684;&#x5EF6;&#x8FDF;</div><div class="line"> 6:      * key&#xFF1A;brokerName</div><div class="line"> 7:      */</div><div class="line"> <span class="number">8</span>:     <span class="keyword">private</span> <span class="keyword">final</span> LatencyFaultTolerance&lt;String&gt; latencyFaultTolerance = <span class="keyword">new</span> LatencyFaultToleranceImpl();</div><div class="line"> <span class="number">9</span>:     <span class="comment">/**</span></div><div class="line">10:      * &#x53D1;&#x9001;&#x6D88;&#x606F;&#x5EF6;&#x8FDF;&#x5BB9;&#x9519;&#x5F00;&#x5173;</div><div class="line">11:      */</div><div class="line"><span class="number">12</span>:     <span class="keyword">private</span> <span class="keyword">boolean</span> sendLatencyFaultEnable = <span class="keyword">false</span>;</div><div class="line"><span class="number">13</span>:     <span class="comment">/**</span></div><div class="line">14:      * &#x5EF6;&#x8FDF;&#x7EA7;&#x522B;&#x6570;&#x7EC4;</div><div class="line">15:      */</div><div class="line"><span class="number">16</span>:     <span class="keyword">private</span> <span class="keyword">long</span>[] latencyMax = {<span class="number">50L</span>, <span class="number">100L</span>, <span class="number">550L</span>, <span class="number">1000L</span>, <span class="number">2000L</span>, <span class="number">3000L</span>, <span class="number">15000L</span>};</div><div class="line"><span class="number">17</span>:     <span class="comment">/**</span></div><div class="line">18:      * &#x4E0D;&#x53EF;&#x7528;&#x65F6;&#x957F;&#x6570;&#x7EC4;</div><div class="line">19:      */</div><div class="line"><span class="number">20</span>:     <span class="keyword">private</span> <span class="keyword">long</span>[] notAvailableDuration = {<span class="number">0L</span>, <span class="number">0L</span>, <span class="number">30000L</span>, <span class="number">60000L</span>, <span class="number">120000L</span>, <span class="number">180000L</span>, <span class="number">600000L</span>};</div><div class="line"><span class="number">21</span>: </div><div class="line"><span class="number">22</span>:     <span class="comment">/**</span></div><div class="line">23:      * &#x6839;&#x636E; Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F; &#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line">24:      *</div><div class="line">25:      * <span class="doctag">@param</span> tpInfo Topic&#x53D1;&#x5E03;&#x4FE1;&#x606F;</div><div class="line">26:      * <span class="doctag">@param</span> lastBrokerName brokerName</div><div class="line">27:      * <span class="doctag">@return</span> &#x6D88;&#x606F;&#x961F;&#x5217;</div><div class="line">28:      */</div><div class="line"><span class="number">29</span>:     <span class="function"><span class="keyword">public</span> MessageQueue <span class="title">selectOneMessageQueue</span><span class="params">(<span class="keyword">final</span> TopicPublishInfo tpInfo, <span class="keyword">final</span> String lastBrokerName)</span> </span>{</div><div class="line"><span class="number">30</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.sendLatencyFaultEnable) {</div><div class="line"><span class="number">31</span>:             <span class="keyword">try</span> {</div><div class="line"><span class="number">32</span>:                 <span class="comment">// &#x83B7;&#x53D6; brokerName=lastBrokerName &amp;&amp; &#x53EF;&#x7528;&#x7684;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;</span></div><div class="line"><span class="number">33</span>:                 <span class="keyword">int</span> index = tpInfo.getSendWhichQueue().getAndIncrement();</div><div class="line"><span class="number">34</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tpInfo.getMessageQueueList().size(); i++) {</div><div class="line"><span class="number">35</span>:                     <span class="keyword">int</span> pos = Math.abs(index++) % tpInfo.getMessageQueueList().size();</div><div class="line"><span class="number">36</span>:                     <span class="keyword">if</span> (pos &lt; <span class="number">0</span>)</div><div class="line"><span class="number">37</span>:                         pos = <span class="number">0</span>;</div><div class="line"><span class="number">38</span>:                     MessageQueue mq = tpInfo.getMessageQueueList().get(pos);</div><div class="line"><span class="number">39</span>:                     <span class="keyword">if</span> (latencyFaultTolerance.isAvailable(mq.getBrokerName())) {</div><div class="line"><span class="number">40</span>:                         <span class="keyword">if</span> (<span class="keyword">null</span> == lastBrokerName || mq.getBrokerName().equals(lastBrokerName))</div><div class="line"><span class="number">41</span>:                             <span class="keyword">return</span> mq;</div><div class="line"><span class="number">42</span>:                     }</div><div class="line"><span class="number">43</span>:                 }</div><div class="line"><span class="number">44</span>:                 <span class="comment">// &#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x76F8;&#x5BF9;&#x597D;&#x7684;broker&#xFF0C;&#x5E76;&#x83B7;&#x5F97;&#x5176;&#x5BF9;&#x5E94;&#x7684;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x4E0D;&#x8003;&#x8651;&#x8BE5;&#x961F;&#x5217;&#x7684;&#x53EF;&#x7528;&#x6027;</span></div><div class="line"><span class="number">45</span>:                 <span class="keyword">final</span> String notBestBroker = latencyFaultTolerance.pickOneAtLeast();</div><div class="line"><span class="number">46</span>:                 <span class="keyword">int</span> writeQueueNums = tpInfo.getQueueIdByBroker(notBestBroker);</div><div class="line"><span class="number">47</span>:                 <span class="keyword">if</span> (writeQueueNums &gt; <span class="number">0</span>) {</div><div class="line"><span class="number">48</span>:                     <span class="keyword">final</span> MessageQueue mq = tpInfo.selectOneMessageQueue();</div><div class="line"><span class="number">49</span>:                     <span class="keyword">if</span> (notBestBroker != <span class="keyword">null</span>) {</div><div class="line"><span class="number">50</span>:                         mq.setBrokerName(notBestBroker);</div><div class="line"><span class="number">51</span>:                         mq.setQueueId(tpInfo.getSendWhichQueue().getAndIncrement() % writeQueueNums);</div><div class="line"><span class="number">52</span>:                     }</div><div class="line"><span class="number">53</span>:                     <span class="keyword">return</span> mq;</div><div class="line"><span class="number">54</span>:                 } <span class="keyword">else</span> {</div><div class="line"><span class="number">55</span>:                     latencyFaultTolerance.remove(notBestBroker);</div><div class="line"><span class="number">56</span>:                 }</div><div class="line"><span class="number">57</span>:             } <span class="keyword">catch</span> (Exception e) {</div><div class="line"><span class="number">58</span>:                 log.error(<span class="string">&quot;Error occurred when selecting message queue&quot;</span>, e);</div><div class="line"><span class="number">59</span>:             }</div><div class="line"><span class="number">60</span>:             <span class="comment">// &#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x4E0D;&#x8003;&#x8651;&#x961F;&#x5217;&#x7684;&#x53EF;&#x7528;&#x6027;</span></div><div class="line"><span class="number">61</span>:             <span class="keyword">return</span> tpInfo.selectOneMessageQueue();</div><div class="line"><span class="number">62</span>:         }</div><div class="line"><span class="number">63</span>:         <span class="comment">// &#x83B7;&#x5F97; lastBrokerName &#x5BF9;&#x5E94;&#x7684;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x4E0D;&#x8003;&#x8651;&#x8BE5;&#x961F;&#x5217;&#x7684;&#x53EF;&#x7528;&#x6027;</span></div><div class="line"><span class="number">64</span>:         <span class="keyword">return</span> tpInfo.selectOneMessageQueue(lastBrokerName);</div><div class="line"><span class="number">65</span>:     }</div><div class="line"><span class="number">66</span>: </div><div class="line"><span class="number">67</span>:     <span class="comment">/**</span></div><div class="line">68:      * &#x66F4;&#x65B0;&#x5EF6;&#x8FDF;&#x5BB9;&#x9519;&#x4FE1;&#x606F;</div><div class="line">69:      *</div><div class="line">70:      * <span class="doctag">@param</span> brokerName brokerName</div><div class="line">71:      * <span class="doctag">@param</span> currentLatency &#x5EF6;&#x8FDF;</div><div class="line">72:      * <span class="doctag">@param</span> isolation &#x662F;&#x5426;&#x9694;&#x79BB;&#x3002;&#x5F53;&#x5F00;&#x542F;&#x9694;&#x79BB;&#x65F6;&#xFF0C;&#x9ED8;&#x8BA4;&#x5EF6;&#x8FDF;&#x4E3A;30000&#x3002;&#x76EE;&#x524D;&#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x5F02;&#x5E38;&#x65F6;</div><div class="line">73:      */</div><div class="line"><span class="number">74</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFaultItem</span><span class="params">(<span class="keyword">final</span> String brokerName, <span class="keyword">final</span> <span class="keyword">long</span> currentLatency, <span class="keyword">boolean</span> isolation)</span> </span>{</div><div class="line"><span class="number">75</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.sendLatencyFaultEnable) {</div><div class="line"><span class="number">76</span>:             <span class="keyword">long</span> duration = computeNotAvailableDuration(isolation ? <span class="number">30000</span> : currentLatency);</div><div class="line"><span class="number">77</span>:             <span class="keyword">this</span>.latencyFaultTolerance.updateFaultItem(brokerName, currentLatency, duration);</div><div class="line"><span class="number">78</span>:         }</div><div class="line"><span class="number">79</span>:     }</div><div class="line"><span class="number">80</span>: </div><div class="line"><span class="number">81</span>:     <span class="comment">/**</span></div><div class="line">82:      * &#x8BA1;&#x7B97;&#x5EF6;&#x8FDF;&#x5BF9;&#x5E94;&#x7684;&#x4E0D;&#x53EF;&#x7528;&#x65F6;&#x95F4;</div><div class="line">83:      *</div><div class="line">84:      * <span class="doctag">@param</span> currentLatency &#x5EF6;&#x8FDF;</div><div class="line">85:      * <span class="doctag">@return</span> &#x4E0D;&#x53EF;&#x7528;&#x65F6;&#x95F4;</div><div class="line">86:      */</div><div class="line"><span class="number">87</span>:     <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">computeNotAvailableDuration</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> currentLatency)</span> </span>{</div><div class="line"><span class="number">88</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = latencyMax.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</div><div class="line"><span class="number">89</span>:             <span class="keyword">if</span> (currentLatency &gt;= latencyMax[i])</div><div class="line"><span class="number">90</span>:                 <span class="keyword">return</span> <span class="keyword">this</span>.notAvailableDuration[i];</div><div class="line"><span class="number">91</span>:         }</div><div class="line"><span class="number">92</span>:         <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"><span class="number">93</span>:     }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;<code>Producer</code>&#x6D88;&#x606F;&#x53D1;&#x9001;&#x5BB9;&#x9519;&#x7B56;&#x7565;&#x3002;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x5BB9;&#x9519;&#x7B56;&#x7565;&#x5173;&#x95ED;&#xFF0C;&#x5373;<code>sendLatencyFaultEnable=false</code>&#x3002;</li>
<li>&#x7B2C; 30 &#x81F3; 62 &#x884C; &#xFF1A;&#x5BB9;&#x9519;&#x7B56;&#x7565;&#x9009;&#x62E9;&#x6D88;&#x606F;&#x961F;&#x5217;&#x903B;&#x8F91;&#x3002;&#x4F18;&#x5148;&#x83B7;&#x53D6;&#x53EF;&#x7528;&#x961F;&#x5217;&#xFF0C;&#x5176;&#x6B21;&#x9009;&#x62E9;&#x4E00;&#x4E2A;broker&#x83B7;&#x53D6;&#x961F;&#x5217;&#xFF0C;&#x6700;&#x5DEE;&#x8FD4;&#x56DE;&#x4EFB;&#x610F;broker&#x7684;&#x4E00;&#x4E2A;&#x961F;&#x5217;&#x3002;</li>
<li>&#x7B2C; 64 &#x884C; &#xFF1A;&#x672A;&#x5F00;&#x542F;&#x5BB9;&#x9519;&#x7B56;&#x7565;&#x9009;&#x62E9;&#x6D88;&#x606F;&#x961F;&#x5217;&#x903B;&#x8F91;&#x3002;</li>
<li><p>&#x7B2C; 74 &#x81F3; 79 &#x884C; &#xFF1A;&#x66F4;&#x65B0;&#x5EF6;&#x8FDF;&#x5BB9;&#x9519;&#x4FE1;&#x606F;&#x3002;&#x5F53; <code>Producer</code> &#x53D1;&#x9001;&#x6D88;&#x606F;&#x65F6;&#x95F4;&#x8FC7;&#x957F;&#xFF0C;&#x5219;&#x903B;&#x8F91;&#x8BA4;&#x4E3A;N&#x79D2;&#x5185;&#x4E0D;&#x53EF;&#x7528;&#x3002;&#x6309;&#x7167;<code>latencyMax</code>&#xFF0C;<code>notAvailableDuration</code>&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x5BF9;&#x5E94;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>  | Producer&#x53D1;&#x9001;&#x6D88;&#x606F;&#x6D88;&#x8017;&#x65F6;&#x957F; | Broker&#x4E0D;&#x53EF;&#x7528;&#x65F6;&#x957F; |<br>  | &#x2014; | &#x2014; |<br>  | &gt;= 15000 ms | 600 <em> 1000 ms  |<br>  | &gt;= 3000 ms | 180 </em> 1000 ms  |<br>  | &gt;= 2000 ms | 120 <em> 1000 ms  |<br>  | &gt;= 1000 ms | 60 </em> 1000 ms  |<br>  | &gt;= 550 ms | 30 * 1000 ms |<br>  | &gt;= 100 ms | 0 ms |<br>  | &gt;= 50 ms | 0 ms |</p>
</li>
</ul>
<h4 id="LatencyFaultTolerance"><a href="#LatencyFaultTolerance" class="headerlink" title="LatencyFaultTolerance"></a>LatencyFaultTolerance</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LatencyFaultTolerance</span>&lt;<span class="title">T</span>&gt; </span>{</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * &#x66F4;&#x65B0;&#x5BF9;&#x5E94;&#x7684;&#x5EF6;&#x8FDF;&#x548C;&#x4E0D;&#x53EF;&#x7528;&#x65F6;&#x957F;</div><div class="line"> 5:      *</div><div class="line"> 6:      * <span class="doctag">@param</span> name &#x5BF9;&#x8C61;</div><div class="line"> 7:      * <span class="doctag">@param</span> currentLatency &#x5EF6;&#x8FDF;</div><div class="line"> 8:      * <span class="doctag">@param</span> notAvailableDuration &#x4E0D;&#x53EF;&#x7528;&#x65F6;&#x957F;</div><div class="line"> 9:      */</div><div class="line"><span class="number">10</span>:     <span class="function"><span class="keyword">void</span> <span class="title">updateFaultItem</span><span class="params">(<span class="keyword">final</span> T name, <span class="keyword">final</span> <span class="keyword">long</span> currentLatency, <span class="keyword">final</span> <span class="keyword">long</span> notAvailableDuration)</span></span>;</div><div class="line"><span class="number">11</span>: </div><div class="line"><span class="number">12</span>:     <span class="comment">/**</span></div><div class="line">13:      * &#x5BF9;&#x8C61;&#x662F;&#x5426;&#x53EF;&#x7528;</div><div class="line">14:      *</div><div class="line">15:      * <span class="doctag">@param</span> name &#x5BF9;&#x8C61;</div><div class="line">16:      * <span class="doctag">@return</span> &#x662F;&#x5426;&#x53EF;&#x7528;</div><div class="line">17:      */</div><div class="line"><span class="number">18</span>:     <span class="function"><span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">(<span class="keyword">final</span> T name)</span></span>;</div><div class="line"><span class="number">19</span>: </div><div class="line"><span class="number">20</span>:     <span class="comment">/**</span></div><div class="line">21:      * &#x79FB;&#x9664;&#x5BF9;&#x8C61;</div><div class="line">22:      *</div><div class="line">23:      * <span class="doctag">@param</span> name &#x5BF9;&#x8C61;</div><div class="line">24:      */</div><div class="line"><span class="number">25</span>:     <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> T name)</span></span>;</div><div class="line"><span class="number">26</span>: </div><div class="line"><span class="number">27</span>:     <span class="comment">/**</span></div><div class="line">28:      * &#x83B7;&#x53D6;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;</div><div class="line">29:      *</div><div class="line">30:      * <span class="doctag">@return</span> &#x5BF9;&#x8C61;</div><div class="line">31:      */</div><div class="line"><span class="number">32</span>:     <span class="function">T <span class="title">pickOneAtLeast</span><span class="params">()</span></span>;</div><div class="line"><span class="number">33</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x5EF6;&#x8FDF;&#x6545;&#x969C;&#x5BB9;&#x9519;&#x63A5;&#x53E3;</li>
</ul>
<h4 id="LatencyFaultToleranceImpl"><a href="#LatencyFaultToleranceImpl" class="headerlink" title="LatencyFaultToleranceImpl"></a>LatencyFaultToleranceImpl</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LatencyFaultToleranceImpl</span> <span class="keyword">implements</span> <span class="title">LatencyFaultTolerance</span>&lt;<span class="title">String</span>&gt; </span>{</div><div class="line"> <span class="number">2</span>: </div><div class="line"> <span class="number">3</span>:     <span class="comment">/**</span></div><div class="line"> 4:      * &#x5BF9;&#x8C61;&#x6545;&#x969C;&#x4FE1;&#x606F;Table</div><div class="line"> 5:      */</div><div class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, FaultItem&gt; faultItemTable = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>);</div><div class="line"> <span class="number">7</span>:     <span class="comment">/**</span></div><div class="line"> 8:      * &#x5BF9;&#x8C61;&#x9009;&#x62E9;Index</div><div class="line"> 9:      * <span class="doctag">@see</span> #pickOneAtLeast()</div><div class="line">10:      */</div><div class="line"><span class="number">11</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocalIndex whichItemWorst = <span class="keyword">new</span> ThreadLocalIndex();</div><div class="line"><span class="number">12</span>: </div><div class="line"><span class="number">13</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">14</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFaultItem</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> <span class="keyword">long</span> currentLatency, <span class="keyword">final</span> <span class="keyword">long</span> notAvailableDuration)</span> </span>{</div><div class="line"><span class="number">15</span>:         FaultItem old = <span class="keyword">this</span>.faultItemTable.get(name);</div><div class="line"><span class="number">16</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == old) {</div><div class="line"><span class="number">17</span>:             <span class="comment">// &#x521B;&#x5EFA;&#x5BF9;&#x8C61;</span></div><div class="line"><span class="number">18</span>:             <span class="keyword">final</span> FaultItem faultItem = <span class="keyword">new</span> FaultItem(name);</div><div class="line"><span class="number">19</span>:             faultItem.setCurrentLatency(currentLatency);</div><div class="line"><span class="number">20</span>:             faultItem.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);</div><div class="line"><span class="number">21</span>:             <span class="comment">// &#x66F4;&#x65B0;&#x5BF9;&#x8C61;</span></div><div class="line"><span class="number">22</span>:             old = <span class="keyword">this</span>.faultItemTable.putIfAbsent(name, faultItem);</div><div class="line"><span class="number">23</span>:             <span class="keyword">if</span> (old != <span class="keyword">null</span>) {</div><div class="line"><span class="number">24</span>:                 old.setCurrentLatency(currentLatency);</div><div class="line"><span class="number">25</span>:                 old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);</div><div class="line"><span class="number">26</span>:             }</div><div class="line"><span class="number">27</span>:         } <span class="keyword">else</span> { <span class="comment">// &#x66F4;&#x65B0;&#x5BF9;&#x8C61;</span></div><div class="line"><span class="number">28</span>:             old.setCurrentLatency(currentLatency);</div><div class="line"><span class="number">29</span>:             old.setStartTimestamp(System.currentTimeMillis() + notAvailableDuration);</div><div class="line"><span class="number">30</span>:         }</div><div class="line"><span class="number">31</span>:     }</div><div class="line"><span class="number">32</span>: </div><div class="line"><span class="number">33</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">34</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>{</div><div class="line"><span class="number">35</span>:         <span class="keyword">final</span> FaultItem faultItem = <span class="keyword">this</span>.faultItemTable.get(name);</div><div class="line"><span class="number">36</span>:         <span class="keyword">if</span> (faultItem != <span class="keyword">null</span>) {</div><div class="line"><span class="number">37</span>:             <span class="keyword">return</span> faultItem.isAvailable();</div><div class="line"><span class="number">38</span>:         }</div><div class="line"><span class="number">39</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">40</span>:     }</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">43</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>{</div><div class="line"><span class="number">44</span>:         <span class="keyword">this</span>.faultItemTable.remove(name);</div><div class="line"><span class="number">45</span>:     }</div><div class="line"><span class="number">46</span>: </div><div class="line"><span class="number">47</span>:     <span class="comment">/**</span></div><div class="line">48:      * &#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x76F8;&#x5BF9;&#x4F18;&#x79C0;&#x7684;&#x5BF9;&#x8C61;</div><div class="line">49:      *</div><div class="line">50:      * <span class="doctag">@return</span> &#x5BF9;&#x8C61;</div><div class="line">51:      */</div><div class="line"><span class="number">52</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">53</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">pickOneAtLeast</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">54</span>:         <span class="comment">// &#x521B;&#x5EFA;&#x6570;&#x7EC4;</span></div><div class="line"><span class="number">55</span>:         <span class="keyword">final</span> Enumeration&lt;FaultItem&gt; elements = <span class="keyword">this</span>.faultItemTable.elements();</div><div class="line"><span class="number">56</span>:         List&lt;FaultItem&gt; tmpList = <span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line"><span class="number">57</span>:         <span class="keyword">while</span> (elements.hasMoreElements()) {</div><div class="line"><span class="number">58</span>:             <span class="keyword">final</span> FaultItem faultItem = elements.nextElement();</div><div class="line"><span class="number">59</span>:             tmpList.add(faultItem);</div><div class="line"><span class="number">60</span>:         }</div><div class="line"><span class="number">61</span>:         <span class="comment">//</span></div><div class="line"><span class="number">62</span>:         <span class="keyword">if</span> (!tmpList.isEmpty()) {</div><div class="line"><span class="number">63</span>:             <span class="comment">// &#x6253;&#x4E71; + &#x6392;&#x5E8F;&#x3002;TODO &#x7591;&#x95EE;&#xFF1A;&#x5E94;&#x8BE5;&#x53EA;&#x80FD;&#x4E8C;&#x9009;&#x4E00;&#x3002;&#x731C;&#x6D4B;Collections.shuffle(tmpList)&#x53BB;&#x6389;&#x3002;</span></div><div class="line"><span class="number">64</span>:             Collections.shuffle(tmpList);</div><div class="line"><span class="number">65</span>:             Collections.sort(tmpList);</div><div class="line"><span class="number">66</span>:             <span class="comment">// &#x9009;&#x62E9;&#x987A;&#x5E8F;&#x5728;&#x524D;&#x4E00;&#x534A;&#x7684;&#x5BF9;&#x8C61;</span></div><div class="line"><span class="number">67</span>:             <span class="keyword">final</span> <span class="keyword">int</span> half = tmpList.size() / <span class="number">2</span>;</div><div class="line"><span class="number">68</span>:             <span class="keyword">if</span> (half &lt;= <span class="number">0</span>) {</div><div class="line"><span class="number">69</span>:                 <span class="keyword">return</span> tmpList.get(<span class="number">0</span>).getName();</div><div class="line"><span class="number">70</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">71</span>:                 <span class="keyword">final</span> <span class="keyword">int</span> i = <span class="keyword">this</span>.whichItemWorst.getAndIncrement() % half;</div><div class="line"><span class="number">72</span>:                 <span class="keyword">return</span> tmpList.get(i).getName();</div><div class="line"><span class="number">73</span>:             }</div><div class="line"><span class="number">74</span>:         }</div><div class="line"><span class="number">75</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">76</span>:     }</div><div class="line"><span class="number">77</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x5EF6;&#x8FDF;&#x6545;&#x969C;&#x5BB9;&#x9519;&#x5B9E;&#x73B0;&#x3002;&#x7EF4;&#x62A4;&#x6BCF;&#x4E2A;&#x5BF9;&#x8C61;&#x7684;&#x4FE1;&#x606F;&#x3002;</li>
</ul>
<h4 id="FaultItem"><a href="#FaultItem" class="headerlink" title="FaultItem"></a>FaultItem</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="class"><span class="keyword">class</span> <span class="title">FaultItem</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">FaultItem</span>&gt; </span>{</div><div class="line"> <span class="number">2</span>:     <span class="comment">/**</span></div><div class="line"> 3:      * &#x5BF9;&#x8C61;&#x540D;</div><div class="line"> 4:      */</div><div class="line"> <span class="number">5</span>:     <span class="keyword">private</span> <span class="keyword">final</span> String name;</div><div class="line"> <span class="number">6</span>:     <span class="comment">/**</span></div><div class="line"> 7:      * &#x5EF6;&#x8FDF;</div><div class="line"> 8:      */</div><div class="line"> <span class="number">9</span>:     <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> currentLatency;</div><div class="line"><span class="number">10</span>:     <span class="comment">/**</span></div><div class="line">11:      * &#x5F00;&#x59CB;&#x53EF;&#x7528;&#x65F6;&#x95F4;</div><div class="line">12:      */</div><div class="line"><span class="number">13</span>:     <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> startTimestamp;</div><div class="line"><span class="number">14</span>: </div><div class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> <span class="title">FaultItem</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>{</div><div class="line"><span class="number">16</span>:         <span class="keyword">this</span>.name = name;</div><div class="line"><span class="number">17</span>:     }</div><div class="line"><span class="number">18</span>: </div><div class="line"><span class="number">19</span>:     <span class="comment">/**</span></div><div class="line">20:      * &#x6BD4;&#x8F83;&#x5BF9;&#x8C61;</div><div class="line">21:      * &#x53EF;&#x7528;&#x6027; &gt; &#x5EF6;&#x8FDF; &gt; &#x5F00;&#x59CB;&#x53EF;&#x7528;&#x65F6;&#x95F4;</div><div class="line">22:      *</div><div class="line">23:      * <span class="doctag">@param</span> other other</div><div class="line">24:      * <span class="doctag">@return</span> &#x5347;&#x5E8F;</div><div class="line">25:      */</div><div class="line"><span class="number">26</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">27</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(<span class="keyword">final</span> FaultItem other)</span> </span>{</div><div class="line"><span class="number">28</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.isAvailable() != other.isAvailable()) {</div><div class="line"><span class="number">29</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.isAvailable())</div><div class="line"><span class="number">30</span>:                 <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">31</span>: </div><div class="line"><span class="number">32</span>:             <span class="keyword">if</span> (other.isAvailable())</div><div class="line"><span class="number">33</span>:                 <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line"><span class="number">34</span>:         }</div><div class="line"><span class="number">35</span>: </div><div class="line"><span class="number">36</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.currentLatency &lt; other.currentLatency)</div><div class="line"><span class="number">37</span>:             <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">38</span>:         <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.currentLatency &gt; other.currentLatency) {</div><div class="line"><span class="number">39</span>:             <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line"><span class="number">40</span>:         }</div><div class="line"><span class="number">41</span>: </div><div class="line"><span class="number">42</span>:         <span class="keyword">if</span> (<span class="keyword">this</span>.startTimestamp &lt; other.startTimestamp)</div><div class="line"><span class="number">43</span>:             <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="number">44</span>:         <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.startTimestamp &gt; other.startTimestamp) {</div><div class="line"><span class="number">45</span>:             <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line"><span class="number">46</span>:         }</div><div class="line"><span class="number">47</span>: </div><div class="line"><span class="number">48</span>:         <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"><span class="number">49</span>:     }</div><div class="line"><span class="number">50</span>: </div><div class="line"><span class="number">51</span>:     <span class="comment">/**</span></div><div class="line">52:      * &#x662F;&#x5426;&#x53EF;&#x7528;&#xFF1A;&#x5F53;&#x5F00;&#x59CB;&#x53EF;&#x7528;&#x65F6;&#x95F4;&#x5927;&#x4E8E;&#x5F53;&#x524D;&#x65F6;&#x95F4;</div><div class="line">53:      *</div><div class="line">54:      * <span class="doctag">@return</span> &#x662F;&#x5426;&#x53EF;&#x7528;</div><div class="line">55:      */</div><div class="line"><span class="number">56</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">57</span>:         <span class="keyword">return</span> (System.currentTimeMillis() - startTimestamp) &gt;= <span class="number">0</span>;</div><div class="line"><span class="number">58</span>:     }</div><div class="line"><span class="number">59</span>: </div><div class="line"><span class="number">60</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">61</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>{</div><div class="line"><span class="number">62</span>:         <span class="keyword">int</span> result = getName() != <span class="keyword">null</span> ? getName().hashCode() : <span class="number">0</span>;</div><div class="line"><span class="number">63</span>:         result = <span class="number">31</span> * result + (<span class="keyword">int</span>) (getCurrentLatency() ^ (getCurrentLatency() &gt;&gt;&gt; <span class="number">32</span>));</div><div class="line"><span class="number">64</span>:         result = <span class="number">31</span> * result + (<span class="keyword">int</span>) (getStartTimestamp() ^ (getStartTimestamp() &gt;&gt;&gt; <span class="number">32</span>));</div><div class="line"><span class="number">65</span>:         <span class="keyword">return</span> result;</div><div class="line"><span class="number">66</span>:     }</div><div class="line"><span class="number">67</span>: </div><div class="line"><span class="number">68</span>:     <span class="meta">@Override</span></div><div class="line"><span class="number">69</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(<span class="keyword">final</span> Object o)</span> </span>{</div><div class="line"><span class="number">70</span>:         <span class="keyword">if</span> (<span class="keyword">this</span> == o)</div><div class="line"><span class="number">71</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"><span class="number">72</span>:         <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> FaultItem))</div><div class="line"><span class="number">73</span>:             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">74</span>: </div><div class="line"><span class="number">75</span>:         <span class="keyword">final</span> FaultItem faultItem = (FaultItem) o;</div><div class="line"><span class="number">76</span>: </div><div class="line"><span class="number">77</span>:         <span class="keyword">if</span> (getCurrentLatency() != faultItem.getCurrentLatency())</div><div class="line"><span class="number">78</span>:             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">79</span>:         <span class="keyword">if</span> (getStartTimestamp() != faultItem.getStartTimestamp())</div><div class="line"><span class="number">80</span>:             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">81</span>:         <span class="keyword">return</span> getName() != <span class="keyword">null</span> ? getName().equals(faultItem.getName()) : faultItem.getName() == <span class="keyword">null</span>;</div><div class="line"><span class="number">82</span>: </div><div class="line"><span class="number">83</span>:     }</div><div class="line"><span class="number">84</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x5BF9;&#x8C61;&#x6545;&#x969C;&#x4FE1;&#x606F;&#x3002;&#x7EF4;&#x62A4;&#x5BF9;&#x8C61;&#x7684;&#x540D;&#x5B57;&#x3001;&#x5EF6;&#x8FDF;&#x3001;&#x5F00;&#x59CB;&#x53EF;&#x7528;&#x7684;&#x65F6;&#x95F4;&#x3002;</li>
</ul>
<h3 id="DefaultMQProducerImpl-sendKernelImpl"><a href="#DefaultMQProducerImpl-sendKernelImpl" class="headerlink" title="DefaultMQProducerImpl#sendKernelImpl()"></a>DefaultMQProducerImpl#sendKernelImpl()</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> SendResult <span class="title">sendKernelImpl</span><span class="params">(<span class="keyword">final</span> Message msg, //</span></span></div><div class="line">  <span class="number">2</span>:     <span class="keyword">final</span> MessageQueue mq, //</div><div class="line">  <span class="number">3</span>:     <span class="keyword">final</span> CommunicationMode communicationMode, //</div><div class="line">  <span class="number">4</span>:     <span class="keyword">final</span> SendCallback sendCallback, //</div><div class="line">  <span class="number">5</span>:     <span class="keyword">final</span> TopicPublishInfo topicPublishInfo, //</div><div class="line">  <span class="number">6</span>:     <span class="keyword">final</span> <span class="keyword">long</span> timeout) <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException {</div><div class="line">  <span class="number">7</span>:     <span class="comment">// &#x83B7;&#x53D6; broker&#x5730;&#x5740;</span></div><div class="line">  <span class="number">8</span>:     String brokerAddr = <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</div><div class="line">  <span class="number">9</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == brokerAddr) {</div><div class="line"> <span class="number">10</span>:         tryToFindTopicPublishInfo(mq.getTopic());</div><div class="line"> <span class="number">11</span>:         brokerAddr = <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</div><div class="line"> <span class="number">12</span>:     }</div><div class="line"> <span class="number">13</span>:     <span class="comment">//</span></div><div class="line"> <span class="number">14</span>:     SendMessageContext context = <span class="keyword">null</span>;</div><div class="line"> <span class="number">15</span>:     <span class="keyword">if</span> (brokerAddr != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">16</span>:         <span class="comment">// &#x662F;&#x5426;&#x4F7F;&#x7528;broker vip&#x901A;&#x9053;&#x3002;broker&#x4F1A;&#x5F00;&#x542F;&#x4E24;&#x4E2A;&#x7AEF;&#x53E3;&#x5BF9;&#x5916;&#x670D;&#x52A1;&#x3002;</span></div><div class="line"> <span class="number">17</span>:         brokerAddr = MixAll.brokerVIPChannel(<span class="keyword">this</span>.defaultMQProducer.isSendMessageWithVIPChannel(), brokerAddr);</div><div class="line"> <span class="number">18</span>:         <span class="keyword">byte</span>[] prevBody = msg.getBody(); <span class="comment">// &#x8BB0;&#x5F55;&#x6D88;&#x606F;&#x5185;&#x5BB9;&#x3002;&#x4E0B;&#x9762;&#x903B;&#x8F91;&#x53EF;&#x80FD;&#x6539;&#x53D8;&#x6D88;&#x606F;&#x5185;&#x5BB9;&#xFF0C;&#x4F8B;&#x5982;&#x6D88;&#x606F;&#x538B;&#x7F29;&#x3002;</span></div><div class="line"> <span class="number">19</span>:         <span class="keyword">try</span> {</div><div class="line"> <span class="number">20</span>:             <span class="comment">// &#x8BBE;&#x7F6E;&#x552F;&#x4E00;&#x7F16;&#x53F7;</span></div><div class="line"> <span class="number">21</span>:             MessageClientIDSetter.setUniqID(msg);</div><div class="line"> <span class="number">22</span>:             <span class="comment">// &#x6D88;&#x606F;&#x538B;&#x7F29;</span></div><div class="line"> <span class="number">23</span>:             <span class="keyword">int</span> sysFlag = <span class="number">0</span>;</div><div class="line"> <span class="number">24</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.tryToCompressMessage(msg)) {</div><div class="line"> <span class="number">25</span>:                 sysFlag |= MessageSysFlag.COMPRESSED_FLAG;</div><div class="line"> <span class="number">26</span>:             }</div><div class="line"> <span class="number">27</span>:             <span class="comment">// &#x4E8B;&#x52A1;</span></div><div class="line"> <span class="number">28</span>:             <span class="keyword">final</span> String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</div><div class="line"> <span class="number">29</span>:             <span class="keyword">if</span> (tranMsg != <span class="keyword">null</span> &amp;&amp; Boolean.parseBoolean(tranMsg)) {</div><div class="line"> <span class="number">30</span>:                 sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;</div><div class="line"> <span class="number">31</span>:             }</div><div class="line"> <span class="number">32</span>:             <span class="comment">// hook&#xFF1A;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x6821;&#x9A8C;</span></div><div class="line"> <span class="number">33</span>:             <span class="keyword">if</span> (hasCheckForbiddenHook()) {</div><div class="line"> <span class="number">34</span>:                 CheckForbiddenContext checkForbiddenContext = <span class="keyword">new</span> CheckForbiddenContext();</div><div class="line"> <span class="number">35</span>:                 checkForbiddenContext.setNameSrvAddr(<span class="keyword">this</span>.defaultMQProducer.getNamesrvAddr());</div><div class="line"> <span class="number">36</span>:                 checkForbiddenContext.setGroup(<span class="keyword">this</span>.defaultMQProducer.getProducerGroup());</div><div class="line"> <span class="number">37</span>:                 checkForbiddenContext.setCommunicationMode(communicationMode);</div><div class="line"> <span class="number">38</span>:                 checkForbiddenContext.setBrokerAddr(brokerAddr);</div><div class="line"> <span class="number">39</span>:                 checkForbiddenContext.setMessage(msg);</div><div class="line"> <span class="number">40</span>:                 checkForbiddenContext.setMq(mq);</div><div class="line"> <span class="number">41</span>:                 checkForbiddenContext.setUnitMode(<span class="keyword">this</span>.isUnitMode());</div><div class="line"> <span class="number">42</span>:                 <span class="keyword">this</span>.executeCheckForbiddenHook(checkForbiddenContext);</div><div class="line"> <span class="number">43</span>:             }</div><div class="line"> <span class="number">44</span>:             <span class="comment">// hook&#xFF1A;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x524D;&#x903B;&#x8F91;</span></div><div class="line"> <span class="number">45</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) {</div><div class="line"> <span class="number">46</span>:                 context = <span class="keyword">new</span> SendMessageContext();</div><div class="line"> <span class="number">47</span>:                 context.setProducer(<span class="keyword">this</span>);</div><div class="line"> <span class="number">48</span>:                 context.setProducerGroup(<span class="keyword">this</span>.defaultMQProducer.getProducerGroup());</div><div class="line"> <span class="number">49</span>:                 context.setCommunicationMode(communicationMode);</div><div class="line"> <span class="number">50</span>:                 context.setBornHost(<span class="keyword">this</span>.defaultMQProducer.getClientIP());</div><div class="line"> <span class="number">51</span>:                 context.setBrokerAddr(brokerAddr);</div><div class="line"> <span class="number">52</span>:                 context.setMessage(msg);</div><div class="line"> <span class="number">53</span>:                 context.setMq(mq);</div><div class="line"> <span class="number">54</span>:                 String isTrans = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</div><div class="line"> <span class="number">55</span>:                 <span class="keyword">if</span> (isTrans != <span class="keyword">null</span> &amp;&amp; isTrans.equals(<span class="string">&quot;true&quot;</span>)) {</div><div class="line"> <span class="number">56</span>:                     context.setMsgType(MessageType.Trans_Msg_Half);</div><div class="line"> <span class="number">57</span>:                 }</div><div class="line"> <span class="number">58</span>:                 <span class="keyword">if</span> (msg.getProperty(<span class="string">&quot;__STARTDELIVERTIME&quot;</span>) != <span class="keyword">null</span> || msg.getProperty(MessageConst.PROPERTY_DELAY_TIME_LEVEL) != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">59</span>:                     context.setMsgType(MessageType.Delay_Msg);</div><div class="line"> <span class="number">60</span>:                 }</div><div class="line"> <span class="number">61</span>:                 <span class="keyword">this</span>.executeSendMessageHookBefore(context);</div><div class="line"> <span class="number">62</span>:             }</div><div class="line"> <span class="number">63</span>:             <span class="comment">// &#x6784;&#x5EFA;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x8BF7;&#x6C42;</span></div><div class="line"> <span class="number">64</span>:             SendMessageRequestHeader requestHeader = <span class="keyword">new</span> SendMessageRequestHeader();</div><div class="line"> <span class="number">65</span>:             requestHeader.setProducerGroup(<span class="keyword">this</span>.defaultMQProducer.getProducerGroup());</div><div class="line"> <span class="number">66</span>:             requestHeader.setTopic(msg.getTopic());</div><div class="line"> <span class="number">67</span>:             requestHeader.setDefaultTopic(<span class="keyword">this</span>.defaultMQProducer.getCreateTopicKey());</div><div class="line"> <span class="number">68</span>:             requestHeader.setDefaultTopicQueueNums(<span class="keyword">this</span>.defaultMQProducer.getDefaultTopicQueueNums());</div><div class="line"> <span class="number">69</span>:             requestHeader.setQueueId(mq.getQueueId());</div><div class="line"> <span class="number">70</span>:             requestHeader.setSysFlag(sysFlag);</div><div class="line"> <span class="number">71</span>:             requestHeader.setBornTimestamp(System.currentTimeMillis());</div><div class="line"> <span class="number">72</span>:             requestHeader.setFlag(msg.getFlag());</div><div class="line"> <span class="number">73</span>:             requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));</div><div class="line"> <span class="number">74</span>:             requestHeader.setReconsumeTimes(<span class="number">0</span>);</div><div class="line"> <span class="number">75</span>:             requestHeader.setUnitMode(<span class="keyword">this</span>.isUnitMode());</div><div class="line"> <span class="number">76</span>:             <span class="keyword">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) { <span class="comment">// &#x6D88;&#x606F;&#x91CD;&#x53D1;Topic</span></div><div class="line"> <span class="number">77</span>:                 String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);</div><div class="line"> <span class="number">78</span>:                 <span class="keyword">if</span> (reconsumeTimes != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">79</span>:                     requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));</div><div class="line"> <span class="number">80</span>:                     MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);</div><div class="line"> <span class="number">81</span>:                 }</div><div class="line"> <span class="number">82</span>:                 String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);</div><div class="line"> <span class="number">83</span>:                 <span class="keyword">if</span> (maxReconsumeTimes != <span class="keyword">null</span>) {</div><div class="line"> <span class="number">84</span>:                     requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));</div><div class="line"> <span class="number">85</span>:                     MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_MAX_RECONSUME_TIMES);</div><div class="line"> <span class="number">86</span>:                 }</div><div class="line"> <span class="number">87</span>:             }</div><div class="line"> <span class="number">88</span>:             <span class="comment">// &#x53D1;&#x9001;&#x6D88;&#x606F;</span></div><div class="line"> <span class="number">89</span>:             SendResult sendResult = <span class="keyword">null</span>;</div><div class="line"> <span class="number">90</span>:             <span class="keyword">switch</span> (communicationMode) {</div><div class="line"> <span class="number">91</span>:                 <span class="keyword">case</span> ASYNC:</div><div class="line"> <span class="number">92</span>:                     sendResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(<span class="comment">//</span></div><div class="line"> <span class="number">93</span>:                         brokerAddr, <span class="comment">// 1</span></div><div class="line"> <span class="number">94</span>:                         mq.getBrokerName(), <span class="comment">// 2</span></div><div class="line"> <span class="number">95</span>:                         msg, <span class="comment">// 3</span></div><div class="line"> <span class="number">96</span>:                         requestHeader, <span class="comment">// 4</span></div><div class="line"> <span class="number">97</span>:                         timeout, <span class="comment">// 5</span></div><div class="line"> <span class="number">98</span>:                         communicationMode, <span class="comment">// 6</span></div><div class="line"> <span class="number">99</span>:                         sendCallback, <span class="comment">// 7</span></div><div class="line"><span class="number">100</span>:                         topicPublishInfo, <span class="comment">// 8</span></div><div class="line"><span class="number">101</span>:                         <span class="keyword">this</span>.mQClientFactory, <span class="comment">// 9</span></div><div class="line"><span class="number">102</span>:                         <span class="keyword">this</span>.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(), <span class="comment">// 10</span></div><div class="line"><span class="number">103</span>:                         context, <span class="comment">//</span></div><div class="line"><span class="number">104</span>:                         <span class="keyword">this</span>);</div><div class="line"><span class="number">105</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">106</span>:                 <span class="keyword">case</span> ONEWAY:</div><div class="line"><span class="number">107</span>:                 <span class="keyword">case</span> SYNC:</div><div class="line"><span class="number">108</span>:                     sendResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(</div><div class="line"><span class="number">109</span>:                         brokerAddr,</div><div class="line"><span class="number">110</span>:                         mq.getBrokerName(),</div><div class="line"><span class="number">111</span>:                         msg,</div><div class="line"><span class="number">112</span>:                         requestHeader,</div><div class="line"><span class="number">113</span>:                         timeout,</div><div class="line"><span class="number">114</span>:                         communicationMode,</div><div class="line"><span class="number">115</span>:                         context,</div><div class="line"><span class="number">116</span>:                         <span class="keyword">this</span>);</div><div class="line"><span class="number">117</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">118</span>:                 <span class="keyword">default</span>:</div><div class="line"><span class="number">119</span>:                     <span class="keyword">assert</span> <span class="keyword">false</span>;</div><div class="line"><span class="number">120</span>:                     <span class="keyword">break</span>;</div><div class="line"><span class="number">121</span>:             }</div><div class="line"><span class="number">122</span>:             <span class="comment">// hook&#xFF1A;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x540E;&#x903B;&#x8F91;</span></div><div class="line"><span class="number">123</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) {</div><div class="line"><span class="number">124</span>:                 context.setSendResult(sendResult);</div><div class="line"><span class="number">125</span>:                 <span class="keyword">this</span>.executeSendMessageHookAfter(context);</div><div class="line"><span class="number">126</span>:             }</div><div class="line"><span class="number">127</span>:             <span class="comment">// &#x8FD4;&#x56DE;&#x53D1;&#x9001;&#x7ED3;&#x679C;</span></div><div class="line"><span class="number">128</span>:             <span class="keyword">return</span> sendResult;</div><div class="line"><span class="number">129</span>:         } <span class="keyword">catch</span> (RemotingException e) {</div><div class="line"><span class="number">130</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) {</div><div class="line"><span class="number">131</span>:                 context.setException(e);</div><div class="line"><span class="number">132</span>:                 <span class="keyword">this</span>.executeSendMessageHookAfter(context);</div><div class="line"><span class="number">133</span>:             }</div><div class="line"><span class="number">134</span>:             <span class="keyword">throw</span> e;</div><div class="line"><span class="number">135</span>:         } <span class="keyword">catch</span> (MQBrokerException e) {</div><div class="line"><span class="number">136</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) {</div><div class="line"><span class="number">137</span>:                 context.setException(e);</div><div class="line"><span class="number">138</span>:                 <span class="keyword">this</span>.executeSendMessageHookAfter(context);</div><div class="line"><span class="number">139</span>:             }</div><div class="line"><span class="number">140</span>:             <span class="keyword">throw</span> e;</div><div class="line"><span class="number">141</span>:         } <span class="keyword">catch</span> (InterruptedException e) {</div><div class="line"><span class="number">142</span>:             <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) {</div><div class="line"><span class="number">143</span>:                 context.setException(e);</div><div class="line"><span class="number">144</span>:                 <span class="keyword">this</span>.executeSendMessageHookAfter(context);</div><div class="line"><span class="number">145</span>:             }</div><div class="line"><span class="number">146</span>:             <span class="keyword">throw</span> e;</div><div class="line"><span class="number">147</span>:         } <span class="keyword">finally</span> {</div><div class="line"><span class="number">148</span>:             msg.setBody(prevBody);</div><div class="line"><span class="number">149</span>:         }</div><div class="line"><span class="number">150</span>:     }</div><div class="line"><span class="number">151</span>:     <span class="comment">// broker&#x4E3A;&#x7A7A;&#x629B;&#x51FA;&#x5F02;&#x5E38;</span></div><div class="line"><span class="number">152</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">&quot;The broker[&quot;</span> + mq.getBrokerName() + <span class="string">&quot;] not exist&quot;</span>, <span class="keyword">null</span>);</div><div class="line"><span class="number">153</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E; &#xFF1A;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x6838;&#x5FC3;&#x65B9;&#x6CD5;&#x3002;&#x8BE5;&#x65B9;&#x6CD5;&#x771F;&#x6B63;&#x53D1;&#x8D77;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#xFF0C;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x7ED9; <code>Broker</code>&#x3002;</li>
<li>&#x7B2C; 21 &#x884C; &#xFF1A;&#x751F;&#x4EA7;&#x6D88;&#x606F;&#x7F16;&#x53F7;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;<a href="http://www.yunai.me/RocketMQ/message/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Message &#x57FA;&#x7840;&#x300B;</a>&#x3002;</li>
<li>&#x7B2C; 64 &#x81F3; 121 &#x884C; &#xFF1A;&#x6784;&#x5EFA;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x8BF7;&#x6C42;<code>SendMessageRequestHeader</code>&#x3002;</li>
<li>&#x7B2C; 107 &#x81F3; 117 &#x884C; &#xFF1A;&#x6267;&#x884C; <code>MQClientInstance#sendMessage(...)</code> &#x53D1;&#x8D77;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x3002;</li>
</ul>
<h1 id="3&#x3001;Broker-&#x63A5;&#x6536;&#x6D88;&#x606F;"><a href="#3&#x3001;Broker-&#x63A5;&#x6536;&#x6D88;&#x606F;" class="headerlink" title="3&#x3001;Broker &#x63A5;&#x6536;&#x6D88;&#x606F;"></a>3&#x3001;Broker &#x63A5;&#x6536;&#x6D88;&#x606F;</h1><blockquote>
<p><a class="magnific-img" href="http://www.yunai.me/images/RocketMQ/2017_04_18/04.png"><img src="http://www.yunai.me/images/RocketMQ/2017_04_18/04.png" alt="&#x63A5;&#x6536;&#x53D1;&#x9001;&#x6D88;&#x606F;API&#x987A;&#x5E8F;&#x56FE;" class="ui centered image"></a></p>
</blockquote>
<h2 id="SendMessageProcessor-sendMessage"><a href="#SendMessageProcessor-sendMessage" class="headerlink" title="SendMessageProcessor#sendMessage"></a>SendMessageProcessor#sendMessage</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">  <span class="number">1</span>: <span class="meta">@Override</span></div><div class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">processRequest</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>{</div><div class="line">  <span class="number">3</span>:     SendMessageContext mqtraceContext;</div><div class="line">  <span class="number">4</span>:     <span class="keyword">switch</span> (request.getCode()) {</div><div class="line">  <span class="number">5</span>:         <span class="keyword">case</span> RequestCode.CONSUMER_SEND_MSG_BACK:</div><div class="line">  <span class="number">6</span>:             <span class="keyword">return</span> <span class="keyword">this</span>.consumerSendMsgBack(ctx, request);</div><div class="line">  <span class="number">7</span>:         <span class="keyword">default</span>:</div><div class="line">  <span class="number">8</span>:             <span class="comment">// &#x89E3;&#x6790;&#x8BF7;&#x6C42;</span></div><div class="line">  <span class="number">9</span>:             SendMessageRequestHeader requestHeader = parseRequestHeader(request);</div><div class="line"> <span class="number">10</span>:             <span class="keyword">if</span> (requestHeader == <span class="keyword">null</span>) {</div><div class="line"> <span class="number">11</span>:                 <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> <span class="number">12</span>:             }</div><div class="line"> <span class="number">13</span>:             <span class="comment">// &#x53D1;&#x9001;&#x8BF7;&#x6C42;Context&#x3002;&#x5728; hook &#x573A;&#x666F;&#x4E0B;&#x4F7F;&#x7528;</span></div><div class="line"> <span class="number">14</span>:             mqtraceContext = buildMsgContext(ctx, requestHeader);</div><div class="line"> <span class="number">15</span>:             <span class="comment">// hook&#xFF1A;&#x5904;&#x7406;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x524D;&#x903B;&#x8F91;</span></div><div class="line"> <span class="number">16</span>:             <span class="keyword">this</span>.executeSendMessageHookBefore(ctx, request, mqtraceContext);</div><div class="line"> <span class="number">17</span>:             <span class="comment">// &#x5904;&#x7406;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x903B;&#x8F91;</span></div><div class="line"> <span class="number">18</span>:             <span class="keyword">final</span> RemotingCommand response = <span class="keyword">this</span>.sendMessage(ctx, request, mqtraceContext, requestHeader);</div><div class="line"> <span class="number">19</span>:             <span class="comment">// hook&#xFF1A;&#x5904;&#x7406;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x540E;&#x903B;&#x8F91;</span></div><div class="line"> <span class="number">20</span>:             <span class="keyword">this</span>.executeSendMessageHookAfter(response, mqtraceContext);</div><div class="line"> <span class="number">21</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">22</span>:     }</div><div class="line"> <span class="number">23</span>: }</div><div class="line"> <span class="number">24</span>: </div><div class="line"> <span class="number">25</span>: <span class="function"><span class="keyword">private</span> RemotingCommand <span class="title">sendMessage</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, //</span></span></div><div class="line"> <span class="number">26</span>:     <span class="keyword">final</span> RemotingCommand request, //</div><div class="line"> <span class="number">27</span>:     <span class="keyword">final</span> SendMessageContext sendMessageContext, //</div><div class="line"> <span class="number">28</span>:     <span class="keyword">final</span> SendMessageRequestHeader requestHeader) <span class="keyword">throws</span> RemotingCommandException {</div><div class="line"> <span class="number">29</span>: </div><div class="line"> <span class="number">30</span>:     <span class="comment">// &#x521D;&#x59CB;&#x5316;&#x54CD;&#x5E94;</span></div><div class="line"> <span class="number">31</span>:     <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(SendMessageResponseHeader.class);</div><div class="line"> <span class="number">32</span>:     <span class="keyword">final</span> SendMessageResponseHeader responseHeader = (SendMessageResponseHeader) response.readCustomHeader();</div><div class="line"> <span class="number">33</span>:     response.setOpaque(request.getOpaque());</div><div class="line"> <span class="number">34</span>:     response.addExtField(MessageConst.PROPERTY_MSG_REGION, <span class="keyword">this</span>.brokerController.getBrokerConfig().getRegionId());</div><div class="line"> <span class="number">35</span>:     response.addExtField(MessageConst.PROPERTY_TRACE_SWITCH, String.valueOf(<span class="keyword">this</span>.brokerController.getBrokerConfig().isTraceOn()));</div><div class="line"> <span class="number">36</span>: </div><div class="line"> <span class="number">37</span>:     <span class="keyword">if</span> (log.isDebugEnabled()) {</div><div class="line"> <span class="number">38</span>:         log.debug(<span class="string">&quot;receive SendMessage request command, {}&quot;</span>, request);</div><div class="line"> <span class="number">39</span>:     }</div><div class="line"> <span class="number">40</span>: </div><div class="line"> <span class="number">41</span>:     <span class="comment">// &#x5982;&#x679C;&#x672A;&#x5F00;&#x59CB;&#x63A5;&#x6536;&#x6D88;&#x606F;&#xFF0C;&#x629B;&#x51FA;&#x7CFB;&#x7EDF;&#x5F02;&#x5E38;</span></div><div class="line"> <span class="number">42</span>:     <span class="meta">@SuppressWarnings</span>(<span class="string">&quot;SpellCheckingInspection&quot;</span>)</div><div class="line"> <span class="number">43</span>:     <span class="keyword">final</span> <span class="keyword">long</span> startTimstamp = <span class="keyword">this</span>.brokerController.getBrokerConfig().getStartAcceptSendRequestTimeStamp();</div><div class="line"> <span class="number">44</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getMessageStore().now() &lt; startTimstamp) {</div><div class="line"> <span class="number">45</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">46</span>:         response.setRemark(String.format(<span class="string">&quot;broker unable to service, until %s&quot;</span>, UtilAll.timeMillisToHumanString2(startTimstamp)));</div><div class="line"> <span class="number">47</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">48</span>:     }</div><div class="line"> <span class="number">49</span>: </div><div class="line"> <span class="number">50</span>:     <span class="comment">// &#x6D88;&#x606F;&#x914D;&#x7F6E;(Topic&#x914D;&#x7F6E;&#xFF09;&#x6821;&#x9A8C;</span></div><div class="line"> <span class="number">51</span>:     response.setCode(-<span class="number">1</span>);</div><div class="line"> <span class="number">52</span>:     <span class="keyword">super</span>.msgCheck(ctx, requestHeader, response);</div><div class="line"> <span class="number">53</span>:     <span class="keyword">if</span> (response.getCode() != -<span class="number">1</span>) {</div><div class="line"> <span class="number">54</span>:         <span class="keyword">return</span> response;</div><div class="line"> <span class="number">55</span>:     }</div><div class="line"> <span class="number">56</span>: </div><div class="line"> <span class="number">57</span>:     <span class="keyword">final</span> <span class="keyword">byte</span>[] body = request.getBody();</div><div class="line"> <span class="number">58</span>: </div><div class="line"> <span class="number">59</span>:     <span class="comment">// &#x5982;&#x679C;&#x961F;&#x5217;&#x5C0F;&#x4E8E;0&#xFF0C;&#x4ECE;&#x53EF;&#x7528;&#x961F;&#x5217;&#x968F;&#x673A;&#x9009;&#x62E9;</span></div><div class="line"> <span class="number">60</span>:     <span class="keyword">int</span> queueIdInt = requestHeader.getQueueId();</div><div class="line"> <span class="number">61</span>:     TopicConfig topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class="line"> <span class="number">62</span>:     <span class="keyword">if</span> (queueIdInt &lt; <span class="number">0</span>) {</div><div class="line"> <span class="number">63</span>:         queueIdInt = Math.abs(<span class="keyword">this</span>.random.nextInt() % <span class="number">99999999</span>) % topicConfig.getWriteQueueNums();</div><div class="line"> <span class="number">64</span>:     }</div><div class="line"> <span class="number">65</span>: </div><div class="line"> <span class="number">66</span>:     <span class="comment">//</span></div><div class="line"> <span class="number">67</span>:     <span class="keyword">int</span> sysFlag = requestHeader.getSysFlag();</div><div class="line"> <span class="number">68</span>:     <span class="keyword">if</span> (TopicFilterType.MULTI_TAG == topicConfig.getTopicFilterType()) {</div><div class="line"> <span class="number">69</span>:         sysFlag |= MessageSysFlag.MULTI_TAGS_FLAG;</div><div class="line"> <span class="number">70</span>:     }</div><div class="line"> <span class="number">71</span>: </div><div class="line"> <span class="number">72</span>:     <span class="comment">// &#x5BF9;RETRY&#x7C7B;&#x578B;&#x7684;&#x6D88;&#x606F;&#x5904;&#x7406;&#x3002;&#x5982;&#x679C;&#x8D85;&#x8FC7;&#x6700;&#x5927;&#x6D88;&#x8D39;&#x6B21;&#x6570;&#xFF0C;&#x5219;topic&#x4FEE;&#x6539;&#x6210;&quot;%DLQ%&quot; + &#x5206;&#x7EC4;&#x540D;&#xFF0C;&#x5373;&#x52A0;&#x5165; &#x6B7B;&#x4FE1;&#x961F;&#x5217;(Dead Letter Queue)</span></div><div class="line"> <span class="number">73</span>:     String newTopic = requestHeader.getTopic();</div><div class="line"> <span class="number">74</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> != newTopic &amp;&amp; newTopic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</div><div class="line"> <span class="number">75</span>:         <span class="comment">// &#x83B7;&#x53D6;&#x8BA2;&#x9605;&#x5206;&#x7EC4;&#x914D;&#x7F6E;</span></div><div class="line"> <span class="number">76</span>:         String groupName = newTopic.substring(MixAll.RETRY_GROUP_TOPIC_PREFIX.length());</div><div class="line"> <span class="number">77</span>:         SubscriptionGroupConfig subscriptionGroupConfig =</div><div class="line"> <span class="number">78</span>:             <span class="keyword">this</span>.brokerController.getSubscriptionGroupManager().findSubscriptionGroupConfig(groupName);</div><div class="line"> <span class="number">79</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionGroupConfig) {</div><div class="line"> <span class="number">80</span>:             response.setCode(ResponseCode.SUBSCRIPTION_GROUP_NOT_EXIST);</div><div class="line"> <span class="number">81</span>:             response.setRemark(<span class="string">&quot;subscription group not exist, &quot;</span> + groupName + <span class="string">&quot; &quot;</span> + FAQUrl.suggestTodo(FAQUrl.SUBSCRIPTION_GROUP_NOT_EXIST));</div><div class="line"> <span class="number">82</span>:             <span class="keyword">return</span> response;</div><div class="line"> <span class="number">83</span>:         }</div><div class="line"> <span class="number">84</span>:         <span class="comment">// &#x8BA1;&#x7B97;&#x6700;&#x5927;&#x53EF;&#x6D88;&#x8D39;&#x6B21;&#x6570;</span></div><div class="line"> <span class="number">85</span>:         <span class="keyword">int</span> maxReconsumeTimes = subscriptionGroupConfig.getRetryMaxTimes();</div><div class="line"> <span class="number">86</span>:         <span class="keyword">if</span> (request.getVersion() &gt;= MQVersion.Version.V3_4_9.ordinal()) {</div><div class="line"> <span class="number">87</span>:             maxReconsumeTimes = requestHeader.getMaxReconsumeTimes();</div><div class="line"> <span class="number">88</span>:         }</div><div class="line"> <span class="number">89</span>:         <span class="keyword">int</span> reconsumeTimes = requestHeader.getReconsumeTimes() == <span class="keyword">null</span> ? <span class="number">0</span> : requestHeader.getReconsumeTimes();</div><div class="line"> <span class="number">90</span>:         <span class="keyword">if</span> (reconsumeTimes &gt;= maxReconsumeTimes) { <span class="comment">// &#x8D85;&#x8FC7;&#x6700;&#x5927;&#x6D88;&#x8D39;&#x6B21;&#x6570;</span></div><div class="line"> <span class="number">91</span>:             newTopic = MixAll.getDLQTopic(groupName);</div><div class="line"> <span class="number">92</span>:             queueIdInt = Math.abs(<span class="keyword">this</span>.random.nextInt() % <span class="number">99999999</span>) % DLQ_NUMS_PER_GROUP;</div><div class="line"> <span class="number">93</span>:             topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(newTopic, <span class="comment">//</span></div><div class="line"> <span class="number">94</span>:                 DLQ_NUMS_PER_GROUP, <span class="comment">//</span></div><div class="line"> <span class="number">95</span>:                 PermName.PERM_WRITE, <span class="number">0</span></div><div class="line"> <span class="number">96</span>:             );</div><div class="line"> <span class="number">97</span>:             <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) {</div><div class="line"> <span class="number">98</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"> <span class="number">99</span>:                 response.setRemark(<span class="string">&quot;topic[&quot;</span> + newTopic + <span class="string">&quot;] not exist&quot;</span>);</div><div class="line"><span class="number">100</span>:                 <span class="keyword">return</span> response;</div><div class="line"><span class="number">101</span>:             }</div><div class="line"><span class="number">102</span>:         }</div><div class="line"><span class="number">103</span>:     }</div><div class="line"><span class="number">104</span>: </div><div class="line"><span class="number">105</span>:     <span class="comment">// &#x521B;&#x5EFA;MessageExtBrokerInner</span></div><div class="line"><span class="number">106</span>:     MessageExtBrokerInner msgInner = <span class="keyword">new</span> MessageExtBrokerInner();</div><div class="line"><span class="number">107</span>:     msgInner.setTopic(newTopic);</div><div class="line"><span class="number">108</span>:     msgInner.setBody(body);</div><div class="line"><span class="number">109</span>:     msgInner.setFlag(requestHeader.getFlag());</div><div class="line"><span class="number">110</span>:     MessageAccessor.setProperties(msgInner, MessageDecoder.string2messageProperties(requestHeader.getProperties()));</div><div class="line"><span class="number">111</span>:     msgInner.setPropertiesString(requestHeader.getProperties());</div><div class="line"><span class="number">112</span>:     msgInner.setTagsCode(MessageExtBrokerInner.tagsString2tagsCode(topicConfig.getTopicFilterType(), msgInner.getTags()));</div><div class="line"><span class="number">113</span>:     msgInner.setQueueId(queueIdInt);</div><div class="line"><span class="number">114</span>:     msgInner.setSysFlag(sysFlag);</div><div class="line"><span class="number">115</span>:     msgInner.setBornTimestamp(requestHeader.getBornTimestamp());</div><div class="line"><span class="number">116</span>:     msgInner.setBornHost(ctx.channel().remoteAddress());</div><div class="line"><span class="number">117</span>:     msgInner.setStoreHost(<span class="keyword">this</span>.getStoreHost());</div><div class="line"><span class="number">118</span>:     msgInner.setReconsumeTimes(requestHeader.getReconsumeTimes() == <span class="keyword">null</span> ? <span class="number">0</span> : requestHeader.getReconsumeTimes());</div><div class="line"><span class="number">119</span>: </div><div class="line"><span class="number">120</span>:     <span class="comment">// &#x6821;&#x9A8C;&#x662F;&#x5426;&#x4E0D;&#x5141;&#x8BB8;&#x53D1;&#x9001;&#x4E8B;&#x52A1;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">121</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isRejectTransactionMessage()) {</div><div class="line"><span class="number">122</span>:         String traFlag = msgInner.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</div><div class="line"><span class="number">123</span>:         <span class="keyword">if</span> (traFlag != <span class="keyword">null</span>) {</div><div class="line"><span class="number">124</span>:             response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"><span class="number">125</span>:             response.setRemark(</div><div class="line"><span class="number">126</span>:                 <span class="string">&quot;the broker[&quot;</span> + <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerIP1() + <span class="string">&quot;] sending transaction message is forbidden&quot;</span>);</div><div class="line"><span class="number">127</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">128</span>:         }</div><div class="line"><span class="number">129</span>:     }</div><div class="line"><span class="number">130</span>: </div><div class="line"><span class="number">131</span>:     <span class="comment">// &#x6DFB;&#x52A0;&#x6D88;&#x606F;</span></div><div class="line"><span class="number">132</span>:     PutMessageResult putMessageResult = <span class="keyword">this</span>.brokerController.getMessageStore().putMessage(msgInner);</div><div class="line"><span class="number">133</span>:     <span class="keyword">if</span> (putMessageResult != <span class="keyword">null</span>) {</div><div class="line"><span class="number">134</span>:         <span class="keyword">boolean</span> sendOK = <span class="keyword">false</span>;</div><div class="line"><span class="number">135</span>: </div><div class="line"><span class="number">136</span>:         <span class="keyword">switch</span> (putMessageResult.getPutMessageStatus()) {</div><div class="line"><span class="number">137</span>:             <span class="comment">// Success</span></div><div class="line"><span class="number">138</span>:             <span class="keyword">case</span> PUT_OK:</div><div class="line"><span class="number">139</span>:                 sendOK = <span class="keyword">true</span>;</div><div class="line"><span class="number">140</span>:                 response.setCode(ResponseCode.SUCCESS);</div><div class="line"><span class="number">141</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">142</span>:             <span class="keyword">case</span> FLUSH_DISK_TIMEOUT:</div><div class="line"><span class="number">143</span>:                 response.setCode(ResponseCode.FLUSH_DISK_TIMEOUT);</div><div class="line"><span class="number">144</span>:                 sendOK = <span class="keyword">true</span>;</div><div class="line"><span class="number">145</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">146</span>:             <span class="keyword">case</span> FLUSH_SLAVE_TIMEOUT:</div><div class="line"><span class="number">147</span>:                 response.setCode(ResponseCode.FLUSH_SLAVE_TIMEOUT);</div><div class="line"><span class="number">148</span>:                 sendOK = <span class="keyword">true</span>;</div><div class="line"><span class="number">149</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">150</span>:             <span class="keyword">case</span> SLAVE_NOT_AVAILABLE:</div><div class="line"><span class="number">151</span>:                 response.setCode(ResponseCode.SLAVE_NOT_AVAILABLE);</div><div class="line"><span class="number">152</span>:                 sendOK = <span class="keyword">true</span>;</div><div class="line"><span class="number">153</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">154</span>: </div><div class="line"><span class="number">155</span>:             <span class="comment">// Failed</span></div><div class="line"><span class="number">156</span>:             <span class="keyword">case</span> CREATE_MAPEDFILE_FAILED:</div><div class="line"><span class="number">157</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">158</span>:                 response.setRemark(<span class="string">&quot;create mapped file failed, server is busy or broken.&quot;</span>);</div><div class="line"><span class="number">159</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">160</span>:             <span class="keyword">case</span> MESSAGE_ILLEGAL:</div><div class="line"><span class="number">161</span>:             <span class="keyword">case</span> PROPERTIES_SIZE_EXCEEDED:</div><div class="line"><span class="number">162</span>:                 response.setCode(ResponseCode.MESSAGE_ILLEGAL);</div><div class="line"><span class="number">163</span>:                 response.setRemark(</div><div class="line"><span class="number">164</span>:                     <span class="string">&quot;the message is illegal, maybe msg body or properties length not matched. msg body length limit 128k, msg properties length limit 32k.&quot;</span>);</div><div class="line"><span class="number">165</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">166</span>:             <span class="keyword">case</span> SERVICE_NOT_AVAILABLE:</div><div class="line"><span class="number">167</span>:                 response.setCode(ResponseCode.SERVICE_NOT_AVAILABLE);</div><div class="line"><span class="number">168</span>:                 response.setRemark(</div><div class="line"><span class="number">169</span>:                     <span class="string">&quot;service not available now, maybe disk full, &quot;</span> + diskUtil() + <span class="string">&quot;, maybe your broker machine memory too small.&quot;</span>);</div><div class="line"><span class="number">170</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">171</span>:             <span class="keyword">case</span> OS_PAGECACHE_BUSY:</div><div class="line"><span class="number">172</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">173</span>:                 response.setRemark(<span class="string">&quot;[PC_SYNCHRONIZED]broker busy, start flow control for a while&quot;</span>);</div><div class="line"><span class="number">174</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">175</span>:             <span class="keyword">case</span> UNKNOWN_ERROR:</div><div class="line"><span class="number">176</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">177</span>:                 response.setRemark(<span class="string">&quot;UNKNOWN_ERROR&quot;</span>);</div><div class="line"><span class="number">178</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">179</span>:             <span class="keyword">default</span>:</div><div class="line"><span class="number">180</span>:                 response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">181</span>:                 response.setRemark(<span class="string">&quot;UNKNOWN_ERROR DEFAULT&quot;</span>);</div><div class="line"><span class="number">182</span>:                 <span class="keyword">break</span>;</div><div class="line"><span class="number">183</span>:         }</div><div class="line"><span class="number">184</span>: </div><div class="line"><span class="number">185</span>:         String owner = request.getExtFields().get(BrokerStatsManager.COMMERCIAL_OWNER);</div><div class="line"><span class="number">186</span>:         <span class="keyword">if</span> (sendOK) {</div><div class="line"><span class="number">187</span>:             <span class="comment">// &#x7EDF;&#x8BA1;</span></div><div class="line"><span class="number">188</span>:             <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incTopicPutNums(msgInner.getTopic());</div><div class="line"><span class="number">189</span>:             <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incTopicPutSize(msgInner.getTopic(), putMessageResult.getAppendMessageResult().getWroteBytes());</div><div class="line"><span class="number">190</span>:             <span class="keyword">this</span>.brokerController.getBrokerStatsManager().incBrokerPutNums();</div><div class="line"><span class="number">191</span>: </div><div class="line"><span class="number">192</span>:             <span class="comment">// &#x54CD;&#x5E94;</span></div><div class="line"><span class="number">193</span>:             response.setRemark(<span class="keyword">null</span>);</div><div class="line"><span class="number">194</span>:             responseHeader.setMsgId(putMessageResult.getAppendMessageResult().getMsgId());</div><div class="line"><span class="number">195</span>:             responseHeader.setQueueId(queueIdInt);</div><div class="line"><span class="number">196</span>:             responseHeader.setQueueOffset(putMessageResult.getAppendMessageResult().getLogicsOffset());</div><div class="line"><span class="number">197</span>:             doResponse(ctx, request, response);</div><div class="line"><span class="number">198</span>: </div><div class="line"><span class="number">199</span>:             <span class="comment">// hook&#xFF1A;&#x8BBE;&#x7F6E;&#x53D1;&#x9001;&#x6210;&#x529F;&#x5230;context</span></div><div class="line"><span class="number">200</span>:             <span class="keyword">if</span> (hasSendMessageHook()) {</div><div class="line"><span class="number">201</span>:                 sendMessageContext.setMsgId(responseHeader.getMsgId());</div><div class="line"><span class="number">202</span>:                 sendMessageContext.setQueueId(responseHeader.getQueueId());</div><div class="line"><span class="number">203</span>:                 sendMessageContext.setQueueOffset(responseHeader.getQueueOffset());</div><div class="line"><span class="number">204</span>: </div><div class="line"><span class="number">205</span>:                 <span class="keyword">int</span> commercialBaseCount = brokerController.getBrokerConfig().getCommercialBaseCount();</div><div class="line"><span class="number">206</span>:                 <span class="keyword">int</span> wroteSize = putMessageResult.getAppendMessageResult().getWroteBytes();</div><div class="line"><span class="number">207</span>:                 <span class="keyword">int</span> incValue = (<span class="keyword">int</span>) Math.ceil(wroteSize / BrokerStatsManager.SIZE_PER_COUNT) * commercialBaseCount;</div><div class="line"><span class="number">208</span>: </div><div class="line"><span class="number">209</span>:                 sendMessageContext.setCommercialSendStats(BrokerStatsManager.StatsType.SEND_SUCCESS);</div><div class="line"><span class="number">210</span>:                 sendMessageContext.setCommercialSendTimes(incValue);</div><div class="line"><span class="number">211</span>:                 sendMessageContext.setCommercialSendSize(wroteSize);</div><div class="line"><span class="number">212</span>:                 sendMessageContext.setCommercialOwner(owner);</div><div class="line"><span class="number">213</span>:             }</div><div class="line"><span class="number">214</span>:             <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"><span class="number">215</span>:         } <span class="keyword">else</span> {</div><div class="line"><span class="number">216</span>:             <span class="comment">// hook&#xFF1A;&#x8BBE;&#x7F6E;&#x53D1;&#x9001;&#x5931;&#x8D25;&#x5230;context</span></div><div class="line"><span class="number">217</span>:             <span class="keyword">if</span> (hasSendMessageHook()) {</div><div class="line"><span class="number">218</span>:                 <span class="keyword">int</span> wroteSize = request.getBody().length;</div><div class="line"><span class="number">219</span>:                 <span class="keyword">int</span> incValue = (<span class="keyword">int</span>) Math.ceil(wroteSize / BrokerStatsManager.SIZE_PER_COUNT);</div><div class="line"><span class="number">220</span>: </div><div class="line"><span class="number">221</span>:                 sendMessageContext.setCommercialSendStats(BrokerStatsManager.StatsType.SEND_FAILURE);</div><div class="line"><span class="number">222</span>:                 sendMessageContext.setCommercialSendTimes(incValue);</div><div class="line"><span class="number">223</span>:                 sendMessageContext.setCommercialSendSize(wroteSize);</div><div class="line"><span class="number">224</span>:                 sendMessageContext.setCommercialOwner(owner);</div><div class="line"><span class="number">225</span>:             }</div><div class="line"><span class="number">226</span>:         }</div><div class="line"><span class="number">227</span>:     } <span class="keyword">else</span> {</div><div class="line"><span class="number">228</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">229</span>:         response.setRemark(<span class="string">&quot;store putMessage return null&quot;</span>);</div><div class="line"><span class="number">230</span>:     }</div><div class="line"><span class="number">231</span>: </div><div class="line"><span class="number">232</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">233</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li><code>#processRequest()</code> &#x8BF4;&#x660E; &#xFF1A;&#x5904;&#x7406;&#x6D88;&#x606F;&#x8BF7;&#x6C42;&#x3002;</li>
<li><code>#sendMessage()</code> &#x8BF4;&#x660E; &#xFF1A;&#x53D1;&#x9001;&#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x7ED3;&#x679C;&#x3002;</li>
<li>&#x7B2C; 51 &#x81F3; 55 &#x884C; &#xFF1A;&#x6D88;&#x606F;&#x914D;&#x7F6E;(Topic&#x914D;&#x7F6E;&#xFF09;&#x6821;&#x9A8C;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="#abstractsendmessageprocessormsgcheck">AbstractSendMessageProcessor#msgCheck()</a>&#x3002;</li>
<li>&#x7B2C; 60 &#x81F3; 64 &#x884C; &#xFF1A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x7F16;&#x53F7;&#x5C0F;&#x4E8E;0&#x65F6;&#xFF0C;<code>Broker</code> &#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x968F;&#x673A;&#x9009;&#x62E9;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;&#x3002;</li>
<li>&#x7B2C; 72 &#x81F3; 103 &#x884C; &#xFF1A;&#x5BF9;RETRY&#x7C7B;&#x578B;&#x7684;&#x6D88;&#x606F;&#x5904;&#x7406;&#x3002;&#x5982;&#x679C;&#x8D85;&#x8FC7;&#x6700;&#x5927;&#x6D88;&#x8D39;&#x6B21;&#x6570;&#xFF0C;&#x5219;topic&#x4FEE;&#x6539;&#x6210;&#x201D;%DLQ%&#x201D; + &#x5206;&#x7EC4;&#x540D;&#xFF0C; &#x5373;&#x52A0;  &#x6B7B;&#x4FE1;&#x961F; (Dead Letter Queue)&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/topic/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Topic&#x300B;</a>&#x3002;</li>
<li>&#x7B2C; 105 &#x81F3; 118 &#x884C; &#xFF1A;&#x521B;&#x5EFA;<code>MessageExtBrokerInner</code>&#x3002;</li>
<li>&#x7B2C; 132 &#xFF1A;&#x5B58;&#x50A8;&#x6D88;&#x606F;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;&#xFF1A;<a href="defaultmessagestoreputmessage">DefaultMessageStore#putMessage()</a>&#x3002;</li>
<li>&#x7B2C; 133 &#x81F3; 183 &#x884C; &#xFF1A;&#x5904;&#x7406;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x7ED3;&#x679C;&#xFF0C;&#x8BBE;&#x7F6E;&#x54CD;&#x5E94;&#x7ED3;&#x679C;&#x548C;&#x63D0;&#x793A;&#x3002;</li>
<li>&#x7B2C; 186 &#x81F3; 214 &#x884C; &#xFF1A;&#x53D1;&#x9001;&#x6210;&#x529F;&#xFF0C;&#x54CD;&#x5E94;&#x3002;&#x8FD9;&#x91CC;<code>doResponse(ctx, request, response)</code>&#x8FDB;&#x884C;&#x54CD;&#x5E94;&#xFF0C;&#x6700;&#x540E;<code>return null</code>&#xFF0C;&#x539F;&#x56E0;&#x662F;&#xFF1A;&#x54CD;&#x5E94;&#x7ED9; <code>Producer</code> &#x53EF;&#x80FD;&#x53D1;&#x751F;&#x5F02;&#x5E38;&#xFF0C;<code>#doResponse(ctx, request, response)</code>&#x6355;&#x6349;&#x4E86;&#x8BE5;&#x5F02;&#x5E38;&#x5E76;&#x8F93;&#x51FA;&#x65E5;&#x5FD7;&#x3002;&#x8FD9;&#x6837;&#x505A;&#x7684;&#x8BDD;&#xFF0C;&#x6211;&#x4EEC;&#x8FDB;&#x884C;&#x6392;&#x67E5; <code>Broker</code> &#x63A5;&#x6536;&#x6D88;&#x606F;&#x6210;&#x529F;&#x540E;&#x54CD;&#x5E94;&#x662F;&#x5426;&#x5B58;&#x5728;&#x5F02;&#x5E38;&#x4F1A;&#x65B9;&#x4FBF;&#x5F88;&#x591A;&#x3002;</li>
</ul>
<h3 id="AbstractSendMessageProcessor-msgCheck"><a href="#AbstractSendMessageProcessor-msgCheck" class="headerlink" title="AbstractSendMessageProcessor#msgCheck"></a>AbstractSendMessageProcessor#msgCheck</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> RemotingCommand <span class="title">msgCheck</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx,</span></span></div><div class="line"> <span class="number">2</span>:                                    <span class="keyword">final</span> SendMessageRequestHeader requestHeader, <span class="keyword">final</span> RemotingCommand response) {</div><div class="line"> <span class="number">3</span>:     <span class="comment">// &#x68C0;&#x67E5; broker &#x662F;&#x5426;&#x6709;&#x5199;&#x5165;&#x6743;&#x9650;</span></div><div class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (!PermName.isWriteable(<span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerPermission())</div><div class="line"> <span class="number">5</span>:         &amp;&amp; <span class="keyword">this</span>.brokerController.getTopicConfigManager().isOrderTopic(requestHeader.getTopic())) {</div><div class="line"> <span class="number">6</span>:         response.setCode(ResponseCode.NO_PERMISSION);</div><div class="line"> <span class="number">7</span>:         response.setRemark(<span class="string">&quot;the broker[&quot;</span> + <span class="keyword">this</span>.brokerController.getBrokerConfig().getBrokerIP1()</div><div class="line"> <span class="number">8</span>:             + <span class="string">&quot;] sending message is forbidden&quot;</span>);</div><div class="line"> <span class="number">9</span>:         <span class="keyword">return</span> response;</div><div class="line"><span class="number">10</span>:     }</div><div class="line"><span class="number">11</span>:     <span class="comment">// &#x68C0;&#x67E5;topic&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x88AB;&#x53D1;&#x9001;&#x3002;&#x76EE;&#x524D;&#x662F;{@link MixAll.DEFAULT_TOPIC}&#x4E0D;&#x88AB;&#x5141;&#x8BB8;&#x53D1;&#x9001;</span></div><div class="line"><span class="number">12</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.brokerController.getTopicConfigManager().isTopicCanSendMessage(requestHeader.getTopic())) {</div><div class="line"><span class="number">13</span>:         String errorMsg = <span class="string">&quot;the topic[&quot;</span> + requestHeader.getTopic() + <span class="string">&quot;] is conflict with system reserved words.&quot;</span>;</div><div class="line"><span class="number">14</span>:         log.warn(errorMsg);</div><div class="line"><span class="number">15</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">16</span>:         response.setRemark(errorMsg);</div><div class="line"><span class="number">17</span>:         <span class="keyword">return</span> response;</div><div class="line"><span class="number">18</span>:     }</div><div class="line"><span class="number">19</span>:     TopicConfig topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</div><div class="line"><span class="number">20</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) { <span class="comment">// &#x4E0D;&#x80FD;&#x5B58;&#x5728;topicConfig&#xFF0C;&#x5219;&#x8FDB;&#x884C;&#x521B;&#x5EFA;</span></div><div class="line"><span class="number">21</span>:         <span class="keyword">int</span> topicSysFlag = <span class="number">0</span>;</div><div class="line"><span class="number">22</span>:         <span class="keyword">if</span> (requestHeader.isUnitMode()) {</div><div class="line"><span class="number">23</span>:             <span class="keyword">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</div><div class="line"><span class="number">24</span>:                 topicSysFlag = TopicSysFlag.buildSysFlag(<span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line"><span class="number">25</span>:             } <span class="keyword">else</span> {</div><div class="line"><span class="number">26</span>:                 topicSysFlag = TopicSysFlag.buildSysFlag(<span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line"><span class="number">27</span>:             }</div><div class="line"><span class="number">28</span>:         }</div><div class="line"><span class="number">29</span>:         <span class="comment">// &#x521B;&#x5EFA;topic&#x914D;&#x7F6E;</span></div><div class="line"><span class="number">30</span>:         log.warn(<span class="string">&quot;the topic {} not exist, producer: {}&quot;</span>, requestHeader.getTopic(), ctx.channel().remoteAddress());</div><div class="line"><span class="number">31</span>:         topicConfig = <span class="keyword">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageMethod(<span class="comment">//</span></div><div class="line"><span class="number">32</span>:             requestHeader.getTopic(), <span class="comment">//</span></div><div class="line"><span class="number">33</span>:             requestHeader.getDefaultTopic(), <span class="comment">//</span></div><div class="line"><span class="number">34</span>:             RemotingHelper.parseChannelRemoteAddr(ctx.channel()), <span class="comment">//</span></div><div class="line"><span class="number">35</span>:             requestHeader.getDefaultTopicQueueNums(), topicSysFlag);</div><div class="line"><span class="number">36</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) {</div><div class="line"><span class="number">37</span>:             <span class="keyword">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</div><div class="line"><span class="number">38</span>:                 topicConfig =</div><div class="line"><span class="number">39</span>:                     <span class="keyword">this</span>.brokerController.getTopicConfigManager().createTopicInSendMessageBackMethod(</div><div class="line"><span class="number">40</span>:                         requestHeader.getTopic(), <span class="number">1</span>, PermName.PERM_WRITE | PermName.PERM_READ,</div><div class="line"><span class="number">41</span>:                         topicSysFlag);</div><div class="line"><span class="number">42</span>:             }</div><div class="line"><span class="number">43</span>:         }</div><div class="line"><span class="number">44</span>:         <span class="comment">// &#x5982;&#x679C;&#x6CA1;&#x914D;&#x7F6E;</span></div><div class="line"><span class="number">45</span>:         <span class="keyword">if</span> (<span class="keyword">null</span> == topicConfig) {</div><div class="line"><span class="number">46</span>:             response.setCode(ResponseCode.TOPIC_NOT_EXIST);</div><div class="line"><span class="number">47</span>:             response.setRemark(<span class="string">&quot;topic[&quot;</span> + requestHeader.getTopic() + <span class="string">&quot;] not exist, apply first please!&quot;</span></div><div class="line"><span class="number">48</span>:                 + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));</div><div class="line"><span class="number">49</span>:             <span class="keyword">return</span> response;</div><div class="line"><span class="number">50</span>:         }</div><div class="line"><span class="number">51</span>:     }</div><div class="line"><span class="number">52</span>:     <span class="comment">// &#x961F;&#x5217;&#x7F16;&#x53F7;&#x662F;&#x5426;&#x6B63;&#x786E;</span></div><div class="line"><span class="number">53</span>:     <span class="keyword">int</span> queueIdInt = requestHeader.getQueueId();</div><div class="line"><span class="number">54</span>:     <span class="keyword">int</span> idValid = Math.max(topicConfig.getWriteQueueNums(), topicConfig.getReadQueueNums());</div><div class="line"><span class="number">55</span>:     <span class="keyword">if</span> (queueIdInt &gt;= idValid) {</div><div class="line"><span class="number">56</span>:         String errorInfo = String.format(<span class="string">&quot;request queueId[%d] is illegal, %s Producer: %s&quot;</span>,</div><div class="line"><span class="number">57</span>:             queueIdInt,</div><div class="line"><span class="number">58</span>:             topicConfig.toString(),</div><div class="line"><span class="number">59</span>:             RemotingHelper.parseChannelRemoteAddr(ctx.channel()));</div><div class="line"><span class="number">60</span>:         log.warn(errorInfo);</div><div class="line"><span class="number">61</span>:         response.setCode(ResponseCode.SYSTEM_ERROR);</div><div class="line"><span class="number">62</span>:         response.setRemark(errorInfo);</div><div class="line"><span class="number">63</span>:         <span class="keyword">return</span> response;</div><div class="line"><span class="number">64</span>:     }</div><div class="line"><span class="number">65</span>:     <span class="keyword">return</span> response;</div><div class="line"><span class="number">66</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E;&#xFF1A;&#x6821;&#x9A8C;&#x6D88;&#x606F;&#x662F;&#x5426;&#x6B63;&#x786E;&#xFF0C;&#x4E3B;&#x8981;&#x662F;Topic&#x914D;&#x7F6E;&#x65B9;&#x9762;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;<code>Broker</code> &#x662F;&#x5426;&#x6709;&#x5199;&#x5165;&#x6743;&#x9650;&#xFF0C;topic&#x914D;&#x7F6E;&#x662F;&#x5426;&#x5B58;&#x5728;&#xFF0C;&#x961F;&#x5217;&#x7F16;&#x53F7;&#x662F;&#x5426;&#x6B63;&#x786E;&#x3002;</li>
<li>&#x7B2C; 11 &#x81F3; 18 &#x884C; &#xFF1A;&#x68C0;&#x67E5;Topic&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x88AB;&#x53D1;&#x9001;&#x3002;&#x76EE;&#x524D;&#x662F; <code>{@link MixAll.DEFAULT_TOPIC}</code> &#x4E0D;&#x88AB;&#x5141;&#x8BB8;&#x53D1;&#x9001;&#x3002;</li>
<li>&#x7B2C; 20 &#x81F3; 51 &#x884C; &#xFF1A;&#x5F53;&#x627E;&#x4E0D;&#x5230;Topic&#x914D;&#x7F6E;&#xFF0C;&#x5219;&#x8FDB;&#x884C;&#x521B;&#x5EFA;&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x521B;&#x5EFA;&#x4F1A;&#x5B58;&#x5728;&#x4E0D;&#x6210;&#x529F;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x4F8B;&#x5982;&#x8BF4;&#xFF1A;<code>defaultTopic</code> &#x7684;Topic&#x914D;&#x7F6E;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x53C8;&#x6216;&#x8005;&#x662F; &#x5B58;&#x5728;&#x4F46;&#x662F;&#x4E0D;&#x5141;&#x8BB8;&#x7EE7;&#x627F;&#xFF0C;&#x8BE6;&#x7EC6;&#x89E3;&#x6790;&#x89C1;<a href="http://www.yunai.me/RocketMQ/topic/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Topic&#x300B;</a>&#x3002;</li>
</ul>
<h2 id="DefaultMessageStore-putMessage"><a href="#DefaultMessageStore-putMessage" class="headerlink" title="DefaultMessageStore#putMessage"></a>DefaultMessageStore#putMessage</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> PutMessageResult <span class="title">putMessage</span><span class="params">(MessageExtBrokerInner msg)</span> </span>{</div><div class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.shutdown) {</div><div class="line"> <span class="number">3</span>:         log.warn(<span class="string">&quot;message store has shutdown, so putMessage is forbidden&quot;</span>);</div><div class="line"> <span class="number">4</span>:         <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, <span class="keyword">null</span>);</div><div class="line"> <span class="number">5</span>:     }</div><div class="line"> <span class="number">6</span>: </div><div class="line"> <span class="number">7</span>:     <span class="comment">// &#x4ECE;&#x8282;&#x70B9;&#x4E0D;&#x5141;&#x8BB8;&#x5199;&#x5165;</span></div><div class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (BrokerRole.SLAVE == <span class="keyword">this</span>.messageStoreConfig.getBrokerRole()) {</div><div class="line"> <span class="number">9</span>:         <span class="keyword">long</span> value = <span class="keyword">this</span>.printTimes.getAndIncrement();</div><div class="line"><span class="number">10</span>:         <span class="keyword">if</span> ((value % <span class="number">50000</span>) == <span class="number">0</span>) {</div><div class="line"><span class="number">11</span>:             log.warn(<span class="string">&quot;message store is slave mode, so putMessage is forbidden &quot;</span>);</div><div class="line"><span class="number">12</span>:         }</div><div class="line"><span class="number">13</span>: </div><div class="line"><span class="number">14</span>:         <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, <span class="keyword">null</span>);</div><div class="line"><span class="number">15</span>:     }</div><div class="line"><span class="number">16</span>: </div><div class="line"><span class="number">17</span>:     <span class="comment">// store&#x662F;&#x5426;&#x5141;&#x8BB8;&#x5199;&#x5165;</span></div><div class="line"><span class="number">18</span>:     <span class="keyword">if</span> (!<span class="keyword">this</span>.runningFlags.isWriteable()) {</div><div class="line"><span class="number">19</span>:         <span class="keyword">long</span> value = <span class="keyword">this</span>.printTimes.getAndIncrement();</div><div class="line"><span class="number">20</span>:         <span class="keyword">if</span> ((value % <span class="number">50000</span>) == <span class="number">0</span>) {</div><div class="line"><span class="number">21</span>:             log.warn(<span class="string">&quot;message store is not writeable, so putMessage is forbidden &quot;</span> + <span class="keyword">this</span>.runningFlags.getFlagBits());</div><div class="line"><span class="number">22</span>:         }</div><div class="line"><span class="number">23</span>: </div><div class="line"><span class="number">24</span>:         <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.SERVICE_NOT_AVAILABLE, <span class="keyword">null</span>);</div><div class="line"><span class="number">25</span>:     } <span class="keyword">else</span> {</div><div class="line"><span class="number">26</span>:         <span class="keyword">this</span>.printTimes.set(<span class="number">0</span>);</div><div class="line"><span class="number">27</span>:     }</div><div class="line"><span class="number">28</span>: </div><div class="line"><span class="number">29</span>:     <span class="comment">// &#x6D88;&#x606F;&#x8FC7;&#x957F;</span></div><div class="line"><span class="number">30</span>:     <span class="keyword">if</span> (msg.getTopic().length() &gt; Byte.MAX_VALUE) {</div><div class="line"><span class="number">31</span>:         log.warn(<span class="string">&quot;putMessage message topic length too long &quot;</span> + msg.getTopic().length());</div><div class="line"><span class="number">32</span>:         <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, <span class="keyword">null</span>);</div><div class="line"><span class="number">33</span>:     }</div><div class="line"><span class="number">34</span>: </div><div class="line"><span class="number">35</span>:     <span class="comment">// &#x6D88;&#x606F;&#x9644;&#x52A0;&#x5C5E;&#x6027;&#x8FC7;&#x957F;</span></div><div class="line"><span class="number">36</span>:     <span class="keyword">if</span> (msg.getPropertiesString() != <span class="keyword">null</span> &amp;&amp; msg.getPropertiesString().length() &gt; Short.MAX_VALUE) {</div><div class="line"><span class="number">37</span>:         log.warn(<span class="string">&quot;putMessage message properties length too long &quot;</span> + msg.getPropertiesString().length());</div><div class="line"><span class="number">38</span>:         <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.PROPERTIES_SIZE_EXCEEDED, <span class="keyword">null</span>);</div><div class="line"><span class="number">39</span>:     }</div><div class="line"><span class="number">40</span>: </div><div class="line"><span class="number">41</span>:     <span class="keyword">if</span> (<span class="keyword">this</span>.isOSPageCacheBusy()) {</div><div class="line"><span class="number">42</span>:         <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.OS_PAGECACHE_BUSY, <span class="keyword">null</span>);</div><div class="line"><span class="number">43</span>:     }</div><div class="line"><span class="number">44</span>: </div><div class="line"><span class="number">45</span>:     <span class="keyword">long</span> beginTime = <span class="keyword">this</span>.getSystemClock().now();</div><div class="line"><span class="number">46</span>:     <span class="comment">// &#x6DFB;&#x52A0;&#x6D88;&#x606F;&#x5230;commitLog</span></div><div class="line"><span class="number">47</span>:     PutMessageResult result = <span class="keyword">this</span>.commitLog.putMessage(msg);</div><div class="line"><span class="number">48</span>: </div><div class="line"><span class="number">49</span>:     <span class="keyword">long</span> eclipseTime = <span class="keyword">this</span>.getSystemClock().now() - beginTime;</div><div class="line"><span class="number">50</span>:     <span class="keyword">if</span> (eclipseTime &gt; <span class="number">500</span>) {</div><div class="line"><span class="number">51</span>:         log.warn(<span class="string">&quot;putMessage not in lock eclipse time(ms)={}, bodyLength={}&quot;</span>, eclipseTime, msg.getBody().length);</div><div class="line"><span class="number">52</span>:     }</div><div class="line"><span class="number">53</span>:     <span class="keyword">this</span>.storeStatsService.setPutMessageEntireTimeMax(eclipseTime);</div><div class="line"><span class="number">54</span>: </div><div class="line"><span class="number">55</span>:     <span class="keyword">if</span> (<span class="keyword">null</span> == result || !result.isOk()) {</div><div class="line"><span class="number">56</span>:         <span class="keyword">this</span>.storeStatsService.getPutMessageFailedTimes().incrementAndGet();</div><div class="line"><span class="number">57</span>:     }</div><div class="line"><span class="number">58</span>: </div><div class="line"><span class="number">59</span>:     <span class="keyword">return</span> result;</div><div class="line"><span class="number">60</span>: }</div></pre></td></tr></table></figure>
<ul class="ui list">
<li>&#x8BF4;&#x660E;&#xFF1A;&#x5B58;&#x50A8;&#x6D88;&#x606F;&#x5C01;&#x88C5;&#xFF0C;&#x6700;&#x7EC8;&#x5B58;&#x50A8;&#x9700;&#x8981; <code>CommitLog</code> &#x5B9E;&#x73B0;&#x3002;</li>
<li>&#x7B2C; 7 &#x81F3; 27 &#x884C; &#xFF1A;&#x6821;&#x9A8C; <code>Broker</code> &#x662F;&#x5426;&#x53EF;&#x4EE5;&#x5199;&#x5165;&#x3002;</li>
<li>&#x7B2C; 29 &#x81F3; 39 &#x884C; &#xFF1A;&#x6D88;&#x606F;&#x683C;&#x5F0F;&#x4E0E;&#x5927;&#x5C0F;&#x6821;&#x9A8C;&#x3002;</li>
<li>&#x7B2C; 47 &#x884C; &#xFF1A;&#x8C03;&#x7528; <code>CommitLong</code> &#x8FDB;&#x884C;&#x5B58;&#x50A8;&#xFF0C;&#x8BE6;&#x7EC6;&#x903B;&#x8F91;&#x89C1;&#xFF1A;<a href="http://www.yunai.me/RocketMQ/message-store/">&#x300A;RocketMQ &#x6E90;&#x7801;&#x5206;&#x6790; &#x2014;&#x2014; Message &#x5B58;&#x50A8;&#x300B;</a></li>
</ul>
<h1 id="4&#x3001;&#x67D0;&#x79CD;&#x7ED3;&#x5C3E;"><a href="#4&#x3001;&#x67D0;&#x79CD;&#x7ED3;&#x5C3E;" class="headerlink" title="4&#x3001;&#x67D0;&#x79CD;&#x7ED3;&#x5C3E;"></a>4&#x3001;&#x67D0;&#x79CD;&#x7ED3;&#x5C3E;</h1><p>&#x611F;&#x8C22;&#x9605;&#x8BFB;&#x3001;&#x6536;&#x85CF;&#x3001;&#x70B9;&#x8D5E;&#x672C;&#x6587;&#x7684;&#x5DE5;&#x7A0B;&#x5E08;&#x540C;&#x5B66;&#x3002;</p>
<p>&#x9605;&#x8BFB;&#x6E90;&#x7801;&#x662F;&#x4EF6;&#x4EE4;&#x81EA;&#x5DF1;&#x5F88;&#x6109;&#x60A6;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x7F16;&#x5199;&#x6E90;&#x7801;&#x89E3;&#x6790;&#x662F;&#x8BA9;&#x81EA;&#x5DF1;&#x8111;&#x7EC6;&#x80DE;&#x6B7B;&#x4F24;&#x65E0;&#x6570;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x75DB;&#x5E76;&#x5FEB;&#x4E50;&#x7740;&#x3002;</p>
<p>&#x5982;&#x679C;&#x6709;&#x5185;&#x5BB9;&#x5199;&#x7684;&#x5B58;&#x5728;&#x9519;&#x8BEF;&#xFF0C;&#x6216;&#x662F;&#x4E0D;&#x6E05;&#x6670;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x89C1;&#x7B11;&#x4E86;&#xFF0C;&#x1F642;&#x3002;&#x6B22;&#x8FCE;&#x52A0; QQ&#xFF1A;7685413 &#x6211;&#x4EEC;&#x4E00;&#x8D77;&#x63A2;&#x8BA8;&#xFF0C;&#x5171;&#x8FDB;&#x6B65;&#x3002;</p>
<p>&#x518D;&#x6B21;&#x611F;&#x8C22;&#x9605;&#x8BFB;&#x3001;&#x6536;&#x85CF;&#x3001;&#x70B9;&#x8D5E;&#x672C;&#x6587;&#x7684;&#x5DE5;&#x7A0B;&#x5E08;&#x540C;&#x5B66;&#x3002;</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1、概述"><span class="toc-number">1.</span> <span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2、Producer-发送消息"><span class="toc-number">2.</span> <span class="toc-text">2、Producer 发送消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQProducer-send-Message"><span class="toc-number">2.1.</span> <span class="toc-text">DefaultMQProducer#send(Message)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMQProducerImpl-sendDefaultImpl"><span class="toc-number">2.2.</span> <span class="toc-text">DefaultMQProducerImpl#sendDefaultImpl()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultMQProducerImpl-tryToFindTopicPublishInfo"><span class="toc-number">2.2.1.</span> <span class="toc-text">DefaultMQProducerImpl#tryToFindTopicPublishInfo()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQFaultStrategy"><span class="toc-number">2.2.2.</span> <span class="toc-text">MQFaultStrategy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MQFaultStrategy-1"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">MQFaultStrategy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LatencyFaultTolerance"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">LatencyFaultTolerance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LatencyFaultToleranceImpl"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">LatencyFaultToleranceImpl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FaultItem"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">FaultItem</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DefaultMQProducerImpl-sendKernelImpl"><span class="toc-number">2.2.3.</span> <span class="toc-text">DefaultMQProducerImpl#sendKernelImpl()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3、Broker-接收消息"><span class="toc-number">3.</span> <span class="toc-text">3、Broker 接收消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SendMessageProcessor-sendMessage"><span class="toc-number">3.1.</span> <span class="toc-text">SendMessageProcessor#sendMessage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AbstractSendMessageProcessor-msgCheck"><span class="toc-number">3.1.1.</span> <span class="toc-text">AbstractSendMessageProcessor#msgCheck</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DefaultMessageStore-putMessage"><span class="toc-number">3.2.</span> <span class="toc-text">DefaultMessageStore#putMessage</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4、某种结尾"><span class="toc-number">4.</span> <span class="toc-text">4、某种结尾</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://www.yunai.me/RocketMQ/message-send-and-receive/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&text=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&title=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&is_video=false&description=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RocketMQ 源码分析 —— Message 发送与接收&body=Check out this article: http://www.yunai.me/RocketMQ/message-send-and-receive/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&title=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&title=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&title=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&title=RocketMQ 源码分析 —— Message 发送与接收" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://www.yunai.me/RocketMQ/message-send-and-receive/&name=RocketMQ 源码分析 —— Message 发送与接收&description=" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$(" #toc-footer").toggle();return="" false;"=""><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$(" #share-footer").toggle();return="" false;"=""><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$(" #nav-footer").toggle();return="" false;"=""><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2017 王文斌
  </div>

  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/YunaiV">GitHub</a></li>
        
          <li>
              Hosted by <a href="https://pages.coding.me" style="font-weight: bold" rel="external nofollow noopener noreferrer" target="_blank">Coding Pages</a>
          </li>
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


<!--page counter part-->
<script>
    function addCount(Counter) {
        // TODO 待优化：过滤 爬虫
        url = $('#actions .icon').attr('href').trim(); // 文章url
//        alert(url);
        title = $('.posttitle').text().trim(); // 文章标题
        var query = new AV.Query(Counter);
        //use url as unique idnetfication
        query.equalTo("url", url);
        query.find({
            success: function (results) {
                if (results.length > 0) {
                    var counter = results[0];
                    counter.fetchWhenSave(true); //get recent result
                    counter.increment("time");
                    counter.save();
                    // 插入次数
                    $('.postdate').append('&nbsp;' + (counter.get('time') + 1) + '  Views');
                } else {
                    var newcounter = new Counter();
                    newcounter.set("title", title);
                    newcounter.set("url", url);
                    newcounter.set("time", 1);
                    newcounter.save(null, {
                        success: function (newcounter) {
                            // 插入次数
                            $('.postdate').append('&nbsp;1  Views');
                        },
                        error: function (newcounter, error) {
                        }
                    });
                }
            },
            error: function (error) {
            }
        });
    }

    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=")
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1
                c_end = document.cookie.indexOf(";", c_start)
                if (c_end == -1) c_end = document.cookie.length
                return unescape(document.cookie.substring(c_start, c_end))
            }
        }
        return ""
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }

    function addVisitLog() {
        // 获取uid
        var visitorId = getCookie('blog_visitor_id');
        if (visitorId.length != 36) {
            visitorId = uuid();
            setCookie('blog_visitor_id', visitorId);
        }
        // ip 浏览器无法获取
        // time 服务端已经记录
        var url = location.href;
        var ua = navigator.userAgent;
        var referer = document.referrer;
        var Log = AV.Object.extend("VisitLog");
        var log = new Log();
        log.set('url', url);
        log.set('ua', ua);
        log.set('referer', referer);
        log.set('visitorId', visitorId);
        log.save();
    }

    function uuid() {
        var s = [];
        var hexDigits = "0123456789abcdef";
        for (var i = 0; i < 36; i++) {
            s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
        }
        s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
        s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
        s[8] = s[13] = s[18] = s[23] = "-";

        var uuid = s.join("");
        return uuid;
    }

    // TODO 待优化：此处性能较差，可能
    function countVisitLog() {
        var Log = AV.Object.extend("VisitLog");
        var query = new AV.Query(Log);
        query.count({
            success: function (results) {
                $('.footer-left').append('&nbsp;' + results + '  Views');
            },
            error: function (error) {
            }
        });
    }

    $(function () {
        // 判断是否在文章页
        setTimeout(function () {
            if ($('.posttitle').length == 1) {
                var Counter = AV.Object.extend("Counter");
                // 增加文章访问次数
                addCount(Counter);
            }
            // 记录访问日志
            addVisitLog();
            // 计算多少人访问
            countVisitLog();
        }, 1000);
    });
</script>
